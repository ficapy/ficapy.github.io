<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>é‚¹é›·</title>
  <subtitle>åˆ¨è¿‡çš„å‘,è‡ªå·±æ…¢æ…¢æ¥å¡«</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://www.zoulei.net/"/>
  <updated>2018-03-15T03:21:18.382Z</updated>
  <id>https://www.zoulei.net/</id>
  
  <author>
    <name>ficapy</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Tornado ä¹‹IOLoop</title>
    <link href="https://www.zoulei.net/2018/03/14/tornado_ioloop/"/>
    <id>https://www.zoulei.net/2018/03/14/tornado_ioloop/</id>
    <published>2018-03-14T10:03:18.000Z</published>
    <updated>2018-03-15T03:21:18.382Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™æ˜¯Tornadoç³»åˆ—çš„å¼€ç¯‡,Tornadoä½œä¸ºå¼‚æ­¥webæ¡†æ¶2010å¹´å‘å¸ƒ1.0ç‰ˆæœ¬ã€‚å¯ä»¥è¯´Pythonç¤¾åŒºæäº†è¿™ä¹ˆå¤šå¹´ï¼Œä¸ºäº†è·å¾—æ¯”å¤šçº¿ç¨‹å¤šè¿›ç¨‹æ›´é«˜çš„æ€§èƒ½ï¼Œç»å†äº†Twistedã€Tornadoã€yieldã€geventã€yield fromã€asyncioã€‚ä¹Ÿä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™æ‰æ˜¯ä¸€ä¸ªå°½å¤´~~ã€‚Tornadoè¿‡äº†è¿™ä¹ˆå¤šå¹´è¿˜ç®—å¼€å‘æ´»è·ƒ(<a href="https://github.com/tornadoweb/tornado/graphs/contributors">ä¸€ä¸ªå¤§ç¥æ‰›èµ·äº†ä¸€ç‰‡å¤©å•Š</a>)ï¼Œä¸åŒäºå¤šçº¿ç¨‹æ¨¡å‹çš„ä¸€æ½­æ­»æ°´ï¼Œçœ‹å®ƒçš„ä»£ç ä½ ä¼šå‘ç°å®ƒè¿˜æ˜¯ç´§è·Ÿæ½®æµçš„ï¼Œè€Œä¸”æœ‰ä¸€ç‚¹ã€‚å®ƒçš„å†…éƒ¨è™½ç„¶ä¸€ç›´åœ¨å˜åŠ¨ï¼Œä½†æ˜¯æä¾›ç»™ç”¨æˆ·çš„ä½¿ç”¨æ¥å£æ˜¯å¾ˆç¨³å®šçš„ï¼Œåç»­å°±ä¼šå‘ç°è¿™ä¸ªå‘æœ‰å¤šå¤§</p>
<a id="more"></a>
<p>æˆªæ­¢ç›®å‰æœ€æ–°ç‰ˆæœ¬çš„ä»£ç æ˜¯4.5ï¼Œæ’é™¤æµ‹è¯•æ€»ä»£ç é‡å¤§çº¦ä¸º12000è¡Œã€‚æˆ‘ä¸ªäººå–œæ¬¢çœ‹ç²¾ç®€ç‰ˆæœ¬çš„ä»£ç ï¼Œæ‰€ä»¥æœ¬æ–‡ä¸º1.0.0ç‰ˆæœ¬ã€‚æ€»ä»£ç é‡ä¸º4200è¡Œï¼Œæ¯”è¾ƒå®¹æ˜“çœ‹æ‡‚ã€‚æ¯•ç«Ÿåˆ«äººä¼˜åŒ–äº†å…«å¹´ï¼ŒæœŸå¾…ä¸€ä¸ªæ˜ŸæœŸç²¾è¯»èƒ½ææ˜ç™½å„ç§å·¥ç¨‹ä¼˜åŒ–æ˜¯ä¸ç°å®çš„ã€‚</p>
<h3 id="IOLoop"><a href="#IOLoop" class="headerlink" title="IOLoop"></a>IOLoop</h3><p>è¯´åˆ°å¼‚æ­¥éé˜»å¡å¤§å¤šæ•°äººéƒ½çŸ¥é“æ˜¯å¼‚æ­¥IOæ¨¡å‹(selectã€pollã€epollã€kqueue)ã€‚æ²¡é”™åœ¨é˜»å¡æ¨¡å‹ä¸­æ¯”å¦‚ä½¿ç”¨<code>socket.recv</code>å®ƒä¼šä¸»çº¿ç¨‹é€ æˆé˜»å¡ã€‚è¿™ç›´æ¥å¯¼è‡´äº†åœ¨pythonä¸­éœ€è¦ä½¿ç”¨å¤šçº¿ç¨‹æˆ–è€…å¤šè¿›ç¨‹æ¨¡å‹æ‰èƒ½å¤ŸåŒæ—¶å¤„ç†å¤šä¸ªè¯·æ±‚ã€‚å¯æ˜¯åœ¨å¼‚æ­¥æ¨¡å‹ä¸­å…è®¸å¯¹æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œç›‘å¬ï¼Œæ“ä½œç³»ç»Ÿæä¾›åŠŸèƒ½ï¼Œå½“æ–‡ä»¶çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–(å¯è¯»ã€å¯å†™ã€å¼‚å¸¸)ç¨‹åºèƒ½å¤Ÿè·å¾—è¿™ä¸€çŠ¶æ€ã€‚å¯¹æˆ‘ä»¬æ¥è¯´å°±æ˜¯å½“æ˜ç¡®çŸ¥é“æŸæ–‡ä»¶å­˜åœ¨ä»€ä¹ˆäº‹ä»¶çš„æ—¶å€™å»è§¦å‘ç›¸åº”çš„å¤„ç†å‡½æ•°ã€‚æ³¨æ„ï¼Œè¿™å°±æ˜¯ä¸€ä¸ª<span style="color:red"><strong>å›è°ƒã€å›è°ƒã€å›è°ƒ(é‡è¦çš„äº‹æƒ…è¯´ä¸‰é)</strong></span></p>
<p>å¯ä»¥æŠŠIOLoopå½“åšä¸€ä¸ªåœä¸ä¸‹æ¥çš„æ­»å¾ªç¯ï¼Œç±»ä¼¼ä¸‹é¢è¿™æ ·<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">import</span> bisect</div><div class="line"><span class="keyword">from</span> selectors <span class="keyword">import</span> DefaultSelector</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">IOLoop</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self._callback = set()</div><div class="line">        self._timeout = []</div><div class="line">        self.ioloop = DefaultSelector()</div><div class="line"></div><div class="line"><span class="meta">    @classmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">instance</span><span class="params">(cls)</span>:</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(cls, <span class="string">'_instance'</span>):</div><div class="line">            cls._instance = cls()</div><div class="line">        <span class="keyword">return</span> cls._instance</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_handler</span><span class="params">(self, fd, event, func)</span>:</span></div><div class="line">        self.ioloop.register(fd, event, func)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update_handler</span><span class="params">(self, fd, event)</span>:</span></div><div class="line">        temp = ioloop.get_key(fd)</div><div class="line">        ioloop.unregister(fd)</div><div class="line">        ioloop.register(fd, event, temp.data)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_callback</span><span class="params">(self, func)</span>:</span></div><div class="line">        self._callback.add(func)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_timeout</span><span class="params">(self, t, func)</span>:</span></div><div class="line">        <span class="class"><span class="keyword">class</span> <span class="title">_T</span>:</span></div><div class="line">            <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, t, func)</span>:</span></div><div class="line">                self.t = t</div><div class="line">                self.callback = func</div><div class="line"></div><div class="line">            <span class="function"><span class="keyword">def</span> <span class="title">__lt__</span><span class="params">(self, other)</span>:</span></div><div class="line">                <span class="keyword">return</span> self.t &lt; other.t</div><div class="line"></div><div class="line">            <span class="function"><span class="keyword">def</span> <span class="title">__gt__</span><span class="params">(self, other)</span>:</span></div><div class="line">                <span class="keyword">return</span> self.t &gt; other.t</div><div class="line"></div><div class="line">        t = _T(t, func)</div><div class="line">        bisect.insort(self._timeout, t)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></div><div class="line"></div><div class="line">        <span class="keyword">while</span> <span class="number">1</span>:</div><div class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> self._callback.copy():</div><div class="line">                i()</div><div class="line">                self._callback.remove(i)</div><div class="line"></div><div class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> self._timeout.copy():</div><div class="line">                <span class="keyword">if</span> time.time() &gt; i.t:</div><div class="line">                    i.callback()</div><div class="line">                    self._timeout.remove(i)</div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    <span class="keyword">break</span></div><div class="line"></div><div class="line">            <span class="keyword">for</span> k, v <span class="keyword">in</span> self.ioloop.select(timeout=<span class="number">0.2</span>):</div><div class="line">                k.data()</div></pre></td></tr></table></figure></p>
<p>ä½ åªéœ€è¦è®°ä½ä»¥ä¸‹å‡ ç‚¹</p>
<ol>
<li><span style="color:red"><strong>IOLoopæ˜¯ä¸€ä¸ªå•ä¾‹</strong></span></li>
<li>IOLoopæä¾›äº†å¤„ç†ä¸‰ç§æƒ…å†µçš„æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯å›è°ƒå½¢å¼(_callback)ã€å®šæ—¶å™¨å½¢å¼(_timeout)ã€ç½‘ç»œIO(selectors)</li>
<li>æœ€åæ˜¯ä¸€ä¸ªwhile 1çš„æ­»å¾ªç¯</li>
</ol>
<h3 id="Callback"><a href="#Callback" class="headerlink" title="Callback"></a>Callback</h3><p>æ­£å› ä¸ºIOLoopæ˜¯ä¸€ä¸ªå•ä¾‹ã€‚æ‰€ä»¥æ‰€æœ‰çš„å‡½æ•°æœ€ç»ˆéƒ½é€šè¿‡add_callbackã€add_timeoutã€add_handleræ”¾ç½®åˆ°äº†IOLoopä¸‹é¢ï¼Œæœ€ç»ˆè¢«æ‰§è¡Œstartä¾æ¬¡è°ƒç”¨ï¼Œå†è°ƒç”¨çš„è¿‡ç¨‹ä¸­ï¼Œè¿™äº›å‡½æ•°åˆä½¿ç”¨ioloop.IOLoop.instance().add_callbackç­‰ä¸æ–­çš„åŠ å…¥ä¸€äº›äº‹ä»¶å¤„ç†ã€‚å¯¼è‡´å½¢æˆäº†ä¸€ä¸ªcallbacké“¾æ¡ï¼Œè®©æˆ‘ä»¬æœ€ç»ˆå¾—åˆ°ç»“æœ<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ä»£ç ä¸ºpython3</span></div><div class="line"><span class="keyword">from</span> selectors <span class="keyword">import</span> DefaultSelector, EVENT_WRITE, EVENT_READ</div><div class="line"><span class="keyword">import</span> socket</div><div class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</div><div class="line"></div><div class="line">done = <span class="keyword">False</span></div><div class="line">selector = DefaultSelector()</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(url)</span>:</span></div><div class="line">    parse = urlparse(url)</div><div class="line">    s = socket.socket()</div><div class="line">    s.setblocking(<span class="keyword">False</span>)</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        s.connect((parse.hostname, <span class="number">80</span>))</div><div class="line">    <span class="keyword">except</span> BlockingIOError:</div><div class="line">        <span class="keyword">pass</span></div><div class="line">    selector.register(s.fileno(), EVENT_WRITE, <span class="keyword">lambda</span>: connected(s, parse.path, parse.hostname))</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">connected</span><span class="params">(s, path, host)</span>:</span></div><div class="line">    selector.unregister(s.fileno())</div><div class="line">    s.send((<span class="string">'GET &#123;&#125; HTTP/1.0\r\nHost:&#123;&#125;\r\n\r\n'</span>.format(path, host)).encode())</div><div class="line">    buf = []</div><div class="line">    selector.register(s.fileno(), EVENT_READ, <span class="keyword">lambda</span>: readable(s, buf))</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">readable</span><span class="params">(s, buf)</span>:</span></div><div class="line">    <span class="keyword">global</span> done</div><div class="line">    chunk = s.recv(<span class="number">1024</span>)</div><div class="line">    <span class="keyword">if</span> chunk:</div><div class="line">        buf.append(chunk)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        done = <span class="keyword">True</span></div><div class="line">        selector.unregister(s.fileno())</div><div class="line">        print((<span class="string">b''</span>.join(buf)).decode())</div><div class="line">        s.close()</div><div class="line"></div><div class="line"></div><div class="line">get(<span class="string">"http://httpbin.org/ip"</span>)</div><div class="line"></div><div class="line"><span class="keyword">while</span> <span class="keyword">not</span> done:</div><div class="line">    events = selector.select()</div><div class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> events:</div><div class="line">        k.data()</div></pre></td></tr></table></figure>    </p>
<p>å¦‚ä¸Šä¾‹.å½“æˆ‘ä»¬è°ƒç”¨get()å¼€å§‹æ‰§è¡Œä»£ç çš„æ—¶å€™å®ƒåªæ˜¯å¼€å¯äº†ç¬¬ä¸€æ­¥åˆ›å»ºäº†ä¸€ä¸ªsocketé“¾æ¥å¹¶åœ¨selectorä¸­æ³¨å†Œäº†ä¸€ä¸ªäº‹ä»¶ï¼Œç­‰å¾…READäº‹ä»¶è¢«è§¦å‘ï¼Œk.data()è¢«è°ƒç”¨ï¼Œå³connectedå‡½æ•°è¢«è°ƒç”¨ï¼Œå‘é€æ•°æ®ä¹‹åå†æ¬¡æ³¨å†ŒREADäº‹ä»¶ã€‚ä¾ç„¶ç­‰å¾…ç›´åˆ°k.data()è¢«è°ƒç”¨ï¼Œå³readableè¢«è°ƒç”¨ã€‚æœ€åç›´è‡³æ•°æ®è¯»å–å®Œæˆã€‚è¡¨ç¤ºæ•´ä¸ªè¿‡ç¨‹ç»“æŸ</p>
<h3 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h3><p>è§‚å¯ŸIOLoopä¾‹å­ä¸­çš„startæ­»å¾ªç¯å¯ä»¥çŸ¥é“ã€‚å®ƒå…¶å®ä¹Ÿæ˜¯ä¼´éšç€é˜»å¡çš„ï¼Œåœ¨<code>self.ioloop.select(timeout=0.2)</code>ä¸­å¦‚æœæŒç»­0.2ç§’æ²¡æœ‰ç­‰å¾…çš„IOäº‹ä»¶å‘ç”Ÿï¼Œé‚£ä¹ˆä¼šé˜»å¡0.2ç§’ï¼Œçœ‹ä¼¼0.2ç§’ä¹Ÿä¸é•¿ï¼Œä½†å…¶å®éå¸¸å¤§é‡çš„äº‹ä»¶å¹¶ä¸æ˜¯IOäº‹ä»¶ï¼Œè€Œæ˜¯åœ¨self._callbacké›†åˆä¸­ã€‚å› æ­¤ä»æ•ˆç‡æ–¹é¢è€ƒè™‘æ·»åŠ _callbackçš„æ—¶å€™è§¦å‘IOäº‹ä»¶ï¼Œè®©selectä¸å†å»é˜»å¡é‚£0.2ç§’ï¼Œå› æ­¤åˆ›å»ºäº†ä¸€ä¸ªç®¡é“å¯¹è±¡æ¥è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå½“æ·»åŠ çš„_callbackçš„æ—¶å€™åŒæ—¶å‘ç®¡é“å†™å…¥ä¸€ä¸ªå­—ç¬¦ã€‚é‚£ä¹ˆå°±ä¸å­˜åœ¨0.2ç§’çš„é˜»å¡äº†</p>
<h3 id="åº”ç”¨ä¸€-PeriodicCallback"><a href="#åº”ç”¨ä¸€-PeriodicCallback" class="headerlink" title="åº”ç”¨ä¸€ PeriodicCallback"></a>åº”ç”¨ä¸€ PeriodicCallback</h3><p>ioloop.pyä¸‹é¢æœ‰ä¸€ä¸ªéå¸¸ç®€å•çš„PeriodicCallbackç±»ï¼Œå®ƒçš„ä½œç”¨æ˜¯å®šæœŸå°†callbackåŠ å…¥åˆ°IOLoopçš„_timeoutåˆ—è¡¨ä¸­ã€‚æ¯”å¦‚ä½ éœ€è¦æ¯éš”ä¸‰ååˆ†é’Ÿå»æ¸…ç†ä¸€æ¬¡ä¸´æ—¶æ–‡ä»¶å¤¹äº§ç”Ÿçš„åƒåœ¾æ–‡ä»¶ç­‰ç­‰ã€‚ç®€æ˜“å®ç°å¤§æ¦‚æ˜¯è¿™æ ·<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PeriodicCallback</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, interval, func)</span>:</span></div><div class="line">        self.interval = interval</div><div class="line">        self.func = func</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></div><div class="line">        timeout = time.time() + self.interval</div><div class="line">        IOLoop.instance().add_timeout(timeout, self.callback)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">callback</span><span class="params">(self)</span>:</span></div><div class="line">        self.func()</div><div class="line">        self.start()</div></pre></td></tr></table></figure><br>å†æ‰§è¡Œstartä¹‹åæ·»åŠ åˆ°äº†_timeoutã€‚å¾…æ—¶é—´åˆ°è¾¾åæ‰§è¡Œä¸€æ¬¡ç„¶åå†è°ƒç”¨startï¼Œå¦‚æ­¤åå¤ğŸ˜³ã€‚æœ€åè¾¾åˆ°äº†æ— é™å¾ªç¯æ‰§è¡Œçš„æ•ˆæœ</p>
<h3 id="åº”ç”¨äºŒ-è‡ªåŠ¨é‡å¯"><a href="#åº”ç”¨äºŒ-è‡ªåŠ¨é‡å¯" class="headerlink" title="åº”ç”¨äºŒ è‡ªåŠ¨é‡å¯"></a>åº”ç”¨äºŒ è‡ªåŠ¨é‡å¯</h3><p>å¯¹äºwebæ¡†æ¶è€Œè¨€ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­å½“ä»£ç å‘ç”Ÿå˜æ›´è‡ªåŠ¨é‡å¯æœºåˆ¶å‡ ä¹æ˜¯éƒ½å¿…å¤‡çš„ã€‚åœ¨Flaskä¸­æ˜¯ä¸»çº¿ç¨‹å•ç‹¬å¼€äº†ä¸€ä¸ªè¿›ç¨‹ï¼Œåœ¨è¿›ç¨‹é‡Œé¢å°†ä¸»å‡½æ•°å¼€ä¸€ä¸ªçº¿ç¨‹è¿è¡Œã€‚ç„¶åæ‰§è¡Œæ­»å¾ªç¯è¿›è¡Œä»£ç å˜æ›´æ£€æµ‹ã€‚å‘ç°å˜æ›´åˆ™è¿›è¡Œè¿›ç¨‹é€€å‡ºæ“ä½œã€‚ä¸»çº¿ç¨‹æ•è·é€€å‡ºçŠ¶æ€è¿›è¡Œé‡å¯ã€‚ç¤ºä¾‹ä»£ç å¯ä»¥<a href="/2016/07/25/werkzeug_note_requests_response_auto_realod/index.html#çƒ­é‡å¯å®ç°åŸç†">çœ‹è¿™é‡Œ</a></p>
<p>å¯ä»¥çœ‹åˆ°è‡ªåŠ¨é‡å¯åŸºæœ¬ç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆã€‚</p>
<ol>
<li>ä¸»ä»£ç æ­£å¸¸æ‰§è¡Œ</li>
<li>æ£€æµ‹ä»£ç å˜æ›´é€»è¾‘å®šæœŸæ‰§è¡Œ</li>
<li>æ£€æµ‹åˆ°å˜æ›´åé‡å¯ç¨‹åº</li>
</ol>
<p>å¯¹äºç¬¬ä¸€ä¸ªæ¡ä»¶è€Œè¨€Tornadoæ²¡ä»€ä¹ˆï¼Œå°±æ˜¯ä¸»çº¿ç¨‹æ­£å¸¸æ“ä½œï¼Œç¬¬äºŒä¸ªæ¡ä»¶å°±åˆ©ç”¨äº†ä¸Šé¢è¯´çš„PeriodicCallbackï¼Œå°†æ£€æµ‹å‡½æ•°å®šæœŸæ‰§è¡Œå°±å¥½ã€‚ç¬¬ä¸‰ä¸ªæ¡ä»¶ä½¿ç”¨os.execvé‡è½½æ•´ä¸ªè¿›ç¨‹ã€‚bingo,æ²¡æœ‰å•ç‹¬çš„å¼€å¯çº¿ç¨‹ï¼Œå¼€å¯è¿›ç¨‹ã€‚å•çº¿ç¨‹å®Œæˆäº†è‡ªåŠ¨é‡å¯çš„æ“ä½œã€‚æœ€ç®€ä»£ç åº”è¯¥æ˜¯è¿™æ ·çš„<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> functools</div><div class="line"><span class="keyword">import</span> ioloop</div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> types</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(io_loop=None, check_time=<span class="number">500</span>)</span>:</span></div><div class="line">    io_loop = io_loop <span class="keyword">or</span> ioloop.IOLoop.instance()</div><div class="line">    modify_times = &#123;&#125;</div><div class="line">    callback = functools.partial(_reload_on_update, modify_times)</div><div class="line">    scheduler = ioloop.PeriodicCallback(callback, check_time, io_loop=io_loop)</div><div class="line">    scheduler.start()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_reload_on_update</span><span class="params">(modify_times)</span>:</span></div><div class="line">    <span class="keyword">for</span> module <span class="keyword">in</span> sys.modules.values():</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(module, types.ModuleType): <span class="keyword">continue</span></div><div class="line">        path = getattr(module, <span class="string">"__file__"</span>, <span class="keyword">None</span>)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> path: <span class="keyword">continue</span></div><div class="line">        <span class="keyword">if</span> path.endswith(<span class="string">".pyc"</span>) <span class="keyword">or</span> path.endswith(<span class="string">".pyo"</span>):</div><div class="line">            path = path[:<span class="number">-1</span>]</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            modified = os.stat(path).st_mtime</div><div class="line">        <span class="keyword">except</span>:</div><div class="line">            <span class="keyword">continue</span></div><div class="line">        <span class="keyword">if</span> path <span class="keyword">not</span> <span class="keyword">in</span> modify_times:</div><div class="line">            modify_times[path] = modified</div><div class="line">            <span class="keyword">continue</span></div><div class="line">        <span class="keyword">if</span> modify_times[path] != modified:</div><div class="line">            os.execv(sys.executable, [sys.executable] + sys.argv)</div></pre></td></tr></table></figure><br>ä½¿ç”¨sys.modulesæŸ¥çœ‹æ‰€æœ‰å·²åŠ è½½çš„æ¨¡å—ã€‚æ¯500æ¯«ç§’å°†æ–‡ä»¶æ”¹åŠ¨æ—¶é—´å’Œå·²æœ‰æ•°æ®è¿›è¡Œå¯¹æ¯”ã€‚å¦‚æœä¸åŒåˆ™æ‰§è¡Œos.execvè¦†ç›–æ‰å½“å‰è¿›ç¨‹ï¼Œåç»­è¯¥ä»£ç è™½ç„¶ä¸ºäº†è·¨å¹³å°é€»è¾‘ä¸Šæœ‰å˜åŠ¨ã€‚å¯æ˜¯æ•´ä½“æ€è·¯æ˜¯æ²¡æœ‰æ”¹å˜çš„</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æ€»ç»“è€Œè¨€IOLoopçš„é€»è¾‘è¿˜æ˜¯å¾ˆå¥½ç†è§£çš„ã€‚å®ƒå¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªç‹¬ç«‹æ€§éå¸¸å¼ºçš„æ¨¡å—ã€‚ä¸€ä¸ªå•ä¾‹ï¼Œæ•´ä½“æ˜¯ä¸€ä¸ªæ­»å¾ªç¯æä¾›ä¸‰ç§æƒ…å†µçš„å¤„ç†ã€‚åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¸æ–­çš„è°ƒç”¨å•ä¾‹çš„æˆå‘˜å‡½æ•°ï¼Œå®Œæˆå¯¹ä¸€ä¸ªäº‹åŠ¡(æ¯”å¦‚è·å¾—ä¸€ä¸ªç½‘é¡µçš„å†…å®¹)çš„å¤„ç†ã€‚è‡³äºä¸ºä»€ä¹ˆæ²¡æœ‰è¢«é˜»å¡ã€‚æ¯å½“è¦IOé˜»å¡çš„æ—¶å€™(æ¯”å¦‚connect)å°±æ³¨å†Œä¸€ä¸ªäº‹ä»¶å›è°ƒï¼Œç„¶åç»§ç»­è¿è¡Œä¸ä¼šé˜»å¡çš„éƒ¨åˆ†ã€‚ç­‰åˆ°äº‹ä»¶å®Œæˆå†è¿›è¡ŒIOæ“ä½œå°±ä¸ä¼šé˜»å¡äº†ã€‚ä»è€Œè¾¾åˆ°æ•´ä½“éé˜»å¡çš„æ•ˆæœ</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿™æ˜¯Tornadoç³»åˆ—çš„å¼€ç¯‡,Tornadoä½œä¸ºå¼‚æ­¥webæ¡†æ¶2010å¹´å‘å¸ƒ1.0ç‰ˆæœ¬ã€‚å¯ä»¥è¯´Pythonç¤¾åŒºæäº†è¿™ä¹ˆå¤šå¹´ï¼Œä¸ºäº†è·å¾—æ¯”å¤šçº¿ç¨‹å¤šè¿›ç¨‹æ›´é«˜çš„æ€§èƒ½ï¼Œç»å†äº†Twistedã€Tornadoã€yieldã€geventã€yield fromã€asyncioã€‚ä¹Ÿä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™æ‰æ˜¯ä¸€ä¸ªå°½å¤´~~ã€‚Tornadoè¿‡äº†è¿™ä¹ˆå¤šå¹´è¿˜ç®—å¼€å‘æ´»è·ƒ(&lt;a href=&quot;https://github.com/tornadoweb/tornado/graphs/contributors&quot;&gt;ä¸€ä¸ªå¤§ç¥æ‰›èµ·äº†ä¸€ç‰‡å¤©å•Š&lt;/a&gt;)ï¼Œä¸åŒäºå¤šçº¿ç¨‹æ¨¡å‹çš„ä¸€æ½­æ­»æ°´ï¼Œçœ‹å®ƒçš„ä»£ç ä½ ä¼šå‘ç°å®ƒè¿˜æ˜¯ç´§è·Ÿæ½®æµçš„ï¼Œè€Œä¸”æœ‰ä¸€ç‚¹ã€‚å®ƒçš„å†…éƒ¨è™½ç„¶ä¸€ç›´åœ¨å˜åŠ¨ï¼Œä½†æ˜¯æä¾›ç»™ç”¨æˆ·çš„ä½¿ç”¨æ¥å£æ˜¯å¾ˆç¨³å®šçš„ï¼Œåç»­å°±ä¼šå‘ç°è¿™ä¸ªå‘æœ‰å¤šå¤§&lt;/p&gt;
    
    </summary>
    
      <category term="Tornado" scheme="https://www.zoulei.net/categories/Tornado/"/>
    
    
  </entry>
  
  <entry>
    <title>Pythoné«˜çº§å¤šçº¿ç¨‹å¹¶å‘</title>
    <link href="https://www.zoulei.net/2018/03/12/python_concurrent_futures_thread/"/>
    <id>https://www.zoulei.net/2018/03/12/python_concurrent_futures_thread/</id>
    <published>2018-03-12T10:49:33.000Z</published>
    <updated>2018-03-12T11:27:47.101Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å¤šçº¿ç¨‹å¤šè¿›ç¨‹å½“é“çš„å¹´ä»£è¿™ä¸ªè¢«ç§°ä¸ºé«˜çº§å¹¶å‘çš„æ¨¡å—è¿˜æ˜¯å¾ˆä»¤äººæƒŠè‰³çš„ã€‚concurrent.futureæ¨¡å—çš„å‰å®³ä¹‹å¤„åœ¨äºå°è£…äº†å¤šçº¿ç¨‹ã€å¤šè¿›ç¨‹ã€é”ã€é˜Ÿåˆ—åˆ°ä¸€èµ·ã€‚è¿™äº›ç»†èŠ‚ä½¿ç”¨è€…éƒ½ä¸éœ€è¦çŸ¥é“ã€‚å››äº”è¡Œä»£ç èƒ½å®ç°ä»¥å¾€äºŒä¸‰åè¡Œå®ç°çš„æ•ˆæœã€‚è€Œä¸”å¤šçº¿ç¨‹å’Œå¤šè¿›ç¨‹çš„ä½¿ç”¨æ–¹å¼å®Œå…¨ä¸€æ ·ï¼Œå ªç§°å®Œç¾æ°ä½œã€‚å¯æƒœï¼Œç°åœ¨å·²ç»æ˜¯å¼‚æ­¥æ—¶ä»£äº†ï¼Œä¸»è¦æ˜¯å› ä¸ºtornadoç”¨åˆ°äº†å®ƒçš„Futureæ¨¡å—ã€‚æˆ‘å°±çœ‹çœ‹å®ƒå¤§æ¦‚æ˜¯æ€æ ·å®ç°çš„</p>
<a id="more"></a>
<p>æ¥è‡ªå®˜æ–¹æ–‡æ¡£çš„ç¤ºä¾‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> concurrent.futures</div><div class="line"><span class="keyword">import</span> urllib.request</div><div class="line"></div><div class="line">URLS = [<span class="string">'http://www.foxnews.com/'</span>,</div><div class="line">        <span class="string">'http://www.cnn.com/'</span>,</div><div class="line">        <span class="string">'http://europe.wsj.com/'</span>,</div><div class="line">        <span class="string">'http://www.bbc.co.uk/'</span>,</div><div class="line">        <span class="string">'http://some-made-up-domain.com/'</span>]</div><div class="line"></div><div class="line"><span class="comment"># Retrieve a single page and report the URL and contents</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_url</span><span class="params">(url, timeout)</span>:</span></div><div class="line">    <span class="keyword">with</span> urllib.request.urlopen(url, timeout=timeout) <span class="keyword">as</span> conn:</div><div class="line">        <span class="keyword">return</span> conn.read()</div><div class="line"></div><div class="line"><span class="comment"># We can use a with statement to ensure threads are cleaned up promptly</span></div><div class="line"><span class="keyword">with</span> concurrent.futures.ThreadPoolExecutor(max_workers=<span class="number">5</span>) <span class="keyword">as</span> executor:</div><div class="line">    <span class="comment"># Start the load operations and mark each future with its URL</span></div><div class="line">    future_to_url = &#123;executor.submit(load_url, url, <span class="number">60</span>): url <span class="keyword">for</span> url <span class="keyword">in</span> URLS&#125;</div><div class="line">    <span class="keyword">for</span> future <span class="keyword">in</span> concurrent.futures.as_completed(future_to_url):</div><div class="line">        url = future_to_url[future]</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            data = future.result()</div><div class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</div><div class="line">            print(<span class="string">'%r generated an exception: %s'</span> % (url, exc))</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            print(<span class="string">'%r page is %d bytes'</span> % (url, len(data)))</div></pre></td></tr></table></figure>
<p>é¦–å…ˆè€ƒè™‘ä¸€ä¸ªé—®é¢˜ã€‚åœ¨å¤šçº¿ç¨‹é‡Œé¢ï¼Œä¸€èˆ¬æˆ‘ä»¬ç›´æ¥<code>threading.Thread(target=)</code>,ä½†æ˜¯ç›´æ¥è¿è¡Œä¸ä¼šå¾—åˆ°è¿”å›çš„ç»“æœçš„ã€‚è¿™é‡Œå°±ç”¨åˆ°äº†<code>Future</code>å¯¹è±¡ã€‚ç±»ä¼¼ä¸è£…é¥°å™¨ï¼Œæœ€ç»ˆè¿è¡Œçš„å‡½æ•°è¢«åµŒå¥—ï¼Œç»“æœè¢«æ·»åŠ åˆ°<code>Future</code>å¯¹è±¡ä¸Šã€‚ä½ å¯ä»¥å°†<code>Future</code>å½“åšä¸€ä¸ªåŠå…¶ç®€å•çš„å¯¹è±¡ï¼Œå°±åƒä¸‹é¢è¿™æ ·<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Future</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.result = <span class="keyword">None</span></div><div class="line">        self._state = <span class="string">"PENDING"</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_result</span><span class="params">(self, value)</span>:</span></div><div class="line">        self._state = <span class="string">"FINISHED"</span></div><div class="line">        self.result = value</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_result</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.result</div></pre></td></tr></table></figure></p>
<p>å› æ­¤æœ€ç»ˆæœ€æ–°çš„å¹¶éæ˜¯åŸå§‹çš„å‡½æ•°ã€‚æ­¤å¤„è¢«å°è£…æˆäº†WorkItemå¯¹è±¡<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WorkerItem</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, future, fn, *args, **kwargs)</span>:</span></div><div class="line">        self.fn = fn</div><div class="line">        self.args = args</div><div class="line">        self.kwargs = kwargs</div><div class="line">        self.future = future</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            ret = self.fn(*self.args, **self.kwargs)</div><div class="line">            self.future.set_result(ret)</div><div class="line"></div><div class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">            self.future.set_result(e)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_worker</span><span class="params">(work_queue)</span>:</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">            work_item = work_queue.get(block=<span class="keyword">True</span>)</div><div class="line">            <span class="keyword">if</span> work_item <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">                work_item.run()</div><div class="line">    <span class="keyword">except</span> BaseException:</div><div class="line">        traceback.print_exc()</div></pre></td></tr></table></figure></p>
<p>å…¶æ¬¡å®ƒèƒ½å¤Ÿå…è®¸å¯¹åˆ›å»ºçš„çº¿ç¨‹æ•°é‡è¿›è¡Œæ§åˆ¶max_clientã€‚è¿™ä¸ªä¹Ÿå¯ä»¥æƒ³åˆ°é€šè¿‡é˜Ÿåˆ—æ¥æ§åˆ¶ï¼Œå½“submitåˆ›å»ºä»»åŠ¡çš„æ—¶å€™å¹¶ä¸æ˜¯ç›´æ¥è°ƒç”¨threading.Threadåˆ›å»ºä¸€ä¸ªå…¨æ–°çš„çº¿ç¨‹ã€‚è€Œæ˜¯ä»…ä»…æŠŠå®ƒåŠ å…¥åˆ°é˜Ÿåˆ—ï¼Œåˆ¤æ–­å½“å‰çº¿ç¨‹æ•°é‡æ˜¯å¦å°äºæœ€å¤§æ•°é‡ã€‚å½“ç„¶åœ¨çº¿ç¨‹ä¸­å°±æ˜¯ä¸æ–­å¾ªç¯æ‰§è¡ŒWorkã€‚<code>Future</code>ã€<code>WorkItem</code>ã€<code>_worker</code>éƒ½æ˜¯å½±è—æ²¡æœ‰å¯¹ç”¨æˆ·æš´éœ²ã€‚çœŸæ­£å¯¹ç”¨æˆ·æš´éœ²çš„åªæœ‰ä¸€ä¸ªThreadPoolExecutor,å¤§æ¦‚å¯ä»¥è¿™æ ·è®¤ä¸º</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolExecutor</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, max_workers)</span>:</span></div><div class="line">        self.max_workers = max_workers</div><div class="line">        self._queue = Queue()</div><div class="line">        self._thread = set()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">submit</span><span class="params">(self, fn, *args, **kwargs)</span>:</span></div><div class="line">        f = Future()</div><div class="line">        worker_item = WorkerItem(f, fn, *args, **kwargs)</div><div class="line">        self._queue.put(worker_item)</div><div class="line">        <span class="keyword">if</span> len(self._thread) &lt; self.max_workers:</div><div class="line">            t = Thread(target=_worker, args=(self._queue,))</div><div class="line">            t.daemon = <span class="keyword">True</span></div><div class="line">            t.start()</div><div class="line">        <span class="keyword">return</span> f</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> self._thread:</div><div class="line">            i.join()</div></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°æ¯æ¬¡submitåä¼šå¾—åˆ°ä¸€ä¸ª<code>Future</code>å¯¹è±¡ã€‚è®¾æƒ³ä¸€ä¸‹å½“çº¿ç¨‹æ‰§è¡Œå¾—åˆ°ç»“æœåæˆ‘ä»¬å¯ä»¥æ ¹æ®<code>Future</code>çš„çŠ¶æ€è½®è¯¢å¾—åˆ°æˆ‘ä»¬éœ€è¦çš„ç»“æœã€‚å¤§æ¦‚å¯ä»¥è¿™æ ·å†™<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">5</span>) <span class="keyword">as</span> executor:</div><div class="line">    future_to_url = &#123;executor.submit(load_url, url, <span class="number">1</span>): url <span class="keyword">for</span> url <span class="keyword">in</span> URLS&#125;</div><div class="line">    <span class="keyword">while</span> <span class="number">1</span>:</div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> future_to_url.copy().keys():</div><div class="line">            <span class="keyword">if</span> i._state == <span class="string">"FINISHED"</span>:</div><div class="line">                print(i.get_result())</div><div class="line">                future_to_url.pop(i)</div><div class="line">        <span class="keyword">if</span> len(future_to_url) == <span class="number">0</span>:</div><div class="line">            <span class="keyword">break</span></div></pre></td></tr></table></figure></p>
<p><span style="color:red"><strong>ä½†æ˜¯å¯èƒ½ä½œè€…è§‰å¾—è¿™ç§æ–¹å¼å¤ªlow,æ•ˆç‡å¤ªä½ã€‚å®ç°äº†ä¸€ä¸ªas_completedå‡½æ•°ï¼Œç›´æ¥è®©ç†è§£éš¾åº¦æå‡ä¸€ä¸ªæ•°é‡çº§ã€‚ã€‚ã€‚ã€‚</strong></span></p>
<p>å¤§æ¦‚å°±æ˜¯å…ˆç”Ÿæˆäº†ä¸€ä¸ªwaiterså¯¹è±¡(è¿™ä¸ªå¯¹è±¡æœ‰threading.Event)ï¼Œå¹¶å°†è¿™äº›å¯¹è±¡æ·»åŠ åˆ°æ‰€æœ‰çš„æœªå®Œæˆçš„Futuresä¸­ã€‚ä»»ä¸€å¯¹è±¡å®Œæˆåˆ™ä¼šè§¦å‘äº‹ä»¶çš„è®¾ç½®ã€‚è¿™æ ·é˜»å¡è¢«æš‚æ—¶å–æ¶ˆï¼Œå¯ä»¥å¾—åˆ°ç»“æœè¿”å›ï¼Œä»£ç æ³¨é‡Šå¦‚ä¸‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">as_completed</span><span class="params">(fs, timeout=None)</span>:</span></div><div class="line">    <span class="keyword">if</span> timeout <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">        end_time = timeout + time.time()</div><div class="line"></div><div class="line">    fs = set(fs)</div><div class="line">    <span class="keyword">with</span> _AcquireFutures(fs):</div><div class="line">        <span class="comment"># å…ˆæŒ‘é€‰å‡ºæ‰€æœ‰å·²ç»æœ‰ç»“æœçš„Future</span></div><div class="line">        finished = set(</div><div class="line">                f <span class="keyword">for</span> f <span class="keyword">in</span> fs</div><div class="line">                <span class="keyword">if</span> f._state <span class="keyword">in</span> [CANCELLED_AND_NOTIFIED, FINISHED])</div><div class="line">        pending = fs - finished</div><div class="line">        <span class="comment"># åˆ›å»ºäº†ä¸€ä¸ªwaiterå¯¹è±¡ã€‚è¯¥å¯¹è±¡ç”¨äºthreading.Eventã€‚ç„¶åå°†è‡ªèº«æ·»åŠ åˆ°äº†æ‰€æœ‰çš„Futuresä¸Šé¢</span></div><div class="line">        waiter = _create_and_install_waiters(fs, _AS_COMPLETED)</div><div class="line"></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="comment"># å…ˆä¾æ¬¡è¿”å›å·²å®Œæˆçš„Future</span></div><div class="line">        <span class="keyword">yield</span> <span class="keyword">from</span> finished</div><div class="line"></div><div class="line">        <span class="keyword">while</span> pending:</div><div class="line">            <span class="keyword">if</span> timeout <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">                wait_timeout = <span class="keyword">None</span></div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                wait_timeout = end_time - time.time()</div><div class="line">                <span class="keyword">if</span> wait_timeout &lt; <span class="number">0</span>:</div><div class="line">                    <span class="keyword">raise</span> TimeoutError(</div><div class="line">                            <span class="string">'%d (of %d) futures unfinished'</span> % (</div><div class="line">                            len(pending), len(fs)))</div><div class="line">            </div><div class="line">            <span class="comment"># å½“Futureè¢«è¿›è¡Œè®¾ç½®ç»“æœä¼šè§¦å‘threading.Event.set</span></div><div class="line">            <span class="comment"># é‚£ä¹ˆè¯¥å¤„çš„é˜»å¡å°±ä¼šè¢«å–æ¶ˆ</span></div><div class="line">            waiter.event.wait(wait_timeout)</div><div class="line"></div><div class="line">            <span class="keyword">with</span> waiter.lock:</div><div class="line">                <span class="comment"># åˆå¾—åˆ°ä¸€æ‰¹å·²å®Œæˆçš„Futures</span></div><div class="line">                finished = waiter.finished_futures</div><div class="line">                waiter.finished_futures = []</div><div class="line">                <span class="comment"># å–æ¶ˆçŠ¶æ€,ç­‰å¾…ä¸‹ä¸€æ¬¡çš„set</span></div><div class="line">                waiter.event.clear()</div><div class="line">            </div><div class="line">            <span class="comment"># ä¾æ¬¡è¿”å›å¹¶ä»pendingé˜Ÿåˆ—ä¸­ç§»å‡º</span></div><div class="line">            <span class="keyword">for</span> future <span class="keyword">in</span> finished:</div><div class="line">                <span class="keyword">yield</span> future</div><div class="line">                pending.remove(future)</div><div class="line"></div><div class="line">    <span class="keyword">finally</span>:</div><div class="line">        <span class="keyword">for</span> f <span class="keyword">in</span> fs:</div><div class="line">            <span class="keyword">with</span> f._condition:</div><div class="line">                f._waiters.remove(waiter)</div></pre></td></tr></table></figure></p>
<p>å¤šçº¿ç¨‹çš„æ–¹å¼ç›¸è¾ƒå¤šè¿›ç¨‹è¦ç®€å•å¾ˆå¤šã€‚å¤šè¿›ç¨‹çš„å®ç°æœ‰æœºä¼šå†å†™ç»­ç¯‡~~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨å¤šçº¿ç¨‹å¤šè¿›ç¨‹å½“é“çš„å¹´ä»£è¿™ä¸ªè¢«ç§°ä¸ºé«˜çº§å¹¶å‘çš„æ¨¡å—è¿˜æ˜¯å¾ˆä»¤äººæƒŠè‰³çš„ã€‚concurrent.futureæ¨¡å—çš„å‰å®³ä¹‹å¤„åœ¨äºå°è£…äº†å¤šçº¿ç¨‹ã€å¤šè¿›ç¨‹ã€é”ã€é˜Ÿåˆ—åˆ°ä¸€èµ·ã€‚è¿™äº›ç»†èŠ‚ä½¿ç”¨è€…éƒ½ä¸éœ€è¦çŸ¥é“ã€‚å››äº”è¡Œä»£ç èƒ½å®ç°ä»¥å¾€äºŒä¸‰åè¡Œå®ç°çš„æ•ˆæœã€‚è€Œä¸”å¤šçº¿ç¨‹å’Œå¤šè¿›ç¨‹çš„ä½¿ç”¨æ–¹å¼å®Œå…¨ä¸€æ ·ï¼Œå ªç§°å®Œç¾æ°ä½œã€‚å¯æƒœï¼Œç°åœ¨å·²ç»æ˜¯å¼‚æ­¥æ—¶ä»£äº†ï¼Œä¸»è¦æ˜¯å› ä¸ºtornadoç”¨åˆ°äº†å®ƒçš„Futureæ¨¡å—ã€‚æˆ‘å°±çœ‹çœ‹å®ƒå¤§æ¦‚æ˜¯æ€æ ·å®ç°çš„&lt;/p&gt;
    
    </summary>
    
      <category term="python" scheme="https://www.zoulei.net/categories/python/"/>
    
    
  </entry>
  
  <entry>
    <title>Pythonä¸­çš„å¤šçº¿ç¨‹é”</title>
    <link href="https://www.zoulei.net/2018/03/12/Python_Thread_Lock/"/>
    <id>https://www.zoulei.net/2018/03/12/Python_Thread_Lock/</id>
    <published>2018-03-12T06:16:13.000Z</published>
    <updated>2018-03-12T09:21:24.786Z</updated>
    
    <content type="html"><![CDATA[<p>å¤šçº¿ç¨‹æ˜¯ä¸ªå‘çˆ¹çš„è¯¾é¢˜ï¼Œæœ‰å¤šçº¿ç¨‹å°±æœ‰é”ã€‚Pythonä¸­æœ‰ä½çº§çº¿ç¨‹æ¨¡å—_threadã€å†å°è£…ä¸€ä¸‹å°±æ˜¯threadingã€å†æ¥ä¸€ä¸‹å°±æ˜¯<code>from concurrent.futures import ThreadPoolExecutor</code>ã€‚å…¶ä¸­æ¶‰åŠåˆ°çš„é”å¤§æ¦‚æœ‰Lockã€RLockã€Conditionã€Semaphoreã€BoundedSeamphoreã€Eventã€‚è¿™ä¹ˆå¤šçœ‹èµ·æ¥æ€ªå“äººçš„ï¼Œå…¶å®è¿™ä¹ˆå¤šçš„é”å…¨éƒ¨åªæ˜¯ç”±Lockæ¼”åŒ–å‡ºæ¥çš„</p>
<a id="more"></a>
<h3 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h3><p><code>Lock = _thread._allocate_lock</code> è¿™ä¸ªæ˜¯ç›´æ¥ç”±æœ€ä½çº§åˆ«çš„_threadç›´æ¥å¼•ç”¨è¿‡æ¥çš„ã€‚åˆ›å»ºé”çš„æ—¶å€™æ˜¯å¤„äºæœªè¢«é”å®šçš„çŠ¶æ€ã€‚è¿™åº”è¯¥æ˜¯æœ€å®¹æ˜“è¢«ç†è§£å’Œä½¿ç”¨çš„ä¸€ç§é”äº†ã€‚åˆšå­¦ä¹ çš„æ—¶å€™é“å®šå†™è¿‡ç±»ä¼¼ä¸‹é¢è¿™ç§ç¤ºä¾‹ã€‚æœ¬è´¨åŸå› æ˜¯pythonä¸­çš„åŸå­æ“ä½œæ˜¯é’ˆå¯¹å•æ¡æŒ‡ä»¤ã€‚è€Œa+=1è¢«ç¿»è¯‘æˆäº†å¤šæ¡æŒ‡ä»¤ã€‚æ‰§è¡Œè¿‡ç¨‹ä¸­ä»»ä½•æ—¶åˆ»å¯èƒ½è¢«æ‰“æ–­</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">a = <span class="number">0</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">global</span> a</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100000</span>):</div><div class="line">        a += <span class="number">1</span></div><div class="line"></div><div class="line">t = [threading.Thread(target=change) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>)]</div><div class="line">[i.start() <span class="keyword">for</span> i <span class="keyword">in</span> t]</div><div class="line">[i.join() <span class="keyword">for</span> i <span class="keyword">in</span> t]</div><div class="line">print(a)</div></pre></td></tr></table></figure>
<p>è§£å†³æ–¹æ³•å°±æ˜¯<span style="color:red"><strong>æ‰€æœ‰çº¿ç¨‹å…±äº«åŒä¸€ä¸ªé”ï¼Œè™½ç„¶é”æœ‰å¾ˆå¤šç§ï¼Œä½†æ˜¯å‡ ä¹éƒ½æ˜¯è¿™æ ·æš´éœ²ç»™ç”¨æˆ·ä½¿ç”¨çš„</strong></span>ï¼Œè¿™æ˜¯å¤§å®¶éƒ½çŸ¥é“çš„ã€‚ä¸€ä¸ªé”éƒ½å¥½ç†è§£ã€‚å¦‚æœæœ‰ä¸¤ä¸ªé”å°±ä¸æ˜¯é‚£ä¹ˆå¥½ç†è§£äº†ï¼Œæ¯”å¦‚è¿™ä¸ªæœ‰ç‚¹è£…é€¼çš„ä¾‹å­ã€‚äº¤å‰æ‰“å°Helloå’ŒWorld</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">lock_a = Lock()</div><div class="line">lock_b = Lock()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</div><div class="line">        lock_a.acquire()</div><div class="line">        time.sleep(<span class="number">0.1</span>)</div><div class="line">        print(<span class="string">"Hello"</span>)</div><div class="line">        lock_b.release()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">world</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</div><div class="line">        lock_b.acquire()</div><div class="line">        time.sleep(<span class="number">0.1</span>)</div><div class="line">        print(<span class="string">"World"</span>)</div><div class="line">        lock_a.release()</div><div class="line"></div><div class="line">Thread(target=hello).start()</div><div class="line">Thread(target=world).start()</div></pre></td></tr></table></figure>
<h3 id="RLock"><a href="#RLock" class="headerlink" title="RLock"></a>RLock</h3><p>å¯é‡å…¥é”å…è®¸çº¿ç¨‹è·å¾—é”ä¹‹åè¯¥çº¿ç¨‹å¯ä»¥æ— æ•°æ¬¡çš„å†æ¬¡è·å¾—é”ã€‚çœ‹èµ·æ¥æ²¡ä»€ä¹ˆç”¨ï¼Œå¤§æ¦‚ä¹Ÿç¡®å®æ²¡å•¥ç”¨å§ï¼Œä¸è¿‡è€ƒè™‘ä¸€ä¸‹ä¸‹é¢è¿™ç§åœºæ™¯<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Change</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.a = <span class="number">1</span></div><div class="line">        self.b = <span class="number">1</span></div><div class="line">        self.lock = RLock()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">adda</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> self.lock:</div><div class="line">            self.a += <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">addb</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> self.lock:</div><div class="line">            self.b += <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">addab</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> self.lock:</div><div class="line">            self.adda()</div><div class="line">            self.addb()</div></pre></td></tr></table></figure><br>ä½ æœ‰ä¸€ä¸ªç±»ã€‚å…¶ä¸­addaæ”¹å˜a,addbæ”¹å˜b.è¿˜æä¾›æ–¹æ³•addabåŒæ—¶è°ƒç”¨å‰ä¸¤è€…ã€‚å¦‚æœæ²¡æœ‰å¯é‡å…¥é”é‚£ä¹ˆä½ å°†ä¸å¾—ä¸æŠŠä¸¤ä¸ªå‡½æ•°ç²˜è´´åˆ°addabä¸‹é¢ã€‚å®ƒçš„å®ç°åŸç†æ˜¯è·å–é”çš„æ—¶å€™æ ¹æ®get_identå¾—åˆ°å½“å‰çº¿ç¨‹æ ‡è¯†ã€‚å¦‚æœå’Œå½“å‰é”çš„æ ‡è¯†ä¸€æ ·åˆ™ä»…ä»…æ˜¯ç»™å€¼åŠ 1ï¼Œå¦åˆ™å°±å°è¯•å»è·å–é”ã€‚ç®€è¦ä»£ç å¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Lock, get_ident</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RLock</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.lock = Lock()</div><div class="line">        self._owner = <span class="keyword">None</span></div><div class="line">        self._count = <span class="number">0</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">acquire</span><span class="params">(self)</span>:</span></div><div class="line">        me = get_ident()</div><div class="line">        <span class="keyword">if</span> self._owner == me:</div><div class="line">            self._count += <span class="number">1</span></div><div class="line">            <span class="keyword">return</span></div><div class="line">        rc = self.lock.acquire()</div><div class="line">        <span class="keyword">if</span> rc:</div><div class="line">            self._owner = me</div><div class="line">            self._count = <span class="number">1</span></div><div class="line"></div><div class="line">    __enter__ = acquire</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">release</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">if</span> self._owner != get_ident():</div><div class="line">            <span class="keyword">raise</span> RuntimeError()</div><div class="line">        self._count -= <span class="number">1</span></div><div class="line">        <span class="keyword">if</span> self._count == <span class="number">0</span>:</div><div class="line">            self._owner = <span class="keyword">None</span></div><div class="line">            self.lock.release()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></div><div class="line">        self.release()</div></pre></td></tr></table></figure>
<h2 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h2><p>è¢«ç§°ä¸ºæ¡ä»¶å˜é‡ï¼Œè¿™ä¸ªåº”è¯¥æ˜¯å¾ˆå°‘è¢«ä½¿ç”¨çš„ã€‚å®ƒå…è®¸ä¼ å…¥ä¸€ä¸ªé”ï¼Œå½“æ»¡è¶³æ¡ä»¶çš„æ—¶å€™è§¦å‘é€šçŸ¥(å¯ä»¥çœ‹ä¸€ä¸‹queueæ¨¡å—çš„å®ç°ï¼Œå½“getä¸åˆ°æ•°æ®çš„æ—¶å€™å°±æ‰§è¡Œwaitç­‰å¾…ï¼Œæ–°åŠ å…¥æ•°æ®çš„æ—¶å€™æ‰§è¡Œnotifyé€šçŸ¥å”¤é†’)ï¼Œè¿™åº”è¯¥æ˜¯å®ƒè¢«ç§°ä¸ºæ¡ä»¶å˜é‡çš„åŸå› (æ„Ÿè§‰éƒ½æœ‰ç‚¹ç‰µå¼ºğŸ˜•),å’ŒLockä»¥åŠRLockä¸åŒã€‚è¿™ä¸ªä¸œä¸œä¸»è¦æ˜¯ç”¨æ¥é€šçŸ¥å…¶ä»–çº¿ç¨‹çš„ã€‚å¤§æ¦‚æœ‰ä¸¤ä¸ªæ–¹æ³•wait(é˜»å¡ç›´åˆ°è¢«é€šçŸ¥)ï¼Œnotify(å”¤é†’wait)ã€‚<br>å®ç°çš„æ€è·¯æ˜¯æ‰€æœ‰çš„çº¿ç¨‹å…±äº«åŒä¸€ä¸ªé”Aï¼ŒåŒæ—¶æœ‰ä¸€ä¸ªå…±ç”¨çš„é”åˆ—è¡¨ã€‚æ¯å½“è°ƒç”¨waitçš„æ—¶å€™ç”Ÿæˆä¸€ä¸ªæ–°çš„é”æ”¾å…¥é”åˆ—è¡¨ï¼Œç„¶åè·å¾—è¯¥é”ï¼Œå†é‡Šæ”¾é”A(å› ä¸ºwaitå¿…é¡»åœ¨è·å¾—é”Aæ‰èƒ½è°ƒç”¨ï¼Œå¦‚æœä¸é‡Šæ”¾åˆ™å…¶ä»–çº¿ç¨‹æ— æ³•è·å¾—é”A)ã€‚æœ€ç»çš„æ¥äº†ï¼Œ<span style="color:red"><strong>å†æ¬¡è·å¾—æ–°ç”Ÿæˆçš„é”é€ æˆæ­»é”</strong></span>ã€‚ç”±æ­¤è¯¥çº¿ç¨‹è¢«æŒ‚èµ·ã€‚ç›´åˆ°å…¶ä»–è·å¾—é”Açš„çº¿ç¨‹æ‰§è¡Œnotifyæ“ä½œã€‚å°†waitçš„é”é‡Šæ”¾ã€‚<br>å®ç°ä»£ç å¦‚ä¸‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Condition</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self._lock = RLock()</div><div class="line">        self._waiters = deque()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self._lock.__enter__()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, *args)</span>:</span></div><div class="line">        <span class="keyword">return</span> self._lock.__exit__(*args)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">assert</span> get_ident() == self._lock._owner</div><div class="line">        waiter = Lock()</div><div class="line">        self._waiters.append(waiter)</div><div class="line"></div><div class="line">        waiter.acquire()</div><div class="line">        self._lock.release()</div><div class="line">        waiter.acquire()</div><div class="line">        self._lock.acquire()</div><div class="line">        <span class="keyword">del</span> waiter</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">notify</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">assert</span> get_ident() == self._lock._owner</div><div class="line">        <span class="keyword">for</span> waiter <span class="keyword">in</span> self._waiters.copy():</div><div class="line">            waiter.release()</div><div class="line">            self._waiters.remove(waiter)</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªä¸œä¸œå§å…¶å®ä¸å¤ªé€‚åˆè¢«ç›´æ¥ä½¿ç”¨ã€‚ä½†æ˜¯ç½‘ä¸Šè¿˜æ˜¯æœ‰äººç¡¬ç”Ÿç”Ÿå‡‘äº†ä¸€ä¸ªæ¶ˆè´¹è€…ç”Ÿäº§è€…çš„ä¾‹å­å‡ºæ¥åšæ¼”ç¤º<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> threading</div><div class="line"><span class="keyword">import</span> random</div><div class="line"><span class="keyword">import</span> time</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Producer</span><span class="params">(threading.Thread)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, integers, condition)</span>:</span></div><div class="line">        super(Producer, self).__init__()</div><div class="line">        self.integers = integers</div><div class="line">        self.condition = condition</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</div><div class="line">            integer = random.randint(<span class="number">0</span>, <span class="number">256</span>)</div><div class="line">            <span class="keyword">with</span> self.condition:</div><div class="line">                self.integers.append(integer)</div><div class="line">                self.condition.notify()</div><div class="line">                time.sleep(<span class="number">0.5</span>)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Consumer</span><span class="params">(threading.Thread)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, integers, condition)</span>:</span></div><div class="line">        super(Consumer, self).__init__()</div><div class="line">        self.integers = integers</div><div class="line">        self.condition = condition</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> self.condition:</div><div class="line">            <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">                <span class="keyword">while</span> self.integers:</div><div class="line">                    integer = self.integers.pop()</div><div class="line">                    print(integer)</div><div class="line">                self.condition.wait()</div><div class="line"></div><div class="line">integers = []</div><div class="line">condition = Condition()</div><div class="line">Producer(integers, condition).start()</div><div class="line">Consumer(integers, condition).start()</div></pre></td></tr></table></figure><br>è¿™ä¸ªä¾‹å­æœ‰ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ã€‚notifyå’Œwaitå¹¶ä¸æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚ä¸ä»£è¡¨æ‰§è¡Œäº†notifyï¼Œwaitéƒ¨åˆ†ä¸€å®šä¼šè¢«æ‰§è¡Œã€‚æ‰€ä»¥å¦‚æœæ¶ˆè´¹è€…éƒ¨åˆ†è¿™æ ·å†™ä¼šé€ æˆéƒ¨åˆ†æ²¡æœ‰è¢«å¤„ç†<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Consumer</span><span class="params">(threading.Thread)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, integers, condition)</span>:</span></div><div class="line">        super(Consumer, self).__init__()</div><div class="line">        self.integers = integers</div><div class="line">        self.condition = condition</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> self.condition:</div><div class="line">            <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">                self.condition.wait()</div><div class="line">                integer = self.integers.pop()</div><div class="line">                print(integer)</div></pre></td></tr></table></figure></p>
<h3 id="Semaphore-amp-BoundedSeamphore"><a href="#Semaphore-amp-BoundedSeamphore" class="headerlink" title="Semaphore &amp; BoundedSeamphore"></a>Semaphore &amp; BoundedSeamphore</h3><p>ä¸Šé¢å…ˆä»‹ç»Conditionæ˜¯æœ‰åŸå› çš„ï¼Œå› ä¸ºå¤šçº¿ç¨‹ä¿¡å·é‡å’Œäº‹ä»¶éƒ½æ˜¯åŸºäºå®ƒç”Ÿæˆçš„ã€‚ä¿¡å·é‡å¸¸ç”¨äºé™åˆ¶å¯¹æœ‰é™èµ„æºçš„è®¿é—®ã€‚æ¯”å¦‚ä½ æœ‰1000ä¸ªçº¿ç¨‹ï¼Œå¦‚æœæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½å»åˆ›å»ºæ•°æ®åº“è¿æ¥ï¼Œé‚£ä¹ˆæ•°æ®åº“å¯èƒ½ä¼šå´©ã€‚æˆ–è€…çˆ¬è™«åˆ›å»ºå¯¹ç½‘ç«™çš„è¿æ¥ï¼Œå¤ªè¿‡å‡¶æ®‹å¹¶ä¸å¥½ï¼Œè¿™ä¸ªæ—¶å€™ç”¨ä¿¡å·é‡æ¥å¤„ç†å°±ä¸é”™ã€‚</p>
<p>è¿™é‡Œå¦‚æœç›´æ¥ä½¿ç”¨Lockæ¥æ„å»ºã€‚é‚£ä¹ˆä¸€ä¸ªé”åŒæ—¶åªå…è®¸ä¸€ä¸ªçº¿ç¨‹æ¥è·å¾—æ˜¾ç„¶æ˜¯ä¸è¾¾ä¸åˆ°è¦æ±‚çš„ã€‚ç¥­å‡ºåˆšæ‰æ„å»ºçš„Condition<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Semaphore</span>:</span></div><div class="line">    <span class="comment"># valueå€¼ç”¨å®Œäº†å°±è¢«è°ƒç”¨wait.åªæœ‰notifyèƒ½è§£é™¤</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value=<span class="number">1</span>)</span>:</span></div><div class="line">        self._lock = Condition()</div><div class="line">        self.value = value</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> self._lock:</div><div class="line">            <span class="keyword">if</span> self.value == <span class="number">0</span>:</div><div class="line">                self._lock.wait()</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                self.value -= <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></div><div class="line">        self.value += <span class="number">1</span></div><div class="line">        self._lock.notify()</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BoundedSemaphore</span><span class="params">(Semaphore)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value=<span class="number">1</span>)</span>:</span></div><div class="line">        super(BoundedSemaphore, self).__init__(value=value)</div></pre></td></tr></table></figure></p>
<h3 id="Event"><a href="#Event" class="headerlink" title="Event"></a>Event</h3><p>Eventå’ŒConditionå·®ä¸å¤šã€‚åŒºåˆ«å°±æ˜¯ä¸Šé¢æåˆ°çš„ï¼Œä½¿ç”¨Conditionï¼Œå¦‚æœåœ¨å•çº¿ç¨‹ï¼Œé‚£ä¹ˆå½“notifyçš„æ—¶å€™æ˜¯æ— æ³•è§¦å‘waitçš„ï¼Œå†è°ƒç”¨waitçº¿ç¨‹ä¼šè¢«é˜»å¡ã€‚<span style="color:red"><strong>ä½†æ˜¯Eventå°±æ”¯æŒåœ¨å•çº¿ç¨‹ä½¿ç”¨ã€‚</strong></span>æä¾›ä¸¤ä¸ªä¸»è¦æ–¹æ³•ï¼Œsetå’Œwaitã€‚ä½†æ˜¯å®ƒå¹¶ä¸éœ€è¦å…ˆè·å¾—é”ã€‚ä½¿ç”¨å¥½åƒæ›´æ–¹ä¾¿ä¸€ç‚¹ï¼Œå®ç°å¦‚ä¸‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Event</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self._cond = Condition()</div><div class="line">        self._flag = <span class="keyword">False</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> self._cond:</div><div class="line">            self._flag = <span class="keyword">True</span></div><div class="line">            self._cond.notify()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clear</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> self._cond:</div><div class="line">            self._flag = <span class="keyword">False</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> self._cond:</div><div class="line">            signaled = self._flag</div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> signaled:</div><div class="line">                signaled = self._cond.wait()</div><div class="line">            <span class="keyword">return</span> signaled</div></pre></td></tr></table></figure></p>
<p>å¦‚æœæŠŠåˆšæ‰é‚£ä¸ªç”Ÿäº§è€…æ¶ˆè´¹è€…æ¢åˆ°å®ƒä¸Šé¢æ¥ï¼Œå¤§æ¦‚æ˜¯è¿™ä¸ªæ ·å­äº†<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> threading</div><div class="line"><span class="keyword">import</span> random</div><div class="line"><span class="keyword">import</span> time</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Producer</span><span class="params">(threading.Thread)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, integers, condition)</span>:</span></div><div class="line">        super(Producer, self).__init__()</div><div class="line">        self.integers = integers</div><div class="line">        self.condition = condition</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</div><div class="line">            integer = random.randint(<span class="number">0</span>, <span class="number">256</span>)</div><div class="line">            self.integers.append(integer)</div><div class="line">            self.condition.set()</div><div class="line">            time.sleep(<span class="number">0.5</span>)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Consumer</span><span class="params">(threading.Thread)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, integers, condition)</span>:</span></div><div class="line">        super(Consumer, self).__init__()</div><div class="line">        self.integers = integers</div><div class="line">        self.condition = condition</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">            <span class="keyword">while</span> self.integers:</div><div class="line">                integer = self.integers.pop()</div><div class="line">                print(integer)</div><div class="line">            self.condition.wait()</div><div class="line"></div><div class="line">integers = []</div><div class="line">condition = Event()</div><div class="line">Producer(integers, condition).start()</div><div class="line">Consumer(integers, condition).start()</div></pre></td></tr></table></figure><br>å½“ç„¶ï¼Œæ²¡å•¥å¿…è¦ç”¨è¿™äº›æ¯”è¾ƒä½çº§çš„ä¸œä¸œã€‚èƒ½ç”¨é€šç”¨é«˜çº§æ•°æ®ç»“æ„å°±ç›´æ¥ç”¨ï¼Œè¿™æ ·å¤§å®¶éƒ½æ¯”è¾ƒå¥½ç†è§£ï¼Œæ€»ç»“å°±æ˜¯åªæ˜¯ç»™å…±äº«èµ„æºåŠ é”ç”¨Lockã€é™åˆ¶èµ„æºè®¿é—®ä½¿ç”¨BoundedSeamphoreï¼Œå”¤é†’ç›¸å…³çº¿ç¨‹ä½¿ç”¨Event</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¤šçº¿ç¨‹æ˜¯ä¸ªå‘çˆ¹çš„è¯¾é¢˜ï¼Œæœ‰å¤šçº¿ç¨‹å°±æœ‰é”ã€‚Pythonä¸­æœ‰ä½çº§çº¿ç¨‹æ¨¡å—_threadã€å†å°è£…ä¸€ä¸‹å°±æ˜¯threadingã€å†æ¥ä¸€ä¸‹å°±æ˜¯&lt;code&gt;from concurrent.futures import ThreadPoolExecutor&lt;/code&gt;ã€‚å…¶ä¸­æ¶‰åŠåˆ°çš„é”å¤§æ¦‚æœ‰Lockã€RLockã€Conditionã€Semaphoreã€BoundedSeamphoreã€Eventã€‚è¿™ä¹ˆå¤šçœ‹èµ·æ¥æ€ªå“äººçš„ï¼Œå…¶å®è¿™ä¹ˆå¤šçš„é”å…¨éƒ¨åªæ˜¯ç”±Lockæ¼”åŒ–å‡ºæ¥çš„&lt;/p&gt;
    
    </summary>
    
      <category term="python" scheme="https://www.zoulei.net/categories/python/"/>
    
    
  </entry>
  
  <entry>
    <title>Linux ä¿¡å·</title>
    <link href="https://www.zoulei.net/2018/03/06/linux_signal/"/>
    <id>https://www.zoulei.net/2018/03/06/linux_signal/</id>
    <published>2018-03-06T04:29:40.000Z</published>
    <updated>2018-03-06T04:35:15.156Z</updated>
    
    <content type="html"><![CDATA[<p>ä¿¡å·æ˜¯è¿›ç¨‹é—´é€šä¿¡çš„ä¸€ç§æ–¹å¼,åŒæ—¶å®ƒæ˜¯ä¸€ç§å¼‚æ­¥çš„å½¢å¼ã€‚å…ˆæ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°ï¼Œå½“æ¥æ”¶åˆ°ä¿¡å·çš„æ—¶å€™å›è°ƒè¯¥å‡½æ•°è¿›ç¨‹å¤„ç†ã€‚ä¿¡å·åœ¨ç³»ç»Ÿä¸­ä»¥æ•°å­—çš„å½¢å¼æ ‡è¯†ã€‚æ¯ä¸ªä¿¡å·å¯¹åº”ç€ä¸€ä¸ªå¤„ç†å‡½æ•°</p>
<a id="more"></a>
<h3 id="ä¿¡å·è¡¨"><a href="#ä¿¡å·è¡¨" class="headerlink" title="ä¿¡å·è¡¨"></a>ä¿¡å·è¡¨</h3><p>æ¥ä¸ªpythonæ‰“å°æ”¯æŒçš„ä¿¡å·<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> signal</div><div class="line"></div><div class="line">signals_to_names = &#123;</div><div class="line">    getattr(signal, n): n</div><div class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> dir(signal)</div><div class="line">    <span class="keyword">if</span> n.startswith(<span class="string">'SIG'</span>) <span class="keyword">and</span> <span class="string">'_'</span> <span class="keyword">not</span> <span class="keyword">in</span> n</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> s, name <span class="keyword">in</span> sorted(signals_to_names.items()):</div><div class="line">    handler = signal.getsignal(s)</div><div class="line">    <span class="keyword">if</span> handler <span class="keyword">is</span> signal.SIG_DFL:</div><div class="line">        handler = <span class="string">'SIG_DFL'</span></div><div class="line">    <span class="keyword">elif</span> handler <span class="keyword">is</span> signal.SIG_IGN:</div><div class="line">        handler = <span class="string">'SIG_IGN'</span></div><div class="line">    print(<span class="string">'&#123;:&lt;10&#125; (&#123;:2d&#125;):'</span>.format(name, s), handler)</div></pre></td></tr></table></figure></p>
<p>å› ä¸ºå¹³æ—¶ç”¨çš„å°‘ï¼Œè€Œubuntuä¸Šçš„<code>man 7 signal</code>çš„å†…å®¹æ¯”è¾ƒå¤šï¼Œæˆ‘åªæ˜¯åœ¨osxä¸Šçœ‹äº†ä¸€ä¸‹singalçš„æ–‡æ¡£ã€‚å®ƒä»…åŒ…å«ä¸‹åˆ—ä¸€äº›ä¿¡å·</p>
<table>
<thead>
<tr>
<th>åºå·</th>
<th>åç§°</th>
<th>é»˜è®¤åŠ¨ä½œ</th>
<th>è§£é‡Š</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>SIGHUP</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>è®©ç¨‹åºæŒ‚èµ·</td>
</tr>
<tr>
<td>2</td>
<td>SIGINT</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>æ‰“æ–­ç¨‹åºçš„æ‰§è¡Œ</td>
</tr>
<tr>
<td>3</td>
<td>SIGQUIT</td>
<td>dump</td>
<td>ç¨‹åº</td>
</tr>
<tr>
<td>4</td>
<td>SIGILL</td>
<td>dump</td>
<td>éæ³•æŒ‡ä»¤</td>
</tr>
<tr>
<td>5</td>
<td>SIGTRAP</td>
<td>dump</td>
<td>é™·é˜±</td>
</tr>
<tr>
<td>6</td>
<td>SIGABRT</td>
<td>dump</td>
<td>æ‰“æ–­ç¨‹åº</td>
</tr>
<tr>
<td>7</td>
<td>SIGEMT</td>
<td>dump</td>
<td></td>
</tr>
<tr>
<td>8</td>
<td>SIGFPE</td>
<td>dump</td>
<td>æµ®ç‚¹æ•°å¼‚å¸¸</td>
</tr>
<tr>
<td>9</td>
<td>SIGKILL</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>æ€æ­»ç¨‹åº(ä¸å¯ä¿®æ”¹)</td>
</tr>
<tr>
<td>10</td>
<td>SIGBUS</td>
<td>dump</td>
<td>æ€»çº¿é”™è¯¯</td>
</tr>
<tr>
<td>11</td>
<td>SIGSEGV</td>
<td>dump</td>
<td>æ®µé”™è¯¯</td>
</tr>
<tr>
<td>12</td>
<td>SIGSYS</td>
<td>dump</td>
<td>è°ƒç”¨ä¸å­˜åœ¨çš„ç³»ç»Ÿè°ƒç”¨</td>
</tr>
<tr>
<td>13</td>
<td>SIGPIPE</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>ç»™ä¸€ä¸ªæ²¡æœ‰è¯»çš„ç®¡é“å†™æ•°æ®</td>
</tr>
<tr>
<td>14</td>
<td>SIGALRM</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>å®æ—¶è®¡æ—¶å™¨è¶…æ—¶</td>
</tr>
<tr>
<td>15</td>
<td>SIGTERM</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>è½¯ä¸­æ–­ä¿¡å·</td>
</tr>
<tr>
<td>16</td>
<td>SIGURG</td>
<td>å·²åºŸå¼ƒ</td>
<td></td>
</tr>
<tr>
<td>17</td>
<td>SIGSTOP</td>
<td>åœæ­¢è¿›ç¨‹</td>
<td>åœæ­¢(ä¸å¯ä¿®æ”¹)</td>
</tr>
<tr>
<td>18</td>
<td>SIGTSTP</td>
<td>åœæ­¢è¿›ç¨‹</td>
<td>ä»é”®ç›˜ç”Ÿæˆåœæ­¢ä¿¡å·</td>
</tr>
<tr>
<td>19</td>
<td>SIGCONT</td>
<td>åºŸå¼ƒ</td>
<td></td>
</tr>
<tr>
<td>20</td>
<td>SIGCHLD</td>
<td>åºŸå¼ƒ</td>
<td></td>
</tr>
<tr>
<td>21</td>
<td>SIGTTIN</td>
<td>åœæ­¢è¿›ç¨‹</td>
<td>åå°è¿›ç¨‹å°è¯•è¯»å–ç»ˆç«¯æ—¶è§¦å‘</td>
</tr>
<tr>
<td>22</td>
<td>SIGTOU</td>
<td>åœæ­¢è¿›ç¨‹</td>
<td>åå°è¿›ç¨‹å°è¯•å†™å…¥ç»ˆç«¯æ—¶è§¦å‘</td>
</tr>
<tr>
<td>23</td>
<td>SIGIO</td>
<td>åºŸå¼ƒ</td>
<td></td>
</tr>
<tr>
<td>24</td>
<td>SIGXCPU</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>è¿›ç¨‹çš„cpuæ—¶é—´ç‰‡åˆ°æœŸ(setrlimit)</td>
</tr>
<tr>
<td>25</td>
<td>SIGXFSZ</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶(setrlimit)</td>
</tr>
<tr>
<td>26</td>
<td>SIGVTLRM</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>è™šæ‹Ÿæ—¶é’Ÿè¶…æ—¶(setitimer)</td>
</tr>
<tr>
<td>27</td>
<td>SIGPROF</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>profilæ—¶é’Ÿè¶…æ—¶(setitimer)</td>
</tr>
<tr>
<td>28</td>
<td>SIGWINCH</td>
<td>åºŸå¼ƒ</td>
<td></td>
</tr>
<tr>
<td>29</td>
<td>SIGINFO</td>
<td>åºŸå¼ƒ</td>
<td></td>
</tr>
<tr>
<td>30</td>
<td>SIGUSR1</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>ç”¨æˆ·è‡ªå®šä¹‰ä¿¡å·1</td>
</tr>
<tr>
<td>31</td>
<td>SIGUSR2</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>ç”¨æˆ·è‡ªå®šä¹‰ä¿¡å·2</td>
</tr>
</tbody>
</table>
<h3 id="ä¿¡å·çš„äº§ç”Ÿ"><a href="#ä¿¡å·çš„äº§ç”Ÿ" class="headerlink" title="ä¿¡å·çš„äº§ç”Ÿ"></a>ä¿¡å·çš„äº§ç”Ÿ</h3><p>ä¿¡å·å¯ä»¥äº§ç”Ÿè‡ªè½¯ä»¶å’Œç¡¬ä»¶ï¼Œç¡¬ä»¶æ¥è¯´ï¼Œæˆ‘ä»¬æœ€å¸¸ç”¨çš„<code>Ctrl+C</code>æ¥ç»ˆæ­¢ä¸€ä¸ªç¨‹åºçš„æ‰§è¡Œï¼Œè½¯ä»¶å±‚é¢å°±æ˜¯ç»å¸¸ä½¿ç”¨<code>kill -9 pid</code>æ¥å¼ºåˆ¶ç»ˆæ­¢ä¸€ä¸ªç¨‹åºã€‚è§‚å¯Ÿä¸Šè¡¨å¯ä»¥å‘ç°è¿˜æœ‰å¾ˆå¤šç±»ä¼¼éæ³•æŒ‡ä»¤ã€é™·å…¥ã€æ®µé”™è¯¯ç­‰ç­‰éƒ½æ˜¯ç”±æ“ä½œç³»ç»Ÿè§¦å‘åé¦ˆç»™åº”ç”¨ç¨‹åºã€‚è¿˜æœ‰å°±æ˜¯æˆ‘ä»¬è‡ªå·±ç¼–å†™ç¨‹åºè¿›è¡Œç³»ç»Ÿè°ƒç”¨è§¦å‘ã€‚æ¯”å¦‚pythonä¸­å¸¸ç”¨çš„<code>signal.alarm</code></p>
<h3 id="ä¿¡å·çš„å¤„ç†"><a href="#ä¿¡å·çš„å¤„ç†" class="headerlink" title="ä¿¡å·çš„å¤„ç†"></a>ä¿¡å·çš„å¤„ç†</h3><p>è§‚å¯Ÿä¿¡å·è¡¨å¯ä»¥å‘ç°è™½ç„¶æœ‰31ä¸ªä¿¡å·ã€‚ä½†æ˜¯é»˜è®¤åŠ¨ä½œåªæœ‰ç»ˆæ­¢è¿›ç¨‹ã€dumpã€åœæ­¢è¿›ç¨‹ä¸‰ç§ã€‚è¿™ç®—æˆäº†å¤šå¯¹ä¸€çš„å…³ç³»ï¼Œå¤šä¸ªä¿¡å·å¯¹åº”ä¸€ä¸ªå¤„ç†ç»“æœã€‚æƒ³æƒ³è¿™å…¶å®æ˜¯ä¸€ç§äººä¸ºçš„çº¦å®šã€‚æ“ä½œç³»ç»Ÿé‡åˆ°ä¸€äº›å¼‚å¸¸çš„æ—¶å€™æœ¬å¯ä»¥ç›´æ¥å¡æ“¦æ‰è¿›ç¨‹ã€‚ä½†æ˜¯è¿˜æ˜¯å…ˆçŸ¥ä¼šä½ ä¸€å£°ï¼Œä¸‡ä¸€ç¨‹åºä½œè€…è§‰å¾—é‡åˆ°è¿™ç§æƒ…å†µè¿˜èƒ½å†æŠ¢æ•‘ä¸€ä¸‹é‚£å°±ä¸å¼‚å¸¸äº†ã€‚æ‰€ä»¥è§„å®šè¿™ä¹ˆå¤šä¿¡å·idã€‚è¿˜æ˜¯ä¸ºäº†æ–¹ä¾¿ç¼–ç¨‹çš„æ—¶å€™å¯¹ä¿¡å·è¿›è¡Œåˆ†ç±»å¤„ç†ã€‚è€Œä¸”ä¸ä»…ä»…çº¦å®šä¿—æˆã€‚åé¢è¿˜æœ‰ä¸¤ä¸ªè‡ªå®šä¹‰ä¿¡å·è®©ä½ è‡ªå·±è¿›è¡Œå®šä¹‰</p>
<p>ä¿¡å·å¤„ç†åŸºæœ¬æœ‰ä¸‰ç§å¥—è·¯ï¼Œé»˜è®¤ã€å¿½ç•¥ã€è‡ªå®šä¹‰ã€‚å¦‚æœä½ è§‰å¾—é‡åˆ°å¼‚å¸¸ä½ è¿˜å¯ä»¥å†æŠ¢æ•‘ä¸€ä¸‹é‚£å°±è‡ªå®šä¹‰æˆ–è€…å¿½ç•¥ã€‚ä½†æ˜¯å‡å¦‚å¿½ç•¥æ‰æ‰€æœ‰çš„ä¿¡å·ã€‚ç®¡ç†äººå‘˜å¯èƒ½å°±æ— æ³•é€€å‡ºä½ çš„ç¨‹åºäº†ã€‚<span style="color:red"><strong>å› æ­¤SIGKILLå’ŒSIGSTOPå¼ºåˆ¶ä¸å…è®¸è¢«å¿½ç•¥æˆ–è€…è‡ªå®šä¹‰</strong></span>ã€‚æ‰€ä»¥<code>kill -9</code>å°±æ˜¯ä¸€ä¸ªå¤§æ€å™¨</p>
<p>ä½†æ˜¯å¾ˆå¤šäººå¹¶ä¸è¢«æ¨èç”¨<code>kill -9</code>ï¼Œè€Œæ›´å¤šçš„äººæ¨èç”¨<code>kill -15</code>ã€‚åŸå› æ˜¯å¼ºåˆ¶è™½ç„¶å¼ºã€‚ä½†æ˜¯è¿™æ ·ç¼–ç¨‹äººå‘˜åˆ«æ— é€‰æ‹©ã€‚æœ‰çš„ç¨‹åºåœ¨æ„å¤–é€€å‡ºå‰éœ€è¦åšä¸€äº›æ¸…ç†å·¥ä½œï¼Œæ¯”å¦‚åˆ æ‰ä¸´æ—¶æ–‡ä»¶å•¥çš„ã€‚å½“ç„¶ï¼Œæ¸£æ°´å¹³çš„ä½œè€…æ€ä¹ˆå¯èƒ½ä¼šå»è‡ªå®šä¹‰å¤„ç†SIGTERMä¿¡å·â”‘(ï¿£Ğ” ï¿£)â”</p>
<h3 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h3><p>æ¯”å¦‚tornadoä¸­å¯ä»¥ä½¿ç”¨ä¿¡å·æœºåˆ¶è®°å½•å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼çš„æ ˆå¸§<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> tornado.httpserver</div><div class="line"><span class="keyword">import</span> tornado.ioloop</div><div class="line"><span class="keyword">import</span> tornado.web</div><div class="line"><span class="keyword">import</span> traceback</div><div class="line"><span class="keyword">import</span> time</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">record_block</span><span class="params">(_, frame)</span>:</span></div><div class="line">    a = traceback.format_stack(frame)</div><div class="line">    print(<span class="string">""</span>.join(a))</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></div><div class="line">        time.sleep(<span class="number">10</span>)</div><div class="line">        self.write(<span class="string">"Hello, world"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    application = tornado.web.Application([</div><div class="line">        (<span class="string">r"/"</span>, MainHandler),</div><div class="line">    ])</div><div class="line">    http_server = tornado.httpserver.HTTPServer(application)</div><div class="line">    http_server.listen(<span class="number">8888</span>)</div><div class="line">    ioloop = tornado.ioloop.IOLoop.current()</div><div class="line">    ioloop.set_blocking_signal_threshold(<span class="number">1</span>, record_block)</div><div class="line">    ioloop.start()</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    main()</div><div class="line"></div></pre></td></tr></table></figure></p>
<p>å…³äºå®ƒçš„å®ç°å°±æ¯”è¾ƒç®€å•äº†ã€‚å…ˆä½¿ç”¨<code>signal.signal(signal.SIGALRM,callback)</code>æ³¨å†Œä¿¡å·å›è°ƒå‡½æ•°ã€‚åœ¨ioloopä¸»å¾ªç¯ä¸­æ¯æ¬¡äº‹ä»¶å®Œæˆåå°†å®æ—¶è®¡æ—¶å™¨å½’é›¶<code>signal.setitimer(signal.ITIMER_REAL, 0, 0)</code>åå†é‡æ–°å¼€å§‹è®¡æ—¶ã€‚æ­¤å¤„ä¸ºä»€ä¹ˆä¸æ˜¯ç”¨alarmè€Œä½¿ç”¨setitimerã€‚å› ä¸ºå‰è€…åªæ”¯æŒæ•´æ•°ç§’ï¼Œåè€…æ”¯æŒæµ®ç‚¹æ•°</p>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p><a href="https://pymotw.com/3/signal/index.html">signal â€” Asynchronous System Events</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¿¡å·æ˜¯è¿›ç¨‹é—´é€šä¿¡çš„ä¸€ç§æ–¹å¼,åŒæ—¶å®ƒæ˜¯ä¸€ç§å¼‚æ­¥çš„å½¢å¼ã€‚å…ˆæ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°ï¼Œå½“æ¥æ”¶åˆ°ä¿¡å·çš„æ—¶å€™å›è°ƒè¯¥å‡½æ•°è¿›ç¨‹å¤„ç†ã€‚ä¿¡å·åœ¨ç³»ç»Ÿä¸­ä»¥æ•°å­—çš„å½¢å¼æ ‡è¯†ã€‚æ¯ä¸ªä¿¡å·å¯¹åº”ç€ä¸€ä¸ªå¤„ç†å‡½æ•°&lt;/p&gt;
    
    </summary>
    
      <category term="linux" scheme="https://www.zoulei.net/categories/linux/"/>
    
    
  </entry>
  
  <entry>
    <title>åˆ©ç”¨BKæ ‘ä¼˜åŒ–æ±‰æ˜è·ç¦»æŸ¥è¯¢</title>
    <link href="https://www.zoulei.net/2018/03/04/Postgresql_use_bktree_hamming/"/>
    <id>https://www.zoulei.net/2018/03/04/Postgresql_use_bktree_hamming/</id>
    <published>2018-03-04T02:45:47.000Z</published>
    <updated>2018-03-04T03:22:06.071Z</updated>
    
    <content type="html"><![CDATA[<p><a href="/2018/03/03/BKTree_VPTree/">ä¸Šä¸€ç¯‡</a> ä»‹ç»äº†BKæ ‘å’ŒVPæ ‘ï¼Œå¹¶è¯´æ˜ç”¨å®ƒå¯ä»¥ä¼˜åŒ–æ±‰æ˜è·ç¦»çš„æŸ¥è¯¢ã€‚ç”¨æ¥å¤„ç†é‡å¤å›¾ç‰‡çš„é—®é¢˜ã€‚æœ¬ç¯‡æˆ‘ä»¬åšå‡ºç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯100ä¸‡æ¡æ•°æ®ã€‚ç›¸å¯¹äºå…¨è¡¨éå†çš„31ç§’ä¸‹é™åˆ°54æ¯«ç§’ã€‚ä½¿ç”¨äº†æ­£ç¡®çš„ç´¢å¼•é€Ÿåº¦æå‡äº†äº”ç™¾å¤šå€</p>
<a id="more"></a>
<h3 id="è·å¾—å›¾ç‰‡çš„simhash"><a href="#è·å¾—å›¾ç‰‡çš„simhash" class="headerlink" title="è·å¾—å›¾ç‰‡çš„simhash"></a>è·å¾—å›¾ç‰‡çš„simhash</h3><p>æˆ‘ä»¬ç›´æ¥ä½¿ç”¨pythonçš„ç¬¬ä¸‰æ–¹åº“<a href="https://github.com/JohannesBuchner/imagehash">imagehash</a>ã€‚ä»£ç å¦‚ä¸‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</div><div class="line"><span class="keyword">import</span> imagehash</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_phash</span><span class="params">(file_path)</span>:</span></div><div class="line">    img = Image.open(file_path)</div><div class="line">    phash = imagehash.phash(img).hash.flatten()</div><div class="line">    phash_list = list(map(bool, phash))</div><div class="line"></div><div class="line">    <span class="keyword">return</span> sum((<span class="number">2</span> ** k) * v <span class="keyword">for</span> k, v <span class="keyword">in</span> enumerate(phash_list[<span class="number">1</span>:][::<span class="number">-1</span>]))</div></pre></td></tr></table></figure></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ã€‚é»˜è®¤å¾—åˆ°çš„phashæ˜¯ä¸€ä¸ªç»è¿‡hexç¼–ç çš„å­—ç¬¦ä¸²ã€‚è¿™æ ·ä¼šå¾ˆé•¿ï¼Œè€Œ<span style="color:red"><strong>æˆ‘ä»¬éœ€è¦ä¿å­˜åˆ°æ•°æ®åº“çš„æ•°æ®æ˜¯ä¸€ä¸ªbigintç±»å‹ã€‚å› æ­¤æˆ‘ä»¬ç›´æ¥è·å¾—64ä½çš„np.arrayï¼Œ</strong></span>å°†å®ƒè½¬æ¢æˆæ•°å­—ã€‚å› ä¸ºint64ä¸­ç¬¬ä¸€ä½æ˜¯ç¬¦å·ä½ã€‚å63ä½æ˜¯è¡¥ç ã€‚å¦‚æœç›´æ¥å°†64ä½éƒ½è½¬æˆæ­£æ•´æ•°ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šä¿å­˜å‡ºé”™ã€‚ä»æœ€æ–¹ä¾¿çš„è§’åº¦æ¥è¯´æˆ‘ä»¬å¯ä»¥å»æ‰ç¬¬ä¸€ä½(å®é™…ä¸Šæˆ‘æµ‹è¯•äº†å¥½å¤šä¸ªã€‚å‘ç°ç¬¬ä¸€ä½åŸºæœ¬éƒ½æ˜¯1)ã€‚è¿™æ ·è½¬æ¢å¾—åˆ°çš„æ•°å­—å°±èƒ½ç›´æ¥å­˜å‚¨åˆ°æ•°æ®åº“äº†ã€‚</p>
<p>å¦‚æœçœŸçš„è¦æ¨¡æ‹Ÿè½¬æ¢æˆbigintçš„æ•ˆæœã€‚å¯ä»¥çœ‹æˆ‘å†™çš„<a href="https://gist.github.com/ficapy/e7012d193c5ea85110a404c006ed7273">è¿™ä¸ª</a></p>
<h3 id="æ•°æ®åº“ä¼˜åŒ–"><a href="#æ•°æ®åº“ä¼˜åŒ–" class="headerlink" title="æ•°æ®åº“ä¼˜åŒ–"></a>æ•°æ®åº“ä¼˜åŒ–</h3><ul>
<li>æ¥ä¸ªç¤ºä¾‹</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">--  åˆ›å»ºè¡¨</span></div><div class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> int8tmp_2</div><div class="line">(</div><div class="line">	a <span class="built_in">bigint</span></div><div class="line">);</div><div class="line"></div><div class="line"><span class="comment">-- å†™å…¥ä¸€ç™¾ä¸‡æ¡æ•°æ®</span></div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> int8tmp_2 <span class="keyword">SELECT</span> val</div><div class="line">                      <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="keyword">sqrt</span>(random()) :: <span class="built_in">NUMERIC</span> * <span class="number">9223372036854775807</span> * <span class="number">2</span> -</div><div class="line">                                   <span class="number">9223372036854775807</span> :: <span class="built_in">NUMERIC</span> <span class="keyword">AS</span> val</div><div class="line">                            <span class="keyword">FROM</span> generate_series(<span class="number">1</span>, <span class="number">1000000</span>)) t;</div><div class="line"><span class="comment">-- åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢å‡½æ•°</span></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> <span class="keyword">bit_count</span>(<span class="keyword">value</span> <span class="built_in">BIGINT</span>)</div><div class="line">  <span class="keyword">RETURNS</span> <span class="built_in">NUMERIC</span></div><div class="line"><span class="keyword">AS</span> $$ <span class="keyword">SELECT</span> <span class="keyword">SUM</span>((<span class="keyword">value</span> &gt;&gt; <span class="built_in">bit</span>) &amp; <span class="number">1</span>)</div><div class="line">      <span class="keyword">FROM</span> generate_series(<span class="number">0</span>, <span class="number">63</span>) <span class="built_in">bit</span> $$</div><div class="line"><span class="keyword">LANGUAGE</span> <span class="keyword">SQL</span> IMMUTABLE <span class="keyword">STRICT</span>;</div><div class="line"></div><div class="line"><span class="comment">-- æŸ¥è¯¢</span></div><div class="line"><span class="keyword">SELECT</span></div><div class="line">  a,</div><div class="line">  <span class="keyword">bit_count</span>(a # <span class="number">8192711222023195111</span>) <span class="keyword">AS</span> hd</div><div class="line"><span class="keyword">FROM</span> int8tmp_2</div><div class="line"><span class="keyword">WHERE</span> <span class="keyword">bit_count</span>(a # <span class="number">8192711222023195111</span>) &lt; <span class="number">4</span></div><div class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> hd;    </div><div class="line"></div><div class="line"><span class="comment">-- ç»“æœå¤§æ¦‚è¿™æ ·</span></div><div class="line"><span class="comment">-- [2018-03-04 11:06:56] 1 row retrieved starting from 1 in 25s 403ms (execution: 25s 383ms, fetching: 20ms)</span></div></pre></td></tr></table></figure>
<ul>
<li>ä½¿ç”¨BKæ ‘åˆ›å»ºç´¢å¼•</li>
</ul>
<p>æˆ‘é€‰æ‹©äº†è¿™ä¸ªæ‰©å±•<a href="https://github.com/fake-name/pg-spgist_hamming">fake-name/pg-spgist_hamming</a>. å®‰è£…çš„å¥—è·¯æ˜¯è¿™æ ·çš„(åªæ”¯æŒPG9.6ä»¥ä¸Šç‰ˆæœ¬)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">git clone .......</div><div class="line">cd bktree</div><div class="line">USE_PGXS=1 make</div><div class="line">USE_PGXS=1 make install</div></pre></td></tr></table></figure>
<p><span style="color:red"><strong>æ³¨æ„è¿™ä¸ªåº“åŒæ—¶æä¾›äº†bktreeå’Œvptree,ä½†æ˜¯æˆ‘æ²¡ææ‡‚vptree,vptreeçš„è¡¨ç°å¾ˆå¥‡æ€ª,å¦å¤–ä¸èƒ½åŒæ—¶ä½¿ç”¨bktreeå’Œvptreeã€‚å› ä¸ºå®ƒä»¬æœ‰ä¸€äº›é‡è½½çš„æ“ä½œç¬¦é‡å¤äº†</strong></span></p>
<ul>
<li>ä½¿ç”¨æµç¨‹</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- å¯ç”¨æ‰©å±•</span></div><div class="line"><span class="keyword">CREATE</span> EXTENSION bktree;</div><div class="line"><span class="comment">-- åˆ›å»º</span></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> int8idx_2 <span class="keyword">ON</span> int8tmp_2 <span class="keyword">USING</span> spgist ( a bktree_ops );</div><div class="line"><span class="comment">-- æŸ¥è¯¢( &lt;-&gt; è¿ç®—ç¬¦è¡¨ç¤ºè®¡ç®—æ±‰æ˜è·ç¦», &lt;@()è¡¨ç¤ºç¬¦åˆæ±‰æ˜è·ç¦»å°äºN)</span></div><div class="line"><span class="keyword">SELECT</span></div><div class="line">  a,</div><div class="line">  a &lt;-&gt; <span class="number">8192711222023195111</span> <span class="keyword">AS</span> hd</div><div class="line"><span class="keyword">FROM</span> int8tmp_2</div><div class="line"><span class="keyword">WHERE</span> a &lt;@ (<span class="number">8192711222023195111</span>, <span class="number">4</span>)</div><div class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> hd;</div><div class="line"><span class="comment">-- ç»“æœå¤§æ¦‚æ˜¯è¿™æ ·çš„</span></div><div class="line">[2018-03-04 11:18:25] 1 row retrieved starting from 1 in 44ms (execution: 31ms, fetching: 13ms)</div></pre></td></tr></table></figure>
<p>ä¸–ç•ŒçœŸç¾å¦™â”‘(ï¿£Ğ” ï¿£)â”</p>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p><a href="https://github.com/digoal/blog/blob/master/201708/20170804_01.md">æµ·é‡æ•°æ®,æµ·æ˜(simhash)è·ç¦»é«˜æ•ˆæ£€ç´¢(smlar) - é˜¿é‡Œäº‘RDS PosgreSQLæœ€ä½³å®è·µ</a><br><a href="https://stackoverflow.com/questions/46280722/bit-count-function-in-postgresql">bit_count function in PostgreSQL</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;/2018/03/03/BKTree_VPTree/&quot;&gt;ä¸Šä¸€ç¯‡&lt;/a&gt; ä»‹ç»äº†BKæ ‘å’ŒVPæ ‘ï¼Œå¹¶è¯´æ˜ç”¨å®ƒå¯ä»¥ä¼˜åŒ–æ±‰æ˜è·ç¦»çš„æŸ¥è¯¢ã€‚ç”¨æ¥å¤„ç†é‡å¤å›¾ç‰‡çš„é—®é¢˜ã€‚æœ¬ç¯‡æˆ‘ä»¬åšå‡ºç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯100ä¸‡æ¡æ•°æ®ã€‚ç›¸å¯¹äºå…¨è¡¨éå†çš„31ç§’ä¸‹é™åˆ°54æ¯«ç§’ã€‚ä½¿ç”¨äº†æ­£ç¡®çš„ç´¢å¼•é€Ÿåº¦æå‡äº†äº”ç™¾å¤šå€&lt;/p&gt;
    
    </summary>
    
      <category term="database" scheme="https://www.zoulei.net/categories/database/"/>
    
    
  </entry>
  
  <entry>
    <title>BKæ ‘å’ŒVPæ ‘</title>
    <link href="https://www.zoulei.net/2018/03/03/BKTree_VPTree/"/>
    <id>https://www.zoulei.net/2018/03/03/BKTree_VPTree/</id>
    <published>2018-03-03T09:17:02.000Z</published>
    <updated>2018-03-04T02:18:38.874Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘æœ‰ä¸€ä¸ªé¡¹ç›®éœ€è¦ç”¨åˆ°simhash.è·å–å›¾ç‰‡çš„hashå€¼å¹¶ä¿å­˜åˆ°æ•°æ®åº“ã€‚åœ¨ç”Ÿæˆæ–°çš„hashçš„æ—¶å€™å’Œæ•°æ®åº“è¿›è¡Œæ¯”å¯¹ã€‚è¾¾åˆ°å»é‡çš„æ•ˆæœã€‚å‡å¦‚å›¾ç‰‡è¾¾åˆ°äº†ä¸€å®šæ•°é‡çº§ï¼Œé‚£ä¹ˆæ¯æ¬¡æŸ¥è¯¢ä¼šè¿›è¡Œå…¨è¡¨æ‰«æï¼Œæ•ˆç‡æ˜¯æ¯”è¾ƒä½ä¸‹çš„ï¼Œè€Œæ•°æ®åº“é»˜è®¤çš„ä¸€äº›ç´¢å¼•åˆæ— æ³•è¾¾åˆ°è¿™ä¸ªéœ€æ±‚ï¼Œåæ¥çœ‹åˆ°äº†BKæ ‘ã€‚è®°å½•ä¸€ä¸‹</p>
<a id="more"></a>
<p>ä½¿ç”¨Pythonçš„åº“<a href="https://github.com/JohannesBuchner/imagehash">imageHash</a> è¿ç®—åä¼šå¾—åˆ°64bité•¿åº¦çš„ç»“æœ(æœ€åä½¿ç”¨äº†hexç¼–ç å¯¼è‡´ç»“æœçœ‹èµ·æ¥å¾ˆé•¿)ã€‚å¦‚æœä¸¤å¼ å›¾ç‰‡çš„bitè¿›è¡Œå¼‚æˆ–åä¸åŒçš„åœ°æ–¹è¶Šå°ã€‚è¯´æ˜ä¸¤å¼ å›¾ç‰‡è¶Šç›¸ä¼¼ã€‚åº¦é‡è¿™2ä¸ªbitä¸ç›¸ä¼¼ç¨‹åº¦è¢«ç§°ä¹‹ä¸ºæ±‰æ˜è·ç¦»</p>
<p>è¿™ä¸ªè·ç¦»å®ƒåˆæ»¡è¶³ä»¥ä¸‹æ€§è´¨(è¢«ç§°ä¸ºLevenshtein)</p>
<ol>
<li>d(x, y) = 0 å½“ä¸”ä»…å½“ x=y  ï¼ˆLevenshteinè·ç¦»ä¸º0 &lt;==&gt; å­—ç¬¦ä¸²ç›¸ç­‰ï¼‰</li>
<li>d(x, y) = d(y, x)     ï¼ˆä»xå˜åˆ°yçš„æœ€å°‘æ­¥æ•°å°±æ˜¯ä»yå˜åˆ°xçš„æœ€å°‘æ­¥æ•°ï¼‰</li>
<li>d(x, y) + d(y, z) &gt;= d(x, z)  ï¼ˆä»xå˜åˆ°zæ‰€éœ€çš„æ­¥æ•°ä¸ä¼šè¶…è¿‡xå…ˆå˜æˆyå†å˜æˆzçš„æ­¥æ•°ï¼‰</li>
</ol>
<h3 id="BKæ ‘"><a href="#BKæ ‘" class="headerlink" title="BKæ ‘"></a>BKæ ‘</h3><p>ä¸ºäº†åŠ é€ŸæŸ¥æ‰¾, æ„å»ºäº†è¿™æ ·ä¸€ç§æ ‘ç»“æ„ã€‚</p>
<ol>
<li>ä»»é€‰ä¸€ä¸ªèŠ‚ç‚¹å½“åšæ ¹èŠ‚ç‚¹</li>
<li>æ’å…¥èŠ‚ç‚¹çš„æ—¶å€™å’Œæ ¹èŠ‚ç‚¹å¯¹æ¯”å¾—åˆ°è·ç¦»ã€‚å¦‚æœè¯¥è·ç¦»ä¸å­˜åœ¨åˆ™æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹ä½œä¸ºæ ¹èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ã€‚å¦‚æœèŠ‚ç‚¹å­˜åœ¨åˆ™è·å¾—èŠ‚ç‚¹ä½œä¸ºæ ¹èŠ‚ç‚¹è¿›è¡Œé€’å½’æ“ä½œ</li>
</ol>
<p>ç¬¬äºŒæ­¥çš„æ„ä¹‰åœ¨äº<strong>ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹ä¸‹é¢çš„å…ƒç´ å¯¹äºè¯¥èŠ‚ç‚¹çš„è·ç¦»éƒ½æ˜¯ç›¸ç­‰çš„</strong>ã€‚æ„å»ºå°±è¾¾åˆ°äº†è¿™ä¸ªæ•ˆæœã€‚åˆ«çš„å•¥äº‹æ²¡åšã€‚</p>
<p>æŸ¥æ‰¾è¿‡ç¨‹ã€‚æŸ¥æ‰¾çš„åŸç†ä¸»è¦ä¾é ç¬¬ä¸‰æ¡æ€§è´¨<code>d(x, y) + d(y, z) &gt;= d(x, z)</code>.<br>å‡è®¾æˆ‘ä»¬æœ‰è¿™æ ·ä¸€ä¸ªæŸ¥è¯¢è¦æ±‚ã€‚éœ€è¦æŸ¥æ‰¾å­—ç¬¦ä¸²targetè·ç¦»ä¸å¤§äºnçš„æ‰€æœ‰ç»“æœã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">è®¾rootä¸ºx, targetä¸ºy</div><div class="line">d(root, target) + d(target, element) &gt;= d(root, element)</div><div class="line">d(target, element)çš„å–å€¼èŒƒå›´æ˜¯[0, n]</div><div class="line">å¾—åˆ°d(root, element) çš„æœ€å¤§å€¼æ˜¯ n + d(root, target)</div></pre></td></tr></table></figure></p>
<p><strong>å› æ­¤æˆ‘ä»¬æ ¹æ®è¿™ä¸ªä¸ç­‰å¼å®ç°äº†å‰ªæçš„æ•ˆæœ</strong>ã€‚å¯¹äºæ»¡è¶³æ¡ä»¶çš„å…ƒç´ ã€‚å°†å…¶è®¾ç½®ä¸ºæ ¹å…ƒç´ ã€‚é€’å½’å¾—åˆ°æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„å…ƒç´ </p>
<h3 id="VPæ ‘"><a href="#VPæ ‘" class="headerlink" title="VPæ ‘"></a>VPæ ‘</h3><p>VPæ ‘å’ŒBKæ ‘åŸç†å·®ä¸å¤šã€‚ä¼˜ç‚¹æ˜¯å½“éœ€è¦æŸ¥è¯¢çš„è·ç¦»Næ›´å¤§çš„æ—¶å€™æ•ˆç‡æ›´é«˜(å…·ä½“åŸç†æˆ‘è¿˜ä¸å¤ªäº†è§£ã€‚å†™çš„æ—¶å€™å‘ç°å¾ˆå¤šæ—¶å€™å®ƒçš„æ•ˆç‡ç”šè‡³æ˜¯ä¸åŠBKæ ‘çš„)ã€‚</p>
<p>BKæ ‘å¯ä»¥çœ‹å‡ºæ˜¯ä¸€ä¸ªå¤šå‰æ ‘ã€‚æ¯ä¸ªèŠ‚ç‚¹ä¸‹é¢å¯ä»¥æœ‰å¤šä¸ªèŠ‚ç‚¹ã€‚VPæ ‘ä¸åŒï¼Œå®ƒæ˜¯ä¸€ä¸ªäºŒå‰æ ‘ã€‚æ ¹æ®æˆ‘çš„éœ€æ±‚ã€‚ç®€å•èµ·è§ã€‚æ¯ä¸€ä¸ªèŠ‚ç‚¹æˆ‘è®¾ç½®äº†ç›¸åŒçš„é˜ˆå€¼ã€‚è·ç¦»å°äºé˜ˆå€¼åˆ™æ”¾åœ¨å·¦è¾¹ï¼Œå¤§äºåˆ™æ”¾åœ¨å³è¾¹ã€‚</p>
<p>æŸ¥æ‰¾çš„æ—¶å€™è¿˜æŒºå°´å°¬çš„ã€‚æ ¹æ®ä¸Šé¢è¯´çš„<code>d(root, element) &lt;= n + d(root, target)</code>ã€‚å½“èŠ‚ç‚¹çš„é˜ˆå€¼å°äºè¿™ä¸ªå€¼çš„æ—¶å€™å·¦å³å­èŠ‚ç‚¹éƒ½éœ€è¦éå†ã€‚å½“èŠ‚ç‚¹é˜ˆå€¼å¤§äºçš„æ—¶å€™å°±åªéœ€è¦éå†å·¦è¾¹(è¾¾åˆ°å‰ªæçš„æ•ˆæœ)</p>
<p>æ³¨æ„:  ä»¥ä¸Šæˆ‘éƒ½åªè€ƒè™‘äº†æ·»åŠ ï¼Œæ²¡æœ‰è€ƒè™‘ä¿®æ”¹å’Œåˆ é™¤çš„äº‹æƒ…ã€‚</p>
<p>Pythonç‰ˆæœ¬ä»£ç å®ç°å¦‚ä¸‹</p>
<script src="//gist.github.com/ficapy/ed909648b184bc2fc1486ce90175d356.js?file=bk_tree.py"></script>
<script src="//gist.github.com/ficapy/ed909648b184bc2fc1486ce90175d356.js?file=vp_tree.py"></script>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p><a href="http://www.matrix67.com/blog/archives/333">ç¼–è¾‘è·ç¦»ã€æ‹¼å†™æ£€æŸ¥ä¸åº¦é‡ç©ºé—´ï¼šä¸€ä¸ªæœ‰è¶£çš„æ•°æ®ç»“æ„</a><br><a href="https://fribbels.github.io/vptree/writeup">VP Tree</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘æœ‰ä¸€ä¸ªé¡¹ç›®éœ€è¦ç”¨åˆ°simhash.è·å–å›¾ç‰‡çš„hashå€¼å¹¶ä¿å­˜åˆ°æ•°æ®åº“ã€‚åœ¨ç”Ÿæˆæ–°çš„hashçš„æ—¶å€™å’Œæ•°æ®åº“è¿›è¡Œæ¯”å¯¹ã€‚è¾¾åˆ°å»é‡çš„æ•ˆæœã€‚å‡å¦‚å›¾ç‰‡è¾¾åˆ°äº†ä¸€å®šæ•°é‡çº§ï¼Œé‚£ä¹ˆæ¯æ¬¡æŸ¥è¯¢ä¼šè¿›è¡Œå…¨è¡¨æ‰«æï¼Œæ•ˆç‡æ˜¯æ¯”è¾ƒä½ä¸‹çš„ï¼Œè€Œæ•°æ®åº“é»˜è®¤çš„ä¸€äº›ç´¢å¼•åˆæ— æ³•è¾¾åˆ°è¿™ä¸ªéœ€æ±‚ï¼Œåæ¥çœ‹åˆ°äº†BKæ ‘ã€‚è®°å½•ä¸€ä¸‹&lt;/p&gt;
    
    </summary>
    
      <category term="database" scheme="https://www.zoulei.net/categories/database/"/>
    
    
  </entry>
  
  <entry>
    <title>å¼€å§‹GitLab CI/CD</title>
    <link href="https://www.zoulei.net/2017/12/25/GitLabCICD_quickstart/"/>
    <id>https://www.zoulei.net/2017/12/25/GitLabCICD_quickstart/</id>
    <published>2017-12-25T12:38:35.000Z</published>
    <updated>2017-12-26T01:34:46.618Z</updated>
    
    <content type="html"><![CDATA[<h3 id="GitLabCI-CDæµç¨‹"><a href="#GitLabCI-CDæµç¨‹" class="headerlink" title="GitLabCI/CDæµç¨‹"></a>GitLabCI/CDæµç¨‹</h3><p>gitlabå¦‚æœæ²¡æœ‰å’ŒDockerå¾ˆå¥½çš„ç»“åˆã€‚é‚£ä¹ˆå®ƒä¼šæ˜¯ä¸€ä¸ªå¾ˆå¹³å‡¡çš„äº§å“ã€‚ä½†æ˜¯æœ‰äº†CIå¯¹æ¯”å…¶ä»–äº§å“Gogsã€githubç­‰å®ƒè¿˜ç®—å¯å ªä¸€ç”¨ã€‚ä¸Šä¸€ç¯‡æ–‡ç« å†™äº†gitlab_ci.ymlé…ç½®æ–‡ä»¶çš„ä¸€äº›å‚æ•°çš„å«ä¹‰ã€‚æœ¬ç¯‡æ–‡ç« è®°å½•ä¸€ä¸‹å¦‚ä½•ä»é›¶åœ¨Gitlabä¸Šå®Œæˆç®€å•çš„CI/CDæµç¨‹ã€‚åŸºç¡€æµç¨‹å¦‚ä¸‹Buildæµç¨‹æ„å»ºæˆ‘ä»¬éœ€è¦çš„é•œåƒä¸Šä¼ åˆ°é•œåƒä»“åº“ã€‚éƒ¨ç½²çš„æ—¶å€™ä»é•œåƒä»“åº“ç›´æ¥æ‹‰å–é‡å¯å®¹å™¨<br><img src="https://ficapy.b0.upaiyun.com/blogimg/GitlabCI.jpg" alt="GitlabCI"><br><a id="more"></a></p>
<h3 id="1-å®‰è£…Docker"><a href="#1-å®‰è£…Docker" class="headerlink" title="1. å®‰è£…Docker"></a>1. å®‰è£…Docker</h3><p>è¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„ã€‚æ— è„‘aptå°±å¥½äº†ã€‚å®‰è£…å®Œæ¯•åéœ€è¦å°†æœ¬åœ°ç”¨æˆ·åŠ å…¥åˆ°Dockerç”¨æˆ·ç»„ã€‚æ–¹ä¾¿å‘½ä»¤çš„æ‰§è¡Œã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹éœ€è¦æ³¨æ„çš„æ˜¯æœ€å¥½ä¿®æ”¹å®ƒçš„é»˜è®¤é…ç½®ï¼Œ/etc/docker/daemon.json</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;data-root&quot;: &quot;/data/docker&quot;,</div><div class="line">    &quot;registry-mirrors&quot;: [&quot;https://xxx.mirror.aliyuncs.com&quot;],</div><div class="line">    &quot;log-opts&quot;: &#123;</div><div class="line">        &quot;max-size&quot;: &quot;50m&quot;,</div><div class="line">        &quot;max-file&quot;: &quot;3&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>ç°åœ¨äº‘ä¸»æœºéƒ½æ˜¯ä½å®¹é‡ç³»ç»Ÿç›˜å¤–åŠ é«˜å®¹é‡æŒ‚è½½ç›˜ç»„æˆã€‚ä¿®æ”¹ä¸€ä¸‹é»˜è®¤çš„æ ¹ç›®å½•ä¼šæ¯”è¾ƒå¥½</li>
<li>æ²¡ä¸ªé•œåƒæºä¸‹è½½dockerhubé•œåƒä¸æ˜æ™ºå•Š</li>
<li>é™å®šä¸€ä¸‹æœ€å¤§æ—¥å¿—é‡æ€»æ²¡é”™ã€‚å¦åˆ™æ—¶é—´å¤ªé•¿æ—¥å¿—å¤šäº†ä¹Ÿå¾ˆçƒ¦äºº</li>
</ol>
<h2 id="2-æ­å»ºDockeré•œåƒä»“åº“"><a href="#2-æ­å»ºDockeré•œåƒä»“åº“" class="headerlink" title="2. æ­å»ºDockeré•œåƒä»“åº“"></a>2. æ­å»ºDockeré•œåƒä»“åº“</h2><p>æˆ‘ä½¿ç”¨çš„æ˜¯Vmwareå‡ºå“çš„<a href="https://github.com/vmware/harbor">Harbor</a>ã€‚å®‰è£…ä¸­é‡åˆ°äº†ä»¥ä¸‹å‡ ä¸ªå‘</p>
<ol>
<li>æŒ‰ç…§æ–‡æ¡£ä»æºç å®‰è£…å¤±è´¥ã€‚ç›´æ¥ä¸‹è½½å…«ç™¾å¤šå…†çš„ç¦»çº¿å®‰è£…åŒ…å®‰è£…å¥½æ­¹ç®—æ˜¯æˆåŠŸäº†</li>
<li>æˆ‘å°†HTTPSæ”¾åˆ°è´Ÿè½½å‡è¡¡ä¸Šé¢ã€‚å®é™…è¯·æ±‚åˆ°åç«¯çš„æ˜¯httpåè®®ã€‚æ‰€ä»¥æˆ‘å°†é…ç½®ä¿®æ”¹ä¸ºhttpã€‚ä½†æ˜¯ç™»é™†å¤±è´¥ã€‚æŸ¥äº†ä¸‹å°†common/config/registry/config.ymlçš„tokenç”±httpæ”¹æˆhttpså¯ä»¥ç™»é™†äº†ã€‚è§£å†³äº†è¿™ä¸ªç„¶åè¿˜ä¸èƒ½pushâ€¦æ²¡åŠæ³•ã€‚æˆ‘å°†è´Ÿè½½å‡è¡¡æ”¹æˆTCPç«¯å£è½¬å‘ã€‚ç›´æ¥å°†è¯ä¹¦æ”¾åœ¨harborä¸Šã€‚å¯ç®—æ˜¯æ²¡æ¯›ç—…äº†</li>
<li>ä»¥å‰é…ç½®è¿‡ä¸€æ¬¡Harborã€‚å¯¼è‡´äº†å†å²é—ç•™æ–‡ä»¶ã€‚å†æ¬¡å®‰è£…ç»“æœå¹¶ä¸ä¼šè¦†ç›–æ‰ä»¥å‰çš„é…ç½®ä¹Ÿä¸ä¼šåšä»»ä½•æç¤ºã€‚</li>
<li>é…ç½®æ–‡ä»¶é‡Œé¢æˆ‘æ”¹äº†ä¸€ä¸‹secretkey_pathåœ°å€ã€‚ç»“æœæ— æ³•ä½¿ç”¨ï¼Œæ— å¥ˆåˆæ”¹å›æ¥äº†</li>
</ol>
<p>æ€»ç»“ã€‚åœ¨Harborä½œä¸ºå®£ç§°çš„ä¼ä¸šçº§Dockeré•œåƒå·¥å…·ã€‚æ€æ‰‹çº§åŠŸèƒ½æ˜¯å¼‚åœ°å¤åˆ¶ï¼Œé•œåƒéªŒè¯ã€‚å®‰å…¨æ‰«æå•¥çš„ã€‚å¦‚æœåªæ˜¯è¦æä¸ªåŸºç¡€çš„é•œåƒä»“åº“ã€‚æœ€åæƒ³äº†æƒ³è¿˜ä¸å¦‚æŠ˜è…¾Gitlabçš„Dockerä»“åº“ã€‚è¯´ä¸å®šåœ¨æƒé™ä¸Šå’ŒGitlabç»“åˆçš„æ›´å¥½</p>
<h2 id="3-æ³¨å†ŒGitlab-runner"><a href="#3-æ³¨å†ŒGitlab-runner" class="headerlink" title="3. æ³¨å†ŒGitlab-runner"></a>3. æ³¨å†ŒGitlab-runner</h2><p>è¿™åº”è¯¥ç®—æ˜¯CIå¼ºå¤§çš„åœ°æ–¹äº†ã€‚å®ƒå’ŒGitlabæœ¬èº«æ¾è€¦åˆã€‚å®¢æˆ·ç«¯å»ºç«‹é•¿è¿æ¥å’ŒGitlabæœåŠ¡å™¨ä¿æŒé€šä¿¡ã€‚å½“æ»¡è¶³æ¡ä»¶çš„æ—¶å€™ç”±Gitlabå¯¹Runnerè¿›è¡Œè°ƒåº¦ã€‚Gitlab-runneræ˜¯ä½¿ç”¨Goç¼–å†™çš„ï¼Œä¾¿äºéƒ¨ç½²ã€‚å½“Runneræ¥æ”¶åˆ°è¯·æ±‚çš„æ—¶å€™å®ƒä¼šæ‰§è¡Œshellè„šæœ¬ã€‚æƒ³è±¡ä¸€ä¸‹pythonç•Œçš„fabricã€‚ä¾æ¬¡æ‰§è¡ŒBashå‘½ä»¤ã€‚Runnerä¹Ÿæ˜¯å·®ä¸å¤šçš„å¥—è·¯ã€‚å¤šæ¡Bashå‘½ä»¤é—´æ˜¯æ²¡æœ‰ç›¸å…³æ€§çš„ã€‚æ¯”å¦‚ä½ ä¸Šä¸€æ¡æ‰§è¡Œ<code>cd demo</code>ä¸‹ä¸€æ¡<code>pwd</code>å¾—åˆ°çš„è¿˜æ˜¯æœ¬åœ°ç”¨æˆ·ç›®å½•ï¼Œå¹¶ä¸æ˜¯demoã€‚</p>
<ol>
<li>å¯åŠ¨gitlab-runner Service</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">docker run -d --name gitlab-runner --restart always \</div><div class="line">  -v /var/gitlab-runner/config:/etc/gitlab-runner \</div><div class="line">  -v /var/run/docker.sock:/var/run/docker.sock \</div><div class="line">  gitlab/gitlab-runner:latest</div></pre></td></tr></table></figure>
<p>é¡ºä¾¿è¯´ä¸€ä¸‹ã€‚è¦æ˜¯æ‰§è¡Œgitlab-runnerçœ‹å®ƒçš„å‘½ä»¤è¡Œå‚æ•°è¿˜æŒºå¤šã€‚å…¶å®æ˜¯è‡ªèº«è®¾è®¡çš„ä¸å¤ªå¥½ã€‚æ˜¾å¾—å¥½åƒå¾ˆå¤æ‚ï¼Œå¾ˆå¤šå‘½ä»¤éœ€è¦è¢«<a href="https://docs.gitlab.com/runner/commands/README.html#service-related-commands">åºŸå¼ƒäº†</a>.å®ƒçš„ä½¿ç”¨å…¶å®è¿˜æ˜¯å¾ˆç®€å•çš„ã€‚å¦‚æœä½ éœ€è¦çœ‹å¸®åŠ©ã€‚é‚£ä¹ˆæ‰§è¡Œ<code>gitlab-runner register -h</code>è¿˜æœ‰ç‚¹ç”¨</p>
<ol>
<li>æ·»åŠ Runner</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">docker exec -it gitlab-runner gitlab-runner register -n --tag-list &quot;name&quot; \</div><div class="line">    -r &quot;token&quot; --name &quot;BigBrother&quot; -u https://gitlab.company.com \</div><div class="line">    --executor &quot;docker&quot; --docker-image &quot;default_image&quot; \</div><div class="line">    --docker-volumes /var/run/docker.sock:/var/run/docker.sock</div></pre></td></tr></table></figure>
<ul>
<li>n è¡¨ç¤ºéäº¤äº’æ¨¡å¼</li>
<li>tag-listè¡¨ç¤ºè¯¥Runnerçš„æ ‡ç­¾(å•ç‹¬çš„é¡¹ç›®ç”¨å•ç‹¬çš„tagä¹ŸæŒºå¥½ã€‚äº’ä¸å¹²æ‰°)</li>
<li>r è¯¥é¡¹ç›®çš„token</li>
<li>name åç§°æ ‡è¯†</li>
<li>u Gitlabåœ°å€</li>
<li>executor å’Œä¸Šé¢è¯´çš„æ‰§è¡Œbashå‘½ä»¤ã€‚æœ‰å¤šç§æ–¹å¼ã€‚æ— è„‘ç”¨dockeræŒºå¥½</li>
<li>docker-image executoré€‰æ‹©äº†dockerä¹‹å,éœ€è¦é€‰æ‹©é»˜è®¤çš„é•œåƒ</li>
<li>docker-volumes è¿™ä¸ªæ˜¯ä¸ºäº†åœ¨dockeré‡Œé¢<a href="https://docs.gitlab.com/ce/ci/docker/using_docker_build.html">ä½¿ç”¨Dockeræ„å»ºé•œåƒ</a></li>
</ul>
<p>ä»¥ä¸Šä¸¤æ­¥å®Œæˆåå°±èƒ½å¤Ÿåœ¨Gitlabåå°çœ‹åˆ°æ­£å¸¸çŠ¶æ€çš„Runneräº†</p>
<h3 id="4-ç¼–å†™-gitlab-ci-ymlæ–‡ä»¶"><a href="#4-ç¼–å†™-gitlab-ci-ymlæ–‡ä»¶" class="headerlink" title="4. ç¼–å†™.gitlab-ci.ymlæ–‡ä»¶"></a>4. ç¼–å†™.gitlab-ci.ymlæ–‡ä»¶</h3><p>å¦‚æœä½ æœ‰ä¸°å¯Œçš„Dockerä½¿ç”¨ç»éªŒï¼Œè¿™ä¸€æ­¥å®é™…ä¸Šæ²¡æœ‰å¤ªå¤§çš„é—®é¢˜ã€‚æœ¬ä¾‹ä¸­æˆ‘åªæ˜¯é€šè¿‡docker buildæ„å»ºäº†é•œåƒã€‚ç„¶åä¸Šä¼ åˆ°ä»“åº“ã€‚éœ€è¦éƒ¨ç½²çš„æ—¶å€™ä½¿ç”¨SSHè¿æ¥åˆ°è¿œç¨‹æœºå™¨ä¸Šä½¿ç”¨<code>docker-compose up --build -d</code>æ›´æ–°ç¨‹åº<br>Demoé¡¹ç›®ç›®å½•å¦‚ä¸‹ã€‚æ­£å¸¸æœ¬åœ°å¯åŠ¨æ‰§è¡Œpython main.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">.</div><div class="line">â”œâ”€â”€ README.md</div><div class="line">â”œâ”€â”€ conf.py</div><div class="line">â”œâ”€â”€ deploy</div><div class="line">â”‚Â Â  â”œâ”€â”€ Dockerfile</div><div class="line">â”‚Â Â  â”œâ”€â”€ prod_env</div><div class="line">â”‚Â Â  â”œâ”€â”€ docker-compose.yml</div><div class="line">â”‚Â Â  â””â”€â”€ stage_env</div><div class="line">â”œâ”€â”€ main.py</div><div class="line">â”œâ”€â”€ .gitlab-ci.yml</div><div class="line">â””â”€â”€ requirements.txt</div></pre></td></tr></table></figure>
<p>Dockerfileå¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">FROM ficapy/python35_alpine</div><div class="line"></div><div class="line">RUN mkdir /app</div><div class="line">WORKDIR /app</div><div class="line">ENV PYTHONPATH=/app</div><div class="line"></div><div class="line">COPY ./requirements.txt /app/requirements.txt</div><div class="line">RUN pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple</div><div class="line"></div><div class="line">COPY . /app</div><div class="line"></div><div class="line">CMD [&quot;python&quot;, &quot;main.py&quot;]</div></pre></td></tr></table></figure>
<p>docker-compose.ymlå¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">version: &apos;3&apos;</div><div class="line"></div><div class="line">services:</div><div class="line">  Name:</div><div class="line">    image: registry.company.com/repos/projectname:$&#123;TAG&#125;</div><div class="line">    restart: always</div><div class="line">    env_file:</div><div class="line">      - $&#123;ENV&#125;_env</div></pre></td></tr></table></figure>
<p>.gitlab-ci.ymlå¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">image: ficapy/docker:latest</div><div class="line"></div><div class="line">variables:</div><div class="line">  SSH: &quot;Host xxxxx&quot;</div><div class="line"></div><div class="line">stages:</div><div class="line">  - build</div><div class="line">  - deploy</div><div class="line"></div><div class="line">build:</div><div class="line">  stage: build</div><div class="line">  only:</div><div class="line">    - master</div><div class="line">  tags:</div><div class="line">    - tag</div><div class="line">  script:</div><div class="line">      - export DOCKER_TAG=$(env TZ=&apos;Asia/Shanghai&apos; date -d @$(git log -n1 $CI_COMMIT_SHA --format=&quot;%at&quot;) +%Y_%m_%d_%H%M%S)</div><div class="line">      - echo $DOCKER_TAG</div><div class="line">      - docker login -u deploy -p $DOCKER_PWD registry.company.com</div><div class="line">      - docker build -t registry.company.com/repos/must_lower_case:$DOCKER_TAG -f deploy/Dockerfile .</div><div class="line">      - docker push registry.company.com/repos/must_lower_case:$DOCKER_TAG</div><div class="line"></div><div class="line">prod_deploy:</div><div class="line">  stage: deploy</div><div class="line">  only:</div><div class="line">    - master</div><div class="line">  tags:</div><div class="line">    - tag</div><div class="line">  when: manual</div><div class="line">  variables:</div><div class="line">    SERVER: ssh_name</div><div class="line">  before_script:</div><div class="line">    - export DOCKER_TAG=$(env TZ=&apos;Asia/Shanghai&apos; date -d @$(git log -n1 $CI_COMMIT_SHA --format=&quot;%at&quot;) +%Y_%m_%d_%H%M%S)</div><div class="line">    - echo $DOCKER_TAG</div><div class="line">    - eval $(ssh-agent -s)</div><div class="line">    - bash -c &quot;ssh-add &lt;(echo &apos;$SSH_PRIVATE_KEY&apos;)&quot;</div><div class="line">    - mkdir -p ~/.ssh</div><div class="line">    - &apos;[[ -f /.dockerenv ]] &amp;&amp; echo -e &quot;$SSH&quot; &gt; ~/.ssh/config&apos;</div><div class="line">  script:</div><div class="line">    - ssh $SERVER &quot;mkdir -p ~/$CI_PROJECT_NAME || true&quot;</div><div class="line">    - rsync -r deploy $SERVER:~/$CI_PROJECT_NAME</div><div class="line">    - ssh $SERVER &quot;docker login -u deploy -p $DOCKER_PWD registry.company.com&quot;</div><div class="line">    - ssh $SERVER &quot;cd $CI_PROJECT_NAME/deploy &amp;&amp; TAG=$DOCKER_TAG ENV=prod docker-compose up --build -d&quot;</div><div class="line">  environment:</div><div class="line">    name: PROD</div></pre></td></tr></table></figure>
<p>æ•´ä¸ªè¿‡ç¨‹çœ‹é…ç½®æ–‡ä»¶åº”è¯¥è¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“ç†è§£çš„ã€‚å¦‚æœæœ‰äº›å‚æ•°ä¸å¤ªæ˜ç™½è¯·æŸ¥çœ‹å‰ä¸€ç¯‡gitlabci ymlç¬”è®°ã€‚å› ä¸ºå®ƒåªæ˜¯ä¸ªDemoã€‚æ‰€ä»¥æˆ‘è®©ä»–åœ¨æ¯æ¬¡masteråˆ†æ”¯æäº¤çš„æ—¶å€™éƒ½è¿›è¡Œè§¦å‘ã€‚æ•´ä¸ªéƒ¨ç½²æµç¨‹å®é™…ä¸Šå°±æ˜¯ä½¿ç”¨äº†SSHè¿œç¨‹è¿æ¥ä¹‹åæ“ä½œdocker-composeè¿›è¡Œæ›´æ–°ã€‚è¿‡ç¨‹ä¸­æ„Ÿè§‰è®©æˆ‘æ¯”è¾ƒéš¾ä»¥å†³æ–­çš„æ˜¯å¦‚ä½•æä¸€ä¸ªå¥½çš„TAGæ–¹æ³•</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å®Œæˆä¸Šè¿°è¿‡ç¨‹ä¹‹åæˆ‘åšä¸€ä¸ªè‡ªæˆ‘æ€»ç»“ã€‚æ‰€è°“CI/CDä¸è¿‡æ˜¯å°†æˆ‘ä»¬æ‡’å¾—è¾“å…¥çš„å‘½ä»¤ç»„åˆå½¢æˆæ–‡ä»¶ã€‚è®©å®ƒä¾æ¬¡æ‰§è¡ŒTest-&gt;Build-&gt;Deployã€‚è¯¥æ–¹æ¡ˆå‡ ä¹ä½¿ç”¨äº†å…¨å¥—Docker.ä»gitlab-runnerã€buildåˆ°é•œåƒä»“åº“åˆ°ç”Ÿäº§ç¯å¢ƒçš„éƒ¨ç½²ã€‚åœ¨é¡¹ç›®æ¯”è¾ƒå¤šçš„æ—¶å€™å®ƒæ˜¯æœ‰å¥½å¤„çš„ã€‚æ¯”å¦‚æœ‰åä¸ªé¡¹ç›®éœ€è¦æ›´æ–°ã€‚æ¯ä¸ªé¡¹ç›®éœ€è¦æ›´æ–°åˆ°å¤šä¸ªç¯å¢ƒä¸‹ã€‚é‚£ä¹ˆä½¿ç”¨è¿™ç§è‡ªåŠ¨åŒ–è¿˜æ˜¯æœ‰ä¼˜åŠ¿çš„ã€‚å¦‚æœå°±ä¸€ä¸¤ä¸ªé¡¹ç›®ï¼Œè€Œä¸”åªéœ€è¦æ›´æ–°åˆ°æµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒã€‚ä¸ªäººè§‰å¾—fabricå°±å¤Ÿäº†ã€‚è€Œä¸”è¯¥æ–¹æ¡ˆæœ‰ä¸€ä¸ªç¼ºç‚¹å°±æ˜¯éƒ¨ç½²é€Ÿåº¦è¾ƒæ…¢ã€‚Gitlabæ¯æ¬¡æ‰§è¡Œä»»åŠ¡é€Ÿåº¦å¹¶ä¸æ˜¯æƒ³è±¡çš„é‚£ä¹ˆå¿«ã€‚æœ€åç”Ÿæˆé•œåƒï¼Œä¸Šä¼ ï¼Œå†æ‹‰å–åˆ°æ­£å¼ç¯å¢ƒã€‚å¦‚æœé•œåƒè¿‡å¤§å°±æ›´æ…¢äº†ã€‚è€Œå¦‚æœä¸ä½¿ç”¨Dockeré•œåƒçš„æ–¹å¼ã€‚ç›´æ¥git pullæ‹‰å–æºç ã€‚å†supervisorctlæ›´æ–°ç¨‹åºã€‚æ—¶é—´åŸºæœ¬æ˜¯ç§’çº§çš„ã€‚åœ¨é¢‘ç¹æ›´æ–°çš„æµ‹è¯•ç¯å¢ƒå®ƒå¯èƒ½æ›´é«˜æ•ˆã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;GitLabCI-CDæµç¨‹&quot;&gt;&lt;a href=&quot;#GitLabCI-CDæµç¨‹&quot; class=&quot;headerlink&quot; title=&quot;GitLabCI/CDæµç¨‹&quot;&gt;&lt;/a&gt;GitLabCI/CDæµç¨‹&lt;/h3&gt;&lt;p&gt;gitlabå¦‚æœæ²¡æœ‰å’ŒDockerå¾ˆå¥½çš„ç»“åˆã€‚é‚£ä¹ˆå®ƒä¼šæ˜¯ä¸€ä¸ªå¾ˆå¹³å‡¡çš„äº§å“ã€‚ä½†æ˜¯æœ‰äº†CIå¯¹æ¯”å…¶ä»–äº§å“Gogsã€githubç­‰å®ƒè¿˜ç®—å¯å ªä¸€ç”¨ã€‚ä¸Šä¸€ç¯‡æ–‡ç« å†™äº†gitlab_ci.ymlé…ç½®æ–‡ä»¶çš„ä¸€äº›å‚æ•°çš„å«ä¹‰ã€‚æœ¬ç¯‡æ–‡ç« è®°å½•ä¸€ä¸‹å¦‚ä½•ä»é›¶åœ¨Gitlabä¸Šå®Œæˆç®€å•çš„CI/CDæµç¨‹ã€‚åŸºç¡€æµç¨‹å¦‚ä¸‹Buildæµç¨‹æ„å»ºæˆ‘ä»¬éœ€è¦çš„é•œåƒä¸Šä¼ åˆ°é•œåƒä»“åº“ã€‚éƒ¨ç½²çš„æ—¶å€™ä»é•œåƒä»“åº“ç›´æ¥æ‹‰å–é‡å¯å®¹å™¨&lt;br&gt;&lt;img src=&quot;https://ficapy.b0.upaiyun.com/blogimg/GitlabCI.jpg&quot; alt=&quot;GitlabCI&quot;&gt;&lt;br&gt;
    
    </summary>
    
      <category term="devops" scheme="https://www.zoulei.net/categories/devops/"/>
    
    
  </entry>
  
  <entry>
    <title>gitlabci yml ç¬”è®°</title>
    <link href="https://www.zoulei.net/2017/12/25/gitlabciyml_note/"/>
    <id>https://www.zoulei.net/2017/12/25/gitlabciyml_note/</id>
    <published>2017-12-25T04:17:56.000Z</published>
    <updated>2017-12-25T06:10:56.899Z</updated>
    
    <content type="html"><![CDATA[<p>ä»¥ä¸‹å†…å®¹æ¥è‡ªGitlabCIå®˜æ–¹æ–‡æ¡£</p>
<h2 id="æœ€åŸºç¡€çš„"><a href="#æœ€åŸºç¡€çš„" class="headerlink" title="æœ€åŸºç¡€çš„"></a>æœ€åŸºç¡€çš„</h2><ul>
<li><p>jobsä½œä¸ºæœ€é¡¶çº§çš„å…ƒç´ ã€‚æ¯ä¸ªjobè‡³å°‘åŒ…å«ä¸€ä¸ªscript</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">job1:</div><div class="line">    script1: pwd</div></pre></td></tr></table></figure>
<p>  æ¯ä¸ªjobçš„æ‰§è¡Œéƒ½æ˜¯å®Œå…¨ç‹¬ç«‹äºå…¶ä»–çš„job</p>
</li>
</ul>
<a id="more"></a>
<h2 id="å…³äºDocker-Imageå’ŒServiceçš„ä½¿ç”¨"><a href="#å…³äºDocker-Imageå’ŒServiceçš„ä½¿ç”¨" class="headerlink" title="å…³äºDocker Imageå’ŒServiceçš„ä½¿ç”¨"></a>å…³äºDocker Imageå’ŒServiceçš„ä½¿ç”¨</h2><ul>
<li><a href="https://docs.gitlab.com/ee/ci/docker/using_docker_build.html">Using Docker Build</a>ã€‚ä¸»è¦è®²è¿°æ€ä¹ˆåœ¨Dockeré‡Œé¢ä½¿ç”¨Dockeræ„å»ºé•œåƒã€‚(æœ€ç®€å•çš„æ˜¯åœ¨æ³¨å†ŒRunnerçš„æ—¶å€™å…±äº«/var/run/docker.sock)</li>
<li><p><a href="https://docs.gitlab.com/ee/ci/docker/using_docker_images.html">Using Docker images</a>ã€‚</p>
</li>
<li><p>æ³¨å†Œçš„æ—¶å€™å¯ä»¥åŒæ—¶è¿è¡ŒServicesã€‚è¿™æ ·åœ¨ä»»åŠ¡æ‰§è¡ŒæœŸé—´å¯ä»¥è®¿é—®services</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">sudo gitlab-runner register \</div><div class="line">    --url &quot;https://gitlab.example.com/&quot; \</div><div class="line">    --registration-token &quot;PROJECT_REGISTRATION_TOKEN&quot; \</div><div class="line">    --description &quot;docker-ruby-2.1&quot; \</div><div class="line">    --executor &quot;docker&quot; \</div><div class="line">    --docker-image ruby:2.1 \</div><div class="line">    --docker-postgres latest \</div><div class="line">    --docker-mysql latest</div></pre></td></tr></table></figure>
</li>
<li><p>serviceå°±æ˜¯ä»»åŠ¡æ‰§è¡Œçš„æ—¶å€™èƒ½å¤Ÿè®¿é—®åˆ°åˆ«çš„å®¹å™¨ã€‚æ¯”å¦‚Mysqlã€Postgresqlã€Redisã€Rabbitmqå•¥çš„</p>
</li>
<li>è®¿é—®serviceå°±å’Œæˆ‘ä»¬ä½¿ç”¨docker-composeå·®ä¸å¤š</li>
</ul>
<h2 id="å…¶ä»–çš„ä¸€äº›Top-Levelè®¾ç½®"><a href="#å…¶ä»–çš„ä¸€äº›Top-Levelè®¾ç½®" class="headerlink" title="å…¶ä»–çš„ä¸€äº›Top-Levelè®¾ç½®"></a>å…¶ä»–çš„ä¸€äº›Top-Levelè®¾ç½®</h2><ul>
<li>before_script: åœ¨æ¯ä¸ªä»»åŠ¡æ‰§è¡Œå‰æ‰§è¡Œ.æ¯”å¦‚é…ç½®å¥½ssh config</li>
<li>after_script: åœ¨æ¯ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆåæ‰§è¡Œ.å¥½åƒç”¨å¤„ä¸å¤§</li>
<li>stages: <span style="color:red"><strong> æ¯ä¸ªä»»åŠ¡éƒ½å¯ä»¥å±äºä¸€ä¸ªstage.åŒä¸€ä¸ªstageçš„jobæ˜¯å¹¶è¡Œçš„.ä½†æ˜¯åªæœ‰ä¸€ä¸ªstageæ‰€æœ‰éƒ½æ‰§è¡Œå®Œæ¯•æ‰ä¼šæ‰§è¡Œä¸‹ä¸€ä¸ªstage</strong></span></li>
<li>variables: æ¯ä¸ªjobéƒ½å¯ä»¥ä½¿ç”¨çš„ç¯å¢ƒå˜é‡ã€‚æ­¤å¤„åªèƒ½è¿›è¡Œå¾ˆç®€å•çš„è®¾ç½®ã€‚æ¯”å¦‚æˆ‘å¸Œæœ›å°†å½“å‰æ—¥æœŸç”¨ä¸€ä¸ªå›ºå®šçš„æ ¼å¼è¡¨è¾¾(éœ€è¦ç”¨dateå‘½ä»¤è¿›è¡Œè½¬æ¢),åœ¨è¿™é‡Œæ˜¯è¡Œä¸é€šçš„</li>
<li>cache: </li>
</ul>
<h2 id="å¯é€‰é¡¹æœ€å¤šçš„Jobsé…ç½®æ¥äº†"><a href="#å¯é€‰é¡¹æœ€å¤šçš„Jobsé…ç½®æ¥äº†" class="headerlink" title="å¯é€‰é¡¹æœ€å¤šçš„Jobsé…ç½®æ¥äº†"></a>å¯é€‰é¡¹æœ€å¤šçš„Jobsé…ç½®æ¥äº†</h2><ul>
<li>jobs: å¿…é¡»è¦æœ‰ç‹¬ç«‹çš„åç§°</li>
</ul>
<table>
<thead>
<tr>
<th>Keyword</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>script</td>
<td>å®šä¹‰shellè„šæœ¬</td>
</tr>
<tr>
<td>image</td>
<td>ä½¿ç”¨çš„image.å¯ä»¥è¦†ç›–æ‰å…¨å±€çš„</td>
</tr>
<tr>
<td>services</td>
<td>ä½¿ç”¨docker services,è¦†ç›–æ‰å…¨å±€</td>
</tr>
<tr>
<td>stage</td>
<td>å±äºå“ªä¸ªé˜¶æ®µ</td>
</tr>
<tr>
<td>variables</td>
<td>å®šä¹‰jobçš„ç¯å¢ƒå˜é‡</td>
</tr>
<tr>
<td>only</td>
<td>åªæœ‰æ»¡è¶³æŸæ¡ä»¶çš„æ—¶å€™æ‰ä¼šè¢«æ‰§è¡Œ</td>
</tr>
<tr>
<td>except</td>
<td>æ»¡è¶³æŸæ¡ä»¶çš„æ—¶å€™ä¸æ‰§è¡Œ</td>
</tr>
<tr>
<td>tags</td>
<td>å“ªäº›Runnersèƒ½å¤Ÿæ‰§è¡Œè¯¥ä»»åŠ¡</td>
</tr>
<tr>
<td>allow_failure</td>
<td>å…è®¸ä»»åŠ¡å¤±è´¥ã€‚æ­£å¸¸æƒ…å†µä¸‹å¤±è´¥åˆ™ä¼šä¸è¿›è¡Œåç»­æ­¥éª¤</td>
</tr>
<tr>
<td>when</td>
<td>å®šä¹‰ä»»åŠ¡ä»€ä¹ˆæ—¶å€™æ‰§è¡Œã€‚manualæ‰‹åŠ¨è¿˜æŒºæœ‰ç”¨â”‘(ï¿£Ğ” ï¿£)â”</td>
</tr>
<tr>
<td>artifacts</td>
<td>å°†æ„å»ºç”Ÿæˆçš„æ–‡ä»¶ä¸Šä¼ åˆ°gitlabã€‚å…è®¸ä»gitlabåå°è¿›è¡Œä¸‹è½½</td>
</tr>
<tr>
<td>dependencies</td>
<td>é…åˆartifactsä½¿ç”¨ã€‚å°†ç”Ÿæˆçš„artifactsæ–‡ä»¶è·¨jobä½¿ç”¨    </td>
</tr>
<tr>
<td>cache</td>
<td>ç¼“å­˜æ–‡ä»¶ç»™åç»­jobä½¿ç”¨</td>
</tr>
<tr>
<td>before_script</td>
<td>è¦†ç›–å…¨å±€</td>
</tr>
<tr>
<td>after_script</td>
<td>è¦†ç›–å…¨å±€</td>
</tr>
<tr>
<td>environment</td>
<td><a href="https://docs.gitlab.com/ee/ci/environments.html">æ–‡æ¡£</a></td>
</tr>
<tr>
<td>coverage</td>
<td>ä»£ç è¦†ç›–ç‡è®¾ç½®</td>
</tr>
<tr>
<td>retry</td>
<td>å¦‚æœå¤±è´¥åˆ™é‡è¯•å‡ æ¬¡</td>
</tr>
</tbody>
</table>
<p>é¢å¤–è¯´æ˜:</p>
<ol>
<li>environmenté…åˆdeployä½¿ç”¨.éƒ¨ç½²çš„æ—¶å€™äººä¸ºæ ‡è®°æ˜¯éƒ¨ç½²åˆ°äº†å“ªä¸ªç¯å¢ƒã€‚æ–¹ä¾¿åœ¨gitlabåå°æŸ¥çœ‹å†å²è®°å½•ã€‚åŒæ—¶æ–¹ä¾¿é”™è¯¯çš„æ—¶å€™å¯ä»¥ç›´æ¥åœ¨gitlabåå°å›æ»šéƒ¨ç½²ã€‚å…¶å®è¿™ä¸ªå‚æ•°ä¸è¦ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚æ·»åŠ ä¸Šå»åªæ˜¯æ›´æ–¹ä¾¿ä¸€ç‚¹</li>
<li>artifactså’Œcacheçš„åŒºåˆ«.<ul>
<li>cacheå¯ä»¥åœ¨å…¨å±€ä½¿ç”¨ä¹Ÿå¯ä»¥åœ¨jobå†…éƒ¨ä½¿ç”¨.ä½†æ˜¯artifactsåªèƒ½åœ¨jobå†…éƒ¨ä½¿ç”¨</li>
<li><span style="color:red"><strong>ç‰¹åˆ«æ³¨æ„</strong></span> cacheè·¨è¶Šè¯¥é¡¹ç›®çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚è·¨è¶Šä¸åŒçš„pipeline.jobå¼€å§‹ä¹‹å‰ä¼šå…ˆè§£å‹å·²æœ‰çš„cache.è€Œartifactsåªä¼šå†å•ä¸ªpipelineå‘¨æœŸã€‚ä¸”æŸä¸ªstageåˆ›å»ºä¹‹åã€‚åœ¨åç»­çš„stageä¸­æ‰èƒ½å¤Ÿä½¿ç”¨ã€‚artifactsä¼šåŒæ—¶ä¸Šä¼ æ–‡ä»¶åˆ°gitlab(ä¸Šä¼ æ­¥éª¤è¿˜æ˜¯å¿…é¡»çš„)ã€‚</li>
</ul>
</li>
</ol>
<h2 id="YAMLç‰¹æ®Šè¯­æ³•"><a href="#YAMLç‰¹æ®Šè¯­æ³•" class="headerlink" title="YAMLç‰¹æ®Šè¯­æ³•"></a>YAMLç‰¹æ®Šè¯­æ³•</h2><ul>
<li><p>ç”¨anchors(&amp;)ã€aliases(*)ã€merging(&lt;&lt;) æ¥ç®€åŒ–ç¼–å†™(å¤§å¤šæ•°æƒ…å†µä¸‹åº”è¯¥æ²¡å•¥ç”¨)</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">.job_template: &amp;job_definition  # Hidden key that defines an anchor named &apos;job_definition&apos;</div><div class="line">image: ruby:2.1</div><div class="line">services:</div><div class="line">    - postgres</div><div class="line">    - redis</div><div class="line"></div><div class="line">test1:</div><div class="line">&lt;&lt;: *job_definition           # Merge the contents of the &apos;job_definition&apos; alias</div><div class="line">script:</div><div class="line">    - test1 project</div><div class="line"></div><div class="line">test2:</div><div class="line">&lt;&lt;: *job_definition           # Merge the contents of the &apos;job_definition&apos; alias</div><div class="line">script:</div><div class="line">    - test2 project</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h3><p><a href="https://docs.gitlab.com/ee/ci/yaml/README.html">Configuration of your jobs with .gitlab-ci.yml </a><br><a href="https://docs.gitlab.com/ee/ci/docker/using_docker_images.html">Using Docker images</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»¥ä¸‹å†…å®¹æ¥è‡ªGitlabCIå®˜æ–¹æ–‡æ¡£&lt;/p&gt;
&lt;h2 id=&quot;æœ€åŸºç¡€çš„&quot;&gt;&lt;a href=&quot;#æœ€åŸºç¡€çš„&quot; class=&quot;headerlink&quot; title=&quot;æœ€åŸºç¡€çš„&quot;&gt;&lt;/a&gt;æœ€åŸºç¡€çš„&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;jobsä½œä¸ºæœ€é¡¶çº§çš„å…ƒç´ ã€‚æ¯ä¸ªjobè‡³å°‘åŒ…å«ä¸€ä¸ªscript&lt;/p&gt;
  &lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;job1:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    script1: pwd&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;  æ¯ä¸ªjobçš„æ‰§è¡Œéƒ½æ˜¯å®Œå…¨ç‹¬ç«‹äºå…¶ä»–çš„job&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="devops" scheme="https://www.zoulei.net/categories/devops/"/>
    
    
  </entry>
  
  <entry>
    <title>influxdb ä¸“ä¸šæœ¯è¯­</title>
    <link href="https://www.zoulei.net/2017/12/09/influxdb_glossary/"/>
    <id>https://www.zoulei.net/2017/12/09/influxdb_glossary/</id>
    <published>2017-12-09T00:02:41.000Z</published>
    <updated>2017-12-09T08:52:51.153Z</updated>
    
    <content type="html"><![CDATA[<p>ä»¥ä¸‹å†…å®¹åŸºæœ¬å…¨ç¯‡æ‘˜æŠ„è‡ªv1.3çš„å®˜æ–¹æ–‡æ¡£,å…ˆä»ç†è§£ä¸‹é¢è¿™å¼ ä¸¤å¼ å›¾å¼€å§‹<br><img src="https://ficapy.b0.upaiyun.com/capture/influxdb_glossary.jpg" alt="influxdb_glossary"><br><img src="https://ficapy.b0.upaiyun.com/capture/influxdb_field.jpg" alt="influxdb"><br><a id="more"></a></p>
<h3 id="aggregation-èšåˆ"><a href="#aggregation-èšåˆ" class="headerlink" title="aggregation èšåˆ"></a>aggregation èšåˆ</h3><p>ä½¿ç”¨èšåˆå‡½æ•°å¯¹pointsä¸­çš„setè¿”å›èšåˆç»“æœ</p>
<ul>
<li>count è¿”å›énullçš„field valuesä¸ªæ•°</li>
<li>distinct  è¿”å›å”¯ä¸€field valuesåˆ—è¡¨</li>
<li>integral ç”±è¿‡æ»¤æ¡ä»¶ç»„æˆçš„ç§¯åˆ†</li>
<li>mean  è¿”å›field valuesçš„ç®—æœ¯å¹³å‡å€¼</li>
<li>median è¿”å›field valuesæ’åºåçš„ä¸­ä½æ•°</li>
<li>mode  ä»field valuesåˆ—è¡¨ä¸­è¿”å›æœ€å¸¸ç”¨çš„å€¼</li>
<li>spread æœ€å¤§å‡å»æœ€å°</li>
<li>stddev æ ‡å‡†å·®</li>
<li>sum æ±‚å’Œ</li>
</ul>
<h3 id="batch-æ‰¹é‡"><a href="#batch-æ‰¹é‡" class="headerlink" title="batch æ‰¹é‡"></a>batch æ‰¹é‡</h3><p>ä¸ºäº†å‡å°‘influxdbçš„è´Ÿè½½ï¼Œå»ºè®®å¯¹pointçš„é›†åˆè¿›è¡Œä¸Šä¼ ã€‚ä½¿ç”¨\nåšåˆ†å‰²ã€‚å»ºè®®æ¯æ‰¹åŒ…å«äº”åƒåˆ°ä¸€ä¸‡ä¸ªpoint</p>
<h3 id="continuous-query-CQ-æŒç»­æŸ¥è¯¢"><a href="#continuous-query-CQ-æŒç»­æŸ¥è¯¢" class="headerlink" title="continuous query(CQ) æŒç»­æŸ¥è¯¢"></a>continuous query(CQ) æŒç»­æŸ¥è¯¢</h3><p>å®šæœŸæ‰§è¡Œè‡ªåŠ¨æŸ¥è¯¢å¹¶å°†ç»“æœæŒä¹…åŒ–åˆ°æ•°æ®åº“</p>
<h3 id="database-æ•°æ®åº“"><a href="#database-æ•°æ®åº“" class="headerlink" title="database æ•°æ®åº“"></a>database æ•°æ®åº“</h3><p>å’Œå…³ç³»å‹æ•°æ®åº“å·®ä¸å¤šå§ã€‚</p>
<table>
<thead>
<tr>
<th>å…³ç³»å‹æ•°æ®åº“</th>
<th>influxdb</th>
</tr>
</thead>
<tbody>
<tr>
<td>database</td>
<td>database</td>
</tr>
<tr>
<td>table</td>
<td>measurement</td>
</tr>
<tr>
<td>row</td>
<td>point</td>
</tr>
</tbody>
</table>
<p>ç‰¹åˆ«ç‚¹çš„å°±æ˜¯ã€‚influxdbæœ‰ä¿ç•™ç­–ç•¥</p>
<h3 id="duration-æŒç»­æ—¶é—´"><a href="#duration-æŒç»­æ—¶é—´" class="headerlink" title="duration æŒç»­æ—¶é—´"></a>duration æŒç»­æ—¶é—´</h3><p>ä¿ç•™ç­–ç•¥çš„ä¸€ä¸ªå±æ€§è¡¨ç¤ºæ•°æ®ä¼šä¿å­˜å¤šä¹…ã€‚æ•°æ®è¿‡æœŸä¼šè¢«æ‰§è¡Œè‡ªåŠ¨åˆ é™¤</p>
<h3 id="field-å­—æ®µ"><a href="#field-å­—æ®µ" class="headerlink" title="field å­—æ®µ"></a>field å­—æ®µ</h3><p>å¯¹æ¯”tagæ¥è¯´fieldæ²¡æœ‰è¢«ç´¢å¼•ã€‚åœ¨ä¸€æ®µæ—¶é—´èŒƒå›´å†…æŸ¥è¯¢fieldçš„å€¼éœ€è¦æ‰«ææ‰€æœ‰çš„pointå¾—åˆ°ç»“æœã€‚æ€§èƒ½æ²¡æœ‰tagå¥½</p>
<h3 id="field-key-å­—æ®µçš„key"><a href="#field-key-å­—æ®µçš„key" class="headerlink" title="field key å­—æ®µçš„key"></a>field key å­—æ®µçš„key</h3><p>åœ¨key-valueå¯¹ä¸­è¡¨ç¤ºfieldå­—æ®µçš„key.åªèƒ½æ˜¯stringç±»å‹ã€‚å­˜å‚¨åˆ°metadataä¸­</p>
<h3 id="field-set-å­—æ®µçš„é›†åˆ"><a href="#field-set-å­—æ®µçš„é›†åˆ" class="headerlink" title="field set å­—æ®µçš„é›†åˆ"></a>field set å­—æ®µçš„é›†åˆ</h3><p>æ‰€æœ‰field keyçš„é›†åˆ</p>
<h3 id="field-value-å­—æ®µçš„å€¼"><a href="#field-value-å­—æ®µçš„å€¼" class="headerlink" title="field value å­—æ®µçš„å€¼"></a>field value å­—æ®µçš„å€¼</h3><p>fieldçš„valueã€‚ç±»å‹å¯ä»¥æ˜¯stringsã€floatã€integersã€booleansã€‚fieldçš„å€¼å§‹ç»ˆä¸æ—¶é—´æˆ³ç›¸å…³</p>
<h3 id="function-å‡½æ•°"><a href="#function-å‡½æ•°" class="headerlink" title="function å‡½æ•°"></a>function å‡½æ•°</h3><p>åˆ†ä¸‰ç±»ï¼Œèšåˆã€é€‰æ‹©ã€è½¬æ¢</p>
<h3 id="identifier-æ ‡è¯†"><a href="#identifier-æ ‡è¯†" class="headerlink" title="identifier æ ‡è¯†"></a>identifier æ ‡è¯†</h3><p>emmmâ€¦æŒç»­æŸ¥è¯¢åç§°ã€æ•°æ®åº“åç§°ã€fieldå­—æ®µã€åº¦é‡åç§°ã€ä¿ç•™ç­–ç•¥åç§°ã€è®¢é˜…åç§°ã€æ ‡ç­¾åç§°ã€ç”¨æˆ·å</p>
<h3 id="line-protocol-è¡Œåè®®"><a href="#line-protocol-è¡Œåè®®" class="headerlink" title="line protocol è¡Œåè®®"></a>line protocol è¡Œåè®®</h3><p>åŸºäºæ–‡æœ¬æ ¼å¼å†™å…¥åˆ°influxdb</p>
<h3 id="measurement-åº¦é‡"><a href="#measurement-åº¦é‡" class="headerlink" title="measurement åº¦é‡"></a>measurement åº¦é‡</h3><p>emmmâ€¦å¯ä»¥ç±»æ¯”åˆ°å…³ç³»å‹æ•°æ®åº“çš„table</p>
<h3 id="metastore-å…ƒæ•°æ®å­˜å‚¨"><a href="#metastore-å…ƒæ•°æ®å­˜å‚¨" class="headerlink" title="metastore  å…ƒæ•°æ®å­˜å‚¨"></a>metastore  å…ƒæ•°æ®å­˜å‚¨</h3><p>åŒ…å«å†…éƒ¨ç³»ç»Ÿçš„çŠ¶æ€ä¿¡æ¯ã€‚å…ƒç´ æ®å­˜å‚¨åŒ…å«äº†ç”¨æˆ·ä¿¡æ¯ã€æ•°æ®åº“ä¿¡æ¯ã€ä¿ç•™ä¾§åˆ—ã€åˆ†ç‰‡å…ƒæ•°æ®ã€æŒç»­æŸ¥è¯¢å’Œè®¢é˜…</p>
<h3 id="node-èŠ‚ç‚¹"><a href="#node-èŠ‚ç‚¹" class="headerlink" title="node èŠ‚ç‚¹"></a>node èŠ‚ç‚¹</h3><p>ä¸€ä¸ªç‹¬ç«‹çš„influxdè¿›ç¨‹</p>
<h3 id="now"><a href="#now" class="headerlink" title="now()"></a>now()</h3><p>æœ¬åœ°çš„çº³ç§’æ—¶é—´æˆ³</p>
<h3 id="point-ç‚¹"><a href="#point-ç‚¹" class="headerlink" title="point ç‚¹"></a>point ç‚¹</h3><ul>
<li>åœ¨serisesä¸­ç”±fieldsç»„æˆçš„å•ä¸ªæ•°æ®ã€‚<code>æ¯ä¸ªpointç”±å®ƒçš„serieså’Œæ—¶é—´æˆ³ç»„æˆå”¯ä¸€æ ‡è¯†</code>(é‡ç‚¹)</li>
<li>å¯¹äºä¸€ä¸ªç›¸åŒçš„æ—¶é—´æˆ³å’Œç›¸åŒçš„seriesåªèƒ½ä¿å­˜ä¸€ä¸ªpoint.å¦‚æœç›¸åŒåˆ™æ–°çš„field setè¦†ç›–æ‰æ—§çš„</li>
</ul>
<h3 id="query-æŸ¥è¯¢"><a href="#query-æŸ¥è¯¢" class="headerlink" title="query æŸ¥è¯¢"></a>query æŸ¥è¯¢</h3><p>ä»influxdbä¸­æŸ¥è¯¢åˆ°ç›¸å…³æ•°æ®çš„æ“ä½œ</p>
<h3 id="replication-factor-å¤åˆ¶å› å­"><a href="#replication-factor-å¤åˆ¶å› å­" class="headerlink" title="replication factor å¤åˆ¶å› å­"></a>replication factor å¤åˆ¶å› å­</h3><p>å¯¹é›†ç¾¤æœ‰ç”¨ã€‚O__O â€œâ€¦å¯æ˜¯é›†ç¾¤å¹¶ä¸æ˜¯å…è´¹åŠŸèƒ½,å°†ä¸€ä»½æ•°æ®ä¿ç•™åˆ°é›†ç¾¤ä¸Šå¤šä»½</p>
<h3 id="retention-policy-RP-ä¿ç•™ç­–ç•¥"><a href="#retention-policy-RP-ä¿ç•™ç­–ç•¥" class="headerlink" title="retention policy(RP) ä¿ç•™ç­–ç•¥"></a>retention policy(RP) ä¿ç•™ç­–ç•¥</h3><p>ä»¥æ•°æ®åº“ä½œä¸ºå•ä½ï¼Œåˆ†ä¸‰ä¸ªæ–¹é¢ã€‚ä¿ç•™æ—¶é•¿ï¼Œæ•°æ®å¤šä¹…è¿›è¡Œä¸€æ¬¡åˆ†ç‰‡æ“ä½œã€‚æ•°æ®è®¾ç½®å¤šå°‘ä¸ªå‰¯æœ¬ã€‚é»˜è®¤autogenè¡¨ç¤ºæ°¸ä¸åˆ é™¤ã€ä¸€ä¸ªå‰¯æœ¬é›†(è¡¨ç¤ºæ²¡å‰¯æœ¬)ã€ä¸ƒå¤©è¿›è¡Œä¸€æ¬¡åˆ†ç‰‡</p>
<h3 id="schema-æ¨¡å¼"><a href="#schema-æ¨¡å¼" class="headerlink" title="schema æ¨¡å¼"></a>schema æ¨¡å¼</h3><p>å¦‚ä½•ç»„ç»‡æ•°æ®åˆ°influxdbã€‚åŒ…å«databasesã€retention policiesã€seriesã€measurementsã€tag keysã€tag valuesã€field keys</p>
<h3 id="selector-é€‰æ‹©å™¨"><a href="#selector-é€‰æ‹©å™¨" class="headerlink" title="selector é€‰æ‹©å™¨"></a>selector é€‰æ‹©å™¨</h3><p>ä¸€ä¸ªå‡½æ•°ï¼Œä»ç‰¹å®šèŒƒå›´çš„pointä¸­è¿”å›å•ä¸ª</p>
<ul>
<li>bottom è¿”å›Nä¸ªæœ€å°çš„field value</li>
<li>first  è¿”å›æœ€å¼€å§‹æ—¶é—´çš„field value</li>
<li>last  è¿”å›æœ€è¿‘æ—¶é—´çš„field value</li>
<li>max  è¿”å›æœ€å¤§çš„field value</li>
<li>min  è¿”å›æœ€å°çš„field value</li>
<li>percentile æ ¹æ®ç™¾åˆ†æ¯”è¿”å›</li>
<li>sample  éšæœºè¿”å›</li>
<li>top  è¿”å›æœ€å¤§çš„Nä¸ªfield value</li>
</ul>
<h3 id="series-åºåˆ—"><a href="#series-åºåˆ—" class="headerlink" title="series åºåˆ—"></a>series åºåˆ—</h3><p>ç”±measurementã€tag setã€retention policyç»„æˆ(<code>æ³¨æ„:field setä¸åœ¨é‡Œé¢</code>)</p>
<h3 id="series-cardinality-åºåˆ—åŸºæ•°"><a href="#series-cardinality-åºåˆ—åŸºæ•°" class="headerlink" title="series cardinality åºåˆ—åŸºæ•°"></a>series cardinality åºåˆ—åŸºæ•°</h3><p>å”¯ä¸€çš„seriesæ•°ï¼Œå¦‚æœä¸€ä¸ªmeasurementæœ‰2ä¸ªtag keyã€‚1ä¸ªæœ‰ä¸‰ä¸ªå”¯ä¸€çš„å€¼ã€‚å¦ä¸€ä¸ªæœ‰ä¸¤ä¸ªã€‚é‚£ä¹ˆåºåˆ—åŸºæ•°ä¸º6.å› ä¸ºtagé›†åˆæ˜¯ä¿å­˜åœ¨å†…å­˜ä¸­çš„ã€‚åœ¨é…ç½®é‡Œé¢ä¹Ÿæœ‰é»˜è®¤çš„æ•°é‡é™åˆ¶</p>
<h3 id="server-æœåŠ¡å™¨"><a href="#server-æœåŠ¡å™¨" class="headerlink" title="server æœåŠ¡å™¨"></a>server æœåŠ¡å™¨</h3><p>è¿è¡Œinfluxdbçš„ç¯å¢ƒã€‚åº”è¯¥ä¸€å°æœåŠ¡å™¨åªè¿è¡Œä¸€ä¸ªinfluxdbè¿›ç¨‹</p>
<h3 id="shard-åˆ†ç‰‡"><a href="#shard-åˆ†ç‰‡" class="headerlink" title="shard åˆ†ç‰‡"></a>shard åˆ†ç‰‡</h3><p>åŒ…å«ç¼–ç å’Œå‹ç¼©æ•°æ®ï¼Œä½œä¸ºTSMæ–‡ä»¶ä¿å­˜åˆ°ç£ç›˜ã€‚æ¯ä¸ªåˆ†ç‰‡å±äºå”¯ä¸€çš„ä¸€ä¸ªshard groupã€‚æ¯ä¸ªåˆ†ç‰‡åŒ…å«äº†ç‰¹å®šçš„series</p>
<h3 id="shard-duration-åˆ†ç‰‡æŒç»­æ—¶é—´"><a href="#shard-duration-åˆ†ç‰‡æŒç»­æ—¶é—´" class="headerlink" title="shard duration åˆ†ç‰‡æŒç»­æ—¶é—´"></a>shard duration åˆ†ç‰‡æŒç»­æ—¶é—´</h3><p>ç”±ä¿ç•™ç­–ç•¥ä¸­çš„shard durationå†³å®šã€‚</p>
<h3 id="shard-group-åˆ†ç‰‡ç»„"><a href="#shard-group-åˆ†ç‰‡ç»„" class="headerlink" title="shard group åˆ†ç‰‡ç»„"></a>shard group åˆ†ç‰‡ç»„</h3><p>åˆ†ç‰‡ç»„(ä¿ç•™ç­–ç•¥)-&gt;shard-&gt;data.ä¸ºäº†è‡ªåŠ¨åˆ é™¤æå‡ºäº†è¿™ä¹ˆå¤šæ¦‚å¿µâ”‘(ï¿£Ğ” ï¿£)â”</p>
<h3 id="subscription-è®¢é˜…"><a href="#subscription-è®¢é˜…" class="headerlink" title="subscription è®¢é˜…"></a>subscription è®¢é˜…</h3><p>O__O â€œâ€¦ å¥½åƒå¹¶æ²¡æœ‰ä»€ä¹ˆç”¨ã€‚æ­é…kapactiorä½¿ç”¨ã€‚è®¢é˜…å®ƒçš„æ•°æ®è¿›è¡Œå­˜å‚¨</p>
<h3 id="tag"><a href="#tag" class="headerlink" title="tag"></a>tag</h3><p>å¯¹æ¯”fieldã€‚tagæ˜¯æœ‰ç´¢å¼•çš„</p>
<h3 id="tag-key"><a href="#tag-key" class="headerlink" title="tag key"></a>tag key</h3><p>ç•¥</p>
<h3 id="tag-set"><a href="#tag-set" class="headerlink" title="tag set"></a>tag set</h3><p>ç•¥</p>
<h3 id="tag-value"><a href="#tag-value" class="headerlink" title="tag value"></a>tag value</h3><p>åªèƒ½ä¸ºæ•°å­—ã€‚å­˜å‚¨åˆ°metadata</p>
<h3 id="timestamp-æ—¶é—´æˆ³"><a href="#timestamp-æ—¶é—´æˆ³" class="headerlink" title="timestamp æ—¶é—´æˆ³"></a>timestamp æ—¶é—´æˆ³</h3><p>å’Œpointå…³è”çš„æ—¶é—´æˆ³ï¼Œå¯ä»¥æœ‰å¤šç§æ—¶é—´æ ¼å¼å­˜å‚¨å’ŒæŸ¥è¯¢</p>
<h3 id="transformation-å˜æ¢"><a href="#transformation-å˜æ¢" class="headerlink" title="transformation å˜æ¢"></a>transformation å˜æ¢</h3><p>ç‰¹å®šçš„ç‚¹è¿”å›å€¼å’Œé›†åˆï¼Œå¾—åˆ°çš„ç»“æœä¸èƒ½ç”¨æ¥å†æ¬¡èšåˆ</p>
<ul>
<li>ceiling ç›®å‰è¿˜ä¸æ”¯æŒ(ceil,floor)</li>
<li>cumulative_sum å°†åˆ—è¡¨å˜æˆç´¯åŠ å’Œåˆ—è¡¨(åŸæœ‰1,1,2,2å˜æˆ1,2,4,6)  </li>
<li>derivative å¯¼æ•°</li>
<li>difference å’Œç¬¬ä¸€ä¸ªç»“æœç›¸å‡å¾—åˆ°ä¸åŒ</li>
<li>elapsed  å¾—åˆ°æ—¶é—´æˆ³çš„ä¸åŒ</li>
<li>floor  ç›®å‰è¿˜ä¸æ”¯æŒ</li>
<li>histogram ç›®å‰è¿˜ä¸æ”¯æŒ</li>
<li>moving_average æ»šåŠ¨å¹³å‡å€¼(åŸæœ‰1,2,3å¾—åˆ°1.5,2.5)</li>
<li>non_negative_derivative éè´Ÿå¯¼æ•°</li>
<li>non_negative_difference éè´Ÿä¸åŒ</li>
</ul>
<h3 id="tsm-Time-Structured-Merge-tree"><a href="#tsm-Time-Structured-Merge-tree" class="headerlink" title="tsm(Time Structured Merge tree)"></a>tsm(Time Structured Merge tree)</h3><p>influxdbçš„ä¸“ç”¨å­˜å‚¨æ ¼å¼ã€‚å…è®¸é«˜å‹ç¼©å’Œé«˜é€Ÿå†™å…¥è¯»å–é€Ÿåº¦è¦é«˜äºå·²å­˜åœ¨çš„B+æ ‘æˆ–è€…LSMæ ‘</p>
<h3 id="user"><a href="#user" class="headerlink" title="user"></a>user</h3><ul>
<li>adminç”¨æˆ·å…·æœ‰è¯»å†™æ‰€æœ‰æ•°æ®åº“çš„æƒé™å¹¶ä¸”å¯ä»¥ç®¡ç†ç”¨æˆ·</li>
<li>éadminæœ‰æ¯ä¸ªæ•°æ®åº“çš„è¯»å†™æƒé™(è¢«adminåˆ†é…)</li>
</ul>
<h3 id="value-per-second"><a href="#value-per-second" class="headerlink" title="value per second"></a>value per second</h3><p>åº¦é‡å†™å…¥é€Ÿåº¦,æ¯”å¦‚æ¯ä¸ªpointæœ‰å››ä¸ªfield,æ¯æ‰¹æœ‰5000ä¸ªpoint.å†™å…¥é€Ÿåº¦ä¸ºæ¯ç§’10ä¸ªã€‚é‚£ä¹ˆvalues per secondé€Ÿç‡ä¸º<code>4*5000*10</code></p>
<h3 id="WAL-write-ahead-log-é¢„å†™æ—¥å¿—"><a href="#WAL-write-ahead-log-é¢„å†™æ—¥å¿—" class="headerlink" title="WAL(write ahead log) é¢„å†™æ—¥å¿—"></a>WAL(write ahead log) é¢„å†™æ—¥å¿—</h3><p>ç•¥</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»¥ä¸‹å†…å®¹åŸºæœ¬å…¨ç¯‡æ‘˜æŠ„è‡ªv1.3çš„å®˜æ–¹æ–‡æ¡£,å…ˆä»ç†è§£ä¸‹é¢è¿™å¼ ä¸¤å¼ å›¾å¼€å§‹&lt;br&gt;&lt;img src=&quot;https://ficapy.b0.upaiyun.com/capture/influxdb_glossary.jpg&quot; alt=&quot;influxdb_glossary&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://ficapy.b0.upaiyun.com/capture/influxdb_field.jpg&quot; alt=&quot;influxdb&quot;&gt;&lt;br&gt;
    
    </summary>
    
      <category term="database" scheme="https://www.zoulei.net/categories/database/"/>
    
    
  </entry>
  
  <entry>
    <title>Elasticsearchç¬”è®°</title>
    <link href="https://www.zoulei.net/2017/12/07/ELK/"/>
    <id>https://www.zoulei.net/2017/12/07/ELK/</id>
    <published>2017-12-07T01:18:08.000Z</published>
    <updated>2017-12-07T01:34:28.783Z</updated>
    
    <content type="html"><![CDATA[<p>ä»¥ä¸‹æ˜¯çœ‹<a href="https://www.udemy.com/complete-elasticsearch-masterclass-with-kibana-and-logstash/">udemyçš„Elasticsearchå…¥é—¨æ•™ç¨‹</a>åšçš„ç®€çŸ­ç¬”è®°</p>
<a id="more"></a>
<ol>
<li><p>åŸºç¡€çŸ¥è¯†ã€ä¸‹è½½ã€é…ç½®(1-3)</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">brew cask install java</div><div class="line">ä¸‹è½½elasticsearchã€kibana</div><div class="line">config/kibana é…ç½®æ–‡ä»¶</div><div class="line">bin/elasticsearch   (9200)</div><div class="line">bin/kibana  å¯åŠ¨(5601ç«¯å£)</div></pre></td></tr></table></figure>
<p> Elasticsearch is Document Oriented</p>
<ul>
<li>insert Documents</li>
<li>Delete Documents</li>
<li>Retrieve Documents</li>
<li>Analyze Documents</li>
<li><p>Search Documents</p>
<h4 id="inverted-index"><a href="#inverted-index" class="headerlink" title="inverted index"></a>inverted index</h4><h4 id="JSONå¯¹è±¡-ç»å…¸æ•°æ®åº“çš„Tableæ¨¡å‹è½¬å˜ä¸ºJSONæ¨¡å‹"><a href="#JSONå¯¹è±¡-ç»å…¸æ•°æ®åº“çš„Tableæ¨¡å‹è½¬å˜ä¸ºJSONæ¨¡å‹" class="headerlink" title="JSONå¯¹è±¡(ç»å…¸æ•°æ®åº“çš„Tableæ¨¡å‹è½¬å˜ä¸ºJSONæ¨¡å‹)"></a>JSONå¯¹è±¡(ç»å…¸æ•°æ®åº“çš„Tableæ¨¡å‹è½¬å˜ä¸ºJSONæ¨¡å‹)</h4><p>ElasticSearch | Relational DB<br>â€” | â€”<br>Field   | Column<br>Document    | Row<br>Type    |   Table<br>Index   |   Database</p>
</li>
</ul>
</li>
<li><p>æ•°æ®å­˜å‚¨å¼•æ“ã€åˆ†å¸ƒå¼å·¥ä½œå¼•æ“é›†ç¾¤ï¼Œshard(4-7)</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">PUT /&#123;index&#125;/&#123;type&#125;/&#123;id&#125;</div><div class="line">&#123;</div><div class="line">    &quot;field1&quot;: &quot;value1&quot;,</div><div class="line">    &quot;field2&quot;: &quot;value2&quot;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line">ç›¸åŒçš„idæ’å…¥ä¼šç”Ÿæˆä¸åŒçš„ç‰ˆæœ¬å·</div><div class="line">æ›´æ–°æ•°æ®çš„åŸç†æ˜¯è¯»å–æ•°æ®åˆå¹¶å†put.åªæ”¯æŒrowçº§åˆ«ï¼Œä¸æ”¯æŒå­—æ®µçº§åˆ«</div><div class="line">DELETE /vehicles/car/123</div><div class="line">&#123;</div><div class="line">    &quot;_index&quot;: &quot;vehicles&quot;,</div><div class="line">    &quot;_type&quot;: &quot;car&quot;,</div><div class="line">    &quot;_id&quot;: &quot;123&quot;,</div><div class="line">    &quot;_version&quot;: 13,</div><div class="line">    &quot;result&quot;: &quot;deleted&quot;,</div><div class="line">    &quot;_shards&quot;: &#123;</div><div class="line">        &quot;total&quot;: 2,</div><div class="line">        &quot;successful&quot;: 1,</div><div class="line">        &quot;failed&quot;: 0</div><div class="line">    &#125;,</div><div class="line">    &quot;_seq_no&quot;: 12,</div><div class="line">    &quot;_primary_term&quot;: 1</div><div class="line">&#125;</div><div class="line">å³ä½¿åˆ é™¤åŒæ ·ä¹Ÿä¸ä¼šçœŸçš„åˆ é™¤æ•°æ®åªä¼šè¿›è¡Œæ ‡è®°ã€‚ç£ç›˜ç©ºé—´ä¸ä¼šç«‹å³é‡Šæ”¾</div></pre></td></tr></table></figure>
<p> mappings and settings.mappingsç±»ä¼¼ä¸æ•°æ®åº“ä¸­çš„schema</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&quot;settings&quot;: &#123;</div><div class="line">  &quot;index&quot;: &#123;</div><div class="line">    &quot;creation_date&quot;: &quot;1512370059209&quot;,</div><div class="line">    &quot;number_of_shards&quot;: &quot;5&quot;,</div><div class="line">    &quot;number_of_replicas&quot;: &quot;1&quot;,</div><div class="line">    &quot;uuid&quot;: &quot;Obppoj9yT4eQg5oq6Zv5IA&quot;,</div><div class="line">    &quot;version&quot;: &#123;</div><div class="line">      &quot;created&quot;: &quot;6000099&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;provided_name&quot;: &quot;vehicles&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> <code>GET business/_search</code></p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">GET business/building/_search</div><div class="line">&#123;</div><div class="line">    &quot;query&quot;:&#123;</div><div class="line">        &quot;term&quot;:&#123;&quot;address&quot;:&quot;pen&quot;&#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">PUTæ•°æ®åç»è¿‡åˆ†æè¿›è¡Œåˆ†è¯å†™å…¥å†…å­˜ã€‚åˆ°è¾¾ä¸€å®šæ•°é‡åæŒä¹…åŒ–å†™å…¥ç£ç›˜ã€‚ç»„æˆsegmentã€‚ä¸”ä¸å¯å˜</div><div class="line">tokenization -&gt; filter</div><div class="line">1. Remove Stop Words</div><div class="line">2. Lowercasing</div><div class="line">3. Stemming</div><div class="line">4. Synonyms</div></pre></td></tr></table></figure>
<p> Token | Exists in<br> â€” | â€”<br> token   |   1</p>
<p> <img src="https://ficapy.b0.upaiyun.com/capture/elasticsearch_analyzer.jpeg" alt="elasticsearch_analyzer"></p>
</li>
</ol>
<ol>
<li><p>inverted index(8-9)</p>
<p> Data Types for Document Fields</p>
<p> String Fields: text,keyword<br> Numeric Fields: long,integer,short,byte,double,float<br> Date Fields: text,keyword<br> True/False Fields: boolean<br> Binary Fields: binary</p>
<p> - æ³¨æ„ã€‚å’Œæ•™ç¨‹ä¸ä¸€è‡´äº†ã€‚æ•™ç¨‹ä½¿ç”¨çš„5ç‰ˆæœ¬ï¼Œæ–°ç‰ˆæœ¬6è¿›è¡Œäº†ç ´åæ€§å‡çº§ã€‚ä»¥å‰index/type/documentsçš„æ¦‚å¿µåç»­ä¼šå»æ‰typeã€‚åœ¨6é‡Œé¢å•ä¸ªindexé‡Œé¢æ— æ³•å­˜å‚¨å¤šä¸ªtypeã€‚æ•…ä¹Ÿæ— æ³•è®¾ç½®å¤šä¸ªmapping</p>
<ul>
<li>å…³é—­å†™å…¥å†…å®¹æ—¶è‡ªåŠ¨ç”Ÿæˆmappings(dynamic:false/strict)</li>
<li><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-analyzers.html">å„ç§analyzeræµ‹è¯•</a></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">POST _analyze</div><div class="line">&#123;</div><div class="line">&quot;analyzer&quot;: &quot;simple&quot;,</div><div class="line">&quot;text&quot;: &quot;The 2 QUICK Brown-Foxes jumped over the lazy dog&apos;s bone.&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<ol>
<li><p>search DSL (10-14)</p>
<ul>
<li>Domain Specific Language</li>
<li><p>Query Context &amp; Filter Context</p>
<ol>
<li><p>Query</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">match_all</div><div class="line">&quot;match&quot;: &#123;&quot;name&quot;: &quot;computer&quot;&#125; </div><div class="line">è¿™æŸ¥è¯¢è¯­æ³•ç®€ç›´è®©äººæœ‰ç§ç”Ÿä¸å¦‚æ­»çš„æ„Ÿè§‰</div><div class="line">GET /courses/_search</div><div class="line">&#123;</div><div class="line">&quot;query&quot;: &#123;</div><div class="line">    &quot;bool&quot;: &#123;</div><div class="line">    &quot;must&quot;: [&#123;&quot;match&quot;: &#123;&quot;room&quot;: &quot;c8&quot;&#125;&#125;,</div><div class="line">        &#123;&quot;match&quot;: &#123;&quot;name&quot;: &quot;computer&quot;&#125;&#125;]</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">must/must_not/should/minimun_should_match</div><div class="line">multi_match/match_phrase /match_phrase_prefix</div><div class="line">range</div></pre></td></tr></table></figure>
</li>
<li><p>Filter</p>
<ul>
<li>ä¸èƒ½å•ç‹¬ä½¿ç”¨</li>
<li>ä¸è¿›è¡Œè¯„åˆ†</li>
<li>ElasticSearchä¼šå¯¹ç»“æœè¿›è¡Œç¼“å­˜</li>
<li>å¯ä»¥å…ˆå¸¸è§„æŸ¥è¯¢å¾—åˆ°è¯„åˆ†ã€‚å†ä½¿ç”¨filterå¯¹ç»“æœè¿‡æ»¤</li>
</ul>
</li>
<li><p>Aggregation</p>
<ul>
<li>endpoint-&gt;_search/_count</li>
<li>bulk indexing</li>
<li>terms:fieldç±»ä¼¼ä¸groupã€aggsæ¥èšåˆã€avgã€maxã€minå‡½æ•°(å¦‚æœéœ€è¦æ ¹æ®èšåˆçš„ç»“æœæ¥æ’åºæ€ä¹ˆåŠ)</li>
<li>å…ˆæ‰§è¡Œqueryã€‚åé¢æ ¹æ®ç»“æœè¿›è¡Œèšåˆ</li>
<li>stats(minã€maxã€avgã€sum)</li>
<li>bucketå’Œmetricçš„æ¦‚å¿µã€‚range  <ul>
<li>å¯¹äºgroup byå¾—åˆ°çš„ç»“æœå†æ¬¡ä½¿ç”¨range(fromã€to)è¿›è¡ŒäºŒæ¬¡åˆ†ç»„ã€‚åˆ†ç»„åå¯ä»¥åµŒå¥—ä½¿ç”¨aggèšåˆ</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
<li><p>logstash and kibana (15-17)</p>
<ol>
<li><p>logstash</p>
<ul>
<li>inputã€filterã€output(rubyè¯­æ³•)</li>
</ul>
</li>
<li><p>Kibana</p>
<ul>
<li>kibanaéœ€è¦å…ˆè®¾ç½®é»˜è®¤index</li>
<li>Visualizeæ–°å»ºå•ä¸ªè§†å›¾ã€Dashboardç»„åˆå®ƒä»¬</li>
</ul>
</li>
</ol>
</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»¥ä¸‹æ˜¯çœ‹&lt;a href=&quot;https://www.udemy.com/complete-elasticsearch-masterclass-with-kibana-and-logstash/&quot;&gt;udemyçš„Elasticsearchå…¥é—¨æ•™ç¨‹&lt;/a&gt;åšçš„ç®€çŸ­ç¬”è®°&lt;/p&gt;
    
    </summary>
    
      <category term="database" scheme="https://www.zoulei.net/categories/database/"/>
    
    
  </entry>
  
  <entry>
    <title>influxdbé…ç½®æ–‡ä»¶</title>
    <link href="https://www.zoulei.net/2017/12/01/influxdb_config/"/>
    <id>https://www.zoulei.net/2017/12/01/influxdb_config/</id>
    <published>2017-12-01T14:38:46.000Z</published>
    <updated>2017-12-08T23:59:26.538Z</updated>
    
    <content type="html"><![CDATA[<p>å¼€å§‹ä¸€ä¸ªè½¯ä»¶,ä»è¯»æ‡‚å®ƒçš„é…ç½®æ–‡ä»¶å¼€å§‹ã€‚ä»¥ä¸‹æ˜¯è¯»å–<a href="https://docs.influxdata.com/influxdb/v1.3/administration/config/">3.1é…ç½®æ–‡æ¡£</a>çš„ç¬”è®°<br>æ€»ç»“æ¥è¯´ï¼Œinfluxdbçš„é…ç½®æ–‡ä»¶å¯é…ç½®çš„åœ°æ–¹å‡ ä¹æ²¡æœ‰ã€‚å‚æ•°æ€§èƒ½è°ƒä¼˜è²Œä¼¼ä¸å­˜åœ¨ï¼Œå…¶ä¸­æ˜¯å¦å¼€å¯ï¼Œæ˜¯å¦è®°å½•æ—¥å¿—éƒ½å æ®äº†å¥½å¤šéƒ¨åˆ†ã€‚é¢å¤–éœ€è¦å…³æ³¨çš„æ˜¯dataç« èŠ‚æœ‰ä¸€äº›å…³äºfsyncçš„è®¾ç½®é»˜è®¤æ˜¯0ï¼Œè¿˜æœ‰é»˜è®¤çš„max-series-per-databaseå’Œmax-value-per-tagé»˜è®¤éƒ½å­˜åœ¨é™åˆ¶ã€‚æš‚æ—¶ä¸å¤ªæ¸…æ¥šåŸç†æ˜¯ä»€ä¹ˆ(æ›´æ–°:å› ä¸ºinfluxdbæœ€å¤§çš„è½¯è‚‹å°±åœ¨seriesçš„æ•°é‡ä¸Šã€‚tagçš„æ•°æ®éƒ½ä¿å­˜åœ¨å†…å­˜ã€‚æ‰€ä»¥æœ‰æå¤§çš„é™åˆ¶ã€‚å¯ä»¥çœ‹åˆ°<a href="https://docs.influxdata.com/influxdb/v1.3/guides/hardware_sizing/#general-hardware-guidelines-for-a-cluster">å®˜æ–¹ç¡¬ä»¶è¦æ±‚</a>,100ä¸‡çš„serieséœ€è¦4-6æ ¸å¿ƒCPU,8-32GBå†…å­˜ï¼Œiopsè¦æ±‚1000+ã€‚å¯¹æ¯”ä¸€ä¸‹influxdbæä¾›çš„<a href="https://cloud.influxdata.com/plan-picker">äº‘æœåŠ¡</a>ï¼Œ100ä¸‡çš„serieséœ€è¦æ¯æœˆ1500åˆ€!!!)ã€‚å½“ä¿å­˜å¤§é‡æ•°æ®çš„æ—¶å€™è‚¯å®šä¼šæŠ¥é”™,å¦å¤–é»˜è®¤çš„æ…¢æŸ¥è¯¢æ—¥å¿—æ˜¯æ²¡æœ‰æ‰“å¼€çš„ã€‚å¯¹äºè¯·æ±‚ã€‚é»˜è®¤æ²¡æœ‰é™åˆ¶æœ€å¤§çš„è¿”å›å†…å®¹æ•°ã€‚ä»¥åŠé™åˆ¶å•ä¸ªæŸ¥è¯¢å“åº”çš„æ—¶é—´</p>
<a id="more"></a>
<h1 id="ä½¿ç”¨é…ç½®æ–‡ä»¶"><a href="#ä½¿ç”¨é…ç½®æ–‡ä»¶" class="headerlink" title="ä½¿ç”¨é…ç½®æ–‡ä»¶"></a>ä½¿ç”¨é…ç½®æ–‡ä»¶</h1><ul>
<li>ä½¿ç”¨<code>influxd config</code>æŸ¥çœ‹é»˜è®¤çš„é…ç½®</li>
<li>ä½¿ç”¨<code>influxd -config config_path</code>æˆ–è€…<code>INFLUXDB_CONFIG_PATH</code>å¯åŠ¨</li>
</ul>
<h2 id="ç¯å¢ƒå˜é‡"><a href="#ç¯å¢ƒå˜é‡" class="headerlink" title="ç¯å¢ƒå˜é‡"></a>ç¯å¢ƒå˜é‡</h2><p>é…ç½®ä¼˜å…ˆçº§ä¸º: ç¯å¢ƒå˜é‡ &gt; æ–‡ä»¶é…ç½® &gt; é»˜è®¤è®¾ç½®</p>
<h2 id="å…¨å±€é€‰é¡¹"><a href="#å…¨å±€é€‰é¡¹" class="headerlink" title="å…¨å±€é€‰é¡¹"></a>å…¨å±€é€‰é¡¹</h2><ol>
<li>reporting-disabled  å‘é€æ•°æ®ç»Ÿè®¡ç»™influxdb</li>
<li>bind-address        ç»‘å®šç›‘å¬åœ°å€(RPC)</li>
<li>GOMAXPROCS          æœ€å¤§è¿›ç¨‹æ•°</li>
</ol>
<h2 id="meta"><a href="#meta" class="headerlink" title="[meta]"></a>[meta]</h2><ol>
<li>dir   metaæ•°æ®ä¿å­˜åœ°å€(ä¸€èˆ¬è®¾ç½®ä¸€ä¸ªbase_dir)</li>
<li>retention-autocreate è‡ªåŠ¨åˆ›å»ºä¿ç•™ç­–ç•¥ã€‚é»˜è®¤æ°¸ä¹…ä¿ç•™</li>
<li>logging-enabled  å¼€å¯metaæ—¥å¿—è®°å½•</li>
</ol>
<h2 id="data"><a href="#data" class="headerlink" title="[data]"></a>[data]</h2><ol>
<li>dir  æ•°æ®ä¿å­˜åœ°å€</li>
<li>index-version å†³å®šåˆ†ç‰‡ç´¢å¼•ä¿å­˜å†…å­˜è¿˜æ˜¯ç£ç›˜</li>
<li>wal-dir  é¢„å†™æ—¥å¿—ä¿å­˜åœ°å€</li>
<li>wal-fsync-delay  é¢„å†™æ—¥å¿—åˆ·æ–°å»¶è¿Ÿ(éssdç£ç›˜å»ºè®®0-100ms)</li>
<li>trace-logging-enabled TSMå¼•æ“å’ŒWALæ—¥å¿—</li>
<li>query-log-enabled   æ˜¯å¦è®°å½•æŸ¥è¯¢æ—¥å¿—</li>
<li>cache-max-memory-size    æœ€å¤§ç¼“å­˜å®¹é‡,å æ»¡ä¼šæ‹’ç»å†™å…¥</li>
<li>cache-snapshot-memory-size ç¼“å­˜å¿«ç…§å¤§å°ã€‚æ»¡åä¼šå°†å†…å­˜å†…å®¹å†™å…¥åˆ°TSMæ–‡ä»¶</li>
<li>cache-snapshot-write-cold-duration å¦‚æœä¸€ä¸ªåˆ†ç‰‡æ²¡æœ‰è¢«å†™å…¥æˆ–è€…åˆ é™¤ä¼šè¢«å†™å…¥åˆ°TSMæ–‡ä»¶çš„æ—¶é—´</li>
<li>compact-full-write-cold-duration åŒä¸Šï¼Œæ²¡æœ‰å†™å…¥æˆ–è€…åˆ é™¤çš„å‹ç¼©æ—¶é—´</li>
<li>max-concurrent-compactions  å¹¶å‘å‹ç¼©è¿›ç¨‹æ•°</li>
<li>max-series-per-database   æ¯ä¸ªæ•°æ®åº“æœ€å¤§çš„seriesæ•°é‡ã€‚è¶…è¿‡ä¼š500é”™è¯¯ã€‚0è¡¨ç¤ºæ— é™åˆ¶(ä¸ºä»€ä¹ˆéœ€è¦é™åˆ¶å‘¢ï¼Ÿ)</li>
<li>max-values-per-tag æ¯ä¸ªtagç´¢å¼•çš„å€¼ä¸ªæ•°(åŒç–‘é—®ä¸ºä»€ä¹ˆé™åˆ¶ä¸ºåä¸‡)</li>
</ol>
<h2 id="coordinator"><a href="#coordinator" class="headerlink" title="[coordinator]"></a>[coordinator]</h2><ol>
<li>write-timeout    å†™å…¥è¶…æ—¶æ—¶é—´10ç§’</li>
<li>max-concurrent-queries  æœ€å¤§å¹¶å‘æŸ¥è¯¢æ•°é»˜è®¤æ— é™åˆ¶</li>
<li>query-timeout   æŸ¥è¯¢è¶…æ—¶æ—¶é—´é»˜è®¤æ— é™åˆ¶</li>
<li>log-queries-after æ…¢æŸ¥è¯¢æ£€æµ‹ã€‚ä¸ºæ…¢æŸ¥è¯¢åˆ™è®°å½•æ—¥å¿—</li>
<li>max-select-point æœ€å¤§çš„pointsæ•°é‡ã€‚é»˜è®¤æ— é™åˆ¶</li>
<li>max-select-series  æœ€å¤§çš„seriesæ•°é‡ã€‚é»˜è®¤æ— é™åˆ¶</li>
<li>max-select-buckets   æœ€å¤§çš„GROUP BY time()æ•°é‡ã€‚é»˜è®¤æ— é™åˆ¶</li>
</ol>
<h2 id="retention"><a href="#retention" class="headerlink" title="[retention]"></a>[retention]</h2><ol>
<li>enable  è®¾ç½®ä¸ºfalseåˆ™ç¦æ­¢åˆ é™¤æ•°æ®</li>
<li>check-interval  æ£€æŸ¥å‘¨æœŸé»˜è®¤ä¸‰ååˆ†é’Ÿ</li>
</ol>
<h2 id="shard-precreation"><a href="#shard-precreation" class="headerlink" title="[shard-precreation]"></a>[shard-precreation]</h2><ol>
<li>enable å¼€å¯æ•°æ®åˆ°è¾¾å‰å…ˆåˆ›å»ºshard</li>
<li>check-interval  æ£€æŸ¥å‘¨æœŸ</li>
<li>advance-period  é¢„åˆ›å»ºshardçš„æœ€å¤§æ—¶é—´</li>
</ol>
<h2 id="admin"><a href="#admin" class="headerlink" title="[admin]"></a>[admin]</h2><p>å®˜æ–¹å®Œå…¨åºŸå¼ƒï¼Œä¸å¯ç”¨ã€‚ç”±xxæ›¿ä»£(æ³¨:è¿˜æ˜¯ç”¨grafanaå§)</p>
<h2 id="monitor"><a href="#monitor" class="headerlink" title="[monitor]"></a>[monitor]</h2><p>ç³»ç»Ÿè‡ªèº«ç›‘æ§ã€‚é»˜è®¤æ•°æ®ä¼šä¿å­˜åˆ°_internalæ•°æ®åº“</p>
<ol>
<li>store-enabled  æ˜¯å¦å­˜å‚¨ç›‘æ§ä¿¡æ¯</li>
<li>store-database ä¿å­˜æ•°æ®åº“çš„åç§°</li>
<li>store-interval  è®°å½•é—´éš”ã€‚é»˜è®¤åç§’</li>
</ol>
<h2 id="subscriber"><a href="#subscriber" class="headerlink" title="[subscriber]"></a>[subscriber]</h2><p>è¿™ä¸ªéƒ¨åˆ†æ˜¯æ§åˆ¶Kapacitorå¦‚ä½•æ¥æ”¶æ•°æ®ã€‚åº”è¯¥æ²¡ä»€ä¹ˆç”¨å¤„</p>
<ol>
<li>enabled</li>
<li>http-timeout</li>
<li>insecure-skip-verify</li>
<li>ca-certs</li>
<li>write-concurrency</li>
<li>write-buffer-size</li>
</ol>
<h2 id="http"><a href="#http" class="headerlink" title="[http]"></a>[http]</h2><p>é™¤äº†RPCè°ƒç”¨ã€‚å°±æ˜¯RESTFULæ–¹å¼çš„apiè¯»å†™äº†</p>
<ol>
<li>enable  æ˜¯å¦æ‰“å¼€</li>
<li>bind-address ç»‘å®šåœ°å€</li>
<li>auth-enabled æ‰“å¼€éªŒè¯</li>
<li>realm  JWTéªŒè¯ç›¸å…³</li>
<li>log-enabled è®°å½•æ—¥å¿—</li>
<li>write-tracing åº”è¯¥æ˜¯è°ƒè¯•ä½¿ç”¨ã€‚ä¼šè®°å½•å†™å…¥çš„payload</li>
<li>pprof-enabled å¼€å¯æ€§èƒ½è®°å½•</li>
<li>https-enabled  å¼€å¯https</li>
<li>https-certificate httpsè¯ä¹¦</li>
<li>https-private-key  httpsç§é’¥</li>
<li>shared-secret  ç”¨äºJWTçš„ç­¾åã€‚æƒ³æƒ³å•æœºåº”è¯¥æ˜¯ç”¨ä¸åˆ°çš„</li>
<li>max-row-limit  æœ€å¤§å•æ¬¡å¯ä»¥ä¸Šä¼ çš„pointï¼Œé»˜è®¤æ— é™åˆ¶</li>
<li>max-connection-limit æœ€å¤§å¯è¿æ¥æ•°ï¼Œé»˜è®¤æ— é™åˆ¶</li>
<li>unix-socket-enabled  å¼€å¯unixåŸŸè¿æ¥</li>
<li>bind-socket  ç»‘å®šsocketåŸŸ</li>
<li>max-body-size  æœ€å¤§bodyé•¿åº¦,é»˜è®¤25MBï¼Œè¶…è¿‡å¤§å°è¿”å›http413è¯·æ±‚å®ä½“è¿‡å¤§é”™è¯¯</li>
</ol>
<h2 id="graphite"><a href="#graphite" class="headerlink" title="[[graphite]]"></a>[[graphite]]</h2><p>(service plugin)è®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ªgraphiteæ•°æ®ç›‘å¬å™¨</p>
<ol>
<li>enabled å¯ç”¨graphite</li>
<li>database   æ•°æ®åº“åç§°</li>
<li>retention-policy ä¿ç•™ç­–ç•¥</li>
<li>bind-address  ç»‘å®šåœ°å€</li>
<li>protocol     åè®®tcpæˆ–udp</li>
<li>consistency-level   ä¸€è‡´æ€§çº§åˆ«</li>
<li>batch-size</li>
<li>batch-pending</li>
<li>batch-timeout</li>
<li>udp-read-buffer</li>
<li>separator</li>
</ol>
<h2 id="collectd"><a href="#collectd" class="headerlink" title="[[collectd]]"></a>[[collectd]]</h2><p>(service plugin)åŒä¸Šï¼Œè®¾ç½®ç›‘å¬collectdæ•°æ®</p>
<ol>
<li>enabled</li>
<li>bind-address</li>
<li>database</li>
<li>retention-policy</li>
<li>typesdb</li>
<li>security-level</li>
<li>auth-file</li>
<li>batch-size</li>
<li>batch-pending</li>
<li>batch-timeout</li>
<li>read-buffer</li>
</ol>
<h2 id="opentsdb"><a href="#opentsdb" class="headerlink" title="[[opentsdb]]"></a>[[opentsdb]]</h2><p>(service plugin)åŒä¸Šï¼Œè®¾ç½®ç›‘å¬opentsdbæ•°æ®</p>
<ol>
<li>enabled</li>
<li>bind-address</li>
<li>database</li>
<li>retention-policy</li>
<li>consistency-level</li>
<li>tls-enabled</li>
<li>certificate</li>
<li>log-point-errors</li>
<li>batch-size</li>
<li>batch-pending</li>
<li>batch-timeout</li>
</ol>
<h2 id="udp"><a href="#udp" class="headerlink" title="[[udp]]"></a>[[udp]]</h2><p>(service plugin)é™¤äº†RPCã€HTTPã€é™„å¸¦UDP</p>
<ol>
<li>enabled</li>
<li>bind-address</li>
<li>database</li>
<li>retention-policy</li>
<li>batch-size</li>
<li>batch-pending</li>
<li>batch-timeout</li>
<li>read-buffer</li>
<li>precision</li>
</ol>
<h1 id="continuous-queries"><a href="#continuous-queries" class="headerlink" title="[continuous_queries]"></a>[continuous_queries]</h1><p>æŒç»­æŸ¥è¯¢</p>
<ol>
<li>enabled  å¼€å¯</li>
<li>query-stats-enabled  é»˜è®¤å…³é—­ï¼Œå°†æ‰§è¡Œç»Ÿè®¡å†™å…¥åˆ°é»˜è®¤çš„ç›‘æ§æ•°æ®åº“  </li>
<li>log-enabled  è®°å½•æ—¥å¿—</li>
<li>run-interval  æŸ¥æ‰¾æ‰§è¡Œé—´éš”</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼€å§‹ä¸€ä¸ªè½¯ä»¶,ä»è¯»æ‡‚å®ƒçš„é…ç½®æ–‡ä»¶å¼€å§‹ã€‚ä»¥ä¸‹æ˜¯è¯»å–&lt;a href=&quot;https://docs.influxdata.com/influxdb/v1.3/administration/config/&quot;&gt;3.1é…ç½®æ–‡æ¡£&lt;/a&gt;çš„ç¬”è®°&lt;br&gt;æ€»ç»“æ¥è¯´ï¼Œinfluxdbçš„é…ç½®æ–‡ä»¶å¯é…ç½®çš„åœ°æ–¹å‡ ä¹æ²¡æœ‰ã€‚å‚æ•°æ€§èƒ½è°ƒä¼˜è²Œä¼¼ä¸å­˜åœ¨ï¼Œå…¶ä¸­æ˜¯å¦å¼€å¯ï¼Œæ˜¯å¦è®°å½•æ—¥å¿—éƒ½å æ®äº†å¥½å¤šéƒ¨åˆ†ã€‚é¢å¤–éœ€è¦å…³æ³¨çš„æ˜¯dataç« èŠ‚æœ‰ä¸€äº›å…³äºfsyncçš„è®¾ç½®é»˜è®¤æ˜¯0ï¼Œè¿˜æœ‰é»˜è®¤çš„max-series-per-databaseå’Œmax-value-per-tagé»˜è®¤éƒ½å­˜åœ¨é™åˆ¶ã€‚æš‚æ—¶ä¸å¤ªæ¸…æ¥šåŸç†æ˜¯ä»€ä¹ˆ(æ›´æ–°:å› ä¸ºinfluxdbæœ€å¤§çš„è½¯è‚‹å°±åœ¨seriesçš„æ•°é‡ä¸Šã€‚tagçš„æ•°æ®éƒ½ä¿å­˜åœ¨å†…å­˜ã€‚æ‰€ä»¥æœ‰æå¤§çš„é™åˆ¶ã€‚å¯ä»¥çœ‹åˆ°&lt;a href=&quot;https://docs.influxdata.com/influxdb/v1.3/guides/hardware_sizing/#general-hardware-guidelines-for-a-cluster&quot;&gt;å®˜æ–¹ç¡¬ä»¶è¦æ±‚&lt;/a&gt;,100ä¸‡çš„serieséœ€è¦4-6æ ¸å¿ƒCPU,8-32GBå†…å­˜ï¼Œiopsè¦æ±‚1000+ã€‚å¯¹æ¯”ä¸€ä¸‹influxdbæä¾›çš„&lt;a href=&quot;https://cloud.influxdata.com/plan-picker&quot;&gt;äº‘æœåŠ¡&lt;/a&gt;ï¼Œ100ä¸‡çš„serieséœ€è¦æ¯æœˆ1500åˆ€!!!)ã€‚å½“ä¿å­˜å¤§é‡æ•°æ®çš„æ—¶å€™è‚¯å®šä¼šæŠ¥é”™,å¦å¤–é»˜è®¤çš„æ…¢æŸ¥è¯¢æ—¥å¿—æ˜¯æ²¡æœ‰æ‰“å¼€çš„ã€‚å¯¹äºè¯·æ±‚ã€‚é»˜è®¤æ²¡æœ‰é™åˆ¶æœ€å¤§çš„è¿”å›å†…å®¹æ•°ã€‚ä»¥åŠé™åˆ¶å•ä¸ªæŸ¥è¯¢å“åº”çš„æ—¶é—´&lt;/p&gt;
    
    </summary>
    
      <category term="database" scheme="https://www.zoulei.net/categories/database/"/>
    
    
  </entry>
  
  <entry>
    <title>ansibleç¬”è®°</title>
    <link href="https://www.zoulei.net/2017/11/28/ansible-note/"/>
    <id>https://www.zoulei.net/2017/11/28/ansible-note/</id>
    <published>2017-11-28T03:28:42.000Z</published>
    <updated>2017-11-28T03:57:18.299Z</updated>
    
    <content type="html"><![CDATA[<p>ä»¥ä¸‹ä¸ºè§‚çœ‹<a href="https://www.youtube.com/playlist?list=PL7hgvWUGJtUsT74AXZgVhr37riphKjzkD">Ansible-Configuration Management</a>çš„ç¬”è®°ã€‚ä¸é€‚åˆåˆå­¦è€…æŸ¥çœ‹ã€‚å¯ä»¥ä½œä¸ºæ¸©ä¹ ä½¿ç”¨</p>
<a id="more"></a>
<h2 id="Ansibleæ€»ç»“"><a href="#Ansibleæ€»ç»“" class="headerlink" title="Ansibleæ€»ç»“"></a>Ansibleæ€»ç»“</h2><ol>
<li>å•ä¸ªModuleæ˜¯åŸºçŸ³ï¼Œå°†æœºå™¨åˆ†ç»„ï¼Œä¸¥é‡ä¾é å˜é‡</li>
<li>taskç»„æˆä»»åŠ¡</li>
<li>å…¨éƒ¨çš„taskç»„æˆplaybooks.å°†æ‰€æœ‰çš„æœºå™¨å®šä¹‰åˆ°ä¸€ä¸ªç¡®å®šçš„çŠ¶æ€</li>
<li>ä½¿ç”¨roleå¯¹playbooksè¿›è¡Œæ‹†åˆ†.roleæœ‰çº¦å®šå¥½çš„ç›®å½•ç»“æ„</li>
<li>ansible galaxyæ¥åˆ†äº«role.ä½¿ç”¨æ—¶å®Œå…¨ä½¿ç”¨å˜é‡æ¥è¦†ç›–åŸæœ‰å˜é‡,ä¸¥é‡ä¾èµ–ç¤¾åŒºæ°´å¹³(æ¯”å¦‚å›½æƒ…å®‰è£…è®¸å¤šè½¯ä»¶éƒ½éœ€è¦ä½¿ç”¨é•œåƒ,è€Œå¤–å›½ä½œè€…ç¼–å†™roleå¹¶ä¸ä¼šè€ƒè™‘è¿™äº›)</li>
</ol>
<h2 id="ç‰¹ç‚¹"><a href="#ç‰¹ç‚¹" class="headerlink" title="ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h2><ul>
<li>change management(å®šä¹‰ä¸€ä¸ªç‰¹å®šçš„ç³»ç»ŸçŠ¶æ€ï¼Œchange_eventç”¨äºå›è°ƒ)</li>
<li>Provisioning(roleã€‚æœåŠ¡åˆ’åˆ†ã€‚æ¯”å¦‚ä¸€ä¸ªwebserverä¼šä¾æ¬¡æ‰§è¡ŒæŸäº›æ­¥éª¤)</li>
<li>Automation(playbookåŒæ—¶è®¾ç½®ä¸Šåƒå°)</li>
<li>Orchestration(ç¼–æ’å¤šä¸ªtasksè®©å…¶åè°ƒcoordinatesæ‰§è¡Œã€‚å¤šä¸ªç³»ç»Ÿé…ç½®ã€‚è§£å†³taské—´çš„ä¾èµ–æ€§)</li>
</ul>
<h2 id="ä¸ºä»€ä¹ˆä½¿ç”¨å®ƒ"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨å®ƒ" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨å®ƒ"></a>ä¸ºä»€ä¹ˆä½¿ç”¨å®ƒ</h2><ul>
<li>No agents</li>
<li>No database</li>
<li>No residual software</li>
<li>No complex upgrades</li>
<li>é¢˜å¤–è¯ã€‚ä½¿ç”¨yamlæ–‡ä»¶æè¿°è€Œæ— æ³•ä½¿ç”¨ç¼–ç¨‹æ§åˆ¶ã€‚æˆ‘è®¤ä¸ºè¿Ÿæ—©è¯ä¸¸ã€‚åªä¸è¿‡ç›®å‰è¿˜æ²¡æ‰¾åˆ°æ›´å¥½çš„æ›¿ä»£å“</li>
<li>ssh/root/encrypted vault(å…±äº«åˆ°githubä»“åº“æˆæ ‡é…äº†,å‡ ä¹æ‰€æœ‰çš„è½¯ä»¶éƒ½æ˜¯è¿™ä¸ªå¥—è·¯)</li>
<li>easy to extend:http callã€shell commands(æŒºæœ‰ç”¨)ã€scripts(æš‚æ—¶ä¸å¤ªæ‡‚ï¼Œæ„Ÿè§‰æ˜¯æ‰©å……model)ã€Ansible-Galaxy</li>
</ul>
<h2 id="Ansible-æ¶æ„"><a href="#Ansible-æ¶æ„" class="headerlink" title="Ansible æ¶æ„"></a>Ansible æ¶æ„</h2><p><img src="https://ficapy.b0.upaiyun.com/capture/ansible_arch.jpg" alt="Ansible æ¶æ„"></p>
<p>Variables:</p>
<ul>
<li>Host Variables: åœ¨èµ„äº§ä¸­ç»™hostæˆ–è€…groupè®¾ç½®çš„å˜é‡</li>
<li>Facts: ansibleè¿›è¡Œçš„ç¬¬ä¸€æ­¥å°±æ˜¯setupã€‚è·å–æœºå™¨çš„åŸºç¡€ä¿¡æ¯ã€‚æ¯”å¦‚å†…ç½‘ip</li>
<li>Dynamic Variables: æ”¶é›†tasksæ•°æ®æˆ–è€…è¿è¡Œæ—¶è·å–ï¼Ÿæ¯”å¦‚å°†ä¸Šä¸€ä¸ªtaskçš„ç»“æœä½œä¸ºå‚æ•°</li>
</ul>
<p>æ‰§è¡Œè¿‡ç¨‹ä¸­å°†modelå‘é€åˆ°è¿œæ–¹æœºå™¨ä¸´æ—¶ç›®å½•æ‰§è¡Œã€‚è¿”å›jsonç»“æœã€‚ç„¶ååˆ é™¤ä¸´æ—¶ç›®å½•å†…å®¹</p>
<h2 id="å­¦ä¹ ç¯å¢ƒæ­å»º-è§†é¢‘19"><a href="#å­¦ä¹ ç¯å¢ƒæ­å»º-è§†é¢‘19" class="headerlink" title="å­¦ä¹ ç¯å¢ƒæ­å»º(è§†é¢‘19)"></a>å­¦ä¹ ç¯å¢ƒæ­å»º(è§†é¢‘19)</h2><ul>
<li>Vagrantã€Virtualboxã€Ansible</li>
<li>Remoteã€Local(åŸºæœ¬ä¸ä½¿ç”¨Localæ¨¡å¼ã€‚ä»…æœ‰ä¸€æ¬¡æ— æ³•è¿œç¨‹sshæˆ‘ç”¨è¿‡)</li>
</ul>
<h2 id="Inventory-Features"><a href="#Inventory-Features" class="headerlink" title="Inventory Features"></a>Inventory Features</h2><ul>
<li>Behavioral Parameters</li>
<li>Groups</li>
<li>Groups of Groups</li>
<li>Assign Variables</li>
<li>Scaling out using multiple files</li>
<li>Static/Dynamic<br>åˆ†ç»„ã€ç»„åˆã€èµ‹äºˆå˜é‡(å’Œpythoné‡Œé¢å˜é‡ä½œç”¨åŸŸLEGBå·®ä¸å¤š)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[db]</div><div class="line">db1.company.com ansible_ssh_user=aarom xx=xx</div><div class="line">db2.company.com</div><div class="line"></div><div class="line">[datacenter-west:children]</div><div class="line">db</div><div class="line"></div><div class="line">[datacenter-west:vars]</div><div class="line">ansible_ssh_user=ansible_user</div><div class="line">xx=xx</div></pre></td></tr></table></figure>
<p>åˆ†ç»„çš„å¥—è·¯(group_varsã€host_varsä¸‹é¢çš„æ–‡ä»¶å¿…é¡»å’Œinventoryç›¸å¯¹åº”)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">â”œâ”€â”€ group_vars   # å…¨å±€</div><div class="line">â”‚Â Â  â”œâ”€â”€ all</div><div class="line">â”‚Â Â  â”œâ”€â”€ db</div><div class="line">â”œâ”€â”€ host_vars   # å•ä¸ªhost</div><div class="line">â”‚Â Â  â””â”€â”€ web1</div><div class="line">â”œâ”€â”€ inventory_prod</div><div class="line">â”œâ”€â”€ inventory_test</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># variable file example</div><div class="line">---     # æ ‡è®°</div><div class="line"># key-value pairs</div><div class="line">ntp:  ntp-west.company.com</div><div class="line">syslog: logger-west.company.com</div></pre></td></tr></table></figure>
<h2 id="Ad-Hoc-ä¸´æ—¶ä½¿ç”¨"><a href="#Ad-Hoc-ä¸´æ—¶ä½¿ç”¨" class="headerlink" title="Ad-Hoc ä¸´æ—¶ä½¿ç”¨"></a>Ad-Hoc ä¸´æ—¶ä½¿ç”¨</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ansible -m ping all</div><div class="line">ansible -m shell -a &quot;hostname&quot; all</div><div class="line">ansible -m shell -a &quot;getent passwd | grep deploy&quot; all</div><div class="line">ansible -b -K -m shell -a &quot;whoami&quot; all -vvv -T 30 -c paramiko</div></pre></td></tr></table></figure>
<p>å‚æ•°æ³¨è§£</p>
<ul>
<li>-b becomeå˜æˆæŸç”¨æˆ·ä¸€èˆ¬æ˜¯root</li>
<li>-K é…åˆ-bè¾“å…¥å¯†ç </li>
<li>-m ä½¿ç”¨æŸä¸ªæ¨¡å—</li>
<li>-vvv å’Œssh -vvvä¸€æ ·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—</li>
<li>-T timeout è®¾ç½®è¶…æ—¶</li>
<li>-c é€‰æ‹©è¿æ¥çš„æ¨¡å—. 3.5ä½¿ç”¨é»˜è®¤å€¼æsudoå¯èƒ½ä¼šæœ‰é—®é¢˜</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ä½¿ç”¨å˜é‡(ä¼°è®¡ä½¿ç”¨janja2æ¨¡æ¿å¼•æ“æ˜¯ä¼špythonçš„äººä½¿ç”¨ansibleçš„å”¯ä¸€ä¼˜åŠ¿äº†-_-)</div><div class="line">ansible webservers -i inventory_prod -m user -a &quot;name=&#123;&#123;username&#125;&#125; password=1234 -b&quot;</div></pre></td></tr></table></figure>
<p>ansible-docå¯ä»¥æŸ¥çœ‹æ–‡æ¡£  </p>
<h2 id="Host-Group-Target-Patterns"><a href="#Host-Group-Target-Patterns" class="headerlink" title="Host/Group Target Patterns"></a>Host/Group Target Patterns</h2><ul>
<li>OR (group1:group2)</li>
<li>NOT (!group2)</li>
<li>Wildcard (web*.ex.com)</li>
<li>Regex (~web[0-9]+)</li>
<li>Complex Patterns AND (group1:&amp;group2) # æ±‚äº¤é›†ã€ä¸­é—´å‡ºç°ä¸€ä¸ª:æœ‰ç‚¹å¥‡è‘©</li>
</ul>
<h2 id="Anaible-Playbooks"><a href="#Anaible-Playbooks" class="headerlink" title="Anaible Playbooks"></a>Anaible Playbooks</h2><ul>
<li>ç»„åˆansible modulesç»„æˆplay,å¤šä¸ªplayç»„æˆplaybooks</li>
<li>logic controls &amp; error handle</li>
<li>include åˆå¹¶å¤šä¸ª</li>
<li>Grab output of task for another task(register)</li>
<li>Debug Module(debug/msg or var)</li>
<li>Promptins for input(ç±»ä¼¼ä¸input,vars_prompt)</li>
<li>Playbook Handlers(notify)<ol>
<li>Tasks with asynchronous execution</li>
<li>Only runs tasks when notified</li>
<li>Tasks Only notify when state=changed</li>
<li>Does not run until all playbook tasks have executed</li>
<li>Most common for restarting services to load changes(if changes are made)</li>
</ol>
</li>
<li>Contitional Clause(when: ansible_os_family == â€œDebianâ€,æ­é…registerä½¿ç”¨)</li>
<li>Jinja2 Template Module(template)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">- hosts: webservres</div><div class="line">  sudo: yes</div><div class="line"></div><div class="line">  vars:</div><div class="line">    http_port: 80</div><div class="line">    doc_dir: /ansible/</div><div class="line">    doc_root: /var/www/html/ansible/</div><div class="line">    max_clients: 5</div><div class="line">  </div><div class="line">  vars_prompt:</div><div class="line">    - name: username</div><div class="line">      prompt: what is your name?</div><div class="line"></div><div class="line">  tasks:</div><div class="line">  - name: Ensure that Apache is installed</div><div class="line">    yum: name=httpd state=present</div><div class="line">    when: ansible_os_family == &quot;RedHat&quot;</div><div class="line"></div><div class="line">  - name: Start Apache Services</div><div class="line">    service: name=httpd enabled=yes state=started</div><div class="line"></div><div class="line">  - name: Deploy configuration File</div><div class="line">    template: src=templates/httpd.j2 dest=/etc/httpd/conf/httpd.conf</div><div class="line">    notify:</div><div class="line">      - Restart Apache</div><div class="line">    </div><div class="line">  - name: Copy Site Files</div><div class="line">      template: src=templates/index.j2 dest=&#123;&#123; doc_root &#125;&#125;/index.html</div><div class="line"></div><div class="line">  handlers:</div><div class="line">    - name: Restart Apache</div><div class="line">      service: name=httpd state=restarted</div><div class="line"></div><div class="line">- hosts: dbservers</div><div class="line">  sudo: yes</div><div class="line"></div><div class="line">  tasks:</div><div class="line">  - name: Ensure MySQL is installed</div><div class="line">    yum: name=mysql-server state=present</div><div class="line">  </div><div class="line">  - name: Start MySQL</div><div class="line">    service: name=mysqld state=started</div><div class="line"></div><div class="line">- hosts: webservers:dbservers</div><div class="line">  sudo: yes</div><div class="line"></div><div class="line">  tasks:</div><div class="line">  - name: Stop IPTABLES NOW!!!</div><div class="line">    service: name=iptables state=stopped</div></pre></td></tr></table></figure>
<p>ansible-playbook -i inventory web_db.yaml</p>
<h2 id="Roles"><a href="#Roles" class="headerlink" title="Roles"></a>Roles</h2><ul>
<li>Predefined directory structure</li>
<li>defaultsã€filesã€handlersã€metaã€tasksã€templatesã€vars</li>
<li>main.yml,ä½¿ç”¨include.varsé™¤å¤–</li>
<li>use tags to define categories within your playbooks</li>
<li><p>Adding Roles to Playbook</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">    ---</div><div class="line">    - hosts: code-dev</div><div class="line">    roles:</div><div class="line">        - server-common</div><div class="line">        - builders</div><div class="line">    gather_facts: no</div><div class="line">    tasks:</div><div class="line">        # Build your extra tasks here like</div><div class="line">    ``` </div><div class="line">- Pre-tasks and Post-tasks(executes plays before or after roles)</div><div class="line">- ```ansible-playbook site.yml -tags &quot;web&quot; -limit atlanta</div></pre></td></tr></table></figure>
</li>
<li><p>ansible galaxy(ansible-galaxy install username.role)</p>
</li>
</ul>
<h2 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h2><p><a href="https://github.com/enginyoyen/ansible-best-practises">ansible-best-practises</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»¥ä¸‹ä¸ºè§‚çœ‹&lt;a href=&quot;https://www.youtube.com/playlist?list=PL7hgvWUGJtUsT74AXZgVhr37riphKjzkD&quot;&gt;Ansible-Configuration Management&lt;/a&gt;çš„ç¬”è®°ã€‚ä¸é€‚åˆåˆå­¦è€…æŸ¥çœ‹ã€‚å¯ä»¥ä½œä¸ºæ¸©ä¹ ä½¿ç”¨&lt;/p&gt;
    
    </summary>
    
      <category term="devops" scheme="https://www.zoulei.net/categories/devops/"/>
    
    
  </entry>
  
  <entry>
    <title>å†…ç½‘æ— ç½‘ç»œç¯å¢ƒåˆå§‹åŒ–çº¿ä¸Šç¯å¢ƒ</title>
    <link href="https://www.zoulei.net/2017/08/13/when_no_network_setup_environment/"/>
    <id>https://www.zoulei.net/2017/08/13/when_no_network_setup_environment/</id>
    <published>2017-08-13T09:18:36.000Z</published>
    <updated>2017-08-13T09:46:27.000Z</updated>
    
    <content type="html"><![CDATA[<p>é‡åˆ°æœ‰äººåæ˜ å¯èƒ½æ˜¯å†…ç½‘ç¯å¢ƒã€‚æ— æ³•è®¿é—®å¤–éƒ¨ç½‘ç»œã€‚å®‰è£…åˆå§‹åŒ–ç¯å¢ƒçš„æ—¶å€™å¥½åƒé¢‡ä¸ºä¸ä¾¿ã€‚å…¶å®åªè¦èƒ½sshä¸Šå»ã€‚è¿™ä¸€åˆ‡éƒ½ä¸æ˜¯é—®é¢˜ã€‚å°±æ˜¯å„ç§è½¬å‘ï¼Œä»¥ä¸‹ä»¥å†…ç½‘ä½¿ç”¨pipå®‰è£…ç¬¬ä¸‰æ–¹ä¾èµ–åŒ…ä¸ºä¾‹è¯´æ˜è¯¥å¦‚ä½•æ“ä½œ</p>
<h2 id="1-æœ¬æœºå¼€å¯ä¸€ä¸ªä¸´æ—¶çš„httpä»£ç†"><a href="#1-æœ¬æœºå¼€å¯ä¸€ä¸ªä¸´æ—¶çš„httpä»£ç†" class="headerlink" title="1.æœ¬æœºå¼€å¯ä¸€ä¸ªä¸´æ—¶çš„httpä»£ç†"></a>1.æœ¬æœºå¼€å¯ä¸€ä¸ªä¸´æ—¶çš„httpä»£ç†</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install mitmproxy           # å®‰è£…</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mitmproxy -p 8899 --ignore .+               #  ä½¿ç”¨</div></pre></td></tr></table></figure>
<p>mitmproxyæ˜¯ä¸€ä¸ªpythonç¼–å†™çš„http/httpsä¸­é—´äººæ¡†æ¶ã€‚è¿™é‡Œæˆ‘ä»¬å•ç‹¬çš„ä½¿ç”¨å®ƒçš„http proxyåŠŸèƒ½ã€‚<br>å‚æ•°på½“ç„¶æ˜¯portç«¯å£çš„æ„æ€äº†ã€‚ç›‘å¬8899ç«¯å£<br>åŠ ä¸Šignoreæ˜¯å› ä¸ºä¸­é—´äººhttpsè¿æ¥éœ€è¦å®¢æˆ·ç«¯å®‰è£…ä¿¡ä»»è¯ä¹¦æ‰å¯ä»¥ã€‚æ­¤å¤„æˆ‘ä»¬åªæ˜¯å•çº¯çš„ä½¿ç”¨ä¸€ä¸‹proxyä¸éœ€è¦ä¸­é—´äººã€‚æ‰€ä»¥æ‰€æœ‰æµé‡ä½¿ç”¨HTTP Connectionéš§é“æ–¹å¼å°±è¾¾æˆç›®çš„äº†ã€‚ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼<code>.+</code>å¿½ç•¥æ‰€æœ‰åŸŸåã€‚è‡³äºä¸ºä»€ä¹ˆä½¿ç”¨httpä¸æ˜¯ç”¨socksã€‚å› ä¸ºhttpä½¿ç”¨æ›´å¹¿æ³›</p>
<h2 id="2-sshä½¿ç”¨è¿œç¨‹ç«¯å£è½¬å‘-å‚è€ƒsshç«¯å£æ˜ å°„"><a href="#2-sshä½¿ç”¨è¿œç¨‹ç«¯å£è½¬å‘-å‚è€ƒsshç«¯å£æ˜ å°„" class="headerlink" title="2.sshä½¿ç”¨è¿œç¨‹ç«¯å£è½¬å‘(å‚è€ƒsshç«¯å£æ˜ å°„)"></a>2.sshä½¿ç”¨è¿œç¨‹ç«¯å£è½¬å‘(å‚è€ƒ<a href="https://ficapy.com/2017/03/12/ssh-port-forward/">sshç«¯å£æ˜ å°„</a>)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh -R 8899:localhost:8899 remote_server</div></pre></td></tr></table></figure>
<p>å°†è¿œç¨‹ä¸»æœºä¸Šçš„8899ç«¯å£æ˜ å°„åˆ°æœ¬æœºçš„8899ç«¯å£</p>
<h2 id="3-è¿œç¨‹ä¸»æœºä½¿ç”¨æœ¬åœ°çš„httpä»£ç†è¿›è¡Œç¯å¢ƒåˆå§‹åŒ–"><a href="#3-è¿œç¨‹ä¸»æœºä½¿ç”¨æœ¬åœ°çš„httpä»£ç†è¿›è¡Œç¯å¢ƒåˆå§‹åŒ–" class="headerlink" title="3.è¿œç¨‹ä¸»æœºä½¿ç”¨æœ¬åœ°çš„httpä»£ç†è¿›è¡Œç¯å¢ƒåˆå§‹åŒ–"></a>3.è¿œç¨‹ä¸»æœºä½¿ç”¨æœ¬åœ°çš„httpä»£ç†è¿›è¡Œç¯å¢ƒåˆå§‹åŒ–</h2><p>å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œæµ‹éªŒ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -x http://localhost:8899 ip.cn</div></pre></td></tr></table></figure>
<p>æ¯”å¦‚ä½¿ç”¨pypiå®‰è£…tornadoæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å³å¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install -i https://pypi.tuna.tsinghua.edu.cn/simple --proxy http://localhost:8899 tornado</div></pre></td></tr></table></figure>
<p>æ€è·¯æ˜¯è¿™æ ·ã€‚å…¶å®ƒåŒç†~~~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;é‡åˆ°æœ‰äººåæ˜ å¯èƒ½æ˜¯å†…ç½‘ç¯å¢ƒã€‚æ— æ³•è®¿é—®å¤–éƒ¨ç½‘ç»œã€‚å®‰è£…åˆå§‹åŒ–ç¯å¢ƒçš„æ—¶å€™å¥½åƒé¢‡ä¸ºä¸ä¾¿ã€‚å…¶å®åªè¦èƒ½sshä¸Šå»ã€‚è¿™ä¸€åˆ‡éƒ½ä¸æ˜¯é—®é¢˜ã€‚å°±æ˜¯å„ç§è½¬å‘ï¼Œä»¥ä¸‹ä»¥å†…ç½‘ä½¿ç”¨pipå®‰è£…ç¬¬ä¸‰æ–¹ä¾èµ–åŒ…ä¸ºä¾‹è¯´æ˜è¯¥å¦‚ä½•æ“ä½œ&lt;/p&gt;
&lt;h2 id=&quot;1-æœ¬æœºå¼€å¯ä¸€ä¸ªä¸´æ—¶çš„httpä»£ç†&quot;&gt;&lt;a href=&quot;#1
    
    </summary>
    
      <category term="ä¼ªæŠ€æœ¯" scheme="https://www.zoulei.net/categories/%E4%BC%AA%E6%8A%80%E6%9C%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>å¼€å‘ç¯å¢ƒä¸­æ•°æ®åº“å¿«é€Ÿå›æ»š</title>
    <link href="https://www.zoulei.net/2017/07/15/develop_quick_restore_postgresql_database/"/>
    <id>https://www.zoulei.net/2017/07/15/develop_quick_restore_postgresql_database/</id>
    <published>2017-07-15T05:24:19.000Z</published>
    <updated>2017-07-15T07:57:36.000Z</updated>
    
    <content type="html"><![CDATA[<p>å¼€å‘ä¸­æ€»ä¼šé‡åˆ°ä¸€äº›æµ‹è¯•éœ€è¦å›æ»šæ•°æ®åº“ã€‚å¸¸è§„çš„å•å…ƒæµ‹è¯•çš„åšæ³•æ˜¯åœ¨å•ä¸ªä¼šè¯ä¸­ä¸çœŸæ­£çš„å†™å…¥åˆ°æ•°æ®åº“ã€‚è€Œæ˜¯æµ‹è¯•å®Œæˆåè¿›è¡Œæ•°æ®åº“å›æ»šã€‚å¤§å¤šæ•°æƒ…å†µä¸‹è¿™æ ·éƒ½æ˜¯æ»¡è¶³è¦æ±‚çš„ã€‚åªæ˜¯æœ‰çš„æ—¶å€™éœ€è¦æ•°æ®åº“çœŸæ­£çš„å†™å…¥åˆ°æ•°æ®åº“ã€‚æ­¤æ—¶rollbackå›æ»šå°±æœ‰äº›ä¹åŠ›äº†ã€‚æ­¤æ—¶ç»™æ•°æ®åº“åšä¸€ä¸ªå¤‡ä»½ï¼Œæµ‹è¯•å®Œæˆåå›æ»šæ˜¯ä¸€ç§ä¸é”™çš„ä¸»æ„ã€‚Postgresqlæ•°æ®åº“çš„å¸¸è§„å¤‡ä»½æˆ‘ä»¬ä¼šä½¿ç”¨pg_dumpå’Œpg_restoreè¿›è¡Œå¯¼å‡ºå’Œæ¢å¤ã€‚æ­¤æ—¶å¦‚ä½•å¿«é€Ÿçš„è¿›è¡Œè¿™ä¸ªæ“ä½œæ˜¯æˆ‘ä»¬å…³æ³¨çš„è¯é¢˜</p>
<p>å¾ˆå¹¸è¿ã€‚å¾ˆé¡ºåˆ©çš„æœåˆ°äº†ç­”æ¡ˆã€‚6å¹´å‰æœ‰äººåœ¨stackexchangeä¸Šæé—®åŒæ ·çš„é—®é¢˜ã€‚å¾—åˆ°äº†ä¸€äº›æœ‰ç”¨çš„å›å¤ã€‚å¤§æ¦‚æœ‰è¿™äº›</p>
<ul>
<li>ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿçº§å¿«ç…§LVM</li>
<li>ä½¿ç”¨CREATE  DATABASE â€¦ TEMPLATEè¯­æ³•</li>
<li>å°†æ•°æ®åº“æ”¾åœ¨è™šæ‹Ÿæœºé‡Œé¢ã€‚ä½¿ç”¨è™šæ‹Ÿæœºå¿«ç…§</li>
</ul>
<p>å…¶ä¸­æœ€æœ‰æ•ˆçš„æ–¹æ¡ˆæ˜¯äºŒã€‚å› ä¸ºLVMåœ¨ä¸ªäººç¬”è®°æœ¬ä¸Šéš¾ä»¥å®æ–½ã€‚è™šæ‹Ÿæœºæ¢å¤æ—¶é—´è¾ƒæ…¢ã€‚ä¾æ®æ–¹æ¡ˆäºŒäºæ˜¯ä¹æœ‰äººå†™äº†ä¸€ä¸ªå·¥å…· <a href="https://github.com/fastmonkeys/stellar">stellar</a>ã€‚ç²—ç•¥è¯»äº†ä¸€ä¸‹æºç ã€‚å…¶å…·ä½“åŸç†å¤§æ¦‚å¦‚ä¸‹å›¾<br><img src="https://ficapy.b0.upaiyun.com/blogimg/backup_and_restore_flow.jpg" alt="backup_and_restore_flow"></p>
<p>å¤‡ä»½çš„æ—¶å€™ä½¿ç”¨create database â€¦ templateåˆ›å»º2ä¸ªå¤‡ä»½ã€‚æ¢å¤çš„æ—¶å€™åˆ æ‰åŸæœ‰çš„æ•°æ®åº“ã€‚å°†ä¸€ä¸ªå¤‡ä»½é‡å‘½åä¸ºåŸæœ‰çš„åç§°ã€‚å¦å¤–çš„ä¸€ä¸ªå¤‡ä»½å†ç”Ÿæˆä¸€ä¸ªå¤‡ä»½å°±å®Œæˆäº†ã€‚å¦å¤–åˆ é™¤æ–°å»ºæ•°æ®åº“æ“ä½œå‡ä¼šå…³é—­æ‰€æœ‰å·²è¿æ¥çš„æ•°æ®åº“ä¼šè¯ã€‚</p>
<p>å› ä¸ºç±»ä¼¼æ–‡ä»¶ç³»ç»Ÿçº§å¿«ç…§ï¼Œæ‰€ä»¥æ–¹æ³•æå¿«ã€‚æˆ‘æœ¬æœº2Gçš„æ•°æ®åº“æ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ªå¿«ç…§å¤§æ¦‚åç§’é’Ÿå·¦å³ï¼Œæ¢å¤å°±æ›´å¿«äº†ã€‚å½“ç„¶ç¼ºç‚¹ä¹Ÿæ˜¯æœ‰çš„ï¼Œä½ æ¯åˆ›å»ºä¸€ä¸ªå¿«ç…§éƒ½ä¼šæ–°å¢2ä¸ªä¸€æ ·å¤§å°çš„å‰¯æœ¬ï¼Œç›¸å½“çš„å æ®ç¡¬ç›˜ç©ºé—´ï¼Œå¯æ˜¯ä¸ºäº†é€Ÿåº¦è¿™ç‚¹ç¼ºé™·ä¹Ÿå°±å¾®ä¸è¶³é“äº†â”‘(ï¿£Ğ” ï¿£)â”</p>
<p>å¦å¤–ä¸€ä¸ªå°ç¼ºç‚¹ã€‚å› ä¸ºå®ƒå®šä½äºæµ‹è¯•ç¯å¢ƒä¸‹çš„æ•°æ®åº“å¤‡ä»½æ¢å¤ã€‚æ‰€ä»¥åªè¿æ¥ä¸€å°æœºå™¨ã€‚æ¯”å¦‚ä½ ä¸€ä¸ªæ•°æ®åº“åœ¨æœºå™¨A,ä¸€ä¸ªæ•°æ®åº“åœ¨æœºå™¨B.èµ›é«˜~~ï¼Œé‚£ä½ åªèƒ½åœ¨2ä¸ªç›®å½•ä¸‹ä½¿ç”¨2ä¸ªé…ç½®æ–‡ä»¶æ¥å®Œæˆäº†ã€‚å¦‚æœåŒä¸€ä¸ªæœºå™¨ä¸Šçš„å¤šä¸ªæ•°æ®åº“æ˜¯å¯ä»¥ç›´æ¥å¤‡ä»½çš„ã€‚å†å°±æ˜¯æ­¤å·¥å…·æ¯”è¾ƒä¸“æ³¨äºPostgresqlã€‚å¯¹äºMysqlå°±ä¸é‚£ä¹ˆå‹å¥½äº†ã€‚æˆ–è®¸æ˜¯Mysqlçš„å¤‡ä»½æ–¹æ¡ˆä¸ä¸€æ ·</p>
<h3 id="ä½¿ç”¨æ–¹æ³•"><a href="#ä½¿ç”¨æ–¹æ³•" class="headerlink" title="ä½¿ç”¨æ–¹æ³•"></a>ä½¿ç”¨æ–¹æ³•</h3><ol>
<li><code>stellar init</code> æŒ‰ç…§æç¤ºè¾“å…¥æœ¬æœºæ•°æ®åº“è®¿é—®è·¯å¾„ç”Ÿæˆé…ç½®æ–‡ä»¶</li>
<li><code>stellar snapshot</code> ç”Ÿæˆä¸€ä¸ªå¿«ç…§</li>
<li><code>stellar restore &lt;snap1&gt;</code> æ¢å¤</li>
<li>å…¶ä»–è¯·çœ‹ <code>stellar --help</code></li>
</ol>
<p>( âŠ™ o âŠ™ )å•Šï¼ å¤šä¹ˆçˆ½å¿«ï¼Œä¸–ç•ŒçœŸç¾å¦™</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://dba.stackexchange.com/questions/3394/is-it-possible-to-quickly-create-restore-database-snapshots-with-postgresql">Is it possible to quickly create/restore database snapshots with PostgreSQL?</a><br><a href="https://github.com/fastmonkeys/stellar">github stellar</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼€å‘ä¸­æ€»ä¼šé‡åˆ°ä¸€äº›æµ‹è¯•éœ€è¦å›æ»šæ•°æ®åº“ã€‚å¸¸è§„çš„å•å…ƒæµ‹è¯•çš„åšæ³•æ˜¯åœ¨å•ä¸ªä¼šè¯ä¸­ä¸çœŸæ­£çš„å†™å…¥åˆ°æ•°æ®åº“ã€‚è€Œæ˜¯æµ‹è¯•å®Œæˆåè¿›è¡Œæ•°æ®åº“å›æ»šã€‚å¤§å¤šæ•°æƒ…å†µä¸‹è¿™æ ·éƒ½æ˜¯æ»¡è¶³è¦æ±‚çš„ã€‚åªæ˜¯æœ‰çš„æ—¶å€™éœ€è¦æ•°æ®åº“çœŸæ­£çš„å†™å…¥åˆ°æ•°æ®åº“ã€‚æ­¤æ—¶rollbackå›æ»šå°±æœ‰äº›ä¹åŠ›äº†ã€‚æ­¤æ—¶ç»™æ•°æ®åº“åšä¸€ä¸ªå¤‡ä»½ï¼Œæµ‹è¯•å®Œæˆåå›æ»š
    
    </summary>
    
      <category term="ä¼ªæŠ€æœ¯" scheme="https://www.zoulei.net/categories/%E4%BC%AA%E6%8A%80%E6%9C%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>Docker CDåˆæ¢-Drone</title>
    <link href="https://www.zoulei.net/2017/07/05/drone/"/>
    <id>https://www.zoulei.net/2017/07/05/drone/</id>
    <published>2017-07-05T13:51:26.000Z</published>
    <updated>2017-07-05T16:21:28.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘æœ‰ä¸ªå°éœ€æ±‚ï¼Œæˆ‘ä»¬å…¬å¸å†™æ–‡æ¡£æ˜¯é€šè¿‡<a href="https://github.com/lord/slate">slate</a>æ¥çš„ã€‚æ¯ä¸€æ¬¡æ–‡æ¡£ç¼–å†™å®Œæˆä¹‹åéƒ½éœ€è¦æ‰§è¡Œ<code>bundle exec middleman build --clean</code>ç”Ÿæˆé™æ€æ–‡ä»¶ã€‚ç„¶åå†ä½¿ç”¨rsyncæ¥è¿›è¡Œä¸Šä¼ æ“ä½œã€‚è™½ç„¶åªæœ‰2æ­¥ã€‚ä½†æ˜¯åšçš„æ¬¡æ•°å¤šäº†éš¾å…ä¹Ÿè®©äººè§‰å¾—åŒçƒ¦ã€‚èŒç”Ÿäº†è‡ªåŠ¨åŒ–å¤„ç†çš„æƒ³æ³•ã€‚æ¯”è¾ƒç²—æš´çš„æ–¹å¼æœ‰ã€‚æ¯éš”å‡ åˆ†é’Ÿå»æ£€æµ‹ä¸€æ¬¡gitç‰ˆæœ¬åº“æ˜¯å¦æœ‰æ›´æ–°(ä»¥å‰æœ¬äººçœŸè¿™æ ·å®ç°è¿‡)ï¼Œè‡ªå·±å†™ä¸ªå°webç¨‹åºã€‚è®¾ç½®webhookã€‚æ¥æ”¶åˆ°webhookå†æ‹‰å–è¿›è¡Œæ“ä½œ(æˆ‘ä¹Ÿå®ç°è¿‡ï¼Œç›®å‰ä¸€åˆ‡è¿è¡Œè‰¯å¥½)ã€‚ç°åœ¨å°è¯•ä¸‹ä½¿ç”¨å¯æŒç»­é›†æˆçš„å¥—è·¯å»å®ç°ã€‚</p>
<a id="more"></a>
<p>è¯´ä¸€ä¸‹ç¬¬ä¸‰ç§æ–¹æ¡ˆç›¸å¯¹å‰ä¸¤ç§æ–¹æ¡ˆçš„ç‰¹ç‚¹ã€‚</p>
<ul>
<li>é›†ä¸­åŒ–ç®¡ç†ã€‚ç¬¬ä¸€äºŒç§æ–¹æ¡ˆéƒ½éœ€è¦å°†è„šæœ¬æ”¾åœ¨å¯¹åº”çš„åº”ç”¨æœºå™¨ä¸Šé¢ã€‚ç¬¬ä¸‰ç§ä¸éœ€è¦ï¼Œå®ƒé›†ä¸­åŒ–äº†ã€‚æ‰€æœ‰çš„webhookéƒ½åœ¨å¯æŒç»­é›†æˆå¹³å°å¤„ç†ã€‚ç”±å¹³å°å†æ¥æ“æ§åº”ç”¨ã€‚è€Œä¸”æ¯ä¸€æ¬¡è§¦å‘æ“ä½œéƒ½æœ‰è¯¦å°½çš„æ—¥å¿—ã€‚é›†ä¸­åœ¨ä¸€èµ·æ¯”è¾ƒå®¹æ˜“çœ‹å‡ºå“ªé‡Œå‡ºäº†ä»€ä¹ˆé—®é¢˜</li>
<li>ä¸éœ€è¦åœ¨æ¯ä¸€å°åº”ç”¨æœºå¤„ç†webhook(å¤„ç†æ„å‘³ç€æ¯ä¸ªåº”ç”¨æœºéƒ½éœ€è¦ç»‘å®šä¸€ä¸ªåŸŸå)ï¼Œå¯èƒ½å’Œä¸Šé¢çš„é›†ä¸­åŒ–ç®¡ç†çš„ä¼˜ç‚¹æ˜¯ä¸€ä¸ªæ„æ€å§</li>
<li>å¯¹äºä¸€ä¸ªè‰¯å¥½çš„æ¶æ„ã€‚å¯æŒç»­é›†æˆå¹³å°æ¯”é›¶æ•£çš„è„šæœ¬æ— ç–‘æ›´åˆé€‚</li>
<li>ç®—æ˜¯ä¸€ä¸ªç¼ºç‚¹ã€‚å•ç‹¬å†™è„šæœ¬ç‹¬ç«‹å¤„ç†webhookç›¸å¯¹å¯æŒç»­é›†æˆæ›´å®¹æ˜“</li>
</ul>
<h3 id="Droneé…ç½®"><a href="#Droneé…ç½®" class="headerlink" title="Droneé…ç½®"></a>Droneé…ç½®</h3><p>docker-composeæˆ‘éƒ½ä¸å¤§ç”¨äº†ï¼Œç›´æ¥ç”¨docker stack deployæ›¿ä»£ã€‚åè€…ç›¸å¯¹å‰è€…å®é™…æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚æˆ–è€…è¯´å‰è€…æ˜¯å› ä¸ºdockerç½‘ç»œé…ç½®æ¬ å‘è¾¾çš„äº§ç‰©ã€‚docker-composeé€‚åˆå•æœºéƒ¨ç½²ï¼Œdocker-swarmé€‚åˆå¤šä¸»æœºã€‚å¼€å¯docker-swarmåªéœ€è¦docker swarm initå¤§æ¦‚å°±å¯ä»¥äº†ï¼Œæ›´è¯¦ç»†çš„çŸ¥è¯†è¯·æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£</p>
<p>drone.yml æ–‡ä»¶å¤§æ¦‚å¦‚ä¸‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">version: &apos;3&apos;</div><div class="line"></div><div class="line">services:</div><div class="line">  drone-server:</div><div class="line">    image: drone/drone:0.7</div><div class="line">    ports:</div><div class="line">      - 82:8000</div><div class="line">    volumes:</div><div class="line">      - /data/github_drone:/var/lib/drone/</div><div class="line">    environment:</div><div class="line">      - DRONE_OPEN=false</div><div class="line">      - DRONE_ADMIN=ficapy</div><div class="line">      - DRONE_GITLAB=true</div><div class="line">      - DRONE_GITHUB_CLIENT=xxxxxxxxx</div><div class="line">      - DRONE_GITHUB_SECRET=xxxxxxxxxx</div><div class="line">      - DRONE_SECRET=xxxpwdxxx</div><div class="line"></div><div class="line">  drone-agent:</div><div class="line">    image: drone/drone:0.7</div><div class="line">    command: agent</div><div class="line">    depends_on:</div><div class="line">      - drone-server</div><div class="line">    volumes:</div><div class="line">      - /var/run/docker.sock:/var/run/docker.sock</div><div class="line">    environment:</div><div class="line">      - DRONE_SERVER=ws://drone-server:8000/ws/broker</div><div class="line">      - DRONE_SECRET=xxxpwdxxx</div><div class="line"></div></pre></td></tr></table></figure></p>
<p>ç„¶åæ‰§è¡Œ<code>docker stack deploy --compose-file=drone.yml drone</code>ï¼Œæ•´ä¸ªç¨‹åºå°±è¿è¡Œèµ·æ¥äº†ã€‚æ­¤å¤„æ˜¯ç›‘å¬81ç«¯å£ã€‚ä»é…ç½®æ–‡ä»¶ä¸­ä¹Ÿå¯ä»¥çŒœä¸€ä¸ªå¤§æ¦‚ã€‚äº†è§£ä¸‹droneçš„æµç¨‹ã€‚serviceä¸»è¦ç”¨æ¥å“åº”æµè§ˆå™¨ç«¯çš„è¯·æ±‚ã€‚æ¥æ”¶åˆ°è¯·æ±‚åä½¿ç”¨websocketå’Œagenté€šä¿¡ç”¨æ¥ä¸‹å‘ä»»åŠ¡è·å–ç»“æœã€‚agenté€šè¿‡/var/run/docker.sockæ¥å’Œdocker daemonè¿›è¡Œé€šä¿¡ã€‚æ‰§è¡Œåˆ›å»ºå®¹å™¨ã€‚æ‰§è¡Œå‘½ä»¤ç­‰ä¸€ç³»åˆ—è¿‡ç¨‹ã€‚</p>
<p>æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„çš„</p>
<ul>
<li>æœ€å¥½æŒ‡å®šç®¡ç†å‘˜ç”¨æˆ·DRONE_ADMINï¼Œå› ä¸ºæœ‰äº›æ“ä½œéœ€è¦adminæƒé™</li>
<li>DRONE_OPENè®¾ç½®ä¸ºtrueçš„æ—¶å€™æ‰€æœ‰çš„ç”¨æˆ·éƒ½èƒ½æˆæƒåä½¿ç”¨ä½ çš„Droneè¿›è¡Œé›†æˆæµ‹è¯•ã€‚è¿™å¾€å¾€æ˜¯ä½ ä¸æ„¿æ„çš„ï¼Œä¸ªäººçš„è¯‰æ±‚å¾€å¾€æ˜¯ç§æœ‰çš„</li>
<li>githubå’Œgitlabåœ¨ä¸€ä¸ªdroneä¸èƒ½åŒæ—¶ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘éƒ¨ç½²äº†ä¸¤å¥—ï¼Œä½¿ç”¨äº†ä¸åŒçš„åŸŸå</li>
<li>èµ·ç äº†è§£OAuthæµç¨‹å’Œwebhookçš„è¿‡ç¨‹ï¼Œæ‰èƒ½æ›´å¥½çš„ç†è§£æ•´å¥—æµç¨‹</li>
<li>å…¶ä»–äº‹å®œå¯ä»¥æŸ¥çœ‹Droneçš„<a href="http://docs.drone.io/installation/">å®‰è£…æ–‡æ¡£</a></li>
</ul>
<p>ä¹‹æ‰€ä»¥ç›‘å¬81ç«¯å£ï¼Œæ˜¯å› ä¸ºæˆ‘ä½¿ç”¨çš„Caddyå½“åšå‰ç½®webæœåŠ¡å™¨ã€‚é…ç½®å¦‚ä¸‹Caddyfile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">drone.ficapy.com &#123;</div><div class="line">    proxy / dockerhost:81 &#123;</div><div class="line">        websocket</div><div class="line">        transparent</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯¹åº”çš„docker-composeæ–‡ä»¶å¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">version: &quot;3&quot;</div><div class="line"></div><div class="line">services:</div><div class="line">  Caddy:</div><div class="line">    image: &quot;abiosoft/caddy&quot;</div><div class="line">    volumes:</div><div class="line">      - /root/caddy/Caddyfile:/etc/Caddyfile</div><div class="line">      - /root/.caddy:/root/.caddy</div><div class="line">    ports:</div><div class="line">      - &quot;80:80&quot;</div><div class="line">      - &quot;443:443&quot;</div><div class="line">    extra_hosts:</div><div class="line">      - &quot;dockerhost:$&#123;dockerhost&#125;&quot;</div></pre></td></tr></table></figure>
<p>æ­¤å¤„ä½¿ç”¨äº†ç¯å¢ƒå˜é‡dockerhostï¼Œæˆ‘å°†å®ƒå†™å…¥äº†zshrcé…ç½®æ–‡ä»¶ä¸­<code>export dockerhost=&quot;172.17.0.1&quot;</code>,ä¸éš¾çœ‹å‡ºåªæ˜¯ä¸ºäº†è½¬å‘è¯·æ±‚, å’Œdroneä¸€æ ·ã€‚æ‰§è¡Œ<code>docker stack deploy --compose-file=caddy_compose.yml caddy</code>å¯åŠ¨</p>
<h3 id="æŒç»­é›†æˆéƒ¨ç½²"><a href="#æŒç»­é›†æˆéƒ¨ç½²" class="headerlink" title="æŒç»­é›†æˆéƒ¨ç½²"></a>æŒç»­é›†æˆéƒ¨ç½²</h3><p>å½“ä½¿ç”¨Droneï¼Œå¹¶æˆæƒä¹‹åã€‚Droneä¼šè‡ªåŠ¨ç»™ä½ çš„é¡¹ç›®åŠ ä¸Šwebhookåœ°å€ã€‚æˆ‘ä»¬åœ¨é¡¹ç›®æ ¹ç›®å½•æ”¾ç½®.drone.ymlæ–‡ä»¶åä¼šä½¿ç”¨dockerè‡ªåŠ¨æ„å»º</p>
<p>å®ç°æœ¬æ–‡å¼€å¤´è¯´çš„éœ€æ±‚.drone.ymlæ–‡ä»¶å¦‚ä¸‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">pipeline:</div><div class="line">  build:</div><div class="line">    image: ruby:2.3</div><div class="line">    commands:</div><div class="line">      - bundle config mirror.https://rubygems.org https://gems.ruby-china.org</div><div class="line">      - bundle install</div><div class="line">      - apt-get update &amp;&amp; apt-get install nodejs rsync -y &amp;&amp; bundle exec middleman build --clean</div><div class="line">      - rsync -r --rsh=&apos;ssh -o LogLevel=ERROR -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o IdentitiesOnly=yes -i /data/id_rsa -p 22&apos; build/* user@host:~/docs --progress --delete</div><div class="line">    volumes:</div><div class="line">      - /data:/data</div><div class="line">    when:</div><div class="line">      branch: master</div></pre></td></tr></table></figure></p>
<p>åœ¨ä½¿ç”¨ä¹‹å‰ã€‚æˆ‘ç°åœ¨/dataç›®å½•ä½¿ç”¨ssh-agentç”Ÿæˆäº†å¯†åŒ™å¯¹ã€‚åœ¨ç›®æ ‡ä¸»æœºä¸Šæ”¾ä¸Šå…¬é’¥ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿsshè¿æ¥è¿œç«¯ä¸»æœºã€‚ç„¶åå®¹å™¨åˆ›å»ºçš„æ—¶å€™å°†å¯†åŒ™æŒ‚è½½åˆ°å®¹å™¨ç›®å½•(æ­¤å¤„éœ€è¦ç®¡ç†å‘˜æƒé™å°†é¡¹ç›®è®¾ç½®ä¸ºå¯ä¿¡)ã€‚ç„¶åå°±é¡ºç†æˆç« äº†ã€‚æ­å»ºç¯å¢ƒï¼Œç”Ÿæˆé™æ€æ–‡ä»¶ï¼ŒrsyncåŒæ­¥å°±å®Œæˆäº†ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘æœ‰ä¸ªå°éœ€æ±‚ï¼Œæˆ‘ä»¬å…¬å¸å†™æ–‡æ¡£æ˜¯é€šè¿‡&lt;a href=&quot;https://github.com/lord/slate&quot;&gt;slate&lt;/a&gt;æ¥çš„ã€‚æ¯ä¸€æ¬¡æ–‡æ¡£ç¼–å†™å®Œæˆä¹‹åéƒ½éœ€è¦æ‰§è¡Œ&lt;code&gt;bundle exec middleman build --clean&lt;/code&gt;ç”Ÿæˆé™æ€æ–‡ä»¶ã€‚ç„¶åå†ä½¿ç”¨rsyncæ¥è¿›è¡Œä¸Šä¼ æ“ä½œã€‚è™½ç„¶åªæœ‰2æ­¥ã€‚ä½†æ˜¯åšçš„æ¬¡æ•°å¤šäº†éš¾å…ä¹Ÿè®©äººè§‰å¾—åŒçƒ¦ã€‚èŒç”Ÿäº†è‡ªåŠ¨åŒ–å¤„ç†çš„æƒ³æ³•ã€‚æ¯”è¾ƒç²—æš´çš„æ–¹å¼æœ‰ã€‚æ¯éš”å‡ åˆ†é’Ÿå»æ£€æµ‹ä¸€æ¬¡gitç‰ˆæœ¬åº“æ˜¯å¦æœ‰æ›´æ–°(ä»¥å‰æœ¬äººçœŸè¿™æ ·å®ç°è¿‡)ï¼Œè‡ªå·±å†™ä¸ªå°webç¨‹åºã€‚è®¾ç½®webhookã€‚æ¥æ”¶åˆ°webhookå†æ‹‰å–è¿›è¡Œæ“ä½œ(æˆ‘ä¹Ÿå®ç°è¿‡ï¼Œç›®å‰ä¸€åˆ‡è¿è¡Œè‰¯å¥½)ã€‚ç°åœ¨å°è¯•ä¸‹ä½¿ç”¨å¯æŒç»­é›†æˆçš„å¥—è·¯å»å®ç°ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Docker" scheme="https://www.zoulei.net/categories/Docker/"/>
    
    
  </entry>
  
  <entry>
    <title>ç†è§£metaclass</title>
    <link href="https://www.zoulei.net/2017/03/24/python_metaclass/"/>
    <id>https://www.zoulei.net/2017/03/24/python_metaclass/</id>
    <published>2017-03-24T01:34:48.000Z</published>
    <updated>2017-05-31T08:46:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>metaclassä¸€ç›´è¢«å½’ç±»ä¸ºæ¯”è¾ƒé«˜æ·±çš„å†…å®¹ï¼Œå†™ä»£ç ä¹Ÿå¾ˆå°‘ä¼šä½¿ç”¨åˆ°metaclassã€‚ç„¶è€Œå¦‚æœä½ çœ‹æŸäº›é¡¹ç›®çš„æºä»£ç ï¼Œè¿˜æ˜¯ä¼šè¢«ç»•åˆ°metaclassé‡Œé¢å»ã€‚èŠ±ä¸€äº›æ—¶é—´ç†è§£ä¸‹metaclasså¾ˆæœ‰ç”¨çš„ï¼Œå› ä¸ºå®ƒçœŸçš„èƒ½æŠŠä¸€æ¡çº¿ä¸²èµ·æ¥ï¼Œç¯ç¯ç›¸æ‰£ï¼Œæ‰€ä»¥æœ‰æ‰å®çš„åŸºç¡€æ˜¯æŒæ¡metaclassçš„å‰æï¼Œæœ¬æ–‡ä»£ç åŸºäºpython3.5</p>
<a id="more"></a>
<p>ä½ åªéœ€è¦ç†è§£ä»¥ä¸‹2ç‚¹</p>
<ol>
<li>metaclasså’Œ<code>__new__</code>ã€<code>__init__</code>å¹¶æ²¡æœ‰éå¸¸éå¸¸æ·±çš„å…³ç³»</li>
<li>type(name, bases, dict)ç”Ÿæˆäº†ä¸€ä¸ªobjectç±»ï¼Œäº†è§£ä¸‰ä¸ªå‚æ•°åˆ†åˆ«æŒ‡ä»£äº†ä»€ä¹ˆ</li>
</ol>
<p>äº†è§£pythonä¸­æœ‰è¿™æ ·ä¸€æ¡å…³ç³»é“¾type-&gt;object-&gt;instance,é€šå¸¸æˆ‘ä»¬å†™ç±»é»˜è®¤ä¼šç»§æ‰¿è‡ªobjectã€‚ä»å…³ç³»é“¾å°±èƒ½çŸ¥é“typeèƒ½å¤Ÿç”Ÿæˆobjectã€‚ä»£ç å¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(type)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, name, bases, attrs)</span>:</span></div><div class="line">        attrs.pop(<span class="string">'e'</span>)</div><div class="line">        print(<span class="string">'1'</span>, cls, name, bases, attrs)</div><div class="line">        cls.a = <span class="number">1</span></div><div class="line">        <span class="keyword">return</span> super().__new__(cls, name, bases, attrs)</div><div class="line"></div><div class="line">    <span class="comment"># def __call__(self, *args, **kwargs):</span></div><div class="line">    <span class="comment">#     print('3')</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, bases, attrs)</span>:</span></div><div class="line">        self.b = <span class="number">2</span></div><div class="line">        print(<span class="string">'2'</span>, self, name, bases, attrs)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(metaclass=A)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, *args, **kwargs)</span>:</span></div><div class="line">        print(<span class="string">'4'</span>, args, kwargs)</div><div class="line">        cls.c = <span class="number">4</span></div><div class="line">        <span class="keyword">return</span> super().__new__(cls)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">e</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></div><div class="line">        print(<span class="string">'5'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, d)</span>:</span></div><div class="line">        self.d = d</div><div class="line">        print(<span class="string">'6'</span>)</div><div class="line"></div><div class="line"></div><div class="line">b = B(<span class="number">6</span>)</div><div class="line">print(hasattr(b, <span class="string">'a'</span>))</div><div class="line">print(b.b)</div><div class="line">print(b.c)</div><div class="line">print(b.d)</div><div class="line">print(hasattr(b, <span class="string">'e'</span>))</div></pre></td></tr></table></figure>
<p>å¯ä»¥å°è¯•æ³¨é‡Šæ‰B(12)ï¼ŒAä¾æ—§ä¼šè¢«æ‰“å°ï¼Œè§‚å¯Ÿargså’Œkwargsçš„è¾“å‡ºã€‚å¯¹æ¯”Aå’ŒBçš„ä¸åŒï¼Œä½ ä¼šå‘ç°metaclassçš„ç”¨å¤„ï¼Œ<strong>ä½¿ç”¨metaclassçš„æ—¶å€™ï¼ŒBçš„æ‰€æœ‰å±æ€§ä¼šè¢«å½“åšå‚æ•°ä¼ é€’ç»™A</strong>ï¼Œé‚£ä¹ˆæˆ‘ä»¬èƒ½å¤Ÿå°†è¿™äº›ä¼ è¿‡æ¥çš„å‚æ•°é¢„å¤„ç†ç„¶åæŒ‚åœ¨åˆ°ç±»çš„å±æ€§ä¸Šé¢è¿”å›ã€‚ä»¥ä¾›åç»­Bä½¿ç”¨ã€‚ç›®å‰åœ¨æˆ‘é‡åˆ°çš„webå¼€å‘ä¸­ä½“ç°çš„æœ€å¸¸è§çš„å°±æ˜¯ORMå’Œè¡¨å•éªŒè¯ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“<code>__new__</code>åˆ›å»ºä¸€ä¸ªå¯¹è±¡ã€‚<code>__init__</code>å¯¹åˆ›å»ºåçš„å¯¹è±¡è¿›è¡Œèµ‹å€¼ç­‰åˆå§‹åŒ–æ“ä½œã€‚ä»–ä»¬çš„ä¼ å‚argså’Œkwargsæ˜¯æ²¡æœ‰åŒºåˆ«çš„ã€‚ä½†æ˜¯åœ¨<code>__new__</code>é˜¶æ®µï¼Œèƒ½å¤Ÿå¯¹attrsè¿›è¡Œä¿®æ”¹ä»è€Œhookå¯¹è±¡çš„åˆ›å»ºæµç¨‹ï¼Œé™¤æ­¤ä¹‹å¤–æ„Ÿè§‰åªèƒ½ç”¨newä¸èƒ½ç”¨initçš„åœºæ™¯æ˜¯å¾ˆå°‘çš„ã€‚ç›®å‰çœ‹åˆ°çš„ä¾‹å­è®°å¾—çš„å¯èƒ½åªæœ‰ç”¨newå®ç°å•ä¾‹ã€‚å¯¹äºå†…ç½®ä¸å¯å˜å¯¹è±¡æ¯”å¦‚intç”¨newå˜æ›´åˆå§‹åŒ–é€»è¾‘</p>
<p>æœ€åä¾‹ä¸¾ä¸€ä¸ªORMçš„ä¾‹å­(è§å‚è€ƒ)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Field</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, column_type)</span>:</span></div><div class="line">        self.name = name</div><div class="line">        self.column_type = column_type</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StringField</span><span class="params">(Field)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></div><div class="line">        super(StringField, self).__init__(name, <span class="string">'vachar(100)'</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelMetaclass</span><span class="params">(type)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, name, bases, attrs)</span>:</span></div><div class="line">        <span class="keyword">if</span> name != <span class="string">'Model'</span>:</div><div class="line">            mappings = &#123;k: v.name <span class="keyword">for</span> k, v <span class="keyword">in</span> attrs.items() <span class="keyword">if</span> isinstance(v, Field)&#125;</div><div class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> mappings.keys():</div><div class="line">                attrs.pop(k)</div><div class="line">            attrs[<span class="string">'__mappings__'</span>] = mappings</div><div class="line">            attrs[<span class="string">'__table__'</span>] = name</div><div class="line"></div><div class="line">        <span class="keyword">return</span> type.__new__(cls, name, bases, attrs)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Model</span><span class="params">(dict, metaclass=ModelMetaclass)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, **kwargs)</span>:</span></div><div class="line">        super().__init__(**kwargs)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, key)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">return</span> self[key]</div><div class="line">        <span class="keyword">except</span> KeyError:</div><div class="line">            <span class="keyword">raise</span> AttributeError(<span class="string">r"'Model' object has no attribute &#123;key&#125;"</span>.format(key=key))</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span></div><div class="line">        self[key] = value</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(self)</span>:</span></div><div class="line">        fields, params, args = [], [], []</div><div class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> self.__mappings__.items():</div><div class="line">            fields.append(v)</div><div class="line">            params.append(<span class="string">'?'</span>)</div><div class="line">            args.append(getattr(self, k, <span class="keyword">None</span>))</div><div class="line">        sql = <span class="string">'insert into &#123;table_name&#125; (&#123;fields&#125;) values (&#123;values&#125;)'</span>.format(table_name=self.__table__,</div><div class="line">                                                                             fields=<span class="string">','</span>.join(fields),</div><div class="line">                                                                             values=<span class="string">','</span>.join(params))</div><div class="line">        print(<span class="string">'SQL: &#123;sql&#125;'</span>.format(sql=sql))</div><div class="line">        print(<span class="string">'ARGS: &#123;args&#125;'</span>.format(args=args))</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserModel</span><span class="params">(Model)</span>:</span></div><div class="line">    user_name = StringField(<span class="string">'username'</span>)</div><div class="line">    email = StringField(<span class="string">'email'</span>)</div><div class="line">    password = StringField(<span class="string">'password'</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    user = UserModel(user_id=<span class="number">123</span>, user_name=<span class="string">'hhh'</span>, email=<span class="string">'a@a.a'</span>, password=<span class="string">'asdfa'</span>, x=<span class="string">'y'</span>)</div><div class="line">    user.save()</div><div class="line">    </div></pre></td></tr></table></figure>    </p>
<p>ä¸‹ç¯‡ä¼šåˆ†æmetaclassåœ¨WTFormsä¸­çš„åº”ç”¨</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.ionelmc.ro/2015/02/09/understanding-python-metaclasses/">Understanding Python metaclasses æ›´è¯¦ç»†çš„ä»‹ç»</a><br><a href="http://www.jianshu.com/p/9dfa40bf2a62">pythonå®ç°ORM</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;metaclassä¸€ç›´è¢«å½’ç±»ä¸ºæ¯”è¾ƒé«˜æ·±çš„å†…å®¹ï¼Œå†™ä»£ç ä¹Ÿå¾ˆå°‘ä¼šä½¿ç”¨åˆ°metaclassã€‚ç„¶è€Œå¦‚æœä½ çœ‹æŸäº›é¡¹ç›®çš„æºä»£ç ï¼Œè¿˜æ˜¯ä¼šè¢«ç»•åˆ°metaclassé‡Œé¢å»ã€‚èŠ±ä¸€äº›æ—¶é—´ç†è§£ä¸‹metaclasså¾ˆæœ‰ç”¨çš„ï¼Œå› ä¸ºå®ƒçœŸçš„èƒ½æŠŠä¸€æ¡çº¿ä¸²èµ·æ¥ï¼Œç¯ç¯ç›¸æ‰£ï¼Œæ‰€ä»¥æœ‰æ‰å®çš„åŸºç¡€æ˜¯æŒæ¡metaclassçš„å‰æï¼Œæœ¬æ–‡ä»£ç åŸºäºpython3.5&lt;/p&gt;
    
    </summary>
    
      <category term="python" scheme="https://www.zoulei.net/categories/python/"/>
    
    
  </entry>
  
  <entry>
    <title>tornadoè¡¨å•éªŒè¯</title>
    <link href="https://www.zoulei.net/2017/03/23/tornado_wtforms/"/>
    <id>https://www.zoulei.net/2017/03/23/tornado_wtforms/</id>
    <published>2017-03-23T12:17:29.000Z</published>
    <updated>2017-03-23T12:41:33.000Z</updated>
    
    <content type="html"><![CDATA[<p>å·¥ä½œä¸­çœ‹åˆ°æœ‰ä¸€äº›ä¸å¥½çš„ä»£ç ï¼Œæƒ³äº†ä¸ªåŠæ³•ä¼˜åŒ–äº†ä¸€ä¸‹ï¼Œäºæ˜¯æœ‰äº†è¿™ç¯‡åšæ–‡ã€‚æœ¬æ–‡ä¸»è¦è®²tornadoçš„è¡¨å•éªŒè¯ï¼Œä½¿ç”¨çš„æ˜¯wtformsã€‚æœ¬æ–‡æœ€ç»ˆè¾¾åˆ°çš„æ•ˆæœæ˜¯ä½¿ç”¨self.xxè·å–postä¼ é€’è¿‡æ¥çš„å€¼ã€‚</p>
<a id="more"></a>
<p>é¦–å…ˆæ˜¯å°†wtformsåµŒå…¥tornadoã€‚åšæ³•å¯ä»¥å‚è€ƒ<a href="https://github.com/truemped/tornadotools/blob/master/tornadotools/forms.py">https://github.com/truemped/tornadotools/blob/master/tornadotools/forms.py</a>ï¼Œæˆ‘çš„åšæ³•ç±»ä¼¼ï¼Œå¯ä»¥çœ‹æœ€ä¸‹é¢çš„ä»£ç ã€‚è¿™æ ·ç»§æ‰¿ä¸€ä¸‹å°±èƒ½å¤Ÿä½¿ç”¨wtformsçš„è¡¨å•éªŒè¯äº†ã€‚èƒ½å¤Ÿä½¿ç”¨çš„ç»“æœæ˜¯å¾ˆå¤šäººå†™è¿™æ ·çš„ä»£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">self.xx1 = self.form.xx1.data</div><div class="line">self.xx2 = self.form.xx2.data</div><div class="line">self.xx3 = self.form.xx3.data</div><div class="line">:</div><div class="line">:</div></pre></td></tr></table></figure>
<p>ç„¶åè¿™æ ·å†™äº†20è¡Œ(ä¸é»‘ï¼Œé¡¹ç›®é‡ŒçœŸæœ‰è¿™æ ·çš„)ã€‚å†™çš„äººä¹Ÿç¡®å®æ˜¯å¾ˆè®¤çœŸå•Šï¼ï¼Œæ”¹è¿›çš„æ–¹æ³•å¾ˆç®€å•ã€‚è°ƒç”¨self.xx1çš„æ—¶å€™è‡ªåŠ¨å–å€¼self.form.xx1.dataã€‚èƒ½åšæˆè¿™æ ·çš„æ–¹æ³•æŒºå¤šã€‚å¾ˆå¤šæ—¶å€™ä¼šå¯¼è‡´self.xxxä½¿ç”¨IDEæ— æ³•è¡¥å…¨ã€‚æˆ‘ä¸ªäººè®¤ä¸ºå¥½çš„ä»£ç è‚¯å®šèƒ½å¤Ÿæ–¹ä¾¿çš„è¡¥å…¨å’Œæç¤ºï¼Œæ¯•ç«Ÿè¿™æ ·èƒ½å®æ‰“å®çš„æå‡ç ä»£ç çš„å¿ƒæƒ…ï¼Œè¯•æƒ³ä¸€ä¸‹ä½ è¦è¾“å…¥20ä¸ªå•è¯ï¼Œå¾ˆå¯èƒ½ä¸€ä¸å°å¿ƒå°±è¾“å…¥é”™è¯¯äº†ã€‚æ”¹è¿›çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨<code>__getattribute__</code>,é…åˆç±»ç»§æ‰¿ï¼Œå…¼é¡¾è‡ªåŠ¨è¡¥å…¨ä¹Ÿä¸ç”¨è·‘å»å†™self.form.xxx.dataäº†</p>
<ol>
<li><code>__getattr__</code>ï¼Œå½“å±æ€§ä¸å­˜åœ¨çš„æ—¶å€™ä¼šè°ƒç”¨</li>
<li><code>__getattribute__</code>,æ— è®ºå±æ€§æ˜¯å¦å­˜åœ¨éƒ½ä¼šè¢«è°ƒç”¨</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">import tornado.ioloop</div><div class="line">import tornado.web</div><div class="line"></div><div class="line">from wtforms import validators, fields</div><div class="line">from wtforms import Form</div><div class="line">from wtforms.fields.core import UnboundField</div><div class="line"></div><div class="line"></div><div class="line">class MultiDict(dict):</div><div class="line">    def getlist(self, key):</div><div class="line">        return self[key]</div><div class="line"></div><div class="line">    def setlist(self, key, value):</div><div class="line">        self[key] = value</div><div class="line"></div><div class="line"></div><div class="line">class BaseForm(Form):</div><div class="line">    def __init__(self, handler=None, obj=None, prefix=&apos;&apos;, **kwargs):</div><div class="line">        if handler is None:</div><div class="line">            return</div><div class="line">        formdata = MultiDict()</div><div class="line">        if handler.request.method == &apos;POST&apos;:</div><div class="line">            for name in handler.request.arguments.keys():</div><div class="line">                formdata.setlist(name, handler.get_arguments(name))</div><div class="line">        else:</div><div class="line">            for name in handler.request.query_arguments.keys():</div><div class="line">                formdata.setlist(name, handler.request.query_arguments[name])</div><div class="line">        Form.__init__(self, formdata, obj=obj, prefix=prefix, **kwargs)</div><div class="line"></div><div class="line"></div><div class="line">class LoginForm(BaseForm):</div><div class="line">    email = fields.StringField(</div><div class="line">        validators=[validators.Email(), validators.required(), validators.length(min=5, max=64)])</div><div class="line">    password = fields.PasswordField(validators=[validators.required()])</div><div class="line"></div><div class="line"></div><div class="line">class MainHandler(tornado.web.RequestHandler, LoginForm):</div><div class="line">    def __getattribute__(self, item):</div><div class="line">        ret = object.__getattribute__(self, item)</div><div class="line">        if isinstance(ret, UnboundField):</div><div class="line">            form = object.__getattribute__(self, &apos;form&apos;)</div><div class="line">            return getattr(form, item).data</div><div class="line">        return ret</div><div class="line"></div><div class="line">    def post(self):</div><div class="line">        self.form = LoginForm(self)</div><div class="line">        print(self.email)</div><div class="line">        self.write(&quot;Hello, world&quot;)</div><div class="line"></div><div class="line"></div><div class="line">def make_app():</div><div class="line">    return tornado.web.Application([</div><div class="line">        (r&quot;/&quot;, MainHandler),</div><div class="line">    ])</div><div class="line"></div><div class="line"></div><div class="line">if __name__ == &quot;__main__&quot;:</div><div class="line">    app = make_app()</div><div class="line">    app.listen(8888)</div><div class="line">    tornado.ioloop.IOLoop.current().start()</div></pre></td></tr></table></figure>
<p>å®Œç¾è§£å†³é—®é¢˜,å¿ƒæƒ…ç¬é—´èˆ’ç•…äº†â”‘(ï¿£Ğ” ï¿£)â”</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å·¥ä½œä¸­çœ‹åˆ°æœ‰ä¸€äº›ä¸å¥½çš„ä»£ç ï¼Œæƒ³äº†ä¸ªåŠæ³•ä¼˜åŒ–äº†ä¸€ä¸‹ï¼Œäºæ˜¯æœ‰äº†è¿™ç¯‡åšæ–‡ã€‚æœ¬æ–‡ä¸»è¦è®²tornadoçš„è¡¨å•éªŒè¯ï¼Œä½¿ç”¨çš„æ˜¯wtformsã€‚æœ¬æ–‡æœ€ç»ˆè¾¾åˆ°çš„æ•ˆæœæ˜¯ä½¿ç”¨self.xxè·å–postä¼ é€’è¿‡æ¥çš„å€¼ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="python" scheme="https://www.zoulei.net/categories/python/"/>
    
    
  </entry>
  
  <entry>
    <title>sshç«¯å£æ˜ å°„</title>
    <link href="https://www.zoulei.net/2017/03/12/ssh-port-forward/"/>
    <id>https://www.zoulei.net/2017/03/12/ssh-port-forward/</id>
    <published>2017-03-12T03:40:30.000Z</published>
    <updated>2017-06-01T07:30:20.000Z</updated>
    
    <content type="html"><![CDATA[<p>å¼€å‘ä¸­ç»å¸¸ä¼šéœ€è¦ç”¨åˆ°ç«¯å£æ˜ å°„è¿™ç§äº‹æƒ…ã€‚ä»¥å‰è§‰å¾—å¥½å®¹æ˜“æ··æ·†ã€‚å…¶å®ç”¨ä¹ æƒ¯äº†å°±ä¼šå‘ç°å¦‚æ­¤ç®€å•â”‘(ï¿£Ğ” ï¿£)â”ï¼Œä¸‹é¢è”ç³»åˆ°æˆ‘æ—¥å¸¸ä½¿ç”¨åˆ°çš„ä¸€äº›sshæ˜ å°„å®ä¾‹è®²è§£ä¸€ä¸‹</p>
<a id="more"></a>
<ol>
<li><p>-Då‚æ•°ï¼Œæä¾›ä¸€ä¸ªsocket5çº§åˆ«çš„ä»£ç†ã€‚</p>
<p> è¿™ä¸ªåœ¨å¾ˆå¤šå¹´ä»¥å‰ç¿»å¢™çš„æ—¶å€™è¿˜æ˜¯å¾ˆå¥½ç”¨çš„ã€‚ä¸è¿‡éƒ½å·²ç»æˆä¸ºäº†å†å²ã€‚æœ‰ä»£ç†ä½¿ç”¨ç»éªŒçš„å¼€å‘è€…éƒ½èƒ½å¾ˆå¿«ç†è§£è¿™ä¸ªç©æ„</p>
</li>
<li><p>-L(local forward)æœ¬åœ°è½¬å‘</p>
<p> æ¯”å¦‚ä½ ç°åœ¨éœ€è¦è¿æ¥åˆ°æ­£å¼ç¯å¢ƒçš„æ•°æ®åº“,é‚£ä¹ˆä½ ä¸éœ€è¦å…ˆsshåˆ°æ­£å¼ç¯å¢ƒå†è¾“å…¥æ•°æ®åº“å‘½ä»¤ã€‚æˆ‘çš„åšæ³•æ˜¯é€‰æ‹©ç”¨å›¾å½¢ç•Œé¢æŸ¥çœ‹æ•°æ®åº“ã€‚å‘½ä»¤æ˜¯è¿™æ ·çš„ </p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh -L  6789:192.168.10.10:5432 prod</div></pre></td></tr></table></figure>
<p> å«ä¹‰å°±æ˜¯å°†æœ¬åœ°6789ç«¯å£æ¥å—åˆ°çš„è¯·æ±‚è½¬å‘åˆ°ç”Ÿäº§ç¯å¢ƒprodä¸Šé¢çš„192.168.10.10:5432ï¼Œè¿™æ ·æœ¬åœ°GUIæ•°æ®åº“ç®¡ç†ç¨‹åºå°±èƒ½å¤Ÿç›´æ¥è¿æ¥æœ¬åœ°6789ç«¯å£æ˜¾ç¤ºçº¿ä¸Šæ•°æ®äº†ã€‚å¯ä»¥çœ‹å‡ºå®ƒçš„ä½œç”¨å°±æ˜¯å°†æœ¬åœ°ç«¯å£çš„è¯·æ±‚è½¬å‘çš„æœåŠ¡å™¨ä¸Šé¢</p>
</li>
<li><p>-R(Remote forward)è¿œç¨‹è½¬å‘</p>
<p> è¿™ä¸ªå°±æ˜¯å’Œæœ¬åœ°è½¬å‘ç›¸åã€‚åœ¨è¿æ¥çš„æœåŠ¡å™¨ä¸Šæ‰“å¼€ä¸€ä¸ªç«¯å£ï¼Œæ˜ å°„åˆ°è‡ªå·±çš„ç«¯å£ã€‚æ­¤æ—¶æ•°æ®æµæ˜¯æœåŠ¡å™¨ç«¯å£æ¥æ”¶åˆ°çš„æ•°æ®ä¼ åˆ°äº†æœ¬åœ°ã€‚æ¯”å¦‚ä½ éœ€è¦ä¸€ä¸ªå…¬ç½‘ip(æ˜¾ç„¶æˆ‘ä»¬çš„åŠå…¬ç¯å¢ƒéƒ½æ˜¯æ²¡æœ‰å…¬ç½‘ipçš„)æ¥è°ƒè¯•ä½ çš„webåº”ç”¨ï¼Œæ¯”å¦‚ä½ æœ¬åœ°å†™äº†ä¸ªwebç¨‹åºç›‘å¬8989ç«¯å£ï¼Œä½ è¿œç¨‹æœåŠ¡å™¨ä¸Šæœ‰å…¬ç½‘ipã€‚ä½ éœ€è¦æŠŠwebç¨‹åºä¸´æ—¶åˆ†äº«åˆ°å…¬ç½‘ç»™åˆ«äººå°è¯•ä½¿ç”¨ã€‚æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh -R 4321:127.0.0.1:8989 prod</div></pre></td></tr></table></figure>
<p> è¿™æ ·åˆ«äººè®¿é—®prod_ip:4321å°±ä¼šæ˜ å°„åˆ°ä½ æœ¬åœ°çš„8989ç«¯å£ä¸Šã€‚</p>
</li>
<li><p>åŠ©è®°</p>
<p> åˆšå¼€å§‹å¯èƒ½è§‰å¾—ç«¯å£æ¯”è¾ƒå®¹æ˜“æ··æ·†ã€‚åªéœ€è¦è®°ä½xx:xxï¼Œå‰é¢æ˜¯å…¥å£ï¼Œåé¢æ˜¯å‡ºå£ã€‚æœ¬åœ°è½¬å‘çš„æ—¶å€™æ•°æ®æ˜¯ä»æœ¬åœ°å‘åˆ°è¿œç¨‹ã€‚æ‰€ä»¥6789æ˜¯æœ¬åœ°ç«¯å£ã€‚è¿œç¨‹è½¬å‘çš„æ—¶å€™æ•°æ®æ˜¯ä»è¿œç¨‹å‘åˆ°æœ¬åœ°ã€‚æ‰€ä»¥8989æ˜¯æœ¬åœ°ç«¯å£</p>
</li>
<li><p>è¾…åŠ©å‚æ•°åŠå·¥å…·</p>
<p> å‡å¦‚ä½ åªéœ€è¦ç«¯å£æ˜ å°„ä¸éœ€è¦è¿›å…¥ç»ˆç«¯æ‰§è¡Œå‘½ä»¤ã€‚å¯ä»¥å¢åŠ -Nfå‚æ•°ï¼Œ-Nä¸ºä¸è¿›å…¥äº¤äº’å¼ç»ˆç«¯ã€‚fä¸ºåå°æ‰§è¡Œã€‚å‡å¦‚ä½ éœ€è¦é•¿æœŸä½¿ç”¨ï¼Œé‚£å°±ä½¿ç”¨autosshï¼Œå’Œsshä¸€ä¸ªå¥—è·¯ã€‚å°±ä¸ä¸¾ä¾‹äº†</p>
</li>
</ol>
<h2 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h2><p>å…¶å®æœ¬åœ°è½¬å‘å’Œè¿œç¨‹è½¬å‘å·²ç»å½¢æˆäº†ä¸€ä¸ªåŒå‘çš„æ•°æ®æµåŠ¨ã€‚è¿™æ ·æˆ‘ä»¬å°±èƒ½å¤Ÿå®ç°ä¸€äº›çœ‹èµ·æ¥å¾ˆé«˜çº§çš„åŠŸèƒ½ã€‚æ¯”å¦‚è®¿é—®å†…ç½‘æœºå™¨(æ²¡æœ‰å…¬ç½‘ipï¼Œä¸èƒ½å¤Ÿè¢«ç›´æ¥è®¿é—®åˆ°)ã€‚åªè¦å†…ç½‘æœºå™¨èƒ½å¤Ÿä½¿ç”¨sshè®¿é—®åˆ°å¤–éƒ¨æœºå™¨ï¼Œè€Œè¿™å°å¤–éƒ¨æœºå™¨æˆ‘ä»¬èƒ½å¤Ÿè¿›è¡Œè®¿é—®ã€‚é‚£ä¹ˆæ­¤æ—¶å°±æ˜¯æ­é…æœ¬åœ°è½¬å‘å’Œè¿œç¨‹è½¬å‘çš„æ—¶å€™äº†ã€‚(æ³¨æ„ï¼Œå¦‚æœå¤–éƒ¨æœºå™¨èƒ½å¤Ÿå’Œå†…éƒ¨æœºå™¨åŒå‘è®¿é—®é‚£ä¹ˆä¼šæ›´ç®€å•)</p>
<p>æ€è·¯å°±æ˜¯ä½¿ç”¨å†…ç½‘æœºå™¨è®¿é—®å¤–éƒ¨æœºå™¨ï¼Œä½¿ç”¨è¿œç¨‹ç«¯å£æ˜ å°„ï¼Œå°†æœ¬æœºçš„22ç«¯å£æ˜ å°„åˆ°å¤–éƒ¨æœºå™¨çš„ä»»ä¸€ç«¯å£ä¸Šã€‚ä¹‹ååœ¨å¤–éƒ¨æœºå™¨å°±èƒ½å¤Ÿä½¿ç”¨ssh localhost -p xxè®¿é—®åˆ°å†…ç½‘æœºå™¨äº†ã€‚ç„¶è€Œè¿™éœ€è¦æˆ‘ä»¬å…ˆç™»å½•åˆ°å¤–éƒ¨æœºå™¨å†ä½¿ç”¨localhostç™»é™†åˆ°å†…ç½‘ã€‚æ­¤æ—¶æˆ‘ä»¬å¯ä»¥æ›´ç®€å•çš„ä½¿ç”¨~/.ssh/configé…ç½®æ–‡ä»¶å®Œæˆ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Host demo</div><div class="line">    user    ficapy</div><div class="line">    HostName    localhost</div><div class="line">    ProxyCommand ssh prod -W %h:7890</div></pre></td></tr></table></figure>
<p>ssh demoåä¼šå…ˆè¿æ¥å¤–éƒ¨æœºå™¨prod,å†å°†è¯·æ±‚è½¬å‘åˆ°localhost:7890ä¸Šå®Œæˆå¯¹å†…éƒ¨æœºå™¨çš„ç™»é™†ã€‚<br>å‡å¦‚å†…éƒ¨æœºå™¨å’Œå¤–éƒ¨æœºå™¨å¯ä»¥åŒå‘è®¿é—®ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦è¿œç¨‹ç«¯å£è½¬å‘ï¼Œåªéœ€è¦è¿™æ ·</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Host demo</div><div class="line">    User ficapy</div><div class="line">    HostName å†…ç½‘æœºå™¨ip</div><div class="line">    ProxyCommand ssh prod -W %h:%p</div></pre></td></tr></table></figure>
<h3 id="æ›´å‘çˆ¹çš„æƒ…å†µ"><a href="#æ›´å‘çˆ¹çš„æƒ…å†µ" class="headerlink" title="æ›´å‘çˆ¹çš„æƒ…å†µ"></a>æ›´å‘çˆ¹çš„æƒ…å†µ</h3><p>åœ¨ä¸¥æ ¼çš„ç¯å¢ƒä¸‹ï¼Œå‡å¦‚ç¦ç”¨äº†sshåè®®ã€‚ä¸å…è®¸ä»å†…éƒ¨sshåˆ°å¤–éƒ¨ã€‚åªå…è®¸å¯¹å¤–å‘é€httpã€httpsè¯·æ±‚ã€‚æ­¤æ—¶sshã€ngrok1.7ç‰ˆæœ¬ã€frpè¿™ç§æ˜¯æ— æ³•ä½¿ç”¨çš„ã€‚æ¨èä½¿ç”¨pagekiteè‡ªå»ºï¼Œäº¦æˆ–è€…ä½¿ç”¨é€Ÿåº¦æš´æ…¢çš„ngrokä»˜è´¹ç‰ˆ<br>é‡åˆ°è¿‡ä¸€ä¸ªé—®é¢˜ã€‚æµ‹è¯•æœºä¸Šéœ€è¦è®¿é—®10.19.2.96çš„1234å’Œ5053ç«¯å£ã€‚å¤„ç†æ–¹æ¡ˆæ˜¯å°†10.19.2.96æ­¤ipç»‘å®šåˆ°ç½‘å¡ä¸Šé¢é…åˆsshè½¬å‘ï¼Œ<code>sudo ifconfig en0 10.19.15.34 netmask 255.255.255.0 up</code>ã€‚ç„¶å<code>ssh -NL 10.19.15.34:1234:10.19.15.34:1234 -L 10.19.15.34:5053:10.19.15.34:5053 dev</code>å°±å¯ä»¥äº†</p>
<h3 id="æ”¶é›†çš„sshé…ç½®æ–‡ä»¶ï¼ˆæ›´å¥½çš„è¿æ¥åˆ°è¿œç«¯æœåŠ¡å™¨ï¼‰"><a href="#æ”¶é›†çš„sshé…ç½®æ–‡ä»¶ï¼ˆæ›´å¥½çš„è¿æ¥åˆ°è¿œç«¯æœåŠ¡å™¨ï¼‰" class="headerlink" title="æ”¶é›†çš„sshé…ç½®æ–‡ä»¶ï¼ˆæ›´å¥½çš„è¿æ¥åˆ°è¿œç«¯æœåŠ¡å™¨ï¼‰"></a>æ”¶é›†çš„sshé…ç½®æ–‡ä»¶ï¼ˆæ›´å¥½çš„è¿æ¥åˆ°è¿œç«¯æœåŠ¡å™¨ï¼‰</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Host	   *</div><div class="line">	Port          		 22</div><div class="line">    User          		 root</div><div class="line">    IdentityFile  		 ~/.ssh/id_rsa</div><div class="line">    ConnectTimeout 		15</div><div class="line">    ConnectionAttempts 	3</div><div class="line">    ServerAliveInterval 	20</div><div class="line">    ServerAliveCountMax 	5		</div><div class="line">    # å¤šæ¡è¿æ¥å…±äº«</div><div class="line">    ControlMaster   	auto</div><div class="line">    ControlPath     	/tmp/ssh_mux_%h_%p_%r</div><div class="line">    # é•¿è¿æ¥(é€€å‡ºæœåŠ¡å™¨åè¿æ¥ä¾ç„¶å¯é‡ç”¨)</div><div class="line">    ControlPersist  	4h</div><div class="line">    # å‡å°‘å»¶è¿Ÿ</div><div class="line">    GSSAPIAuthentication 	no</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼€å‘ä¸­ç»å¸¸ä¼šéœ€è¦ç”¨åˆ°ç«¯å£æ˜ å°„è¿™ç§äº‹æƒ…ã€‚ä»¥å‰è§‰å¾—å¥½å®¹æ˜“æ··æ·†ã€‚å…¶å®ç”¨ä¹ æƒ¯äº†å°±ä¼šå‘ç°å¦‚æ­¤ç®€å•â”‘(ï¿£Ğ” ï¿£)â”ï¼Œä¸‹é¢è”ç³»åˆ°æˆ‘æ—¥å¸¸ä½¿ç”¨åˆ°çš„ä¸€äº›sshæ˜ å°„å®ä¾‹è®²è§£ä¸€ä¸‹&lt;/p&gt;
    
    </summary>
    
      <category term="DevOps" scheme="https://www.zoulei.net/categories/DevOps/"/>
    
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨acme.shå¿«é€Ÿæ­å»ºhttps</title>
    <link href="https://www.zoulei.net/2017/03/05/acme.sh_quick_start/"/>
    <id>https://www.zoulei.net/2017/03/05/acme.sh_quick_start/</id>
    <published>2017-03-05T09:19:27.000Z</published>
    <updated>2017-07-29T15:18:25.000Z</updated>
    
    <content type="html"><![CDATA[<p>letsencryptåˆšå‡ºæ¥çš„æ—¶å€™å†™äº†ä¸€ç¯‡å®ƒçš„è®¤è¯ç­¾å‘åŸç†ã€‚è‡ªé‚£è¿‡åå°±æ²¡æœ‰çœŸæ­£çš„å»å®è·µè¿‡äº†ã€‚æœ€è¿‘æœ‰éƒ¨ç½²HTTPSçš„éœ€æ±‚å°±åˆè€ƒå¯Ÿäº†ä¸€ç•ªã€‚å‘ç°acme.shç°å¸¸å¥½ç”¨å•Š~~~ï¼Œæ¥ä¸€ç¯‡æ°´æ–‡è®°å½•ä¸‹æµ‹è¯•éƒ¨ç½²HTTPSçš„å®Œæ•´è¿‡ç¨‹å§</p>
<a id="more"></a>
<p><a href="media/README-1.md">README</a></p>
<p>é¦–å…ˆæœ‰2ç§è®¤è¯æ–¹å¼ï¼Œç”Ÿæˆä¸€ä¸ªæŒ‡å®šçš„æ–‡ä»¶è®©letsencryptè®¿é—®ã€‚æˆ–è€…ç”Ÿæˆä¸€ä¸ªDNSè®°å½•è®©letsencryptè®¿é—®ã€‚ç¬¬ä¸€ç§æ–¹å¼æœ‰éå¸¸å¤§çš„å±€é™æ€§ã€‚æ¯”å¦‚ä½ çš„80ç«¯å£æ­£åœ¨è¢«ä½¿ç”¨ã€‚é‚£ä¹ˆä½ éœ€è¦å…ˆè®¾ç½®DNSè§£æï¼Œå†ä¿®æ”¹ä¸‹nginxçš„é…ç½®è®©ç½‘å€èƒ½å¤Ÿè¢«æ­£å¸¸è®¿é—®åˆ°ã€‚è¿™å°±æ˜¾å¾—å¾ˆéº»çƒ¦äº†ã€‚ä¸»æµçš„DNSæœåŠ¡æä¾›å•†éƒ½å·²ç»æä¾›äº†APIæ¥å£ï¼Œä½¿ç”¨DNSçš„ä¼˜åŠ¿å°±æ˜¯ï¼š</p>
<ol>
<li>ä»»ä½•ç”µè„‘éƒ½èƒ½ç›´æ¥ç”Ÿæˆè¯ä¹¦æ–‡ä»¶ï¼Œä¸éœ€è¦ä¾èµ–æœ¬æœºèƒ½å¤Ÿè¢«å¤–éƒ¨è®¿é—®</li>
<li>ä¸éœ€è¦å¯¹nginxåšä»»ä½•è®¾ç½®</li>
</ol>
<p>ä»¥ä¸‹è®°å½•ä¸‹æˆ‘ä½¿ç”¨ä¸€ä¸ªä¸´æ—¶çš„digitaloceanæœºå™¨ä»0å¼€å§‹éƒ¨ç½²httpsçš„æ­¥éª¤(å‡è®¾æµ‹è¯•urlä¸ºssl.ficapy.com,æ“ä½œç¯å¢ƒä¸ºosx)</p>
<p>æˆ‘è¿˜æ˜¯è¦å®‰åˆ©ä¸‹ï¼Œä¸´æ—¶ä½¿ç”¨digitaloceanæµ‹è¯•ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·tugboatç°å¸¸å¥½å•Š</p>
<ol>
<li><p>å®‰è£…tugboatç”¨å‘½ä»¤è¡Œå¿«é€Ÿåˆ›å»ºæœºå™¨ä»¥åŠæµ‹è¯•å®Œæˆååˆ é™¤</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gem install tugboat</div></pre></td></tr></table></figure>
</li>
<li><p>å°†digitaloceançš„apiå†™å…¥è®©tugboatèƒ½å¤Ÿæ­£å¸¸ä½¿ç”¨,å¹¶æ‰§è¡Œä¸€äº›åˆå§‹åŒ–è®¾ç½®</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tugboat authorize</div></pre></td></tr></table></figure>
</li>
<li><p>æ ¹æ®åˆå§‹åŒ–é»˜è®¤è®¾ç½®åˆ›å»ºä¸€ä¸ªvps</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tugboat create temp</div></pre></td></tr></table></figure>
</li>
<li><p>sshç™»é™†</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tugboat ssh temp</div></pre></td></tr></table></figure>
</li>
<li><p>å®‰è£…acme.sh</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl https://get.acme.sh | sh</div></pre></td></tr></table></figure>
</li>
<li><p>å‚ç…§acme.shæ–‡æ¡£å°†dnsçš„apiä¿¡æ¯ä½œä¸ºç¯å¢ƒå˜é‡å†™å…¥(è®°å¾—æ‰§è¡Œsource ~/.bashrc)</p>
</li>
<li><p>ç”Ÿæˆè¯ä¹¦</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">acme.sh --issue --dns dns_cf -d ssl.ficapy.com --debug</div></pre></td></tr></table></figure>
</li>
<li><p>å°†è¯ä¹¦æ”¾ç½®åˆ°ä½ç½®å¹¶è®¾ç½®nginxé‡å¯å‘½ä»¤</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">acme.sh --installcert -d ssl.ficapy.com \</div><div class="line">           --keypath       /etc/nginx/ssl/ssl.ficapy.com.key  \</div><div class="line">           --fullchainpath /etc/nginx/ssl/ssl.ficapy.com.pem \</div><div class="line">           --reloadcmd     &quot;service nginx force-reload&quot;</div></pre></td></tr></table></figure>
</li>
<li><p>å¼ºåˆ¶æµ‹è¯•ç»­çº¦(è¯¥æ“ä½œä¼šè‡ªåŠ¨æ‰§è¡Œæ³¨å†Œè¿‡çš„äº‹ä»¶ï¼Œä¸€èˆ¬å°±æ˜¯é‡å¯nginxå’¯ï¼Œç»­çº¦keyæ˜¯ä¸ä¼šå˜çš„ï¼Œå˜çš„æ˜¯fullchain.ceræ–‡ä»¶)</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">acme.sh --renew-all --force</div></pre></td></tr></table></figure>
</li>
<li><p>ç”Ÿæˆdhparamæ–‡ä»¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl dhparam -out /etc/nginx/ssl/dhparam.pem 2048</div></pre></td></tr></table></figure>
</li>
<li><p>ä½¿ç”¨ç”Ÿæˆä¸€ä¸ªæ ‡å‡†çš„nginxé…ç½®æ–‡ä»¶å¹¶æ”¾å…¥/etc/nginx/site-enablesç›®å½•ï¼Œç¤ºä¾‹å¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">    server &#123;</div><div class="line">    listen 443 ssl;</div><div class="line"></div><div class="line">    server_name ssl.ficapy.com;</div><div class="line">    # certs sent to the client in SERVER HELLO are concatenated in ssl_certificate</div><div class="line">    ssl_certificate /etc/nginx/ssl/ssl.ficapy.com.pem;</div><div class="line">    ssl_certificate_key /etc/nginx/ssl/ssl.ficapy.com.key;</div><div class="line">    ssl_session_timeout 1d;</div><div class="line">    ssl_session_cache shared:SSL:50m;</div><div class="line"></div><div class="line"></div><div class="line">    # Diffie-Hellman parameter for DHE ciphersuites, recommended 2048 bits</div><div class="line">    ssl_dhparam /etc/nginx/ssl/dhparam.pem;</div><div class="line"></div><div class="line">    # intermediate configuration. tweak to your needs.</div><div class="line">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</div><div class="line">    ssl_ciphers &apos;ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS&apos;;</div><div class="line">    ssl_prefer_server_ciphers on;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>æœ€åå°±æ˜¯æµè§ˆå™¨è®¿é—®ä»¥ä¸‹æµ‹è¯•å®Œæ¯•å•¦ã€‚å¦‚æœå‡ºç°é”™è¯¯å¯ä»¥æŸ¥çœ‹nginxçš„æ—¥å¿—/var/log/error.logï¼Œè‚¯å®šæ˜¯å“ªä¸€æ­¥å‡ºé—®é¢˜å•¦ï¼Œæœ€åå°±æ˜¯æµ‹è¯•å®Œæ¯•ååˆ é™¤vpså•¦<code>tugboat destory temp</code></p>
</li>
</ol>
<p>é¢å¤–è¯´ä¸€ä¸‹å…¶ä»–çš„å§ã€‚æœ€å¼€å§‹æˆ‘è¯•è¿‡é˜¿é‡Œäº‘dnsçš„apiï¼Œç”¨çš„æ˜¯å­è´¦å·ã€‚ç»“æœå­è´¦å·æ˜¯æ— æ³•åŒ…å«(æ³¨æ„)dnsçš„æ“ä½œæƒé™çš„ï¼Œå°±æ€»æ˜¯å¤±è´¥ã€‚åæ¥ä¸ç”¨å­è´¦å·ï¼Œç›´æ¥ç”¨åŸè´¦å·çš„apiå¯†åŒ™å°±å®Œå…¨æ²¡é—®é¢˜å•¦~~~ã€‚å¦å¤–å„å¤§äº‘å¹³å°å¤§å¤šéƒ½æœ‰è´Ÿè½½å‡è¡¡å™¨ï¼Œç„¶åå¯ä»¥å¡«å†™httpsè¯ä¹¦ã€‚è¿™ç§å°±ä¸å¤ªé€‚åˆletsencryptè¿™ç§çŸ­æœŸè¯ä¹¦äº†ã€‚å¦åˆ™æ€»ä¸Šå»æ¢è¯ä¹¦ä¸è¢«éº»çƒ¦æ­»ã€‚å¦‚æœåœ¨è¿™ç§è´Ÿè½½å‡è¡¡å™¨ä¸Šä¸è®¾ç½®httpsè¯ä¹¦ã€‚é‚£ä¹ˆå°±éœ€è¦åœ¨è´Ÿè½½å‡è¡¡å™¨æ¯ä¸€å°æœºå™¨éƒ½è®¾ç½®ä¸Šhttpsè¯ä¹¦ï¼Œå—¯æƒ³æƒ³ä¹ŸæŒºå¤´å¤§å•Š~~~ï¼Œæ‰€ä»¥è¿™ç§è‡ªåŠ¨åŒ–æ–¹å¼åªæ¯”è¾ƒé€‚åˆåœ¨ä¸€å°æœºå™¨ä¸Šç”Ÿæˆå¹¶ç»´æŠ¤è¯ä¹¦</p>
<p>å†é¢å¤–ï¼Œå“ªä¸ªæ—¶å€™å†™ä¸ªAnsibleçš„playbookå°±å¥½å“’ï¼Œå¯èƒ½ä¼šæ›´åŠ æ–¹ä¾¿â”‘(ï¿£Ğ” ï¿£)â”</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://github.com/pearkes/tugboat">github tugboat</a><br><a href="https://mozilla.github.io/server-side-tls/ssl-config-generator/">mozilla ssl-config-generator</a><br><a href="https://ruby-china.org/topics/31983">ä½¿ç”¨ acme.sh ç»™ Nginx å®‰è£… Letâ€™ s Encrypt æä¾›çš„å…è´¹ SSL è¯ä¹¦</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;letsencryptåˆšå‡ºæ¥çš„æ—¶å€™å†™äº†ä¸€ç¯‡å®ƒçš„è®¤è¯ç­¾å‘åŸç†ã€‚è‡ªé‚£è¿‡åå°±æ²¡æœ‰çœŸæ­£çš„å»å®è·µè¿‡äº†ã€‚æœ€è¿‘æœ‰éƒ¨ç½²HTTPSçš„éœ€æ±‚å°±åˆè€ƒå¯Ÿäº†ä¸€ç•ªã€‚å‘ç°acme.shç°å¸¸å¥½ç”¨å•Š~~~ï¼Œæ¥ä¸€ç¯‡æ°´æ–‡è®°å½•ä¸‹æµ‹è¯•éƒ¨ç½²HTTPSçš„å®Œæ•´è¿‡ç¨‹å§&lt;/p&gt;
    
    </summary>
    
      <category term="DevOps" scheme="https://www.zoulei.net/categories/DevOps/"/>
    
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨pre-commitæ”¹è¿›ä»£ç é£æ ¼</title>
    <link href="https://www.zoulei.net/2017/03/04/pre_commit/"/>
    <id>https://www.zoulei.net/2017/03/04/pre_commit/</id>
    <published>2017-03-04T04:52:37.000Z</published>
    <updated>2017-03-04T10:44:07.000Z</updated>
    
    <content type="html"><![CDATA[<p>å¾ˆæ—©å°±ä½¿ç”¨è¿‡autopep8æ¥è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç ï¼Œä½¿ç”¨IDEçš„æ—¶å€™ä¹Ÿä¼šç»å¸¸ä½¿ç”¨æ ¼å¼åŒ–ä»£ç åŠŸèƒ½è®©ä»£ç æ›´ç¬¦åˆè§„èŒƒä¸€ç‚¹ã€‚å¯æ˜¯è¿™éƒ½ä¸æ˜¯è‡ªåŠ¨åŒ–çš„ï¼Œæˆ–è€…è¯´æ˜¯å¼ºåˆ¶çš„ã€‚ä¸ºäº†ä¿æŒå›¢é˜Ÿçš„è‰¯å¥½ä»£ç é£æ ¼æ„Ÿè§‰æ¯ä¸ªåŒäº‹åœ¨æäº¤ä»£ç ä¹‹å‰éƒ½è‡ªåŠ¨è¿›è¡Œæ ¼å¼åŒ–æˆ–è€…é£æ ¼æ£€æŸ¥æ˜¯ä¸€ä¸ªä¸é”™çš„ä¸»æ„ï¼Œäºæ˜¯æ‰¾åˆ°äº†<a href="http://pre-commit.com/">pre-commit</a></p>
<p>åŸç†ä¹Ÿè¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œgitè‡ªèº«æä¾›äº†ä¸€äº›hookåŠŸèƒ½ï¼ŒæŸ¥çœ‹git/hooksç›®å½•ä¸‹ä¼šå‘ç°æœ‰ä¸€äº›sampleæ–‡ä»¶ï¼Œè¿™æ ·åœ¨æ‰§è¡Œcommitã€pushã€mergeçš„æ—¶å€™éƒ½æ˜¯å¯ä»¥è¿›è¡Œä¸€äº›ç®€å•çš„æ£€æŸ¥ç­‰åŠŸèƒ½çš„ã€‚ç„¶è€Œè¿™ä¸ªè®¾å®šæœ‰ä¸€ä¸ªç¼ºç‚¹ã€‚æ²¡ä¸€ä¸ªhookåªèƒ½æ‰§è¡Œä¸€ä¸ªæ–‡ä»¶çš„å†…å®¹ï¼Œæ‰€ä»¥è¦ä¹ˆå°†å„ç§åŠŸèƒ½æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œé¢ï¼Œæˆ–è€…æ¯ä¸ªåŠŸèƒ½éƒ½æ”¾ç½®åœ¨å„è‡ªçš„æ–‡ä»¶é‡Œé¢ã€‚æœ€åç”±ä¸€ä¸ªæ–‡ä»¶ä¸€èµ·æ‰§è¡Œã€‚pre-commitå°±è§£å†³äº†æˆ‘ä»¬çš„è¿™ä¸ªæ–‡ä»¶ã€‚å°†ä¸åŒçš„ä»»åŠ¡åˆ†å‰²æˆå•ä¸ªæ–‡ä»¶ã€‚ç„¶ååªéœ€è¦æ·»åŠ åˆ«äººå…±äº«çš„è„šæœ¬å°±èƒ½å¤Ÿå¾ˆå¿«çš„è¿›è¡Œcommit hookäº†ï¼Œç®€è¦ä½¿ç”¨æ–¹æ³•ä¾‹ä¸¾å¦‚ä¸‹</p>
<ol>
<li><p>åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ç¼–å†™é…ç½®æ–‡ä»¶(.pre-commit-config.yaml)</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-   repo: git://github.com/pre-commit/pre-commit-hooks</div><div class="line">    sha: v0.7.1</div><div class="line">    hooks:</div><div class="line">    -   id: trailing-whitespace</div><div class="line">    -   id: autopep8-wrapper</div></pre></td></tr></table></figure>
</li>
<li><p>è¿›è¡Œåˆå§‹åŒ–<code>pre-commit install</code>å°±å¯ä»¥äº†ï¼Œä»¥åæ¯æ¬¡æ‰§è¡Œcommitçš„æ—¶å€™å°±ä¼šæ‰§è¡Œæ£€æŸ¥ã€‚é…ç½®æ–‡ä»¶çš„repoåœ°å€å³ä¸ºç¬¦åˆpre-commitæ¡†æ¶çš„åœ°å€ï¼Œidå³ä¸ºæä¾›çš„åŠŸèƒ½~~ï¼Œè¿˜æ˜¯å¾ˆå¥½ç†è§£çš„ã€‚ä¾‹å¦‚ä»¥ä¸Šæä¾›çš„autopep8-wrapperå°±å¯èƒ½å¤Ÿé…ç½®pep8è§„èŒƒè¿›è¡Œä¸€äº›ä»£ç é£æ ¼æ£€æŸ¥ï¼Œå¦‚æœä¸ç¬¦åˆé£æ ¼å°±ä¼šè‡ªåŠ¨æ ¼å¼åŒ–ã€‚pep8å·¥å…·çš„é»˜è®¤é…ç½®æ–‡ä»¶æ˜¯<code>~/.config/pep8</code></p>
</li>
</ol>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://blog.sideci.com/2015/12/14/style-guide-of-python-and-lint-tool/">About style guide of python and linter tool. pep8, pyflakes, flake8, haking, Pyling.</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¾ˆæ—©å°±ä½¿ç”¨è¿‡autopep8æ¥è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç ï¼Œä½¿ç”¨IDEçš„æ—¶å€™ä¹Ÿä¼šç»å¸¸ä½¿ç”¨æ ¼å¼åŒ–ä»£ç åŠŸèƒ½è®©ä»£ç æ›´ç¬¦åˆè§„èŒƒä¸€ç‚¹ã€‚å¯æ˜¯è¿™éƒ½ä¸æ˜¯è‡ªåŠ¨åŒ–çš„ï¼Œæˆ–è€…è¯´æ˜¯å¼ºåˆ¶çš„ã€‚ä¸ºäº†ä¿æŒå›¢é˜Ÿçš„è‰¯å¥½ä»£ç é£æ ¼æ„Ÿè§‰æ¯ä¸ªåŒäº‹åœ¨æäº¤ä»£ç ä¹‹å‰éƒ½è‡ªåŠ¨è¿›è¡Œæ ¼å¼åŒ–æˆ–è€…é£æ ¼æ£€æŸ¥æ˜¯ä¸€ä¸ªä¸é”™çš„ä¸»æ„ï¼Œäºæ˜¯æ‰¾åˆ°äº†&lt;a href=&quot;
    
    </summary>
    
      <category term="python" scheme="https://www.zoulei.net/categories/python/"/>
    
    
  </entry>
  
</feed>
