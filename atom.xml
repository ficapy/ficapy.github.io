<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>é‚¹é›·</title>
  <subtitle>åˆ¨è¿‡çš„å‘,è‡ªå·±æ…¢æ…¢æ¥å¡«</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://www.zoulei.net/"/>
  <updated>2016-11-08T14:04:33.000Z</updated>
  <id>https://www.zoulei.net/</id>
  
  <author>
    <name>ficapy</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>åŠè‡ªåŠ¨åˆ·ç½‘ç»œè¯¾ç¨‹</title>
    <link href="https://www.zoulei.net/2016/11/08/network_course_pass/"/>
    <id>https://www.zoulei.net/2016/11/08/network_course_pass/</id>
    <published>2016-11-08T14:04:28.000Z</published>
    <updated>2016-11-08T14:04:33.000Z</updated>
    
    <content type="html"><![CDATA[<p>åˆ·ä¸€ä¸ªç½‘ç»œè¯¾ç¨‹ï¼Œå¾ˆå¸¸è§çš„é‚£ç§ï¼Œæ’­æ”¾è§†é¢‘ç»Ÿè®¡è§‚çœ‹æ—¶é•¿ã€‚ä¸è¿‡è¯¥ç³»ç»Ÿæ¯”è¾ƒå¼±ï¼Œå³ä½¿åˆ‡æ¢åˆ°åˆ«çš„é¡µé¢ä¸€æ ·ä¹Ÿä¼šè®¡ç®—æ—¶é•¿ã€‚é™åˆ¶æ¡ä»¶åªæ˜¯å¶å°”ä¼šå‡ºç°ä¸€äº›é—®ç­”é¢˜è®©è§†é¢‘æš‚åœä¸”ä¸€ä¸ªè§†é¢‘æ’­æ”¾å®Œæˆåä¸ä¼šè‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€ä¸ªè§†é¢‘ã€‚æœ€å¼€å§‹æ˜¯æ‰“ç®—ç›´æ¥æ¨¡æ‹Ÿå‘é€httpè¯·æ±‚ï¼Œä¸è¿‡åé¢æ„Ÿè§‰æˆ–è®¸æœ‰å‘å°±é€‰äº†å¦å¤–ä¸€ç§åŠæ³•ã€‚è®²è¯¾è‚¯å®šæ˜¯æœ‰å£°éŸ³çš„ï¼Œç”¨ç¨‹åºå»æ•è·å£°éŸ³ï¼Œå¦‚æœäº”ç§’é’Ÿæ²¡æœ‰å£°éŸ³åˆ™è®¤ä¸ºæœ‰é—®ç­”é¢˜å‡ºç°æˆ–è€…è¯¥ç« èŠ‚è®²å®Œäº†ã€‚</p>
<a id="more"></a>
<h3 id="æ¨¡æ‹Ÿè¯·æ±‚æ³•"><a href="#æ¨¡æ‹Ÿè¯·æ±‚æ³•" class="headerlink" title="æ¨¡æ‹Ÿè¯·æ±‚æ³•"></a>æ¨¡æ‹Ÿè¯·æ±‚æ³•</h3><p>é€šè¿‡chromeå¼€å‘è€…å·¥å…·å¯ä»¥çŸ¥é“æ¯60ç§’ä¼šå‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œå¤§æ¦‚å¦‚ä¸‹(æŸäº›ä¿¡æ¯*å·æ›¿ä»£)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /home/scorm/rte?cmd=submit&#38;token=68&#38;uid=null&#38;cwid=20&#38;eplanid=17245&#38;dig=************ HTTP/1.1&#10;Host: ******&#10;Connection: keep-alive&#10;Content-Length: 58&#10;Pragma: no-cache&#10;Cache-Control: no-cache&#10;Origin: *********&#10;X-Requested-With: ShockwaveFlash/23.0.0.205&#10;User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.71 Safari/537.36&#10;Content-Type: text/xml&#10;Accept: */*&#10;Referer: *****htmlv1player_template_index.swf?1478605419919&#10;Accept-Encoding: gzip, deflate&#10;Accept-Language: zh-CN,zh;q=0.8&#10;Cookie: *********&#10;&#10;cmd:submit&#10;token:68&#10;uid:null&#10;cwid:20&#10;eplanid:17245&#10;dig:*****</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°cookieä¿¡æ¯ç™»å½•åå°±ä¼šæœ‰ï¼Œè¦æ‹¼å‡‘å‡ºä»¥ä¸Šä¿¡æ¯åªéœ€è¦çŸ¥é“digæ˜¯å¦‚ä½•äº§ç”Ÿçš„ã€‚ä»X-Requested-With: ShockwaveFlash/23.0.0.205æˆ‘ä»¬å°±èƒ½çœ‹å‡ºæ¥æ˜¯flashå‘é€çš„ï¼Œç„¶åä¸‹è½½é¡µé¢çš„swfæ–‡ä»¶è¿›è¡Œåç¼–è¯‘å°±èƒ½çŸ¥é“digäº§ç”Ÿçš„é€»è¾‘ã€‚æŠŠswfæ–‡ä»¶æ”¾å…¥<a href="http://www.showmycode.com/">http://www.showmycode.com/</a>å°±èƒ½çœ‹åˆ°äº§ç”Ÿçš„é€»è¾‘äº†ã€‚ä¸è¿‡æˆ‘ä¸ä¼šasï¼Œä»–äº§ç”Ÿçš„ä»£ç ä¹Ÿå¼‚å¸¸ç³Ÿç³•ï¼Œæˆªå–ä¸€æ®µå¦‚ä¸‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">md5String = (md5String + _md5PrivateKey);&#10;md5String = MD5.hash(md5String);&#10;req = new URLRequest((_serviceUrlHasQuery) ? ((((((((((_serviceUrl + &#34;&#38;cmd=submit&#38;token=&#34;) + _token) + &#34;&#38;uid=&#34;) + _uid) + &#34;&#38;cwid=&#34;) + _cwid) + &#34;&#38;eplanid=&#34;) + _cplanid) + &#34;&#38;dig=&#34;) + md5String) : ((((((((((_serviceUrl + &#34;?cmd=submit&#38;token=&#34;) + _token) + &#34;&#38;uid=&#34;) + _uid) + &#34;&#38;cwid=&#34;) + _cwid) + &#34;&#38;eplanid=&#34;) + _cplanid) + &#34;&#38;dig=&#34;) + md5String));&#10;req.method = URLRequestMethod.POST;&#10;req.contentType = &#34;text/xml&#34;;&#10;_currentSubmitData = xml;&#10;req.data = xml;&#10;_urlLoader.load(req);</span><br></pre></td></tr></table></figure></p>
<p>å¦‚æœä½ å¯¹aséå¸¸ç†Ÿæ‚‰çœ‹èµ·æ¥ä¼°è®¡æ²¡å•¥é—®é¢˜ã€‚å¯æ˜¯æœ‰æ›´å¥½çš„æ–¹æ¡ˆã€‚å¼€æºè½¯ä»¶<a href="https://github.com/jindrapetrik/jpexs-decompiler">jpexs-decompiler</a>.è€Œä¸”å±…ç„¶æœ‰ä¸­æ–‡è¯­è¨€åŒ…ã€‚å¾ˆç‰›çš„ä¸€ç‚¹å°±æ˜¯å®ƒèƒ½å¤Ÿç›´æ¥ç¼–è¾‘ç¼–åç¼–è¯‘åçš„ä»£ç å†é‡æ–°æ‰“åŒ…ï¼Œå¯ä»¥çœ‹çœ‹å®ƒç”Ÿæˆçš„ä»£ç <br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this._token++;&#10;md5String = this._token + &#34;&#34; + this._uid + &#34;&#34; + this._cwid + &#34;&#34; + this._cplanid + &#34;&#34; + tmpTime;&#10;xml = &#34;&#60;request lastAccess=\&#34;&#34; + this._lastAccess + &#34;\&#34; sessionTime=\&#34;&#34; + tmpTime + &#34;\&#34;&#62;&#34;;&#10;for each(tmpObj in tmpHash)&#10;&#123;&#10;   if(tmpHash[&#34;sco_&#34; + tmpObj.id] == null)&#10;   &#123;&#10;      tmpObj2 = this._tracksHash[&#34;sco_&#34; + tmpObj.id];&#10;      if(tmpObj2 != null)&#10;      &#123;&#10;         xml = xml + &#34;&#60;item id=\&#34;&#34; + tmpObj2.id + &#34;\&#34; score=\&#34;&#34; + tmpObj2.score + &#34;\&#34; time=\&#34;&#34; + tmpObj2.time + &#34;\&#34;/&#62;&#34;;&#10;         tmpHash[&#34;sco_&#34; + tmpObj.id] = tmpObj2;&#10;         md5String = md5String + tmpObj2.id + tmpObj2.score;&#10;      &#125;&#10;   &#125;&#10;&#125;&#10;for each(objTemp in tmpHash)&#10;&#123;&#10;   xml = xml + &#34;&#60;item id=\&#34;&#34; + objTemp.id + &#34;\&#34; complete=\&#34;&#34; + objTemp.complete + &#34;\&#34; type=\&#34;obj\&#34;/&#62;&#34;;&#10;&#125;&#10;xml = xml + &#34;&#60;/request&#62;&#34;;&#10;this._cmd = &#34;submit&#34;;&#10;md5String = md5String + this._md5PrivateKey;&#10;ExternalInterface.call(&#34;console.log&#34;,md5String);&#10;md5String = MD5.hash(md5String);&#10;req = new URLRequest(!!this._serviceUrlHasQuery?this._serviceUrl + &#34;&#38;cmd=submit&#38;token=&#34; + this._token + &#34;&#38;uid=&#34; + this._uid + &#34;&#38;cwid=&#34; + this._cwid + &#34;&#38;eplanid=&#34; + this._cplanid + &#34;&#38;dig=&#34; + md5String:this._serviceUrl + &#34;?cmd=submit&#38;token=&#34; + this._token + &#34;&#38;uid=&#34; + this._uid + &#34;&#38;cwid=&#34; + this._cwid + &#34;&#38;eplanid=&#34; + this._cplanid + &#34;&#38;dig=&#34; + md5String);&#10;req.method = URLRequestMethod.POST;&#10;req.contentType = &#34;text/xml&#34;;&#10;this._currentSubmitData = xml;&#10;req.data = xml;&#10;this._urlLoader.load(req);</span><br></pre></td></tr></table></figure></p>
<p>è¿™æ ·çœ‹èµ·æ¥å°±å¾ˆå®¹æ˜“ç†è§£äº†ï¼Œå†™æˆpythonä»£ç å¤§æ¦‚å°±æ˜¯è¿™æ ·å­(åç¼–è¯‘åå¯ä»¥çœ‹åˆ°key)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Request Payload</span></span><br><span class="line"><span class="comment"># &lt;request lastAccess="ch_00_02" sessionTime="60"&gt;&lt;/request&gt;</span></span><br><span class="line"><span class="comment"># &lt;response success="true"&gt;</span></span><br><span class="line"><span class="comment"># &lt;item complete="0" id="ch_00_02" score="0.0" time="2249" /&gt;</span></span><br><span class="line"><span class="comment"># &lt;/response&gt;</span></span><br><span class="line"><span class="comment"># &lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;response success="true"&gt;&lt;item complete="0" id="ch_00_02" score="0.0" time="2249"/&gt;&lt;/response&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># http://***?cmd=submit&amp;token=5&amp;uid=null&amp;cwid=67&amp;eplanid=17242&amp;dig=*****</span></span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line">pri = <span class="string">'#Huaxia$RTE-*PP'</span></span><br><span class="line">a = <span class="string">'1null671724260#Huaxia$RTE-*PP'</span></span><br><span class="line">b = md5(a).hexdigest()</span><br></pre></td></tr></table></figure><br>å¦å¤–å¦‚æœé‡åˆ°ä»€ä¹ˆç–‘æƒ‘å¯ä»¥ç›´æ¥<code>ExternalInterface.call(&quot;console.log&quot;,md5String);</code>è¿™æ ·èƒ½å¤Ÿè¾“å‡ºå˜é‡ã€‚é‡æ–°æ‰“åŒ…ä¸ºswfï¼Œå†ç”¨fiddleræ›¿æ¢æ‰è¯·æ±‚çš„swfæ–‡ä»¶ä¸ºè‡ªå·±æ‰“åŒ…çš„æ–‡ä»¶ï¼Œè¿™æ ·å°±èƒ½çœ‹åˆ°è°ƒè¯•è¾“å‡ºäº†ã€‚æ„Ÿæ…¨ä¸‹è¿™ä¸ªå·¥å…·çœŸå¥½ç”¨ï¼Œä¸è¿‡æœ¬äººä¸æ˜¯æå‰ç«¯çš„ï¼Œè€Œä¸”flashä¹Ÿå·²ç»æ²¡è½åˆ°æ²¡æœ‰å»æ·±å…¥çš„å¿…è¦â”‘(ï¿£Ğ” ï¿£)â”</p>
<h3 id="åˆ¤æ–­è§†é¢‘æ˜¯å¦æ’­æ”¾å®ŒæˆåŠè‡ªåŠ¨åŒ–"><a href="#åˆ¤æ–­è§†é¢‘æ˜¯å¦æ’­æ”¾å®ŒæˆåŠè‡ªåŠ¨åŒ–" class="headerlink" title="åˆ¤æ–­è§†é¢‘æ˜¯å¦æ’­æ”¾å®ŒæˆåŠè‡ªåŠ¨åŒ–"></a>åˆ¤æ–­è§†é¢‘æ˜¯å¦æ’­æ”¾å®ŒæˆåŠè‡ªåŠ¨åŒ–</h3><p>æˆ‘åˆ¤æ–­çš„ä¾æ®æ˜¯æ²¡æœ‰å£°éŸ³äº†ï¼Œéœ€è¦è§£å†³çš„å°±æ˜¯è·å–å½“å‰éŸ³é‡å¤§å°çš„é—®é¢˜ã€‚æœ€å¼€å§‹æƒ³çš„æ˜¯ä½¿ç”¨ç³»ç»Ÿçš„å‘½ä»¤è¡Œæ¥å£ï¼Œæ— å¥ˆå¹¶æ²¡æœ‰æ‰¾åˆ°ï¼Œè€Œåçœ‹åˆ°äº†ä½¿ç”¨è™šæ‹ŸéŸ³é¢‘æ¥å£<a href="https://github.com/mattingalls/Soundflower">Soundflower</a>,è™½ç„¶2å¹´æ²¡æ›´æ–°è¿‡äº†ï¼ŒæƒŠå¥‡çš„æ˜¯èƒ½æ­£å¸¸ä½¿ç”¨ã€‚å®‰è£…ä¸Šä¹‹ååœ¨soundé‡Œé¢çš„inputå’Œoutputä¼šå¤šå‡º2ä¸ªè®¾å¤‡ï¼Œå¦‚å›¾<img src="https://ficapy.b0.upaiyun.com/blogimg/soundflower.png" alt="soundflower">,å½“ä½ éœ€è¦æ•è·ç³»ç»Ÿå£°éŸ³çš„æ—¶å€™å°†inputå’Œoutputå‡é€‰ä¸ºåŒä¸€ä¸ª(è¿™æ ·ä¼šå¯¼è‡´æœºå™¨æ²¡æœ‰å£°éŸ³è¾“å‡ºï¼Œéœ€è¦é€‰æ‹©åŒä¸€ä¸ªçš„åŸå› æˆ‘è§‰å¾—æ˜¯ä»£ç ä¸­æ ¹æ®inputçš„æ–‡ä»¶æè¿°ç¬¦æ¥è·å¾—output,æ‰€ä»¥éœ€è¦å°†inputå’Œoutputé€‰ä¸ºåŒä¸€ä¸ª)ï¼Œç„¶è€Œæˆ‘å•ç‹¬å¼€äº†ä¸€ä¸ªwindowsè™šæ‹Ÿæœºï¼Œè™šæ‹Ÿæœºå¯ä»¥é€‰æ‹©ä½¿ç”¨å“ªä¸ªè¾“å…¥è¾“å‡ºéŸ³é¢‘æ¥å£ï¼Œå¯¹äºè™šæ‹Ÿæœºçš„è¾“å‡ºæˆ‘é€‰æ‹©äº†soundflowerï¼Œåœ¨ç³»ç»Ÿè®¾ç½®é‡Œé¢æˆ‘é€‰æ‹©äº†ç›¸åŒçš„soundeflowerä½œä¸ºè¾“å…¥ã€‚å¯æ˜¯é€‰æ‹©äº†æ­£å¸¸çš„æ¥å£ä½œä¸ºè¾“å‡ºã€‚å¦‚æ­¤æˆ‘å¬ä¸åˆ°è™šæ‹Ÿæœºå‘å‡ºçš„å£°éŸ³ï¼ŒåŒæ—¶æœ¬æœºå‘å‡ºçš„å£°éŸ³åˆå¯ä»¥æ­£å¸¸æ”¶å¬ï¼Œå®Œç¾~~~<br>ä»£ç å¦‚ä¸‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import time&#10;import pyaudio&#10;import audioop&#10;from collections import deque&#10;from subprocess import Popen&#10;&#10;FORMAT = pyaudio.paInt16&#10;CHANNELS = 2&#10;RATE = 44100&#10;CHUNK = 1024&#10;&#10;audio = pyaudio.PyAudio()&#10;&#10;stream = audio.open(format=FORMAT, channels=CHANNELS,&#10;                    rate=RATE, input=True,&#10;                    frames_per_buffer=CHUNK)&#10;&#10;flag = time.time()&#10;queue = deque(maxlen=5)&#10;while True:&#10;    data = stream.read(CHUNK)&#10;    if time.time() - flag &#62; 1:&#10;        flag = time.time()&#10;        rms = audioop.rms(data, 2)&#10;        print rms&#10;        queue.append(rms)&#10;        if len(queue) == 5 and sum(queue) == 0:&#10;            Popen(&#34;&#34;&#34;/usr/bin/osascript -e &#39;display notification &#34;look here&#34; &#39;&#34;&#34;&#34;, shell=True)</span><br></pre></td></tr></table></figure></p>
<p>å½“äº”ç§’é’Ÿæ²¡æœ‰å£°éŸ³å°±åœ¨å±å¹•å³ä¸Šè§’å¼¹å‡ºä¸€ä¸ªæç¤ºæ¡†æé†’ä½ å»ç‚¹å‡»ã€‚æœ¬æ–‡ç”¨äºosxç³»ç»Ÿï¼Œå…¶ä»–ç³»ç»ŸæŒ‰ç…§è¿™ä¸ªæ€è·¯åº”è¯¥ä¹Ÿèƒ½å®ç°</p>
<h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><p>å½“ç„¶è¿™ä¸ªç³»ç»Ÿè¿˜æœ‰å¾ˆ<code>è´´å¿ƒ</code>çš„åœ°æ–¹ï¼Œå¯¹äºè§†é¢‘è®²è§£ä¸­å‡ºç°çš„é—®ç­”é¢˜ï¼Œå…¶å®åœ¨å‰ç«¯é¡µé¢ä¸­å·²ç»ç»™å‡ºäº†ç­”æ¡ˆï¼Œæ‰“å¼€webæ§åˆ¶å°ï¼ŒæŸ¥çœ‹ä¸€ä¸‹å°±æœ‰å“’ã€‚<br>ç„¶åè¿˜ä¸å…è®¸å¤åˆ¶ç²˜è´´ã€‚è¿™ä¸ªåŒæ ·ç›´æ¥åœ¨æ§åˆ¶å°é‡Œé¢å¤åˆ¶å°±å¥½äº†ï¼Œä¹Ÿæ²¡å¿…è¦ç¦ç”¨jså•¥çš„~~</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://www.christianengvall.se/record-audio-soundflower/">record-audio-soundflower</a><br><a href="http://stackoverflow.com/questions/26478315/getting-volume-levels-from-pyaudio-for-use-in-arduino">getting-volume-levels-from-pyaudio-for-use-in-arduino</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åˆ·ä¸€ä¸ªç½‘ç»œè¯¾ç¨‹ï¼Œå¾ˆå¸¸è§çš„é‚£ç§ï¼Œæ’­æ”¾è§†é¢‘ç»Ÿè®¡è§‚çœ‹æ—¶é•¿ã€‚ä¸è¿‡è¯¥ç³»ç»Ÿæ¯”è¾ƒå¼±ï¼Œå³ä½¿åˆ‡æ¢åˆ°åˆ«çš„é¡µé¢ä¸€æ ·ä¹Ÿä¼šè®¡ç®—æ—¶é•¿ã€‚é™åˆ¶æ¡ä»¶åªæ˜¯å¶å°”ä¼šå‡ºç°ä¸€äº›é—®ç­”é¢˜è®©è§†é¢‘æš‚åœä¸”ä¸€ä¸ªè§†é¢‘æ’­æ”¾å®Œæˆåä¸ä¼šè‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€ä¸ªè§†é¢‘ã€‚æœ€å¼€å§‹æ˜¯æ‰“ç®—ç›´æ¥æ¨¡æ‹Ÿå‘é€httpè¯·æ±‚ï¼Œä¸è¿‡åé¢æ„Ÿè§‰æˆ–è®¸æœ‰å‘å°±é€‰äº†å¦å¤–ä¸€ç§åŠæ³•ã€‚è®²è¯¾è‚¯å®šæ˜¯æœ‰å£°éŸ³çš„ï¼Œç”¨ç¨‹åºå»æ•è·å£°éŸ³ï¼Œå¦‚æœäº”ç§’é’Ÿæ²¡æœ‰å£°éŸ³åˆ™è®¤ä¸ºæœ‰é—®ç­”é¢˜å‡ºç°æˆ–è€…è¯¥ç« èŠ‚è®²å®Œäº†ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="ä¼ªæŠ€æœ¯" scheme="https://www.zoulei.net/categories/%E4%BC%AA%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="python" scheme="https://www.zoulei.net/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>Flaskè·¯ç”±æœºåˆ¶</title>
    <link href="https://www.zoulei.net/2016/09/11/flask_routing_note/"/>
    <id>https://www.zoulei.net/2016/09/11/flask_routing_note/</id>
    <published>2016-09-11T14:06:12.000Z</published>
    <updated>2016-09-11T14:11:49.000Z</updated>
    
    <content type="html"><![CDATA[<p>Flaskå¸…æ°”çš„Hello Worldç¤ºä¾‹è®©äººå°è±¡æ·±åˆ»ã€‚å…¶ä¸­ä½¿ç”¨è£…é¥°å™¨çš„è·¯ç”±å†™æ³•åŠŸä¸å¯æ²¡ï¼Œç”šè‡³ä»¥å‰çœ‹è¿‡ä¸€ä¸ªç³»åˆ—<a href="http://ains.co/blog/things-which-arent-magic-flask-part-1.html">æ²¡é‚£ä¹ˆç¥å¥‡</a>ï¼Œè®²äº†app.routeã€‚æ˜¯çš„ï¼Œå®ƒå¥½åƒå¹¶æ²¡æœ‰é‚£ä¹ˆç¥å¥‡ï¼Œæˆ‘ä¹Ÿæ¥è§£æä¸€ä¸‹ğŸ˜†</p>
<a id="more"></a>
<p>Flaskçš„è·¯ç”±æ˜¯å¯¹werkzeugè¿›è¡Œäº†ç®€å•çš„åŒ…è£…ï¼Œåšæˆäº†app.routeè£…é¥°å™¨å’Œblueprintã€‚å…¶å®werkzeugä¸­æœ‰ä¸€æ®µdocstringå°±èƒ½åæ˜ å‡ºflaskçš„è·¯ç”±æœºåˆ¶(MapAdapter.dispatch)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> werkzeug.wrappers <span class="keyword">import</span> Request, Response</span><br><span class="line"><span class="keyword">from</span> werkzeug.wsgi <span class="keyword">import</span> responder</span><br><span class="line"><span class="keyword">from</span> werkzeug.routing <span class="keyword">import</span> Map, Rule</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_index</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> Response(<span class="string">'Hello from the index'</span>)</span><br><span class="line"></span><br><span class="line">url_map = Map([Rule(<span class="string">'/'</span>, endpoint=<span class="string">'index'</span>)])</span><br><span class="line">views = &#123;<span class="string">'index'</span>: on_index&#125;</span><br><span class="line"></span><br><span class="line"><span class="decorator">@responder</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span><span class="params">(environ, start_response)</span>:</span></span><br><span class="line">    request = Request(environ)</span><br><span class="line">    urls = url_map.bind_to_environ(environ)</span><br><span class="line">    <span class="keyword">return</span> urls.dispatch(<span class="keyword">lambda</span> e, v: views[e](request, **v),</span><br><span class="line">                         catch_http_exceptions=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure></p>
<p>werkzeugè·¯ç”±çš„å…¨éƒ¨å®ç°éƒ½åœ¨routing.pyæ–‡ä»¶å½“ä¸­ï¼Œçœ‹å®ƒå°±å¤Ÿäº†ã€‚è·¯ç”±çš„åŸºæœ¬åŠŸèƒ½å¯ä»¥è¯´æ˜¯</p>
<ol>
<li>ç»™å‡ºä¸€ä¸ªURLï¼ŒåŒ¹é…åˆ°å®ƒå¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œ</li>
<li>ç»™å‡ºå‡½æ•°èƒ½åæ¨æ„é€ å‡ºURL</li>
</ol>
<h2 id="Rule"><a href="#Rule" class="headerlink" title="Rule"></a>Rule</h2><p>ä¸€ä¸ªRuleå°±æ˜¯ä¸€æ¡URLåŒ¹é…è§„åˆ™,å®ƒçš„æ¨¡å¼å¦‚ä¸‹<code>&lt;converter(arguments):name&gt;</code>,ä½¿ç”¨æ­£åˆ™åŒ¹é…æ‰¾å‡ºæˆ‘ä»¬éœ€è¦çš„ä¿¡æ¯<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_rule_re = re.compile(r&#39;&#39;&#39;&#10;    (?P&#60;static&#62;[^&#60;]*)                           # static rule data&#10;    &#60;&#10;    (?:&#10;        (?P&#60;converter&#62;[a-zA-Z_][a-zA-Z0-9_]*)   # converter name&#10;        (?:\((?P&#60;args&#62;.*?)\))?                  # converter arguments&#10;        \:                                      # variable delimiter&#10;    )?&#10;    (?P&#60;variable&#62;[a-zA-Z_][a-zA-Z0-9_]*)        # variable name&#10;    &#62;&#10;&#39;&#39;&#39;, re.VERBOSE)</span><br></pre></td></tr></table></figure></p>
<p>å¤§æ¦‚æ˜¯è¿™ä¹ˆä¸ªæ ·å­ruleåŒ¹é…<br><img src="https://ficapy.b0.upaiyun.com/blogimg/werkzeug_rule_re.png" alt="werkzeug_rule_re"><br>convertè§„åˆ™åŒ¹é…<br><img src="https://ficapy.b0.upaiyun.com/blogimg/werkzeug_converter_args_re.png" alt="werkzeug_converter_args_re"><br>å¾ˆå®¹æ˜“æƒ³åˆ°ä½¿ç”¨è¿™2ä¸ªæ­£åˆ™èƒ½å¤ŸåŒ¹é…ä¸€ä¸ªURLï¼Œä¸€çœ‹ä»–æ˜¯å¦åŒ¹é…æŸä¸ªruleï¼Œå…¶æ¬¡å¦‚æœåŒ¹é…é‚£ä¹ˆæå–å‡ºruleä¸­çš„å‚æ•°å’Œå€¼,æ¯”å¦‚<code>/&lt;int:id&gt;</code>å°±èƒ½åŒ¹é…<code>/16</code>è¿™ä¸ªurlä¸”å¾—åˆ°id=16ã€‚è¿™2ä¸ªå‡½æ•°å°±æ˜¯matchå’Œbuildäº†<br>ä»…ä»…æœ‰å®ƒä»¬æ˜¯ä¸å¤Ÿçš„ã€‚æˆ‘ä»¬éœ€è¦çš„ä¸ä»…ä»…æ˜¯ä¸€æ¡Ruleï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯æ‰€æœ‰Ruleçš„é›†åˆã€‚å½“æˆ‘ä»¬æ¯åˆ›å»ºä¸€ä¸ªRuleçš„æ—¶å€™å°†å®ƒåŠ å…¥åˆ°é›†åˆä¸­ã€‚æ‰€ä»¥å®ƒæä¾›äº†get_ruleså’Œbindæ–¹æ³•</p>
<p>Ruleå¯¹è±¡åŒæ—¶æœ‰2ä¸ªéå¸¸é‡è¦çš„å±æ€§endpointå’Œ_regex(ç¼–è¯‘åçš„æ­£åˆ™).endpointä¸ç”¨è¯´åŒ¹é…è¿”å›å®ƒï¼Œæ ¹æ®å®ƒè¿”å›æ„å»ºå¥½çš„URLï¼ŒåŒ¹é…åŠŸèƒ½åˆ™æ˜¯ç”±_regexå¯¹è±¡æä¾›çš„ã€‚å¦å¤–æœ‰å‡ ä¸ªå¯¹è±¡ç»§æ‰¿è‡ªRule<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Subdomain           self.subdomain&#10;Submount            self.rule = self.path + self.rule&#10;EndpointPrefix      self.endpoint = self.prefix + self.endpoint</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹å‡ºè¿™ä¸‰ä¸ªå¯¹è±¡éƒ½æ˜¯å¯¹Ruleçš„å±æ€§è¿›è¡Œäº†å°å¹…åº¦ä¿®æ”¹,å…¶ä¸­subdomainå’Œsubmountä¿®æ”¹çš„æœ€ç»ˆç»“æœå°±æ˜¯æ”¹å˜äº†_regexå¯¹è±¡</p>
<p>è¯´ä¸€ä¸‹Subdomain,å­åŸŸåã€‚è¿™ç©æ„å„¿å¥½åƒå¹¶ä¸å¸¸ç”¨ï¼Œä¸€èˆ¬ä¸€ä¸ªå­åŸŸåå°±æ˜¯å•ç‹¬ä¸€ä¸ªé¡¹ç›®äº†ï¼Œä¸å¤§ä¼šå‡ ä¸ªå­åŸŸåæ··åˆåœ¨ä¸€ä¸ªé¡¹ç›®é‡Œé¢ã€‚å¦‚æœè¦ä½¿ç”¨å­åŸŸåéœ€è¦è®¾ç½®SERVER_NAMEã€‚ç¤ºä¾‹å¦‚ä¸‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">'SERVER_NAME'</span>] = <span class="string">'app.local:5000'</span></span><br><span class="line"><span class="decorator">@app.route('/',subdomain='blog')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello'</span></span><br><span class="line">app.run(<span class="string">'app.local'</span>)</span><br></pre></td></tr></table></figure><br>ç„¶åå°±æ˜¯åœ¨hosté‡Œé¢æ·»åŠ å°±å¯ä»¥æ­£å¸¸è°ƒè¯•å­åŸŸåäº†<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 app.local&#10;127.0.0.1 blog.app.local</span><br></pre></td></tr></table></figure></p>
<h2 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h2><p>Mapçš„ä½œç”¨å°±æ˜¯å°†æ‰€æœ‰çš„Ruleç»„åˆåœ¨ä¸€èµ·,æ‰€ä»¥addå‡½æ•°æ˜¯å¿…é¡»çš„,Ruleå¯¹è±¡ä¸­çš„matchå’Œbuildéƒ½åªæ˜¯é’ˆå¯¹è‡ªå·±çš„ï¼ŒMapä¸­æä¾›çš„matchå’Œbuildåˆ™æ˜¯é’ˆå¯¹æ‰€æœ‰Ruleçš„ã€‚æ¯”å¦‚åœ¨Flaskä¸­å†™app.routeå¿…ç„¶ä¼šè°ƒç”¨addï¼Œå°†è¯¥Ruleæ·»åŠ åˆ°Mapä¸­ã€‚ä»£ç å¦‚ä¸‹(0.1ç‰ˆæœ¬)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_url_rule</span><span class="params">(self, rule, endpoint, **options)</span>:</span></span><br><span class="line">    options[<span class="string">'endpoint'</span>] = endpoint</span><br><span class="line">    options.setdefault(<span class="string">'methods'</span>, (<span class="string">'GET'</span>,))</span><br><span class="line">    self.url_map.add(Rule(rule, **options))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">route</span><span class="params">(self, rule, **options)</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(f)</span>:</span></span><br><span class="line">      self.add_url_rule(rule, f.__name__, **options)</span><br><span class="line">      self.view_functions[f.__name__] = f</span><br><span class="line">      <span class="keyword">return</span> f</span><br><span class="line">  <span class="keyword">return</span> decorator</span><br></pre></td></tr></table></figure><br>ä»£ç ä¸­self.url_map = Map(),å¯ä»¥çœ‹åˆ°app.routeåšäº†2ä»¶äº‹æƒ…ï¼ŒåŠ å…¥åˆ°Mapä¸­ï¼ŒåŠ å…¥åˆ°äº†view_functionså­—å…¸ä¸­(endpointå¯¹åº”å‡½æ•°,è¿™æ®µä»£ç å’Œæ–‡ç« å¼€å¤´çš„ä»£ç æ˜¯å¾ˆç›¸ä¼¼çš„)</p>
<p>Mapå¯¹è±¡ä¸­æœ‰2ä¸ªå±æ€§ä¹Ÿæ˜¯æ¯”è¾ƒé‡è¦çš„,_rulesåˆ—è¡¨å’Œ_rules_by_endpointå­—å…¸ã€‚å‰è€…å­˜æ”¾æ‰€æœ‰Ruleå¯¹è±¡ï¼ŒåŒ¹é…çš„æ—¶å€™ç”¨æ¥éå†ï¼Œåè€…ä¸ºendpointåˆ°Ruleçš„æ˜ å°„ã€‚ç”¨æ¥buildé‡ç»„URL</p>
<p>ç°åœ¨å†æ¥çœ‹çœ‹Flaskä¸­çš„dispatchåˆ†å‘é€»è¾‘<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatch_request</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="string">"""Does the request dispatching.  Matches the URL and returns the</span><br><span class="line">    return value of the view or error handler.  This does not have to</span><br><span class="line">    be a response object.  In order to convert the return value to a</span><br><span class="line">    proper response object, call :func:`make_response`.</span><br><span class="line">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        endpoint, values = self.match_request()</span><br><span class="line">        <span class="keyword">return</span> self.view_functions[endpoint](**values)</span><br><span class="line">    <span class="keyword">except</span> HTTPException, e:</span><br><span class="line">        handler = self.error_handlers.get(e.code)</span><br><span class="line">        <span class="keyword">if</span> handler <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">return</span> e</span><br><span class="line">        <span class="keyword">return</span> handler(e)</span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        handler = self.error_handlers.get(<span class="number">500</span>)</span><br><span class="line">        <span class="keyword">if</span> self.debug <span class="keyword">or</span> handler <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">return</span> handler(e)</span><br></pre></td></tr></table></figure><br>åŒ¹é…è¯·æ±‚å¾—åˆ°endpointå†ä»view_functionä¸­å¾—åˆ°å¯¹åº”çš„å¤„ç†å‡½æ•°æ‰§è¡Œ</p>
<h2 id="Blueprint"><a href="#Blueprint" class="headerlink" title="Blueprint"></a>Blueprint</h2><p>@app.routeè™½ç„¶å¤Ÿç‚«é…·ï¼Œå¯æ˜¯å®ƒç»ä¸é€‚åº”äºå¤§é¡¹ç›®ã€‚å› ä¸ºæ³¨å†Œçš„endpointå°±æ˜¯å‡½æ•°çš„åç§°ï¼Œåœ¨å¤§é¡¹ç›®ä¸­ç»å¯¹ä¼šå­˜åœ¨é‡åå‡½æ•°çš„ã€‚Blueprintçš„è§£å†³åŠæ³•å°±æ˜¯<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">blueprint = Blueprint(&#39;public&#39;, __name__, static_folder=&#39;../static&#39;)&#10;@blueprint.route(&#39;/&#39;, methods=[&#39;GET&#39;, &#39;POST&#39;])&#10;def index()&#10;&#10;app.register_blueprint(blueprint)</span><br></pre></td></tr></table></figure></p>
<p>è¿™æ ·å®ƒæ³¨å†Œçš„endpointå°±ä¼šå˜æˆpublic.indexï¼Œè§£å†³äº†é‡åé—®é¢˜</p>
<p>æœ‰äººé—®ä¸ºä»€ä¹ˆendpointä¸ç›´æ¥ä½¿ç”¨å¯¹åº”çš„å‡½æ•°ï¼Œè€Œè¦ä½¿ç”¨å­—ç¬¦ä¸²ã€‚æˆ‘è®¤ä¸ºæ˜¯ä½¿ç”¨url_forç­‰æ„å»ºURLå‡½æ•°çš„æ—¶å€™éœ€è¦å®ƒæ˜¯å­—ç¬¦ä¸²ï¼Œå› ä¸ºä½¿ç”¨è£…é¥°å™¨åfunc = deactor(func)ï¼Œä½ ä½¿ç”¨@app.routeä¹‹åæ³¨å†Œçš„funcå’Œä½ ç°åœ¨çš„funcä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚æ„å»ºå‡½æ•°å°†æ— æ³•ä½¿ç”¨,è¿™ä¹Ÿå‘Šè¯‰äº†æˆ‘ä»¬,ä»»ä½•æ—¶å€™å…¶ä»–çš„è£…é¥°å™¨éƒ½éœ€è¦å†™åœ¨@app.routeä¸‹é¢,å› ä¸ºå¦‚æœå†™åœ¨ä¸Šé¢ï¼Œä½ æ³¨å†Œçš„é‚£ä¸ªå‡½æ•°æ˜¯ä¸åŒ…å«ä¸Šé¢çš„è£…é¥°å™¨çš„ï¼Œæ³¨å®šäº†ä¸Šé¢çš„è£…é¥°å™¨æ— æ³•æ‰§è¡Œ</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Flaskå¸…æ°”çš„Hello Worldç¤ºä¾‹è®©äººå°è±¡æ·±åˆ»ã€‚å…¶ä¸­ä½¿ç”¨è£…é¥°å™¨çš„è·¯ç”±å†™æ³•åŠŸä¸å¯æ²¡ï¼Œç”šè‡³ä»¥å‰çœ‹è¿‡ä¸€ä¸ªç³»åˆ—&lt;a href=&quot;http://ains.co/blog/things-which-arent-magic-flask-part-1.html&quot;&gt;æ²¡é‚£ä¹ˆç¥å¥‡&lt;/a&gt;ï¼Œè®²äº†app.routeã€‚æ˜¯çš„ï¼Œå®ƒå¥½åƒå¹¶æ²¡æœ‰é‚£ä¹ˆç¥å¥‡ï¼Œæˆ‘ä¹Ÿæ¥è§£æä¸€ä¸‹ğŸ˜†&lt;/p&gt;
    
    </summary>
    
      <category term="Flask" scheme="https://www.zoulei.net/categories/Flask/"/>
    
    
      <category term="Flask" scheme="https://www.zoulei.net/tags/Flask/"/>
    
  </entry>
  
  <entry>
    <title>Flaskæ’ä»¶åŸç†</title>
    <link href="https://www.zoulei.net/2016/09/05/flask_plugin_note/"/>
    <id>https://www.zoulei.net/2016/09/05/flask_plugin_note/</id>
    <published>2016-09-04T23:38:32.000Z</published>
    <updated>2016-09-11T14:08:21.000Z</updated>
    
    <content type="html"><![CDATA[<p>Flaskçš„æ’ä»¶è¿˜æŒºå¤š,ç”¨è¿‡çš„éƒ½çŸ¥é“æ¯”å¦‚flask-sqlalchemy,å®‰è£…çš„æ—¶å€™æ˜¯ä½¿ç”¨pip install flask-sqlalchemyï¼Œä½¿ç”¨çš„æ—¶å€™å°±æˆäº†from flask.ext.sqlalchemy import SQLAlchemyã€‚ä½¿ç”¨çš„æ˜¯flask.extè€Œä¸æ˜¯flask_sqlalchemyã€‚æ„Ÿè§‰è¿˜æœ‰ç‚¹ç‰›æ°å•Š-_-ï¼Œä¸è¿‡ä»…ä»…æ˜¯çœ‹èµ·æ¥é«˜å¤§ä¸Šï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ã€‚<a href="https://github.com/pallets/flask/issues/1135">åœ¨2016å¹´4æœˆ13å·æ­£å¼è¢«ç§»å‡ºæ”¯æŒäº†</a>ï¼Œå·²ç»ç›´æ¥å‘å‡ºä¸å»ºè®®ä½¿ç”¨çš„è­¦å‘Šã€‚æœ¬æ–‡è¿˜æ˜¯æ¥ç‚’ä¸€ä¸‹ç°é¥­ï¼Œçœ‹çœ‹å®ƒèƒŒåçš„é€»è¾‘</p>
<a id="more"></a>
<p>æ¯”å¦‚flask-sqlalchemyåŸæœ¬æ˜¯ä½¿ç”¨from flask_sqlalchemy import [anything]ä½¿ç”¨çš„ï¼Œè¢«å˜æˆäº†from flask.ext.sqlalchemy import [anything]ã€‚è¿™æ˜¯ä¸€ç§å¯¹äºimportçš„hookã€‚æˆ‘ä»¬çŸ¥é“è¦å¯¼å…¥ä¸€ä¸ªæ¨¡å—ï¼Œä¸ä½¿ç”¨importå£°æ˜ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå¯ä»¥ä½¿ç”¨__import__å‡½æ•°ï¼Œè¿”å›å¾—åˆ°çš„ä¹Ÿæ˜¯ä¸€ä¸ªæ¨¡å—å¯¹è±¡</p>
<h2 id="import-hook"><a href="#import-hook" class="headerlink" title="import hook"></a>import hook</h2><p>ä¸‹æ–‡ç®€è¿°ï¼Œå¦‚æœéœ€è¦äº†è§£æ¯”è¾ƒè¯¦ç»†çš„èµ„æ–™å¯ä»¥æŸ¥çœ‹åæ–‡ç»™å‡ºçš„å‚è€ƒé“¾æ¥(python2å’Œ3çš„importæœºåˆ¶æ˜¯ç•¥æœ‰åŒºåˆ«çš„)<br>importå£°æ˜ä¸»è¦åšäº†2ä»¶äº‹æƒ…ï¼ŒæŸ¥æ‰¾æ¨¡å—ï¼ŒåŠ è½½æ¨¡å—ã€‚æˆ‘ä»¬è¯´çš„hookå‘ç”Ÿåœ¨ç¬¬ä¸€æ­¥æŸ¥æ‰¾æ¨¡å—ã€‚æŸ¥æ‰¾æ¨¡å—çš„æ­¥éª¤æ˜¯</p>
<ol>
<li>æŸ¥æ‰¾sys.modulesç¼“å­˜</li>
<li>åœ¨sys.meta_pathä¸­ä¾æ¬¡æ‰§è¡Œfinderå¯¹è±¡,æ‰¾åˆ°å°±è¿”å›è‡ªèº«,æ‰€æœ‰çš„éƒ½æ²¡æœ‰æ‰¾åˆ°åˆ™ä¼šæŠ¥é”™<br>æ³¨æ„:sys.path_hooksä¸­çš„finderä¼šè¢«sys.meta_pathè°ƒç”¨æ‰§è¡Œ(sys.meta_pathå’Œsys.path_hookéƒ½å¯ä»¥å‚ä¸import hooksæ­¥éª¤)</li>
</ol>
<h2 id="ç²¾ç®€ç‰ˆæœ¬å®ç°"><a href="#ç²¾ç®€ç‰ˆæœ¬å®ç°" class="headerlink" title="ç²¾ç®€ç‰ˆæœ¬å®ç°"></a>ç²¾ç®€ç‰ˆæœ¬å®ç°</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExtensionImporter</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install</span><span class="params">(self)</span>:</span></span><br><span class="line">        sys.meta_path[:] = [x <span class="keyword">for</span> x <span class="keyword">in</span> sys.meta_path <span class="keyword">if</span> self != x] + [self]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_module</span><span class="params">(self, fullname, path=None)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> fullname.startswith(<span class="string">'flask.ext.'</span>):</span><br><span class="line">            <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load_module</span><span class="params">(self, fullname)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> fullname <span class="keyword">in</span> sys.modules:</span><br><span class="line">            <span class="keyword">return</span> sys.modules[fullname]</span><br><span class="line"></span><br><span class="line">        modname = fullname.split(<span class="string">'.'</span>)[-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        realname = <span class="string">'flask_'</span> +  modname</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            __import__(realname)</span><br><span class="line">        <span class="keyword">except</span> ImportError:</span><br><span class="line">            <span class="keyword">raise</span> ImportError(<span class="string">'No module named %s'</span> % fullname)</span><br><span class="line"></span><br><span class="line">        module = sys.modules[fullname] = sys.modules[realname]</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'.'</span> <span class="keyword">not</span> <span class="keyword">in</span> modname:</span><br><span class="line">            setattr(sys.modules[<span class="string">'flask.ext'</span>], modname, module)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> module</span><br></pre></td></tr></table></figure>
<p>ExtensionImporteræ˜¯ä¸€ä¸ªfinderå¯¹è±¡,å½“æ‰§è¡Œimport flask.extæ—¶ä¼šæŠŠå®ƒåŠ å…¥åˆ°sys.meta_pathåˆ—è¡¨ï¼Œåç»­çš„importéƒ½ä¼šå…ˆæ‰§è¡Œå®ƒï¼Œåˆ¤æ–­æ»¡è¶³è¦æ±‚åå°±ä¼šä½¿ç”¨__import__å¯¼å…¥ç„¶ååŠ å…¥åˆ°sys.modulesï¼Œè¿™æ ·å°±å®ç°äº†flask.ext.sqlalchemyå¯¼å…¥</p>
<p>ä¸ºä»€ä¹ˆä¼šè¢«åºŸé™¤å‘¢ã€‚ä¸‹é¢æ˜¯æˆ‘çŒœæµ‹çš„ã€‚é¦–å…ˆæœ¬æ¥è¿™ä¸ªä¸œè¥¿æ²¡æœ‰å®è´¨çš„ä½œç”¨ï¼Œå°±æ˜¯çœ‹ç€ç‚«é…·è€Œå·²ã€‚æˆ‘ä»¬å¯ä»¥è®¤ä¸ºæ‰€æœ‰çš„æ‰©å±•å¯¼å…¥éƒ½ä¼šä½¿ç”¨flask.ext.xxxï¼Œä½†æ˜¯è¿™å¯¹ç¬¬ä¸‰æ–¹æ‰©å±•åº“æ˜¯æœ‰è¦æ±‚çš„ï¼Œé‚£å°±æ˜¯åŒ…åå¿…é¡»ä¸ºflask_xxxæ‰è¡Œï¼Œæˆ‘çŒœæµ‹æœ‰çš„ç¬¬ä¸‰æ–¹åº“æœªå¿…éµå®ˆè¿™ä¸ªè§„åˆ™(å¦åˆ™exthook.pyä¸­ä¹Ÿä¸ä¼šå‡ºç°['flask_%s', 'flaskext.%s'flaskext.å¦å¤–ä¸€ç§å½¢å¼)ï¼Œè¿™å°±è¯´æ˜äº†æœ‰çš„ä½œè€…ä½¿ç”¨äº†flaskextxxxè¿™ç§åŒ…åã€‚å‡ºç°äº†ç¬¬äºŒç§éš¾å…å°±ä¼šå‡ºç°å¦å¤–çš„ã€‚å½“ä½¿ç”¨è€…å‘ç°å¹¶éæ‰€æœ‰çš„ç¬¬ä¸‰æ–¹æ‰©å±•éƒ½ä½¿ç”¨flask.extå¯¼å…¥çš„æ—¶å€™ã€‚ç¤¾åŒºä¹Ÿè§‰å¾—æ²¡å¿…è¦ç»´æŒäº†ï¼Œæ¯•ç«Ÿç¬¬ä¸€ä¸ªå†™è¿™ä¸ªä»£ç çš„äººæ˜¯ä¸æ˜¯å› ä¸ºåˆšåˆšäº†è§£äº†importæœºåˆ¶ï¼Œè§‰å¾—å¾ˆç‚«é…·å†™ä¸Šå»çš„å‘¢-_-,å¦å¤–è¿™ç§èŠ±å“¨çš„è®¾è®¡ä¹Ÿå¯èƒ½å¯¹ä»£ç è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½äº§ç”Ÿäº†è´Ÿé¢å½±å“ã€‚soï¼Œæœ€åè¿˜æ˜¯å›åˆ°äº†åŸæ¥çš„ä½ç½®ï¼Œç›´æ¥ä½¿ç”¨import flask_sqlalchemyå¯¼å…¥å§</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://docs.python.org/3/reference/import.html#import-hooks">å®˜æ–¹import hookæ–‡æ¡£</a><br><a href="https://github.com/Liuchang0812/slides/tree/master/pycon2015cn">pycon2015 importæ¼”è®²</a><br><a href="https://github.com/mitsuhiko/flask-sqlalchemy">flask-sqlalchemy</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Flaskçš„æ’ä»¶è¿˜æŒºå¤š,ç”¨è¿‡çš„éƒ½çŸ¥é“æ¯”å¦‚flask-sqlalchemy,å®‰è£…çš„æ—¶å€™æ˜¯ä½¿ç”¨pip install flask-sqlalchemyï¼Œä½¿ç”¨çš„æ—¶å€™å°±æˆäº†from flask.ext.sqlalchemy import SQLAlchemyã€‚ä½¿ç”¨çš„æ˜¯flask.extè€Œä¸æ˜¯flask_sqlalchemyã€‚æ„Ÿè§‰è¿˜æœ‰ç‚¹ç‰›æ°å•Š-_-ï¼Œä¸è¿‡ä»…ä»…æ˜¯çœ‹èµ·æ¥é«˜å¤§ä¸Šï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ã€‚&lt;a href=&quot;https://github.com/pallets/flask/issues/1135&quot;&gt;åœ¨2016å¹´4æœˆ13å·æ­£å¼è¢«ç§»å‡ºæ”¯æŒäº†&lt;/a&gt;ï¼Œå·²ç»ç›´æ¥å‘å‡ºä¸å»ºè®®ä½¿ç”¨çš„è­¦å‘Šã€‚æœ¬æ–‡è¿˜æ˜¯æ¥ç‚’ä¸€ä¸‹ç°é¥­ï¼Œçœ‹çœ‹å®ƒèƒŒåçš„é€»è¾‘&lt;/p&gt;
    
    </summary>
    
      <category term="Flask" scheme="https://www.zoulei.net/categories/Flask/"/>
    
    
      <category term="Flask" scheme="https://www.zoulei.net/tags/Flask/"/>
    
  </entry>
  
  <entry>
    <title>tmux</title>
    <link href="https://www.zoulei.net/2016/09/02/tmux_note/"/>
    <id>https://www.zoulei.net/2016/09/02/tmux_note/</id>
    <published>2016-09-02T07:43:22.000Z</published>
    <updated>2016-09-04T07:33:07.000Z</updated>
    
    <content type="html"><![CDATA[<p>è‡ªscreenä¹‹åtmuxæ—©å·²èº«åè¿œæ‰¬ï¼Œç„¶è€Œè¿™ä¸ªä¸œè¥¿å¯¹äºä¸€èˆ¬äººæ¥è¯´å¥½åƒå¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ï¼Œå¥½åƒè¿˜æ¯”è¾ƒéº»çƒ¦ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¥å‰çš„çœ‹æ³•ã€‚ä¸»è¦åŸå› å°±æ˜¯iterm2å·²ç»éå¸¸å®Œç¾äº†ã€‚iterm2çš„å¥½ç”¨ä¸€å®šç¨‹åº¦ä¸Šæ©ç›–äº†tmuxçš„å…‰è¾‰ã€‚å› ä¸ºiterm2æ˜¯å¼€ç®±å³ç”¨,tmuxä¸é…ç½®ä¸ä¸€å®šç”¨çš„èˆ’æœã€‚ç›´åˆ°æŸä¸€å¤©æˆ‘åœ¨youtubeä¸Šçœ‹åˆ°äº†2ä¸ªè§†é¢‘ï¼Œæˆ‘çŸ¥é“æˆ‘è¯¥æ”¹æ”¹äº†:)<br><img src="https://ficapy.b0.upaiyun.com/blogimg/gotbletu_tmux.png" alt="gotbletu_tmux"><br>æˆ‘ä¸ªäººä¹Ÿæ˜¯åˆšå…¥é—¨,ä¸‹é¢ä»‹ç»ä¸€äº›åŸºæœ¬çŸ¥è¯†ï¼Œå¸Œæœ›å¯¹è¯»è€…æœ‰æ‰€å¸®åŠ©.</p>
<a id="more"></a>
<h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><ul>
<li>tmuxåˆ†å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ï¼Œè¿™ä¸ªdockerè¿™ç§æ˜¯å¾ˆç›¸ä¼¼çš„ï¼Œæˆ‘ä»¬æ“ä½œçš„åªæ˜¯é’ˆå¯¹å®¢æˆ·ç«¯ï¼ŒæœåŠ¡ç«¯ä»¥å®ˆæŠ¤è¿›ç¨‹è¿è¡Œï¼Œè¿™æ ·å®ç°äº†æˆ‘ä»¬é€€å‡ºåä¸‹æ¬¡å†è¿›å…¥ä¾æ—§ä¿æŒäº†è¿è¡ŒçŠ¶æ€</li>
<li>session:æ¯”å¦‚ä½ åœ¨å…¬å¸æœ‰ä¸ªå·¥ä½œç¯å¢ƒï¼Œåœ¨å®¶é‡Œåˆæ˜¯å¦å¤–ä¸€ä¸ªå·¥ä½œç¯å¢ƒã€‚è¿™2ä¸ªç¯å¢ƒå·®åˆ«éå¸¸å¤§ã€‚é‚£ä¹ˆå°±ä½¿ç”¨2ä¸ªä¸åŒçš„session</li>
<li>window:ä½ åœ¨å·¥ä½œç¯å¢ƒä¸­è¦æ‰“å¼€å¤šä¸ªè½¯ä»¶ï¼ŒèŠå¤©çš„ã€BTä¸‹è½½çš„ã€å¬æ­Œçš„etc</li>
<li>pane:ä¸€ä¸ªè½¯ä»¶è¦åˆ†æˆå¤šä¸ªåŒºåŸŸè¾“å‡º</li>
<li>å½“ç„¶ä¸€èˆ¬æ¥è¯´è¶Šå°‘æ˜¯è¶Šæ–¹ä¾¿åˆ‡æ¢çš„ã€‚å°±ä¸ªäººæ¥è¯´ä¸€ä¸ªsessionå°±å¤Ÿäº†,ä¸»è¦åˆ‡æ¢æ¥è‡ªäºwindowå’Œpane</li>
<li>tmuxä¸»è¦æ¥è¯´æœ€é‡è¦çš„å°±æ˜¯å¯¹å„ä¸ªçª—å£çš„åˆ‡æ¢æ’åˆ—ç®¡ç†ï¼Œå„ç§é”®ä½ç»‘å®šä¹Ÿæ˜¯ç”¨äºå¯¹çª—å£çš„åˆ‡æ¢</li>
</ul>
<h2 id="windows-paneåŸºæœ¬è®¾ç½®"><a href="#windows-paneåŸºæœ¬è®¾ç½®" class="headerlink" title="windows,paneåŸºæœ¬è®¾ç½®"></a>windows,paneåŸºæœ¬è®¾ç½®</h2><p>å’Œvimä¸€æ ·tmuxä¹Ÿæ˜¯ä½¿ç”¨ä¸€ä¸ªä¸»è¦çš„prefix keyï¼Œå…ˆè¾“å…¥prefix keyä¹‹åå†è¾“å…¥ç»‘å®šçš„å­—æ¯æ‰§è¡Œæ“ä½œ.ä¸‹é¢å°±å°†æˆ‘ä»å¤šä¸ªåœ°æ–¹copyæ¥çš„é…ç½®è§£é‡Šä¸€ç•ª-_-</p>
<p>è®¾ç½®æˆC-a,åŒæ—¶è§£ç»‘åŸæ¥çš„C-b,æœ€åçš„bind açš„ä½œç”¨å°±æ˜¯:C-aæœ¬æ¥æ˜¯å›åˆ°è¡Œé¦–çš„å¿«æ·é”®ï¼Œè¢«tmuxä½¿ç”¨ä¹‹åä½¿ç”¨æ­¤è®¾å®šå˜æˆäº†C-a-aåˆ°è¡Œé¦–</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set -g prefix ^a&#10;unbind ^b&#10;bind a send-prefix</span><br></pre></td></tr></table></figure>
<p>ä¹‹åå°±æ˜¯å¯¹windowå’Œpaneçš„å¿«æ·é”®è®¾å®šï¼Œæœ¬äººä½¿ç”¨vimç›¸ä¼¼çš„å¿«æ·é”®è®¾å®šã€‚è¿™ä¸ªå¥½åƒæ²¡å•¥å¥½è¯´çš„ï¼Œæ¯”å¦‚hjklåœ¨paneä¸­ç§»åŠ¨,sã€våˆ†å±ï¼Œä½¿ç”¨&lt;ã€&gt;ã€+ã€_å¯¹paneè¿›è¡Œå¤§å°çš„æ”¹å˜ï¼Œä½¿ç”¨C-uã€C-dè¿›è¡Œäº¤æ¢ï¼Œä½¿ç”¨qã€C-qè¿›è¡Œå…³é—­paneå’Œwindowï¼Œä¸¾ä¸ªä¾‹å­</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bind k selectp -U&#10;bind -r &#60; resize-pane -L 10&#10;bind ^u swapp -U&#10;bind q killp</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨-r(recursion)å°±èƒ½å¤Ÿè¾“å…¥ä¸€æ¬¡&lt;ä¹‹åé©¬ä¸Šå¤šæ¬¡è¾“å…¥&lt;ã€&gt;æœ‰æ•ˆ,è¿™å¯¹äºè°ƒæ•´å¤§å°æ—¶æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚ã€‚ã€‚,æ²¡æœ‰è¢«é‡å†™çš„é…ç½®åŸºæœ¬éƒ½æ˜¯éå¸¸å¥½è®°çš„å•è¯,cã€nã€wã€dè®°è¿™äº›éƒ½æ˜¯æ¯«ä¸è´¹åŠ›çš„</p>
<h2 id="é¼ æ ‡ã€å¤åˆ¶åŠæ¸…å±è®¾ç½®"><a href="#é¼ æ ‡ã€å¤åˆ¶åŠæ¸…å±è®¾ç½®" class="headerlink" title="é¼ æ ‡ã€å¤åˆ¶åŠæ¸…å±è®¾ç½®"></a>é¼ æ ‡ã€å¤åˆ¶åŠæ¸…å±è®¾ç½®</h2><p>å¦‚æœä½ ä¸è¿›è¡Œå…¶ä»–è®¾ç½®å¯èƒ½ç”¨å‡ ä¸‹åŠ¨ä¸€ä¸‹é¼ æ ‡ä¸Šä¸‹ç¿»ä¸€ä¸‹ï¼Œå°±ä¼šé«˜å‘¼WTFã€‚æ¯•ç«Ÿå®Œå…¨ä¸åŠ¨é¼ æ ‡çš„å¤§ç¥ä¸å¤šï¼Œæˆ‘è¿˜æ˜¯æ‰“å¼€é¼ æ ‡è®¾ç½®å§,è¿™æ ·ä¹Ÿèƒ½åŒæ—¶ä½¿ç”¨é¼ æ ‡è¿›è¡Œä¸Šä¸‹æ»‘åŠ¨äº†ï¼Œå…¶æ¬¡å¤åˆ¶ä¹Ÿå’Œä»¥å‰ä¸ä¸€æ ·äº†ï¼Œç‰¹åˆ«æ˜¯å¦‚æœä½ åˆ†äº†2ä¸ªç«–å‘çš„pane,è¿™æ ·å’Œä»¥å‰ä¸€æ ·ç”¨é¼ æ ‡å¤åˆ¶å°±å‡ºé—®é¢˜äº†ï¼Œå½“ç„¶ä½ å¯ä»¥ç”¨z(zoom)å…¨å±å½“å‰çš„paneï¼Œç„¶åç”¨é¼ æ ‡å¤åˆ¶ã€‚ç„¶è€Œä¸€ä¸ªvimå…šæ˜¯ä¸ä¼šè¿™æ ·åšçš„T_Tã€‚ä¸‹é¢æ˜¯è®¾ç½®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setw -g mouse on&#10;#set vi mode for copy mode&#10;setw -g mode-keys vi&#10;&#10;# more settings to make copy-mode more vim-like&#10;unbind [&#10;bind Escape copy-mode&#10;unbind p&#10;bind p paste-buffer&#10;bind -t vi-copy &#39;v&#39; begin-selection&#10;bind -t vi-copy &#39;y&#39; copy-selection&#10;&#10;# Buffers to/from Mac clipboard, yay tmux book from pragprog&#10;bind C-c run &#34;tmux save-buffer - | reattach-to-user-namespace pbcopy&#34;&#10;bind C-v run &#34;tmux set-buffer $(reattach-to-user-namespace pbpaste); tmux paste-buffer&#34;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å¤åˆ¶å¥½åƒå˜å¾—å¤æ‚äº†ã€‚ã€‚ã€‚éœ€è¦å…ˆè¿›å…¥é€‰æ‹©æ¨¡å¼C-a-ESC-vé€‰æ‹©éœ€è¦å¤åˆ¶çš„å†…å®¹åå†æ‰§è¡Œyå¤åˆ¶åˆ°tmuxçš„ç¼“å†²åŒºï¼Œå¦å¤–åƒtmuxå’Œvimè¿™ç§çš„ç²˜è´´æ¿æ˜¯ç‹¬ç«‹çš„,å’Œosxç³»ç»Ÿçš„ç²˜è´´æ¿ä¸å…±é€š,å¦‚æœè¦å†å¤åˆ¶åˆ°ç³»ç»Ÿç²˜è´´æ¿ï¼Œæ­¤æ—¶å†ä½¿ç”¨C-a-C-c,å¥½åƒæ˜¯æ¯”è¾ƒå¤æ‚å•Šã€‚ã€‚ä½ å¯ä»¥æŒ‰ä½optionå†ç”¨é¼ æ ‡é€‰æ‹©ä¹Ÿæ˜¯ç›´æ¥å¤åˆ¶åˆ°ç³»ç»Ÿç²˜è´´æ¿ï¼Œè¦è®©vimå’Œtmuxå’Œç³»ç»Ÿç²˜è´´æ¿é€šç”¨ï¼Œä½ éœ€è¦<code>brew install reattach-to-user-namespace</code>å®‰è£…ã€‚å¦å¤–iterm2å…¶å®æ˜¯å¯ä»¥è®©ä»–ä»¬å…±ç”¨çš„ï¼Œä¸‹å›¾é€‰ä¸­Applications in terminal may access clipboardä¹Ÿèƒ½è¾¾åˆ°åŒæ ·çš„æ•ˆæœï¼Œä¸è¿‡ä¸‹é¢çš„å‚è€ƒæ–‡ç« æœ‰è¯´æœ‰ç¼ºç‚¹-_-æˆ‘å°±å¬äº†ä»–çš„äº†<br><img src="https://ficapy.b0.upaiyun.com/blogimg/iterm_access_clipboard.png" alt="iterm_access_clipboard"></p>
<p>å†å°±æ˜¯é…ç½®é‡è½½å’Œæ¸…å±</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#bind -n C-l send-keys &#39;C-l&#39;&#10;bind -n C-k send-keys -R \; send-keys C-l \; clear-history&#10;# reload config (prefix r)&#10;bind r source ~/.tmux.conf \; display &#34;Configuration reloaded!&#34;</span><br></pre></td></tr></table></figure>
<p>å°±å¥½åƒcommand+kå®Œå…¨æ¸…å±ï¼Œtmuxä¹Ÿå¯ä»¥ï¼Œä¸è¿‡éœ€è¦é…ç½®(è¿™ä¸ªå®Œç¾æ¸…å±å‘½ä»¤æ‰¾äº†å¾ˆä¹…),-nè¡¨ç¤ºä¸éœ€è¦å…ˆæŒ‰prefix keyç›´æ¥ä½¿ç”¨C-kå°±è°ƒç”¨äº†ï¼Œå¦å¤–ä¸è¦å°†C-lè®¾ç½®ä¸ºæ¸…å±,ä¼šè®©TABè¡¥å…¨å¤±æ•ˆ</p>
<h2 id="çŠ¶æ€æ "><a href="#çŠ¶æ€æ " class="headerlink" title="çŠ¶æ€æ "></a>çŠ¶æ€æ </h2><p>é…ç½®ä¸€ä¸ªå¥½çœ‹çš„çŠ¶æ€æ å¥½åƒè¿˜æ˜¯æ¯”è¾ƒå›°éš¾çš„,æˆ‘æ¯”è¾ƒå·æ‡’å°±ç›´æ¥ä½¿ç”¨äº†<a href="https://github.com/erikw/tmux-powerline">tmux-powerline</a>å’Œ<a href="https://github.com/seebi/tmux-colors-solarized/blob/master/tmuxcolors-256.conf">tmux-colors-solarized</a>,ä¸‹é¢æ˜¯æ•ˆæœ<br><img src="https://ficapy.b0.upaiyun.com/blogimg/tmux_statusbar.png" alt="tmux_statusbar"><br>æ³¨æ„é…ç½®powerlineçš„æ—¶å€™å¯èƒ½éœ€è¦åœ¨~/.zshrcä¸­åŠ å…¥<code>PS1=&quot;$PS1&quot;&#39;$([ -n &quot;$TMUX&quot; ] &amp;&amp; tmux setenv TMUXPWD_$(tmux display -p &quot;#D&quot; | tr -d %) &quot;$PWD&quot;)&#39;</code>æœ‰çš„æ—¶å€™ä¿®æ”¹é…ç½®å¯èƒ½éœ€è¦tmux kill-serveråé‡æ–°è¿›å…¥æ‰èƒ½çœ‹åˆ°æ•ˆæœ</p>
<p>åœ¨çŠ¶ä½“æ çš„é…ç½®ä¼šçœ‹åˆ°è¿™ç§<code>set-option -g status-bg colour235</code>,colour235æ˜¯ä»€ä¹ˆé¬¼é¢œè‰²ã€‚çœŸæ˜¯ä¸å¥½çŒœå•Šï¼Œå¯ä»¥å•ç‹¬å¼€ä¸€ä¸ªpaneæ‰“å°è¾“å‡ºæ‰€æœ‰256ç§é¢œè‰²ï¼Œè‡ªå·±å¯¹æ¯”ä¿®æ”¹æˆå–œæ¬¢çš„é¢œè‰²</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;0..255&#125; ; do&#10;    printf &#34;\x1b[38;5;$&#123;i&#125;mcolour$&#123;i&#125;\n&#34;&#10;done</span><br></pre></td></tr></table></figure>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>æˆ‘ä»¬è®¾ç½®å¥½äº†ä¹‹åå¯èƒ½éœ€è¦åœ¨æ‰“å¼€itermä¹‹åå°±ç›´æ¥è¿›å…¥tmux,å¦åˆ™å²‚ä¸æ˜¯ç™½å¿™æ´»~(â‰§â–½â‰¦)/~å•¦å•¦å•¦ï¼Œå¾ˆç®€å•,åœ¨itermçš„è®¾ç½®é¡µprofilesâ†’Generalâ†’Send text at startä¸­å¡«å…¥<code>tmux attach -t init || tmux new -s init</code>,æ›´æœ‰ç”¨çš„æ˜¯åœ¨æˆ‘ä»¬è¿œç¨‹åˆ°vpsä¸Šçš„æ—¶å€™ç›´æ¥è¿›å…¥åˆ°tmux,è®¾ç½®ä¸€ä¸ªåˆ«åå¦‚ä¸‹<code>alias hg=&quot;ssh -t hg \&quot;bash -c &#39;tmux a -t init || tmux new -s init&#39;\&quot;&quot;</code>è¿™æ ·æˆ‘ä»¬æ‰§è¡Œhgçš„æ—¶å€™å°±æ–°å»ºä¸€ä¸ªsessionæˆ–è€…è¿æ¥åˆ°å·²æœ‰çš„session</p>
<p>å¦‚æœæˆ‘ä»¬æœ¬åœ°å¼€ä¸€ä¸ªtmuxï¼Œç„¶åè¿œç¨‹è¿æ¥vpsï¼Œvpså†è¿è¡Œtmuxï¼Œè¿™ä¼šé€ æˆåµŒå¥—ä½¿ç”¨ã€‚ç‰¹åˆ«æ˜¯å½“ä½ çš„prefix keyè¿˜æ˜¯ä¸€æ ·çš„æ—¶å€™ã€‚ã€‚ã€‚æ‚²å‚¬äº†ï¼Œä½ æ‰€è¾“å…¥çš„å¿«æ·é”®åªä¼šè¢«æœ¬åœ°çš„tmuxå¤„ç†è€Œä¸ä¼šè¢«è¿œç¨‹çš„tmuxå“åº”ï¼Œè¦å¤„ç†è¿™ä¸ªé—®é¢˜å¯ä»¥å°†2è€…çš„prefix keyè®¾ç½®æˆä¸ä¸€æ ·,æ¯”å¦‚ä¸€ä¸ªä¸ºaå¦å¤–ä¸€ä¸ªä¸ºsã€‚æˆ–è€…ä½¿ç”¨itermå•ç‹¬å¼€ä¸€ä¸ªçª—å£ï¼Œæˆ‘æ›´æ¨èåè€…,å› ä¸ºè®¾ç½®æˆä¸åŒçš„prefix keyè¾“å…¥å¿«äº†å¯èƒ½å°±è¾“å…¥æ··æ·†å•¦ã€‚</p>
<p>å¦å¤–,ä½¿ç”¨äº†tmuxæ˜¾è‘—å¢åŠ äº†iterm2çš„è€—ç”µé‡,ä¼°è®¡æ˜¯æˆ‘è®¾ç½®çš„é‚£ä¸ªçŠ¶æ€æ æ˜¾ç¤ºä¸Šä¼ ä¸‹è½½æµé‡å¯¼è‡´çš„ï¼Œæ¯å‡ ç§’åˆ·æ–°æ‰§è¡Œä¸€æ¬¡shellæˆ–è®¸æŒºè€—ç”µ.</p>
<p><a href="https://github.com/ficapy/dotfiles/blob/master/.tmux.conf">æˆ‘çš„tmuxé…ç½®</a></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://danielmiessler.com/study/tmux/">A tmux Primer</a><br><a href="https://www.youtube.com/playlist?list=PL5BE1545D8486D66D">gotbletu youtube playlist</a><br><a href="https://evertpot.com/osx-tmux-vim-copy-paste-clipboard/">Making the clipboard work between iTerm2, tmux, vim and OS X.</a><br><a href="http://superuser.com/questions/285381/how-does-the-tmux-color-palette-work">How does the tmux color palette work?</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è‡ªscreenä¹‹åtmuxæ—©å·²èº«åè¿œæ‰¬ï¼Œç„¶è€Œè¿™ä¸ªä¸œè¥¿å¯¹äºä¸€èˆ¬äººæ¥è¯´å¥½åƒå¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ï¼Œå¥½åƒè¿˜æ¯”è¾ƒéº»çƒ¦ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¥å‰çš„çœ‹æ³•ã€‚ä¸»è¦åŸå› å°±æ˜¯iterm2å·²ç»éå¸¸å®Œç¾äº†ã€‚iterm2çš„å¥½ç”¨ä¸€å®šç¨‹åº¦ä¸Šæ©ç›–äº†tmuxçš„å…‰è¾‰ã€‚å› ä¸ºiterm2æ˜¯å¼€ç®±å³ç”¨,tmuxä¸é…ç½®ä¸ä¸€å®šç”¨çš„èˆ’æœã€‚ç›´åˆ°æŸä¸€å¤©æˆ‘åœ¨youtubeä¸Šçœ‹åˆ°äº†2ä¸ªè§†é¢‘ï¼Œæˆ‘çŸ¥é“æˆ‘è¯¥æ”¹æ”¹äº†:)&lt;br&gt;&lt;img src=&quot;https://ficapy.b0.upaiyun.com/blogimg/gotbletu_tmux.png&quot; alt=&quot;gotbletu_tmux&quot;&gt;&lt;br&gt;æˆ‘ä¸ªäººä¹Ÿæ˜¯åˆšå…¥é—¨,ä¸‹é¢ä»‹ç»ä¸€äº›åŸºæœ¬çŸ¥è¯†ï¼Œå¸Œæœ›å¯¹è¯»è€…æœ‰æ‰€å¸®åŠ©.&lt;/p&gt;
    
    </summary>
    
      <category term="linux" scheme="https://www.zoulei.net/categories/linux/"/>
    
    
  </entry>
  
  <entry>
    <title>fasdå’Œfzf</title>
    <link href="https://www.zoulei.net/2016/08/29/fasd&amp;fzf/"/>
    <id>https://www.zoulei.net/2016/08/29/fasd&amp;fzf/</id>
    <published>2016-08-29T13:55:24.000Z</published>
    <updated>2016-08-30T07:24:19.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ¥2ä¸ªæ—¥å¸¸ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·ç©ä¸€ç©ï¼Œå‰ä¸€ä¸ªæ˜¯ç›®å½•å¿«é€Ÿè·³è½¬ï¼Œåä¸€ä¸ªæ˜¯ä½¿ç”¨cursesæ¨¡ç³ŠæŸ¥æ‰¾</p>
<a id="more"></a>
<h2 id="fasd"><a href="#fasd" class="headerlink" title="fasd"></a><a href="https://github.com/clvv/fasd">fasd</a></h2><p>ç›®å½•å¿«é€Ÿè·³è½¬å·¥å…·æŒºå¤šçš„autojump,z.æˆ‘æœ€å¼€å§‹ç”¨çš„æ˜¯zï¼Œç”¨é•¿äº†æ„Ÿè§‰å¥½åƒæœ‰bug,ç„¶åå°±æ¢fasd.<code>å¥½åƒ</code>æ„Ÿè§‰å¥½ç”¨é‚£ä¹ˆä¸€ç‚¹ç‚¹ã€‚è¿™ç§å·¥å…·åŸç†éƒ½å·®ä¸å¤šã€‚å¯¹ä½ çš„å†å²è¾“å…¥è¿›è¡Œç»Ÿè®¡ï¼Œæ”¾å…¥æ•°æ®åº“ã€‚ç„¶åæ ¹æ®ä½ è¾“å…¥çš„ç»“æœä»æ•°æ®åº“åŒ¹é…è¾¾åˆ°å¿«é€Ÿcdçš„ç»“æœã€‚å®‰è£…å¥½åç›´æ¥è¾“å…¥fasd,å°±å¯ä»¥çœ‹åˆ°å¾—åˆ†ä»¥åŠç›®å½•/æ–‡ä»¶ã€‚ä»å®ƒçš„åŸç†ä¹Ÿèƒ½å¯ä»¥çœ‹å‡ºæ¥ã€‚å®ƒåªèƒ½å¯¹æœ‰è®°å½•çš„å¿«é€Ÿåˆ‡æ¢(ä»ä½ å®‰è£…è¿™ä¸ªè½¯ä»¶å¼€å§‹è®°å½•)ã€‚å¯¹äºä¸€ä¸ªæ–°çš„ç›®å½•é¦–æ¬¡è®¿é—®è¿˜æ˜¯éœ€è¦ç”¨cdã€‚è¿™ä¸ªè½¯ä»¶ä¸ªå¸¸ç”¨çš„å‘½ä»¤ä¹Ÿå°±2ä¸ª<br>zå’Œvï¼Œåˆ†åˆ«ä»£è¡¨åˆ‡æ¢ç›®å½•å’Œä½¿ç”¨$EDITORæ‰“å¼€æ–‡ä»¶.æ‰€ä»¥:</p>
<ul>
<li>å½“ä½ éœ€è¦å¿«é€Ÿcdåˆ°ä»¥å‰æ‰“å¼€è¿‡çš„ç›®å½•ç”¨z,å½“ä½ é¦–æ¬¡æ‰“å¼€ä¸€ä¸ªç›®å½•ç”¨cd(æˆ–è€…æ‰“å¼€å½“å‰ç›®å½•)ï¼›</li>
<li>å½“ä½ éœ€è¦ç”¨vimæ‰“å¼€ä»¥å‰æ‰“å¼€çš„æ–‡ä»¶ç”¨v,é¦–æ¬¡æ‰“å¼€æˆ–ç¡®å®šç›®å½•vim</li>
<li>å®ƒçœŸçš„å¾ˆæ–¹ä¾¿äº†,æˆ‘çœ‹åˆ°æœ‰äº›äººæŠŠå®ƒå’Œfzfåˆèµ·æ¥ä¸€èµ·ç”¨ã€‚æˆ‘æƒ³äº†å¾ˆä¹…ï¼Œé™¤äº†è£…é€¼é™ä½æ•ˆç‡ã€‚æˆ‘æ²¡æƒ³åˆ°æœ‰ä»€ä¹ˆç”¨</li>
</ul>
<h2 id="fzf"><a href="#fzf" class="headerlink" title="fzf"></a><a href="https://github.com/junegunn/fzf">fzf</a></h2><p>è¿™æ¬¾è½¯ä»¶å¯¹äºæé«˜å‘½ä»¤è¡Œæ•ˆç‡ä¹Ÿæ˜¯å¾ˆç‰›é€¼,è€Œä¸”çœ‹githubä¸Šé¢çš„æäº¤è®°å½•ï¼Œä¾æ—§éå¸¸æ´»è·ƒ(å¯¹äºä¸€ä¸ªå°ç™½æ²¡ä»€ä¹ˆæ¯”é¡¹ç›®çš„æ´»è·ƒæ›´é‡è¦äº†ï¼Œå› ä¸ºå®ƒæ„å‘³ç€ä½ å¯èƒ½é‡åˆ°çš„å‘å‰äººéƒ½å¯èƒ½å·²ç»è¶Ÿè¿‡).è€Œä¸”è¿™ä¸ªé¡¹ç›®çš„ä½œè€…å¥½åƒéå¸¸è‡ªä¿¡,é¡¹ç›®è¯´æ˜é‡Œé¢å±…ç„¶åªåˆ—ä¸¾äº†ä¼˜ç‚¹ï¼Œä¸æ¯«æ²¡æœ‰ç¼ºç‚¹.</p>
<p>è¿™æ˜¯ä¸€æ¬¾å®‰è£…ä¸Šå»å°±èƒ½è®©ä½ çœ¼å‰ä¸€äº®çš„è½¯ä»¶ã€‚æ¯”å¦‚Ctrl+Rï¼Œå®Œç¾æ›¿æ¢äº†shellé»˜è®¤çš„å†å²è®°å½•åŠŸèƒ½,å½“è¾“å…¥æŒ‡ä»¤çš„æ—¶å€™ä½¿ç”¨ctrl+Tå°±èƒ½åˆ—å‡ºå½“å‰ç›®å½•ä¸‹æ‰€æœ‰çš„æ–‡ä»¶ã€‚å½“ç„¶è¿™åªæ˜¯åˆ—ä¸¾çš„2ä¸ªæœ€å¸¸ç”¨çš„åŠŸèƒ½,å®é™…ä¸Šï¼Œå®ƒçš„æ½œåŠ›è¿œä¸æ­¢è¿™ä¹ˆç‚¹ï¼Œå¦‚æœä½ ç”¨è¿‡osxä¸Šè¢«äººå¹æˆç¥çš„alfred,é‚£ä¹ˆfzfçš„æ¦‚å¿µå¯èƒ½å’Œå®ƒæœ‰ä¸€å®šçš„ç›¸ä¼¼æ€§(å–å¾—ä¸€äº›ç»“æœ,ç„¶åä½¿ç”¨åˆ—è¡¨æ’é™¤å‡ºæ¥),ä¸¾ä¸ªä¾‹å­,IDEä¸­æˆ‘ä»¬ç»å¸¸ä½¿ç”¨å…¨å±€æ›¿æ¢,ç”¨ä»¥ä¸‹å‘½ä»¤ä¹Ÿèƒ½æå®š<br><code>grep -rn &#39;python&#39;| fzf -m | awk -F &#39;:&#39; &#39;{print $1}&#39; | xargs -L 1 sed -i -e &#39;s/python/hello/g&#39;</code><br>æ•ˆæœå¦‚ä¸‹<img src="https://ficapy.b0.upaiyun.com/blogimg/fzf_grep_sed.gif" alt="fzf_grep_sed"><br>è§£é‡Šä¸€ä¸‹ï¼Œ</p>
<ol>
<li>ä½¿ç”¨grepé€’å½’åŒ¹é…å½“å‰ç›®å½•å«æœ‰pythonçš„æ–‡ä»¶,-rä¸ºé€’å½’ï¼Œ-nä¸ºæ˜¾ç¤ºè¡Œå·ã€‚</li>
<li>ä½¿ç”¨fzfæ˜¾ç¤ºå‡ºæ¥,-mä¸ºå¤šè¡Œæ¨¡å¼,ä½¿ç”¨tabä¸ºé€‰æ‹©æˆ–è€…å–æ¶ˆé€‰æ‹©ã€‚</li>
<li>ä½¿ç”¨awkå¯¹é€‰æ‹©çš„çš„ç»“æœè¿›è¡Œå¤„ç†,-Fä¸ºé€‰æ‹©åˆ†éš”ç¬¦ï¼Œç»“æœä¸ºå¤šä¸ªç›®å½•</li>
<li>ä½¿ç”¨xargså¯¹ç»“æœæ‰§è¡Œsedæ›¿æ¢,-Lä¸ºå¯¹æ¯ä¸€ä¸ªéç©ºè¡Œæ‰§è¡Œåç»­å‘½ä»¤(Call utility for every number non-empty lines read.  A line ending with a space continues to the next non-empty line)</li>
<li>å¦å¤–grepçš„æ•ˆç‡æ˜¯éå¸¸é«˜çš„,å¦‚æœä½ ç›´æ¥ç”¨sedè¿›è¡Œå…¨å±€æ›¿æ¢-_-æ–‡ä»¶ä¸€å¤šè¿˜æ˜¯å¾ˆèŠ±è´¹æ—¶é—´æ»´,æ¯”å¦‚è¿™ç§<code>sed -i -- &#39;s/foo/bar/g&#39; **/*(D.)</code></li>
</ol>
<h3 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h3><p>è™½ç„¶ä½œè€…æ²¡æœ‰åˆ—ä¸¾å‡ºæ¥,æˆ‘è¿˜æ˜¯å°±æˆ‘çš„ä¸ªäººæ„Ÿè§‰è¯´ä¸€ä¸‹</p>
<ol>
<li>è ¢åˆ°å®¶çš„åŒ¹é…æ•ˆæœ,ä½ å¾ˆéš¾ç†è§£å®ƒæ˜¯æ ¹æ®ä»€ä¹ˆç»™ä½ åŒ¹é…çš„,æ”¾ä¸€å¼ å›¾<img src="http://ficapy.b0.upaiyun.com/blogimg/fzf_match.png" alt="fzf_match">ï¼Œå°±è¿™åŒªå¤·æ‰€æ€çš„åŒ¹é…ï¼Œä½ ä¸å¾—ä¸ä½¿ç”¨^$!ç­‰é¢å¤–çš„è§„åˆ™æˆ–è€…å¤šè¾“å…¥ä¸€äº›å­—ç¬¦ç„¶åä¸Šä¸‹é”®é€‰æ‹©</li>
<li>çœ‹ç€ç‚«é…·,æœ‰æ—¶å€™æ²¡å¿…è¦é‚£ä¹ˆç‚«é…·ï¼Œæ¯”å¦‚ä½¿ç”¨zçš„æ—¶å€™tabå¦‚æœæœ‰å¤šä¸ªé€‰æ‹©ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœä½ ç”¨fzfæ›¿ä»£ï¼Œä»–ä¼šä½¿ç”¨curseså…¨å±è®©ä½ é€‰æ‹©,å…¶å®æ•´ä¸ªè¿‡ç¨‹å·²ç»å¤šè¾“å…¥äº†å¥½å¤šå­—ç¬¦.</li>
</ol>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>fasdå’Œfzfçš„å¾ˆå¥½ç”¨ï¼Œè€Œä¸”å®ƒä»¬éƒ½ä¸éœ€è¦ä»»ä½•é…ç½®éƒ½èƒ½è®©ä½ æ„Ÿåˆ°é«˜æ•ˆ!å¯¹äºfzfå¦‚æœä½ èŠ±æ—¶é—´é…ç½®æ˜¯æœ‰ç‰¹åˆ«å¤šç©æ³•çš„ï¼Œå¯ä»¥å‚ç…§å®˜ç½‘<a href="https://github.com/junegunn/fzf/wiki/examples">fzf_examples</a>å’Œ<a href="https://www.youtube.com/playlist?list=PLqv94xWU9zZ2fMsMMDF4PjtNHCeBFbggD">gotbletuçš„è§†é¢‘æ•™ç¨‹</a>ä½“éªŒå®ƒçš„å¼ºå¤§ã€‚å¦å¤–ï¼Œå¦‚æœä½ å–œæ¬¢è¿™2ä¸ªè½¯ä»¶ï¼Œé‚£ä¹ˆä½ ä¸€å®šä¼šå–œæ¬¢<a href="https://github.com/zsh-users/zsh-autosuggestions">zsh-autosuggestions</a>è¯•ä¸€è¯•å§~~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æ¥2ä¸ªæ—¥å¸¸ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·ç©ä¸€ç©ï¼Œå‰ä¸€ä¸ªæ˜¯ç›®å½•å¿«é€Ÿè·³è½¬ï¼Œåä¸€ä¸ªæ˜¯ä½¿ç”¨cursesæ¨¡ç³ŠæŸ¥æ‰¾&lt;/p&gt;
    
    </summary>
    
      <category term="linux" scheme="https://www.zoulei.net/categories/linux/"/>
    
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨shellä¿®æ”¹osxçš„CapsLockæ˜ å°„</title>
    <link href="https://www.zoulei.net/2016/08/29/use_shell_modifier_capslock_map_on_osx/"/>
    <id>https://www.zoulei.net/2016/08/29/use_shell_modifier_capslock_map_on_osx/</id>
    <published>2016-08-29T03:24:33.000Z</published>
    <updated>2016-08-29T03:49:10.000Z</updated>
    
    <content type="html"><![CDATA[<p>å¯¹äºå‘½ä»¤è¡Œçˆ±å¥½è€…,å¾ˆå¤šäººä¼šé€‰æ‹©å°†é»„é‡‘é”®ç›˜ä½ç½®CapsLockæ›¿æ¢æˆCtrl,æœ‰äº›äººé€‰æ‹©ä»…ä»…æ˜¯å’Œé»˜è®¤çš„Ctrlè¿›è¡Œæ›¿æ¢ï¼Œæœ‰äº›äººæ›´æç«¯ï¼Œç›¸å½“äºå»æ‰CapsLocké”®å¢åŠ ä¸€ä¸ªCtrlä½ç½®ã€‚æˆ‘é€‰æ‹©åè€…ã€‚æœ‰æ—¶å€™ä¼šæƒ³ã€‚å‡å¦‚éœ€è¦è¾“å…¥å¤§æ®µæ–‡å­—çš„æ—¶å€™ä¸€ç›´æŒ‰ä½Shiftå²‚ä¸æ˜¯è›‹ç–¼ã€‚æœç´¢äº†ä¸‹ï¼Œç½‘ä¸ŠçœŸæœ‰è¿™ä¸ªé—®é¢˜ã€‚è€Œä¸”æœ‰äººè¿˜ç»™å‡ºäº†ç­”æ¡ˆã€‚æˆ‘å°±è½¬å‘ä¸€ä¸‹å¥½äº†-_-</p>
<ul>
<li>é¦–å…ˆä½ è¦çŸ¥é“åœ¨ä½ çš„<code>system preferencesâ†’keyboardâ†’modifiers keys</code>æ˜¯å¯ä»¥ä¿®æ”¹CapsLockæ˜ å°„<br>åˆ°Ctrlçš„</li>
<li>å…¶æ¬¡ä½¿ç”¨applescriptå¯ä»¥ç¼–è¾‘è„šæœ¬å¯¹GUIç•Œé¢è¿›è¡Œæ“ä½œ(ç³»ç»Ÿè¿˜è‡ªå¸¦ä¸€ä¸ªScript Editor,ä¸å¾—ä¸åæ§½ä¸€ä¸‹,è„šæœ¬çœŸä¸ç¾è§‚)</li>
<li>è„šæœ¬ç¼–å†™åæ‰§è¡Œéœ€è¦åˆ°å®‰å…¨è®¾ç½®é‡Œé¢æ·»åŠ è®¸å¯æƒé™(<code>system preferencesâ†’security&amp;privacyâ†’accessibility</code>,ç”±äºæˆ‘ä½¿ç”¨çš„æ˜¯iTerm,å°†å®ƒåŠ å…¥å°±å¥½äº†)</li>
</ul>
<p>æœ€åå¥‰ä¸Šè„šæœ¬(æ·»åŠ è‡³~/.zshrc,!!!!ä»…å¯¹è‹±æ–‡ç³»ç»Ÿæœ‰æ•ˆ,ä¸­æ–‡ä¼°è®¡æ”¹ä¸€ä¸‹ä¹Ÿèƒ½ç”¨)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">caps () &#123;&#10;&#9;osascript &#62; /dev/null &#60;&#60;EOF&#10;    tell application &#34;System Preferences&#34;&#10;        reveal anchor &#34;keyboardTab&#34; of pane &#34;com.apple.preference.keyboard&#34;&#10;    end tell&#10;    tell application &#34;System Events&#34; to tell window 1 of process &#34;System Preferences&#34;&#10;        click button 1 of tab group 1&#10;        tell sheet 1&#10;            tell pop up button 4&#10;                click&#10;                delay 0.1&#10;                if value is &#34;&#8682; Caps Lock&#34; then&#10;                    click menu item 2 of menu 1&#10;                    log &#34;Change Caps Lock&#34;&#10;                else&#10;                    click menu item 1 of menu 1&#10;                    log &#34;Restore Caps Lock&#34;&#10;                end if&#10;            end tell&#10;            click button &#34;OK&#34;&#10;        end tell&#10;    end tell&#10;    quit application &#34;System Preferences&#34;&#10;EOF&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://superuser.com/questions/495956/controlling-modifier-key-behavior-via-the-terminal-on-mac">Controlling modifier key behavior via the terminal on mac</a><br><a href="http://apple.stackexchange.com/questions/103621/run-applescript-from-bash-script">Run AppleScript from bash script</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¯¹äºå‘½ä»¤è¡Œçˆ±å¥½è€…,å¾ˆå¤šäººä¼šé€‰æ‹©å°†é»„é‡‘é”®ç›˜ä½ç½®CapsLockæ›¿æ¢æˆCtrl,æœ‰äº›äººé€‰æ‹©ä»…ä»…æ˜¯å’Œé»˜è®¤çš„Ctrlè¿›è¡Œæ›¿æ¢ï¼Œæœ‰äº›äººæ›´æç«¯ï¼Œç›¸å½“äºå»æ‰CapsLocké”®å¢åŠ ä¸€ä¸ªCtrlä½ç½®ã€‚æˆ‘é€‰æ‹©åè€…ã€‚æœ‰æ—¶å€™ä¼šæƒ³ã€‚å‡å¦‚éœ€è¦è¾“å…¥å¤§æ®µæ–‡å­—çš„æ—¶å€™ä¸€ç›´æŒ‰ä½Shiftå²‚ä¸æ˜¯è›‹ç–¼ã€‚æœç´¢äº†ä¸‹ï¼Œç½‘
    
    </summary>
    
      <category term="ä¼ªæŠ€æœ¯" scheme="https://www.zoulei.net/categories/%E4%BC%AA%E6%8A%80%E6%9C%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨Dockeré…ç½®é™æ€åšå®¢</title>
    <link href="https://www.zoulei.net/2016/08/21/docker_static_blog/"/>
    <id>https://www.zoulei.net/2016/08/21/docker_static_blog/</id>
    <published>2016-08-21T01:29:29.000Z</published>
    <updated>2016-08-29T13:53:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>é¦–å…ˆè¿™æ˜¯ç¯‡æ°´æ–‡:),ä»…è®°å½•ä¸‹è¿™2å¤©ä½¿ç”¨dockerçš„æƒ…å†µã€‚å®é™…ä¸Šå’Œdockeræ²¡ä»€ä¹ˆå…³ç³»,é™æ€åšå®¢å˜›,ç”Ÿæˆä¹‹åä¸Šä¼ åˆ°vpsç„¶åä¸Šé¢æ”¾ä¸ªnginxå°±å¥½äº†ï¼Œæ²¡ä»€ä¹ˆéœ€è¦æ“å¿ƒçš„</p>
<a id="more"></a>
<p>æ­¥éª¤å¦‚ä¸‹(æœåŠ¡ç«¯)ï¼š</p>
<ol>
<li>å‚ç…§dockerå®˜æ–¹æ–‡æ¡£å®‰è£…ä¸Šdocker,æœ€è€—æ—¶çš„å°±æ˜¯è¿™ä¸€æ­¥äº†ï¼Œå› ä¸ºdockerè™½ç„¶å‘å±•å‡ å¹´äº†ï¼Œå¯æ˜¯è¿˜æ˜¯å¤„äºä¸æ–­å®Œå–„ä¸­ã€‚è¿å®‰è£…æ–¹å¼éƒ½ä¸æ˜¯ç®€å•çš„<code>apt-get install xx</code>æå®š(å¦å¤–ç°åœ¨dockeræ”¯æŒçš„æœ€ä½ç‰ˆæœ¬å·æ˜¯3.1,æ„å‘³ç€openvzæ˜¯æ— æ³•ä½¿ç”¨çš„ï¼Œå› ä¸ºopenvzçš„å†…æ ¸ç‰ˆæœ¬å·æ˜¯2.6.32ï¼Œä¸”æ— æ³•å‡çº§)</li>
<li>åœ¨ä½ å­˜æ”¾é™æ€æ–‡ä»¶çš„ç›®å½•ä¸‹æ‰§è¡Œ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --restart=always -p 80:80 -v `pwd`:/usr/share/nginx/html nginx</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>è§£é‡Šä¸€ä¸‹:</p>
<ul>
<li>då‚æ•°è¡¨ç¤ºä»¥detach,ä»¥åå°è¿›ç¨‹å½¢å¼ä¸€ç›´è¿è¡Œ</li>
<li><code>--restart=always</code>å½“å®¹å™¨å› ä¸ºå¼‚å¸¸é€€å‡ºç”šè‡³è¢«rebooté‡å¯æ“ä½œåæ— é™è‡ªåŠ¨é‡å¯</li>
<li>på‚æ•°ï¼Œç”¨è¿‡vagrantçš„æ¯”è¾ƒå¥½ç†è§£ï¼Œè™šæ‹Ÿæœºéƒ½æœ‰è¿™ä¹ˆä¸ªç©æ„å„¿ã€‚ç«¯å£æ˜ å°„</li>
<li>vå‚æ•°ã€‚vagrantä¹Ÿæœ‰è¿™ä¸ªæ¦‚å¿µã€‚æ–‡ä»¶å¤¹å…±äº«</li>
<li>è‡³äºå…±äº«çš„ç›®å½•,é‚£æ˜¯å› ä¸ºå®¹å™¨å†…nginxé»˜è®¤çš„é…ç½®æ—¢å¦‚æ­¤ã€‚é»˜è®¤æ–‡ä»¶ä½ç½®ä¸º/usr/share/nginx/htmlã€‚è¿™ä¸ªåœ°æ–¹å‰åçš„åœ°å€å¿…é¡»éƒ½æ˜¯ç»å¯¹åœ°å€ã€‚æ„Ÿè§‰è¦æ˜¯èƒ½ç”¨ç›¸å¯¹å°±å¥½äº†</li>
<li>å¦‚æœä½ è¦å»å®¹å™¨å†…çœ‹çœ‹å®ƒnginxçš„é…ç½®å•¥çš„æ‰§è¡Œ(exité€€å‡º)<code>docker run -it --restart=always -p 80:80 -v `pwd`:/usr/share/nginx/html nginx /bin/bash</code></li>
</ul>
<p>è‡³äºå®¢æˆ·ç«¯,ç”¨rsyncåŒæ­¥å°±å¥½äº†ã€‚æˆ‘ç”¨çš„æ˜¯hexoé™æ€åšå®¢ç”Ÿæˆå™¨ã€‚ä½¿ç”¨<a href="https://github.com/hexojs/hexo-deployer-rsync">https://github.com/hexojs/hexo-deployer-rsync</a>è¿™ä¸ªé…åˆssh configé…ç½®ä¸€ä¸‹å°±å¥½äº†ã€‚å¾ˆç®€å•O_o</p>
<p>å¦å¤–ç›®å‰æœ¬äººå°†è¿™ä¸ªé™æ€åšå®¢æ”¾åœ¨äº†3ä¸ªåœ°æ–¹:</p>
<ol>
<li>hostkerä½¿ç”¨gitéƒ¨ç½²<a href="https://www.zoulei.net">https://www.zoulei.net</a></li>
<li>github pagesä½¿ç”¨gitéƒ¨ç½²<a href="https://ficapy.github.io">https://ficapy.github.io</a></li>
<li>128M vps rsyncåŒæ­¥<a href="https://www.ficapy.com">https://www.ficapy.com</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;é¦–å…ˆè¿™æ˜¯ç¯‡æ°´æ–‡:),ä»…è®°å½•ä¸‹è¿™2å¤©ä½¿ç”¨dockerçš„æƒ…å†µã€‚å®é™…ä¸Šå’Œdockeræ²¡ä»€ä¹ˆå…³ç³»,é™æ€åšå®¢å˜›,ç”Ÿæˆä¹‹åä¸Šä¼ åˆ°vpsç„¶åä¸Šé¢æ”¾ä¸ªnginxå°±å¥½äº†ï¼Œæ²¡ä»€ä¹ˆéœ€è¦æ“å¿ƒçš„&lt;/p&gt;
    
    </summary>
    
      <category term="ä¼ªæŠ€æœ¯" scheme="https://www.zoulei.net/categories/%E4%BC%AA%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="docker" scheme="https://www.zoulei.net/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>werkzeugæºç åˆ†æ(Debugæ¨¡å—)</title>
    <link href="https://www.zoulei.net/2016/08/07/werkzeug_debug_note/"/>
    <id>https://www.zoulei.net/2016/08/07/werkzeug_debug_note/</id>
    <published>2016-08-07T00:43:31.000Z</published>
    <updated>2016-09-04T07:32:59.000Z</updated>
    
    <content type="html"><![CDATA[<p>flaskçš„debugçœ‹èµ·æ¥è¿˜æ˜¯å¾ˆç¥å¥‡çš„ï¼Œå¯ä»¥åœ¨å¼‚å¸¸é¡µé¢æŸ¥çœ‹å½“å‰è°ƒç”¨æ ˆï¼Œä¸”èƒ½å¤Ÿåœ¨å½“å‰æ ˆå†…è¿›è¡Œäº¤äº’å¼ä¼šè¯ç”¨ä»¥è°ƒè¯•ã€‚æœ¬æ–‡å°†ä¼šä»pythonçš„REPLè¿›è¡Œè¯´æ˜å¹¶å»¶ä¼¸åˆ°flaskã€‚çœ‹çœ‹å®ƒçš„å…·ä½“å®ç°</p>
<a id="more"></a>
<h3 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h3><p>pythonçš„è¿è¡Œæ˜¯è®²æºç è¿›è¡Œç¼–è¯‘ï¼Œä¹‹åè™šæ‹Ÿæœºæ‰§è¡Œã€‚è¿™2ä¸ªæ­¥éª¤pythonéƒ½æä¾›äº†æ¥å£,compileå’Œexecã€‚execçš„æ‰§è¡Œä¼šè°ƒç”¨compile,æˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šä¸»åŠ¨å»è°ƒç”¨compileã€‚compileè¿™ä¸ªå‡½æ•°æœ‰ä¸‰ä¸ªæ¨¡å¼<a href="https://docs.python.org/3/library/functions.html#compile">å®˜æ–¹æ–‡æ¡£</a> <a href="http://stackoverflow.com/questions/2220699/whats-the-difference-between-eval-exec-and-compile-in-python">stackoverflow</a></p>
<ul>
<li>exec:ä¸€ç³»åˆ—å£°æ˜</li>
<li>eval:å•æ¡è¡¨è¾¾å¼</li>
<li>single:å•æ¡å£°æ˜,å’Œexecä¸åŒçš„æ˜¯å½“è¿”å›ä¸ä¸ºNoneçš„æ—¶å€™æ‰§è¡Œçš„æ—¶å€™ä¼šæ‰“å°ã€‚è¿™ä¸€æƒ³éƒ½çŸ¥é“ä¸“é—¨æ˜¯ä¸ºäº¤äº’å¼ç¯å¢ƒå‡†å¤‡çš„</li>
</ul>
<p>ç¼–è¯‘ä¹‹åä¸ç”¨è¯´ã€‚ä½¿ç”¨å†…å»ºå‡½æ•°execæ‰§è¡Œå°±å¥½å•¦ã€‚å®ƒå¸¦æœ‰2ä¸ªå¯é€‰å‚æ•°,å…¨å±€ç©ºé—´å˜é‡åŠå±€éƒ¨ç©ºé—´å˜é‡ã€‚çœ‹ä¸€ä¸ªä¾‹å­<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">local = &#123;&#125;</span><br><span class="line">code = compile(<span class="string">'a=1'</span>, filename=<span class="string">'&lt;string&gt;'</span>, mode=<span class="string">'single'</span>)</span><br><span class="line">print(code)</span><br><span class="line">exec(code,local)</span><br><span class="line">code = compile(<span class="string">'a+=1'</span>, filename=<span class="string">'&lt;string&gt;'</span>, mode=<span class="string">'single'</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    exec(code)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    print(<span class="string">'Error'</span>)</span><br><span class="line">exec(code,local)</span><br><span class="line">print(local.get(<span class="string">'a'</span>))</span><br><span class="line">code = compile(<span class="string">'x+=1'</span>,filename=<span class="string">'&lt;string&gt;'</span>,mode=<span class="string">'single'</span>)</span><br><span class="line">print(code)</span><br><span class="line"><span class="comment"># &lt;code object &lt;module&gt; at 0x10fd9dc90, file "&lt;string&gt;", line 1&gt;</span></span><br><span class="line"><span class="comment"># Error</span></span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line"><span class="comment"># &lt;code object &lt;module&gt; at 0x105c25c90, file "&lt;string&gt;", line 1&gt;</span></span><br></pre></td></tr></table></figure></p>
<ol>
<li>ç¼–è¯‘çš„æ—¶å€™åªè¦è¯­æ³•æ²¡æœ‰é—®é¢˜å°±å¯ä»¥é€šè¿‡ï¼Œçœ‹x+=1,å³ä½¿å…¨å±€å˜é‡ä¸å­˜åœ¨xä¹Ÿèƒ½å¤Ÿç¼–è¯‘é€šè¿‡</li>
<li>ä½¿ç”¨execçš„æ—¶å€™ï¼Œå¯ä»¥å¼•å…¥ä¸€ä¸ªå­—å…¸ï¼Œå¦åˆ™ä¼šè‡ªåŠ¨ä½¿ç”¨é»˜è®¤çš„global,æœ‰äº†è¿™ä¸ªå­—å…¸æˆ‘ä»¬å°±å¯ä»¥è¿æ¥ä¸Šä¸‹æ–‡ï¼Œæƒ³ä¸€æƒ³ã€‚è¦æ˜¯æˆ‘ä»¬æ‰§è¡Œa=1ï¼Œå¦‚æœæ²¡æœ‰è®°å½•ã€‚é‚£ä¹ˆåé¢æ‰§è¡Œa+=1å°±ä¼šæŠ¥é”™äº†ï¼Œè¿™è‚¯å®šä¸æ˜¯æˆ‘ä»¬æ‰€å¸Œæœ›çš„</li>
</ol>
<h3 id="è‡ªå¸¦REPL"><a href="#è‡ªå¸¦REPL" class="headerlink" title="è‡ªå¸¦REPL"></a>è‡ªå¸¦REPL</h3><p>è¦å®ç°ä¸€ä¸ªç±»ä¼¼çš„IDLEç¯å¢ƒ2æ¡è¯­å¥å°±å¤Ÿäº†<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> code</span><br><span class="line">code.interact()</span><br></pre></td></tr></table></figure><br>çœ‹è°ƒç”¨å›¾<br><img src="http://ficapy.b0.upaiyun.com/blogimg/code_interactiveconsole.png" alt="code_interactiveconsole"><br>ä¼šæ¶‰åŠåˆ°2ä¸ªæ¨¡å—ï¼Œcodeå’Œcodeopï¼Œè¿™2ä¸ªæ¨¡å—å¯ä»¥éƒ½è¯´æ˜¯ä¸ºç”Ÿæˆäº¤äº’å¼è§£é‡Šå™¨æœåŠ¡çš„ã€‚codeæ¨¡å—ä½œç”¨æ˜¯æ¥æ”¶è¯·æ±‚ç„¶åè§£æå†æ‰§è¡Œ(exec)ã€‚è§£æéƒ¨åˆ†å°±æ˜¯ç”±codeopæä¾›çš„ã€‚è®¾æƒ³ä¸€ä¸‹ä¸ºä»€ä¹ˆæœ‰äº†compileè¿˜éœ€è¦ä¸€ä¸ªå•ç‹¬çš„codeopæ¨¡å—ã€‚<br>æˆ‘ä»¬ä½¿ç”¨äº¤äº’å¼è§£é‡Šå™¨çš„æ—¶å€™å¹¶ä¸æ˜¯æ‰€æœ‰çš„å‘½ä»¤éƒ½æ˜¯ä¸€è¡Œè¾“å…¥å®Œæˆçš„ã€‚æ¯”å¦‚è¾“å…¥ä¸€ä¸ªå‡½æ•°ï¼Œé‚£å°±éœ€è¦å¤šè¡Œã€‚å°†æˆ‘ä»¬è¾“å…¥çš„å¤šè¡Œç¼–è¯‘ä¸€æ¬¡ã€‚è¿™æ˜¯æˆ‘ä»¬çš„éœ€æ±‚ã€‚codeopå°±æ˜¯ä¸ºè¿™ä¸ªè€Œå­˜åœ¨çš„ã€‚æ¯”å¦‚ä½ æ‰§è¡Œcodeop.compile_command(â€˜math(â€˜)ä¼šè¿”å›Noneã€‚è¿™å°±ä»£è¡¨ä½ ä¸‹ä¸€è¡Œç»§ç»­è¾“å…¥ï¼Œç›´åˆ°ä½ è¿ç»­è¾“å…¥äº†2ä¸ªç©ºè¡Œã€‚å¥½äº†ï¼Œå®ƒçŸ¥é“ä½ è¾“å…¥å®Œæˆäº†ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runsource</span><span class="params">(self, source, filename=<span class="string">"&lt;input&gt;"</span>, symbol=<span class="string">"single"</span>)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        code = self.compile(source, filename, symbol)</span><br><span class="line">    <span class="keyword">except</span> (OverflowError, SyntaxError, ValueError):</span><br><span class="line">        <span class="comment"># Case 1</span></span><br><span class="line">        self.showsyntaxerror(filename)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> code <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">        <span class="comment"># Case 2</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Case 3</span></span><br><span class="line">    self.runcode(code)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">False</span></span><br></pre></td></tr></table></figure><br>é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„ã€‚</p>
<h3 id="Exception-traceback-frameè”ç³»"><a href="#Exception-traceback-frameè”ç³»" class="headerlink" title="Exception,traceback,frameè”ç³»"></a>Exception,traceback,frameè”ç³»</h3><p>ä¸Šä¸ªä¾‹å­<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomeExcept</span><span class="params">(Exception)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, desc)</span>:</span></span><br><span class="line">        super(CustomeExcept, self).__init__()</span><br><span class="line">        self.desc = desc</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.desc</span><br><span class="line"></span><br><span class="line">    __str__ = __repr__</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">t</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">raise</span> CustomeExcept(<span class="string">'l'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">app</span><span class="params">()</span>:</span></span><br><span class="line">    a = <span class="number">1</span></span><br><span class="line">    t()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    app()</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="comment"># traceback.print_exc(file=sys.stdout)</span></span><br><span class="line">    exc_type, exc_value, exc_tb = sys.exc_info()</span><br><span class="line">    print(exc_tb.tb_frame.f_lineno)</span><br><span class="line">    print(exc_type)</span><br><span class="line">    print(exc_value <span class="keyword">is</span> e)</span><br><span class="line">    print(exc_value)</span><br><span class="line">    print([i <span class="keyword">for</span> i <span class="keyword">in</span> dir(exc_tb) <span class="keyword">if</span> <span class="keyword">not</span> i.startswith(<span class="string">'_'</span>)])</span><br><span class="line">    print(exc_tb.tb_frame, exc_tb.tb_lineno, exc_tb.tb_next.tb_lineno, exc_tb.tb_next.tb_next.tb_lineno,</span><br><span class="line">          exc_tb.tb_next.tb_next.tb_next, sys._getframe(<span class="number">0</span>), exc_tb.tb_frame.f_back)</span><br><span class="line">    print(exc_tb.tb_next.tb_frame.f_locals)</span><br><span class="line"><span class="comment"># 23</span></span><br><span class="line"><span class="comment"># &lt;class '__main__.CustomeExcept'&gt;</span></span><br><span class="line"><span class="comment"># True</span></span><br><span class="line"><span class="comment"># l</span></span><br><span class="line"><span class="comment"># ['tb_frame', 'tb_lasti', 'tb_lineno', 'tb_next']</span></span><br><span class="line"><span class="comment"># &lt;frame object at 0x7f90b5813958&gt; 19 17 13 None &lt;frame object at 0x7f90b5813958&gt; None</span></span><br><span class="line"><span class="comment"># &#123;'a': 1&#125;</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>Exceptioné…åˆraiseä½¿ç”¨,ä½¿ç”¨exceptæ•è·å¼‚å¸¸çš„æ—¶å€™è¿”å›å®ƒçš„å®ä¾‹</li>
<li>è¿”å›çš„å®ä¾‹æ˜¯å’Œå¸§æ ˆFrameæ˜¯æ²¡æœ‰å…³ç³»çš„</li>
<li>sys.exc_infoè¿”å›äº†å¼‚å¸¸ç±»ï¼Œå¼‚å¸¸å®ä¾‹,tracebackå®ä¾‹</li>
<li>tracebackå¯¹è±¡è®°å½•çš„å¸§ä¸æ˜¯å½“å‰å¸§,è€Œæ˜¯ä»å‘èµ·å¼‚å¸¸çš„é‚£ä¸ªå‡½æ•°å¼€å§‹è®°å½•å¸§æ ˆ,å› æ­¤æ¯”å½“å‰å¸§æ ˆæ›´é•¿,tracebackçš„ä¸­æ–‡æ„æ€æ˜¯å›æº¯,å®ƒçš„tb_nextå¯ä»¥æƒ³è±¡ä¸€ä¸‹,å®é™…ä¸Šæ›´å¯ä»¥è¯´æ˜¯è¯»å–ä¸Šä¸€ä¸ªå¸§(å› ä¸ºå¼•å‘å¼‚å¸¸çš„é‚£ä¸ªå¸§å®é™…ä¸Šåœ¨æœ€ä¸Šé¢)</li>
<li>tb_nextè¿”å›çš„è¿˜æ˜¯ä¸€ä¸ªtracebackå¯¹è±¡</li>
<li>tracebackæ¨¡å—æä¾›äº†ä¸€äº›æ¥å£(æ¯”å¦‚traceback.print_exc)ä»å¸§ä¸­æå–å‡ºä¿¡æ¯ç„¶åæ ¼å¼åŒ–æ‰“å°<br>å·ä¸€å¼ å›¾(å¼•ç”¨è‡ª<a href="http://busuncle.github.io/python-vm-and-bytecode.html">http://busuncle.github.io/python-vm-and-bytecode.html</a>)<br><img src="https://ficapy.b0.upaiyun.com/blogimg/pyframeobject_busuncle.github.io.jpg" alt="pyframeobject"></li>
</ul>
<h3 id="werkzeugå®ç°"><a href="#werkzeugå®ç°" class="headerlink" title="werkzeugå®ç°"></a>werkzeugå®ç°</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__debugger__:yes&#10;cmd:a = 1+1&#10;frm:0&#10;s:3WcibzVj8YXQDR0Na4bv</span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p><a href="http://busuncle.github.io/python-vm-and-bytecode.html">Pythonè™šæ‹Ÿæœºä¸å­—èŠ‚ç </a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;flaskçš„debugçœ‹èµ·æ¥è¿˜æ˜¯å¾ˆç¥å¥‡çš„ï¼Œå¯ä»¥åœ¨å¼‚å¸¸é¡µé¢æŸ¥çœ‹å½“å‰è°ƒç”¨æ ˆï¼Œä¸”èƒ½å¤Ÿåœ¨å½“å‰æ ˆå†…è¿›è¡Œäº¤äº’å¼ä¼šè¯ç”¨ä»¥è°ƒè¯•ã€‚æœ¬æ–‡å°†ä¼šä»pythonçš„REPLè¿›è¡Œè¯´æ˜å¹¶å»¶ä¼¸åˆ°flaskã€‚çœ‹çœ‹å®ƒçš„å…·ä½“å®ç°&lt;/p&gt;
    
    </summary>
    
      <category term="Flask" scheme="https://www.zoulei.net/categories/Flask/"/>
    
    
      <category term="Flask" scheme="https://www.zoulei.net/tags/Flask/"/>
    
  </entry>
  
  <entry>
    <title>redis-pyæºç åˆ†æ</title>
    <link href="https://www.zoulei.net/2016/08/06/redis_py_note/"/>
    <id>https://www.zoulei.net/2016/08/06/redis_py_note/</id>
    <published>2016-08-06T11:39:07.000Z</published>
    <updated>2016-08-06T23:04:33.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡ä¼šç®€è¿°è¯¥åº“çš„ä»£ç ç»„ç»‡æ¶æ„ï¼Œä¼šç€é‡ä»‹ç»å®ƒå®ç°çš„è¿æ¥æ± ConnectPoolä»¥åŠå¦‚ä½•å®ç°çš„çº¿ç¨‹ã€è¿›ç¨‹å®‰å…¨ã€‚</p>
<a id="more"></a>
<h3 id="æ–‡ä»¶ç»“æ„"><a href="#æ–‡ä»¶ç»“æ„" class="headerlink" title="æ–‡ä»¶ç»“æ„"></a>æ–‡ä»¶ç»“æ„</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#10;&#9500;&#9472;&#9472; __init__.py&#10;&#9500;&#9472;&#9472; _compat.py          &#20860;&#23481;&#24615;&#10;&#9500;&#9472;&#9472; client.py           &#23454;&#29616;&#23458;&#25143;&#31471;,&#35843;&#29992;connectionpool&#10;&#9500;&#9472;&#9472; connection.py       &#23454;&#29616;&#36830;&#25509;&#27744;&#65292;&#36830;&#25509;&#65292;&#35299;&#26512;&#22120;&#10;&#9500;&#9472;&#9472; exceptions.py       &#24322;&#24120;&#31867;&#10;&#9500;&#9472;&#9472; lock.py             &#23454;&#29616;&#20998;&#24067;&#24335;&#38145;&#10;&#9500;&#9472;&#9472; sentinel.py         &#37197;&#21512;redis sentinel&#26426;&#21046;&#23454;&#29616;&#39640;&#21487;&#29992;&#23458;&#25143;&#31471;&#10;&#9492;&#9472;&#9472; utils.py            &#36741;&#21161;&#31867;</span><br></pre></td></tr></table></figure>
<h3 id="å®ç°é€»è¾‘"><a href="#å®ç°é€»è¾‘" class="headerlink" title="å®ç°é€»è¾‘"></a>å®ç°é€»è¾‘</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line">r = redis.Redis()</span><br><span class="line">r.set(<span class="string">'foob'</span>, <span class="string">'bar'</span>)</span><br></pre></td></tr></table></figure>
<p>çœ‹æ¶æ„å›¾<br><img src="https://ficapy.b0.upaiyun.com/blogimg/redis_py_arch.png" alt="redis_client_arch"><br>çœ‹è°ƒç”¨å›¾(ä»¥ä¸‹ä¸º5å¹´å‰çš„<a href="https://github.com/andymccurdy/redis-py/tree/2.4">2.4ç‰ˆæœ¬</a>)<br><img src="https://ficapy.b0.upaiyun.com/blogimg/redis_old_version.png" alt="redis_old_version"><br>ç¬¬ä¸€æ­¥æ‰§è¡Œ<code>r=redis.Redis()</code>æ²¡è¿›è¡Œä»€ä¹ˆæ“ä½œï¼ŒåŒæ—¶éšå¼çš„åˆå§‹åŒ–äº†ConnectionPoolã€‚<br>ç­‰åˆ°æ‰§è¡Œsetæ“ä½œçš„æ—¶å€™ã€‚å°±æ˜¯æ‰§è¡Œäº†execute_commandï¼Œæ­¤æ—¶åˆ†ä¸ºäº†å‡ ä¸ªæ­¥éª¤ã€‚çœ‹ç¬¬5ä¸ªå‡½æ•°è°ƒç”¨ï¼Œä»è¿æ¥æ± é‡Œé¢get_connectionã€‚å¦‚æœæ²¡æœ‰å¯ç”¨çš„ï¼Œé‚£ä¹ˆåˆ™æ–°å»º(redis.connection.Connection.<strong>init</strong>),æ­¤æ—¶å¹¶æ²¡æœ‰åˆ›å»ºsocketè¿æ¥ã€‚ç¬¬8ä¸ªå‡½æ•°è°ƒç”¨send_command,å‘½ä»¤æ‰“åŒ…ç„¶ååˆ›å»ºè¿æ¥å‘é€ã€‚è¯¥ç‰ˆæœ¬ä½¿ç”¨connection._sock.makefile(â€˜râ€™)ä¾¿äºè¯»å–ã€‚<br>å†åˆ°äº†ç¬¬21ä¸ªå‡½æ•°è°ƒç”¨Connection.read_response.ä½¿ç”¨è§£æå™¨ä»socketè¯»å–æ•°æ®å¹¶è½¬æ¢æˆä¾¿äºpythonä½¿ç”¨çš„æ•°æ®ç»“æ„<br>æœ€åfinallyå°†è¯¥è¿æ¥é‡Šæ”¾åˆ°çº¿ç¨‹æ± </p>
<p>ç°åœ¨å¯ä»¥çœ‹åˆ°æœ‰è¿™æ ·ä¸€æ¡å…³ç³»ï¼Œæ¯ä¸€ä¸ªredis.Redis()å®ä¾‹éƒ½æœ‰ä¸€ä¸ªConnectionPoolå¯¹è±¡,ä¸€ä¸ªè¿æ¥æ± è‡³å°‘å«æœ‰ä¸€æ¡è¿æ¥ã€‚æ‰€ä»¥ç»å¤§å¤šæ•°æƒ…å†µæ²¡æœ‰å¿…è¦å†™å‡ºè¿æ¥æ± <br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pool = redis.ConnectionPool()&#10;r = redis.Redis(connection_pool=pool)&#10;&#31561;&#20215;&#20110;&#10;r = redis.Redis()</span><br></pre></td></tr></table></figure></p>
<h3 id="å¤šçº¿ç¨‹"><a href="#å¤šçº¿ç¨‹" class="headerlink" title="å¤šçº¿ç¨‹"></a>å¤šçº¿ç¨‹</h3><p>å¦‚æœä½ çš„ç¨‹åºæ˜¯å•çº¿ç¨‹çš„ã€‚é‚£ä¹ˆæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œä¸€ä¸ªRediså®ä¾‹ï¼Œä¸€ä¸ªè¿æ¥æ± ï¼Œä¸€ä¸ªsocketè¿æ¥ã€‚<br>å¤šçº¿ç¨‹é‚£æˆ‘ä»¬ä¸»è¦è€ƒè™‘çš„æ˜¯çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚å¯¹äºrediså®¢æˆ·ç«¯å°±æ˜¯socketè¿æ¥ç»å¯¹è¦çº¿ç¨‹é—´éš”ç¦»ï¼Œå¦åˆ™ä¸€ä¸ªçº¿ç¨‹è§£æäº†å¦å¤–ä¸€ä¸ªsocketçš„è¿”å›å†…å®¹ï¼Œé‚£ä¹ˆå¤šçº¿ç¨‹ä¹Ÿå°±æ²¡æ„ä¹‰äº†ã€‚æµ‹è¯•ä¸€ä¸‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line">r = redis.Redis()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    r.setex(threading.get_ident(), threading.get_ident(), <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        <span class="keyword">assert</span> r.get(threading.get_ident()) <span class="keyword">in</span> [str(threading.get_ident()).encode(), <span class="keyword">None</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">50</span>):</span><br><span class="line">    threading.Thread(target=main).start()</span><br><span class="line"><span class="comment"># watch -n 1 "redis-cli INFO clients"    </span></span><br><span class="line"><span class="comment"># Every 1.0s: redis-cli INFO clients                                           Sat Aug  6 21:34:31 2016</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># #Clients</span></span><br><span class="line"><span class="comment"># connected_clients:26</span></span><br><span class="line"><span class="comment"># client_longest_output_list:0</span></span><br><span class="line"><span class="comment"># client_biggest_input_buf:0</span></span><br><span class="line"><span class="comment"># blocked_clients:0</span></span><br></pre></td></tr></table></figure><br>å¯ä»¥çœ‹åˆ°ç»“æœå¹¶æ²¡æœ‰é”™è¯¯ï¼Œè€Œä¸”åˆ›å»ºçš„è¿æ¥æ•°å’Œåˆ›å»ºçš„çº¿ç¨‹æ•°å¹¶ä¸æ˜¯ä¸€è‡´çš„</p>
<p>è¯•æƒ³ä¸€ä¸‹ï¼Œæ¯æ¬¡æ‰§è¡Œä¸€æ¬¡ç±»ä¼¼setçš„æŒ‡ä»¤ã€‚éƒ½ä¼šä»è¿æ¥æ± (Listç»“æ„)å–å‡º(pop)ä¸€ä¸ªè¿æ¥ã€‚è€Œlist.popæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚æ‰§è¡Œå®Œæ¯•å‘½ä»¤ååˆä¼šä½¿ç”¨appendåŠ å…¥åˆ°è¿æ¥æ± ï¼Œlist.appendä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚æ‰€ä»¥é’ˆå¯¹socketçš„æ“ä½œæ˜¯çº¿ç¨‹éš”ç¦»çš„ã€‚è¿™ä¸€åˆ‡å¥½åƒå’Œ_in_use_connectionså¹¶æ²¡æœ‰ä»€ä¹ˆå…³ç³»ã€‚å¯¹äºä¸€ä¸ªç®€å•çš„è¿æ¥æ± ã€‚ä»è¿æ¥æ± å–å‡ºï¼Œç”¨å®ŒåŠ å…¥åˆ°è¿æ¥æ± ã€‚è€Œ_in_use_connectionsè®°å½•çš„æ˜¯ä½¿ç”¨ä¸­çš„çº¿ç¨‹ã€‚å•¥å­ç”¨å‘¢ã€‚å®ƒç”¨äºä¸€ä¸ªæ¥å£(å…³é—­è¿æ¥æ± ä¸­çš„æ‰€æœ‰è¿æ¥)ã€‚æ³¨æ„å…³é—­è¿æ¥å¹¶ä¸ä¼šå°†_available_connectionså’Œ_in_use_connectionsæ¸…ç©ºã€‚å®ƒåªä¼šå°†connectionå¯¹è±¡ä¸­çš„_sockè®¾ç½®ä¸ºNoneï¼Œè€Œæ¯æ¬¡æ‰§è¡Œå‘½ä»¤çš„æ—¶å€™connectionéƒ½æ˜¯ä¼šæ£€æŸ¥_sockæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™ä¼šé‡æ–°å»ºç«‹è¿æ¥,å¦‚ä¸‹ç¤ºä¾‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line">r = redis.Redis()</span><br><span class="line">r.setex(<span class="string">'key'</span>, <span class="string">'value'</span>, <span class="number">20</span>)</span><br><span class="line">print(r.connection_pool._available_connections[<span class="number">0</span>]._sock)</span><br><span class="line">r.connection_pool.disconnect()</span><br><span class="line">print(r.connection_pool._available_connections[<span class="number">0</span>]._sock)</span><br><span class="line">r.setex(<span class="string">'key'</span>,<span class="string">'value'</span>,<span class="number">20</span>)</span><br><span class="line">print(r.connection_pool._available_connections[<span class="number">0</span>]._sock)</span><br><span class="line"><span class="comment"># &lt;socket.socket fd=5, family=AddressFamily.AF_INET6, type=SocketKind.SOCK_STREAM, proto=6, laddr=('::1', 62900, 0, 0), raddr=('::1', 6379, 0, 0)&gt;</span></span><br><span class="line"><span class="comment"># None</span></span><br><span class="line"><span class="comment"># &lt;socket.socket fd=5, family=AddressFamily.AF_INET6, type=SocketKind.SOCK_STREAM, proto=6, laddr=('::1', 62901, 0, 0), raddr=('::1', 6379, 0, 0)&gt;</span></span><br></pre></td></tr></table></figure><br>å› ä¸ºå®ƒå…³é—­è¿æ¥çš„æ—¶å€™å¹¶æ²¡æœ‰å°†å¯¹åº”çš„connectionå¯¹è±¡ä»è¿æ¥æ± ä¸­åˆ é™¤ã€‚é‚£ä¹ˆä¼šé€ æˆä¸€ä¸ªé—®é¢˜ã€‚å¦‚æœä½ åˆ›å»ºè¿‡100ä¸ªè¿æ¥ï¼Œé‚£ä¹ˆè¿æ¥æ± å°†ä¼šä¸€ç›´å¤ç”¨è¿™äº›å¯¹è±¡ã€‚å¦‚æœä½ é«˜å³°æœŸåˆ›å»ºè¿‡å¤šçš„è¿æ¥ï¼Œè€Œååˆåªéœ€è¦å‡ ä¸ªè¿æ¥å°±å¤Ÿäº†(è™½ç„¶è¿™æ ·çš„é—®é¢˜ä¼°è®¡æå°‘ä¼šé‡åˆ°)ã€‚ä½ å¯ä»¥æ˜¾å¼çš„popå‡º_available_connectionså¹¶å…³é—­ã€‚<br>å…¶å®æœ‰ä¸€ä¸ªåœ°æ–¹æ˜¯éçº¿ç¨‹å®‰å…¨çš„ã€‚åœ¨åˆ›å»ºè¿æ¥çš„æ—¶å€™æœ‰self._created_connections += 1,å¦‚æœä½ è®¿é—®è¿™ä¸ªå€¼å¾—åˆ°åˆ›å»ºçš„è¿æ¥æ•°æ˜¯ä¸å¯é çš„ã€‚ä¸è¿‡è¿™éƒ½æ— å…³ç´§è¦ï¼Œå› ä¸ºä½ ä¸å¯èƒ½åœ¨æçŸ­çš„æ—¶é—´å†…åˆ›å»ºè®¸å¤šè¿æ¥ã€‚å³ä½¿è¿™é‡Œä¸å‡†ã€‚ç»Ÿè®¡è¯¯å·®ä¹Ÿä¸ä¼šæœ‰2ä¸ªã€‚</p>
<p>ä¸ºäº†é¿å…æ— ç«¯åˆ›å»ºå‡ºNå¤šè¿æ¥ã€‚è¯¥å®¢æˆ·ç«¯åæœŸåŠ å…¥äº†BlockingConnectionPoolç±»ã€‚ä½¿ç”¨LifoQueueåˆ›å»ºå‡ºè¿æ¥é˜Ÿåˆ—ï¼Œå¦‚æœè¯¥é˜Ÿåˆ—è¢«ä½¿ç”¨å®Œï¼Œé‚£ä¹ˆåç»­è¯·æ±‚å°†ä¼šé˜»å¡ä¸€æ®µæ—¶é—´ï¼Œè¿‡é•¿åˆ™å¼•å‘å¼‚å¸¸ã€‚</p>
<h3 id="å¤šè¿›ç¨‹å®‰å…¨"><a href="#å¤šè¿›ç¨‹å®‰å…¨" class="headerlink" title="å¤šè¿›ç¨‹å®‰å…¨"></a>å¤šè¿›ç¨‹å®‰å…¨</h3><p>redis-pyåœ¨2.4.12åŠ å…¥äº†å¤šçº¿ç¨‹å®‰å…¨<a href="https://github.com/andymccurdy/redis-py/issues/234">è§issues</a>ã€‚<br>å¯ä»¥çœ‹åˆ°å®ç°åŸç†ä¹Ÿæ˜¯å¾ˆç®€å•çš„ã€‚forkè¿›ç¨‹çš„æ—¶å€™socketä¸€æ ·ä½¿ç”¨çš„ã€‚ä¸ºäº†åˆ†å¼€ï¼Œä½¿ç”¨äº†os.getpid()åŒºåˆ†ã€‚å¦‚æœè¿›ç¨‹å·å˜äº†ï¼Œåˆ™å…³é—­æ‰€æœ‰çš„è¿æ¥ï¼Œé‡æ–°è¿æ¥åè‡ªç„¶å°±åˆ†å¼€äº†ã€‚åŒæ—¶ä¸ºäº†é˜²æ­¢ä¸€ä¸ªè¿›ç¨‹æœ‰å¤šä¸ªçº¿ç¨‹è¿™ç§æƒ…å†µã€‚ä¸€ä¸ªçº¿ç¨‹å…³é—­åï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¹Ÿå¯èƒ½æ‰§è¡Œå…³é—­æ“ä½œã€‚æ‰€ä»¥æ­¤å¤„ä½¿ç”¨äº†é”<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_checkpid</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> self.pid != os.getpid():</span><br><span class="line">        <span class="keyword">with</span> self._check_lock:</span><br><span class="line">            <span class="keyword">if</span> self.pid == os.getpid():</span><br><span class="line">                <span class="comment"># another thread already did the work while we waited</span></span><br><span class="line">                <span class="comment"># on the lock.</span></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            self.disconnect()</span><br><span class="line">            self.reset()</span><br></pre></td></tr></table></figure></p>
<p>æ’æ’­ä¸€ä¸‹å½“å‰2.10.5ç‰ˆæœ¬çš„è°ƒç”¨å›¾<br><img src="http://ficapy.b0.upaiyun.com/blogimg/redis_pool.png" alt="new_redis_pool"><br>å¯ä»¥çœ‹åˆ°å’Œæœ€ä¸Šé¢çš„è°ƒç”¨å›¾å‡ºå…¥å¾ˆå°ï¼Œä»…ä»…åŠ å…¥äº†è¿›ç¨‹å®‰å…¨,å°†socket.makefileå˜æˆäº†SocketBuffer.</p>
<h3 id="åˆ†å¸ƒå¼é”"><a href="#åˆ†å¸ƒå¼é”" class="headerlink" title="åˆ†å¸ƒå¼é”"></a>åˆ†å¸ƒå¼é”</h3><p>çº¿ç¨‹é”å°±æ˜¯å¤šçº¿ç¨‹é—´æœ‰çº¿ç¨‹é—´å…±äº«å˜é‡ã€‚è¿›ç¨‹é”å°±æ˜¯å¤šè¿›ç¨‹é—´æœ‰è¿›ç¨‹é—´å…±äº«å˜é‡ã€‚æ­¤å¤„çš„å…±äº«å˜é‡å°±æ˜¯å°†å˜é‡å­˜å‚¨åˆ°redisæ•°æ®åº“ã€‚å®ç°ä¹Ÿæ¯”è¾ƒç®€å•ã€‚æˆªå–ä¸€æ®µacquireçœ‹çœ‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_acquire</span><span class="params">(self, token)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> self.redis.setnx(self.name, token):</span><br><span class="line">        <span class="keyword">if</span> self.timeout:</span><br><span class="line">            <span class="comment"># convert to milliseconds</span></span><br><span class="line">            timeout = int(self.timeout * <span class="number">1000</span>)</span><br><span class="line">            self.redis.pexpire(self.name, timeout)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">False</span></span><br></pre></td></tr></table></figure><br>å¦å¤–å®ƒå®ç°çš„åªæ˜¯æœ€ç®€å•çš„é”ã€‚æ¯”å¦‚å¯é‡å…¥é”å•¥çš„éƒ½æ˜¯æ²¡æœ‰å®ç°çš„ã€‚å¦‚æœä½ æƒ³é…åˆsentinelè¿›è¡Œé«˜å¯ç”¨ã€‚å¾€ä¸‹çœ‹â€¦..</p>
<h3 id="Sentinel"><a href="#Sentinel" class="headerlink" title="Sentinel"></a>Sentinel</h3><p><img src="https://ficapy.b0.upaiyun.com/blogimg/redis_sentinel.png" alt="redis_sentinel"><br>å¾—ç›Šäºredis-pyçš„æ¾è€¦åˆï¼Œè¿æ¥æ± ã€è¿æ¥ã€è§£æå™¨åŸºæœ¬éƒ½å¾ˆç‹¬ç«‹ã€‚<br>å®¢æˆ·ç«¯å’Œç›‘è§†å™¨ç»„åˆ›å»ºä¸€ä¸ªä¸Šé¢è¯´çš„Redisæ­£å¸¸è¿æ¥ã€‚å®ƒä¸»è¦æä¾›æ¥å£è¿”å›masterçš„åœ°å€å’Œè¿”å›salveçš„åœ°å€ã€‚<br>ç„¶åæˆ‘ä»¬ä½¿ç”¨master_forè¿”å›çš„ä¹Ÿæ˜¯ä¸€ä¸ªRedisè¿æ¥<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return redis_class(connection_pool=connection_pool_class(&#10;            service_name, self, **connection_kwargs))</span><br></pre></td></tr></table></figure></p>
<p>ä¸è¿‡å®ƒè¿›è¡Œå¯¹è¿æ¥æ± å’Œè¿æ¥å¯¹è±¡éƒ½è¿›è¡Œäº†ä¸€äº›ä¿®æ”¹ã€‚å¯ä»¥çœ‹åˆ°å®ƒå°†selfä¼ é€’ç»™äº†åº•å±‚è¿æ¥æ± ã€‚è€Œè¿æ¥æ± ä¹Ÿä½¿ç”¨<code>self.connection_kwargs[&#39;connection_pool&#39;] = weakref.proxy(self)</code>å°†è‡ªå·±ä¼ é€’ç»™äº†åº•å±‚Connectionï¼Œå°±è¿™æ ·å®ƒå®ç°äº†é«˜å¯ç”¨å®¢æˆ·ç«¯ï¼Œåœ¨åº•å±‚è¿æ¥çš„æ—¶å€™ä½¿ç”¨é«˜å±‚æä¾›çš„å‡½æ•°æä¾›æ­£ç¡®çš„åœ°å€~~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ¬æ–‡ä¼šç®€è¿°è¯¥åº“çš„ä»£ç ç»„ç»‡æ¶æ„ï¼Œä¼šç€é‡ä»‹ç»å®ƒå®ç°çš„è¿æ¥æ± ConnectPoolä»¥åŠå¦‚ä½•å®ç°çš„çº¿ç¨‹ã€è¿›ç¨‹å®‰å…¨ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æºç è§£æ" scheme="https://www.zoulei.net/categories/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
    
      <category term="python" scheme="https://www.zoulei.net/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>werkzeugæºç åˆ†æ(local.py)</title>
    <link href="https://www.zoulei.net/2016/08/03/werkzeug_local_note/"/>
    <id>https://www.zoulei.net/2016/08/03/werkzeug_local_note/</id>
    <published>2016-08-03T00:58:00.000Z</published>
    <updated>2016-09-04T08:14:45.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ‰äººè¯´flaskçš„ä¸Šä¸‹æ–‡æœºåˆ¶æ˜¯æ•´ä¸ªæ¡†æ¶çš„ç²¾åéƒ¨åˆ†ï¼Œæœ‰äººè¯´å®ƒç¥å¥‡çš„gè®©äººè´¹è§£ã€‚werkzeugçš„local.pyå°±æ˜¯å®ƒçš„å…·ä½“å®ç°ã€‚è¿™ä¸ªçœ‹ä¼¼ç¥å¥‡çš„æœºåˆ¶èƒŒååŠ ä¸Šåº”ç”¨ä»£ç ä¹Ÿä¸è¿‡ä¸¤ä¸‰ç™¾è¡Œã€‚ä¸è¿‡å¥½åƒå‘è¿˜æ˜¯<code>æ¯”è¾ƒæ·±</code>çš„ã€‚å¦å¤–flaskçš„0.1ç‰ˆæœ¬æ‰200å¤šè¡Œä»£ç ã€‚å€¼å¾—ç…ä¸€ä¸‹</p>
<a id="more"></a>
<h3 id="ç›´è§‚æ„Ÿå—ä¸Šä¸‹æ–‡"><a href="#ç›´è§‚æ„Ÿå—ä¸Šä¸‹æ–‡" class="headerlink" title="ç›´è§‚æ„Ÿå—ä¸Šä¸‹æ–‡"></a>ç›´è§‚æ„Ÿå—ä¸Šä¸‹æ–‡</h3><p>ä½¿ç”¨wrkè¿›è¡Œå‹æµ‹<code>wrk -t300 -c300 -d10s http://127.0.0.1:5000</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> pprint <span class="keyword">import</span> pprint</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask.globals <span class="keyword">import</span> _request_ctx_stack,_app_ctx_stack</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="decorator">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    time.sleep(random.random())</span><br><span class="line">    pprint(_request_ctx_stack._local.__storage__)</span><br><span class="line">    pprint(_app_ctx_stack._local.__storage__)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line"></span><br><span class="line">app.run(threaded=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸä¸€æ—¶åˆ»çŠ¶æ€</span></span><br><span class="line"><span class="comment"># &#123;123145360109568: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></span><br><span class="line"><span class="comment">#  123145391640576: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></span><br><span class="line"><span class="comment">#  123145407406080: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></span><br><span class="line"><span class="comment">#  123145417916416: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></span><br><span class="line"><span class="comment">#  123145428426752: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></span><br><span class="line"><span class="comment">#  123145459957760: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></span><br><span class="line"><span class="comment">#  123145480978432: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></span><br><span class="line"><span class="comment">#  123145496743936: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></span><br><span class="line"><span class="comment">#  123145512509440: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></span><br><span class="line"><span class="comment">#  123145538785280: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></span><br><span class="line"><span class="comment">#  123145549295616: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></span><br><span class="line"><span class="comment">#  123145601847296: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></span><br><span class="line"><span class="comment">#  123145638633472: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></span><br><span class="line"><span class="comment">#  123145680674816: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></span><br><span class="line"><span class="comment">#  123145743736832: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></span><br><span class="line"><span class="comment">#  123145764757504: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;&#125;</span></span><br><span class="line"><span class="comment"># &#123;123145360109568: &#123;'stack': [&lt;flask.ctx.AppContext object at 0x103f90f60&gt;]&#125;,</span></span><br><span class="line"><span class="comment">#  123145391640576: &#123;'stack': [&lt;flask.ctx.AppContext object at 0x103fcdc50&gt;]&#125;,</span></span><br><span class="line"><span class="comment">#  123145407406080: &#123;'stack': [&lt;flask.ctx.AppContext object at 0x10402c080&gt;]&#125;,</span></span><br><span class="line"><span class="comment">#  123145417916416: &#123;'stack': [&lt;flask.ctx.AppContext object at 0x103fa0668&gt;]&#125;,</span></span><br><span class="line"><span class="comment">#  123145428426752: &#123;'stack': [&lt;flask.ctx.AppContext object at 0x104058828&gt;]&#125;,</span></span><br><span class="line"><span class="comment">#  123145459957760: &#123;'stack': [&lt;flask.ctx.AppContext object at 0x103fd8470&gt;]&#125;,</span></span><br><span class="line"><span class="comment">#  123145480978432: &#123;'stack': [&lt;flask.ctx.AppContext object at 0x1040859e8&gt;]&#125;,</span></span><br><span class="line"><span class="comment">#  123145496743936: &#123;'stack': [&lt;flask.ctx.AppContext object at 0x104078cf8&gt;]&#125;,</span></span><br><span class="line"><span class="comment">#  123145512509440: &#123;'stack': [&lt;flask.ctx.AppContext object at 0x104036c88&gt;]&#125;,</span></span><br></pre></td></tr></table></figure></p>
<h3 id="ä¸ºä»€ä¹ˆä¼šæœ‰Local"><a href="#ä¸ºä»€ä¹ˆä¼šæœ‰Local" class="headerlink" title="ä¸ºä»€ä¹ˆä¼šæœ‰Local"></a>ä¸ºä»€ä¹ˆä¼šæœ‰Local</h3><p>æ¯”è¾ƒæŠ½è±¡çš„è§£é‡Šå«å®ƒ<code>çº¿ç¨‹å†…å…±äº«å˜é‡</code>ï¼Œä¸‹é¢æ¥ä¸ªä¾‹å­<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">l = threading.local()</span><br><span class="line">l.a = <span class="number">1</span></span><br><span class="line">threading.Thread(target=<span class="keyword">lambda</span>: setattr(l, <span class="string">'a'</span>, <span class="number">2</span>) <span class="keyword">or</span> print(l.a, threading.current_thread())).start()</span><br><span class="line">print(l.a)</span><br><span class="line"><span class="comment"># 2 &lt;Thread(Thread-1, started 123145307557888)&gt;</span></span><br><span class="line"><span class="comment"># 1</span></span><br></pre></td></tr></table></figure><br>å¯ä»¥çœ‹å‡ºå°±æ˜¯ä¸€å…¨å±€å¯¹è±¡å¯¹å®ƒè®¾ç½®çš„å±æ€§åœ¨çº¿ç¨‹é—´æ˜¯éš”ç¦»çš„ã€‚å¯æ˜¯è¿™åˆæœ‰ä»€ä¹ˆç”¨ã€‚æˆ‘ä»¬ä½œä¸ºæ¡†æ¶ä½¿ç”¨è€…é€»è¾‘ä¸€èˆ¬éƒ½æ˜¯å†™åœ¨ä¸€èµ·çš„ï¼Œæ²¡æœ‰äººä¼šæ•…æ„å»åƒè¿™æ ·å†™<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">l = threading.local()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    l.a = <span class="number">1</span></span><br><span class="line">    l.a  <span class="comment">##è¿›è¡Œå¼•ç”¨</span></span><br></pre></td></tr></table></figure><br>å¯æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯æ¡†æ¶ï¼çº¿ç¨‹çš„è°ƒèµ·ä¸æ˜¯æˆ‘ä»¬ä¸»åŠ¨å»æ“ä½œçš„ã€‚æ¡†æ¶ä¼šæœ‰ä¸€äº›ç¬¬ä¸‰æ–¹æ‰©å±•ã€‚å®ƒä»¬ä¾é æ­¤æœºåˆ¶ç»™æˆ‘ä»¬æä¾›æ¥å£ï¼Œæ¯”å¦‚æ¥ä¸ª<a href="http://flask.pocoo.org/docs/0.11/appcontext/#context-usage">å®˜æ–¹ç¤ºä¾‹</a><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> g</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_db</span><span class="params">()</span>:</span></span><br><span class="line">    db = getattr(g, <span class="string">'_database'</span>, <span class="keyword">None</span>)</span><br><span class="line">    <span class="keyword">if</span> db <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">        db = g._database = connect_to_database()</span><br><span class="line">    <span class="keyword">return</span> db</span><br><span class="line"><span class="comment">#=========================</span></span><br><span class="line"><span class="keyword">from</span> werkzeug.local <span class="keyword">import</span> LocalProxy</span><br><span class="line">db = LocalProxy(get_db)</span><br></pre></td></tr></table></figure></p>
<p>Localçš„å®ç°åŸç†å¾ˆç®€å•ï¼Œè¿™é‡Œä¸è¯¦è¿°äº†ã€‚å°±æ˜¯å‰ä¸€ç¯‡åšæ–‡è¯´çš„å­—å…¸çš„<code>dict[key] = value</code>æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å…¶å®threading.localä¹Ÿæ˜¯ä¸€æ ·çš„ä½œç”¨ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¸ç”¨å®ƒã€‚</p>
<ul>
<li>æ”¯æŒäº†greenlet(æœ¬åšæ–‡åªä¼šæ¶‰åŠåˆ°å¤šçº¿ç¨‹æƒ…å†µ)</li>
<li>è‡ªå¸¦çš„å†™æ³•å¤ªç‰¹ä¹ˆæ¶å¿ƒäº†ï¼Œé‚£ä¸ªæºç æˆ‘éƒ½å¿«çœ‹åäº†ï¼Œä¸å¦‚è‡ªå·±å†™ä¸€ä¸ª(æˆ‘éƒ½æ²¡çœ‹é€è‡ªå¸¦çš„ä¸ºä»€ä¹ˆè¦é‚£ä¹ˆå†™,å¦‚æœä½ èƒ½è½»æ¾çœ‹æ˜ç™½ï¼Œé‚£ä¹ˆä½ è‚¯å®šæ˜¯çœ‹é­”æœ¯æ–¹æ³•çš„å¤§ç¥)<br>ç®€è¿°ä¸‹è‡ªå¸¦çš„é€»è¾‘ï¼Œä¸»è¦æ˜¯è¿™å‡ å¥<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># python2.7.11&#20195;&#30721;&#10;dict = object.__getattribute__(self, &#39;__dict__&#39;)&#10;current_thread().__dict__[key] = dict&#10;&#10;key = object.__getattribute__(self, &#39;_local__key&#39;)&#10;d = current_thread().__dict__.get(key)&#10;# import threading&#10;# l = threading.current_thread()&#10;# print(l is threading.current_thread())&#10;# threading.Thread(target=lambda :print(threading.current_thread() is l)).start()&#10;# True&#10;# False</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>åœ¨åŒä¸€çº¿ç¨‹å†…threading.current_thread()æ˜¯åŒä¸€å¯¹è±¡ï¼Œæœ‰ä¸€ä¸ª_patchå‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨localå±æ€§è¢«è°ƒç”¨å‰æå‰è°ƒç”¨ï¼Œå°†current_thread().__dict__ç›¸å…³çš„å†…å®¹ç»‘å®šåœ¨local.__dict__ä¸Šã€‚</p>
<h3 id="ä¸ºä»€ä¹ˆä¼šæœ‰LocalStack"><a href="#ä¸ºä»€ä¹ˆä¼šæœ‰LocalStack" class="headerlink" title="ä¸ºä»€ä¹ˆä¼šæœ‰LocalStack"></a>ä¸ºä»€ä¹ˆä¼šæœ‰LocalStack</h3><p>å®ƒä¸»è¦å°†ä¸Šé¢çš„Localç”±<code>l.key = value</code>å˜æˆäº†<code>l.push(value)</code>ã€‚å˜æˆäº†æ ˆç»“æ„ã€‚å¯æ˜¯ä»ä¸Šé¢çš„ç›´è§‚æ„Ÿå—ä¸Šä¸‹æ–‡éƒ¨åˆ†å¯ä»¥çœ‹åˆ°åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä»»ä¸€æ—¶åˆ»æ ˆé‡Œé¢éƒ½ä»…æœ‰ä¸€ä¸ªå†…å®¹ã€‚é‚£ä¹ˆè¿˜ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æ ˆå‘¢ï¼Œå¾€ä¸‹çœ‹ã€‚</p>
<h3 id="ä¸ºä»€ä¹ˆä¼šæœ‰LocalProxy"><a href="#ä¸ºä»€ä¹ˆä¼šæœ‰LocalProxy" class="headerlink" title="ä¸ºä»€ä¹ˆä¼šæœ‰LocalProxy"></a>ä¸ºä»€ä¹ˆä¼šæœ‰LocalProxy</h3><p>ä»åå­—å°±å¯ä»¥çœ‹å‡ºæ¥æ˜¯ä»£ç†æ¨¡å¼ã€‚å¯ä»¥çœ‹çœ‹githubä¸Šçš„<a href="https://github.com/faif/python-patterns/blob/master/proxy.py">è®¾è®¡æ¨¡å¼</a>ï¼ŒåŒæ ·æ˜¯è®²çš„ä»£ç†æ¨¡å¼ï¼Œflaskçš„å®é™…åº”ç”¨å°±æ¯”è¿™ä¸ªä¾‹å­è¦é«˜æ˜çš„å¤š</p>
<p>æˆ‘ä»¬ä½¿ç”¨ä»£ç†æ˜¯ä¸ºäº†ç»•è¿‡é˜²ç«å¢™è®¿é—®å¤–é¢çš„ä¸–ç•Œï¼Œé‚£ä¹ˆLocalProxyè¿™ä¸ªä»£ç†æ˜¯å¹²å•¥å­çš„å‘¢ã€‚è®¾æƒ³ä¸€ä¸‹ã€‚æˆ‘ä»¬ä½¿ç”¨äº†l = Local()å¹¶ä¸”åœ¨ä¸Šé¢ç»™ä¸€ä¸ªå±æ€§èµ‹å€¼äº†l.key = valueã€‚é‚£ä¹ˆå½“ä½ è¦è°ƒç”¨çš„æ—¶å€™å°±ä½¿ç”¨l.keyå°±å¥½å•¦ã€‚ç°åœ¨æˆ‘ä»¬æ²¡æœ‰ç›´æ¥ç”¨Localç”¨çš„æ˜¯l = LocalStack(),l.push(RequestContext()),requestè¿™ä¸ªå±æ€§åˆåœ¨<br>RequestContext()è¿™ä¸ªå¯¹è±¡ä¸Šã€‚é‚£ä¹ˆæˆ‘ä»¬è¦è®¿é—®requestæ€ä¹ˆåŠï¼æ­¤æ—¶ä½ å°±è¦æ‰§è¡Œl.top.requestè¿›è¡Œè®¿é—®ã€‚å¯æ˜¯ä¼˜é›…å‘¢ï¼ä¼˜é›…å‘¢ï¼ä¼˜é›…å‘¢ï¼ä¼˜é›…å“ªé‡Œå»äº†ã€‚æˆ‘ä»¬å¾ˆæ‡’ï¼Œæˆ‘ä»¬æƒ³æ‰§è¡Œä¸€ä¸ªrequestå°±èƒ½ä»£æ›¿l.top.request(æœ‰äººä¼šé—®ä¸ºä»€ä¹ˆä¸ç›´æ¥å†™æ­»reques = l.top.requestï¼Œé‚£æ˜¯å› ä¸ºå®ƒæ˜¯æ­»ï¼ï¼ï¼çš„,è€Œl.top.requestæ˜¯éšç€çº¿ç¨‹è¿›å…¥é€€å‡ºä¸€ç›´å‡ºå…¥æ ˆåŠ¨æ€å˜åŒ–çš„ï¼Œæˆ‘ä»¬åªèƒ½åœ¨æ¯æ¬¡ä½¿ç”¨çš„æ—¶å€™æ‰§è¡Œl.top.requestå¾—åˆ°æ­£ç¡®çš„ç»“æœ)ã€‚â†’_â†’è¿™å°±æ˜¯è¿™ä¸ªä»£ç†èƒ½ä¸ºæˆ‘ä»¬åšçš„<br>æ‰§è¡Œrepr(current_app)çš„è°ƒç”¨å›¾ï¼Œè¯·æ— è§†pycallé‚£ä¸€å—<br><img src="http://ficapy.b0.upaiyun.com/blogimg/werkzeug_localproxy.png" alt="werkzeug_localproxy"><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_find_app</span><span class="params">()</span>:</span></span><br><span class="line">    top = _app_ctx_stack.top</span><br><span class="line">    <span class="keyword">if</span> top <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(_app_ctx_err_msg)</span><br><span class="line">    <span class="keyword">return</span> top.app</span><br><span class="line"></span><br><span class="line">_app_ctx_stack = LocalStack()</span><br><span class="line">current_app = LocalProxy(_find_app)</span><br></pre></td></tr></table></figure><br>åœ¨LocalProxyé‡Œé¢æˆ‘ä»¬å†™äº†ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“å¯¹LocalProxyå±æ€§è¿›è¡Œè®¿é—®çš„æ—¶å€™ï¼Œå®ƒæ°¸è¿œéƒ½æ˜¯å…ˆæ‰§è¡Œ_get_current_object,è¯¥å‡½æ•°å°±æ˜¯æ‰§è¡Œæˆ‘ä»¬å†™å…¥çš„å›è°ƒå‡½æ•°å¾—åˆ°è®¿é—®å¯¹è±¡,æ¯”å¦‚current_appå°±æ˜¯å¾—åˆ°_app_ctx_stack.top.appå¯¹è±¡ã€‚æœ€åå†å¯¹å¾—åˆ°çš„å¯¹è±¡è¿›è¡Œå±æ€§è®¿é—®</p>
<p>å¯¹LocalProxyè®²3ä¸ªå°ç»†èŠ‚</p>
<ol>
<li><p>__init__ä¸­æœ‰<code>object.__setattr__(self, &#39;_LocalProxy__local&#39;, local)</code>ã€‚å¦‚æœä½ è¦ç¡®ä¿å¯¹ä¸€ä¸ªå¯¹è±¡çš„<code>__dict__</code>ä¸­åŠ å…¥å†…å®¹ï¼Œéœ€è¦ä½¿ç”¨object.__setattr__ï¼Œä½¿ç”¨self.xã€setattr(self,â€™xâ€™)ã€self.__dict__[x]éƒ½æ˜¯ä¸ç¡®å®šçš„ï¼Œå› ä¸ºå®ƒselfè¿™ä¸ªå¯¹è±¡å¯èƒ½ä¼šé‡å†™è‡ªèº«çš„__setattr__,å…¶æ¬¡å¯¹äºç§æœ‰å˜é‡ã€‚æ‰§è¡Œ__setattr__çš„æ—¶å€™éœ€è¦å˜æ¢</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class Foo():&#10;    def __init__(self):&#10;        self.__a = 1&#10;print(Foo().__dict__)&#10;# &#123;&#39;_Foo__a&#39;: 1&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æœ€ä¸‹é¢åŒæ—¶ä¹Ÿå¯¹æ‰€æœ‰å¯åˆ—ä¸¾çš„é­”æœ¯æ–¹æ³•è¿›è¡Œäº†ä»£ç†<code>__str__ = lambda x:    str(x._get_current_object())</code></p>
</li>
<li>ç”±äºä»£ç†çš„å­˜åœ¨åŸå§‹å¯¹è±¡çš„è®¿é—®éœ€è¦é€šè¿‡_get_current_object(å…¶å®å¯¹äºçœ‹è¿‡ä»£ç çš„è¿™åº”è¯¥æ˜¯åºŸè¯O_o)<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask,current_app&#10;from flask.globals import _app_ctx_stack&#10;with Flask(__name__).app_context():&#10;    print(current_app is _app_ctx_stack.top.app)&#10;    print(current_app._get_current_object() is _app_ctx_stack.top.app)&#10;# False&#10;# True</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="requestã€sessionå’Œg"><a href="#requestã€sessionå’Œg" class="headerlink" title="requestã€sessionå’Œg"></a>requestã€sessionå’Œg</h3><p>è¿™å‡ ä¸ªå’Œä¸Šä¸‹æ–‡æ¯æ¯ç›¸å…³,æ¯”å¦‚ç¦»å¼€äº†å¯¹åº”çš„ä¸Šä¸‹æ–‡å®ƒä»¬å®Œå…¨æ— æ³•ä½¿ç”¨<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request, session, g</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> [request, session, g]:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        i.x = <span class="number">1</span></span><br><span class="line">    <span class="keyword">except</span> RuntimeError:</span><br><span class="line">        print(<span class="string">'boom! '</span>, end=<span class="string">''</span>)</span><br><span class="line"><span class="comment"># boom! boom! boom!</span></span><br></pre></td></tr></table></figure><br>flaskçš„0.1ç‰ˆæœ¬æ˜¯åªæœ‰RequestContextè¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œæ²¡æœ‰åº”ç”¨ä¸Šä¸‹æ–‡çš„ã€‚<a href="https://github.com/pallets/flask/commit/47288231fe8f9c6b2c413d50160c32c3884d5785">ç›´åˆ°0.9ç‰ˆæœ¬æ‰ç”¨äºŒä¸‰åè¡Œä»£ç åŠ ä¸ŠAppContextåº”ç”¨ä¸Šä¸‹æ–‡</a><br>ä¸ºä»€ä¹ˆè¦åŠ ä¸Šåº”ç”¨ä¸Šä¸‹æ–‡å‘¢ã€‚å®˜æ–¹æ–‡æ¡£æˆ‘æ²¡æœ‰æ‰¾åˆ°å¾ˆè¯¦å°½çš„è§£é‡Šï¼Œ<a href="http://flask.pocoo.org/docs/0.11/appcontext/#purpose-of-the-application-context">åªæœ‰ä¸€æ®µç®€è¦çš„æè¿°</a>ï¼ŒåŒæ—¶å‚è€ƒäº†ä¸‹åˆ«äººçš„åšå®¢ã€‚æˆ‘ä¸ªäººç†è§£æ˜¯ä¸ºäº†å¤„ç†å•ç‹¬ä½¿ç”¨åº”ç”¨ä¸Šä¸‹æ–‡ä¸ä½¿ç”¨è¯·æ±‚ä¸Šä¸‹æ–‡çš„æƒ…å†µã€‚å¦å¤–æ–‡æ¡£æœ‰<code>creating such a request context is an unnecessarily expensive operation</code>åœ¨æŸäº›æƒ…å†µä½¿ç”¨è¯·æ±‚ä¸Šä¸‹æ–‡æ˜¯æ˜‚è´µçš„æ²¡æœ‰å¿…è¦çš„æ“ä½œã€‚å‚è€ƒä¸‹é¢çš„ä»£ç <br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,current_app</span><br><span class="line"><span class="keyword">from</span> flask.globals <span class="keyword">import</span> _app_ctx_stack, _request_ctx_stack</span><br><span class="line"></span><br><span class="line">app1 = Flask(<span class="string">'a'</span>)</span><br><span class="line">app2 = Flask(<span class="string">'b'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> app1.app_context():</span><br><span class="line">    <span class="keyword">with</span> app2.app_context():</span><br><span class="line">        print(_request_ctx_stack._local.__storage__)</span><br><span class="line">        print(_app_ctx_stack._local.__storage__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &#123;&#125;</span></span><br><span class="line"><span class="comment"># &#123;140735191154688: &#123;'stack': [&lt;flask.ctx.AppContext object at 0x1096c1f60&gt;, &lt;flask.ctx.AppContext object at 0x1096cd048&gt;]&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> app1.test_client() <span class="keyword">as</span> client1:</span><br><span class="line">    <span class="keyword">with</span> app2.test_client() <span class="keyword">as</span> client2:</span><br><span class="line">        print(_request_ctx_stack._local.__storage__)</span><br><span class="line">        print(_app_ctx_stack._local.__storage__)</span><br><span class="line">        client2.get(<span class="string">'/b'</span>)</span><br><span class="line">        print(current_app)</span><br><span class="line">        print(_request_ctx_stack._local.__storage__)</span><br><span class="line">        client1.get(<span class="string">'/a'</span>)</span><br><span class="line">        print(current_app)</span><br><span class="line">        print(_request_ctx_stack._local.__storage__)</span><br><span class="line">    resp = client1.get(<span class="string">'/a'</span>)</span><br><span class="line">    print(_request_ctx_stack._local.__storage__)</span><br><span class="line">    print(current_app)</span><br><span class="line"><span class="comment"># &#123;&#125;</span></span><br><span class="line"><span class="comment"># &#123;&#125;</span></span><br><span class="line"><span class="comment"># &lt;Flask 'b'&gt;</span></span><br><span class="line"><span class="comment"># &#123;140735191154688: &#123;'stack': [&lt;RequestContext 'http://localhost/b' [GET] of b&gt;]&#125;&#125;</span></span><br><span class="line"><span class="comment"># &lt;Flask 'a'&gt;</span></span><br><span class="line"><span class="comment"># &#123;140735191154688: &#123;'stack': [&lt;RequestContext 'http://localhost/a' [GET] of a&gt;]&#125;&#125;</span></span><br><span class="line"><span class="comment"># &#123;140735191154688: &#123;'stack': [&lt;RequestContext 'http://localhost/a' [GET] of a&gt;]&#125;&#125;</span></span><br></pre></td></tr></table></figure><br>é¦–å…ˆå¯ä»¥çœ‹åˆ°æ‰§è¡Œapp_context()çš„æ—¶å€™æœ‰äº†åº”ç”¨ä¸Šä¸‹æ–‡ï¼Œå’Œè¯·æ±‚ä¸Šä¸‹æ–‡ä¸€æ¯›é’±å…³ç³»éƒ½æ²¡æœ‰ã€‚çœ‹ä¸‹ä»£ç å°±æ˜¯return AppContext(self),å®ƒè‡ªå·±æœ‰ä¸ª<strong>enter</strong>å‡½æ•°æ‰§è¡Œäº†pushã€‚è¿™æœ‰ä»€ä¹ˆç”¨å‘¢ã€‚æ¯”å¦‚ä½ è¦åœ¨å‘½ä»¤è¡Œè°ƒç”¨ä¸‹ä½ å†™çš„æ•°æ®åº“å‡½æ•°ã€‚å¾ˆæ˜æ˜¾å®ƒéœ€è¦æ•°æ®åº“çš„é…ç½®app.configã€‚å¦‚æœæ²¡æœ‰åº”ç”¨ä¸Šä¸‹æ–‡ï¼Œé‚£ä¹ˆä½ éœ€è¦å…ˆåˆ›å»ºè¯·æ±‚ä¸Šä¸‹æ–‡ã€‚ç°åœ¨ä½ åªéœ€è¦åˆ›å»ºåº”ç”¨ä¸Šä¸‹æ–‡äº†(æ¯”è¯·æ±‚ä¸Šä¸‹æ–‡æ›´è½»é‡)ã€‚å†è€…å½“æˆ‘ä»¬ä¸€æ¬¡æ€§è¿›å…¥äº†å¤šä¸ªåº”ç”¨ä¸Šä¸‹æ–‡çš„æ—¶å€™æ­¤æ—¶æ ˆé‡Œé¢å°±ä¸æ­¢ä¸€ä¸ªå…ƒç´ äº†ã€‚æ‰€ä»¥ã€‚ã€‚ã€‚ã€‚è¿™ä¹Ÿæ˜¯ä¸Šé¢é—®çš„ä¸ºä»€ä¹ˆè¦ç”¨æ ˆ</p>
<p>ç¬¬äºŒä¸ªä¾‹å­åªæœ‰å½“è¯·æ±‚å‘é€ååº”ç”¨ä¸Šä¸‹æ–‡å’Œè¯·æ±‚ä¸Šä¸‹æ–‡æ‰ä¼šåŒæ—¶å…¥æ ˆã€‚ä¸”åŒæ—¶å‡ºæ ˆï¼Œæ‰€ä»¥ç½‘ä¸Šæœ‰åšå®¢å†™ä¸€ä¸ªåº”ç”¨ä¸Šä¸‹æ–‡ä¼šåŒ…å«å¤šä¸ªè¯·æ±‚ä¸Šä¸‹æ–‡è¿™æ˜¯ä¸å¯¹çš„ã€‚å¹¶ä¸”ç»å¯¹ä¸èƒ½ç†è§£ä¸ºåº”ç”¨ä¸Šä¸‹æ–‡çš„ç”Ÿå­˜å‘¨æœŸæ˜¯ä¸€ä¸ªappä»å¯åŠ¨åˆ°å…³é—­è¿™ä¸ªè¿‡ç¨‹</p>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p><a href="https://blog.tonyseek.com/post/the-context-mechanism-of-flask/">Flask çš„ Context æœºåˆ¶</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ‰äººè¯´flaskçš„ä¸Šä¸‹æ–‡æœºåˆ¶æ˜¯æ•´ä¸ªæ¡†æ¶çš„ç²¾åéƒ¨åˆ†ï¼Œæœ‰äººè¯´å®ƒç¥å¥‡çš„gè®©äººè´¹è§£ã€‚werkzeugçš„local.pyå°±æ˜¯å®ƒçš„å…·ä½“å®ç°ã€‚è¿™ä¸ªçœ‹ä¼¼ç¥å¥‡çš„æœºåˆ¶èƒŒååŠ ä¸Šåº”ç”¨ä»£ç ä¹Ÿä¸è¿‡ä¸¤ä¸‰ç™¾è¡Œã€‚ä¸è¿‡å¥½åƒå‘è¿˜æ˜¯&lt;code&gt;æ¯”è¾ƒæ·±&lt;/code&gt;çš„ã€‚å¦å¤–flaskçš„0.1ç‰ˆæœ¬æ‰200å¤šè¡Œä»£ç ã€‚å€¼å¾—ç…ä¸€ä¸‹&lt;/p&gt;
    
    </summary>
    
      <category term="Flask" scheme="https://www.zoulei.net/categories/Flask/"/>
    
    
      <category term="Flask" scheme="https://www.zoulei.net/tags/Flask/"/>
    
  </entry>
  
  <entry>
    <title>listå’Œdictçš„çº¿ç¨‹å®‰å…¨</title>
    <link href="https://www.zoulei.net/2016/07/31/list_dict_threading_safe/"/>
    <id>https://www.zoulei.net/2016/07/31/list_dict_threading_safe/</id>
    <published>2016-07-30T23:47:09.000Z</published>
    <updated>2016-08-02T03:56:03.000Z</updated>
    
    <content type="html"><![CDATA[<p>åˆšè½¬è¡Œç¬¬ä¸€æ¬¡ITé¢è¯•çš„æ—¶å€™é¢è¯•å®˜é—®æˆ‘ï¼Œlistå’Œdictæ˜¯ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å½“æ—¶æˆ‘å°±æƒ³ï¼Œæ“¦å˜,ä½œä¸ºä¸€ä¸ªåˆå­¦è€…listå’Œdictä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„éƒ½çœ‹äº†Néå•¦ã€‚è¿™è¿˜æœ‰ç–‘é—®ä¹ˆ~~~ï¼Œç°åœ¨æƒ³æƒ³å¹¶æ²¡æœ‰æŠ“ä½é‡ç‚¹ï¼Œçº¿ç¨‹å®‰å…¨åº”è¯¥é’ˆå¯¹äºå…·ä½“çš„æ“ä½œï¼Œè€Œä¸æ˜¯å…·ä½“çš„å¯¹è±¡ï¼Œæˆ‘ä»¬è¯´Queueæ˜¯çº¿ç¨‹å®‰å…¨çš„æ˜¯å› ä¸ºé’ˆå¯¹å®ƒçš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<a id="more"></a>
<h3 id="å®˜æ–¹æ–‡æ¡£"><a href="#å®˜æ–¹æ–‡æ¡£" class="headerlink" title="å®˜æ–¹æ–‡æ¡£"></a><a href="https://docs.python.org/2/faq/library.html#what-kinds-of-global-value-mutation-are-thread-safe">å®˜æ–¹æ–‡æ¡£</a></h3><p>å¯ä»¥çœ‹åˆ°å¤§æ¦‚æœ‰è¿™ä¹ˆä¸ªæ¦‚å¿µ<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">L,L1,L2-&#62;list&#10;D,D1,D2-&#62;dict&#10;x,y-&#62;object&#10;i,j-&#62;int&#10;&#10;&#32447;&#31243;&#23433;&#20840;&#10;L.append(x)&#10;L1.append(L2)&#10;x=L[i]&#10;y=L.pop()&#10;L1[i,j]=L2&#10;L.sort()&#10;x=y&#10;x.field=y&#10;D[x]=y&#10;D1.update(D2)&#10;D.keys()&#10;&#10;&#10;&#20197;&#19979;&#26159;&#38750;&#32447;&#31243;&#23433;&#20840;&#10;i=i+1&#10;L.append(L[-1])&#10;L[i]=L[j]&#10;D[x]=D[x]+1</span><br></pre></td></tr></table></figure><br>å¯ä»¥çœ‹åˆ°listçš„appendå•¥çš„å…¶å®æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚æˆ‘ä»¬çœ‹åˆ°çš„ä¸¾éçº¿ç¨‹å®‰å…¨çš„ä¾‹å­åŸºæœ¬éƒ½æ˜¯i+=1è¿™ç§ï¼Œæœ€åå¾—åˆ°çš„ç»“æœå°äºç›¸åŠ æ¬¡æ•°ã€‚ç„¶åæœ€åè¯´ä¸€å¥å¤šçº¿ç¨‹å¯¹åŒä¸€èµ„æºè¿›è¡Œæ“ä½œçš„æ—¶å€™è¦åŠ é”å“‡ã€‚ã€‚ã€‚ã€‚ã€‚è¿™è¯ç›´æ¥è¯´çš„å¥½åƒæ¯”è¾ƒä¸è´Ÿè´£ä»»ã€‚è®©æˆ‘è¿™æ ·çš„åˆå­¦è€…é£å£°é¹¤å”³è‰æœ¨çš†å…µ</p>
<h3 id="ä¸€ç‚¹å°è§£é‡Š"><a href="#ä¸€ç‚¹å°è§£é‡Š" class="headerlink" title="ä¸€ç‚¹å°è§£é‡Š"></a>ä¸€ç‚¹å°è§£é‡Š</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> dis</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> i</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">3000000</span>):</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">th = [threading.Thread(target=main), threading.Thread(target=main)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> th:</span><br><span class="line">    t.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> th:</span><br><span class="line">    t.join()</span><br><span class="line">print(i)</span><br><span class="line"></span><br><span class="line">dis.dis(main)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4372439</span></span><br><span class="line"><span class="comment">#   8           0 SETUP_LOOP              30 (to 33)</span></span><br><span class="line"><span class="comment">#               3 LOAD_GLOBAL              0 (range)</span></span><br><span class="line"><span class="comment">#               6 LOAD_CONST               1 (3000000)</span></span><br><span class="line"><span class="comment">#               9 CALL_FUNCTION            1</span></span><br><span class="line"><span class="comment">#              12 GET_ITER            </span></span><br><span class="line"><span class="comment">#         &gt;&gt;   13 FOR_ITER                16 (to 32)</span></span><br><span class="line"><span class="comment">#              16 STORE_FAST               0 (_)</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#   9          19 LOAD_GLOBAL              1 (i)</span></span><br><span class="line"><span class="comment">#              22 LOAD_CONST               2 (1)</span></span><br><span class="line"><span class="comment">#              25 INPLACE_ADD         </span></span><br><span class="line"><span class="comment">#              26 STORE_GLOBAL             1 (i)</span></span><br><span class="line"><span class="comment">#              29 JUMP_ABSOLUTE           13</span></span><br><span class="line"><span class="comment">#         &gt;&gt;   32 POP_BLOCK           </span></span><br><span class="line"><span class="comment">#         &gt;&gt;   33 LOAD_CONST               0 (None)</span></span><br><span class="line"><span class="comment">#              36 RETURN_VALUE</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çŸ¥é“pythonä»£ç ç»è¿‡ç¼–è¯‘æˆå­—èŠ‚ç æŒ‡ä»¤ï¼Œç„¶åpythonè™šæ‹ŸæœºæŒ‰ç…§æŒ‡ä»¤è¿›è¡Œæ‰§è¡Œï¼Œè¿™é‡Œæ¯ä¸€æ¡æŒ‡ä»¤éƒ½æ˜¯åŸå­æ“ä½œä¸ä¼šè¢«ä¸­æ–­ï¼Œå¯ä»¥çœ‹åˆ°<code>i+=1</code>è¿™æ¡è¯­å¥è¢«åˆ’åˆ†ä¸º4æ¡æŒ‡ä»¤è¢«æ‰§è¡Œã€‚å–å‡ºiå˜é‡çš„å€¼å…¥æ ˆâ†’â†’å°†è¢«åŠ æ•°1å…¥æ ˆâ†’â†’å–å‡º2ä¸ªæ•°ç›¸åŠ ç»“æœå†å…¥æ ˆâ†’â†’ç»“æœå‡ºæ ˆã€‚å› ä¸ºæ˜¯è¦ç´¯åŠ ã€‚æˆ‘ä»¬å½“ç„¶éœ€è¦ç´¯åŠ çš„ç¬¬ä¸€æ­¥åŠ å…¥çš„å€¼æ˜¯ä¸Šä¸€ä¸ªç´¯åŠ çš„ç»“æœã€‚å¯æ˜¯åœ¨å¤šçº¿ç¨‹ä¸åŠ é”çš„æƒ…å†µä¸‹æ¯ä¸€æ¡æŒ‡ä»¤è¢«æ‰§è¡Œå®Œæ¯•åéƒ½æœ‰å¯èƒ½å»æ‰§è¡Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„æŒ‡ä»¤ã€‚è¿™å°±ä¼šé€ æˆç¬¬ä¸€æ­¥åŠ å…¥çš„å€¼æœ‰å¯èƒ½å’Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹æ˜¯ä¸€æ ·çš„ï¼Œäºæ˜¯æ‚²å‰§å‘ç”Ÿäº†O_o</p>
<p>å†æƒ³ä¸€æƒ³append<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">8          19 LOAD_GLOBAL              1 (i)&#10;           22 LOAD_ATTR                2 (append)&#10;           25 LOAD_CONST               2 (1)&#10;           28 CALL_FUNCTION            1&#10;           31 POP_TOP</span><br></pre></td></tr></table></figure><br> <a href="http://jakevdp.github.io/images/array_vs_list.png">å›¾ç‰‡å¼•ç”¨è‡ª</a><br> <img src="https://ficapy.b0.upaiyun.com/blogimg/array_vs_list.png" alt="array_vs_list"><br>å¯ä»¥çœ‹å‡ºlistå°±æ˜¯ä¸€ä¸ªå®¹å™¨.appendå°±ç›¸å½“ä¸åœ¨æœ€åé¢åŠ äº†ä¸€ä¸ªå¼•ç”¨ã€‚è™½ç„¶å®ƒä¹Ÿæ˜¯ç”±å‡ æ¡æŒ‡å®šç»„æˆã€‚ä¹Ÿä¼šå‘ç”Ÿäº¤é”™æ‰§è¡Œçš„æƒ…å†µã€‚è¿™ç§äº¤é”™é€ æˆçš„ç»“æœæ— éå°±æ˜¯æˆ‘æœ¬æ¥æ˜¯å…ˆæ‰§è¡Œçš„å´åœ¨äº†ä¸€ä¸ªçš„åé¢æ‰§è¡Œäº†æ’å…¥ï¼Œé€ æˆçš„ç»“æœå°±æ˜¯<code>é¡ºåºé”™ä¹±äº†</code>ã€‚ğŸ˜„å¯æ˜¯ç‰¹å–µæœ¬æ¥å°±æ˜¯å¤šçº¿ç¨‹ç¨‹åºï¼Œè°ç‰¹å–µä¼šå»å…³å¿ƒé¡ºåºå‘¢ã€‚æ‰€ä»¥å°±è¯´çº¿ç¨‹å®‰å…¨äº†ã€‚<br>å¯ä»¥çœ‹å‡ºï¼Œappendå’Œ<code>i+=1</code>æœ€å¤§çš„åŒºåˆ«å°±æ˜¯æ˜¯å¦å¯¹è‡ªèº«è¿›è¡Œäº†ä¿®æ”¹ã€‚dictåŒç†~~</p>
<p>å¦å¤–åŠ é”çš„æ—¶é—´å¼€é”€å…¶å®è¿˜æ˜¯æŒºå¤§çš„ã€‚ä¸Šä¾‹ï¼Œæˆ‘ç”¨3ä¸ªçº¿ç¨‹(ç»“æœæ˜¯9000000)ï¼Œä¸åŠ é”1.38ç§’ï¼ŒåŠ é”æ‰§è¡Œ39.16ç§’(python2.7.11)ã€‚ä¸åŠ é”1.06ç§’ï¼ŒåŠ é”3.94ç§’(python3.5.1)ã€‚â†’_â†’å½“ç„¶ä½ å¯ä»¥æŠŠi+=1æ”¹æˆi.apped(1)è¿™æ ·ä¸ç”¨é”ç»“æœä¹Ÿèƒ½å¯¹äº†ï¼Œåªä¸è¿‡å†…å­˜æ¶ˆè€—æ„Ÿäºº</p>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p><a href="http://qingyunha.github.io/taotao/">A Python Interpreter Written in Python</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åˆšè½¬è¡Œç¬¬ä¸€æ¬¡ITé¢è¯•çš„æ—¶å€™é¢è¯•å®˜é—®æˆ‘ï¼Œlistå’Œdictæ˜¯ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å½“æ—¶æˆ‘å°±æƒ³ï¼Œæ“¦å˜,ä½œä¸ºä¸€ä¸ªåˆå­¦è€…listå’Œdictä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„éƒ½çœ‹äº†Néå•¦ã€‚è¿™è¿˜æœ‰ç–‘é—®ä¹ˆ~~~ï¼Œç°åœ¨æƒ³æƒ³å¹¶æ²¡æœ‰æŠ“ä½é‡ç‚¹ï¼Œçº¿ç¨‹å®‰å…¨åº”è¯¥é’ˆå¯¹äºå…·ä½“çš„æ“ä½œï¼Œè€Œä¸æ˜¯å…·ä½“çš„å¯¹è±¡ï¼Œæˆ‘ä»¬è¯´Queueæ˜¯çº¿ç¨‹å®‰å…¨çš„æ˜¯å› ä¸ºé’ˆå¯¹å®ƒçš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="python" scheme="https://www.zoulei.net/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>werkzeugæºç åˆ†æ(Request/Responseå’Œçƒ­é‡å¯)</title>
    <link href="https://www.zoulei.net/2016/07/25/werkzeug_note_requests_response_auto_realod/"/>
    <id>https://www.zoulei.net/2016/07/25/werkzeug_note_requests_response_auto_realod/</id>
    <published>2016-07-25T13:48:17.000Z</published>
    <updated>2016-09-04T08:46:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>Flaskè¿™ä¸ªäººäººç§°èµçš„å¾®æ¡†æ¶å°±æ˜¯æ„å»ºåœ¨werkzeugä¹‹ä¸Šï¼Œwerkzeugç»™è‡ªå·±çš„å®šä½å°±æ˜¯å·¥å…·é›†åˆã€‚å®ƒå®ç°äº†wsgi serverã€Requests/Responseå°è£…ã€DEBUGã€çƒ­é‡å¯ã€è·¯ç”±æ§åˆ¶ä»¥åŠå…¶ä»–çš„ä¸€äº›è¾…åŠ©åŠŸèƒ½ã€‚æ¥ä¸‹æ¥çš„å‡ ç¯‡æ–‡ç« ä¼šä»ä¸€äº›å¤§çš„æ–¹é¢å»åˆ†æå®ƒã€‚æœ¬ç¯‡å¦‚æ ‡é¢˜:D</p>
<a id="more"></a>
<h3 id="WSGI-Server"><a href="#WSGI-Server" class="headerlink" title="WSGI Server"></a>WSGI Server</h3><p>è¿™ä¸ªåˆç•¥è¯´ä¸€ä¸‹ã€‚å’Œå®ƒç›¸å…³çš„ä»£ç ä¸å¤šã€‚å’Œwsgirefä¸€æ ·å®ƒæ„å»ºåœ¨pythonè‡ªå¸¦æ¨¡å—SocketServerå’ŒBaseHTTPRequestHandlerä¹‹ä¸Šã€‚ç”šè‡³æ¯”è‡ªå¸¦çš„wsgirefä»£ç è¦å°‘ã€‚å®ƒä¸»è¦å¢åŠ äº†SSLå’Œsocket.fromfdæ”¯æŒã€‚å¹¶ä¸”å°†debugã€é™æ€æ–‡ä»¶åˆ†å‘ã€çƒ­é‡å¯ç»„åˆå†äº†ä¸€èµ·</p>
<h3 id="Requestã€Responseå°è£…"><a href="#Requestã€Responseå°è£…" class="headerlink" title="Requestã€Responseå°è£…"></a>Requestã€Responseå°è£…</h3><p>è¿™ä¸ªå¯èƒ½ç®—æ˜¯é‡ç‚¹äº†ã€‚æœ‰ä¸ªåº“webobå°±æ˜¯ä¸“é—¨åšè¿™ä¸ªçš„ã€‚å å¾—ä»£ç é‡ä¹Ÿå¾ˆå¤§ã€‚å¯æƒœæˆ‘å¹¶ä¸æƒ³è¯¦ç»†å†™æ¯ä¸€ä¸ªçš„è¿‡ç¨‹ï¼Œå¤ªéº»çƒ¦äº†ï¼Œäº†è§£äº†å¤§æ¦‚å°±å¥½å•¦ã€‚ä»¥åä¼šä¸»è¦åˆ†æä¸‹datastructures.pyè¿™ä¸ªæ–‡ä»¶ã€‚ä¸‹é¢æ˜¯è¶…ç®€æ´çš„åŸç†ä»£ç <br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, env)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="decorator">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">application</span><span class="params">(cls, f)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(env, start_response)</span>:</span></span><br><span class="line">            request = cls(env)</span><br><span class="line">            <span class="keyword">return</span> f(request)(env, start_response)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> decorator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Response</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, str)</span>:</span></span><br><span class="line">        self.body = str</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, env, start_response)</span>:</span></span><br><span class="line">        start_response(<span class="string">'200 OK'</span>, [])</span><br><span class="line">        <span class="keyword">return</span> [self.body]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="decorator">@Request.application</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">app</span><span class="params">(req)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> Response(<span class="string">b'Hello'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server</span><br><span class="line"></span><br><span class="line">make_server(<span class="string">''</span>, <span class="number">8000</span>, app).serve_forever()</span><br></pre></td></tr></table></figure><br>å¯ä»¥å¤§æ¦‚äº†è§£æ˜¯è¿™ä¹ˆå›äº‹:</p>
<ul>
<li>Requestå®ƒä¸»è¦å°è£…çš„æ˜¯headersï¼Œç„¶åå˜ï¼Œå„ç§å±æ€§éƒ½ç”¨propertyå°±å¥½äº†ï¼Œå‰©ä¸‹çš„bodyå’Œå…¶ä»–çš„ä¹Ÿå·®ä¸å¤šå•¦ã€‚</li>
<li>Request.applicationè¿™ä¸ªè£…é¥°å™¨çš„ä½œç”¨å°±æ˜¯å°†åŸæ¥çš„env,start_responseå‚æ•°å˜æˆreqç»™æˆ‘ä»¬ä½¿ç”¨</li>
<li><code>Responseå®ƒå°±æ˜¯ä¸€ä¸ªwsgiappå¯¹è±¡</code><br>çœ‹ä¸‹å®ƒä»¬2ä¸ªçš„ç»§æ‰¿å›¾<br><img src="https://ficapy.b0.upaiyun.com/blogimg/werkzerg_wrappers_inherit.png" alt="werkzeug.wrappers.inherit"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlainRequest</span><span class="params">(StreamOnlyMixin, Request)</span>:</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Response</span><span class="params">(BaseResponse, ETagResponseMixin, ResponseStreamMixin,</span><br><span class="line">               CommonResponseDescriptorsMixin,</span><br><span class="line">               WWWAuthenticateMixin)</span>:</span></span><br></pre></td></tr></table></figure>
ç¿»æºç å¯ä»¥çœ‹åˆ°å®ƒä»¬çš„ç»§æ‰¿å¤§éƒ¨åˆ†éƒ½æ˜¯å¯¹headersçš„æ“ä½œ</li>
</ul>
<h3 id="çƒ­é‡å¯å®ç°åŸç†"><a href="#çƒ­é‡å¯å®ç°åŸç†" class="headerlink" title="çƒ­é‡å¯å®ç°åŸç†"></a>çƒ­é‡å¯å®ç°åŸç†</h3><p>ä¸Šç®€å›¾ï¼š<br><img src="https://ficapy.b0.upaiyun.com/blogimg/werkzeug_autoreload.png" alt="werkzeug_autoreload"><br>ä¸ŠåŸç†ä»£ç :<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'Hello'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file_change</span><span class="params">()</span>:</span></span><br><span class="line">    mtimes = &#123;&#125;</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        filename = __file__</span><br><span class="line">        mtime = os.stat(filename).st_mtime</span><br><span class="line">        old_time = mtimes.get(filename)</span><br><span class="line">        <span class="keyword">if</span> old_time <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            mtimes[filename] = mtime</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">elif</span> mtime &gt; old_time:</span><br><span class="line">            print(<span class="string">' * Detected change in &#123;&#125;, reloading'</span>.format(filename))</span><br><span class="line">            sys.exit(<span class="number">3</span>)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.environ.get(<span class="string">'secord_process'</span>):</span><br><span class="line">    threading.Thread(target=main, args=()).start()</span><br><span class="line">    file_change()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        env = os.environ.copy()</span><br><span class="line">        env[<span class="string">'secord_process'</span>] = <span class="string">'true'</span></span><br><span class="line">        exit_code = subprocess.call([sys.executable] + sys.argv, env=env)</span><br><span class="line">        <span class="keyword">if</span> exit_code != <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure></p>
<p>åšæ³•å°±æ˜¯ä¸»çº¿ç¨‹å•¥äº‹æ²¡åšï¼Œè·‘ä¸€ä¸ªæ­»å¾ªç¯ï¼Œç”Ÿæˆå­è¿›ç¨‹(å°±ç›¸å½“è¿è¡Œè‡ªèº«,åŒºåˆ«å°±æ˜¯os.environ)ã€‚è¿™ä¸ªè¿›ç¨‹å†…ä½¿ç”¨å•ç‹¬çš„çº¿ç¨‹è·‘éœ€è¦è¿è¡Œçš„å‡½æ•°ï¼Œå¦å¤–å°±æ˜¯æ£€æŸ¥ç›¸å…³æ–‡ä»¶æ˜¯å¦è¢«æ”¹å˜ã€‚æ”¹å˜å°±æ‰§è¡Œsys.exitã€‚ç„¶åå°±åˆè¢«ä¸»çº¿ç¨‹çš„æ­»å¾ªç¯ç”Ÿæˆäº†æ–°çš„å­è¿›ç¨‹</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Flaskè¿™ä¸ªäººäººç§°èµçš„å¾®æ¡†æ¶å°±æ˜¯æ„å»ºåœ¨werkzeugä¹‹ä¸Šï¼Œwerkzeugç»™è‡ªå·±çš„å®šä½å°±æ˜¯å·¥å…·é›†åˆã€‚å®ƒå®ç°äº†wsgi serverã€Requests/Responseå°è£…ã€DEBUGã€çƒ­é‡å¯ã€è·¯ç”±æ§åˆ¶ä»¥åŠå…¶ä»–çš„ä¸€äº›è¾…åŠ©åŠŸèƒ½ã€‚æ¥ä¸‹æ¥çš„å‡ ç¯‡æ–‡ç« ä¼šä»ä¸€äº›å¤§çš„æ–¹é¢å»åˆ†æå®ƒã€‚æœ¬ç¯‡å¦‚æ ‡é¢˜:D&lt;/p&gt;
    
    </summary>
    
      <category term="Flask" scheme="https://www.zoulei.net/categories/Flask/"/>
    
    
      <category term="Flask" scheme="https://www.zoulei.net/tags/Flask/"/>
    
  </entry>
  
  <entry>
    <title>osx airdropæ— æ³•ä½¿ç”¨ä¿®å¤</title>
    <link href="https://www.zoulei.net/2016/07/23/fix_osx_airdrop_not_working/"/>
    <id>https://www.zoulei.net/2016/07/23/fix_osx_airdrop_not_working/</id>
    <published>2016-07-23T02:53:25.000Z</published>
    <updated>2016-07-24T08:27:21.000Z</updated>
    
    <content type="html"><![CDATA[<p>å‰äº›å¤©ç”¨çš„å¥½å¥½çš„airdropå±…ç„¶æ— æ³•ä½¿ç”¨äº†ã€‚å…·ä½“æƒ…å†µæ˜¯ï¼šæˆ‘æœ‰iphoneã€ipadã€macã€‚iphoneå’Œipadèƒ½å¤Ÿäº’ç›¸å‘ç°ã€‚macå¯¹å®ƒä»¬2ä¸ªå‘ç°ä¸äº†ã€‚å¦ˆè›‹æ­£è¦ä¼ èµ„æ–™å¯æ€¥æ­»æˆ‘äº†ã€‚ç½‘ä¸Šä¸€æœè¿™ç§æƒ…å†µè¿˜ä¸åœ¨å°‘æ•°ã€‚</p>
<p>é‡åˆ°è¿™ç§æƒ…å†µã€‚å¯ä»¥æ‰“å¼€about this macâ†’â†’system reportæŸ¥çœ‹Network(wifi)å¯ä»¥çœ‹åˆ°Country Code:æ˜¯ä¸æ˜¯CN(æˆ‘ç”µè„‘æœ‰é—®é¢˜çš„æ—¶å€™æ˜¯X3)ã€‚å¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆæ— æ³•ä½¿ç”¨airdropå°±å’Œå®ƒæœ‰å…³ã€‚è‡³äºå¦‚ä½•ä¿®å¤è¿™ä¸ªé—®é¢˜æˆ‘æ²¡æœ‰æ‰¾åˆ°ç¡®åˆ‡çš„åŠæ³•.æœ‰ä¸€ä¸ªåŸå› å¯èƒ½æ˜¯ç”±äºè·¯ç”±å™¨é€ æˆçš„ã€‚è¿™ä¸ªå¯ä»¥æ‰“å¼€ç³»ç»Ÿè‡ªå¸¦çš„æ— çº¿æ£€æµ‹å·¥å…·Wireless Diagnostics(Windowsâ†’â†’scan)æŸ¥çœ‹æ˜¯ä¸æ˜¯ç”±äºå›½å®¶ç å†²çªé€ æˆçš„(è¯¦æƒ…çœ‹ç¬¬ä¸€ä¸ªå‚è€ƒèµ„æ–™)ã€‚å¦‚æœè¿™é‡Œæ²¡æœ‰é—®é¢˜(æˆ‘çš„ä¸æ˜¯è¿™ä¸ªé—®é¢˜)ã€‚ã€‚ã€‚ã€‚ã€‚é‚£ä¹ˆè¯·å°è¯•æ‰§è¡Œä»¥ä¸‹æ“ä½œ</p>
<ol>
<li>å°†æ“ä½œç³»ç»Ÿçš„è¯­è¨€æ”¹æˆä¸­æ–‡</li>
<li>åœ¨ç³»ç»Ÿè®¾ç½®é¡µé€€å‡ºicloudè´¦å·</li>
<li>é‡å¯ç³»ç»Ÿ<br>ï¼š<br>ï¼š<br>å°¼ç›ï¼Œæœ‰å¯èƒ½å°±æš‚æ—¶èƒ½æ­£å¸¸ä½¿ç”¨äº†ãƒ¾(ï½¡ï½€Ğ”Â´ï½¡)</li>
</ol>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p><a href="http://www.howtogeek.com/211993/how-to-fix-conflicting-country-codes-and-improve-your-macs-wi-fi/">how-to-fix-conflicting-country-codes-and-improve-your-macs-wi-fi</a><br><a href="http://km.nicetypo.com/doc/7090786787135be8d32fa6624b892309">è§£æ±ºç„¡æ³•å¾ iPhone AirDrop åˆ° Mac çš„æ–¹æ³•</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å‰äº›å¤©ç”¨çš„å¥½å¥½çš„airdropå±…ç„¶æ— æ³•ä½¿ç”¨äº†ã€‚å…·ä½“æƒ…å†µæ˜¯ï¼šæˆ‘æœ‰iphoneã€ipadã€macã€‚iphoneå’Œipadèƒ½å¤Ÿäº’ç›¸å‘ç°ã€‚macå¯¹å®ƒä»¬2ä¸ªå‘ç°ä¸äº†ã€‚å¦ˆè›‹æ­£è¦ä¼ èµ„æ–™å¯æ€¥æ­»æˆ‘äº†ã€‚ç½‘ä¸Šä¸€æœè¿™ç§æƒ…å†µè¿˜ä¸åœ¨å°‘æ•°ã€‚&lt;/p&gt;
&lt;p&gt;é‡åˆ°è¿™ç§æƒ…å†µã€‚å¯ä»¥æ‰“å¼€about this ma
    
    </summary>
    
    
      <category term="éšç¬”" scheme="https://www.zoulei.net/tags/%E9%9A%8F%E7%AC%94/"/>
    
  </entry>
  
  <entry>
    <title>pycallgraphæºç åˆ†æ</title>
    <link href="https://www.zoulei.net/2016/07/22/pycallgraph_note/"/>
    <id>https://www.zoulei.net/2016/07/22/pycallgraph_note/</id>
    <published>2016-07-22T07:13:05.000Z</published>
    <updated>2016-08-18T10:01:11.000Z</updated>
    
    <content type="html"><![CDATA[<p>ç”¨æ¥ç”Ÿæˆå‡½æ•°è°ƒç”¨å›¾ï¼Œè¿™ä¸ªå·¥å…·å¯èƒ½åæ°”æ¯”è¾ƒå¤§ã€‚å› ä¸ºçœ‹ä»‹ç»å°±èƒ½çœ‹åˆ°å¥½åƒå¯ä»¥ç”Ÿæˆæ¯”è¾ƒå¸…æ°”çš„å›¾åƒã€‚ä»æºç å±‚é¢çœ‹ã€‚å…¶å®è¿™ä¸ªå·¥å…·æ˜¯ç›¸å½“ç®€å•çš„ï¼Œå°±æ˜¯ä½¿ç”¨äº†sys.settraceæ¥å£,è¯¥æ¥å£å¸¸ç”¨äºdebugã€profile(æœ¬æ–‡ç¯å¢ƒpython3.5.1)ã€‚</p>
<a id="more"></a>
<h3 id="pycallgraphæ–‡ä»¶ç»“æ„"><a href="#pycallgraphæ–‡ä»¶ç»“æ„" class="headerlink" title="pycallgraphæ–‡ä»¶ç»“æ„"></a>pycallgraphæ–‡ä»¶ç»“æ„</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#10;&#9500;&#9472;&#9472; __init__.py&#10;&#9500;&#9472;&#9472; color.py                &#26174;&#31034;&#39068;&#33394;&#10;&#9500;&#9472;&#9472; config.py               &#20027;&#35201;&#29992;&#26469;&#30830;&#23450;&#20351;&#29992;&#21738;&#20123;&#36807;&#28388;&#26041;&#27861;&#10;&#9500;&#9472;&#9472; exceptions.py           &#27809;&#21861;&#29992;&#10;&#9500;&#9472;&#9472; globbing_filter.py      &#23601;&#19968;&#20010;fnmatch&#10;&#9500;&#9472;&#9472; memory_profiler.py      &#10;&#9500;&#9472;&#9472; metadata.py&#10;&#9500;&#9472;&#9472; output                  output.py&#26159;&#22522;&#31867;&#65292;&#20854;&#20182;&#20960;&#20010;&#26159;&#20855;&#20307;&#36755;&#20986;&#26041;&#24335;&#10;&#9474;&#160;&#160; &#9500;&#9472;&#9472; __init__.py&#10;&#9474;&#160;&#160; &#9500;&#9472;&#9472; gephi.py&#10;&#9474;&#160;&#160; &#9500;&#9472;&#9472; graphviz.py&#10;&#9474;&#160;&#160; &#9500;&#9472;&#9472; output.py&#10;&#9474;&#160;&#160; &#9500;&#9472;&#9472; pickle.py&#10;&#9474;&#160;&#160; &#9492;&#9472;&#9472; ubigraph.py&#10;&#9500;&#9472;&#9472; pycallgraph.py          &#25972;&#21512;config&#21644;output&#10;&#9500;&#9472;&#9472; tracer.py               &#26680;&#24515;&#25991;&#20214;(&#35843;&#29992;sys.settrace&#30340;&#22320;&#26041;)&#10;&#9492;&#9472;&#9472; util.py</span><br></pre></td></tr></table></figure>
<h3 id="è·å–å‡½æ•°è¢«å“ªäº›å‡½æ•°è°ƒç”¨"><a href="#è·å–å‡½æ•°è¢«å“ªäº›å‡½æ•°è°ƒç”¨" class="headerlink" title="è·å–å‡½æ•°è¢«å“ªäº›å‡½æ•°è°ƒç”¨"></a>è·å–å‡½æ•°è¢«å“ªäº›å‡½æ•°è°ƒç”¨</h3><p>æŸ¥çœ‹ä¸‹é¢çš„ç›¸å…³èµ„æ–™ã€‚æœ‰è¿™æ ·ä¸€æ®µä»£ç <br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> traceback</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">()</span>:</span></span><br><span class="line">    g()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">g</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> traceback.format_stack():</span><br><span class="line">        print(line.strip())</span><br><span class="line"></span><br><span class="line">f()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Prints:</span></span><br><span class="line"><span class="comment"># File "so-stack.py", line 10, in &lt;module&gt;</span></span><br><span class="line"><span class="comment">#     f()</span></span><br><span class="line"><span class="comment"># File "so-stack.py", line 4, in f</span></span><br><span class="line"><span class="comment">#     g()</span></span><br><span class="line"><span class="comment"># File "so-stack.py", line 7, in g</span></span><br><span class="line"><span class="comment">#     for line in traceback.format_stack():</span></span><br></pre></td></tr></table></figure><br>å½“fè°ƒç”¨gçš„æ—¶å€™ã€‚åœ¨gé‡Œé¢æœ‰è°ƒç”¨äº†traceback.format_stackï¼Œå®ƒæ˜¾ç¤ºäº†å½“è°ƒç”¨å‡½æ•°gçš„æ—¶å€™çš„è°ƒç”¨è·¯å¾„ã€‚å®ç°å…¶å®æ˜¯æ¯”è¾ƒç®€å•çš„å˜›ã€‚å½“è°ƒç”¨gçš„æ—¶å€™ï¼Œå®ƒåœ¨æ ˆé¡¶ã€‚é‚£ä¹ˆåªéœ€è¦ä¸æ–­çš„è°ƒç”¨frame.f_backå°±èƒ½å¾—åˆ°ä¸Šä¸€ä¸ªæ ˆï¼Œå°±å¯ä»¥å¾—åˆ°ä»¥ä¸Šä¿¡æ¯ã€‚å¯ä»¥çœ‹å‡ºå®ƒå¾—åˆ°çš„æ˜¯å‡½æ•°è¢«è°ƒç”¨çš„ä¿¡æ¯ã€‚å‡å¦‚å‡½æ•°gè°ƒç”¨äº†å¾ˆå¤šåº•å±‚å‡½æ•°ï¼Œæ­¤æ—¶æˆ‘éœ€è¦è¿›è¡Œä¸€äº›patch hookï¼Œé‚£ä¹ˆè¦å¾—åˆ°æ˜¯å‡½æ•°gè°ƒç”¨äº†å“ªäº›åº•å±‚å‡½æ•°ï¼è¿™ç§æ–¹æ³•å°±æ²¡ç”¨äº†ã€‚å¥½åœ¨pythonæä¾›äº†sys.settrace</p>
<h3 id="sys-settraceåŸºæœ¬ä»‹ç»"><a href="#sys-settraceåŸºæœ¬ä»‹ç»" class="headerlink" title="sys.settraceåŸºæœ¬ä»‹ç»"></a>sys.settraceåŸºæœ¬ä»‹ç»</h3><p>é¦–å…ˆå¾—å¯¹pythonè¿è¡Œçš„åŸºæœ¬æ¦‚å¿µæœ‰ä¸ªäº†è§£ï¼Œå‡½æ•°çš„è°ƒç”¨æ˜¯ä¸€ç§æ ˆç»“æ„ã€‚å½“å‡½æ•°è¢«è°ƒç”¨(è§¦å‘calläº‹ä»¶)çš„æ—¶å€™å½“å‰å¸§å…¥æ ˆï¼Œå½“å‡½æ•°æ‰§è¡Œå®Œæ¯•è¿”å›(è§¦å‘returnäº‹ä»¶)çš„æ—¶å€™æ ˆé¡¶çš„å¸§å‡ºæ ˆã€‚sys.settraceå°±æ˜¯å¯¹è¿™äº›äº‹ä»¶çš„hookã€‚çœ‹ä¸‹é¢è¿™æ®µä»£ç <br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trace</span><span class="params">(frame, event, args,record=[])</span>:</span></span><br><span class="line">    print(frame.f_lineno, frame.f_code.co_filename, event)</span><br><span class="line">    <span class="keyword">if</span> event == <span class="string">'call'</span>:</span><br><span class="line">        record.append(frame)</span><br><span class="line">    <span class="keyword">elif</span> event == <span class="string">'return'</span>:</span><br><span class="line">        pre_frame = record.pop()</span><br><span class="line">        print(pre_frame <span class="keyword">is</span> frame)</span><br><span class="line">    <span class="keyword">return</span> trace</span><br><span class="line">sys.settrace(trace)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="number">1</span> / i - <span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span> ZeroDivisionError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">main()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 11 /Users/ficapy/Dropbox/source_read/py3/settrace.py call</span></span><br><span class="line"><span class="comment"># 12 /Users/ficapy/Dropbox/source_read/py3/settrace.py line</span></span><br><span class="line"><span class="comment"># 13 /Users/ficapy/Dropbox/source_read/py3/settrace.py line</span></span><br><span class="line"><span class="comment"># 14 /Users/ficapy/Dropbox/source_read/py3/settrace.py line</span></span><br><span class="line"><span class="comment"># 14 /Users/ficapy/Dropbox/source_read/py3/settrace.py exception</span></span><br><span class="line"><span class="comment"># 15 /Users/ficapy/Dropbox/source_read/py3/settrace.py line</span></span><br><span class="line"><span class="comment"># 16 /Users/ficapy/Dropbox/source_read/py3/settrace.py line</span></span><br><span class="line"><span class="comment"># 12 /Users/ficapy/Dropbox/source_read/py3/settrace.py line</span></span><br><span class="line"><span class="comment"># 13 /Users/ficapy/Dropbox/source_read/py3/settrace.py line</span></span><br><span class="line"><span class="comment"># 14 /Users/ficapy/Dropbox/source_read/py3/settrace.py line</span></span><br><span class="line"><span class="comment"># 12 /Users/ficapy/Dropbox/source_read/py3/settrace.py line</span></span><br><span class="line"><span class="comment"># 12 /Users/ficapy/Dropbox/source_read/py3/settrace.py return</span></span><br><span class="line"><span class="comment"># True</span></span><br></pre></td></tr></table></figure><br>æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„çš„:</p>
<ol>
<li>traceå‡½æ•°æœ€åè®°å¾—è¿”å›è‡ªèº«</li>
<li>ä¸éœ€è¦è€ƒè™‘å¤šçº¿ç¨‹é—®é¢˜ï¼Œå› ä¸ºsys.settraceåªå¯¹ä¸»çº¿ç¨‹æœ‰æ•ˆ(å¤šçº¿ç¨‹æ˜¯threading.settraceï¼Œå¤šè¿›ç¨‹æ²¡è¯•è¿‡)</li>
<li>è¿˜æ˜¯è¦åºŸè¯ä¸€å¥ï¼Œå‘ç”Ÿreturnçš„æ—¶å€™frameä¸€å®šæ˜¯æœ€åä¸€ä¸ªcallçš„frameã€‚è¿™ä¹Ÿæ˜¯pycallgraphçš„è¿è¡Œçš„åŸºæœ¬æ¡ä»¶ã€‚</li>
<li>è™½ç„¶traceæœ‰7ä¸ªäº‹ä»¶ã€‚å¯æ˜¯å¯¹äºæˆ‘ä»¬ç»˜åˆ¶è°ƒç”¨å›¾callã€returnå°±å¤Ÿäº†.</li>
</ol>
<h3 id="pycallgraphåŸç†ç‰ˆæœ¬"><a href="#pycallgraphåŸç†ç‰ˆæœ¬" class="headerlink" title="pycallgraphåŸç†ç‰ˆæœ¬"></a>pycallgraphåŸç†ç‰ˆæœ¬</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="keyword">from</span> pprint <span class="keyword">import</span> pprint</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">call_dict = defaultdict(<span class="keyword">lambda</span>: defaultdict(int))</span><br><span class="line">frame_stack = []</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trace</span><span class="params">(frame, event, args)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> event == <span class="string">'call'</span>:</span><br><span class="line">        frame_stack.append(frame)</span><br><span class="line">        call_dict[frame.f_back][frame] += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> event == <span class="string">'return'</span>:</span><br><span class="line">        <span class="keyword">if</span> frame <span class="keyword">is</span> frame_stack[-<span class="number">1</span>]:</span><br><span class="line">            frame_stack.pop()</span><br><span class="line">    <span class="keyword">return</span> trace</span><br><span class="line"></span><br><span class="line">sys.settrace(trace)</span><br><span class="line">requests.get(<span class="string">'http://www.z.cn'</span>)</span><br><span class="line">sys.settrace(<span class="keyword">None</span>)</span><br><span class="line">pprint(call_dict)</span><br><span class="line"></span><br><span class="line"><span class="comment"># defaultdict(&lt;function &lt;lambda&gt; at 0x10f282950&gt;,</span></span><br><span class="line"><span class="comment">#             &#123;&lt;frame object at 0x10f199448&gt;: defaultdict(&lt;class 'int'&gt;,</span></span><br><span class="line"><span class="comment">#                                                         &#123;&lt;frame object at 0x10f303848&gt;: 1,</span></span><br><span class="line"><span class="comment">#                                                          &lt;frame object at 0x10f4f93d8&gt;: 1,</span></span><br><span class="line"><span class="comment">#                                                          &lt;frame object at 0x10f985980&gt;: 1&#125;),</span></span><br><span class="line"><span class="comment">#                                                         :</span></span><br><span class="line"><span class="comment">#                                                         :</span></span><br><span class="line"><span class="comment">#                                                         :</span></span><br><span class="line"><span class="comment">#              &lt;frame object at 0x7fa6630a2018&gt;: defaultdict(&lt;class 'int'&gt;,</span></span><br><span class="line"><span class="comment">#                                                            &#123;&lt;frame object at 0x10fd1b8b8&gt;: 1,</span></span><br><span class="line"><span class="comment">#                                                             &lt;frame object at 0x10fd2a9d0&gt;: 1,</span></span><br><span class="line"><span class="comment">#                                                             &lt;frame object at 0x10fd2f908&gt;: 1,</span></span><br><span class="line"><span class="comment">#                                                             &lt;frame object at 0x10fd32570&gt;: 1,</span></span><br><span class="line"><span class="comment">#                                                             &lt;frame object at 0x10fd3fac8&gt;: 1,</span></span><br><span class="line"><span class="comment">#                                                             &lt;frame object at 0x7fa662093cc8&gt;: 1,</span></span><br><span class="line"><span class="comment">#                                                             &lt;frame object at 0x7fa6621ddc98&gt;: 1,</span></span><br><span class="line"><span class="comment">#                                                             &lt;frame object at 0x7fa6621e0468&gt;: 1&#125;)&#125;)</span></span><br></pre></td></tr></table></figure>
<p>åœ¨æ¯ä¸ªå‡½æ•°è°ƒç”¨çš„æ—¶å€™ï¼Œå°†å½“å‰æ ˆå’Œä¸Šä¸€ä¸ªæ ˆå…³è”èµ·æ¥ã€‚æ‰€æœ‰çš„æ•°æ®æ±‡æ€»å°±å¾—åˆ°äº†requests.getçš„è°ƒç”¨å…³ç³»å›¾ã€‚ç„¶åå°±å¯ä»¥å…´å¥‹çš„å»ç”¨graphvizç”Ÿæˆå›¾ç‰‡~(â‰§â–½â‰¦)/~å•¦å•¦å•¦ï¼Œç›´æ¥è¿™æ ·å¤§æ¦‚å°±ç”Ÿæˆäº†ç±»ä¼¼ä¸‹é¢çš„å›¾ç‰‡<br><img src="https://ws2.sinaimg.cn/large/a25f7e36gw1f62u6liqvqj21kw0awdjr.jpg" alt="confusion_requests"><br>çœ‹èµ·æ¥å¾ˆç‚«é…·ï¼Œå…¶å®å˜›ç”¨æ²¡æœ‰ï¼Œå‡ ç™¾ä¸ªå…ƒç´ çº¿æ¡ä¸€å¤§å †ï¼Œæ ¹æœ¬çªå‡ºä¸äº†é‡ç‚¹ã€‚<strong><code>æ‰€ä»¥æ”¶é›†æ•°æ®æ˜¯å¾ˆå®¹æ˜“çš„ï¼Œæœ€é‡è¦çš„æ˜¯è¿‡æ»¤æ•°æ®ï¼Œé‡ç‚¹çªå‡ºè‡ªå·±éœ€è¦çš„æ•°æ®</code></strong>è¿™éƒ¨åˆ†åº”è¯¥ä¹Ÿæ˜¯pycallgraphçš„é‡ç‚¹è¦å¤„ç†çš„éƒ¨åˆ†(å¤„ç†çš„å¹¶ä¸å¥½)ã€‚</p>
<h3 id="è¿‡æ»¤ä¸éœ€è¦å…³æ³¨çš„å‡½æ•°"><a href="#è¿‡æ»¤ä¸éœ€è¦å…³æ³¨çš„å‡½æ•°" class="headerlink" title="è¿‡æ»¤ä¸éœ€è¦å…³æ³¨çš„å‡½æ•°"></a>è¿‡æ»¤ä¸éœ€è¦å…³æ³¨çš„å‡½æ•°</h3><p>æ¯”å¦‚ä¸€ä¸ªå‡½æ•°æˆ‘ä»¬ä¸éœ€è¦å…³æ³¨ã€‚é‚£ä¹ˆå½“calläº‹ä»¶çš„æ—¶å€™æˆ‘ä»¬åªéœ€è¦ä¸æŠŠå®ƒåŠ å…¥åˆ°call_dictä¸­ã€‚åŒæ—¶å°†å½“å‰æ ˆé•¿åº¦è®¾ç½®ä¸ºæœ€å¤§é•¿åº¦ã€‚é‚£ä¹ˆè¯¥å‡½æ•°å’Œè¢«è¯¥å‡½æ•°è°ƒç”¨çš„å‡½æ•°éƒ½ä¸ä¼šè¢«æˆ‘ä»¬è®°å½•ã€‚pycallgraphçš„åšæ³•æ˜¯:ä¸åŠ å…¥åˆ°call_dictï¼Œåªæ˜¯å¯¹frame_stackåˆ—è¡¨åŠ å…¥ä¸€ä¸ªç©ºå€¼ã€‚returnäº‹ä»¶ä¹Ÿåªæ˜¯ç®€å•çš„popç§»å‡º(è¿™æ ·é€ æˆçš„ç»“æœå°±æ˜¯è¯¥å‡½æ•°ä¸è¢«è®°å½•ï¼Œå¯æ˜¯è¯¥è¢«è¯¥å‡½æ•°è°ƒç”¨çš„å…¶ä»–å‡½æ•°åªè¦ä¸è¢«è§„åˆ™è¿‡æ»¤å°±ä¼šè¢«è®°å½•)<br>é€šå¸¸è¿‡æ»¤çš„æ¡ä»¶ä¼šæœ‰:</p>
<ol>
<li>å†…ç½®æ¨¡å—</li>
<li>ç§æœ‰å‡½æ•°</li>
<li>æ¯”å¦‚ä¸€äº›åº“æœ‰compat.pyã€datastructers.pyã€exceptions.pyã€utils.pyè¿™äº›æ¨¡å—å¸¸ä¼šè¢«å¼•ç”¨ã€‚å¯æ˜¯å¯¹äº†è§£æ•´ä¸ªè¿‡ç¨‹å¹¶æ²¡æœ‰ä»€ä¹ˆå¸®åŠ©ã€‚åè€Œä¼šå¯¼è‡´ç”Ÿæˆçš„å›¾å¾ˆæ··ä¹±</li>
<li>æŸäº›åº“è™½ç„¶è¢«å¼•ç”¨å¤ªå¤šæ¬¡ä¹Ÿè¯¥è¢«åˆ é™¤<br>æ€»ä¹‹å°±æ˜¯æ ¹æ®éœ€è¦å…³æ³¨çš„åœ°æ–¹å†™è¿‡æ»¤è§„åˆ™ï¼Œç”Ÿæˆåˆé€‚çš„å›¾~~<br>æ¯”å¦‚è¿™æ ·ã€‚ã€‚ã€‚ã€‚requests.getçš„<br><img src="https://ficapy.b0.upaiyun.com/blogimg/requests_get.png" alt="requests_get"><br>æ³¨æ„åˆ°è¿™é‡Œæœ‰ç»„(æ ¹æ®å•ä¸ªæ¨¡å—åˆ†)ï¼Œå®ç°çš„æ–¹å¼ä¹Ÿå¾ˆç®€å•ã€‚å¯ä»¥æŸ¥çœ‹æˆ‘å†™çš„ç²¾ç®€ç‰ˆçš„pycallgraph.<a href="https://gist.github.com/ficapy/a2601d44b1492c228732178e1bb3eb5e">https://gist.github.com/ficapy/a2601d44b1492c228732178e1bb3eb5e</a></li>
</ol>
<h3 id="å¤šçº¿ç¨‹ç‰ˆ"><a href="#å¤šçº¿ç¨‹ç‰ˆ" class="headerlink" title="å¤šçº¿ç¨‹ç‰ˆ"></a>å¤šçº¿ç¨‹ç‰ˆ</h3><p>å› ä¸ºç›®å‰æ²¡æœ‰ç”¨æ¥åˆ†æå¤šçº¿ç¨‹ç¨‹åºï¼Œæ‰€ä»¥åªæ˜¯å¤§æ¦‚äº†è§£äº†ä¸€ä¸‹ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trace</span><span class="params">(frame, event, args,record=[])</span>:</span></span><br><span class="line">    <span class="keyword">if</span> event == <span class="string">'call'</span>:</span><br><span class="line">        record.append(frame)</span><br><span class="line">    <span class="keyword">elif</span> event == <span class="string">'return'</span>:</span><br><span class="line">        pre_frame = record.pop()</span><br><span class="line">        print(pre_frame <span class="keyword">is</span> frame)</span><br><span class="line">    <span class="keyword">return</span> trace</span><br><span class="line">threading.settrace(trace)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    time.sleep(random.random())</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">    threading.Thread(target=main).start()</span><br><span class="line"></span><br><span class="line"><span class="comment"># False</span></span><br><span class="line"><span class="comment"># False</span></span><br><span class="line"><span class="comment"># False</span></span><br><span class="line"><span class="comment"># False</span></span><br><span class="line"><span class="comment"># True</span></span><br><span class="line"><span class="comment"># True</span></span><br><span class="line"><span class="comment"># True</span></span><br><span class="line"><span class="comment"># False</span></span><br><span class="line"><span class="comment"># False</span></span><br><span class="line"><span class="comment"># False</span></span><br><span class="line"><span class="comment"># False</span></span><br></pre></td></tr></table></figure><br>å¯ä»¥çœ‹åˆ°ç¨æœ‰åŒºåˆ«ï¼Œå› ä¸ºå®ƒæœ‰å¤šä¸ªæ ˆï¼Œæ‰€ä»¥æ— æ³•åƒå•ä¸ªé‚£æ ·ç”¨ä¸€ä¸ªåˆ—è¡¨å°±æ·»åŠ ã€å–å‡ºå°±èƒ½æå®šã€‚å¯èƒ½ä»¥åæœ‰éœ€è¦æˆ‘ä¼šæ·»åŠ ä¸Šçº¿ç¨‹æ”¯æŒ</p>
<h3 id="pycallgraphç¼ºé™·"><a href="#pycallgraphç¼ºé™·" class="headerlink" title="pycallgraphç¼ºé™·"></a>pycallgraphç¼ºé™·</h3><ol>
<li>æ›´æ–°ç¼“æ…¢ï¼Œmasterç‰ˆæœ¬æ˜¯3å¹´å‰çš„ï¼æ–‡æ¡£ä¹Ÿæ˜¯</li>
<li>è®¾ç½®é¡¹æœ‰threaded.æçš„æ˜¯çº¿ç¨‹å®‰å…¨ï¼sys.settraceåœ¨ä¸»çº¿ç¨‹æ˜¯æ²¡æœ‰çº¿ç¨‹é—®é¢˜ã€‚æˆ‘éƒ½æ²¡æœ‰æƒ³æ˜ç™½å†™çº¿ç¨‹è¿™æ®µæ˜¯å¹²å•¥å­ç”¨çš„</li>
<li>æ²¡æœ‰çªå‡ºè¿‡æ»¤çš„é‡è¦æ€§</li>
</ol>
<h3 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h3><p><a href="https://docs.python.org/3/library/sys.html#sys.settrace">å®˜ç½‘sys.settrace</a><br><a href="http://tech.uc.cn/?p=1932">pythonç¨‹åºçš„æ‰§è¡ŒåŸç†</a><br><a href="https://www.youtube.com/watch?v=YIhGbFW985c">PYCON-Dmitry Trofimov - Python Debugger Uncovered</a><br><a href="http://stackoverflow.com/questions/1156023/print-current-call-stack-from-a-method-in-python-code">Print current call stack from a method in Python code</a><br><a href="https://segmentfault.com/a/1190000000356018">å¸¸ç”¨çš„pythonè°ƒè¯•å·¥å…·</a><br><a href="http://www.jianshu.com/p/e44885a777f0">graphviz dotè¯­è¨€å­¦ä¹ ç¬”è®°</a><br><a href="https://github.com/ionelmc/python-hunter">Github_python-hunter</a><br><a href="https://github.com/alonho/pytrace">Github_pytrace</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç”¨æ¥ç”Ÿæˆå‡½æ•°è°ƒç”¨å›¾ï¼Œè¿™ä¸ªå·¥å…·å¯èƒ½åæ°”æ¯”è¾ƒå¤§ã€‚å› ä¸ºçœ‹ä»‹ç»å°±èƒ½çœ‹åˆ°å¥½åƒå¯ä»¥ç”Ÿæˆæ¯”è¾ƒå¸…æ°”çš„å›¾åƒã€‚ä»æºç å±‚é¢çœ‹ã€‚å…¶å®è¿™ä¸ªå·¥å…·æ˜¯ç›¸å½“ç®€å•çš„ï¼Œå°±æ˜¯ä½¿ç”¨äº†sys.settraceæ¥å£,è¯¥æ¥å£å¸¸ç”¨äºdebugã€profile(æœ¬æ–‡ç¯å¢ƒpython3.5.1)ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æºç è§£æ" scheme="https://www.zoulei.net/categories/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
    
      <category term="python" scheme="https://www.zoulei.net/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>pyenvä½¿ç”¨é•œåƒåŠ é€Ÿ</title>
    <link href="https://www.zoulei.net/2016/07/15/pyenv_use_mirror/"/>
    <id>https://www.zoulei.net/2016/07/15/pyenv_use_mirror/</id>
    <published>2016-07-15T00:57:02.000Z</published>
    <updated>2016-07-15T01:42:56.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä½¿ç”¨<code>pyenv install 3.5.0</code>çš„æ—¶å€™ç›´æ¥å»python.orgå®˜ç½‘ä¸‹è½½æºç è¿›è¡Œç¼–è¯‘ã€‚é€Ÿåº¦å‡ kbæ¯ç§’æ…¢åˆ°æ— æ³•è‡ªç†ã€‚æ— å¥ˆç”¨ä»£ç†é€Ÿåº¦ä¹Ÿä¸æ€ä¹ˆæ ·ã€‚å†å…¶æ¬¡è¯¥é¡¹ç›®çš„ä½œè€…æ˜¯è‡ªå·±å†™äº†ä¸€ä¸ª<a href="https://github.com/yyuu/yyuu.github.com">pyenvé•œåƒé¡¹ç›®</a>çš„ï¼Œåªå¯æƒœæ›´æ–°é¢‘ç‡è¿œä¸å¦‚pyenvã€‚å¯¼è‡´å®‰è£…ä¸€äº›æ–°çš„ç‰ˆæœ¬æ— æ³•ä½¿ç”¨å…¬å…±ä»£ç†</p>
<p>å¦‚æœå®‰è£…2.7.6ä½ å¯ä»¥é€‰æ‹©ä½¿ç”¨å›½å†…ä¸ƒç‰›çš„é•œåƒã€‚é¡¹ç›®åœ°å€<a href="http://pyenv.qiniudn.com/pythons/">http://pyenv.qiniudn.com/pythons/</a>ã€‚æ‰§è¡Œ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PYTHON_BUILD_MIRROR_URL=&#34;http://pyenv.qiniudn.com/pythons/&#34;&#10;pyenv install 2.7.6</span><br></pre></td></tr></table></figure></p>
<p>å°±ä¼šä½¿ç”¨ä¸ƒç‰›é•œåƒè¿›è¡Œä¸‹è½½é€Ÿåº¦éå¸¸å¿«ã€‚<br>ç¼ºç‚¹å°±æ˜¯é™¤äº†ç½‘é¡µä¸Šçš„ä¸€äº›ç‰ˆæœ¬ã€‚å…¶ä»–çš„éƒ½ä¸æ”¯æŒäº†ã€‚ä¸ƒç‰›æ²¡æœ‰å¯¹è¿™ä¸ªé¡¹ç›®è¿›è¡Œæ›´æ–°</p>
<p>æˆ‘ä»¬å¯ä»¥ç”¨è¿…é›·æˆ–è€…å…¶ä»–å¯ç”¨çš„å¿«é€Ÿçš„æ–¹æ³•æŠŠpythonæºç ä¸‹è½½åˆ°æœ¬åœ°ã€‚è‡ªå·±å¼€å¯ä¸€ä¸ªé•œåƒç»™è‡ªå·±ç”¨ã€‚è¿™æ ·å°±å¥½äº†ã€‚æ¯”å¦‚æ‰§è¡Œ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ficapy@L ~&#62; pyenv install 3.5.0                                                                                                                                                                           &#10;Downloading Python-3.5.0.tgz...&#10;-&#62; https://www.python.org/ftp/python/3.5.0/Python-3.5.0.tgz</span><br></pre></td></tr></table></figure></p>
<p>ç„¶åæŠŠ<code>https://www.python.org/ftp/python/3.5.0/Python-3.5.0.tgz</code>ä¸‹è½½åˆ°æœ¬åœ°ã€‚<br>å†è®¾ç½®é•œåƒåœ°å€<code>export PYTHON_BUILD_MIRROR_URL=&quot;http://127.0.0.1:8000/&quot;</code><br>åˆ°ä¸‹è½½åœ°å€æ‰§è¡Œ<code>python3 -m http.server</code><br>å†æ¬¡æ‰§è¡Œ<code>pyenv install 3.5.0</code>å‘ç°è¿˜æ˜¯ä»å®˜ç½‘ä¸‹è½½ã€‚ä¸è¿‡æ­¤æ—¶æŸ¥çœ‹http.serverä¸Šæœ‰ä¸€æ¡HEADè¯·æ±‚æ—¥å¿—ã€‚-_-å‘ç°ä¸æ˜¯ç›´æ¥è¯·é—®çš„æ–‡ä»¶åï¼Œè€Œæ˜¯ä¸€ä¸ª64ä½çš„å­—ç¬¦ã€‚å°†ä¸‹è½½çš„æ–‡ä»¶åä¿®æ”¹æˆé‚£64ä½å­—ç¬¦ã€‚åœ¨æ‰§è¡Œå°±okäº†~~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä½¿ç”¨&lt;code&gt;pyenv install 3.5.0&lt;/code&gt;çš„æ—¶å€™ç›´æ¥å»python.orgå®˜ç½‘ä¸‹è½½æºç è¿›è¡Œç¼–è¯‘ã€‚é€Ÿåº¦å‡ kbæ¯ç§’æ…¢åˆ°æ— æ³•è‡ªç†ã€‚æ— å¥ˆç”¨ä»£ç†é€Ÿåº¦ä¹Ÿä¸æ€ä¹ˆæ ·ã€‚å†å…¶æ¬¡è¯¥é¡¹ç›®çš„ä½œè€…æ˜¯è‡ªå·±å†™äº†ä¸€ä¸ª&lt;a href=&quot;https://github.com/yyuu/
    
    </summary>
    
    
      <category term="python" scheme="https://www.zoulei.net/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>pythonæè¿°ç¬¦åº”ç”¨</title>
    <link href="https://www.zoulei.net/2016/07/10/python_descriptor/"/>
    <id>https://www.zoulei.net/2016/07/10/python_descriptor/</id>
    <published>2016-07-10T09:13:43.000Z</published>
    <updated>2016-08-02T03:40:42.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸ªäººè®¤ä¸ºpythonä¸­æè¿°ç¬¦åè®®æ˜¯ä¸€ä¸ªæ¯”è¾ƒç¥å¥‡çš„å­˜åœ¨ï¼Œæ˜¯å› ä¸ºå¦‚æœä½ ä¸å»äº†è§£propertyçš„å†…éƒ¨å®ç°ï¼Œæ²¡æœ‰æ·±ç©¶åˆ«äººå†™çš„__set__ã€__get__æ–¹æ³•ã€‚æˆ–è®¸å†™pythonå¾ˆå¤šå¹´éƒ½å¯¹è¿™ä¸ªä¸œè¥¿æ²¡ä»€ä¹ˆäº†è§£ã€‚ç„¶è€Œè¿™ç©æ„å„¿æœ‰æ—¶å€™çœŸçš„æŒºå¥½ç”¨çš„ã€‚æœ¬æ–‡ä¸ä¼šè¯¦è¿°æè¿°ç¬¦åè®®ã€‚ä¼šç€é‡è®²ä¸€ä¸ªå°ä¾‹å­ã€‚å¦‚æœä»¥å‰æ²¡æœ‰æ¥è§¦è¿‡æè¿°ç¬¦ï¼Œè¯·ä¾æ¬¡æŸ¥çœ‹æ–‡æœ«ç›¸å…³èµ„æ–™çš„ä¸¤ç¯‡æ–‡ç« </p>
<a id="more"></a>
<h3 id="é€‚ç”¨èŒƒå›´"><a href="#é€‚ç”¨èŒƒå›´" class="headerlink" title="é€‚ç”¨èŒƒå›´"></a>é€‚ç”¨èŒƒå›´</h3><p>æè¿°ç¬¦åè®®éƒ½æ˜¯é’ˆå¯¹å¯¹è±¡å±æ€§çš„è®¿é—®ã€‚å…ˆè¦æ˜ç™½æˆ‘ä»¬ä¸ä¼šå»é’ˆå¯¹ä¸€ä¸ªå…¨å±€çš„defä½¿ç”¨propertyè¿›è¡Œè£…é¥°ã€‚æˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯åœ¨ç±»é‡Œé¢ä½¿ç”¨ã€‚å¯ä»¥å¯¹ç±»çš„è®¿é—®ä½¿ç”¨æè¿°ç¬¦(æ¯”è¾ƒå°‘ç”¨)ï¼Œæ›´å¸¸ç”¨çš„æ˜¯é’ˆå¯¹ç±»å®ä¾‹çš„è®¿é—®ä½¿ç”¨æè¿°ç¬¦åè®®</p>
<h3 id="èµ„æ–™æè¿°ç¬¦å’Œéèµ„æ–™æè¿°ç¬¦çš„åŒºåˆ«"><a href="#èµ„æ–™æè¿°ç¬¦å’Œéèµ„æ–™æè¿°ç¬¦çš„åŒºåˆ«" class="headerlink" title="èµ„æ–™æè¿°ç¬¦å’Œéèµ„æ–™æè¿°ç¬¦çš„åŒºåˆ«"></a>èµ„æ–™æè¿°ç¬¦å’Œéèµ„æ–™æè¿°ç¬¦çš„åŒºåˆ«</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RevealAccess</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, obj, objtype)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self.val</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># def __set__(self, obj, val):</span></span><br><span class="line">    <span class="comment">#     self.val = val</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span><span class="params">(object)</span>:</span></span><br><span class="line">    x = RevealAccess()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">m = MyClass()</span><br><span class="line">print(m.x)</span><br><span class="line">m.x = <span class="number">20</span></span><br><span class="line">print(m.__dict__)</span><br><span class="line">m.__dict__[<span class="string">'x'</span>] = <span class="number">1</span></span><br><span class="line">print(m.__dict__)</span><br><span class="line">print(m.x)</span><br><span class="line">print(m.__class__ <span class="keyword">is</span> type(m))</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆï¼Œå½“å¯¹å±æ€§xè¿›è¡Œè®¿é—®çš„æ—¶å€™ä¸æ˜¯ç›´æ¥è¿”å›æè¿°ç¬¦å¯¹è±¡ï¼Œè€Œæ˜¯æŒ‰ç…§æè¿°ç¬¦è§„åˆ™æ‰§è¡Œäº†æè¿°ç¬¦å¯¹è±¡çš„__get__ç­‰æ–¹æ³•ï¼èµ„æ–™æè¿°ç¬¦å°±æ˜¯åŒæ—¶å®ç°äº†__get__å’Œ__set__ï¼ŒåŒºåˆ«å°±æ˜¯æ˜¯èµ„æ–™æè¿°ç¬¦çš„æ—¶å€™å°±æŒ‰ç…§èµ„æ–™æè¿°ç¬¦çš„__get__ã€__set__æ¥ã€‚éèµ„æ–™æè¿°ç¬¦çš„æ—¶å€™é‚£å°±å…ˆè®¿é—®<code>instance.__dict__[&#39;x&#39;]</code>ï¼Œæ²¡æœ‰å°±åœ¨æŒ‰ç…§éèµ„æ–™æè¿°ç¬¦çš„__get__æ¥ã€‚ä¸Šé¢çš„ä¾‹å­å…ˆæ³¨é‡Šæ‰__set__å°±æ˜¯éèµ„æ–™æè¿°ç¬¦ï¼Œå¯¹å®ä¾‹å±æ€§è¿›è¡Œè®¿é—®çš„æ—¶å€™å…ˆè®¿é—®äº†instance.__dict__æ²¡æœ‰å°±ä½¿ç”¨äº†æè¿°ç¬¦å¯¹è±¡çš„__get__æ–¹æ³•ã€‚å½“ä¸ºèµ„æ–™æè¿°ç¬¦çš„æ—¶å€™çºµç„¶å¯¹instance.__dict__è®¾ç½®äº†ã€‚ä¾ç„¶ä¼šè°ƒç”¨æè¿°ç¬¦å¯¹è±¡ã€‚</p>
<h3 id="ç¤ºä¾‹åº”ç”¨-propertyåŠ å¼ºç‰ˆï¼Œå¢åŠ ç¼“å­˜-æœ€ç®€ä»£ç "><a href="#ç¤ºä¾‹åº”ç”¨-propertyåŠ å¼ºç‰ˆï¼Œå¢åŠ ç¼“å­˜-æœ€ç®€ä»£ç " class="headerlink" title="ç¤ºä¾‹åº”ç”¨:propertyåŠ å¼ºç‰ˆï¼Œå¢åŠ ç¼“å­˜(æœ€ç®€ä»£ç )"></a>ç¤ºä¾‹åº”ç”¨:propertyåŠ å¼ºç‰ˆï¼Œå¢åŠ ç¼“å­˜(æœ€ç®€ä»£ç )</h3><p>é¦–å…ˆæ¥ä¸€ä¸ªä¾‹å­<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span><span class="params">(object)</span>:</span></span><br><span class="line"><span class="decorator">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">jammy</span><span class="params">(self,_cache=&#123;&#125;)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'result'</span> <span class="keyword">in</span> _cache:</span><br><span class="line">            <span class="keyword">return</span> _cache[<span class="string">'result'</span>]</span><br><span class="line">        print(<span class="string">'jammy called'</span>)</span><br><span class="line">        result = <span class="number">1</span></span><br><span class="line">        _cache.update(&#123;<span class="string">'result'</span>:result&#125;)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">f = Foo()</span><br><span class="line">print(f.jammy)</span><br><span class="line">print(f.jammy)</span><br></pre></td></tr></table></figure><br>è¯¥æ–¹æ³•ä½¿ç”¨pythonå‡½æ•°çš„é»˜è®¤å‚æ•°åªåˆå§‹åŒ–ä¸€æ¬¡å¯¹ç»“æœè¿›è¡Œç¼“å­˜ã€‚ç¼ºç‚¹æ¯”è¾ƒæ˜æ˜¾ã€‚1.æ— æ³•å¤ç”¨ã€‚2.å¯¹åŸå‡½æ•°è¿›è¡Œäº†ä¿®æ”¹</p>
<p>ä¸‹é¢çœ‹pyramidçš„å®ç°<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">reify</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, func)</span>:</span></span><br><span class="line">        self.func = func</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, obj, cls)</span>:</span></span><br><span class="line">        value = obj.__dict__[self.func.__name__] = self.func(obj)</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span><span class="params">(object)</span>:</span></span><br><span class="line"><span class="decorator">    @reify</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">jammy</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'jammy called'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">f = Foo()</span><br><span class="line">print(f.jammy)</span><br><span class="line">print(f.jammy)</span><br></pre></td></tr></table></figure><br>ä½¿ç”¨çš„æ˜¯éèµ„æ–™æè¿°ç¬¦ï¼Œç¬¬ä¸€æ¬¡å¯¹å±æ€§è¿›è¡Œè®¿é—®çš„æ—¶å€™ï¼Œå› ä¸ºf.__dict__æ˜¯æ²¡æœ‰jammyçš„ã€‚æ•…è€Œè®¿é—®äº†æè¿°ç¬¦ï¼Œåœ¨æè¿°ç¬¦__get__é‡Œé¢å°†ç»“æœåŠ å…¥åˆ°äº†f.__dict__é‡Œé¢ã€‚åé¢è®¿é—®å°±æ²¡__get__ä»€ä¹ˆäº‹å„¿äº†ã€‚å®ç°äº†å¯¹ç»“æœçš„ç¼“å­˜</p>
<p>å†çœ‹werkzeugçš„å®ç°<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cached_property</span><span class="params">(property)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, func, name=None, doc=None)</span>:</span></span><br><span class="line">        self.__name__ = func.__name__</span><br><span class="line">        self.func = func</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, obj, value)</span>:</span></span><br><span class="line">        obj.__dict__[self.__name__] = value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, obj, type=None)</span>:</span></span><br><span class="line">        value = obj.__dict__.get(self.__name__)</span><br><span class="line">        <span class="keyword">if</span> value <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            value = self.func(obj)</span><br><span class="line">            obj.__dict__[self.__name__] = value</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span><span class="params">(object)</span>:</span></span><br><span class="line"><span class="decorator">    @cached_property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">jammy</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'jammy called'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">f = Foo()</span><br><span class="line">print(f.jammy)</span><br><span class="line">print(f.jammy)</span><br></pre></td></tr></table></figure><br>å¯ä»¥çœ‹åˆ°å’Œèµ„æ–™æè¿°ç¬¦çš„åŸºæœ¬ä¸€æ ·ã€‚å¯ä»¥çœ‹åˆ°__set__åŸºæœ¬æ²¡ä»€ä¹ˆç”¨ï¼Œä»…ä»…åªæ˜¯è¡¨é¢äº†è¿™æ˜¯ä¸€ä¸ªèµ„æ–™æè¿°ç¬¦ã€‚è€Œä¸”åŒæ ·çš„ï¼Œä¸ºäº†æ–¹ä¾¿ä¹Ÿä¸€æ ·æŠŠç»“æœå­˜å‚¨åˆ°äº†f.__dict__é‡Œé¢</p>
<h3 id="getattr-ã€-getattribute"><a href="#getattr-ã€-getattribute" class="headerlink" title="__getattr__ã€__getattribute__"></a>__getattr__ã€__getattribute__</h3><p>è™½ç„¶éƒ½æœ‰getï¼Œå¯æ˜¯åŒºåˆ«æ˜¯å¾ˆå¤§çš„ã€‚<br>æè¿°ç¬¦æ˜¯<code>æ§åˆ¶å¯¹è±¡æŸä¸ªå±æ€§çš„è®¿é—®</code>(æ‰€ä»¥çœ‹åˆ°æè¿°ç¬¦å¯¹è±¡ä¸€èˆ¬ä¸»è¦ç”¨<code>__get__</code>ï¼Œ<code>__get__</code>)ã€‚<br><code>__getattr__</code>å®ƒ<code>æ§åˆ¶å±æ€§ä¸å­˜åœ¨çš„æ—¶å€™è¯¥å’‹åŠ</code><br><code>__getattribute__</code>å’Œä¸Šé¢ç›¸åï¼Œé»˜è®¤è¡Œä¸ºï¼Œä»__dict__ä¸­æ‰¾åˆ°å±æ€§å€¼è¿”å›<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, attr)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"looking up"</span>, attr</span><br><span class="line">        value = <span class="number">42</span></span><br><span class="line">        self.__dict__[attr] = value</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line">f = Foo()</span><br><span class="line"><span class="keyword">print</span> f.x </span><br><span class="line"><span class="keyword">print</span> f.x</span><br><span class="line"><span class="comment">#output &gt;&gt;&gt; looking up x 42</span></span><br><span class="line"><span class="comment">#output &gt;&gt;&gt; 42</span></span><br><span class="line"></span><br><span class="line">f.x = <span class="number">3</span></span><br><span class="line"><span class="keyword">print</span> f.x </span><br><span class="line"><span class="comment">#output &gt;&gt;&gt; 3</span></span><br></pre></td></tr></table></figure></p>
<p>å†åŠ ä¸€ä¸ªç±»ä¼¼çš„ä¾‹å­å§O_o(<a href="https://github.com/faif/python-patterns/blob/master/lazy_evaluation.py">https://github.com/faif/python-patterns/blob/master/lazy_evaluation.py</a>)</p>
<h3 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h3><p><a href="https://harveyqing.gitbooks.io/python-read-and-write/content/python_advance/python_descriptor.html">pythonå®˜æ–¹æ–‡æ¡£æè¿°ç¬¦æŒ‡å—(è¯‘)</a><br><a href="http://www.geekfan.net/7862/">pythonæè¿°ç¬¦è§£å¯†</a><br><a href="http://stackoverflow.com/questions/3278077/difference-between-getattr-vs-getattribute">Difference between __getattr__ vs __getattribute__</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸ªäººè®¤ä¸ºpythonä¸­æè¿°ç¬¦åè®®æ˜¯ä¸€ä¸ªæ¯”è¾ƒç¥å¥‡çš„å­˜åœ¨ï¼Œæ˜¯å› ä¸ºå¦‚æœä½ ä¸å»äº†è§£propertyçš„å†…éƒ¨å®ç°ï¼Œæ²¡æœ‰æ·±ç©¶åˆ«äººå†™çš„__set__ã€__get__æ–¹æ³•ã€‚æˆ–è®¸å†™pythonå¾ˆå¤šå¹´éƒ½å¯¹è¿™ä¸ªä¸œè¥¿æ²¡ä»€ä¹ˆäº†è§£ã€‚ç„¶è€Œè¿™ç©æ„å„¿æœ‰æ—¶å€™çœŸçš„æŒºå¥½ç”¨çš„ã€‚æœ¬æ–‡ä¸ä¼šè¯¦è¿°æè¿°ç¬¦åè®®ã€‚ä¼šç€é‡è®²ä¸€ä¸ªå°ä¾‹å­ã€‚å¦‚æœä»¥å‰æ²¡æœ‰æ¥è§¦è¿‡æè¿°ç¬¦ï¼Œè¯·ä¾æ¬¡æŸ¥çœ‹æ–‡æœ«ç›¸å…³èµ„æ–™çš„ä¸¤ç¯‡æ–‡ç« &lt;/p&gt;
    
    </summary>
    
    
      <category term="python" scheme="https://www.zoulei.net/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>wsgirefæºç é˜…è¯»</title>
    <link href="https://www.zoulei.net/2016/07/04/2016-07-04/"/>
    <id>https://www.zoulei.net/2016/07/04/2016-07-04/</id>
    <published>2016-07-04T09:32:07.000Z</published>
    <updated>2016-07-04T09:38:55.000Z</updated>
    
    <content type="html"><![CDATA[<pre><code> _ _ _ ____ ____ _ ____ ____ ____    _ _  _ _  _ ____ ____ _ ___
 | | | [__  | __ | |__/ |___ |___    | |\ | |__| |___ |__/ |  |
 |_|_| ___] |__] | |  \ |___ |       | | \| |  | |___ |  \ |  |
+--------------------------+     +---------------------------------+
|    wsgiref.WSGIServer    |     |   wsgiref.WSGIRequestHandler    |
+--------------------------+     +---------------------------------+
              |
+-------------v------------+    +------------------------------------+
|  http.server.HTTPServer  |    | http.server.BaseHTTPRequestHandler |
+--------------------------+    +------------------------------------+

+--------------------------+    +------------------------------------+
|  socketserver.TCPServer  |    | socketserver.StreamRequestHandler  |
+--------------------------+    +------------------------------------+
                                        overload handle logic

Created with Monodraw
</code></pre><h2 id="dd"><a href="#dd" class="headerlink" title="dd"></a>dd</h2>]]></content>
    
    <summary type="html">
    
      &lt;pre&gt;&lt;code&gt; _ _ _ ____ ____ _ ____ ____ ____    _ _  _ _  _ ____ ____ _ ___
 | | | [__  | __ | |__/ |___ |___    | |\ | |__| |___ |__/ |  |

    
    </summary>
    
      <category term="æºç è§£æ" scheme="https://www.zoulei.net/categories/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
    
  </entry>
  
  <entry>
    <title>http.serveræºç é˜…è¯»</title>
    <link href="https://www.zoulei.net/2016/07/02/http_server_note/"/>
    <id>https://www.zoulei.net/2016/07/02/http_server_note/</id>
    <published>2016-07-02T09:07:20.000Z</published>
    <updated>2016-07-02T10:19:40.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸Šä¸€ç« è®²SocketServeræ¨¡å—ï¼Œå®ƒå°†æœåŠ¡ç«¯æ ¹æ®ç›‘å¬å¥—æ¥å­—å’Œè¿æ¥å¥—æ¥å­—åˆ†ä¸ºäº†2ä¸ªéƒ¨åˆ†(BaseServer/BaseRequestHandler)ï¼Œè€Œè¿æ¥å¥—æ¥å­—ç±»çš„å¤„ç†æ–¹æ³•ç›¸å½“ç®€å•ï¼Œæœ€ç»ˆæ˜¯ä¸€ä¸ªhandleå‡½æ•°å°±æå®šäº†ã€‚http.serverè¿™ä¸ªæ¨¡å—ä¸»è¦ç±»BaseHTTPRequestHandleç»§æ‰¿è‡ªBaseRequestHandle,å¯¹handleè¿›è¡Œäº†ä¸€ç‚¹ç‚¹çš„åŠ å¼ºï¼Œä¸»è¦å°±æ˜¯å¯¹httpåè®®è¿›è¡Œäº†ç®€å•çš„è§£æå·¥ä½œ(æºç ç‰ˆæœ¬Python3.5)</p>
<a id="more"></a>
<p>å…ˆä¸Šå›¾ä¸ºæ•¬:D<br><img src="https://ficapy.b0.upaiyun.com/blogimg/httpserver_note.png" alt=""><br>è¿™ä¸ªæ¨¡å—åªéœ€è¦å…³å¿ƒBaseHTTPRequestHandlerç±»ï¼Œå…¶å®é‡Œé¢è¿˜æœ‰ä¸ªCGIå¤„ç†ç±»ï¼Œä¸è¿‡è¿™ç©æ„å„¿ä¼°è®¡ä¹Ÿæ˜¯ä¸Šå¤ç¥å…½äº†ã€‚æ²¡å…³æ³¨çš„å¿…è¦ã€‚</p>
<h3 id="ä»£ç è§£è¯»"><a href="#ä»£ç è§£è¯»" class="headerlink" title="ä»£ç è§£è¯»"></a>ä»£ç è§£è¯»</h3><ol>
<li>æ”¯æŒhttpç‰ˆæœ¬0.9ã€1.0ã€1.1ï¼ŒåŒºåˆ«å°±æ˜¯0.9ç‰ˆæœ¬åªæœ‰bodyã€‚1.1ç‰ˆæœ¬æ˜¾å¼æ”¯æŒkeep-aliveã€‚ä¸ºäº†æ”¯æŒkeep-aliveï¼Œä»£ç ä¸­æœ‰å¤šå¤„å¤„ç†é€»è¾‘</li>
<li>å¯¹äºå†…å®¹çš„è§£æä¸»è¦æ˜¯ä½¿ç”¨parse_requestæ–¹æ³•ã€‚è¯¥æ–¹æ³•é€»è¾‘ä¸»è¦è§£æç¬¬ä¸€è¡Œrequest lineã€‚å¦‚æœå‡ºé”™å°±ç›´æ¥è°ƒç”¨send_errorè¿”å›é”™è¯¯å†…å®¹ã€‚headeréƒ¨åˆ†ä¸»è¦å¼•å…¥äº†email.parser.Parserè¿›è¡Œè§£æ</li>
<li>parser_requestå¯¹<code>Except:100-continue</code>è¿›è¡Œäº†ç‰¹æ®Šå¤„ç†ï¼Œè§é™„å½•</li>
<li>è¿”å›status lineå’Œheaderæ˜¯å…ˆä½¿ç”¨send_response_onlyåˆ›å»ºä¸€ä¸ªåˆ—è¡¨ï¼Œç„¶åè°ƒç”¨send_headerä¾æ¬¡åœ¨åˆ—è¡¨ä¸­æ·»åŠ æ•°æ®ï¼Œæœ€åè°ƒç”¨end_headerså‘é€æ•°æ®</li>
<li><code>send_errorå‡½æ•°å°±æ˜¯ä¸€ä¸ªå›å¤çš„å…¸èŒƒ</code></li>
<li>å‰©ä¸‹å°±æ˜¯æ—¥å¿—å‡½æ•°å’Œå‡ ä¸ªè¾…åŠ©å‡½æ•°äº†</li>
</ol>
<h3 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> http.server <span class="keyword">import</span> BaseHTTPRequestHandler</span><br><span class="line"><span class="keyword">from</span> socketserver <span class="keyword">import</span> ThreadingTCPServer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handle</span><span class="params">(BaseHTTPRequestHandler)</span>:</span></span><br><span class="line">    protocol_version = <span class="string">"HTTP/1.1"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_GET</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.send_error(<span class="number">500</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_POST</span><span class="params">(self)</span>:</span></span><br><span class="line">        len = self.headers.get(<span class="string">'Content-Length'</span>)</span><br><span class="line">        data = self.rfile.read(int(len))</span><br><span class="line"></span><br><span class="line">        self.send_response(<span class="number">200</span>)</span><br><span class="line">        self.send_header(<span class="string">'Content-Length'</span>, len)</span><br><span class="line">        self.end_headers()</span><br><span class="line">        self.wfile.write(data)</span><br><span class="line"></span><br><span class="line">ThreadingTCPServer((<span class="string">''</span>, <span class="number">9999</span>), Handle).serve_forever()</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯ä¸€ä¸ªæœ€ç®€çš„http serverã€‚do_GETå‡½æ•°è¡¨é¢send_errorå°±èƒ½å¤Ÿå“åº”ä¸€ä¸ªè¯·æ±‚ã€‚do_POSTå‡½æ•°å‚ç…§send_errorçš„é€»è¾‘åªä¸è¿‡è¯»å–äº†å®¢æˆ·ç«¯å‘é€çš„bodyå­—æ®µ</p>
<h3 id="å°çŸ¥è¯†"><a href="#å°çŸ¥è¯†" class="headerlink" title="å°çŸ¥è¯†"></a>å°çŸ¥è¯†</h3><h6 id="ç±»å˜é‡å’Œå®ä¾‹å˜é‡"><a href="#ç±»å˜é‡å’Œå®ä¾‹å˜é‡" class="headerlink" title="ç±»å˜é‡å’Œå®ä¾‹å˜é‡"></a>ç±»å˜é‡å’Œå®ä¾‹å˜é‡</h6><p>è¿™2ä¸ªéå¸¸ç›¸è¿‘ï¼Œå…·ä½“åŒºåˆ«æˆ‘å°±ä¸æ¦‚è¿°äº†ã€‚åœ¨å†™ä»£ç çš„æ—¶å€™å¾ˆå¤šäººæ— è„‘self.xxx = xxxå°±æäº†ä¸€ä¸ªå®ä¾‹å˜é‡ã€‚å¤§å¤šæ•°æ—¶å€™ç”¨å®ä¾‹å˜é‡éƒ½èƒ½å¤Ÿæ›¿ä»£ç±»å˜é‡çš„åŠŸèƒ½ã€‚è¿™å¾ˆå®¹æ˜“è®©äººå¿½ç•¥ç±»å˜é‡çš„ä¼˜ç‚¹ã€‚â‘ å«ä¹‰æ˜ç¡®ï¼šè¿™æ˜¯è¿™ä¸ªç±»çš„æ‰€æœ‰å®ä¾‹å…±ç”¨çš„ã€‚â‘¡ä¸éœ€è¦é‡è½½<strong>init</strong>ï¼Œè¿™åœ¨ç»§æ‰¿çš„æ—¶å€™æ˜¯å¾ˆæœ‰ç”¨å“’~~~ï¼Œsoï¼Œä¸è¦æœ‰äº‹æ²¡äº‹æ— è„‘åœ¨<strong>init</strong>é‡Œé¢self.xxx = xxxå•¦</p>
<h3 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h3><p><a href="http://www.laruence.com/2011/01/20/1840.html">Expect:100-continue</a><br><a href="https://docs.python.org/3.6/library/http.server.html?highlight=http.server#http.server.BaseHTTPRequestHandler">å®˜æ–¹æ–‡æ¡£</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸Šä¸€ç« è®²SocketServeræ¨¡å—ï¼Œå®ƒå°†æœåŠ¡ç«¯æ ¹æ®ç›‘å¬å¥—æ¥å­—å’Œè¿æ¥å¥—æ¥å­—åˆ†ä¸ºäº†2ä¸ªéƒ¨åˆ†(BaseServer/BaseRequestHandler)ï¼Œè€Œè¿æ¥å¥—æ¥å­—ç±»çš„å¤„ç†æ–¹æ³•ç›¸å½“ç®€å•ï¼Œæœ€ç»ˆæ˜¯ä¸€ä¸ªhandleå‡½æ•°å°±æå®šäº†ã€‚http.serverè¿™ä¸ªæ¨¡å—ä¸»è¦ç±»BaseHTTPRequestHandleç»§æ‰¿è‡ªBaseRequestHandle,å¯¹handleè¿›è¡Œäº†ä¸€ç‚¹ç‚¹çš„åŠ å¼ºï¼Œä¸»è¦å°±æ˜¯å¯¹httpåè®®è¿›è¡Œäº†ç®€å•çš„è§£æå·¥ä½œ(æºç ç‰ˆæœ¬Python3.5)&lt;/p&gt;
    
    </summary>
    
      <category term="æºç è§£æ" scheme="https://www.zoulei.net/categories/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
    
  </entry>
  
  <entry>
    <title>SocketServeræºç é˜…è¯»</title>
    <link href="https://www.zoulei.net/2016/06/29/socketserver_note/"/>
    <id>https://www.zoulei.net/2016/06/29/socketserver_note/</id>
    <published>2016-06-29T03:53:14.000Z</published>
    <updated>2016-07-02T10:24:36.000Z</updated>
    
    <content type="html"><![CDATA[<p>SocketServer.pyè¿™ä¸ªæ–‡ä»¶700æ¥è¡Œï¼Œé™¤å»æ³¨é‡Šå¤§æ¦‚300æ¥è¡Œå·¦å³ï¼Œæ®ç½‘å‹ç§°è¯¥æ¨¡å—å®ä¹ƒå­¦ä¹ ç±»ç»§æ‰¿ä¹‹å…¸èŒƒã€‚<br>è¦ç†è§£è¿™ä¸ªæ¨¡å—çœŸçš„éå¸¸çš„ç®€å•ï¼Œä¹Ÿè®©äººä½“ä¼šåˆ°åŒæ­¥ç¼–ç¨‹çš„ç®€å•æ€§ã€‚å¦å¤–æˆ‘ç°åœ¨æ¯”è¾ƒå…³æ³¨webç¼–ç¨‹ï¼Œæ‰€ä»¥ä¼šæ¯”è¾ƒå…³æ³¨tcpéƒ¨åˆ†å¿½ç•¥æ‰udp(æºç ç‰ˆæœ¬Python2.7.11)</p>
<a id="more"></a>
<h3 id="ç±»ç»§æ‰¿å…³ç³»"><a href="#ç±»ç»§æ‰¿å…³ç³»" class="headerlink" title="ç±»ç»§æ‰¿å…³ç³»"></a>ç±»ç»§æ‰¿å…³ç³»</h3><p>ä¸è¯´åˆ«çš„ï¼Œå•å•çœ‹åˆ°è¿™å¼ å›¾å°±èƒ½å”¬ä½å¥½å¤šäººï¼Œæ„Ÿè§‰å¾ˆé«˜å¤§ä¸Šæœ‰æ²¡æœ‰<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+------------+</span><br><span class="line">| BaseServer |</span><br><span class="line">+------------+</span><br><span class="line">      |</span><br><span class="line">      v</span><br><span class="line">+-----------+        +------------------+</span><br><span class="line">| TCPServer |-------&gt;| UnixStreamServer |</span><br><span class="line">+-----------+        +------------------+</span><br><span class="line">      |</span><br><span class="line">      v</span><br><span class="line">+-----------+        +--------------------+</span><br><span class="line">| UDPServer |-------&gt;| UnixDatagramServer |</span><br><span class="line">+-----------+        +--------------------+</span><br></pre></td></tr></table></figure></p>
<h3 id="åŒæ­¥å¤„ç†ç±»æ¯”"><a href="#åŒæ­¥å¤„ç†ç±»æ¯”" class="headerlink" title="åŒæ­¥å¤„ç†ç±»æ¯”"></a>åŒæ­¥å¤„ç†ç±»æ¯”</h3><p>æœåŠ¡ç«¯å˜›ï¼Œè¯·å…è®¸æˆ‘æ±¡ä¸€ä¸‹ï¼Œå°±åƒå¤è£…å‰§é‡Œé¢çš„æ€¡çº¢é™¢ï¼Œéƒ½æœ‰ä¸ªé—¨å£æ¥å®¢çš„è€é¸¨ï¼Œæœ‰å®¢æˆ·æ¥å°±å¼•è¿›å»ç„¶åäº¤ç»™å¤±è¶³å°‘å¥³ã€‚è€é¸¨å°±æ˜¯æœåŠ¡ç«¯çš„ç›‘å¬socketï¼Œå¤±è¶³å°‘å¥³å°±æ˜¯å…·ä½“å¤„ç†çš„ä¸šåŠ¡é€»è¾‘ã€‚å¯ä»¥å†™æˆå¦‚ä¸‹ä¼ªä»£ç <br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">s = socket.socket()</span><br><span class="line">s.bind((<span class="string">'localhost'</span>,<span class="number">9999</span>))</span><br><span class="line">s.listen(<span class="number">2048</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    client,addr = s.accept()</span><br><span class="line">    handle(client,addr,s)</span><br></pre></td></tr></table></figure>    </p>
<p>å¯ä»¥è¯´socketserverå°±æ˜¯ç”±ä¸Šé¢æœ€åŸºæœ¬çš„æ­¥éª¤ï¼Œä¸ºäº†æ‰©å±•æ€§è€Œå†™çš„ä»£ç ã€‚ä¸Šé¢çš„ä¼ªä»£ç handle(client,addr,s)æ˜¯ä¸€éƒ¨åˆ†ï¼Œä¸Šé¢çš„åˆ†ä¸ºå¦å¤–ä¸€éƒ¨åˆ†ã€‚</p>
<p>socketserverå› ä¸ºæ˜¯åŒæ­¥çš„ï¼Œæ‰€ä»¥ç†è§£èµ·æ¥æ¯”asyncoreè¦ç®€å•è®¸å¤šã€‚è€Œä¸”æ³¨é‡Šå†™çš„éå¸¸è¯¦å°½ï¼Œæˆ‘å°±ä¸è¯¦è¿°BaseServer/BaseRequestHandlerçš„ç±»æ–¹æ³•äº†ï¼Œè¯´ä¸€ä¸‹å‡ ä¸ªæœ‰ç‚¹æ„æ€çš„åœ°æ–¹ã€‚</p>
<ol>
<li>BaseServeréƒ¨åˆ†åŸºæœ¬å°±ä»£è¡¨äº†ç›‘å¬å¥—æ¥å­—ï¼Œç„¶è€Œè¿˜æ˜¯æä¾›äº†2ä¸ªå¯¹è¿æ¥å¥—æ¥å­—çš„æ–¹æ³•ï¼Œå°±æ˜¯å¤„ç†å®Œæˆä¹‹åå…³é—­å•¦~~shutdown_request/close_request</li>
<li>handle_requestæ–¹æ³•å’Œserver_foreveræ˜¯éå¸¸ç›¸ä¼¼çš„ï¼ŒåŒºåˆ«å°±æ˜¯handler_requeståªç›¸åº”ä¸€ä¸ªè¯·æ±‚ã€‚å¤§æ¦‚æ˜¯ç”¨æ¥è°ƒè¯•å§ã€‚è¯¥å‡½æ•°è¿˜è°ƒèµ·äº†ä¸€ä¸ªç‰¹åˆ«åƒåœ¾çš„handle<em>timeoutå‡½æ•°ã€‚çœ‹åå­—æ˜¯ä¸æ˜¯ä»¥ä¸ºæ˜¯å¯¹è¿æ¥å¥—æ¥å­—çš„è¶…æ—¶å¤„ç†å‡½æ•°-</em>-ï¼Œå®é™…ä¸Šæ˜¯ç­‰å¤šä¹…è¿˜æ²¡æ¥ä¸€ä¸ªæ–°è¿æ¥ä¼šè§¦å‘ï¼Œå¯æ˜¯è¿™ä¸ªéœ€æ±‚åŸºæœ¬æ²¡æœ‰ã€‚æ‰€ä»¥æˆ‘éå¸¸è®¤ä¸ºè¿™ä¸ªhandle_requestä»…ä»…ç”¨æ¥è°ƒè¯•ä¸€æ¬¡è€Œå·²</li>
<li>ä¸Šé¢çš„ä¼ªä»£ç å¹¶æ²¡æœ‰ç”¨åˆ°selectï¼Œä¸ºä»€ä¹ˆsocketserverå°±ç”¨åˆ°äº†ï¼Œå…¶å®å¦‚æœåªæ˜¯ä¸ºäº†å¤„ç†tcpé‚£ä¹ˆæ­¤å¤„æ˜¯æ²¡æœ‰å¿…è¦ç”¨selectçš„ï¼Œå› ä¸ºtcpéœ€è¦acceptè€Œudpæ˜¯ç›´æ¥recvfromå°±å¥½äº†ã€‚ç”¨selectåªæ˜¯ä¸ºäº†é€šçŸ¥æœ‰æ•°æ®æ¥äº†ã€‚éƒ½æ˜¯ä¸ºäº†é€‚åº”å¤šç§æƒ…å†µæ‰ç”¨çš„selectã€‚å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯å®ƒä¸æ˜¯ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ˜¯ç›´æ¥ç”¨çš„selfï¼Œè¿™é‡Œåªè¦selfå®ç°äº†file_noæ–¹æ³•å°±å¯ä»¥äº†(å‚ç…§å®˜æ–¹æ–‡æ¡£)ã€‚è¿˜æœ‰selectå¦å¤–å¥—äº†ä¸€ä¸ª_eintr_retryå‡½æ•°ã€‚è¿™é‡Œæ˜¯å› ä¸ºæŸäº›æƒ…å†µä¸‹selectä¼šè¢«æ“ä½œç³»ç»Ÿä¸­æ–­è€Œå¼•å‘å¼‚å¸¸(æ¯”å¦‚ä½¿ç”¨single)</li>
<li>å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°å®ç°çš„ThreadingTCPServeræ˜¯é€šè¿‡ç»§æ‰¿çš„æ–¹å¼å®ç°çš„ï¼Œå®è´¨å°±æ˜¯å¤„ç†è¿æ¥å¥—æ¥å­—çš„æ—¶å€™ä½¿ç”¨å¤šçº¿ç¨‹æˆ–è€…å¤šè¿›ç¨‹,å¯ä»¥æƒ³åˆ°è¦å®ç°ç›¸åŒçš„æ•ˆæœç”¨è£…é¥°å™¨åŒæ ·æ˜¯å¯ä»¥çš„</li>
<li>StreamRequestHandlerä¸­ä½¿ç”¨äº†socket.makefileå°†è¿æ¥å¥—æ¥å­—åˆ†æˆäº†è¯»å’Œå†™2ä¸ªç±»æ–‡ä»¶å¯¹è±¡(åªèƒ½æ˜¯é˜»å¡socket)ã€‚å¯ä»¥æ„Ÿå—åˆ°çš„ä¼˜åŠ¿å°±æ˜¯read(num)è¿”å›çš„é•¿åº¦æ˜¯å‡†ç¡®çš„ï¼Œrecvå°±æ²¡æœ‰è¿™ä¸ªä¼˜åŠ¿</li>
<li>ç”¨åˆ°äº†threading.Event,è¿™ä¸ªåœ°æ–¹æˆ‘æ˜¯æ²¡å¤šææ˜ç™½ã€‚è°ƒç”¨shutdownæ–¹æ³•ä¼šä¸­æ–­å¾ªç¯ä»è€Œå…³é—­æœåŠ¡ã€‚ä¸€èˆ¬ä¼šåœ¨å¤„ç†çº¿ç¨‹è°ƒç”¨è¿™ä¸ªã€‚å¦‚æœä¸æ˜¯åœ¨å¤„ç†çº¿ç¨‹è°ƒç”¨é‚£ä¹ˆä¼šå‘ç”Ÿæ­»é”ã€‚ã€‚ã€‚æˆ‘èƒ½æƒ³åˆ°çš„åªæœ‰è¿™é‡Œ</li>
</ol>
<h3 id="socks5-DEMO-å¼•ç”¨è‡ªhttp-xiaoxia-org-2011-03-29-written-by-python-socks5-server"><a href="#socks5-DEMO-å¼•ç”¨è‡ªhttp-xiaoxia-org-2011-03-29-written-by-python-socks5-server" class="headerlink" title="socks5 DEMO(å¼•ç”¨è‡ªhttp://xiaoxia.org/2011/03/29/written-by-python-socks5-server/)"></a>socks5 DEMO(å¼•ç”¨è‡ª<a href="http://xiaoxia.org/2011/03/29/written-by-python-socks5-server/">http://xiaoxia.org/2011/03/29/written-by-python-socks5-server/</a>)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket, select, SocketServer, struct</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Socks5Handle</span><span class="params">(SocketServer.StreamRequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">tcprelay</span><span class="params">(self, sock, remote)</span>:</span></span><br><span class="line">        fdset = [sock, remote]</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            r, w, e = select.select(fdset, [], [])</span><br><span class="line">            <span class="keyword">if</span> sock <span class="keyword">in</span> r:</span><br><span class="line">                <span class="keyword">if</span> remote.send(sock.recv(<span class="number">4096</span>)) &lt;= <span class="number">0</span>: <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> remote <span class="keyword">in</span> r:</span><br><span class="line">                <span class="keyword">if</span> sock.send(remote.recv(<span class="number">4096</span>)) &lt;= <span class="number">0</span>: <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            print(<span class="string">'socks connection from '</span>, self.client_address)</span><br><span class="line">            sock = self.connection</span><br><span class="line">            <span class="comment"># 1. Version</span></span><br><span class="line">            sock.recv(<span class="number">262</span>)</span><br><span class="line">            sock.send(<span class="string">b"\x05\x00"</span>)</span><br><span class="line">            <span class="comment"># 2. Request</span></span><br><span class="line">            data = self.rfile.read(<span class="number">4</span>)</span><br><span class="line">            mode = ord(data[<span class="number">1</span>])</span><br><span class="line">            addrtype = ord(data[<span class="number">3</span>])</span><br><span class="line">            <span class="keyword">if</span> addrtype == <span class="number">1</span>:  <span class="comment"># IPv4</span></span><br><span class="line">                addr = socket.inet_ntoa(self.rfile.read(<span class="number">4</span>))</span><br><span class="line">            <span class="keyword">elif</span> addrtype == <span class="number">3</span>:  <span class="comment"># Domain name</span></span><br><span class="line">                addr = self.rfile.read(ord(sock.recv(<span class="number">1</span>)[<span class="number">0</span>]))</span><br><span class="line">            port = struct.unpack(<span class="string">'&gt;H'</span>, self.rfile.read(<span class="number">2</span>))</span><br><span class="line">            reply = <span class="string">b"\x05\x00\x00\x01"</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> mode == <span class="number">1</span>:  <span class="comment"># 1. Tcp connect</span></span><br><span class="line">                    remote = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">                    remote.connect((addr, port[<span class="number">0</span>]))</span><br><span class="line">                    print(<span class="string">'Tcp connect to'</span>, addr, port[<span class="number">0</span>])</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    reply = <span class="string">b"\x05\x07\x00\x01"</span>  <span class="comment"># Command not supported</span></span><br><span class="line">                local = remote.getsockname()</span><br><span class="line">                reply += socket.inet_aton(local[<span class="number">0</span>]) + struct.pack(<span class="string">"&gt;H"</span>, local[<span class="number">1</span>])</span><br><span class="line">            <span class="keyword">except</span> socket.error:</span><br><span class="line">                <span class="comment"># Connection refused</span></span><br><span class="line">                reply = <span class="string">'\x05\x05\x00\x01\x00\x00\x00\x00\x00\x00'</span></span><br><span class="line">            sock.send(reply)</span><br><span class="line">            <span class="comment"># 3. Transfering</span></span><br><span class="line">            <span class="keyword">if</span> reply[<span class="number">1</span>] == <span class="string">'\x00'</span>:  <span class="comment"># Success</span></span><br><span class="line">                self.tcprelay(sock, remote)</span><br><span class="line">        <span class="keyword">except</span> socket.error:</span><br><span class="line">            print(<span class="string">'socket error'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    server = SocketServer.ThreadingTCPServer((<span class="string">''</span>, <span class="number">1081</span>), Socks5Handle)</span><br><span class="line">    server.serve_forever()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h3 id="å’Œasyncoreå¯¹æ¯”"><a href="#å’Œasyncoreå¯¹æ¯”" class="headerlink" title="å’Œasyncoreå¯¹æ¯”"></a>å’Œasyncoreå¯¹æ¯”</h3><p>asyncoreå’ŒsocketserveråŒæ ·å®ç°äº†å¹¶å‘ã€‚å¯¹æ¯”ä¸€ä¸‹<br>1.ä»åå­—éƒ½å¯ä»¥çœ‹å‡ºæ¥serverã€‚socketserveråªèƒ½ç”¨æ¥å®ç°serverï¼Œè€Œasyncoreè¿˜å¯ä»¥å®ç°å®¢æˆ·ç«¯<br>2.socketserverå®ç°äº†å¤šçº¿ç¨‹å’Œå¤šè¿›ç¨‹ï¼Œasyncoreæ¡†æ¶æ˜¯å•çº¿ç¨‹äº‹ä»¶å¾ªç¯</p>
<h3 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h3><p><a href="https://pymotw.com/2/SocketServer/index.html#module-SocketServer">SocketServer â€“ Creating network servers.</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;SocketServer.pyè¿™ä¸ªæ–‡ä»¶700æ¥è¡Œï¼Œé™¤å»æ³¨é‡Šå¤§æ¦‚300æ¥è¡Œå·¦å³ï¼Œæ®ç½‘å‹ç§°è¯¥æ¨¡å—å®ä¹ƒå­¦ä¹ ç±»ç»§æ‰¿ä¹‹å…¸èŒƒã€‚&lt;br&gt;è¦ç†è§£è¿™ä¸ªæ¨¡å—çœŸçš„éå¸¸çš„ç®€å•ï¼Œä¹Ÿè®©äººä½“ä¼šåˆ°åŒæ­¥ç¼–ç¨‹çš„ç®€å•æ€§ã€‚å¦å¤–æˆ‘ç°åœ¨æ¯”è¾ƒå…³æ³¨webç¼–ç¨‹ï¼Œæ‰€ä»¥ä¼šæ¯”è¾ƒå…³æ³¨tcpéƒ¨åˆ†å¿½ç•¥æ‰udp(æºç ç‰ˆæœ¬Python2.7.11)&lt;/p&gt;
    
    </summary>
    
      <category term="æºç è§£æ" scheme="https://www.zoulei.net/categories/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
    
  </entry>
  
  <entry>
    <title>asyncoreæºç é˜…è¯»</title>
    <link href="https://www.zoulei.net/2016/06/29/asyncore_note/"/>
    <id>https://www.zoulei.net/2016/06/29/asyncore_note/</id>
    <published>2016-06-29T03:24:21.000Z</published>
    <updated>2016-07-02T10:24:51.000Z</updated>
    
    <content type="html"><![CDATA[<p>asyncoreä¸ºselect.selectã€pollçš„å°è£…(å®é™…ä¸Šç°åœ¨å¤§å®¶éƒ½ä½¿ç”¨æ›´ä¸ºé«˜æ•ˆçš„epoll)ï¼Œå˜æˆäº†æ¡†æ¶çš„ä½¿ç”¨æ¨¡å¼ï¼Œè¯¥åº“å·²ç»ä½œä¸ºå…¼å®¹æ¨¡å¼å­˜åœ¨ï¼Œæ–°çš„åº“ä¸ºasyncioã€‚ä¸”åœ¨2å’Œ3ä¸­asyncoreä»£ç æœ‰ä¸€ç‚¹ç‚¹å·®å¼‚ã€‚(æºç ç‰ˆæœ¬2.7.11)</p>
<a id="more"></a>
<h3 id="dispatcherç±»-è°ƒåº¦"><a href="#dispatcherç±»-è°ƒåº¦" class="headerlink" title="dispatcherç±»(è°ƒåº¦)"></a>dispatcherç±»(è°ƒåº¦)</h3><p>æ–‡ä»¶asyncore.pyä¸­æœ€é‡è¦çš„ç±»ä¸ºdispatcherï¼Œä½¿ç”¨çš„æ—¶å€™åªéœ€è¦ç»§æ‰¿asyncore.dispatcherå°±å¥½äº†</p>
<p>å¯ä»¥è¿™æ ·ç†è§£æ¯ä¸€ä¸ªç»§æ‰¿äº†asyncore.dispatcherçš„ç±»éƒ½ä»£è¡¨äº†ä¸€ä¸ªsocket(ç›‘å¬socketæˆ–è€…è¿æ¥socket)</p>
<p>åœ¨asyncore.pyçš„æœ€å¼€å§‹æœ‰ä¸€ä¸ªå…¨å±€å­—å…¸socket_mapå¯¹åº”fdå’Œä¸€ä¸ªasyncore.dispatcherç±»ï¼Œå½“ä½ ç»§æ‰¿ä¸€ä¸ªdispatcherç±»çš„æ—¶å€™æ€»ä¼šè°ƒç”¨å‡½æ•°åœ¨å…¨å±€å­—å…¸socket_mapä¸­åˆ›å»ºä¸€ä¸ªæ˜ å°„ï¼Œå½“ç„¶åœ¨å…³é—­çš„æ—¶å€™ä¹Ÿä¼šä»å…¨å±€å­—å…¸ä¸­åˆ é™¤</p>
<p>æœ€åæ˜¯ä¸€ä¸ªloopæ­»å¾ªç¯ï¼Œå¯ä»¥å¾ˆå®¹æ˜“æƒ³åˆ°æ˜¯ä½¿ç”¨äº†ç³»ç»ŸIOå¤šè·¯å¤ç”¨æ¥å£select.selectå¯¹å…¨å±€socket_mapè¿›è¡Œäº†æ“ä½œã€‚æ ¹æ®è¿”å›çš„äº‹ä»¶è¿›è¡Œæ“ä½œ(3ä¸ªäº‹ä»¶è¯»ã€å†™ã€é”™è¯¯)</p>
<p>æºç ä¸­æˆ‘ä»¬ç€é‡çœ‹dispatcherç±»ï¼Œå®ƒå¯ä»¥åˆ’åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªè¦ç‚¹</p>
<ol>
<li>æ·»åŠ äº†4ä¸ªçŠ¶æ€ï¼Œconnected/accepting/connecting/closingï¼Œæƒ³æƒ³ä¸ºä»€ä¹ˆè¦è®¾ç½®è¿™å‡ ä¸ªçŠ¶æ€å‘¢ï¼Ÿï¼Ÿï¼Ÿ<br>connected:å·²ç»è¿æ¥ä¸Šå¯¹æ–¹,æ¯”å¦‚ç›‘å¬å¥—æ¥å­—sock,addr = socket.accept()è¿”å›çš„sock</li>
<li>add_channel/del_channel/create_socket/set_socketè¿™å‡ ä¸ªéƒ½æ˜¯é’ˆå¯¹å…¨å±€å­—å…¸socket_mapçš„æ“ä½œã€‚æ·»åŠ è¿›å»æˆ–è€…åˆ é™¤</li>
<li>readable/writable ç”¨çš„åœ°æ–¹ä¸æ˜¯å¤ªå¤šï¼Œé¢„å…ˆç¡®å®šè¯¥socketè¯¥ä¸è¯¥æ·»åŠ åˆ°socketçš„å¯è¯»å¯å†™é‡Œé¢</li>
<li>listen/bind/connect/accept/send/recv/close è¿™å‡ ä¸ªå‡½æ•°å˜›ï¼Œå¯¹åŸæœ‰çš„è¡Œä¸ºç¨å¾®æ”¹åŠ¨äº†ä¸‹ï¼Œæ¯”å¦‚listenè®¾ç½®ä¸ºacceptingçŠ¶æ€ï¼Œconnectè®¾ç½®ä¸ºconnectingçŠ¶æ€ï¼Œsend,recvä¸€å®šæ¡ä»¶å‡ºå‘closeï¼Œcloseå³ä¸ºä»å…¨å±€å­—å…¸ä¸­åˆ é™¤å¹¶å…³é—­socket</li>
<li>handle_read_event/handle_connect_event/handle_write_event.å½“selectæœ‰äº‹ä»¶è¿”å›çš„æ—¶å€™å°±æ˜¯è°ƒç”¨çš„è¿™3ä¸ªæ–¹æ³•ã€‚åªæ˜¯éœ€è¦æ³¨æ„ã€‚è¿™é‡Œå¹¶ä¸æ˜¯æœ€ç»ˆæ‰§è¡Œçš„æ“ä½œ(sendã€recvç­‰)ï¼ï¼ï¼è¿™é‡Œä¹Ÿä½“ç°äº†æ ‡æ³¨socketçŠ¶æ€çš„ä½œç”¨ï¼Œreadå¯ä»¥åˆ†ä¸ºç›‘å¬(accepting)ã€è¿æ¥å®Œæˆå(connecting)â†’â†’â†’è¿™é‡Œå°±æ˜¯ä¸€ä¸ªhookï¼Œå¦‚æœè‡ªå·±è°ƒç”¨connectè¿æ¥é‚£ä¹ˆå®Œæˆåæ˜¯æ­¤çŠ¶æ€ï¼Œå¯ä»¥è‡ªå·±é‡å†™handle_connectå¤„ç†è¯¥äº‹ä»¶ï¼Œå¦‚æœæ˜¯ç›´æ¥åˆå§‹åŒ–çš„socketåˆ™ç›´æ¥ä¸ºconnectedçŠ¶æ€ã€‚handle_write_eventä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå½“ä¸ºconnectingçŠ¶æ€çš„æ—¶å€™å¤„ç†hookï¼Œå¦åˆ™å¤„ç†å†™å…¥äº‹ä»¶</li>
<li>æœ€åè¿™ä¸€éƒ¨åˆ†åŸºæœ¬å°±æ˜¯ä½¿ç”¨è€…éœ€è¦é‡å†™çš„éƒ¨åˆ†äº†ã€‚handle_expt/handle_read/handle_write/handle_connect/handle_accept/handle_closeå«ä¹‰å¾ˆæ˜ç™½ï¼Œå°±ä¸è¡¨è¿°äº†</li>
</ol>
<p>åœ¨åé¢å°±æ˜¯dispatcherçš„ç»§æ‰¿ç±»dispatcher_with_sendå’Œfile_dispatcherï¼Œå‰è€…å˜›ï¼Œè¯•æƒ³ä¸€ä¸‹ä½ è¦å‘é€éå¸¸å¤šå†…å®¹ï¼Œè‚¯å®šè°ƒç”¨ä¸€æ¬¡sendå‘ä¸å®Œã€‚å®ƒå°±ç»™ä½ è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå½“ç„¶æ–¹æ³•ä¹Ÿå¾ˆç®€å•ã€‚åé¢å°±æ˜¯ä¸ºäº†é«˜æ•ˆå‘é€æ–‡ä»¶è€Œäº§ç”Ÿçš„äº†</p>
<h3 id="æµç¨‹å›¾ç¤º-ä»¥ä¸€ä¸ªå®¢æˆ·ç«¯ä¸ºä¾‹"><a href="#æµç¨‹å›¾ç¤º-ä»¥ä¸€ä¸ªå®¢æˆ·ç«¯ä¸ºä¾‹" class="headerlink" title="æµç¨‹å›¾ç¤º(ä»¥ä¸€ä¸ªå®¢æˆ·ç«¯ä¸ºä¾‹)"></a>æµç¨‹å›¾ç¤º(ä»¥ä¸€ä¸ªå®¢æˆ·ç«¯ä¸ºä¾‹)</h3><p><img src="https://ficapy.b0.upaiyun.com/blogimg/asyncore%E7%AE%80%E6%98%93%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt=""></p>
<h3 id="sockets5-DEMO"><a href="#sockets5-DEMO" class="headerlink" title="sockets5 DEMO"></a>sockets5 DEMO</h3><p>å¯¹äºä½¿ç”¨asyncoreï¼Œå®˜æ–¹çš„ä¾‹å­æˆ‘è§‰å¾—å·²ç»è¡¨ç°çš„éå¸¸åˆ°ä½äº†ã€‚ä¸‹é¢æˆ‘æ”¾å‡ºä¸€ä¸ªä½¿ç”¨å®ƒå†™çš„ç®€å•socks5server(ä½œä¸ºä¸€ä¸ªdemoï¼Œåªå¯¹tcpè¿›è¡Œå¤„ç†ï¼Œæ²¡æœ‰å†™è¿œç¨‹dnsè§£æ)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncore</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">sockets_map = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Socks5Listen</span><span class="params">(asyncore.dispatcher)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, address=<span class="params">(<span class="string">'localhost'</span>, <span class="number">8081</span>)</span>)</span>:</span></span><br><span class="line">        asyncore.dispatcher.__init__(self)</span><br><span class="line">        self.create_socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.set_reuse_addr()</span><br><span class="line">        self.bind(address)</span><br><span class="line">        self.listen(<span class="number">2048</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_accept</span><span class="params">(self)</span>:</span></span><br><span class="line">        pair = self.accept()</span><br><span class="line">        <span class="keyword">if</span> pair <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            sock, addr = pair</span><br><span class="line">            print(<span class="string">'socks connection from '</span>, addr)</span><br><span class="line">            Local(sock)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Local</span><span class="params">(asyncore.dispatcher_with_send)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, sock)</span>:</span></span><br><span class="line">        asyncore.dispatcher_with_send.__init__(self, sock=sock)</span><br><span class="line">        self.read_buffer = <span class="string">''</span></span><br><span class="line">        self.status = <span class="string">'init'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(self, num)</span>:</span></span><br><span class="line">        data = self.recv(num)</span><br><span class="line">        self.read_buffer += data</span><br><span class="line">        <span class="keyword">if</span> len(self.read_buffer) != num:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            _ = self.read_buffer</span><br><span class="line">            self.read_buffer = <span class="string">''</span></span><br><span class="line">            <span class="keyword">return</span> _</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_read</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.status == <span class="string">'init'</span>:</span><br><span class="line">            self.recv(<span class="number">262</span>)</span><br><span class="line">            self.send(<span class="string">b"\x05\x00"</span>)</span><br><span class="line">            self.status = <span class="string">'request'</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> self.status == <span class="string">'request'</span>:</span><br><span class="line">            data = self.read(<span class="number">4</span>)</span><br><span class="line">            <span class="keyword">if</span> data <span class="keyword">is</span> <span class="keyword">None</span>: <span class="keyword">return</span></span><br><span class="line">            mode = ord(data[<span class="number">1</span>])</span><br><span class="line">            addrtype = ord(data[<span class="number">3</span>])</span><br><span class="line">            <span class="keyword">if</span> addrtype == <span class="number">1</span>:  <span class="comment"># IPv4</span></span><br><span class="line">                addr = self.read(<span class="number">4</span>)</span><br><span class="line">                <span class="keyword">if</span> addr <span class="keyword">is</span> <span class="keyword">None</span>: <span class="keyword">return</span></span><br><span class="line">                addr = socket.inet_ntoa(addr)</span><br><span class="line">            <span class="keyword">elif</span> addrtype == <span class="number">3</span>:  <span class="comment"># Domain name</span></span><br><span class="line">                addr = self.read(ord(self.recv(<span class="number">1</span>)[<span class="number">0</span>]))</span><br><span class="line">                <span class="keyword">if</span> addr <span class="keyword">is</span> <span class="keyword">None</span>: <span class="keyword">return</span></span><br><span class="line">            port = self.read(<span class="number">2</span>)</span><br><span class="line">            <span class="keyword">if</span> port <span class="keyword">is</span> <span class="keyword">None</span>: <span class="keyword">return</span></span><br><span class="line">            port = struct.unpack(<span class="string">'&gt;H'</span>, port)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> mode == <span class="number">1</span>:  <span class="comment"># 1. Tcp connect</span></span><br><span class="line">                remote = Remote(addr, port)</span><br><span class="line">                sockets_map[self] = remote</span><br><span class="line">                sockets_map[remote] = self</span><br><span class="line">                self.status = <span class="string">'transfer'</span></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                reply = <span class="string">b"\x05\x07\x00\x01"</span>  <span class="comment"># Command not supported</span></span><br><span class="line">                self.send(reply)</span><br><span class="line">                self.close()</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> self.status == <span class="string">'transfer'</span>:</span><br><span class="line">            data = self.recv(<span class="number">2048</span>)</span><br><span class="line">            <span class="keyword">if</span> data:</span><br><span class="line">                sockets_map[self].send(data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_expt</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.handle_close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_close</span><span class="params">(self)</span>:</span></span><br><span class="line">        asyncore.dispatcher_with_send.handle_close(self)</span><br><span class="line">        remote = sockets_map.get(self)</span><br><span class="line">        <span class="keyword">if</span> remote:</span><br><span class="line">            <span class="keyword">del</span> sockets_map[remote]</span><br><span class="line">        <span class="keyword">if</span> self <span class="keyword">in</span> sockets_map:</span><br><span class="line">            <span class="keyword">del</span> sockets_map[self]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Remote</span><span class="params">(asyncore.dispatcher_with_send)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, addr, port)</span>:</span></span><br><span class="line">        asyncore.dispatcher_with_send.__init__(self)</span><br><span class="line">        self.create_socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.connect((addr, port))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_connect</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'Tcp connect to'</span>, self.addr)</span><br><span class="line">        local = self.socket.getsockname()</span><br><span class="line">        reply = <span class="string">b"\x05\x00\x00\x01"</span></span><br><span class="line">        reply += socket.inet_aton(local[<span class="number">0</span>]) + struct.pack(<span class="string">"&gt;H"</span>, local[<span class="number">1</span>])</span><br><span class="line">        sockets_map[self].socket.send(reply)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_read</span><span class="params">(self)</span>:</span></span><br><span class="line">        data = self.recv(<span class="number">2048</span>)</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            sockets_map[self].send(data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_expt</span><span class="params">(self)</span>:</span></span><br><span class="line">        reply = <span class="string">'\x05\x05\x00\x01\x00\x00\x00\x00\x00\x00'</span></span><br><span class="line">        self.send(reply)</span><br><span class="line">        self.handle_close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_close</span><span class="params">(self)</span>:</span></span><br><span class="line">        asyncore.dispatcher_with_send.handle_close(self)</span><br><span class="line">        local = sockets_map.get(self)</span><br><span class="line">        <span class="keyword">if</span> local:</span><br><span class="line">            <span class="keyword">del</span> sockets_map[local]</span><br><span class="line">        <span class="keyword">if</span> self <span class="keyword">in</span> sockets_map:</span><br><span class="line">            <span class="keyword">del</span> sockets_map[self]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server = Socks5Listen()</span><br><span class="line">asyncore.loop()</span><br></pre></td></tr></table></figure>
<p>ä¸€ä¸ªsocks5æœåŠ¡ç«¯ä¼šæœ‰3ç±»socketã€‚æ‰€ä»¥ä¼šæœ‰ä¸‰ä¸ªç±»ã€‚</p>
<h3 id="å°çŸ¥è¯†"><a href="#å°çŸ¥è¯†" class="headerlink" title="å°çŸ¥è¯†"></a>å°çŸ¥è¯†</h3><h6 id="LEGBä½œç”¨åŸŸ"><a href="#LEGBä½œç”¨åŸŸ" class="headerlink" title="LEGBä½œç”¨åŸŸ"></a>LEGBä½œç”¨åŸŸ</h6><p>asyncoreä¸­ä½¿ç”¨å…¨å±€å­—å…¸socket_mapè®°å½•æ˜ å°„ã€‚æƒ³åˆ°å…¨å±€å°±ä¼šæƒ³åˆ°global<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> a</span><br><span class="line">    a += <span class="number">1</span></span><br><span class="line">main()</span><br><span class="line"><span class="keyword">print</span> a</span><br></pre></td></tr></table></figure><br>å¯ä»¥æ³¨æ„åˆ°è¿™é‡Œå¿…é¡»è¦æœ‰globalå…³é”®å­—ï¼Œç„¶è€Œæ¢æˆå­—å…¸ã€‚ä¸ºä½•å°±ä¸éœ€è¦globaläº†ã€‚å®é™…ä¸Šè¿™é‡Œè¦å…³æ³¨çš„æ˜¯å¯¹è±¡çš„id,å¯¹äºæ•°å­—ã€å­—ç¬¦ä¸²è¿™äº›å¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œç„¶è€Œå­—å…¸å¯¹è±¡æ˜¯å¯å˜çš„ã€‚è¦æ”¹å˜ä¸å¯å˜å˜é‡å®é™…æ˜¯é‡æ–°èµ‹å€¼ï¼Œæ‰€ä»¥å¯¹äºæ”¹å˜å¤–éƒ¨ä¸å¯å˜å˜é‡è¦ç”¨globalï¼Œå¯å˜å¯¹è±¡ä¸éœ€è¦</p>
<h6 id="æ¡†æ¶å’Œåº“çš„åŒºåˆ«"><a href="#æ¡†æ¶å’Œåº“çš„åŒºåˆ«" class="headerlink" title="æ¡†æ¶å’Œåº“çš„åŒºåˆ«"></a>æ¡†æ¶å’Œåº“çš„åŒºåˆ«</h6><p>ä¿—ç§°å¥½è±åæ¨¡å¼(Donâ€™t call us, we will call you)ã€‚æ¯”å¦‚åº“å‡½æ•°sumä½ å¾ˆå®¹æ˜“æƒ³åˆ°ç»™å‡ ä¸ªæ•°å­—å®ƒè¿”å›ç»™ä½ å’Œã€‚æ¡†æ¶å˜›ã€‚å°±åƒä¸Šé¢çš„asyncoreä½ éœ€è¦çš„æ˜¯ç»§æ‰¿dispatcherç±»ç„¶åé‡æ–°ä¸€äº›æ–¹æ³•ã€‚è™½ç„¶å®ƒèƒ½è¾¾åˆ°ç›®çš„ï¼Œå¯æ˜¯å¦‚æœä½ ä¸çœ‹æºç æˆ–è®¸ä½ æ°¸è¿œä¹Ÿæ— æ³•æ˜ç™½æ¡†æ¶åœ¨åé¢åšäº†ä»€ä¹ˆã€‚ä»æˆ‘ä¸ªäººçš„ç†è§£æ¥çœ‹æˆ‘æ˜¯æ¯”è¾ƒå–œæ¬¢æˆç†Ÿçš„æ¡†æ¶çš„ã€‚æ¯•ç«Ÿå¦‚æœä¸ç”¨æ¡†æ¶è‡ªå·±ç”¨åº“å‡½æ•°å†™æœ€åä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œå½“ç„¶å¾ˆå¯èƒ½æ˜¯ä¸€ä¸ªåƒåœ¾çš„æ¡†æ¶:D</p>
<h6 id="ä¸ºä»€ä¹ˆå¤šè·¯IOå¤ç”¨ä¸€å®šæ˜¯é…åˆçš„éé˜»å¡socket"><a href="#ä¸ºä»€ä¹ˆå¤šè·¯IOå¤ç”¨ä¸€å®šæ˜¯é…åˆçš„éé˜»å¡socket" class="headerlink" title="ä¸ºä»€ä¹ˆå¤šè·¯IOå¤ç”¨ä¸€å®šæ˜¯é…åˆçš„éé˜»å¡socket"></a>ä¸ºä»€ä¹ˆå¤šè·¯IOå¤ç”¨ä¸€å®šæ˜¯é…åˆçš„éé˜»å¡socket</h6><p>å¦ˆè›‹ï¼Œè¿™ä¸ªé—®é¢˜å„ç§è¯´æ³•çœŸæ˜¯å¤ªå¤šäº†ã€‚æƒ³ä¸€æƒ³å¦‚æœselectè¿”å›ç»™ä½ ä¸€ä¸ªfdå¯è¯»ï¼Œé‚£ä¹ˆä»–ä¸€å®šæ˜¯å¯è¯»çš„ã€‚å¦‚æœè¿™æ ·é‚£ä¹ˆä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ç”¨selecté…åˆé˜»å¡socketä¹Ÿæ˜¯å¯ä»¥çš„ã€‚å¯æ˜¯ç°å®ä¸è¿™æ ·çº¸å•Šã€‚unixæ‰‹å†Œä¸­æ˜ç¡®è¯´æ˜äº†ä¸æ˜¯è¿™æ ·çš„ã€‚æ‰€ä»¥å·¥ç¨‹ä¸Šå‡ ä¹æ²¡æœ‰è§è¿‡é…åˆé˜»å¡socketä½¿ç”¨çš„ä¾‹å­ã€‚å¦å¤–asyncoreç§connectæ–¹æ³•ç”¨çš„æ˜¯connect_ex</p>
<h3 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h3><p><a href="https://docs.python.org/2/library/asyncore.html">å®˜æ–¹æ–‡æ¡£</a></p>
<p><a href="https://www.zhihu.com/question/37271342">çŸ¥ä¹:ä¸ºä»€ä¹ˆIOå¤šè·¯å¤ç”¨è¦æ­é…éé˜»å¡socket</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;asyncoreä¸ºselect.selectã€pollçš„å°è£…(å®é™…ä¸Šç°åœ¨å¤§å®¶éƒ½ä½¿ç”¨æ›´ä¸ºé«˜æ•ˆçš„epoll)ï¼Œå˜æˆäº†æ¡†æ¶çš„ä½¿ç”¨æ¨¡å¼ï¼Œè¯¥åº“å·²ç»ä½œä¸ºå…¼å®¹æ¨¡å¼å­˜åœ¨ï¼Œæ–°çš„åº“ä¸ºasyncioã€‚ä¸”åœ¨2å’Œ3ä¸­asyncoreä»£ç æœ‰ä¸€ç‚¹ç‚¹å·®å¼‚ã€‚(æºç ç‰ˆæœ¬2.7.11)&lt;/p&gt;
    
    </summary>
    
      <category term="æºç è§£æ" scheme="https://www.zoulei.net/categories/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
    
  </entry>
  
</feed>
