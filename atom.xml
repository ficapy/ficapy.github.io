<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>é‚¹é›·</title>
  <subtitle>åˆ¨è¿‡çš„å‘,è‡ªå·±æ…¢æ…¢æ¥å¡«</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://www.zoulei.net/"/>
  <updated>2018-06-06T16:16:43.839Z</updated>
  <id>https://www.zoulei.net/</id>
  
  <author>
    <name>ficapy</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Goç¨‹åºè®¾è®¡è¯­è¨€è¯¾åä¹ é¢˜ç­”æ¡ˆ-ç¬¬ä¸‰ç« (åŸºæœ¬æ•°æ®)</title>
    <link href="https://www.zoulei.net/2018/06/06/the_go_programming_lang_usage_answer_3/"/>
    <id>https://www.zoulei.net/2018/06/06/the_go_programming_lang_usage_answer_3/</id>
    <published>2018-06-06T15:59:33.000Z</published>
    <updated>2018-06-06T16:16:43.839Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ç¬¬ä¸‰ç« "><a href="#ç¬¬ä¸‰ç« " class="headerlink" title="ç¬¬ä¸‰ç« "></a>ç¬¬ä¸‰ç« </h3><ul>
<li>æ•´æ•°</li>
<li>æµ®ç‚¹æ•°</li>
<li>å¤æ•°</li>
<li>å¸ƒå°”å€¼</li>
<li>å­—ç¬¦ä¸²</li>
<li>å¸¸é‡</li>
</ul>
<p>è¿™ä¸€ç« é˜…è¯»ä½“éªŒå¾ˆå¥½ï¼Œå› ä¸ºä¹¦ä¸Šç»™çš„ç¤ºä¾‹å¾ˆç‚«é…·ï¼Œäº§ç”Ÿçš„ç»“æœæ˜¯ç‚«é…·çš„å›¾å½¢ï¼Œç„¶è€Œæƒ³è¦ç†è§£å´æŒºå¤´ç—›ï¼Œå› ä¸ºéœ€è¦ä¸€äº›åŸºç¡€çš„å›¾å½¢å­¦çŸ¥è¯†ï¼Œè¿™ç« ä¹ é¢˜åšå¾—æ¯”è¾ƒå¤´ç–¼ï¼Œä¸æ˜¯å› ä¸ºä»£ç é€»è¾‘ï¼Œè€Œæ˜¯å› ä¸ºâ€ä¸šåŠ¡é€»è¾‘â€<br><a id="more"></a></p>
<h4 id="ç»ƒä¹ 3-1"><a href="#ç»ƒä¹ 3-1" class="headerlink" title="ç»ƒä¹ 3.1"></a>ç»ƒä¹ 3.1</h4><p> å‡å¦‚å‡½æ•°fè¿”å›ä¸€ä¸ªfloat64å‹çš„æ— ç©·å¤§å€¼,å°±ä¼šå¯¼è‡´SVGæ–‡ä»¶å«æœ‰æ— æ•ˆçš„<polygon>å…ƒç´ .ä¿®æ”¹æœ¬ç¨‹åºä»¥é¿å…æ— æ•ˆå¤šè¾¹å½¢</p>
<ul>
<li><p>æˆ‘çš„æƒ³æ³•æ˜¯å°†æ— ç©·å¤§å’Œ<code>math.MaxFloat64</code>è¿›è¡Œæ¯”è¾ƒï¼Œæ¯”å®ƒè¿˜å¤§å°±æ›¿æ¢ä¸ºæœ€å¤§å€¼</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">func</span> <span class="title">TestMax</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> z <span class="keyword">float64</span></div><div class="line">	<span class="keyword">if</span> <span class="number">1</span>/z &gt; math.MaxFloat64&#123;</div><div class="line">		fmt.Println(math.MaxFloat64)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"> </div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="ç»ƒä¹ 3-2"><a href="#ç»ƒä¹ 3-2" class="headerlink" title="ç»ƒä¹ 3.2"></a>ç»ƒä¹ 3.2</h4><p>ç”¨mathåŒ…çš„å…¶ä»–å‡½æ•°è¯•éªŒå¯è§†åŒ–æ•ˆæœ.ä½ æ˜¯å¦èƒ½ç”Ÿæˆå„ç§æ›²é¢,åˆ†åˆ«å‘ˆé¸¡è›‹ç›’çŠ¶ã€é›ªå¡çŠ¶æˆ–é©¬éçŠ¶</p>
<ul>
<li>æ²¡æœ‰å®Œå…¨ææ˜ç™½ï¼Œä¸‰ç»´æ˜ å°„åˆ°äºŒç»´çš„è¿‡ç¨‹ï¼Œä¸è¿‡æ•´ä¸ªä»£ç çš„é€»è¾‘è¿˜æ˜¯å¾ˆæ¸…æ™°çš„ï¼Œè¿™ä¸€é¢˜ç•¥è¿‡</li>
</ul>
<p>#####ç»ƒä¹ 3.3<br>æŒ‰é«˜åº¦ç»™æ¯ä¸ªå¤šè¾¹å½¢ä¸Šè‰²,ä½¿å¾—å°é¡¶å‘ˆçº¢è‰²(#ff0000),è°·åº•å‘ˆè“è‰²(#0000ff)</p>
<ul>
<li>æ€è·¯æ˜¯å¾—åˆ°æœ€å¤§å€¼æœ€å°å€¼ï¼Œå°†ä¸­é—´éƒ¨åˆ†åˆ†ä¸º256ä¸ªéƒ¨åˆ†ï¼Œç„¶åæ¯ä¸ªzå€¼éƒ½èƒ½æ˜ å°„åˆ°ä¸€ä¸ªé¢œè‰²ï¼Œæƒ³ç€å¯ä»¥å¹³æ»‘è¿‡æ¸¡ï¼Œç„¶è€Œæ•ˆæœå´å¾ˆç³Ÿç³•ğŸ˜°</li>
<li>svgçš„polygonæ˜¾ç¤ºé¢œè‰²ï¼Œåªè¦åœ¨æ¯ä¸ªpolygonä¸Šé¢æ·»åŠ fillå±æ€§å°±å¯ä»¥äº†</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"math"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">const</span> (</div><div class="line">	width, height = <span class="number">600</span>, <span class="number">320</span></div><div class="line">	cells         = <span class="number">100</span></div><div class="line">	xyrange       = <span class="number">30.0</span></div><div class="line">	xyscale       = width / <span class="number">2</span> / xyrange</div><div class="line">	zscale        = height * <span class="number">0.4</span></div><div class="line">	angle         = math.Pi / <span class="number">6</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> sin30, cos30 = math.Sin(angle), math.Cos(angle)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	fmt.Printf(<span class="string">"&lt;svg xmlns='http://www.w3.org/2000/svg' "</span>+</div><div class="line">		<span class="string">"style='stroke: grey; fill: white; stroke-width: 0.7' "</span>+</div><div class="line">		<span class="string">"width='%d' height='%d'&gt;"</span>, width, height)</div><div class="line">	min, max := getMinMax()</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cells; i++ &#123;</div><div class="line">		<span class="keyword">for</span> j := <span class="number">0</span>; j &lt; cells; j++ &#123;</div><div class="line">			ax, ay, r, g, b := corner(i+<span class="number">1</span>, j, min, max)</div><div class="line">			bx, by, r, g, b := corner(i, j, min, max)</div><div class="line">			cx, cy, r, g, b := corner(i, j+<span class="number">1</span>, min, max)</div><div class="line">			dx, dy, r, g, b := corner(i+<span class="number">1</span>, j+<span class="number">1</span>, min, max)</div><div class="line">			fmt.Printf(<span class="string">"&lt;polygon points='%g,%g %g,%g %g,%g %g,%g' fill='#%x%x%x'/&gt;\n"</span>,</div><div class="line">				ax, ay, bx, by, cx, cy, dx, dy, r, g, b)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	fmt.Println(<span class="string">"&lt;/svg&gt;"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">getColor</span><span class="params">(min, max, current <span class="keyword">float64</span>)</span> <span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	step := (max - min) / <span class="number">255</span></div><div class="line">	v := <span class="keyword">int</span>((current - min) / step)</div><div class="line">	r := v</div><div class="line">	g := <span class="number">0</span></div><div class="line">	b := <span class="number">255</span> - v</div><div class="line">	<span class="keyword">return</span> r, g, b</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">getMinMax</span><span class="params">()</span> <span class="params">(<span class="keyword">float64</span>, <span class="keyword">float64</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> min, max <span class="keyword">float64</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cells; i++ &#123;</div><div class="line">		<span class="keyword">for</span> j := <span class="number">0</span>; j &lt; cells; j++ &#123;</div><div class="line">			x := xyrange * (<span class="keyword">float64</span>(i)/cells - <span class="number">0.5</span>)</div><div class="line">			y := xyrange * (<span class="keyword">float64</span>(j)/cells - <span class="number">0.5</span>)</div><div class="line"></div><div class="line">			z := f(x, y)</div><div class="line">			<span class="keyword">if</span> z &lt; min &#123;</div><div class="line">				min = z</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> z &gt; max &#123;</div><div class="line">				max = z</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> min, max</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">corner</span><span class="params">(i, j <span class="keyword">int</span>, min, max <span class="keyword">float64</span>)</span> <span class="params">(<span class="keyword">float64</span>, <span class="keyword">float64</span>, <span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	x := xyrange * (<span class="keyword">float64</span>(i)/cells - <span class="number">0.5</span>)</div><div class="line">	y := xyrange * (<span class="keyword">float64</span>(j)/cells - <span class="number">0.5</span>)</div><div class="line"></div><div class="line">	z := f(x, y)</div><div class="line">	<span class="comment">// å°†(x,y,z)ç­‰è§’æŠ•å°„åˆ°äºŒç»´SVGç»˜å›¾å¹³é¢ä¸Š,åæ ‡æ˜¯(sx,sy)</span></div><div class="line">	sx := width/<span class="number">2</span> + (x-y)*cos30*xyscale</div><div class="line">	sy := height/<span class="number">2</span> + (x+y)*sin30*xyscale - z*zscale</div><div class="line">	r, g, b := getColor(min, max, z)</div><div class="line">	<span class="keyword">return</span> sx, sy, r, g, b</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(x <span class="keyword">float64</span>, y <span class="keyword">float64</span>)</span> <span class="title">float64</span></span> &#123;</div><div class="line">	r := math.Hypot(x, y)</div><div class="line">	<span class="keyword">return</span> math.Sin(r) / r</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ç»ƒä¹ 3-4"><a href="#ç»ƒä¹ 3-4" class="headerlink" title="ç»ƒä¹ 3.4"></a>ç»ƒä¹ 3.4</h4><p>ä»¿ç…§1.7èŠ‚çš„ç¤ºä¾‹Lissajousçš„æ–¹æ³•,æ„å»ºä¸€ä¸ªwebæœåŠ¡å™¨,è®¡ç®—å¹¶ç”Ÿæˆæ›²é¢,åŒæ—¶å°†svgæ•°æ®å†™å…¥å®¢æˆ·ç«¯.æœåŠ¡å™¨å¿…é¡»å¦‚ä¸‹è®¾ç½®Content-TypeæŠ¥å¤´ <code>w.Header().set(&quot;Content-Type&quot;,&quot;image/svg+xml&quot;)</code></p>
<ul>
<li>è¿™ä¸ªé—®é¢˜æ¯”è¾ƒç®€å•ï¼Œä½“ç°äº†Goçš„æ¥å£æ€ç»´ï¼Œå°†mainæ”¹æˆå‡½æ•°ï¼Œä¼ å…¥<code>io.Writer</code>æ¥å£ï¼Œå°†<code>fmt.Printf</code>æ”¹ä¸º<code>fmt.Fprintf</code>å°±å¯ä»¥äº†ï¼Œæœ€åwebè¯·æ±‚åŠ Headerè®©æµè§ˆå™¨è¯†åˆ«svg</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	handler := <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class="line">		w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"image/svg+xml"</span>)</div><div class="line">		image(w)</div><div class="line">	&#125;</div><div class="line">	http.HandleFunc(<span class="string">"/"</span>, handler)</div><div class="line">	log.Fatal(http.ListenAndServe(<span class="string">"localhost:8877"</span>, <span class="literal">nil</span>))</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ç»ƒä¹ 3-5"><a href="#ç»ƒä¹ 3-5" class="headerlink" title="ç»ƒä¹ 3.5"></a>ç»ƒä¹ 3.5</h4><p>ç”¨image.NewRGBAå‡½æ•°å’Œcolor.RGBAç±»å‹æˆ–color.YCbCrç±»å‹å®ç°ä¸€ä¸ªMandelbroté›†çš„å…¨å½©å›¾</p>
<ul>
<li>åˆæ˜¯ä¸€ä¸ªå›¾å½¢å­¦,ä¸€ç»´å˜é‡æœ€ç®€å•çš„æ–¹å¼æ˜¯R=G=B,æœ€åå‡ºæ¥ä¸€ä¸ªå¹³æ»‘å˜åŒ–çš„ç°åº¦å›¾ã€‚ä½œè€…è¦æ±‚å˜æˆå…¨å½©å›¾(å–‚ï¼å¤§å“¥ï¼Œæˆ‘æ˜¯æ¥å­¦Golangçš„ï¼Œä¸æ˜¯æ¥æå›¾å½¢å­¦çš„)ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“è¿™éœ€è¦ä»€ä¹ˆå›¾å½¢å­¦çŸ¥è¯†ğŸ˜•ï¼Œä¸è¿‡çœ‹åˆ°æœ‰äººç»™å‡ºäº†è¿™æ ·ä¸€ä¸ªçœ‹èµ·æ¥å¾ˆç®€å•ä¹Ÿç¬¦åˆé¢˜ç›®è¦æ±‚çš„å˜åŒ–</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">mandelbrot</span><span class="params">(z <span class="keyword">complex128</span>)</span> <span class="title">color</span>.<span class="title">Color</span></span> &#123;</div><div class="line">	<span class="keyword">const</span> iterations = <span class="number">200</span></div><div class="line">	<span class="keyword">const</span> contrast = <span class="number">15</span></div><div class="line"></div><div class="line">	<span class="keyword">var</span> v <span class="keyword">complex128</span></div><div class="line">	<span class="keyword">for</span> n := <span class="keyword">uint8</span>(<span class="number">0</span>); n &lt; iterations; n++ &#123;</div><div class="line">		v = v*v + z</div><div class="line">		<span class="keyword">if</span> cmplx.Abs(v) &gt; <span class="number">2</span> &#123;</div><div class="line">			v := <span class="number">255</span> - contrast*n</div><div class="line">			<span class="keyword">return</span> color.YCbCr&#123;v, <span class="number">255</span> - v, <span class="number">255</span>&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> color.Black</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;ç¬¬ä¸‰ç« &quot;&gt;&lt;a href=&quot;#ç¬¬ä¸‰ç« &quot; class=&quot;headerlink&quot; title=&quot;ç¬¬ä¸‰ç« &quot;&gt;&lt;/a&gt;ç¬¬ä¸‰ç« &lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;æ•´æ•°&lt;/li&gt;
&lt;li&gt;æµ®ç‚¹æ•°&lt;/li&gt;
&lt;li&gt;å¤æ•°&lt;/li&gt;
&lt;li&gt;å¸ƒå°”å€¼&lt;/li&gt;
&lt;li&gt;å­—ç¬¦ä¸²&lt;/li&gt;
&lt;li&gt;å¸¸é‡&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¿™ä¸€ç« é˜…è¯»ä½“éªŒå¾ˆå¥½ï¼Œå› ä¸ºä¹¦ä¸Šç»™çš„ç¤ºä¾‹å¾ˆç‚«é…·ï¼Œäº§ç”Ÿçš„ç»“æœæ˜¯ç‚«é…·çš„å›¾å½¢ï¼Œç„¶è€Œæƒ³è¦ç†è§£å´æŒºå¤´ç—›ï¼Œå› ä¸ºéœ€è¦ä¸€äº›åŸºç¡€çš„å›¾å½¢å­¦çŸ¥è¯†ï¼Œè¿™ç« ä¹ é¢˜åšå¾—æ¯”è¾ƒå¤´ç–¼ï¼Œä¸æ˜¯å› ä¸ºä»£ç é€»è¾‘ï¼Œè€Œæ˜¯å› ä¸ºâ€ä¸šåŠ¡é€»è¾‘â€&lt;br&gt;
    
    </summary>
    
      <category term="Goç¨‹åºè®¾è®¡è¯­è¨€" scheme="https://www.zoulei.net/categories/Go%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/"/>
    
    
  </entry>
  
  <entry>
    <title>Goç¨‹åºè®¾è®¡è¯­è¨€è¯¾åä¹ é¢˜ç­”æ¡ˆ-ç¬¬äºŒç« (ç¨‹åºç»“æ„)</title>
    <link href="https://www.zoulei.net/2018/06/05/the_go_programming_lang_usage_answer_2/"/>
    <id>https://www.zoulei.net/2018/06/05/the_go_programming_lang_usage_answer_2/</id>
    <published>2018-06-05T15:52:24.000Z</published>
    <updated>2018-06-05T23:52:21.886Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ç¬¬äºŒç« "><a href="#ç¬¬äºŒç« " class="headerlink" title="ç¬¬äºŒç« "></a>ç¬¬äºŒç« </h3><ul>
<li>åç§°</li>
<li>å£°æ˜</li>
<li>å˜é‡</li>
<li>èµ‹å€¼</li>
<li>ç±»å‹å£°æ˜</li>
<li>åŒ…å’Œæ–‡ä»¶</li>
<li>ä½œç”¨åŸŸ</li>
</ul>
<a id="more"></a>
<h4 id="ç»ƒä¹ 2-1"><a href="#ç»ƒä¹ 2-1" class="headerlink" title="ç»ƒä¹ 2.1:"></a>ç»ƒä¹ 2.1:</h4><p>æ·»åŠ ç±»å‹ã€å¸¸é‡å’Œå‡½æ•°åˆ°tempconvåŒ…ä¸­ï¼Œå¤„ç†ä»¥å¼€å°”æ–‡ä¸ºå•ä½(K)çš„æ¸©åº¦å€¼,0K=-273.15â„ƒ,å˜åŒ–1Kå’Œå˜åŒ–1â„ƒæ˜¯ç­‰ä»·çš„</p>
<ul>
<li>å¾ˆæ°´çš„é¢˜</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> tempconv</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> Kelvin <span class="keyword">float64</span></div><div class="line"><span class="keyword">type</span> Celsius <span class="keyword">float64</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(k Kelvin)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">"%gK"</span>, k)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">CToK</span><span class="params">(c Celsius)</span> <span class="title">Kelvin</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> Kelvin(c - <span class="number">273.15</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">KToC</span><span class="params">(k Kelvin)</span> <span class="title">Celsius</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> Celsius(k + <span class="number">273.15</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="ç»ƒä¹ 2-2"><a href="#ç»ƒä¹ 2-2" class="headerlink" title="ç»ƒä¹ 2.2"></a>ç»ƒä¹ 2.2</h5><p>å†™ä¸€ä¸ªç±»ä¼¼äºcfçš„é€šç”¨çš„å•ä½è½¬æ¢ç¨‹åº,ä»å‘½ä»¤è¡Œå‚æ•°æˆ–è€…æ ‡å‡†è¾“å…¥(å¦‚æœæ²¡æœ‰å‚æ•°)è·å–æ•°å­—,ç„¶åå°†æ¯ä¸€ä¸ªæ•°å­—è½¬æ¢ä¸ºä»¥æ‘„æ°æ¸©åº¦å’Œåæ°æ¸©åº¦è¡¨ç¤ºçš„æ¸©åº¦,ä»¥è‹±å¯¸å’Œç±³è¡¨ç¤ºçš„é•¿åº¦å•ä½,ä»¥ç£…å’Œåƒå…‹è¡¨ç¤ºçš„é‡é‡å•ä½,ç­‰ç­‰</p>
<ul>
<li>ç•¥ï¼ŒåŒå¾ˆæ°´</li>
</ul>
<h4 id="ç»ƒä¹ 2-3"><a href="#ç»ƒä¹ 2-3" class="headerlink" title="ç»ƒä¹ 2.3:"></a>ç»ƒä¹ 2.3:</h4><p>ä½¿ç”¨å¾ªç¯é‡å†™PopCountæ¥ä»£æ›¿å•ä¸ªè¡¨è¾¾å¼.å¯¹æ¯”ä¸¤ä¸ªç‰ˆæœ¬çš„æ•ˆç‡</p>
<ul>
<li>ä¸‹é¢è¿ç»­ä¸‰é“é¢˜éƒ½æ˜¯ç»å…¸é¢è¯•é¢˜ï¼Œæ±‚äºŒè¿›åˆ¶æ•°ä¸­1çš„ä¸ªæ•°ï¼Œé™å®šäº†æ­£æ•´æ•°</li>
<li>ä¹¦ä¸Šçš„ä»£ç ä¸»è¦æ˜¯é¢„å…ˆè®¡ç®—,å°†64bitæ¯8bitä¸€ç»„,8bitä¼šæœ‰äºŒçš„å…«æ¬¡æ–¹ç§ç»“æœï¼Œå…±256ç§ç»“æœï¼Œå°†æ‰€æœ‰çš„ç»“æœéƒ½å…ˆè®¡ç®—å‡ºæ¥(ç©ºé—´æ¢æ—¶é—´)</li>
<li>é¢„è®¡ç®—ä¸»è¦æ˜¯è¿™ä¸€æ­¥<code>pc[i] = pc[i/2] + byte(i&amp;1)</code>ï¼Œæ³¨æ„æ­¤å¤„çš„å«ä¹‰æ˜¯é™¤ä»¥äºŒè¡¨ç¤ºäºŒè¿›åˆ¶æ•°å³ç§»ä¸€ä½ï¼Œåé¢è¡¨ç¤ºæœ€åä¸€ä½æ˜¯1è¿˜æ˜¯0</li>
<li>ä»£ç ä¸­<code>[256]byte</code>æ¢æˆ<code>[256]int</code>ï¼Œæ›´å¥½ç†è§£ã€‚å¯èƒ½è¿™æ ·å†™åªæ˜¯ä¸ºäº†è®©äººæ›´åŠ èƒ½ææ˜ç™½byteå’Œintçš„å„ç§è½¬æ¢å§</li>
<li>æ³¨æ„è¿™ç§é¢„è®¡ç®—çš„æ‰§è¡Œæ•ˆç‡æ˜¯å¾ˆé«˜çš„</li>
</ul>
<p>ä¹¦ä¸Šç»™çš„ä»£ç è¿˜æ˜¯æ¯”è¾ƒæ‰­æ›²çš„<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 2000000000	         0.32 ns/op</span></div><div class="line"><span class="keyword">package</span> tempconv</div><div class="line"></div><div class="line"><span class="keyword">var</span> pc [<span class="number">256</span>]<span class="keyword">byte</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> pc &#123;</div><div class="line">		pc[i] = pc[i/<span class="number">2</span>] + <span class="keyword">byte</span>(i&amp;<span class="number">1</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">PopCount</span><span class="params">(x <span class="keyword">uint64</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">int</span>(pc[<span class="keyword">byte</span>(x&gt;&gt;(<span class="number">0</span>*<span class="number">8</span>))] +</div><div class="line">		pc[<span class="keyword">byte</span>(x&gt;&gt;(<span class="number">1</span>*<span class="number">8</span>))] +</div><div class="line">		pc[<span class="keyword">byte</span>(x&gt;&gt;(<span class="number">2</span>*<span class="number">8</span>))] +</div><div class="line">		pc[<span class="keyword">byte</span>(x&gt;&gt;(<span class="number">3</span>*<span class="number">8</span>))] +</div><div class="line">		pc[<span class="keyword">byte</span>(x&gt;&gt;(<span class="number">4</span>*<span class="number">8</span>))] +</div><div class="line">		pc[<span class="keyword">byte</span>(x&gt;&gt;(<span class="number">5</span>*<span class="number">8</span>))] +</div><div class="line">		pc[<span class="keyword">byte</span>(x&gt;&gt;(<span class="number">6</span>*<span class="number">8</span>))] +</div><div class="line">		pc[<span class="keyword">byte</span>(x&gt;&gt;(<span class="number">7</span>*<span class="number">8</span>))])</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ”¹æˆå¾ªç¯</p>
<ul>
<li>æƒŠä¸æƒŠå–œï¼Œæ„ä¸æ„å¤–ï¼Œé€Ÿåº¦å±…ç„¶çˆ†é™ä½100å€</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">PopCount1</span><span class="params">(x <span class="keyword">uint64</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	ret := <span class="keyword">byte</span>(<span class="number">0</span>)</div><div class="line">	<span class="keyword">for</span> i := <span class="keyword">uint8</span>(<span class="number">0</span>); i &lt; <span class="number">8</span>; i++ &#123;</div><div class="line">		ret += pc[<span class="keyword">byte</span>(x&gt;&gt;(i*<span class="number">8</span>))]</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">int</span>(ret)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkPopCount1</span><span class="params">(b *testing.B)</span></span> &#123;</div><div class="line">	<span class="comment">// 100000000	        21.4 ns/op</span></div><div class="line">	<span class="comment">// å¾ªç¯</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</div><div class="line">		PopCount1(<span class="number">2</span>&lt;&lt;<span class="number">63</span> - <span class="number">1</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ç»ƒä¹ 2-4"><a href="#ç»ƒä¹ 2-4" class="headerlink" title="ç»ƒä¹ 2.4"></a>ç»ƒä¹ 2.4</h4><p>å†™ä¸€ä¸ªç”¨äºç»Ÿè®¡ä½çš„PopCount,å®ƒåœ¨å…¶å®é™…å‚æ•°çš„64ä½ä¸Šæ‰§è¡Œç§»ä½æ“ä½œ,æ¯æ¬¡åˆ¤æ–­æœ€å³è¾¹çš„ä½,è¿›è€Œå®ç°ç»Ÿè®¡åŠŸèƒ½.æŠŠå®ƒä¸å¿«æŸ¥è¡¨ç‰ˆæœ¬çš„æ€§èƒ½è¿›è¡Œå¯¹æ¯”</p>
<ul>
<li>å¾ˆæ™®é€šçš„å†™æ³•</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">PopCount2</span><span class="params">(x <span class="keyword">uint64</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	ret := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">64</span>; i++ &#123;</div><div class="line">		<span class="keyword">if</span> x&amp;<span class="number">1</span> == <span class="number">1</span> &#123;</div><div class="line">			ret += <span class="number">1</span></div><div class="line">		&#125;</div><div class="line">		x = x &gt;&gt; <span class="number">1</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> ret</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkPopCount2</span><span class="params">(b *testing.B)</span></span> &#123;</div><div class="line">	<span class="comment">// 20000000	        60.5 ns/op</span></div><div class="line">	<span class="comment">// &gt;&gt; å¾ªç¯</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</div><div class="line">		PopCount2(<span class="number">2</span>&lt;&lt;<span class="number">63</span> - <span class="number">1</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ç»ƒä¹ 2-5"><a href="#ç»ƒä¹ 2-5" class="headerlink" title="ç»ƒä¹ 2.5"></a>ç»ƒä¹ 2.5</h4><p>ä½¿ç”¨x&amp;(x-1)å¯ä»¥æ¸…é™¤xæœ€å³è¾¹çš„éé›¶ä½,åˆ©ç”¨è¯¥ç‰¹ç‚¹å†™ä¸€ä¸ªPopCount,ç„¶åè¯„ä»·å®ƒçš„æ€§èƒ½</p>
<ul>
<li>x&amp;(x-1)é¢è¯•åŸºç¡€é¢˜</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">PopCount3</span><span class="params">(x <span class="keyword">uint64</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	ret := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> x != <span class="number">0</span> &#123;</div><div class="line">		x = (x - <span class="number">1</span>) &amp; x</div><div class="line">		ret += <span class="number">1</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> ret</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkPopCount3</span><span class="params">(b *testing.B)</span></span> &#123;</div><div class="line">	<span class="comment">// 30000000	        50.5 ns/op</span></div><div class="line">	<span class="comment">// x&amp;(x-1)</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</div><div class="line">		PopCount3(<span class="number">2</span>&lt;&lt;<span class="number">63</span> - <span class="number">1</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€å~~~è¿˜æ˜¯æŒºå¥‡è‘©ï¼Œä¹¦ä¸Šçš„å†™æ³•å±…ç„¶æ˜¯æœ€å¿«çš„ï¼Œæ”¹æˆå¾ªç¯é€Ÿåº¦å±…ç„¶çˆ†é™ï¼Œä¹Ÿä¸çŸ¥é“Goç¼–è¯‘å™¨æ˜¯å¦‚ä½•ä¼˜åŒ–ä»£ç çš„â•­(â•¯^â•°)â•®</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;ç¬¬äºŒç« &quot;&gt;&lt;a href=&quot;#ç¬¬äºŒç« &quot; class=&quot;headerlink&quot; title=&quot;ç¬¬äºŒç« &quot;&gt;&lt;/a&gt;ç¬¬äºŒç« &lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;åç§°&lt;/li&gt;
&lt;li&gt;å£°æ˜&lt;/li&gt;
&lt;li&gt;å˜é‡&lt;/li&gt;
&lt;li&gt;èµ‹å€¼&lt;/li&gt;
&lt;li&gt;ç±»å‹å£°æ˜&lt;/li&gt;
&lt;li&gt;åŒ…å’Œæ–‡ä»¶&lt;/li&gt;
&lt;li&gt;ä½œç”¨åŸŸ&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="Goç¨‹åºè®¾è®¡è¯­è¨€" scheme="https://www.zoulei.net/categories/Go%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/"/>
    
    
  </entry>
  
  <entry>
    <title>Goç¨‹åºè®¾è®¡è¯­è¨€è¯¾åä¹ é¢˜ç­”æ¡ˆ-ç¬¬ä¸€ç« (å…¥é—¨)</title>
    <link href="https://www.zoulei.net/2018/06/03/the_go_programming_language_answer_1/"/>
    <id>https://www.zoulei.net/2018/06/03/the_go_programming_language_answer_1/</id>
    <published>2018-06-03T12:56:37.000Z</published>
    <updated>2018-06-04T14:15:32.894Z</updated>
    
    <content type="html"><![CDATA[<p>ä½œä¸ºä¸€ä¸ªåˆå­¦è€…è¶…çº§å–œæ¬¢è¿™æœ¬ä¹¦ï¼Œå€¼å¾—åå¤é˜…è¯»ï¼Œå¸¸è¯»å¸¸æ–°ã€‚å› ä¸ºè¯»äº†å¥½å¤šæ—¶é—´äº†ï¼Œå› æ­¤æœ‰ä¸€ä¸ªè®¡åˆ’æŠŠè¯¾åä¹ é¢˜å…¨éƒ¨åšå®Œï¼Œæ¯å¤©åšäº”é¢˜~~</p>
<p>Golangç‰ˆæœ¬:1.10.1<br>IDE: GoLand<br>æ“ä½œç³»ç»Ÿ: 10.13.4</p>
<a id="more"></a>
<h4 id="ç»ƒä¹ 1-1"><a href="#ç»ƒä¹ 1-1" class="headerlink" title="ç»ƒä¹ 1.1"></a>ç»ƒä¹ 1.1</h4><p>ä¿®æ”¹echoç¨‹åºè¾“å‡ºos.Args[0],å³å‘½ä»¤çš„åå­—</p>
<ul>
<li><code>os.Args</code>æ˜¯ä¸€ä¸ªslice</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestOutputName</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">	fmt.Println(os.Args[<span class="number">0</span>])</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ç»ƒä¹ 1-2"><a href="#ç»ƒä¹ 1-2" class="headerlink" title="ç»ƒä¹ 1.2"></a>ç»ƒä¹ 1.2</h4><p>ä¿®æ”¹echoç¨‹åº,è¾“å‡ºå‚æ•°çš„ç´¢å¼•å’Œå€¼,æ¯è¡Œä¸€ä¸ª</p>
<ul>
<li><code>for range</code>ç»“æ„çš„ä½¿ç”¨</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestListArgs</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> os.Args &#123;</div><div class="line">		fmt.Printf(<span class="string">"%d\t%s\n"</span>, k, v)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ç»ƒä¹ 1-3"><a href="#ç»ƒä¹ 1-3" class="headerlink" title="ç»ƒä¹ 1.3"></a>ç»ƒä¹ 1.3</h4><p>å°è¯•æµ‹é‡å¯èƒ½ä½æ•ˆçš„ç¨‹åºå’Œä½¿ç”¨strings.Joinçš„ç¨‹åºåœ¨æ‰§è¡Œæ—¶é—´ä¸Šçš„å·®å¼‚</p>
<ul>
<li>è¯¥ç”¨ä¾‹å¤§æ¦‚æ˜¾ç¤ºç›¸æ¯”<code>+=</code>,ä½¿ç”¨strings.Joinè¦å¿«1782å€</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkStringJoin1</span><span class="params">(b *testing.B)</span></span> &#123;</div><div class="line">	<span class="comment">// 1	1581441327 ns/op</span></div><div class="line">	<span class="keyword">var</span> a [<span class="number">100000</span>]<span class="keyword">string</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++ &#123;</div><div class="line">		a[i] = <span class="string">"1"</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</div><div class="line">		<span class="keyword">var</span> ret <span class="keyword">string</span></div><div class="line">		<span class="keyword">for</span> _, i := <span class="keyword">range</span> a &#123;</div><div class="line">			ret += i</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkStringJoin2</span><span class="params">(b *testing.B)</span></span> &#123;</div><div class="line">	<span class="comment">// 2000	    844351 ns/op</span></div><div class="line">	<span class="keyword">var</span> a [<span class="number">100000</span>]<span class="keyword">string</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++ &#123;</div><div class="line">		a[i] = <span class="string">"1"</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</div><div class="line">		_ = strings.Join(a[:], <span class="string">""</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ç»ƒä¹ 1-4"><a href="#ç»ƒä¹ 1-4" class="headerlink" title="ç»ƒä¹ 1.4"></a>ç»ƒä¹ 1.4</h4><p>ä¿®æ”¹dup2ç¨‹åº,è¾“å‡ºå‡ºç°é‡å¤è¡Œçš„æ–‡ä»¶çš„åç§°</p>
<ul>
<li>ç”¨ç»“æ„ä½“ä»£æ›¿åŸæœ‰çš„stringç±»å‹</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"os"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"bufio"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> line <span class="keyword">struct</span> &#123;</div><div class="line">	FileName <span class="keyword">string</span></div><div class="line">	String   <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	counts := <span class="built_in">make</span>(<span class="keyword">map</span>[line]<span class="keyword">int</span>)</div><div class="line">	files := os.Args[<span class="number">1</span>:]</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(files) == <span class="number">0</span> &#123;</div><div class="line">		countLines(os.Stdin, counts, <span class="string">"ARGS"</span>)</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">for</span> _, arg := <span class="keyword">range</span> files &#123;</div><div class="line">			f, err := os.Open(arg)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				fmt.Fprintf(os.Stderr, <span class="string">"dup2: %v\n"</span>, err)</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">			countLines(f, counts, f.Name())</div><div class="line">			f.Close()</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> line, n := <span class="keyword">range</span> counts &#123;</div><div class="line">		<span class="keyword">if</span> n &gt; <span class="number">1</span> &#123;</div><div class="line">			fmt.Printf(<span class="string">"%s\t%s\t%d\n"</span>, line.FileName, line.String, n)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">countLines</span><span class="params">(file *os.File, counts <span class="keyword">map</span>[line]<span class="keyword">int</span>, fileName <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	input := bufio.NewScanner(file)</div><div class="line">	<span class="keyword">for</span> input.Scan() &#123;</div><div class="line">		counts[line&#123;</div><div class="line">			FileName: fileName,</div><div class="line">			String:   input.Text(),</div><div class="line">		&#125;]++</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure>
<h4 id="ç»ƒä¹ 1-5"><a href="#ç»ƒä¹ 1-5" class="headerlink" title="ç»ƒä¹ 1.5"></a>ç»ƒä¹ 1.5</h4><p>æ”¹å˜åˆ©è¨å¦‚ç¨‹åºçš„ç”»æ¿é¢œè‰²ä¸ºç»¿è‰²é»‘åº•æ¥å¢åŠ çœŸå®æ€§ã€‚ä½¿ç”¨color.RGBA{0xRR,0xGG,0xBB,0xff}åˆ›å»ºä¸€ç§webé¢œè‰²#RRGGBB,æ¯ä¸€å¯¹åå…­è¿›åˆ¶æ•°ç»„è¡¨ç¤ºç»„æˆä¸€ä¸ªåƒç´ çº¢ã€ç»¿ã€è“åˆ†é‡çš„äº®åº¦ã€‚</p>
<ul>
<li>ç”»æ¿åº•è‰²ä¸ºpaletteçš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå¯é‡‡ç”¨<code>0x</code>è¡¨ç¤ºåå…­è¿›åˆ¶æ•°å­—</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"image/color"</span></div><div class="line">	<span class="string">"math/rand"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line">	<span class="string">"os"</span></div><div class="line">	<span class="string">"net/http"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"io"</span></div><div class="line">	<span class="string">"image/gif"</span></div><div class="line">	<span class="string">"image"</span></div><div class="line">	<span class="string">"math"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> palette = []color.Color&#123;color.Black, color.RGBA&#123;</div><div class="line">	R: <span class="number">0</span>,</div><div class="line">	G: <span class="number">0xFF</span>,</div><div class="line">	B: <span class="number">0</span>,</div><div class="line">	A: <span class="number">0xFF</span>,</div><div class="line">&#125;&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	rand.Seed(time.Now().UTC().UnixNano())</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(os.Args) &gt; <span class="number">1</span> &amp;&amp; os.Args[<span class="number">1</span>] == <span class="string">"web"</span> &#123;</div><div class="line">		handler := <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class="line">			lissajous(w)</div><div class="line">		&#125;</div><div class="line">		http.HandleFunc(<span class="string">"/"</span>, handler)</div><div class="line">		log.Fatal(http.ListenAndServe(<span class="string">"localhost:8000"</span>, <span class="literal">nil</span>))</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	lissajous(os.Stdout)</div><div class="line"></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">lissajous</span><span class="params">(out io.Writer)</span></span> &#123;</div><div class="line">	<span class="keyword">const</span> (</div><div class="line">		cycles  = <span class="number">5</span>     <span class="comment">// å®Œæ•´çš„xæŒ¯è¡å™¨å˜åŒ–çš„ä¸ªæ•°</span></div><div class="line">		res     = <span class="number">0.001</span> <span class="comment">//	è§’åº¦åˆ†è¾¨ç‡</span></div><div class="line">		size    = <span class="number">100</span>   <span class="comment">//	å›¾åƒç”»å¸ƒåŒ…å« [-size..+size]</span></div><div class="line">		nframes = <span class="number">64</span>    <span class="comment">//	åŠ¨ç”»ä¸­çš„å¸§æ•°</span></div><div class="line">		delay   = <span class="number">8</span>     <span class="comment">//	ä»¥10msä¸ºå•ä½çš„å¸§é—´å»¶è¿Ÿ</span></div><div class="line">	)</div><div class="line">	freq := rand.Float64() * <span class="number">3.0</span> <span class="comment">// yæŒ¯è¡å™¨çš„ç›¸å¯¹é¢‘ç‡</span></div><div class="line">	anim := gif.GIF&#123;LoopCount: nframes&#125;</div><div class="line">	phase := <span class="number">0.0</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; nframes; i++ &#123;</div><div class="line">		rect := image.Rect(<span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>*size+<span class="number">1</span>, <span class="number">2</span>*size+<span class="number">1</span>)</div><div class="line">		img := image.NewPaletted(rect, palette)</div><div class="line">		<span class="keyword">for</span> t := <span class="number">0.0</span>; t &lt; cycles*<span class="number">2</span>*math.Pi; t += res &#123;</div><div class="line">			x := math.Sin(t)</div><div class="line">			y := math.Sin(t*freq + phase)</div><div class="line">			img.SetColorIndex(size+<span class="keyword">int</span>(x*size+<span class="number">0.5</span>), size+<span class="keyword">int</span>(y*size+<span class="number">0.5</span>), <span class="number">1</span>)</div><div class="line">		&#125;</div><div class="line">		phase += <span class="number">0.1</span></div><div class="line">		anim.Delay = <span class="built_in">append</span>(anim.Delay, delay)</div><div class="line">		anim.Image = <span class="built_in">append</span>(anim.Image, img)</div><div class="line">	&#125;</div><div class="line">	gif.EncodeAll(out, &amp;anim)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ç»ƒä¹ 1-6"><a href="#ç»ƒä¹ 1-6" class="headerlink" title="ç»ƒä¹ 1.6"></a>ç»ƒä¹ 1.6</h4><p>é€šè¿‡åœ¨ç”»æ¿ä¸­æ·»åŠ æ›´å¤šé¢œè‰²ï¼Œç„¶åé€šè¿‡æœ‰è¶£çš„æ–¹å¼æ”¹å˜SetColorIndexçš„ç¬¬ä¸‰ä¸ªå‚æ•°,ä¿®æ”¹åˆ©è¨å¦‚ç¨‹åºæ¥äº§ç”Ÿå¤šå½©çš„å›¾ç‰‡</p>
<ul>
<li>æ²¡æƒ³åˆ°ä»€ä¹ˆæœ‰è¶£çš„æ–¹å¼ï¼Œéšä¾¿ç”¨äº†ä¸ªéšæœºç”Ÿæˆï¼Œ<code>rand.Intn</code>,æ³¨æ„initåœ¨mainå‰é¢è¢«æ‰§è¡Œï¼Œå› æ­¤éšæœºç§å­éœ€è¦æ”¾åœ¨inité‡Œé¢</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"image/color"</span></div><div class="line">	<span class="string">"math/rand"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line">	<span class="string">"os"</span></div><div class="line">	<span class="string">"net/http"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"io"</span></div><div class="line">	<span class="string">"image/gif"</span></div><div class="line">	<span class="string">"image"</span></div><div class="line">	<span class="string">"math"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> palette []color.Color</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">	rand.Seed(time.Now().UTC().UnixNano())</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">256</span>; i++ &#123;</div><div class="line">		palette = <span class="built_in">append</span>(palette, color.RGBA&#123;</div><div class="line">			R: <span class="keyword">uint8</span>(rand.Intn(<span class="number">256</span>)),</div><div class="line">			G: <span class="keyword">uint8</span>(rand.Intn(<span class="number">256</span>)),</div><div class="line">			B: <span class="keyword">uint8</span>(rand.Intn(<span class="number">256</span>)),</div><div class="line">			A: <span class="number">0xFF</span>,</div><div class="line">		&#125;)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(os.Args) &gt; <span class="number">1</span> &amp;&amp; os.Args[<span class="number">1</span>] == <span class="string">"web"</span> &#123;</div><div class="line">		handler := <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class="line">			lissajous(w)</div><div class="line">		&#125;</div><div class="line">		http.HandleFunc(<span class="string">"/"</span>, handler)</div><div class="line">		log.Fatal(http.ListenAndServe(<span class="string">"localhost:8000"</span>, <span class="literal">nil</span>))</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	lissajous(os.Stdout)</div><div class="line"></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">lissajous</span><span class="params">(out io.Writer)</span></span> &#123;</div><div class="line">	<span class="keyword">const</span> (</div><div class="line">		cycles  = <span class="number">5</span>     <span class="comment">// å®Œæ•´çš„xæŒ¯è¡å™¨å˜åŒ–çš„ä¸ªæ•°</span></div><div class="line">		res     = <span class="number">0.001</span> <span class="comment">//	è§’åº¦åˆ†è¾¨ç‡</span></div><div class="line">		size    = <span class="number">100</span>   <span class="comment">//	å›¾åƒç”»å¸ƒåŒ…å« [-size..+size]</span></div><div class="line">		nframes = <span class="number">64</span>    <span class="comment">//	åŠ¨ç”»ä¸­çš„å¸§æ•°</span></div><div class="line">		delay   = <span class="number">8</span>     <span class="comment">//	ä»¥10msä¸ºå•ä½çš„å¸§é—´å»¶è¿Ÿ</span></div><div class="line">	)</div><div class="line">	freq := rand.Float64() * <span class="number">3.0</span> <span class="comment">// yæŒ¯è¡å™¨çš„ç›¸å¯¹é¢‘ç‡</span></div><div class="line">	anim := gif.GIF&#123;LoopCount: nframes&#125;</div><div class="line">	phase := <span class="number">0.0</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; nframes; i++ &#123;</div><div class="line">		rect := image.Rect(<span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>*size+<span class="number">1</span>, <span class="number">2</span>*size+<span class="number">1</span>)</div><div class="line">		img := image.NewPaletted(rect, palette)</div><div class="line">		<span class="keyword">for</span> t := <span class="number">0.0</span>; t &lt; cycles*<span class="number">2</span>*math.Pi; t += res &#123;</div><div class="line">			x := math.Sin(t)</div><div class="line">			y := math.Sin(t*freq + phase)</div><div class="line">			img.SetColorIndex(size+<span class="keyword">int</span>(x*size+<span class="number">0.5</span>), size+<span class="keyword">int</span>(y*size+<span class="number">0.5</span>), <span class="keyword">uint8</span>(rand.Intn(<span class="built_in">len</span>(palette))))</div><div class="line">		&#125;</div><div class="line">		phase += <span class="number">0.1</span></div><div class="line">		anim.Delay = <span class="built_in">append</span>(anim.Delay, delay)</div><div class="line">		anim.Image = <span class="built_in">append</span>(anim.Image, img)</div><div class="line">	&#125;</div><div class="line">	gif.EncodeAll(out, &amp;anim)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ç»ƒä¹ 1-7"><a href="#ç»ƒä¹ 1-7" class="headerlink" title="ç»ƒä¹ 1.7"></a>ç»ƒä¹ 1.7</h4><p>å‡½æ•°io.Copy(dst,src)ä»srcè¯»,å¹¶ä¸”å†™å…¥dst.ä½¿ç”¨å®ƒä»£æ›¿ioutil.ReadAllæ¥å¤åˆ¶å“åº”å†…å®¹åˆ°os.StdOut,è¿™æ ·ä¸éœ€è¦è£…ä¸‹æ•´ä¸ªæ•°æ®æµçš„ç¼“å†²åŒº.ç¡®ä¿æ£€æŸ¥io.Copyè¿”å›çš„é”™è¯¯ç»“æœ</p>
<ul>
<li>io.Copyä»£æ›¿ioutil.ReadAllæ›´çœå†…å­˜ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æŠŠå®ƒçœ‹åšæ˜¯ä¸€ä¸ªåŒæ­¥çš„æ“ä½œï¼Œè¿”å›äº†æœ€ç»ˆä¼ è¾“æ•°æ®çš„å¤§å°</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"time"</span></div><div class="line">	<span class="string">"os"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"net/http"</span></div><div class="line">	<span class="string">"io"</span></div><div class="line">	<span class="string">"io/ioutil"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	start := time.Now()</div><div class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</div><div class="line">	<span class="keyword">for</span> _, url := <span class="keyword">range</span> os.Args[<span class="number">1</span>:] &#123;</div><div class="line">		<span class="keyword">go</span> fetch(url, ch)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> <span class="keyword">range</span> os.Args[<span class="number">1</span>:] &#123;</div><div class="line">		fmt.Println(&lt;-ch)</div><div class="line">	&#125;</div><div class="line">	fmt.Printf(<span class="string">"%.2f elapsed\n"</span>, time.Since(start).Seconds())</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">fetch</span><span class="params">(url <span class="keyword">string</span>, ch <span class="keyword">chan</span>&lt;- <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	start := time.Now()</div><div class="line">	resp, err := http.Get(url)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		ch &lt;- fmt.Sprint(err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	nbytes, err := io.Copy(ioutil.Discard, resp.Body)</div><div class="line">	resp.Body.Close()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		ch &lt;- fmt.Sprintf(<span class="string">"while reading %s: %v"</span>, url, err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	secs := time.Since(start).Seconds()</div><div class="line">	ch &lt;- fmt.Sprintf(<span class="string">"%.2fs %7d %s"</span>, secs, nbytes, url)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ç»ƒä¹ 1-8"><a href="#ç»ƒä¹ 1-8" class="headerlink" title="ç»ƒä¹ 1.8"></a>ç»ƒä¹ 1.8</h4><p>ä¿®æ”¹fetchç¨‹åºæ·»åŠ ä¸€ä¸ª<a href="http://å‰ç¼€(å‡å¦‚è¯¥URLå‚æ•°ç¼ºå¤±åè®®å‰ç¼€).å¯èƒ½ä¼šç”¨åˆ°strings.HasPrefix">http://å‰ç¼€(å‡å¦‚è¯¥URLå‚æ•°ç¼ºå¤±åè®®å‰ç¼€).å¯èƒ½ä¼šç”¨åˆ°strings.HasPrefix</a></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestAddPrefix</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">	inputURL := <span class="string">"z.cn"</span></div><div class="line">	<span class="keyword">if</span> ! strings.HasPrefix(inputURL, <span class="string">"http"</span>) &#123;</div><div class="line">		inputURL = <span class="string">"http://"</span> + inputURL</div><div class="line">	&#125;</div><div class="line">	fmt.Println(inputURL)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ç»ƒä¹ 1-9"><a href="#ç»ƒä¹ 1-9" class="headerlink" title="ç»ƒä¹ 1.9"></a>ç»ƒä¹ 1.9</h4><p>ä¿®æ”¹fetchæ¥è¾“å‡ºhttpçŠ¶æ€ç ,å¯ä»¥åœ¨resp.Statusä¸­æ‰¾åˆ°å®ƒ</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestOutputStatusCode</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">	resp, _ := http.Get(<span class="string">"http://z.cn"</span>)</div><div class="line">	fmt.Println(<span class="string">"StatusCode: "</span>, resp.StatusCode)</div><div class="line">	io.Copy(os.Stdout, resp.Body)</div><div class="line">	resp.Body.Close()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ç»ƒä¹ 1-10"><a href="#ç»ƒä¹ 1-10" class="headerlink" title="ç»ƒä¹ 1.10"></a>ç»ƒä¹ 1.10</h4><p>æ‰¾ä¸€ä¸ªäº§ç”Ÿå¤§é‡æ•°æ®çš„ç½‘ç«™.è¿ç»­ä¸¤æ¬¡è¿è¡Œfetchall,çœ‹æŠ¥å‘Šçš„æ—¶é—´æ˜¯å¦ä¼šæœ‰å¤§çš„å˜åŒ–,è°ƒæŸ¥ç¼“å­˜æƒ…å†µ.æ¯ä¸€æ¬¡è·å–çš„å†…å®¹ä¸€æ ·å—?ä¿®æ”¹fetchallå°†å†…å®¹è¾“å‡ºåˆ°æ–‡ä»¶,è¿™æ ·å¯ä»¥æ£€æŸ¥å®ƒæ˜¯å¦ä¸€è‡´</p>
<ul>
<li>è¿™é—®é¢˜ä¸æ˜¯ä»–å‚»å°±æ˜¯æˆ‘å‚»ï¼Œæˆ‘è¿˜æ˜¯åå‘æ˜¯ä»–å‚»ã€‚çŒœæµ‹æœ‰å¯èƒ½è¯´çš„æ˜¯è®¿é—®ç½‘ç«™ç¬¬ä¸€æ¬¡å¾ˆæ…¢ï¼Œç¬¬äºŒæ¬¡ä¼šå› ä¸ºç¼“å­˜ç­–ç•¥åŠ é€Ÿä¼ è¾“(æ¯”å¦‚httpè¿è¥å•†ç¼“å­˜å•¥çš„)ï¼Œäº¦æˆ–è€…æ˜¯æœ¬æœºç¼“å­˜304çŠ¶æ€ç (ä½†æ˜¯ä¸¤æ¬¡å®Œå…¨ç‹¬ç«‹çš„è®¿é—®å’Œè¿™ä¸ªæ‰¯ä¸ä¸Šä»€ä¹ˆå…³ç³»)</li>
</ul>
<h4 id="ç»ƒä¹ 1-11"><a href="#ç»ƒä¹ 1-11" class="headerlink" title="ç»ƒä¹ 1.11"></a>ç»ƒä¹ 1.11</h4><p>ä½¿ç”¨æ›´é•¿çš„å‚æ•°åˆ—è¡¨æ¥å°è¯•fetchall,ä¾‹å¦‚ä½¿ç”¨alexa.comæ’åå‰100ä¸‡çš„ç½‘ç«™,å¦‚æœä¸€ä¸ªç½‘ç«™æ²¡æœ‰å“åº”,ç¨‹åºçš„è¡Œä¸ºæ˜¯åˆ™ä¹ˆæ ·çš„</p>
<ul>
<li><a href="http://colobu.com/2016/07/01/the-complete-guide-to-golang-net-http-timeouts/">Go net/http è¶…æ—¶æœºåˆ¶å®Œå…¨æ‰‹å†Œ</a></li>
<li>è™½ç„¶æ¯ä¸ªURLéƒ½å¯¹åº”äº†ä¸€ä¸ªchanï¼Œä½†æ˜¯æœ‰å¯èƒ½æŸå‡ ä¸ªURLç‰¹åˆ«æ…¢ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„è¯·æ±‚éƒ½éœ€è¦ç­‰åˆ°æœ€æ…¢çš„é‚£ä¸ªå®Œæˆï¼Œæ¯”å¦‚ä½ åœ¨æœ¬åœ°<code>nc -l 8000</code>ç›‘å¬ç«¯å£ï¼Œå†ç›´æ¥ä½¿ç”¨<code>http.Get</code>è®¿é—®ã€‚å®ƒé»˜è®¤æ°¸ä¸è¶…æ—¶ï¼Œç›´åˆ°tcpè¿æ¥è¢«ä¸­æ–­</li>
<li>æ‰“å¼€å¤ªå¤šçš„é“¾æ¥ä¼šå¯ç”¨Nå¤šçš„goroutineï¼Œè¿™æ ·ä¼šè¾¾åˆ°ç³»ç»Ÿä¸Šé™ï¼Œæ¯”å¦‚è§¦å‘å¸¸è§çš„<code>too many open files</code></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä½œä¸ºä¸€ä¸ªåˆå­¦è€…è¶…çº§å–œæ¬¢è¿™æœ¬ä¹¦ï¼Œå€¼å¾—åå¤é˜…è¯»ï¼Œå¸¸è¯»å¸¸æ–°ã€‚å› ä¸ºè¯»äº†å¥½å¤šæ—¶é—´äº†ï¼Œå› æ­¤æœ‰ä¸€ä¸ªè®¡åˆ’æŠŠè¯¾åä¹ é¢˜å…¨éƒ¨åšå®Œï¼Œæ¯å¤©åšäº”é¢˜~~&lt;/p&gt;
&lt;p&gt;Golangç‰ˆæœ¬:1.10.1&lt;br&gt;IDE: GoLand&lt;br&gt;æ“ä½œç³»ç»Ÿ: 10.13.4&lt;/p&gt;
    
    </summary>
    
      <category term="Goç¨‹åºè®¾è®¡è¯­è¨€" scheme="https://www.zoulei.net/categories/Go%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/"/>
    
    
  </entry>
  
  <entry>
    <title>macä¸Šä½¿ç”¨mitmproxyå¯¹ios appè¿›è¡ŒæŠ“åŒ…</title>
    <link href="https://www.zoulei.net/2018/05/25/mitmproxy_transparent_model_network_capture/"/>
    <id>https://www.zoulei.net/2018/05/25/mitmproxy_transparent_model_network_capture/</id>
    <published>2018-05-25T09:45:59.000Z</published>
    <updated>2018-05-25T10:52:46.862Z</updated>
    
    <content type="html"><![CDATA[<p>å¯¹ios appæŠ“åŒ…çš„æ–¹å¼æŒºå¤šçš„ï¼Œæœ€å¸¸è§„çš„æ–¹æ¡ˆå°±æ˜¯æœ¬æœºå¼€å¯ä¸€ä¸ªhttpä»£ç†ã€‚ç„¶åæ‰‹æœºè¿›è¡Œè®¾ç½®ï¼Œå°†æœ¬æœºå†…ç½‘ipä»¥åŠç«¯å£è®¾ç½®ä¸Šå»ã€‚å®‰è£…ä¸€ä¸ªhttpsè¯ä¹¦ï¼Œè®¾ç½®ä¸ºä¿¡ä»»å°±å¯ä»¥å¼€å§‹æŠ“åŒ…äº†ã€‚è¿™ä¸ªæ–¹æ¡ˆéå¸¸é€šç”¨ã€‚ç±»ä¼¼çš„å®ç°ä»¥Fiddlerã€charlesä¸ºä»£è¡¨ï¼Œå®ƒä»¬ç¡®å®å¾ˆå¥½ç”¨ï¼Œä¹Ÿå¾ˆå¥½ç†è§£ã€‚ä½†æ˜¯ç¼ºç‚¹ä¹Ÿæ˜¯æœ‰çš„</p>
<ul>
<li>æœ€å¤§çš„ç¼ºç‚¹å°±æ˜¯æ¯ä¸€æ¬¡ä½¿ç”¨éƒ½éœ€è¦è®¾ç½®ä»£ç†ï¼Œä½ éœ€è¦æŸ¥çœ‹æœ¬æœºå†…ç½‘ipï¼Œç„¶åå¡«å†™åˆ°æ‰‹æœºä¸Šã€‚è°ƒè¯•å®Œæˆåå†å°†æ‰‹æœºçš„ä»£ç†è®¾ç½®æ¸…é™¤</li>
<li>Fiddleråªæœ‰windowsç‰ˆæœ¬å¯ç”¨ï¼Œæ„å‘³ç€macéœ€è¦ä½¿ç”¨è™šæ‹Ÿæœºï¼Œcharleså¹¶æ²¡æœ‰Fiddlerå¥½ç”¨ï¼Œç„¶è€Œè¿˜å–çš„è´¼è´µ</li>
</ul>
<p>åŒç±»å‹çš„å¼€æºæ–¹æ¡ˆæœ€å¸¸è§çš„æ˜¯Pythonå®ç°çš„mitmproxyã€‚mitmwebä¹Ÿæä¾›å›¾å½¢ç•Œé¢ï¼Œåˆ«è¯´ï¼Œåªè¦ä½ ä¸å«Œå¼ƒè¿˜æ˜¯æŒºå¥½ç”¨çš„</p>
<p>osxä¸Šè¿˜æœ‰ä¸ªæ¯”è¾ƒå¥‡è‘©çš„æ‰€è°“ç½‘ç»œè°ƒè¯•è½¯ä»¶Surgeã€‚99ç¾åˆ€ï¼Œå–çš„è¿˜æ˜¯æŒºè´µçš„ï¼ŒåŠŸèƒ½è¿˜è¡Œï¼Œç•Œé¢ä¹ŸæŒºèŠ±å“¨ï¼Œå¿½æ‚ å°ç™½æ˜¯è¶³å¤Ÿäº†ã€‚ç”¨å®ƒä¹Ÿèƒ½å¤Ÿè¿œç¨‹è°ƒè¯•ï¼Œä»£ä»·æ˜¯éœ€è¦ç”¨æœ‰çº¿è¿æ¥åˆ°macç”µè„‘ä¸Šï¼Œç„¶åmacç«¯è½¯ä»¶å°±èƒ½æ•è·è¿œç¨‹æ‰‹æœºçš„ç½‘ç»œè¯·æ±‚æ•°æ®ï¼Œè¿™ä¸ªè½¯ä»¶ç•Œé¢ç¡®å®æŒºä¸é”™ï¼Œç„¶è€Œè¯·æ±‚è¿‡æ»¤æŸ¥æ‰¾å¯¹æ¯”ä¸‹Fiddlerè€Œè¨€å°±æ˜¯ä¸ªæ¸£æ¸£å§ã€‚</p>
<p>å› æ­¤æƒ³äº†ä¸€ä¸ªæ¯”è¾ƒå¦ç±»çš„æ–¹æ¡ˆï¼Œæ‰‹æœºä½¿ç”¨macç”µè„‘çš„ç½‘ç»œï¼ŒåŒæ—¶ä½¿ç”¨pfå¯¹è¯·æ±‚è¿›è¡Œè½¬å‘ã€‚ä½¿ç”¨mitmproxyçš„é€æ˜ä»£ç†æ¨¡å¼è·å¾—æ‰‹æœºç«¯çš„æ•°æ®ï¼Œä½¿ç”¨mitmwebè¿›è¡Œå±•ç¤º</p>
<a id="more"></a>
<h3 id="æœ¬ç¯‡ç¯å¢ƒ"><a href="#æœ¬ç¯‡ç¯å¢ƒ" class="headerlink" title="æœ¬ç¯‡ç¯å¢ƒ"></a>æœ¬ç¯‡ç¯å¢ƒ</h3><ul>
<li>æœºå™¨ MBP 2015/ ipad mini</li>
<li>ç³»ç»Ÿ  osx 10.13/ ios 11.3</li>
</ul>
<h3 id="1-è®©ipadé€šè¿‡è“ç‰™è¿ä¸Šosxçš„ç½‘ç»œ"><a href="#1-è®©ipadé€šè¿‡è“ç‰™è¿ä¸Šosxçš„ç½‘ç»œ" class="headerlink" title="1. è®©ipadé€šè¿‡è“ç‰™è¿ä¸Šosxçš„ç½‘ç»œ"></a>1. è®©ipadé€šè¿‡è“ç‰™è¿ä¸Šosxçš„ç½‘ç»œ</h3><p>å‚ç…§<a href="https://www.zhihu.com/question/24480413">https://www.zhihu.com/question/24480413</a>ï¼Œå…ˆè®©æ‰‹æœºé€šè¿‡è“ç‰™è¿æ¥ä¸Šç”µè„‘ï¼Œåœ¨ç”µè„‘è®¾ç½®ç½‘ç»œå…±äº«ï¼Œé€‰æ‹©è“ç‰™çš„æ–¹å¼ï¼Œè¿™ä¸€æ­¥åŸºæœ¬å°±é…ç½®å¥½äº†</p>
<p>æ¥ä¸‹æ¥æ˜¯éªŒè¯ã€‚é€šè¿‡<code>ifconfig</code>å‘½ä»¤æŸ¥çœ‹ç›®å‰å­˜åœ¨å“ªäº›ç½‘ç»œæ¥å£ï¼ŒæŸ¥çœ‹activeçŠ¶æ€çš„æ¥å£ï¼Œè‡ªå·±æ’é™¤ä¸€ä¸‹ã€‚åƒæˆ‘çš„å°±æ˜¯<code>bridge100</code>ã€‚ç„¶åå¯ä»¥ä½¿ç”¨wiresharkçœ‹ä¸€ä¸‹è¿™ä¸ªç½‘ç»œæ¥å£æ˜¯å¦æ­£å¸¸æ”¶åˆ°äº†æ‰‹æœºç«¯çš„æ•°æ®è¯·æ±‚<code>sudo /Applications/Wireshark.app/Contents/MacOS/Wireshark</code>ã€‚å¾…èƒ½æ­£å¸¸é€šè¿‡ç”µè„‘ç½‘ç»œè®¿é—®åè¿›è¡Œåç»­æ“ä½œ</p>
<h3 id="é€šè¿‡PFå¯¹ç½‘ç»œæ•°æ®è¿›è¡Œè½¬å‘"><a href="#é€šè¿‡PFå¯¹ç½‘ç»œæ•°æ®è¿›è¡Œè½¬å‘" class="headerlink" title="é€šè¿‡PFå¯¹ç½‘ç»œæ•°æ®è¿›è¡Œè½¬å‘"></a>é€šè¿‡PFå¯¹ç½‘ç»œæ•°æ®è¿›è¡Œè½¬å‘</h3><ol>
<li><p>å…è®¸ipè½¬å‘</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo sysctl -w net.inet.ip.forwarding=1</div></pre></td></tr></table></figure>
</li>
<li><p>è®¾ç½®pfè½¬å‘è§„åˆ™(å°†80ã€443ç«¯å£çš„å†…å®¹è½¬å‘åˆ°æœ¬åœ°8080ç«¯å£)</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo vim /etc/pf.conf</div><div class="line">æ·»åŠ å¦‚ä¸‹è¡Œ(è®°ä½ä½¿ç”¨å¯¹åº”çš„ç½‘ç»œæ¥å£)</div><div class="line">å¦å¤–pfçš„é…ç½®å¯¹é¡ºåºæœ‰è¦æ±‚ï¼Œåƒæˆ‘æœ¬æœºå°±éœ€è¦å°†å®ƒæ”¾åˆ°rdr-anchor &quot;com.apple/*&quot;ä¸‹ä¸€è¡Œ</div><div class="line">rdr on bridge100 inet proto tcp to any port &#123;80, 443&#125; -&gt; 127.0.0.1 port 8080</div></pre></td></tr></table></figure>
</li>
<li><p>å¯ç”¨pfè§„åˆ™</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo pfctl -e</div></pre></td></tr></table></figure>
</li>
<li><p>é…ç½®sudoeræ–‡ä»¶å…è®¸mitmproxyè®¿é—®pfctl</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo vim /etc/sudoers</div><div class="line">æ·»åŠ ä»¥ä¸‹è¡Œ</div><div class="line">ALL ALL=NOPASSWD: /sbin/pfctl -s state</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="å®‰è£…mitmproxyä½¿ç”¨"><a href="#å®‰è£…mitmproxyä½¿ç”¨" class="headerlink" title="å®‰è£…mitmproxyä½¿ç”¨"></a>å®‰è£…mitmproxyä½¿ç”¨</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">brew install mitmproxy</div><div class="line">mitmweb -T --ignore apple</div></pre></td></tr></table></figure>
<p>æ‰‹æœºç«¯è®¿é—®<code>http://mimt.it</code>ç‚¹å‡»å®‰è£…httpsè¯ä¹¦ã€‚é™¤æ­¤ä¹‹å¤–è¿˜éœ€è¦è®¾ç½®-&gt; é€šç”¨ -&gt; å…³äº  -&gt; ä¿¡ä»»è¯ä¹¦è®¾ç½® -&gt; è®¾ç½®ä¸ºå¯ä¿¡ã€‚<br>ä¸Šé¢ignoreå‚æ•°æ˜¯æ­£åˆ™åŒ¹é…ã€‚å¿½ç•¥å¯¹åŸŸååŒ…å«appleçš„å¤„ç†ã€‚å› ä¸ºåœ¨å®¢æˆ·ç«¯å¼ºåˆ¶è¯ä¹¦éªŒè¯çš„æ—¶å€™ä¼ªé€ è¯ä¹¦æ˜¯è¿‡ä¸äº†çš„ï¼Œè¿™æ ·ä¼šåœ¨è°ƒè¯•çš„æ—¶å€™å½±å“iosæ¶ˆæ¯æ¨é€å•¥çš„<br>bingo~~ ç»“æŸäº†</p>
<p>ä¸è¶³ä¹‹å¤„å°±æ˜¯å®ƒå¹¶ä¸ä¼šæ˜¾ç¤ºè®¿é—®çš„åŸŸåï¼Œåªä¼šæ˜¾ç¤ºip(æ„Ÿè§‰è¿™æ˜¯ä¸€ä¸ªbugï¼Œå› ä¸ºmitmproxyä½¿ç”¨â€“hostå‚æ•°æ˜¯èƒ½å¤Ÿçœ‹åˆ°æ­£ç¡®çš„åœ°å€çš„)</p>
<p>ç„¶åå°±æ˜¯å­¦ä¹ ä¸€ä¸‹mitmproxyçš„è¿‡æ»¤è¯­å¥äº†ï¼Œå¾ˆç®€å•ï¼Œåœ¨webæ“ä½œä¸Šä¼šæœ‰æç¤º</p>
<p>æ•´ä¸ªè¿‡ç¨‹å°±æ˜¯è¿™æ ·ï¼Œè®©æ‰‹æœºé€šè¿‡ç”µè„‘è¿›è¡Œä¸Šç½‘ï¼Œç”¨mitmproxyçš„é€æ˜ä»£ç†æ¨¡å¼ä»ä¸‰å±‚ç½‘ç»œä¸Šæ•è·æ•°æ®(è¿™æ ·å°±é¿å…äº†åœ¨æ‰‹æœºç«¯è®¾ç½®ä»£ç†)ï¼Œå¸Œæœ›èƒ½å¯¹ä½ ä»¬æœ‰æ‰€å¸®åŠ©â”‘(ï¿£Ğ” ï¿£)â”</p>
<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><p><a href="https://docs.mitmproxy.org/stable/howto-transparent/">https://docs.mitmproxy.org/stable/howto-transparent/</a><br><a href="https://medium.com/bugbountywriteup/intercepting-network-data-with-mitmproxy-on-macos-3e3f2f0123b2">https://medium.com/bugbountywriteup/intercepting-network-data-with-mitmproxy-on-macos-3e3f2f0123b2</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¯¹ios appæŠ“åŒ…çš„æ–¹å¼æŒºå¤šçš„ï¼Œæœ€å¸¸è§„çš„æ–¹æ¡ˆå°±æ˜¯æœ¬æœºå¼€å¯ä¸€ä¸ªhttpä»£ç†ã€‚ç„¶åæ‰‹æœºè¿›è¡Œè®¾ç½®ï¼Œå°†æœ¬æœºå†…ç½‘ipä»¥åŠç«¯å£è®¾ç½®ä¸Šå»ã€‚å®‰è£…ä¸€ä¸ªhttpsè¯ä¹¦ï¼Œè®¾ç½®ä¸ºä¿¡ä»»å°±å¯ä»¥å¼€å§‹æŠ“åŒ…äº†ã€‚è¿™ä¸ªæ–¹æ¡ˆéå¸¸é€šç”¨ã€‚ç±»ä¼¼çš„å®ç°ä»¥Fiddlerã€charlesä¸ºä»£è¡¨ï¼Œå®ƒä»¬ç¡®å®å¾ˆå¥½ç”¨ï¼Œä¹Ÿå¾ˆå¥½ç†è§£ã€‚ä½†æ˜¯ç¼ºç‚¹ä¹Ÿæ˜¯æœ‰çš„&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æœ€å¤§çš„ç¼ºç‚¹å°±æ˜¯æ¯ä¸€æ¬¡ä½¿ç”¨éƒ½éœ€è¦è®¾ç½®ä»£ç†ï¼Œä½ éœ€è¦æŸ¥çœ‹æœ¬æœºå†…ç½‘ipï¼Œç„¶åå¡«å†™åˆ°æ‰‹æœºä¸Šã€‚è°ƒè¯•å®Œæˆåå†å°†æ‰‹æœºçš„ä»£ç†è®¾ç½®æ¸…é™¤&lt;/li&gt;
&lt;li&gt;Fiddleråªæœ‰windowsç‰ˆæœ¬å¯ç”¨ï¼Œæ„å‘³ç€macéœ€è¦ä½¿ç”¨è™šæ‹Ÿæœºï¼Œcharleså¹¶æ²¡æœ‰Fiddlerå¥½ç”¨ï¼Œç„¶è€Œè¿˜å–çš„è´¼è´µ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;åŒç±»å‹çš„å¼€æºæ–¹æ¡ˆæœ€å¸¸è§çš„æ˜¯Pythonå®ç°çš„mitmproxyã€‚mitmwebä¹Ÿæä¾›å›¾å½¢ç•Œé¢ï¼Œåˆ«è¯´ï¼Œåªè¦ä½ ä¸å«Œå¼ƒè¿˜æ˜¯æŒºå¥½ç”¨çš„&lt;/p&gt;
&lt;p&gt;osxä¸Šè¿˜æœ‰ä¸ªæ¯”è¾ƒå¥‡è‘©çš„æ‰€è°“ç½‘ç»œè°ƒè¯•è½¯ä»¶Surgeã€‚99ç¾åˆ€ï¼Œå–çš„è¿˜æ˜¯æŒºè´µçš„ï¼ŒåŠŸèƒ½è¿˜è¡Œï¼Œç•Œé¢ä¹ŸæŒºèŠ±å“¨ï¼Œå¿½æ‚ å°ç™½æ˜¯è¶³å¤Ÿäº†ã€‚ç”¨å®ƒä¹Ÿèƒ½å¤Ÿè¿œç¨‹è°ƒè¯•ï¼Œä»£ä»·æ˜¯éœ€è¦ç”¨æœ‰çº¿è¿æ¥åˆ°macç”µè„‘ä¸Šï¼Œç„¶åmacç«¯è½¯ä»¶å°±èƒ½æ•è·è¿œç¨‹æ‰‹æœºçš„ç½‘ç»œè¯·æ±‚æ•°æ®ï¼Œè¿™ä¸ªè½¯ä»¶ç•Œé¢ç¡®å®æŒºä¸é”™ï¼Œç„¶è€Œè¯·æ±‚è¿‡æ»¤æŸ¥æ‰¾å¯¹æ¯”ä¸‹Fiddlerè€Œè¨€å°±æ˜¯ä¸ªæ¸£æ¸£å§ã€‚&lt;/p&gt;
&lt;p&gt;å› æ­¤æƒ³äº†ä¸€ä¸ªæ¯”è¾ƒå¦ç±»çš„æ–¹æ¡ˆï¼Œæ‰‹æœºä½¿ç”¨macç”µè„‘çš„ç½‘ç»œï¼ŒåŒæ—¶ä½¿ç”¨pfå¯¹è¯·æ±‚è¿›è¡Œè½¬å‘ã€‚ä½¿ç”¨mitmproxyçš„é€æ˜ä»£ç†æ¨¡å¼è·å¾—æ‰‹æœºç«¯çš„æ•°æ®ï¼Œä½¿ç”¨mitmwebè¿›è¡Œå±•ç¤º&lt;/p&gt;
    
    </summary>
    
      <category term="devops" scheme="https://www.zoulei.net/categories/devops/"/>
    
    
  </entry>
  
  <entry>
    <title>ocr.ficapy.com åå°å®ç°</title>
    <link href="https://www.zoulei.net/2018/04/01/pdfaddtext_architecture/"/>
    <id>https://www.zoulei.net/2018/04/01/pdfaddtext_architecture/</id>
    <published>2018-04-01T06:34:38.000Z</published>
    <updated>2018-04-01T12:19:21.171Z</updated>
    
    <content type="html"><![CDATA[<p>å› ä¸ºä¸ªäººéœ€æ±‚ï¼Œå†™äº†ä¸€ä¸ªå¾ˆå°ä¼—çš„ä½œå“ï¼Œ<a href="https://ocr.ficapy.com">https://ocr.ficapy.com</a>ï¼Œæˆ‘ç»™å®ƒèµ·çš„é¡¹ç›®åæ˜¯pdfaddtextï¼Œç”¨é€”æ˜¯ç»™æ‰«æç‰ˆæœ¬çš„PDFæ–‡ä»¶åŠ ä¸Šæœç´¢åŠŸèƒ½ã€‚ä½¿ç”¨åœºæ™¯æ˜¯æˆ‘æœ‰å‡ æœ¬æ‰«æç‰ˆæœ¬çš„PDFä¹¦ç±(ç½‘ä¸Šæœ‰ç‰¹åˆ«å¤šçš„æ‰«æç‰ˆä¹¦ç±)ï¼Œæœ‰æ—¶å€™æƒ³æœç´¢ä¹¦ä¸­æœ‰æ²¡æœ‰æåˆ°æŸä¸ªçŸ¥è¯†ç‚¹ï¼Œçº¯å›¾ç‰‡æ˜¯æ— æ³•æœç´¢çš„ï¼Œä½ åªèƒ½å‡­è®°å¿†å»æ‰¾ã€‚<span style="color:red"><strong>æœ¬é¡¹ç›®ä½œç”¨å°±æ˜¯å°†PDFçš„æ–‡æœ¬å†…å®¹è¯†åˆ«å‡ºæ¥ï¼Œç„¶åå†™å…¥ä¸€å±‚éšè—çš„æ–‡å­—å±‚ï¼Œè¿™æ ·PDFé˜…è¯»å™¨å°±èƒ½å¤Ÿæœç´¢è¿™äº›æ–‡å­—äº†ï¼ŒåŒæ—¶å°½é‡ä¿è¯å°†è¯†åˆ«å‡ºæ¥çš„æ–‡å­—å†™åˆ°åŸå›¾ç‰‡å¯¹åº”çš„ä½ç½®</strong></span>,ç±»ä¼¼çš„å·¥å…·æœ‰<a href="https://github.com/jbarlow83/OCRmyPDF">OCRmyPDF</a>ï¼Œå®ƒçš„ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼Œä½¿ç”¨Tesseract OCRå¼•æ“ï¼Œå¯¹æ¯”è¯†åˆ«æ•ˆæœï¼Œç®€ç›´è¢«å•†ç”¨OCRåŠæ‰“ã€‚</p>
<p>æœ€å¼€å§‹æœ‰äº†è¿™ä¸ªæƒ³æ³•ï¼Œæˆ‘å¤§æ¦‚èŠ±è´¹äº†ä¸€ä¸ªä¸‹åˆçš„æ—¶é—´ç”¨pythonå†™å‡ºäº†åŸºæœ¬çš„demoã€‚å°†æ¯ä¸€é¡µPDFè½¬æ¢æˆå›¾ç‰‡ï¼Œç„¶åç”¨å…è´¹çš„OCRæœåŠ¡å»è¯†åˆ«ï¼Œå¾—åˆ°ç»“æœï¼Œæœ€ååˆå¹¶å‡ºä¸€ä¸ªæ–°çš„pdfå‡ºæ¥ã€‚è¿‡ç¨‹ç®—æ˜¯æ¯”è¾ƒé¡ºåˆ©ã€‚æœ¬ç€ç‹¬ä¹ä¹ä¸å¦‚ä¼—ä¹ä¹çš„å¿ƒæ€ã€‚æˆ‘è®¡åˆ’å°†å®ƒè½¬å˜æˆä¸€é¡¹webæœåŠ¡ï¼Œäºæ˜¯æŒ–å‘ä¹‹æ—…å°±æ­¤å¼€å§‹äº†</p>
<p>TLDR</p>
<a id="more"></a>
<p>å¼€å§‹çš„æ„æ€æ˜¯è¿™ä¸ªæ ·å­çš„<img src="https://ficapy.b0.upaiyun.com/blogimg/pdfaddtext_arch1.png" alt="pdfaddtext1"><br>åå°æ¥æ”¶åˆ°æ–‡ä»¶è¿›è¡Œæ‹†åˆ†ï¼Œä¾æ¬¡è·å–ç»“æœæœ€åæœåŠ¡ç«¯ç”Ÿæˆæ–‡ä»¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚æµç¨‹å®Œæˆï¼Œæ˜¯ä¸æ˜¯ç‰¹ç®€å•ğŸ˜•</p>
<h3 id="é—®é¢˜ä¸€-pdfè½¬æ¢ç”Ÿæˆjpgæ•ˆç‡è¿‡ä½"><a href="#é—®é¢˜ä¸€-pdfè½¬æ¢ç”Ÿæˆjpgæ•ˆç‡è¿‡ä½" class="headerlink" title="é—®é¢˜ä¸€: pdfè½¬æ¢ç”Ÿæˆjpgæ•ˆç‡è¿‡ä½"></a>é—®é¢˜ä¸€: pdfè½¬æ¢ç”Ÿæˆjpgæ•ˆç‡è¿‡ä½</h3><p>pythonçš„ç”Ÿæ€æ— éœ€è´¨ç–‘ï¼Œå„ç§åŒ…é½å…¨åˆ°ä½ æ€€ç–‘äººç”Ÿã€‚pdfè½¬æ¢æˆjpgä¹Ÿéƒ½æ˜¯æœ‰çš„ï¼Œæ¯”å¦‚<a href="https://github.com/Belval/pdf2image">pdf2image</a>ã€‚å®ƒæœ‰ä¸€ä¸ªæ— æ³•å¿½è§†çš„ç¼ºç‚¹ï¼Œæ•ˆç‡å¤ªä½ã€‚ä¸ªäººå¤„ç†å°‘é‡é—®é¢˜å¯ä»¥ï¼Œä½†æ˜¯å¦‚æœç”¨äºwebæœåŠ¡ã€‚æ¯ç”Ÿæˆä¸€å¼ ç…§ç‰‡å¡ä¸¤ç§’ï¼Œè‚¯å®šæ— æ³•å¿å—ï¼Œåæ¥å¯¹æ¯”imagemagickå’Œghostscriptï¼Œghostscriptçš„æ•ˆç‡æ¯”imagemagické«˜ä¸€äº›ï¼Œå½“ç„¶æ¯”pythonä¸çŸ¥é“é«˜åˆ°å“ªé‡Œå»äº†ã€‚æ³¨: imagemagickçš„pdfè½¬å›¾ç‰‡åº•å±‚ä½¿ç”¨çš„æ˜¯ghostscriptï¼Œæœ€åé€‰æ‹©äº†subprocessè°ƒç”¨ghostscript</p>
<h3 id="é—®é¢˜äºŒ-OCRæ•ˆç‡è¿‡ä½"><a href="#é—®é¢˜äºŒ-OCRæ•ˆç‡è¿‡ä½" class="headerlink" title="é—®é¢˜äºŒ: OCRæ•ˆç‡è¿‡ä½"></a>é—®é¢˜äºŒ: OCRæ•ˆç‡è¿‡ä½</h3><p>ç›®å‰æ²¡æœ‰èƒ½åŠ›æ­å»ºä¸€ä¸ªè¯†åˆ«å‡†ç¡®åº¦æ¯”è¾ƒé«˜çš„æ–‡å­—è¯†åˆ«å¼•æ“ï¼Œäºæ˜¯ä½¿ç”¨äº†å…è´¹çš„OCRã€‚åœ¨ç½‘ä¸Šè…¾è®¯çš„å…è´¹OCRå£ç¢‘æ˜¯å¾ˆä¸é”™çš„ï¼Œè¶…é«˜çš„è¯†åˆ«å‡†ç¡®ç‡ï¼Œè€Œä¸”çœ‹æ–‡æ¡£å‘ç°ä¸é™åˆ¶è¯†åˆ«æ¬¡æ•°ï¼Œåªæ˜¯ä¸ä¿è¯å¹¶å‘(æ˜¯ä¸æ˜¯æ„Ÿè§‰è¶…çº§è‰¯å¿ƒï¼)ã€‚é†’é†’äº†å°‘å¹´ï¼Œå“ªé‡Œæœ‰è¿™ä¹ˆå¥½çš„äº‹æƒ…ï¼ï¼ï¼</p>
<p>æˆ‘åˆšå¼€å§‹ç”¨çš„æ—¶å€™å¤§æ¦‚å››äº”ç§’è¿”å›ç»“æœã€‚è¯†åˆ«å‡†ç¡®ç‡ç½‘ä¸Šæ²¡æœ‰çå¹ï¼Œå¯¹ä¸­æ–‡çš„å‡†ç¡®ç‡è¿˜æ˜¯å¾ˆä¸é”™çš„ï¼Œåæ¥å¯èƒ½è¯¥æœåŠ¡ç”¨çš„äººå¤ªå¤šï¼Œæ•ˆç‡å¤§å¹…åº¦é™ä½ã€‚é™ä½åˆ°10åˆ°20ç§’æ‰ä¼šè¿”å›ç»“æœã€‚è€Œä¸”ç»å¸¸æ€§è¿”å›ç³»ç»Ÿç¹å¿™çš„é”™è¯¯ã€‚è¿™ä¹Ÿå¯èƒ½å’Œæˆ‘çš„éœ€æ±‚æœ‰å…³ï¼Œå› ä¸ºæˆ‘ä¸Šä¼ çš„è¯†åˆ«ç´ æéƒ½æ˜¯1000åƒç´ ä»¥ä¸Šçš„å›¾ç‰‡ã€‚é‡Œé¢çš„æ–‡å­—ä¼—å¤šï¼Œæ‰€ä»¥è¯†åˆ«æ•ˆç‡æ¯”è¾ƒä½ã€‚ä½†æ˜¯è…¾è®¯æä¾›çš„å…è´¹OCRæœåŠ¡æœ‰åŠ£åŒ–æœåŠ¡è´¨é‡çš„å«Œç–‘ï¼Œæ¯•ç«Ÿå¦‚æœå…è´¹çš„æœåŠ¡æä¾›çš„è¿‡äºçš„å¥½ï¼Œç”¨æˆ·ä»˜è´¹çš„çƒ­æƒ…è‚¯å®šå¤§å¹…åº¦é™ä½ã€‚å¾ˆæ˜æ˜¾çš„æ˜¯ä½ ä¸Šä¼ ä¸€å¼ å›¾ç‰‡å¾—åˆ°ç»“æœï¼Œä¹‹åå†æ¬¡ä¸Šä¼ ä¾æ—§æ˜¯ç­‰å¾…åå‡ ç§’æ‰å¾—åˆ°ç»“æœï¼Œç¨å¾®æ­£å¸¸çš„å¼€å‘è‚¯å®šéƒ½çŸ¥é“å°†ç»“æœç¼“å­˜ä¸€ä¸‹ï¼Œå†æ¬¡ç›¸åŒçš„å›¾ç‰‡è¯·æ±‚ç›´æ¥è¿”å›ç»“æœã€‚é‰´äºè…¾è®¯OCRçš„ä½æ•ˆï¼Œæˆ‘ä¸å¾—ä¸æ‰¾å…¶ä»–çš„OCRæœåŠ¡åŒæ—¶ä½¿ç”¨ï¼Œä¿è¯ç³»ç»Ÿçš„å¯é æ€§ï¼Œæœ€ç»ˆåŒæ—¶ä½¿ç”¨äº†ä»¥ä¸‹æœåŠ¡</p>
<ul>
<li><a href="https://ai.qq.com/doc/ocridcardocr.shtml">è…¾è®¯</a></li>
<li><a href="https://cloud.baidu.com/doc/OCR/OCR-API.html#.E8.BF.94.E5.9B.9E.E6.A0.BC.E5.BC.8F">ç™¾åº¦</a></li>
<li><a href="https://azure.microsoft.com/zh-cn/services/cognitive-services/computer-vision/">å¾®è½¯</a></li>
<li><a href="http://ai.sogou.com/ai-docs/api/ocr">æœç‹—</a></li>
<li><a href="https://console.faceplusplus.com.cn/documents/7776484">faceplusplus</a></li>
</ul>
<p>å¼€å‘è¿‡ç¨‹ä¸­çš„<span style="color:red"><strong>ä¸ªäººæ„Ÿè§‰</strong></span>,è¯†åˆ«å‡†ç¡®ç‡ä¾æ¬¡æ˜¯ç™¾åº¦&gt;è…¾è®¯&gt;æœç‹—&gt;å¾®è½¯&gt;faceplusplus<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">åˆ†åˆ«æ˜¯ç™¾åº¦  è…¾è®¯  æœç‹—  å¾®è½¯ face++     å¯¹åŒä¸€å¼ ç®€å•å›¾ç‰‡çš„è¯†åˆ«ç»“æœ</div><div class="line">[[&apos;è¿™æ˜¯ç¬¬ä¸€æ®µæ–‡å­—&apos;, 316, 123, 22, 131], [&apos;è¿™ä¸ªåœ°æ–¹æ˜¯ç¬¬äºŒæ®µOhye&apos;, 213, 286, 21, 195]]</div><div class="line">[[&apos;è¿™æ˜¯ç¬¬ä¸€æ®µæ–‡å­—&apos;, 316, 123, 22, 131], [&apos;è¿™ä¸ªåœ°æ–¹æ˜¯ç¬¬äºŒæ®µOhye&apos;, 213, 286, 21, 195]]</div><div class="line">[[&apos;è¿™æ˜¯ç¬¬ä¸€æ®µæ–‡å­—&apos;, 309, 122, 24, 149], [&apos;è¿™ä¸ªåœ°æ–¹æ˜¯ç¬¬äºŒæ®µOhye&apos;, 202, 283, 26, 213]]</div><div class="line">[[&apos;è¿™æ˜¯ç¬¬ä¸€æ®µæ–‡å­—&apos;, 318, 125, 21, 124], [&apos;è¿™ä¸ªåœ°æ–¹æ˜¯ç¬¬äºŒæ®µOhye&apos;, 220, 290, 21, 189]]</div><div class="line">[[&apos;è¿™æ˜¯ç¬¬ä¸€æ®µæ–‡å­—&apos;, 319, 125, 19, 128], [&apos;ä¸ªåœ°æ–¹æ˜¯ç¬¬æ®µOye&apos;, 232, 286, 22, 176]]</div></pre></td></tr></table></figure></p>
<p>åŸºæœ¬ä¸Šå›½å†…èƒ½å…è´¹ä½¿ç”¨çš„OCRæœåŠ¡æˆ‘éƒ½ç»™æƒ³åŠæ³•æ•´åˆäº†ï¼Œå®ƒä»¬çš„è¾“å‡ºéƒ½å·®ä¸å¤šï¼Œæä¾›æ–‡å­—åœ¨å›¾ç‰‡ä¸­çš„å®šä½åŠŸèƒ½ï¼Œé™¤äº†è…¾è®¯è¿”å›å¾ˆæ…¢ï¼Œå…¶ä»–æœåŠ¡åŸºæœ¬éƒ½åœ¨å››ç§’å·¦å³è¿”å›ã€‚æœç‹—çš„OCRæœåŠ¡å¾ˆä½è°ƒï¼Œå¥½åƒçŸ¥é“çš„äººéƒ½ä¸å¤šï¼Œè€Œä¸”æ˜¯è¿™äº›æœåŠ¡é‡Œé¢æ–‡æ¡£æœ€å¥‡è‘©çš„ï¼Œæ–‡æ¡£å‡ ä¹æ²¡æœ‰ï¼Œå°±æä¾›äº†ä¸€ä¸ªPHPè°ƒç”¨æœåŠ¡çš„demoã€‚</p>
<p>å³ä¾¿åŒæ—¶ä½¿ç”¨äº†äº”ä¸ªå…è´¹æœåŠ¡ï¼Œä¾æ—§ä¸å¤Ÿç”¨ï¼Œè€Œä¸”å‡ ä¹é™¤äº†è…¾è®¯æ˜¯ä¸é™åˆ¶æ¯æ—¥è°ƒç”¨æ¬¡æ•°ï¼Œå…¶ä»–çš„æœåŠ¡éƒ½ä¼šé™åˆ¶æ¯å¤©æœ€å¤šè°ƒç”¨å¤šå°‘æ¬¡ã€‚æœ€åé¢„ä¼°æ¯å¤©å¯ä¾›è¯†åˆ«çš„å›¾ç‰‡æ•°é‡æœ€å¤šä¸è¶…è¿‡3000é¡µã€‚<span style="color:red"><strong>åº•å±‚OCRæœåŠ¡çš„é™åˆ¶ç›´æ¥å¯¼è‡´äº†è®¾è®¡å¤æ‚åº¦çš„æˆå€ä¸Šå‡</strong></span>ï¼Œå¦‚æœæœ¬åœ°èƒ½åœ¨500æ¯«ç§’å†…è¯†åˆ«å¾—åˆ°ä¸€ä¸ªç»“æœï¼Œä¹Ÿå°±æ²¡é‚£ä¹ˆå¤šäº‹å„¿äº†ã€‚</p>
<h3 id="é—®é¢˜ä¸‰ï¼šæ›´å¿«çš„å“åº”"><a href="#é—®é¢˜ä¸‰ï¼šæ›´å¿«çš„å“åº”" class="headerlink" title="é—®é¢˜ä¸‰ï¼šæ›´å¿«çš„å“åº”"></a>é—®é¢˜ä¸‰ï¼šæ›´å¿«çš„å“åº”</h3><p>å¦‚æœæ˜¯å•äººä½¿ç”¨,é‚£ä¹ˆä¸€ä¸ªä»»åŠ¡è¿›è¡Œå®Œæ¯•ä¹‹åå†è¿›è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚ä¸å­˜åœ¨å¹¶å‘è°ƒåº¦çš„é—®é¢˜ã€‚ä½†æ˜¯å®ƒä½œä¸ºä¸€é¡¹webæœåŠ¡ï¼ŒåŠ¿å¿…ä¼šå­˜åœ¨å¹¶å‘é—®é¢˜ï¼Œå½“æŸä¸ªç”¨æˆ·æ­£åœ¨æ‰§è¡Œè½¬æ¢æ“ä½œï¼Œæ­¤æ—¶å¦å¤–ä¸€ä¸ªç”¨æˆ·åˆæäº¤äº†ä¸€ä¸ªä»»åŠ¡è¯·æ±‚ã€‚æ˜¯é€‰æ‹©ç»§ç»­å°†å‰é¢çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•å†æ‰§è¡Œåç»­çš„(å…ˆåˆ°å…ˆæœåŠ¡)ï¼Œè¿˜æ˜¯é‡‡å–ä¸€å®šçš„ç­–ç•¥è¿›è¡Œä¹±åºæ‰§è¡Œã€‚æœ¬ç¨‹åºé€‰æ‹©äº†<span style="color:red"><strong>çŸ­ä»»åŠ¡ä¼˜å…ˆç­–ç•¥</strong></span>ï¼Œä»¥pdfä¸­çš„å•é¡µä½œä¸ºæœ€å°ä»»åŠ¡å•å…ƒï¼Œä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å¯¹ä»»åŠ¡è¿›è¡Œæ’åºã€‚å°†æ¯ä¸€ä¸ªä»»åŠ¡æœªå®Œæˆçš„é¡µæ•°ä½œä¸ºæ¯”è¾ƒå…ƒç´ ã€‚æ¯æ¬¡é€‰æ‹©ä»»åŠ¡çš„æ—¶å€™æ€»æ˜¯ä»ä¼˜å…ˆçº§ä¸­é€‰æ‹©æœªå®Œæˆé¡µæ•°æœ€å°‘çš„ä»»åŠ¡ä¼˜å…ˆæ‰§è¡Œã€‚åŒæ—¶ä¸ºäº†é¿å…é¥¥é¥¿ï¼Œå‡è®¾å­˜åœ¨å‡ ç™¾é¡µçš„å¤§æ–‡ä»¶ï¼Œæ¯éš”ä¸€åˆ†é’Ÿï¼ŒæŒ‰ç…§ä»»åŠ¡çš„åˆ›å»ºæ—¶é—´æ¥è°ƒæ•´ä»»åŠ¡ä¼˜å…ˆçº§</p>
<p>æœ€å¼€å§‹çš„æœ€ç®€æ¶æ„å‡ ä¹æ˜¯è®¤ä¸ºä¸å­˜åœ¨å¹¶å‘çš„ã€‚ä½†æ˜¯ä¸å¹¶å‘æ˜¯ä¸å¯èƒ½çš„ï¼Œæ‰€ä»¥æµç¨‹æ”¹æˆäº†è¿™æ ·<br><img src="https://ficapy.b0.upaiyun.com/blogimg/pdfaddtext_arch2.png" alt="pdfaddtext_arch2"></p>
<ol>
<li>ç”¨æˆ·å°†å›¾ç‰‡ä¸Šä¼ åˆ°é˜¿é‡Œäº‘OSS, åå°æ¥æ”¶åˆ°å›è°ƒåä¸‹è½½æ–‡ä»¶ã€‚è¿”å›ç»™å®¢æˆ·ç«¯ä»»åŠ¡idã€‚</li>
<li>å®¢æˆ·ç«¯æ ¹æ®æ­¤IDåˆ›å»ºwebsocketè¿æ¥ã€‚åå°ä¸‹è½½æ–‡ä»¶å®Œæ¯•åå‘é€redisé˜Ÿåˆ—æ¶ˆæ¯ã€‚</li>
<li>å¼€å¯ä¸€ä¸ªç‹¬ç«‹çš„PDFåˆ†ç‰‡è¿›ç¨‹ã€‚æ¥æ”¶åˆ°æ¶ˆæ¯åè¿›ç¨‹è·å–æ–‡ä»¶åœ°å€ï¼Œç„¶åå°†PDFæ–‡ä»¶çš„æ¯ä¸€é¡µè½¬æ¢æˆå›¾ç‰‡(æ”¾åˆ°ç‰¹å®šçš„ç›®å½•)ã€‚</li>
<li>ç”Ÿäº§è€…è´Ÿè´£è½®è¯¢ç›®å½•å‘ç°æ–°ç”Ÿæˆçš„å›¾ç‰‡ã€‚ç„¶åæ¯ä¸€å¼ å›¾ç‰‡è¢«å°è£…æˆä¸€ä¸ªTaskä»»åŠ¡å¯¹è±¡ï¼Œè¢«åŠ å…¥åˆ°å…¨å±€é˜Ÿåˆ—ï¼Œå…¨å±€é˜Ÿåˆ—çš„åŸºæœ¬æ ¼å¼æ˜¯ä¸€ä¸ªå­—å…¸{file_md5:Queue}ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶éƒ½æ‹¥æœ‰ä¸€ä¸ªé˜Ÿåˆ—ã€‚</li>
<li><span style="color:red"><strong>æ¶ˆè´¹è€…è´Ÿè´£ä»é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªä»»åŠ¡ã€‚è·å–çš„è§„åˆ™æ˜¯ä»ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ–‡ä»¶md5ã€‚ç„¶ååœ¨å…¨å±€é˜Ÿåˆ—ä¸­å¯¹åº”æ–‡ä»¶md5é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªä»»åŠ¡</strong>ï¼Œæ‰§è¡Œä»»åŠ¡ï¼Œæ›´æ–°ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œå¦‚æœè¯¥æ–‡ä»¶è¢«å…¨éƒ¨æ‰§è¡Œå®Œæˆåˆ™è¿”å›ç»“æœ</span></li>
</ol>
<p>è¿™é‡Œæ¶‰åŠåˆ°äº†ä¸‰ä¸ªå¾ˆé‡è¦çš„åœ°æ–¹ã€<span style="color:red"><strong>Taskä»»åŠ¡ã€å…¨å±€é˜Ÿåˆ—ã€ä¼˜å…ˆçº§é˜Ÿåˆ—</strong></span>ã€‚å…¶ä¸­ç¬¬äº”æ­¥æ˜¯æ•´ä¸ªè¿‡ç¨‹ä¸­æœ€å®¹æ˜“å‡ºç°é”™è¯¯çš„åœ°æ–¹ã€‚</p>
<p>åå°æ•´ä¸ªæ˜¯ä½¿ç”¨Tornadoå®ç°çš„ï¼Œæœ€å¼€å§‹æˆ‘è€ƒè™‘çš„æ˜¯å°†PDFåˆ†ç‰‡ä½¿ç”¨multiprocessè¿›ç¨‹æ¥å®ç°å°±å¥½äº†ã€‚åæ¥è€ƒè™‘å®ƒè¦æ˜¯æŒ‚äº†æ€ä¹ˆåŠã€‚å¦‚æœå®ƒæŒ‚äº†æ•´ä¸ªæµç¨‹å°±æ— æ³•è¿›è¡Œã€‚å¦‚æœä¸€å®šè¦å°†å®ƒä½¿ç”¨multiprocessï¼Œé‚£ä¹ˆå°†ä¸å¾—ä¸ç›‘æ§å®ƒæ˜¯ä¸æ˜¯æŒ‚æ‰äº†å¯¹å®ƒè¿›è¡Œé‡å¯ã€‚æœ€åè¿˜æ˜¯å°†å®ƒç‹¬ç«‹å‡ºæ¥ç”¨supervisordå¤„ç†äº†</p>
<h3 id="é—®é¢˜å››-é”-amp-æ­»é”"><a href="#é—®é¢˜å››-é”-amp-æ­»é”" class="headerlink" title="é—®é¢˜å››: é”&amp;æ­»é”"></a>é—®é¢˜å››: é”&amp;æ­»é”</h3><p>ä¸Šå›¾ä¸­çš„æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…å¹¶ä¸æ˜¯ç®€å•çš„å…±äº«åŒä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ã€‚æ¶ˆè´¹è€…å–å‡ºä»»åŠ¡çš„æµç¨‹æ˜¯å…ˆè¯»å–ä¼˜å…ˆçº§é˜Ÿåˆ—å¾—åˆ°æ–‡ä»¶md5ï¼Œå†ä»å…¨å±€é˜Ÿåˆ—å­—å…¸ä¸­è·å¾—ç›¸åº”é˜Ÿåˆ—è·å¾—ä»»åŠ¡ã€‚è®¾æƒ³ç¨‹åºæœ€å¼€å§‹ä»ä¼˜å…ˆçº§é˜Ÿåˆ—é‡Œé¢å–å¾—çš„æ˜¯ç©ºå€¼ã€‚å†ç”¨ç©ºå€¼å»æŸ¥æ‰¾å…¨å±€é˜Ÿåˆ—æ— ç–‘ä¼šè¢«æŠ¥é”™ã€‚è¦ä¹ˆä½ å°±åœ¨è·å–ä»»åŠ¡çš„æ—¶å€™ä½¿ç”¨whileè¯­å¥ä¸æ–­çš„åˆ¤æ–­å½“å‰ä¼˜å…ˆçº§ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦æœ‰å…ƒç´ ã€‚ç„¶è€Œåœ¨Tornadoé‡Œé¢æ­»å¾ªç¯è¿™ç§æ–¹å¼æ˜¯ä¸å…è®¸çš„ï¼Œä¼šç›´æ¥é€ æˆå…¶ä»–éƒ¨åˆ†æ— æ³•æ‰§è¡Œï¼Œæ— æ³•å“åº”ç”¨æˆ·è¯·æ±‚ã€‚å› æ­¤éœ€è¦ä½¿ç”¨Tornadoæä¾›çš„tornado.lock.Eventã€‚åœ¨è¯»å–ä¼˜å…ˆçº§é˜Ÿåˆ—ä¹‹å‰å…ˆåˆ¤æ–­è¯¥äº‹ä»¶é”æ˜¯å¦è¢«é”ã€‚å¦‚æœè¢«é”é‚£ä¹ˆcoroutineå°±è¢«é˜»å¡ã€‚è¿™æ ·åªéœ€è¦åœ¨ä¼˜å…ˆçº§é˜Ÿåˆ—æ·»åŠ å’Œåˆ é™¤å…ƒç´ çš„åœ°æ–¹ç»Ÿä¸€å¤„ç†ã€‚æ·»åŠ å…ƒç´ çš„æ—¶å€™å–æ¶ˆé”ã€‚å–æ¶ˆå…ƒç´ çš„æ—¶å€™åˆ¤æ–­ä¼˜å…ˆçº§é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºã€‚ä¸ºç©ºåˆ™è®¾ç½®é”</p>
<p>ä¸ºäº†ä¸æµªè´¹ç³»ç»Ÿèµ„æºã€‚å¦‚æœä¸€ä¸ªç”¨æˆ·çš„ä»»åŠ¡æ­£åœ¨è¢«æ‰§è¡Œï¼Œè€Œæ­¤æ—¶ç”¨æˆ·é€€å‡ºäº†ã€‚æ¯«æ— ç–‘é—®ï¼Œè¿™ç§æƒ…å†µä¸‹æœ¬ç€å¿«é€Ÿå“åº”çš„åŸåˆ™ï¼Œæˆ‘ä»¬ä¼šç›´æ¥åˆ æ‰è¯¥æ–‡ä»¶çš„æ‰€æœ‰ä»»åŠ¡ã€‚å†åˆ æ‰ä»»åŠ¡ä¹‹å‰ï¼Œè¯¥æ–‡ä»¶åœ¨ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­æ’åˆ—åœ¨æœ€å‰é¢ï¼Œå› æ­¤ï¼Œå°±æœ‰å¯èƒ½æœ‰çš„æ¶ˆè´¹è€…è·å–äº†è¯¥æ–‡ä»¶çš„é˜Ÿåˆ—é”ã€‚ç„¶è€Œ{file_md5: Queue}ä»»åŠ¡é˜Ÿåˆ—è¢«åˆ é™¤ï¼Œæ„å‘³ç€è·å–åˆ°é”çš„æ¶ˆè´¹è€…æ°¸è¿œæ— æ³•è¢«æ‰§è¡Œï¼Œé€ æˆæ­»é”ï¼Œè¯¥æ¶ˆè´¹è€…å†ä¹Ÿæ— æ³•æ¶ˆè´¹ä»»åŠ¡ã€‚äº¦æˆ–è€…ä¸€ä¸ªæ–‡ä»¶ä»»åŠ¡åœ¨æœªå®Œæˆä¹‹å‰æ‰€æœ‰çš„æ¶ˆè´¹è€…éƒ½ä¼šå»è¯»å–è¿™ä¸ªé˜Ÿåˆ—ï¼Œå½“ä»»åŠ¡è¢«å®Œæˆçš„æ—¶å€™(è¯¥é˜Ÿåˆ—ä¼šè¢«åˆ é™¤)æ€»æœ‰æ¶ˆè´¹è€…è¿˜åœ¨æŒæœ‰è¯¥é”ã€‚é¿å…æ–¹æ³•æ˜¯è·å–é”è®¾ç½®è¶…æ—¶æ—¶é—´(æ¯”å¦‚äº”ç§’)ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°ä»»åŠ¡ç›´æ¥æŠ¥å‘Šå¼‚å¸¸ï¼Œæ•è·å¼‚å¸¸ï¼Œè¿”å›ä¸€ä¸ªç©ºä»»åŠ¡ï¼Œæ¶ˆè´¹è€…å¯¹ç©ºä»»åŠ¡å¿½ç•¥å¤„ç†ï¼Œç­‰å¾…å†æ¬¡å»å…¨å±€é˜Ÿåˆ—è·å–ä»»åŠ¡ï¼Œæ­¤æ—¶åˆšæ‰çš„æ–‡ä»¶é˜Ÿåˆ—åº”è¯¥å·²ç»åˆ é™¤äº†ã€‚</p>
<p>æ³¨: ç³»ç»Ÿé‡å¯çš„æ—¶å€™æ¸…ç©ºredisä¼˜å…ˆçº§é˜Ÿåˆ—(åæ¥æƒ³äº†ä¸€ä¸‹ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸å¿…è¦æ”¾åœ¨rediså½“ä¸­,ç›´æ¥pythonå®ç°ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå®ƒå¹¶æ²¡æœ‰æŒä¹…åŒ–çš„éœ€æ±‚)</p>
<h3 id="é—®é¢˜äº”-ä½•æ—¶è§¦å‘redisæ¶ˆæ¯ï¼Œä½•æ—¶å°†ä»»åŠ¡åŠ å…¥åˆ°ä¼˜å…ˆçº§é˜Ÿåˆ—"><a href="#é—®é¢˜äº”-ä½•æ—¶è§¦å‘redisæ¶ˆæ¯ï¼Œä½•æ—¶å°†ä»»åŠ¡åŠ å…¥åˆ°ä¼˜å…ˆçº§é˜Ÿåˆ—" class="headerlink" title="é—®é¢˜äº”: ä½•æ—¶è§¦å‘redisæ¶ˆæ¯ï¼Œä½•æ—¶å°†ä»»åŠ¡åŠ å…¥åˆ°ä¼˜å…ˆçº§é˜Ÿåˆ—"></a>é—®é¢˜äº”: ä½•æ—¶è§¦å‘redisæ¶ˆæ¯ï¼Œä½•æ—¶å°†ä»»åŠ¡åŠ å…¥åˆ°ä¼˜å…ˆçº§é˜Ÿåˆ—</h3><p>è¿™å¥½åƒä¸æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚æœ€å¼€å§‹çš„æ—¶å€™æˆ‘é€‰æ‹©åœ¨æ–‡ä»¶ä¸‹è½½å®Œæˆåå‘é€redisæ¶ˆæ¯å¹¶åŠ å…¥åˆ°ä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚<br>å…ˆæƒ³è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼Œå½“ç”¨æˆ·æ–­å¼€åä¸ºäº†èŠ‚çœèµ„æºåŠ¿å¿…ä¼šé€‰æ‹©ç«‹åˆ»åˆ æ‰ä¼˜å…ˆçº§é˜Ÿåˆ—(åŒæ—¶åˆ æ‰å…¨å±€é˜Ÿåˆ—çš„ç›¸å…³é¡¹TODO:æˆ‘å¥½åƒæ²¡æœ‰è€ƒè™‘ä¸¤ä¸ªç”¨æˆ·æ­£åœ¨å¤„ç†åŒä¸€ä¸ªPDFä¸€ä¸ªç”¨æˆ·æ–­çº¿çš„æƒ…å†µ)ã€‚å‡è®¾ç”¨æˆ·æ˜¯éæ­£å¸¸æ–­å¼€(å®ƒè¿‡å‡ ç§’åä¼šå†æ¬¡è¿æ¥ï¼Œæˆ‘æ˜¯ä¸æ˜¯é—²çš„è›‹ç–¼ã€‚è€ƒè™‘è¿™ç§æƒ…å†µğŸ˜•)ã€‚ä¸ºäº†æ›´å¥½çš„ä½“éªŒä¼šé€‰æ‹©å‰ç«¯é‡è¿æœºåˆ¶ã€‚æˆ‘ä»¬å¸Œæœ›é‡è¿åä»»åŠ¡èƒ½æ¢å¤å¹¶ç»§ç»­ã€‚å¦‚æœåœ¨ä¸‹è½½å®Œæˆåå‘é€redisæ¶ˆæ¯ã€‚é‚£ä¹ˆwebsocketé‡è¿å°±ä¸ä¼šå‘æ¶ˆæ¯äº†ã€‚æ­¤æ—¶è¿™ä¸ªä»»åŠ¡å°±æ²¡åŠæ³•ç»§ç»­äº†</p>
<p>ä½ ä¼šæƒ³ï¼Œå‰ç«¯é‡è¿æˆ‘ä¹Ÿå¯ä»¥é‡‡ç”¨æ¨¡æ‹Ÿé‡æ–°ä¸Šä¼ æ–‡ä»¶çš„æ­¥éª¤å•Š~~~ï¼Œtoo navie! ä¸Šä¼ çš„æ—¶å€™æ·»åŠ äº†googleéªŒè¯ç è¿™ä¸€æ­¥ã€‚é‡æ–°æ¨¡æ‹Ÿä¸Šä¼ è‡ªåŠ¨åŒ–æ˜¯åšä¸åˆ°çš„ã€‚æ‰€ä»¥å‘é€redisè¿™ä¸€æ­¥å†å»ºç«‹websocketè¿æ¥åå‘æ¯”è¾ƒåˆé€‚<br>é—®é¢˜åˆæ¥äº†ã€‚å»ºç«‹websocketåæ–‡ä»¶è¿˜æ²¡æœ‰ä¸‹è½½å®Œæ¯•ï¼Œæ­¤æ—¶å‘é€redisæ¶ˆæ¯åˆ°åˆ†ç‰‡è¿›ç¨‹ï¼Œåˆ†ç‰‡è¿›ç¨‹æ— ç–‘ä¼šå‡ºé”™ã€‚è§£å†³æ–¹æ³•å°±å’Œä¸Šé¢é‚£ä¸ªé”ä¸€æ ·ã€‚æ·»åŠ Eventäº‹ä»¶é”ï¼Œä¸‹è½½çš„æ—¶å€™æ‰§è¡Œset<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">download_event = &#123;&#125;</div><div class="line"><span class="keyword">if</span> self.file_md5 <span class="keyword">in</span> download_event:</div><div class="line">    download_event[self.file_md5].set()</div><div class="line">    IOLoop().instance().call_later(<span class="number">2</span>, <span class="keyword">lambda</span>: download_event.pop(self.file_md5, <span class="number">1</span>))</div></pre></td></tr></table></figure></p>
<p>ä¼˜å…ˆçº§é˜Ÿåˆ—å¯ä¾›é€‰æ‹©çš„åœ°æ–¹å°±æ›´å¤šäº†</p>
<ol>
<li>æ–‡ä»¶ä¸‹è½½å®Œæˆå</li>
<li>websocketå»ºç«‹è¿æ¥å</li>
<li>ç”Ÿäº§è€…æ·»åŠ ä»»åŠ¡å<br>è¿™é‡Œæœ€é‡è¦çš„æ˜¯ä¸è¦åœ¨å¤šä¸ªåœ°æ–¹æ’å…¥åŒä¸€ä¸ªäº‹ä»¶ï¼Œå‡ºäº†é—®é¢˜ä¸å¥½debugã€‚ä¸‹è½½å®Œæˆå‰æ ‡å¿—ç€ç¬¬ä¸€æ¬¡å»ºç«‹è¿æ¥ï¼Œwebsocketæœ‰å¯èƒ½æ ‡å¿—ç€æ–­çº¿é‡è¿ã€‚å®ƒä»¬æœ€ç»ˆéƒ½ä¼šèµ°å‘ç”Ÿäº§è€…è¿™ä¸ªåœ°æ–¹ï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©åœ¨ç”Ÿäº§è€…è¿™é‡Œæ·»åŠ ã€‚å…ˆæ£€æµ‹è¯¥file_md5æ˜¯å¦å­˜åœ¨å¯¹åº”çš„websocketè¿æ¥ï¼Œå¦‚æœå­˜åœ¨åˆ™åŠ å…¥å…¨å±€é˜Ÿåˆ—ï¼ŒåŒæ—¶åŠ å…¥ä¼˜å…ˆçº§é˜Ÿåˆ—</li>
</ol>
<h3 id="ä¼˜åŒ–ä¸€ï¼šé‡å¤æ–‡ä»¶ç›´æ¥å¾—åˆ°ç»“æœ"><a href="#ä¼˜åŒ–ä¸€ï¼šé‡å¤æ–‡ä»¶ç›´æ¥å¾—åˆ°ç»“æœ" class="headerlink" title="ä¼˜åŒ–ä¸€ï¼šé‡å¤æ–‡ä»¶ç›´æ¥å¾—åˆ°ç»“æœ"></a>ä¼˜åŒ–ä¸€ï¼šé‡å¤æ–‡ä»¶ç›´æ¥å¾—åˆ°ç»“æœ</h3><p>å¦‚æœæ–‡ä»¶åœ¨åå°æ•°æ®åº“å­˜åœ¨è®°å½•ï¼Œå¦‚æœè¯¥æ–‡ä»¶å…¨éƒ¨ç»“æœéƒ½æ­£ç¡®å­˜åœ¨åˆ™ç›´æ¥è¿”å›ç»“æœã€‚å¦‚æœæ­£åœ¨è¢«æ‰§è¡Œæˆ–è€…æœ‰éƒ¨åˆ†å†…å®¹æ²¡æœ‰è¢«OCRã€‚åˆ™åå°æ–°å»ºä»»åŠ¡ï¼Œæ€»è€Œè¨€ä¹‹ï¼Œé¿å…ç”¨æˆ·å†æ¬¡ä¸Šä¼ æ–‡ä»¶åˆ°é˜¿é‡Œäº‘OSS</p>
<h3 id="ä¼˜åŒ–äºŒï¼šå‡å°‘OCRæ¬¡æ•°"><a href="#ä¼˜åŒ–äºŒï¼šå‡å°‘OCRæ¬¡æ•°" class="headerlink" title="ä¼˜åŒ–äºŒï¼šå‡å°‘OCRæ¬¡æ•°"></a>ä¼˜åŒ–äºŒï¼šå‡å°‘OCRæ¬¡æ•°</h3><p>OCRçš„æœºä¼šå¾ˆå®è´µ,æ‰€ä»¥åº”è¯¥å°½é‡å‡å°‘OCRçš„æ¬¡æ•°ï¼Œé¦–å…ˆæƒ³åˆ°çš„æ˜¯åŒä¸€ä¸ªæ–‡ä»¶å¦‚æœå¾—åˆ°äº†ç»“æœå°±ä¸éœ€è¦å†æ¬¡å»è°ƒç”¨OCRæ¥å£ï¼Œå†å…¶æ¬¡ï¼Œä¸€ä¸ªPDFæ–‡ä»¶ç”±Nå¼ å›¾ç‰‡ç»„æˆã€‚å¯¹æ¯ä¸€å¼ å›¾ç‰‡è¿›è¡Œç›¸ä¼¼åº¦åˆ¤æ–­ï¼Œå¦‚æœè¶³å¤Ÿç›¸ä¼¼å°±è®¤ä¸ºå®ƒæ˜¯åŒä¸€å¼ å›¾ç‰‡é¿å…å†æ¬¡æ‰§è¡Œè¯†åˆ«æ“ä½œã€‚å›¾ç‰‡ç›¸ä¼¼åº¦ç®—æ³•å‰é¢æœ‰åšæ–‡æåˆ°ï¼Œä½¿ç”¨çš„æ˜¯<a href="https://github.com/JohannesBuchner/imagehash">imagehash</a>ã€‚å¯¹æ¯å¼ å›¾ç‰‡ç”Ÿæˆ64bitçš„æ ‡è¯†ã€‚æ¯”å¯¹çš„æ—¶å€™ä½¿ç”¨æ±‰æ˜è·ç¦»æ£€æŸ¥æ˜¯å¦ç›¸ä¼¼ã€‚æ•°æ®åº“ä¼˜åŒ–æ±‰æ˜è·ç¦»çš„æ–¹æ³•å‰é¢åšæ–‡ä¹Ÿæœ‰æåˆ°</p>
<h3 id="ä¼˜åŒ–ä¸‰-ä½¿ç”¨æµè§ˆå™¨å®¢æˆ·ç«¯è¿›è¡ŒPDFåˆå¹¶"><a href="#ä¼˜åŒ–ä¸‰-ä½¿ç”¨æµè§ˆå™¨å®¢æˆ·ç«¯è¿›è¡ŒPDFåˆå¹¶" class="headerlink" title="ä¼˜åŒ–ä¸‰:  ä½¿ç”¨æµè§ˆå™¨å®¢æˆ·ç«¯è¿›è¡ŒPDFåˆå¹¶"></a>ä¼˜åŒ–ä¸‰:  ä½¿ç”¨æµè§ˆå™¨å®¢æˆ·ç«¯è¿›è¡ŒPDFåˆå¹¶</h3><p>å¦‚æœç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ä¸º100Mï¼Œåœ¨åå°ç”Ÿæˆæ–‡ä»¶å¹¶æä¾›ç»™ç”¨æˆ·ä¸‹è½½ï¼ŒOSSå¤–ç½‘ä¸‹è½½çš„ä»·æ ¼å¤§æ¦‚æ˜¯1Gäº”æ¯›ã€‚å—¯ã€‚ä¸Šä¼ å‡ ä¸ªå¤§æ–‡ä»¶ï¼Œæ¥å‡ æ¬¡æ¶æ„ä¸‹è½½ï¼Œç­‰ç€å¤©ä»·è´¦å•å§ğŸ˜€ã€‚å› æ­¤è¿™ç§åº”ç”¨é‡‡å–å®¢æˆ·ç«¯æ¸²æŸ“æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œæˆ‘å…ˆæ‰¾äº†ä¸€ä¸‹jsçš„åº“ã€‚å·ç§°â€ä»»ä½•èƒ½å¤Ÿç”¨JavaScriptå®ç°çš„åº”ç”¨ç³»ç»Ÿï¼Œæœ€ç»ˆéƒ½å¿…å°†ç”¨JavaScriptå®ç°â€~~,ç„¶å¹¶åµï¼Œæˆ‘å¹¶æ²¡æœ‰æ‰¾åˆ°å…è®¸ä¿®æ”¹PDFæ–‡ä»¶çš„å¼€æºjsåº“ï¼Œå…³äºPDFçš„è¦ä¹ˆæ˜¯æ¸²æŸ“ç”¨ï¼Œè¦ä¹ˆå°±æ˜¯ä»0ç”Ÿæˆä¸€ä¸ªæ–°çš„PDFæ–‡ä»¶ã€‚åæ¥æˆ‘æ‰¾åˆ°äº†å•†ä¸šçš„jsåº“pspdfkit(ä¹Ÿæœ‰ä¸€äº›å…¶ä»–çš„ï¼Œå½“ç„¶å®ƒä»¬ä»·æ ¼éƒ½ä¸è²)ï¼Œå®ƒè®©æˆ‘çŸ¥é“äº†æœ‰webassemblyè¿™ä¸ªä¸œä¸œçš„å­˜åœ¨ï¼Œå®ƒå…è®¸c/c++/rustä»£ç å†æµè§ˆå™¨ç«¯æ‰§è¡Œã€‚è™½ç„¶c/c++/rustæˆ‘ä¸€ä¸ªéƒ½ä¸ä¼š, ä½†æ˜¯æˆ‘è¿˜æ˜¯æ‰¾åˆ°äº†ä¸€ä¸ªc++çš„åº“<a href="https://github.com/galkahana/PDF-Writer">PDF-Writer</a>ï¼Œçœ‹åˆ°äº†å¸Œæœ›çš„æ›™å…‰å†…å¿ƒæ˜¯æ¿€åŠ¨çš„ã€‚ç„¶åæˆ‘å»åˆ·Cçš„æ•™ç¨‹ï¼Œå†åˆ·äº†ä¸€éC++çš„æ•™ç¨‹ï¼ŒçŸ¥é“äº†Hello Worldæ€ä¹ˆå†™ã€‚å‚ç…§äº†å‡ ä¸ªwebassemblyçš„é¡¹ç›®(å¤§å¤šæ•°éƒ½æ˜¯ç”¨Cå†™çš„)ã€‚é‡ç‚¹å‚ç…§äº†è¿™ä¸ª<a href="https://github.com/antelle/wasm-image-compressor">wasm-image-compressor</a>ã€‚æœ€ç»ˆè¿˜çœŸç»™æŠ˜è…¾å‡ºæ¥äº†(å‰ç«¯è€—è´¹çš„æ—¶é—´å æ®äº†æ•´ä¸ªå¼€å‘çš„ä¸€å¤§åŠ)ã€‚ç»“æœæ˜¯ç¼–è¯‘åå¤§å°ä¸º1.5Mï¼Œå®ç°äº†ä¸¤ä¸ªåŠŸèƒ½ã€‚éªŒè¯PDFæ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ(å¯ä»¥æ­£å¸¸è§£æï¼Œé¡µæ•°æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Œæ¯é¡µå¤§å°æ˜¯å¦ç¬¦åˆè¦æ±‚)ï¼Œä¼ å…¥PDFæ–‡ä»¶å’Œjsonç»“æœï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„æ–‡ä»¶ã€‚<br>åˆ«è¯´æ•ˆç‡è¿˜çœŸä¸é”™ï¼Œç”Ÿæˆæ–‡ä»¶è¿‡ç¨‹æ¯”pythonå¿«å¾ˆå¤š</p>
<p>è¯¥é¡¹ç›®æä¾›äº†ä¸¤ç§ç”ŸæˆPDFçš„æ–¹å¼ï¼Œ<a href="https://ocr.ficapy.com">æµè§ˆå™¨ç«¯</a> å’Œ<a href="https://gist.github.com/ficapy/baef42b378685e5853d709f2a69eadd1">pythonè„šæœ¬</a>,è¿™ä¸¤ç§æ–¹å¼ç”Ÿæˆçš„PDFæ–‡ä»¶æ–¹å¼æ˜¯ä¸ä¸€æ ·çš„ã€‚pythonçš„æ–¹å¼æ˜¯åˆå¹¶ä¸¤ä¸ªå›¾å±‚ï¼Œæ–°çš„canvaså›¾å±‚é€æ˜åº¦ä¸ºå®Œå…¨é€æ˜.c++çš„æ–¹å¼æ˜¯é‡‡å–è¿½åŠ çš„æ–¹å¼ï¼Œè®¾ç½®æ¯ä¸ªå…ƒç´ çš„å¯è§æ€§ä¸ºä¸å¯è§</p>
<p>å…¶æ¬¡æ˜¯å­—ä½“çš„é—®é¢˜ï¼Œå†™å…¥æ–‡å­—çš„æ—¶å€™éƒ½éœ€è¦æŒ‡æ˜å­—ä½“ã€‚ç„¶è€Œé™„å¸¦ä¸€ä¸ªå®Œæ•´çš„å­—ä½“ä¼šæµªè´¹å·¨å¤§çš„ç©ºé—´ã€‚æˆ‘æ‰¾äº†ä¸€ä¸ªæ¯”è¾ƒå°ä¸€ç‚¹çš„ä¸­æ–‡å­—ä½“ï¼Œå¤§å°æ˜¯1.5Mã€‚æ„Ÿè§‰è¿™äº›æ–‡å­—ä¸éœ€è¦çœŸæ­£çš„æ˜¾ç¤ºå‡ºæ¥ï¼Œæ‰€ä»¥è‡ªå·±åˆ¶ä½œä¸€ä¸ªæœ€å°çš„å­—ä½“å¸¦å¥¹è¿™ä¸ªä¸­æ–‡å­—ä½“æ˜¯æœ‰å¯èƒ½çš„ï¼Œä½†æ˜¯æˆ‘å¤±è´¥äº†ã€‚åˆ¶ä½œå‡ºæ¥åç”µè„‘èƒ½å¤Ÿæ­£å¸¸è¯†åˆ«ï¼ŒC++åº“ç»“æœæ— æ³•æ­£å¸¸æ‰“å¼€è¯¥å­—ä½“</p>
<h3 id="ä¼˜åŒ–å››-é‡‡ç”¨msgpackè¿›è¡Œä¼ è¾“"><a href="#ä¼˜åŒ–å››-é‡‡ç”¨msgpackè¿›è¡Œä¼ è¾“" class="headerlink" title="ä¼˜åŒ–å››: é‡‡ç”¨msgpackè¿›è¡Œä¼ è¾“"></a>ä¼˜åŒ–å››: é‡‡ç”¨msgpackè¿›è¡Œä¼ è¾“</h3><p>ç›´æ¥å¯¹ç»“æœè¿›è¡Œjsonç¼–ç ä¼ è¾“è¿˜æ˜¯å¾ˆä¸åˆ’ç®—çš„,å› æ­¤æœ¬é¡¹ç›®æ•°æ®å­˜å‚¨ä»¥åŠå‰åç«¯ä¼ è¾“é‡‡ç”¨msgpackè¿›è¡Œå‹ç¼©åä¼ è¾“ã€‚éœ€è¦æ³¨æ„çš„æ˜¯websocketå¯¹äºŒè¿›åˆ¶æµéœ€è¦ç‰¹æ®ŠæŒ‡å®š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> socket = <span class="keyword">new</span> WebSocket(url);</div><div class="line">socket.binaryType = <span class="string">'arraybuffer'</span>;</div><div class="line">socket.onmessage = <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</div><div class="line">    <span class="keyword">let</span> raw_data = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(event.data);</div><div class="line">    ret = msgpack.decode(raw_data);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="æ”¹è¿›æ–¹å‘"><a href="#æ”¹è¿›æ–¹å‘" class="headerlink" title="æ”¹è¿›æ–¹å‘"></a>æ”¹è¿›æ–¹å‘</h3><ol>
<li>ç›®å‰20é¡µçš„é™åˆ¶è®©ç½‘é¡µç«¯å‡ ä¹æ²¡æœ‰ä½œç”¨,æä¾›ä¸€ä¸ªç¨æœ‰è´¨é‡çš„æœ¬åœ°OCR,å¯¹äºæ•°ç™¾é¡µçš„PDFé€‰æ‹©åœ¨æœ¬åœ°è¯†åˆ«</li>
<li>è§£å†³ä¸­æ–‡å­—ä½“è¿‡å¤§çš„é—®é¢˜ï¼ŒåŒæ—¶ä¼˜åŒ–å‰ç«¯å¤§å°ï¼Œå°½é‡è®©å‹ç¼©åçš„é¡µé¢åŠ è½½å¤§å°åˆ°1Mä»¥å†…</li>
<li>åå°å¯¹PDFè¿›è¡Œé¢„å¤„ç†,å¦‚æœå‘ç°å¯ç›´æ¥è¯»å–æ–‡å­—è¡¨ç¤ºè¯¥é¡µä¸éœ€è¦è¢«OCR</li>
<li>æ”¹è¿›å‰ç«¯å‘å¸ƒé€»è¾‘ï¼Œæ¯æ¬¡å˜åŠ¨æ–‡ä»¶åè®©CDNç¼“å­˜å¾ˆå°´å°¬</li>
</ol>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://bertanguven.com/faster-conversions-from-pdf-to-pngjpeg-imagemagick-vs-ghostscript">Faster conversions from PDF to PNG/JPEG, imagemagick vs ghostscript</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å› ä¸ºä¸ªäººéœ€æ±‚ï¼Œå†™äº†ä¸€ä¸ªå¾ˆå°ä¼—çš„ä½œå“ï¼Œ&lt;a href=&quot;https://ocr.ficapy.com&quot;&gt;https://ocr.ficapy.com&lt;/a&gt;ï¼Œæˆ‘ç»™å®ƒèµ·çš„é¡¹ç›®åæ˜¯pdfaddtextï¼Œç”¨é€”æ˜¯ç»™æ‰«æç‰ˆæœ¬çš„PDFæ–‡ä»¶åŠ ä¸Šæœç´¢åŠŸèƒ½ã€‚ä½¿ç”¨åœºæ™¯æ˜¯æˆ‘æœ‰å‡ æœ¬æ‰«æç‰ˆæœ¬çš„PDFä¹¦ç±(ç½‘ä¸Šæœ‰ç‰¹åˆ«å¤šçš„æ‰«æç‰ˆä¹¦ç±)ï¼Œæœ‰æ—¶å€™æƒ³æœç´¢ä¹¦ä¸­æœ‰æ²¡æœ‰æåˆ°æŸä¸ªçŸ¥è¯†ç‚¹ï¼Œçº¯å›¾ç‰‡æ˜¯æ— æ³•æœç´¢çš„ï¼Œä½ åªèƒ½å‡­è®°å¿†å»æ‰¾ã€‚&lt;span style=&quot;color:red&quot;&gt;&lt;strong&gt;æœ¬é¡¹ç›®ä½œç”¨å°±æ˜¯å°†PDFçš„æ–‡æœ¬å†…å®¹è¯†åˆ«å‡ºæ¥ï¼Œç„¶åå†™å…¥ä¸€å±‚éšè—çš„æ–‡å­—å±‚ï¼Œè¿™æ ·PDFé˜…è¯»å™¨å°±èƒ½å¤Ÿæœç´¢è¿™äº›æ–‡å­—äº†ï¼ŒåŒæ—¶å°½é‡ä¿è¯å°†è¯†åˆ«å‡ºæ¥çš„æ–‡å­—å†™åˆ°åŸå›¾ç‰‡å¯¹åº”çš„ä½ç½®&lt;/strong&gt;&lt;/span&gt;,ç±»ä¼¼çš„å·¥å…·æœ‰&lt;a href=&quot;https://github.com/jbarlow83/OCRmyPDF&quot;&gt;OCRmyPDF&lt;/a&gt;ï¼Œå®ƒçš„ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼Œä½¿ç”¨Tesseract OCRå¼•æ“ï¼Œå¯¹æ¯”è¯†åˆ«æ•ˆæœï¼Œç®€ç›´è¢«å•†ç”¨OCRåŠæ‰“ã€‚&lt;/p&gt;
&lt;p&gt;æœ€å¼€å§‹æœ‰äº†è¿™ä¸ªæƒ³æ³•ï¼Œæˆ‘å¤§æ¦‚èŠ±è´¹äº†ä¸€ä¸ªä¸‹åˆçš„æ—¶é—´ç”¨pythonå†™å‡ºäº†åŸºæœ¬çš„demoã€‚å°†æ¯ä¸€é¡µPDFè½¬æ¢æˆå›¾ç‰‡ï¼Œç„¶åç”¨å…è´¹çš„OCRæœåŠ¡å»è¯†åˆ«ï¼Œå¾—åˆ°ç»“æœï¼Œæœ€ååˆå¹¶å‡ºä¸€ä¸ªæ–°çš„pdfå‡ºæ¥ã€‚è¿‡ç¨‹ç®—æ˜¯æ¯”è¾ƒé¡ºåˆ©ã€‚æœ¬ç€ç‹¬ä¹ä¹ä¸å¦‚ä¼—ä¹ä¹çš„å¿ƒæ€ã€‚æˆ‘è®¡åˆ’å°†å®ƒè½¬å˜æˆä¸€é¡¹webæœåŠ¡ï¼Œäºæ˜¯æŒ–å‘ä¹‹æ—…å°±æ­¤å¼€å§‹äº†&lt;/p&gt;
&lt;p&gt;TLDR&lt;/p&gt;
    
    </summary>
    
      <category term="python" scheme="https://www.zoulei.net/categories/python/"/>
    
    
  </entry>
  
  <entry>
    <title>Tornado æ‚é¡¹</title>
    <link href="https://www.zoulei.net/2018/03/20/Tornado_misc/"/>
    <id>https://www.zoulei.net/2018/03/20/Tornado_misc/</id>
    <published>2018-03-20T06:50:09.000Z</published>
    <updated>2018-03-20T07:23:11.034Z</updated>
    
    <content type="html"><![CDATA[<p>Tornadoç³»åˆ—åŸºæœ¬ä»‹ç»çš„å·®ä¸å¤šäº†ï¼Œæœ¬ç¯‡ä»‹ç»ä¸€äº›é›¶æ•£çš„ä¸œè¥¿ã€‚æœ‰äº†å‰é¢çš„çŸ¥è¯†ï¼Œæœ¬ç¯‡ä¼šè®²çš„æ¯”è¾ƒç²—ç•¥</p>
<a id="more"></a>
<h3 id="set-blocking-signal-threshold"><a href="#set-blocking-signal-threshold" class="headerlink" title="set_blocking_signal_threshold"></a>set_blocking_signal_threshold</h3><p>å› ä¸ºTornadoæ˜¯å•çº¿ç¨‹çš„ï¼Œå› æ­¤å½“ä¸€ä¸ªä»»åŠ¡è¢«é˜»å¡ä¸€ä¸¤ç§’é’ŸåŸºæœ¬å°±æ˜¯å“ªé‡Œå‡ºé—®é¢˜äº†ï¼Œè¯¥å‡½æ•°ç»™äº†æˆ‘ä»¬ä¸€ä¸ªæœºä¼šå¯Ÿè§‰è¿™äº›é—®é¢˜ã€‚å¯ä»¥å½“å‘ç”Ÿé˜»å¡è¶…è¿‡é˜ˆå€¼çš„æ—¶å€™æ‰§è¡Œç›¸å…³å›è°ƒå‡½æ•°</p>
<p>å®ç°åŸç†å°±æ˜¯ä½¿ç”¨ä¿¡å·æœºåˆ¶ï¼Œå…ˆä½¿ç”¨<code>signal.signal(signal.SIGALRM,callback)</code>æ³¨å†Œä¿¡å·å›è°ƒå‡½æ•°ã€‚åœ¨ioloopä¸»å¾ªç¯ä¸­æ¯æ¬¡äº‹ä»¶å®Œæˆåå°†å®æ—¶è®¡æ—¶å™¨å½’é›¶<code>signal.setitimer(signal.ITIMER_REAL, 0, 0)</code>åå†é‡æ–°å¼€å§‹è®¡æ—¶ã€‚å¦‚æœä¸»å¾ªç¯è¢«é˜»å¡æ²¡æœ‰è¢«æ‰§è¡Œè®¡æ—¶å™¨å½’é›¶åˆ™ä¼šè¢«è§¦å‘</p>
<h3 id="å¤šè¿›ç¨‹"><a href="#å¤šè¿›ç¨‹" class="headerlink" title="å¤šè¿›ç¨‹"></a>å¤šè¿›ç¨‹</h3><p>æœ‰ä¸€äº›æƒ…å†µæˆ‘ä»¬ä¼šéƒ¨ç½²å¤šä¸ªTornadoå®ä¾‹ç”¨æ¥å¢åŠ ç³»ç»Ÿæ•´ä½“ååé‡ï¼Œæœ‰ä¸¤ç§æ–¹æ¡ˆï¼Œä¸€ï¼šå°†Tornadoç¨‹åºå•ç‹¬æ‰§è¡ŒNä»½ï¼Œæ¯ä¸€ä¸ªå®ä¾‹å•ç‹¬ç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œç„¶åä½¿ç”¨Nginxå®ç°è´Ÿè½½å‡è¡¡ã€‚äºŒï¼šä½¿ç”¨Tornadoæä¾›çš„å¤šè¿›ç¨‹ï¼Œè¯¥æ¨¡å—å®ç°åœ¨process.py(æœ€ç®€å•çš„ç‰ˆæœ¬ä¸ºv2.1.0)ï¼Œå®ç°åŸç†ä¸ºå¼€å¯ä¸€ä¸ªä¸»è¿›ç¨‹ï¼Œå¼€å¯Nä¸ªå·¥ä½œè¿›ç¨‹ï¼Œä¸»è¿›ç¨‹ä¸»è¦è´Ÿè´£è¿™äº›å·¥ä½œè¿›ç¨‹çš„é‡å¯å·¥ä½œ(æ¯”å¦‚æŸè¿›ç¨‹æŒ‚æ‰äº†ï¼Œé‚£ä¹ˆä¼šé‡æ–°å¯åŠ¨ä¸€ä¸ªï¼Œç»´æŒæ€»è¿›ç¨‹æ•°é‡)ã€‚æ²¡ä¸€ä¸ªå·¥ä½œè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªä¸»å¾ªç¯ï¼Œå®ƒä»¬å‡åˆ†å¤„ç†httpè¯·æ±‚</p>
<h3 id="gen-sleep"><a href="#gen-sleep" class="headerlink" title="gen.sleep"></a>gen.sleep</h3><p>ç­‰å¾…Nç§’é’Ÿï¼Œè¿™ä¸ªåŠŸèƒ½ç›´åˆ°4.1ç‰ˆæœ¬æ‰è¢«åŠ å…¥ï¼Œè¿˜æ˜¯æŒºå¥‡æ€ªçš„ã€‚å®ç°åŸç†å°±æ˜¯æ–°å»ºä¸€ä¸ªFutureå¯¹è±¡ï¼ŒåŒæ—¶æ·»åŠ å›è°ƒåˆ°ä¸»å¾ªç¯ï¼Œè®¾ç½®Nç§’åå°†Futureå¯¹è±¡è®¾ç½®ä¸ºä»»æ„ä¸€ä¸ªå€¼ã€‚</p>
<h3 id="gen-run-on-executer"><a href="#gen-run-on-executer" class="headerlink" title="gen.run_on_executer"></a>gen.run_on_executer</h3><p>ä½¿ç”¨å•ç‹¬çš„çº¿ç¨‹æ¥å®Œæˆé˜»å¡çš„ä»»åŠ¡ã€‚åŒæ—¶èƒ½å¤Ÿä½¿ç”¨yieldå¼‚æ­¥æ¥æ”¶åˆ°è¿”å›çš„å€¼ã€‚å®ç°åŸç†ä¸»è¦ä¾é concurrent.futureæ¨¡å—ï¼Œconcurrent.future.submitä¼šè¿”å›ä¸€ä¸ªFutureå¯¹è±¡ã€‚yieldæ¥æ”¶åˆ°è¿™ä¸ªå¯¹è±¡æ§åˆ¶æƒè½¬ç§»ã€‚å½“çº¿ç¨‹å†…å®¹æ‰§è¡Œå®Œæ¯•åä¼šè®¾ç½®Futureçš„å€¼ã€‚yieldè¢«æ¢å¤</p>
<h3 id="run-sync"><a href="#run-sync" class="headerlink" title="run_sync"></a>run_sync</h3><p>ç»å¸¸ç”¨äºè°ƒè¯•ã€‚æ¯”å¦‚å†™äº†ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œè¦éªŒè¯ä¸€ä¸‹æ­£ç¡®æ€§ã€‚é‚£ä¹ˆå°±ä¸éœ€è¦ä½¿ç”¨IOLoop.instance().start()è®©å®ƒæ— æ³•ç»ˆæ­¢ã€‚å‡è®¾aå‡½æ•°è¢«coroutineè£…é¥°ï¼Œé‚£ä¹ˆa()è¿”å›ä¸€ä¸ªFutureå¯¹è±¡ï¼Œæ­¤æ—¶æ‰§è¡ŒIOLoop.instance().start()ã€‚æ•´ä¸ªä¸»å¾ªç¯å°±ä¼šè¢«æ‰§è¡Œã€‚è€Œrun_syncä»…ä»…åªæ˜¯åœ¨ä¸­é—´åšäº†ä¸€ä»¶äº‹æƒ…ã€‚å¯¹äºä¸€ä¸ªFutureå¯¹è±¡ï¼Œæ‹¥æœ‰add_done_callbackå‡½æ•°ï¼Œè¡¨ç¤ºè¯¥Futureå®ŒæˆååšæŸäº‹ï¼Œå› æ­¤å®ƒåªæ˜¯æ·»åŠ äº†ä¸€ä¸ªå›è°ƒè®©ä¸»å¾ªç¯åœæ­¢</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Tornadoç³»åˆ—åŸºæœ¬ä»‹ç»çš„å·®ä¸å¤šäº†ï¼Œæœ¬ç¯‡ä»‹ç»ä¸€äº›é›¶æ•£çš„ä¸œè¥¿ã€‚æœ‰äº†å‰é¢çš„çŸ¥è¯†ï¼Œæœ¬ç¯‡ä¼šè®²çš„æ¯”è¾ƒç²—ç•¥&lt;/p&gt;
    
    </summary>
    
      <category term="Tornado" scheme="https://www.zoulei.net/categories/Tornado/"/>
    
    
  </entry>
  
  <entry>
    <title>Tornado ä¹‹queue</title>
    <link href="https://www.zoulei.net/2018/03/19/tornado_queue/"/>
    <id>https://www.zoulei.net/2018/03/19/tornado_queue/</id>
    <published>2018-03-19T06:24:05.000Z</published>
    <updated>2018-03-20T06:44:46.310Z</updated>
    
    <content type="html"><![CDATA[<p>ä»‹ç»å®ŒStackContextã€gen.engineã€gen.coroutineä¹‹åTornado3.0ä»¥å‰çš„æ ¸å¿ƒå†…å®¹åŸºæœ¬å·²ç»å®Œç»“äº†ã€‚æœ¬ç¯‡ä»‹ç»ä¸€ä¸‹gen.coroutineä¸­Futureçš„åº”ç”¨ï¼Œåœ¨tornadoä¸­ç”Ÿæˆä¸€ä¸ªé˜Ÿåˆ—çš„æ•°æ®ç»“æ„ã€‚å¦‚æœç»å¸¸å†™webçš„æƒ…å†µï¼Œå•å•åªå¤„ç†ç”¨æˆ·çš„è¾“å…¥ç»™å‡ºè¾“å‡ºï¼Œé‚£ä¹ˆè¦æ±‚ä¸ä¼šå¤ªå¤šï¼Œä¹Ÿä¸ä¼šç”¨åˆ°é˜Ÿåˆ—ã€‚å¯æ˜¯å¦‚æœä½ å»å†™ä¸€ä¸ªçˆ¬è™«ï¼Œè‚¯å®šéœ€è¦é™é€Ÿå•¥çš„ï¼Œæ­¤æ—¶é˜Ÿåˆ—å°±æ˜¯ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„ä¸œè¥¿ï¼Œå¾ˆå®¹æ˜“å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ã€‚Tornadoå®˜æ–¹çš„demoä¸­ä¹Ÿæœ‰ä¸€ä¸ª[çˆ¬è™«ä»£ç (<a href="https://github.com/tornadoweb/tornado/blob/master/demos/webspider/webspider.py)]æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨é˜Ÿåˆ—(æœ¬ç¯‡åŸºäºv5.0.0">https://github.com/tornadoweb/tornado/blob/master/demos/webspider/webspider.py)]æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨é˜Ÿåˆ—(æœ¬ç¯‡åŸºäºv5.0.0</a>)</p>
<a id="more"></a>
<h3 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h3><p>ç†è§£Queueæ¨¡å—ç»™å‡ºçš„ä¾‹å­å°±å¯ä»¥äº†<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> tornado <span class="keyword">import</span> gen</div><div class="line"><span class="keyword">from</span> tornado.ioloop <span class="keyword">import</span> IOLoop</div><div class="line"><span class="keyword">from</span> tornado.queues <span class="keyword">import</span> Queue</div><div class="line"></div><div class="line">q = Queue(maxsize=<span class="number">2</span>)</div><div class="line"></div><div class="line"><span class="meta">@gen.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">consumer</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        item = <span class="keyword">yield</span> q.get()</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            print(<span class="string">'Doing work on %s'</span> % item)</div><div class="line">            <span class="keyword">yield</span> gen.sleep(<span class="number">0.01</span>)</div><div class="line">        <span class="keyword">finally</span>:</div><div class="line">            q.task_done()</div><div class="line"></div><div class="line"><span class="meta">@gen.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">producer</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> range(<span class="number">5</span>):</div><div class="line">        <span class="keyword">yield</span> q.put(item)</div><div class="line">        print(<span class="string">'Put %s'</span> % item)</div><div class="line"></div><div class="line"><span class="meta">@gen.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    <span class="comment"># Start consumer without waiting (since it never finishes).</span></div><div class="line">    IOLoop.current().spawn_callback(consumer)</div><div class="line">    <span class="keyword">yield</span> producer()  <span class="comment"># Wait for producer to put all tasks.</span></div><div class="line">    <span class="keyword">yield</span> q.join()  <span class="comment"># Wait for consumer to finish all tasks.</span></div><div class="line">    print(<span class="string">'Done'</span>)</div><div class="line"></div><div class="line">IOLoop.current().run_sync(main)</div></pre></td></tr></table></figure></p>
<h3 id="æ§åˆ¶æƒè½¬ç§»"><a href="#æ§åˆ¶æƒè½¬ç§»" class="headerlink" title="æ§åˆ¶æƒè½¬ç§»"></a>æ§åˆ¶æƒè½¬ç§»</h3><p>åœ¨pythonè‡ªå¸¦æ¨¡å—é‡Œé¢çš„queueæ˜¯ç»™å¤šçº¿ç¨‹ä½¿ç”¨çš„.æ„å‘³ç€å½“é˜Ÿåˆ—é‡Œé¢æ²¡æœ‰å…ƒç´ çš„æ—¶å€™ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚é˜»å¡ä¸»çº¿ç¨‹è¿™ç§æ“ä½œåœ¨åç¨‹é‡Œé¢å½“ç„¶æ˜¯ä¸å…è®¸çš„ã€‚åç¨‹é‡Œé¢éœ€è¦çš„æ˜¯å½“æŸäº‹éœ€è¦è¿›è¡Œç­‰å¾…çš„æ—¶å€™ä¸»åŠ¨è®©å‡ºæ§åˆ¶æƒé™ï¼Œè®©å…¶ä»–çš„äº‹ä»¶æ‰§è¡Œã€‚å…·ä½“æ¥è¯´ï¼Œå¦‚ä½•è®©å‡ºæ§åˆ¶æƒå‘¢ã€‚ç†è§£ä¸Šä¸€ç¯‡çš„coroutineå°±å¯ä»¥å‘ç°ã€‚<span style="color:red"><strong>yield ä¸€ä¸ªæš‚æ—¶è¿˜æ²¡æœ‰ç»“æœçš„Futureå°±ä¼šå¯¼è‡´æ§åˆ¶æƒè½¬ç§»ï¼Œç­‰Futureç»“æœåˆ°æ¥yieldå°±ä¼šè¢«æ¢å¤</strong></span><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> tornado.gen <span class="keyword">import</span> coroutine,sleep</div><div class="line"><span class="keyword">from</span> tornado.ioloop <span class="keyword">import</span> IOLoop</div><div class="line"></div><div class="line"><span class="meta">@coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">xx</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">yield</span> sleep(<span class="number">1</span>)</div><div class="line">    print(<span class="string">"xx"</span>)</div><div class="line"></div><div class="line"><span class="meta">@coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">x</span><span class="params">()</span>:</span></div><div class="line">    xx()</div><div class="line">    print(<span class="string">"x"</span>)</div><div class="line"></div><div class="line"><span class="comment"># x()</span></div><div class="line"><span class="comment"># IOLoop.instance().start()</span></div><div class="line">IOLoop.instance().run_sync(x)</div></pre></td></tr></table></figure><br>è§‚å¯Ÿè¿™ä¸ªä¾‹å­ã€‚æ­£å¸¸çš„å†™æ³•æ˜¯<code>yield xx()</code>ï¼Œç„¶åä¼šè°ƒç”¨xx(),è¿‡ä¸€ç§’ä¹‹åæ‰“å°xxå†æ‰“å°xã€‚å¦‚æœç›´æ¥ä½¿ç”¨xxï¼Œå…¶å®è¿™æ®µä»£ç ä¹Ÿæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚xxè¿”å›äº†ä¸€ä¸ªFutureå¯¹è±¡ã€‚å› ä¸ºæ²¡æœ‰ä½¿ç”¨yieldï¼Œæ‰€ä»¥å®ƒä¸å¿…ç­‰å¾…xxå‡½æ•°æ‰§è¡Œå®Œå†è¿›è¡Œä¸‹é¢çš„æ“ä½œã€‚xxè¿”å›çš„Futureå·²ç»å¼€å§‹äº†è¿è¡Œ(å®ƒå¹¶ä¸ä¼šä»€ä¹ˆéƒ½ä¸å‘ç”Ÿ)ï¼Œå®ƒä¾æ—§åœ¨ä¸€ç§’é’Ÿä¹‹åè¢«æ‰§è¡Œç„¶åæ‰“å°xxã€‚</p>
<h3 id="Queueçš„å®ç°æ€è·¯"><a href="#Queueçš„å®ç°æ€è·¯" class="headerlink" title="Queueçš„å®ç°æ€è·¯"></a>Queueçš„å®ç°æ€è·¯</h3><p>æ ¸å¿ƒæ€è·¯æ˜¯</p>
<ul>
<li>getã€putæ“ä½œå‡è¿”å›Futureå¯¹è±¡</li>
<li>æ²¡æœ‰è¢«è®¾ç½®å€¼çš„Futureæ‰§è¡Œyieldä¼šæœ‰é˜»å¡æ•ˆæœ</li>
</ul>
<p>åˆ›å»ºä¸‰ä¸ªé˜Ÿåˆ—åˆ†åˆ«ä¸ºæ­£å¸¸é˜Ÿåˆ—_queueã€æœªæ¥geté˜Ÿåˆ—_gettersï¼Œæœªæ¥puté˜Ÿåˆ—_puttersã€‚<br>æ‰§è¡Œgetæ“ä½œçš„æ—¶å€™åˆ›å»ºä¸€ä¸ªFutureå¯¹è±¡ã€‚ä¼˜å…ˆä»_puttersé‡Œé¢è·å–.è·å¾—çš„æ˜¯ä¸€ä¸ªå€¼å’Œä¸€ä¸ªFutureå¯¹è±¡ï¼Œæ‰§è¡ŒFuture.set_resultã€‚æ­¤æ—¶ä»£è¡¨putè¢«é˜»å¡ï¼Œæ‰§è¡Œset_resultå–æ¶ˆé˜»å¡ã€‚å†è€ƒè™‘ä»_queueé‡Œé¢å–ï¼Œä»£è¡¨æ­£å¸¸å–å€¼ã€‚å¦‚æœéƒ½æ²¡æœ‰åˆ™æ”¾å…¥_gettersé˜Ÿåˆ—(æ­¤æ—¶å› ä¸ºFuturesæ²¡æœ‰å€¼ï¼Œå–å€¼çš„åœ°æ–¹è¢«é˜»å¡)ã€‚</p>
<p>æ‰§è¡Œputå°±æ˜¯ç›¸åçš„æ“ä½œï¼Œä¼˜å…ˆä»_gettersé‡Œé¢å–(æœ‰å€¼åˆ™æ‰§è¡ŒFuture.set_resultï¼Œå–æ¶ˆè·å–è¿‡ç¨‹çš„é˜»å¡)ã€‚å†æ£€æŸ¥æ­£å¸¸é˜Ÿåˆ—çš„å…ƒç´ æ˜¯å¦è¶…è¿‡æœ€å¤§å€¼ã€‚å¦åˆ™åŠ å…¥æœªæ¥é˜Ÿåˆ—</p>
<p>é‚£ä¹ˆé˜Ÿåˆ—è¿˜æœ‰task_doneå’Œjoinæ“ä½œï¼Œå‰è€…æ¯ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•éƒ½ä¼šè¢«è°ƒç”¨è¡¨ç¤ºè¯¥ä»»åŠ¡å®Œæˆï¼Œåè€…è¡¨ç¤ºç­‰å¾…åŠ å…¥åˆ°é˜Ÿåˆ—çš„æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆï¼Œå¦åˆ™é˜»å¡ã€‚é¡ºä¾¿è¯´ä¸€ä¸‹tornadoçš„é”æ˜¯æ€ä¹ˆå®ç°çš„</p>
<p>ä¾æ—§æ˜¯ä¾é æ²¡æœ‰è¢«è®¾ç½®å€¼çš„Futureè¢«yieldä¼šé€ æˆé˜»å¡ã€‚è¯¥Futureè¢«è®¾ç½®å€¼åˆ™ä¼šç»§ç»­æ‰§è¡Œ<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Event</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.f = Future()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.f.done():</div><div class="line">            self.f.set_result(<span class="keyword">None</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clear</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">if</span> self.f.done():</div><div class="line">            self.f = Future()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.f</div></pre></td></tr></table></figure><br>æ³¨æ„ã€‚è¿™ä¸ªåœ°æ–¹è°ƒç”¨setå’Œclearéƒ½æ˜¯ä¸å¸¦yieldçš„ï¼Œåªæœ‰å½“æœ€åè°ƒç”¨waitæ‰ä½¿ç”¨yieldã€‚</p>
<h3 id="Queueçš„å®ç°"><a href="#Queueçš„å®ç°" class="headerlink" title="Queueçš„å®ç°"></a>Queueçš„å®ç°</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Queue</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, maxsize=None)</span>:</span></div><div class="line">        self.max_size = maxsize <span class="keyword">or</span> <span class="number">2</span> &lt;&lt; <span class="number">16</span></div><div class="line">        self._queue = collections.deque([])</div><div class="line">        self._getters = collections.deque([]) </div><div class="line">        self._putters = collections.deque([]) </div><div class="line">        self._unfinished_tasks = <span class="number">0</span></div><div class="line">        self._finished = Event()</div><div class="line">        self._finished.set()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></div><div class="line">        f = Future()</div><div class="line">        <span class="keyword">if</span> len(self._queue) &gt; <span class="number">0</span>:</div><div class="line">            value = self._queue.popleft()</div><div class="line">            f.set_result(value)</div><div class="line">        <span class="keyword">elif</span> len(self._putters) &gt; <span class="number">0</span>:</div><div class="line">            item, future = self._putters.popleft()</div><div class="line">            f.set_result(item)</div><div class="line">            future.set_result(<span class="keyword">None</span>)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self._getters.append(f)</div><div class="line">        <span class="keyword">return</span> f</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, value)</span>:</span></div><div class="line">        self._unfinished_tasks += <span class="number">1</span></div><div class="line">        self._finished.clear()</div><div class="line"></div><div class="line">        f = Future()</div><div class="line">        <span class="keyword">if</span>  len(self._getters) &gt; <span class="number">0</span>:</div><div class="line">            future = self._getters.pop()</div><div class="line">            f.set_result(<span class="keyword">None</span>)</div><div class="line">            future.set_result(value)</div><div class="line">        <span class="keyword">elif</span> len(self._queue) &lt; self.max_size:</div><div class="line">            self._queue.append(value)</div><div class="line">            f.set_result(<span class="keyword">None</span>)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self._putters.append((value, f))</div><div class="line">        <span class="keyword">return</span> f</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">task_done</span><span class="params">(self)</span>:</span></div><div class="line">        self._unfinished_tasks -= <span class="number">1</span></div><div class="line">        <span class="keyword">if</span> self._unfinished_tasks == <span class="number">0</span>:</div><div class="line">            self._finished.set()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">join</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self._finished.wait()</div></pre></td></tr></table></figure>
<p>æºç åšäº†æ›´å¤šçš„é€‚é…å°†_getå’Œ_putç‹¬ç«‹å‡ºæ¥ã€‚ç„¶åä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œå…ˆè¿›åå‡ºé˜Ÿåˆ—æ»¡è¶³ä¸åŒçš„å‡ºå…¥é¡ºåºè¦æ±‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»‹ç»å®ŒStackContextã€gen.engineã€gen.coroutineä¹‹åTornado3.0ä»¥å‰çš„æ ¸å¿ƒå†…å®¹åŸºæœ¬å·²ç»å®Œç»“äº†ã€‚æœ¬ç¯‡ä»‹ç»ä¸€ä¸‹gen.coroutineä¸­Futureçš„åº”ç”¨ï¼Œåœ¨tornadoä¸­ç”Ÿæˆä¸€ä¸ªé˜Ÿåˆ—çš„æ•°æ®ç»“æ„ã€‚å¦‚æœç»å¸¸å†™webçš„æƒ…å†µï¼Œå•å•åªå¤„ç†ç”¨æˆ·çš„è¾“å…¥ç»™å‡ºè¾“å‡ºï¼Œé‚£ä¹ˆè¦æ±‚ä¸ä¼šå¤ªå¤šï¼Œä¹Ÿä¸ä¼šç”¨åˆ°é˜Ÿåˆ—ã€‚å¯æ˜¯å¦‚æœä½ å»å†™ä¸€ä¸ªçˆ¬è™«ï¼Œè‚¯å®šéœ€è¦é™é€Ÿå•¥çš„ï¼Œæ­¤æ—¶é˜Ÿåˆ—å°±æ˜¯ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„ä¸œè¥¿ï¼Œå¾ˆå®¹æ˜“å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ã€‚Tornadoå®˜æ–¹çš„demoä¸­ä¹Ÿæœ‰ä¸€ä¸ª[çˆ¬è™«ä»£ç (&lt;a href=&quot;https://github.com/tornadoweb/tornado/blob/master/demos/webspider/webspider.py)]æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨é˜Ÿåˆ—(æœ¬ç¯‡åŸºäºv5.0.0&quot;&gt;https://github.com/tornadoweb/tornado/blob/master/demos/webspider/webspider.py)]æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨é˜Ÿåˆ—(æœ¬ç¯‡åŸºäºv5.0.0&lt;/a&gt;)&lt;/p&gt;
    
    </summary>
    
      <category term="Tornado" scheme="https://www.zoulei.net/categories/Tornado/"/>
    
    
  </entry>
  
  <entry>
    <title>Tornado ä¹‹gen.coroutine</title>
    <link href="https://www.zoulei.net/2018/03/17/Tornado_gen_coroutine/"/>
    <id>https://www.zoulei.net/2018/03/17/Tornado_gen_coroutine/</id>
    <published>2018-03-17T07:54:43.000Z</published>
    <updated>2018-03-17T11:10:21.530Z</updated>
    
    <content type="html"><![CDATA[<p>2013å¹´Tornado3.0ç‰ˆæœ¬ã€‚gen.coroutineä¸Šçº¿ï¼Œç›´åˆ°ä»Šå¤©å®ƒä¾æ—§æ˜¯ç›®å‰Tornadoä¸­ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„è£…é¥°å™¨ã€‚åŒæ—¶å®ƒä¹Ÿæ˜¯æ¥æ›¿gen.engineçš„å­˜åœ¨ã€‚å®ƒåŸºæœ¬å»æ‰äº†gen.Taskçš„å¥—è·¯ã€‚ç›¸å¯¹gen.engineè€Œè¨€ã€‚å®ƒåªéœ€è¦gen.coroutineå°±å¤Ÿäº†ï¼Œå†™æ³•ä¸Šæ›´ä¸ºç¾è§‚</p>
<a id="more"></a>
<h3 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h3><p>éœ€è¦å®ç°çš„ç›®æ ‡æ˜¯è¿™æ ·çš„<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenAsyncHandler</span><span class="params">(RequestHandler)</span>:</span></div><div class="line"><span class="meta">    @asynchronous</span></div><div class="line"><span class="meta">    @gen.coroutine</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></div><div class="line">        http_client = AsyncHTTPClient()</div><div class="line">        response = <span class="keyword">yield</span> http_client.fetch(<span class="string">"http://example.com"</span>)</div><div class="line">        do_something_with_response(response)</div><div class="line">        self.render(<span class="string">"template.html"</span>)</div></pre></td></tr></table></figure></p>
<p>åœ¨è¿™é‡Œï¼Œå®ƒå¹¶ä¸æ˜¯gen.engineæ—¶ä»£çš„ä½œé£ã€‚åœ¨ä¸Šä¸€ç¯‡ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ·»åŠ gen.engineçš„æ—¶å€™æ²¡æœ‰æ”¹åŠ¨è¿‡ä»»ä½•å·²æœ‰ä»£ç ã€‚å¯æ˜¯åœ¨gen.coroutineæ—¶ä»£ã€‚å®ƒå»æ‰äº†gen.Taskã€‚äºæ­¤åŒæ—¶ï¼Œæ”¹åŠ¨çš„æ˜¯http_client.fetchã€‚</p>
<h3 id="Future"><a href="#Future" class="headerlink" title="Future"></a>Future</h3><p>Taskè¿™ä¸ªåè¯ä¸å¤Ÿç‚«é…·ï¼Œç„¶åå®ƒæ–°å¢äº†ä¸€ä¸ªç±»å«åšFutureã€‚<code>æœªæ¥</code>è¿™ä¸ªè¯çœ‹èµ·æ¥å°±å¾ˆæœ‰ç§‘æŠ€æ„Ÿã€‚æ˜¯çš„ï¼Œå®ƒè¡¨è¿°çš„æ˜¯ï¼Œåœ¨æœªæ¥æŸä¸€åˆ»ï¼Œè¿™ä¸ªå¯¹è±¡ä¼šå¾—åˆ°ç»“æœï¼Œå½“ç„¶è¿™èƒŒåçš„ä¸€åˆ‡ä»ç„¶æ˜¯æ¢æ±¤ä¸æ¢è¯ç”±å›è°ƒæ“ä½œæ¥å®Œæˆã€‚çœ‹ä¸€ä¸‹Futureéƒ½æœ‰å•¥<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Future</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self._val = <span class="keyword">None</span></div><div class="line">        self._callback = set()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_result</span><span class="params">(self, value)</span>:</span></div><div class="line">        self._val = value</div><div class="line">        <span class="keyword">for</span> callback <span class="keyword">in</span> self._callback:</div><div class="line">            callback(self)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">result</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self._val</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_done_callback</span><span class="params">(self, callback)</span>:</span></div><div class="line">        self._callback.add(callback)</div></pre></td></tr></table></figure><br>ä¸€ä¸ªFutureç±»å¯ä»¥å¦‚æ­¤çš„ç®€å•ã€‚å®ƒåªæ˜¯æä¾›äº†ä¸€ä¸ª_valçš„å­˜å‚¨åœºæ‰€ï¼Œå¦å¤–å½“ä½¿ç”¨set_resultè®¾ç½®å€¼çš„æ—¶å€™ä¼šé¡ºä¾¿å°†åŠ å…¥åˆ°è¯¥å¯¹è±¡çš„å›è°ƒè¿›è¡Œè°ƒç”¨ã€‚æä¾›äº†æ·»åŠ å›è°ƒçš„å‡½æ•°add_done_callback</p>
<p>å›å¿†gen.Taskï¼Œå®ƒåšçš„äº‹æƒ…æ˜¯å¯¹åŒ…å«callbackå‚æ•°çš„å‡½æ•°Aè¿›è¡ŒåŒ…è£…ï¼Œå½“å‡½æ•°Açš„callbackè¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå®é™…ä¸Šè°ƒç”¨çš„æ˜¯Runner.result_callbackã€‚è¿™ç§åšæ³•çš„ç¼ºç‚¹å‘¢å°±æ˜¯åœ¨RequestHandler.geté‡Œé¢éœ€è¦å‡ºç°gen.Taskã€‚ç°åœ¨æˆ‘ä»¬ä¸å¸Œæœ›å®ƒå‡ºç°ã€‚æˆ‘ä»¬å®Œå…¨å¯ä»¥æ”¹å˜è¿™ä¸€é€»è¾‘ã€‚å› ä¸ºhttp_client.fetchè‚¯å®šæ˜¯ä¼šè°ƒç”¨callbackçš„ã€‚å¯ä»¥æƒ³è±¡å®ƒæœ€ç»ˆçš„è¯­å¥æ˜¯<code>callback(result)</code>ã€‚<span style="color:red"><strong>æ—¢ç„¶æ¡†æ¶å¸Œæœ›è®©ç”¨æˆ·ä¸å¿…è¾“å…¥gen.Taskï¼Œé‚£ä¹ˆå¯ä»¥é€‰æ‹©åœ¨http_client.fetchä¸­åŠ å…¥Future,è®¾ç½®å®ƒçš„callbackä¸ºFuture.set_result</strong></span>ã€‚éšä¾¿ä¸¾ä¾‹å¦‚ä¸‹ã€‚å‡è®¾æœ‰ä¸€ä¸ªå‡½æ•°æ˜¯add_one,åŸæœ¬é€»è¾‘å¦‚ä¸‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_one</span><span class="params">(ret, callback)</span>:</span></div><div class="line">    ret += <span class="number">1</span></div><div class="line">    IOLoop.instance().add_callback(<span class="keyword">lambda</span>: callback(ret))</div></pre></td></tr></table></figure><br>æ”¹å†™æˆè¿™ä¸ªæ ·å­<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_one</span><span class="params">(ret)</span>:</span></div><div class="line">    future = Future()</div><div class="line">    ret += <span class="number">1</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">callback</span><span class="params">()</span>:</span></div><div class="line">        <span class="keyword">return</span> future.set_result(ret)</div><div class="line">    IOLoop.instance().add_callback(callback)</div><div class="line">    <span class="keyword">return</span> future</div></pre></td></tr></table></figure><br>è™½ç„¶è¿™ä¸ªåœ°æ–¹æœ€ç»ˆè¢«future.set_resultæ‰§è¡Œã€‚å¯æ˜¯Futureæä¾›äº†add_done_callbackæ¥å£ï¼Œ<span style="color:red"><strong>æ„å‘³ç€å…è®¸æˆ‘ä»¬è‡ªå·±çš„callbackèƒ½å¤Ÿåœ¨add_oneæ‰§è¡Œå®Œæ¯•åè¢«future.set_resultæ‰€è§¦å‘</strong></span>ï¼ŒåŒæ—¶æ³¨æ„add_oneè¿”å›çš„æ˜¯ä¸€ä¸ªfutureå¯¹è±¡</p>
<h3 id="coroutine"><a href="#coroutine" class="headerlink" title="coroutine"></a>coroutine</h3><p>å‡å¦‚æˆ‘ä»¬ç±»æ¯”gen.engineå»å®ç°å®ƒ<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Runner</span><span class="params">()</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, g)</span>:</span></div><div class="line">        self.g = g</div><div class="line">        <span class="comment"># å¾—åˆ°ä¸€ä¸ªFuture</span></div><div class="line">        self.yielded = self.g.send(<span class="keyword">None</span>)</div><div class="line">        self.yielded.add_done_callback(self.future_callback)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">future_callback</span><span class="params">(self, future)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.result_callback(future.result())</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">result_callback</span><span class="params">(self, value)</span>:</span></div><div class="line">        self.result = value</div><div class="line">        self.run()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            self.yielded = self.g.send(self.yielded.result())</div><div class="line">            self.yielded.add_done_callback(self.future_callback)</div><div class="line">        <span class="keyword">except</span> StopIteration:</div><div class="line">            <span class="keyword">return</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">coroutine</span><span class="params">(func)</span>:</span></div><div class="line"><span class="meta">    @wraps(func)</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">        result = func(*args, **kwargs)</div><div class="line">        <span class="keyword">return</span> Runner(result)</div><div class="line">    <span class="keyword">return</span> inner</div></pre></td></tr></table></figure><br>æ˜¯ä¸æ˜¯å‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼Œè¿˜å¯ä»¥æ­£å¸¸è¿è¡Œã€‚ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªæå¤§çš„ç¼ºé™·ã€‚å®ƒæ— æ³•è¢«åµŒå¥—ä½¿ç”¨ï¼Œä»€ä¹ˆæ„æ€å‘¢<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> tornado.gen <span class="keyword">import</span> coroutine</div><div class="line"><span class="meta">@coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">a</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">yield</span> b()</div><div class="line"></div><div class="line"><span class="meta">@coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">b</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> <span class="number">1</span></div></pre></td></tr></table></figure><br>åŒæ—¶åœ¨gen.engineæ—¶ä»£, è¿™ç§è°ƒç”¨æ–¹å¼ä¹Ÿæ˜¯ä¸è¢«å…è®¸çš„ï¼Œå¯æ˜¯gen.coroutineå®ç°äº†è¿™ç§æ–¹å¼çš„è°ƒç”¨ã€‚ä¸»è¦åŸç†æ˜¯æˆ‘ä»¬è§„å®šï¼Œæ‰€æœ‰yieldå³è¾¹çš„å€¼å…¨éƒ¨æ˜¯Futureå¯¹è±¡ï¼Œå¯¹ä¸€ä¸ªFutureå¯¹è±¡å¤„ç†å®Œæ¯•åå†å¤„ç†ä¸‹ä¸€ä¸ªã€‚é‚£ä¹ˆå°±è¦ä¿®æ”¹coroutineäº†<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">coroutine</span><span class="params">(func)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner</span><span class="params">()</span>:</span></div><div class="line">        f = Future()</div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">final_callback</span><span class="params">(value)</span>:</span></div><div class="line">            f.set_result(value)</div><div class="line">        Runner(func, final_callback)</div><div class="line">        <span class="keyword">return</span> f</div><div class="line">    <span class="keyword">return</span> inner</div></pre></td></tr></table></figure><br>å¯¹äºæ¯ä¸€ä¸ªå­coroutineï¼Œå®ƒä»¬éƒ½ä¼šç”Ÿæˆä¸€ä¸ªRunnerå¯¹è±¡(æ­¤æ—¶Runnerå·²ç»å°†ç”Ÿæˆå™¨è¿›è¡Œåˆå§‹åŒ–ï¼Œæ‰§è¡Œsend(None)ï¼Œå¹¶add_done_callback)ï¼Œåªæ˜¯å®ƒä»¬è¿”å›çš„å¹¶ä¸æ˜¯Runnerï¼Œè€Œæ˜¯Future.åœ¨Futureè¢«æ‰§è¡Œset_resultæ“ä½œçš„æ—¶å€™å­coroutineçš„yieldå¾€ä¸‹èµ°ã€‚ç›´åˆ°é‡åˆ°StopIterationå¼‚å¸¸ï¼Œæ­¤æ—¶final_callbackå‡½æ•°è¢«è°ƒç”¨ï¼Œå®ƒè¢«çˆ¶coroutineæ‰€æ¥å—ï¼Œè§¦å‘çˆ¶coroutineçš„yieldå¾€ä¸‹èµ°ã€‚ã€‚ã€‚ã€‚å ªç§°å®Œç¾ã€‚ã€‚ã€‚ã€‚</p>
<p>å°±è¿™æ ·ï¼Œå®ƒå®ç°äº†å’Œyield fromå·®ä¸å¤šçš„é€»è¾‘ã€‚çˆ¶ç”Ÿæˆå™¨è°ƒç”¨å­ç”Ÿæˆå™¨ï¼Œç®€ç›´å…­çš„é£èµ·ä¸æœä¸è¡Œ<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Runner</span><span class="params">()</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, gen, final_callback)</span>:</span></div><div class="line">        self.final_callback = final_callback</div><div class="line">        self.gen = gen()</div><div class="line">        self.yielded = self.gen.send(<span class="keyword">None</span>)</div><div class="line">        <span class="comment"># ä¼šå›è°ƒfutureå¯¹è±¡</span></div><div class="line">        self.yielded.add_done_callback(self.future_callback)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">future_callback</span><span class="params">(self, future)</span>:</span></div><div class="line">        self.run()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            self.yielded = self.gen.send(self.yielded.result())</div><div class="line">        <span class="keyword">except</span> StopIteration <span class="keyword">as</span> e:</div><div class="line">            self.final_callback(e.value)</div><div class="line">            <span class="keyword">return</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self.yielded.add_done_callback(self.future_callback)</div></pre></td></tr></table></figure></p>
<p>è¯´å®è¯ï¼Œè¿˜æ˜¯æ„Ÿè§‰æœ‰ç‚¹ç»•ï¼Œå¸Œæœ›ä½ èƒ½å¤Ÿçœ‹æ˜ç™½</p>
<h3 id="æ”¹è¿›"><a href="#æ”¹è¿›" class="headerlink" title="æ”¹è¿›"></a>æ”¹è¿›</h3><p>å’Œä¸Šé¢çš„ç®€æ˜“å†™æ³•ä¸åŒã€‚Tornadoæºç çš„å®ç°è¦å¤æ‚ä¸€äº›ï¼Œå› ä¸ºå®ƒè¦è€ƒè™‘æ›´å¤æ‚çš„éœ€æ±‚</p>
<ul>
<li>å…¼å®¹æ€§ï¼Œå®ƒä¸èƒ½å› ä¸ºæœ‰äº†Futureå¯¹è±¡åå°±å®Œå…¨ä¸é¡¾ä»¥å‰gen.Taskçš„å†™æ³•</li>
<li>å®ƒåŒæ ·éœ€è¦å®ç°ä¸€æ¬¡yieldå¤šä¸ªFutureçš„éœ€æ±‚</li>
</ul>
<p>æ‰€ä»¥ï¼Œå®ƒå¦å¤–ç”Ÿæˆäº†ä¸€ä¸ªå’Œgen.Taskç±»ä¼¼çš„å¯¹è±¡YieldFutureã€‚å’Œgen.Taskæ‹¥æœ‰çš„æˆå‘˜å¯¹è±¡ä¸€æ ·<br><code>start</code>ã€<code>is_ready</code>ã€<code>get_result</code>ã€‚åŒæ—¶ç”±äºFutureåœ¨Tornadoä¸­åº”ç”¨æ˜¯å¦‚æ­¤çš„æ™®éã€‚IOLoopæ–°å¢äº†ä¸€ä¸ªæ–¹æ³•add_futureå‡½æ•°(è¿˜æœ‰ä¸€æ–¹é¢å°±æ˜¯å‰é¢æåˆ°çš„callbackå¼‚å¸¸é—®é¢˜)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_future</span><span class="params">(self, future, callback)</span>:</span></div><div class="line">    <span class="keyword">assert</span> isinstance(future, Future)</div><div class="line">    callback = stack_context.wrap(callback)</div><div class="line">    future.add_done_callback(</div><div class="line">        <span class="keyword">lambda</span> future: self.add_callback(callback, future))</div></pre></td></tr></table></figure><br>åœ¨ä½¿ç”¨çš„æ—¶å€™<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">self.runner = runner</div><div class="line">self.key = object()</div><div class="line">runner.register_callback(self.key)</div><div class="line">self.io_loop.add_future(self.future, runner.result_callback(self.key))</div></pre></td></tr></table></figure></p>
<p>å®é™…ä¸Šå¦‚æœä¸è€ƒè™‘å¼‚å¸¸æƒ…å†µï¼Œå’Œå®ƒæ˜¯ç­‰ä»·çš„<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Future.add_done_callback(self.future_callback)</div></pre></td></tr></table></figure></p>
<p>å’Œgen.engineä¸€æ ·ã€‚coroutineä¹Ÿä¼šé‡åˆ°è¿™ç§é—®é¢˜<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@gen.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></div><div class="line">    http_client = AsyncHTTPClient()</div><div class="line">    response1, response2 = <span class="keyword">yield</span> [http_client.fetch(url1),</div><div class="line">                                  http_client.fetch(url2)]</div><div class="line">    response_dict = <span class="keyword">yield</span> dict(response3=http_client.fetch(url3),</div><div class="line">                               response4=http_client.fetch(url4))</div><div class="line">    response3 = response_dict[<span class="string">'response3'</span>]</div><div class="line">    response4 = response_dict[<span class="string">'response4'</span>]</div></pre></td></tr></table></figure><br>ä¸€æ¬¡yield å¤šä¸ªFutureå¯¹è±¡ã€‚é‚£ä¹ˆè§£å†³åŠæ³•ä¹Ÿæ˜¯å’Œengineå·®ä¸å¤šçš„ã€‚å½“å‘ç°send(value)è¿”å›å€¼æ˜¯ä¸€ä¸ªlistæˆ–è€…dictå¯¹è±¡æ—¶ã€‚å®ƒä¼šä½¿ç”¨Multiè¿›è¡Œå°è£…ã€‚åœ¨è¢«å›è°ƒçš„æ—¶å€™æ£€æŸ¥Multiå¯¹è±¡çš„is_readyçŠ¶æ€ã€‚ä»…ä»…å½“éƒ½å¾—åˆ°ç»“æœæ‰ç®—å®Œæˆ</p>
<p>å¦å¤–åœ¨Tornado3.1ç‰ˆæœ¬HandlerRequest._executeè¿›è¡Œæ”¹åŠ¨ã€‚è¢«coroutineè£…é¥°çš„å‡½æ•°ä¸éœ€è¦å†è¢«asynchronousæ‰€è£…é¥°ã€‚è‡³æ­¤è¿™ä¸ªä»1.0.0è·¨è¶Šåˆ°3.1.0ç‰ˆæœ¬çš„è£…é¥°å™¨çš„ç”Ÿå‘½èµ°åˆ°äº†å°½å¤´ã€‚ç„¶è€Œä¾æ—§å¾ˆå¤šäººä¸ç®¡ä¸é¡¾ç¡¬æ˜¯è¦åŠ ä¸Šè¿™ä¸ªè£…é¥°å™¨æ‰å®‰å¿ƒ</p>
<h3 id="åº”ç”¨ä¸€"><a href="#åº”ç”¨ä¸€" class="headerlink" title="åº”ç”¨ä¸€"></a>åº”ç”¨ä¸€</h3><p>å¯ä»¥è¯´è‡ªæ­¤ä¹‹åTornadoåªå­˜åœ¨Futureé…åˆyieldã€coroutineçš„æ“ä½œã€‚ä½ ä»å¤´æ–°å»ºä¸€ä¸ªTornadoçš„å¼‚æ­¥åº“ã€‚ç”¨æˆ·è°ƒç”¨æœ€åå¿…å®šæ˜¯è¿”å›ç»™ç”¨æˆ·Futureå¯¹è±¡ã€‚è¿™é‡Œæˆ‘å°è±¡æ¯”è¾ƒæ·±çš„å°±æ˜¯ç”¨Futureå®ç°äº†celeryç»“æœçš„å¼‚æ­¥è·å–ã€‚è¯´æ˜¯å¼‚æ­¥ã€‚å®è´¨ä¸Šå°±æ˜¯è½®è¯¢ã€‚<a href="https://github.com/mayflaver/tornado-celery/blob/master/torncelery.py">ä»£ç åœ¨è¿™é‡Œ</a><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> tornado.concurrent <span class="keyword">import</span> TracebackFuture</div><div class="line"><span class="keyword">from</span> tornado.ioloop <span class="keyword">import</span> IOLoop</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">async</span><span class="params">(task, *args, **kwargs)</span>:</span></div><div class="line">    future = TracebackFuture()</div><div class="line">    callback = kwargs.pop(<span class="string">"callback"</span>, <span class="keyword">None</span>)</div><div class="line">    <span class="keyword">if</span> callback:</div><div class="line">        IOLoop.instance().add_future(future,</div><div class="line">                                     <span class="keyword">lambda</span> future: callback(future.result()))</div><div class="line">    result = task.delay(*args, **kwargs)</div><div class="line">    IOLoop.instance().add_callback(_on_result, result, future)</div><div class="line">    <span class="keyword">return</span> future</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_on_result</span><span class="params">(result, future)</span>:</span></div><div class="line">    <span class="comment"># if result is not ready, add callback function to next loop,</span></div><div class="line">    <span class="keyword">if</span> result.ready():</div><div class="line">        future.set_result(result.result)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        IOLoop.instance().add_callback(_on_result, result, future)</div></pre></td></tr></table></figure><br>celeryæ‰§è¡Œtask.delayç«‹åˆ»è¿”å›äº†resultå¯¹è±¡ã€‚ç„¶åå°†resuleå’ŒfutureåŠ å…¥å›è°ƒï¼ŒæŸ¥è¯¢resule.readyç¡®å®šä»»åŠ¡æ˜¯å¦å®Œæˆã€‚ä¸€æ—¦å®Œæˆåˆ™è°ƒç”¨future.set_resuleã€‚Futureå¯¹è±¡è®¾ç½®å€¼ä¹‹åyieldå°±ä¼šç»§ç»­å¾€ä¸‹èµ°ã€‚å®Œç¾~~~ï¼Œå¦åˆ™å®ƒä¼šå†æ¬¡å¾ªç¯ï¼Œç›´åˆ°å¾—åˆ°ç»“æœä¸ºæ­¢ã€‚å¯ä»¥çœ‹åˆ°å®ƒè¿™ç§æ–¹å¼è¿˜æ˜¯ç›¸å½“çš„ç²—æš´çš„ï¼Œå› ä¸ºä¸€æ—¦æ²¡æœ‰ç»“æœå°±ä¼šä¸åœçš„å¾ªç¯ã€‚å¯æ˜¯è¿™ç§æ–¹å¼èƒœåœ¨ä»£ç ç®€å•</p>
<h3 id="åº”ç”¨äºŒ"><a href="#åº”ç”¨äºŒ" class="headerlink" title="åº”ç”¨äºŒ"></a>åº”ç”¨äºŒ</h3><p>å†æ¥ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œgen.sleep() æ¯”è¾ƒæ²¡æœ‰æƒ³åˆ°ï¼Œå®ƒä¼šæ˜¯4.1.0ç‰ˆæœ¬æ‰åŠ å…¥çš„ï¼Œå®ç°å¦‚ä¸‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">sleep</span><span class="params">(duration)</span>:</span></div><div class="line">    f = Future()</div><div class="line">    IOLoop.current().call_later(duration, <span class="keyword">lambda</span>: f.set_result(<span class="keyword">None</span>))</div><div class="line">    <span class="keyword">return</span> f</div></pre></td></tr></table></figure><br>(âŠ™vâŠ™)å—¯ï¼Œæ„ä¸æ„å¤–ã€‚è¿™åº”è¯¥æ˜¯æˆ‘åœ¨Tornadoé‡Œé¢å‘ç°æœ€ç®€å•çš„ä»£ç äº†ï¼Œåˆ›å»ºä¸€ä¸ªFutureå¯¹è±¡ï¼Œç„¶ååœ¨IOLoopçš„_timeoutåˆ—è¡¨ä¸­åŠ å…¥ä¸€ä¸ªåˆ°æœŸæ‰§è¡Œå›è°ƒï¼Œè®¾ç½®Futureçš„å€¼ã€‚è‡³æ­¤yieldç»§ç»­å¾€ä¸‹èµ°~~</p>
<h3 id="ç®€æ˜“ä»£ç "><a href="#ç®€æ˜“ä»£ç " class="headerlink" title="ç®€æ˜“ä»£ç "></a>ç®€æ˜“ä»£ç </h3><p>å¯ä»¥ç”¨ä¸‹é¢è¿™æ®µç®€æ˜“ä»£ç è§‚å¯Ÿä¸€ä¸‹coroutineçš„é€»è¾‘<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> tornado.ioloop</div><div class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Future</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self._val = <span class="keyword">None</span></div><div class="line">        self._callback = set()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_result</span><span class="params">(self, value)</span>:</span></div><div class="line">        self._val = value</div><div class="line">        <span class="keyword">for</span> callback <span class="keyword">in</span> self._callback:</div><div class="line">            callback(self)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">result</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self._val</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_done_callback</span><span class="params">(self, callback)</span>:</span></div><div class="line">        self._callback.add(callback)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Runner</span><span class="params">()</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, gen, final_callback)</span>:</span></div><div class="line">        self.final_callback = final_callback</div><div class="line">        self.gen = gen()</div><div class="line">        self.yielded = self.gen.send(<span class="keyword">None</span>)</div><div class="line">        <span class="comment"># ä¼šå›è°ƒfutureå¯¹è±¡</span></div><div class="line">        self.yielded.add_done_callback(self.future_callback)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">future_callback</span><span class="params">(self, future)</span>:</span></div><div class="line">        self.run()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            self.yielded = self.gen.send(self.yielded.result())</div><div class="line">        <span class="keyword">except</span> StopIteration <span class="keyword">as</span> e:</div><div class="line">            self.final_callback(e.value)</div><div class="line">            <span class="keyword">return</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self.yielded.add_done_callback(self.future_callback)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">coroutine</span><span class="params">(func)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner</span><span class="params">()</span>:</span></div><div class="line">        f = Future()</div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">final_callback</span><span class="params">(value)</span>:</span></div><div class="line">            f.set_result(value)</div><div class="line">        Runner(func, final_callback)</div><div class="line">        <span class="keyword">return</span> f</div><div class="line">    <span class="keyword">return</span> inner</div><div class="line"></div><div class="line"><span class="meta">@coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">haha</span><span class="params">()</span>:</span></div><div class="line">    c = <span class="keyword">yield</span> haha1()</div><div class="line">    r = <span class="keyword">yield</span> add_one(<span class="number">1</span>)</div><div class="line">    b = <span class="keyword">yield</span> add_one(<span class="number">2</span>)</div><div class="line">    print(r, b, c)</div><div class="line"></div><div class="line"><span class="meta">@coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">haha1</span><span class="params">()</span>:</span></div><div class="line">    r = <span class="keyword">yield</span> add_one(<span class="number">1</span>)</div><div class="line">    b = <span class="keyword">yield</span> add_one(<span class="number">2</span>)</div><div class="line">    <span class="keyword">return</span> r + b</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_one</span><span class="params">(ret)</span>:</span></div><div class="line">    f = Future()</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">callback</span><span class="params">(future, result)</span>:</span></div><div class="line">        future.set_result(result)</div><div class="line">    tornado.ioloop.IOLoop.instance().add_callback(partial(callback, f, ret + <span class="number">1</span>))</div><div class="line">    <span class="keyword">return</span> f</div><div class="line">haha()</div><div class="line"></div><div class="line">tornado.ioloop.IOLoop().instance().start()</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;2013å¹´Tornado3.0ç‰ˆæœ¬ã€‚gen.coroutineä¸Šçº¿ï¼Œç›´åˆ°ä»Šå¤©å®ƒä¾æ—§æ˜¯ç›®å‰Tornadoä¸­ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„è£…é¥°å™¨ã€‚åŒæ—¶å®ƒä¹Ÿæ˜¯æ¥æ›¿gen.engineçš„å­˜åœ¨ã€‚å®ƒåŸºæœ¬å»æ‰äº†gen.Taskçš„å¥—è·¯ã€‚ç›¸å¯¹gen.engineè€Œè¨€ã€‚å®ƒåªéœ€è¦gen.coroutineå°±å¤Ÿäº†ï¼Œå†™æ³•ä¸Šæ›´ä¸ºç¾è§‚&lt;/p&gt;
    
    </summary>
    
      <category term="Tornado" scheme="https://www.zoulei.net/categories/Tornado/"/>
    
    
  </entry>
  
  <entry>
    <title>Tornado ä¹‹gen.engine</title>
    <link href="https://www.zoulei.net/2018/03/17/tornado_gen_engine/"/>
    <id>https://www.zoulei.net/2018/03/17/tornado_gen_engine/</id>
    <published>2018-03-17T04:13:51.000Z</published>
    <updated>2018-03-17T07:49:00.209Z</updated>
    
    <content type="html"><![CDATA[<p>Tornadoåœ¨2011å¹´çš„2.1ç‰ˆæœ¬åŠ å…¥äº†gen.engineæ¨¡å—ï¼Œè¯¥æ¨¡å—ä¸»è¦ä¸ºäº†è§£å†³å¼‚æ­¥ç¨‹åºç¼–å†™ä¸å¤Ÿä¼˜é›…çš„é—®é¢˜ã€‚åŠ›å›¾è®©ä½¿ç”¨è€…ç¦»callbackæ›´è¿œï¼Œè¿™ä¹Ÿæ˜¯Tornadoå‰å®³çš„åœ°æ–¹ã€‚æœ¬æ¥å†…éƒ¨å„ç§äº‹ä»¶å¤„ç†ï¼Œcallbackæ»¡å¤©é£ï¼Œå¯æ˜¯åœ¨ç”¨æˆ·çœ¼é‡Œï¼Œå®ƒé‚£ä¸ªclass Handler(web.RequestHandler)ä¸‹é¢getçš„å†™æ³•å’ŒåŒæ­¥å†™æ³•å·®ä¸å¤šå˜›ã€‚å’ŒåŒæ­¥çš„å†™æ³•ä¸€æ ·ï¼Œè·å¾—äº†æ›´é«˜çš„æ€§èƒ½ï¼Œæˆ‘æƒ³è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆTornadoèƒ½å‡ºå½©çš„åœ°æ–¹å§(æœ¬æ–‡ä»£ç åŸºäºv2.3.0)</p>
<a id="more"></a>
<h3 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h3><p>ä¸»è¦èµ·å› å°±æ˜¯ä¸å¤Ÿä¼˜é›…çš„callback,å‡è®¾æœ‰ä¸€ä¸ªéœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦å‘ç¬¬ä¸‰æ–¹apiè¯·æ±‚æ•°æ®ï¼Œç„¶åè¿”å›ç»™å®¢æˆ·ç«¯ã€‚æ­¤æ—¶å†™æ³•æ˜¯è¿™æ ·çš„<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncHandler</span><span class="params">(RequestHandler)</span>:</span></div><div class="line"><span class="meta">    @asynchronous</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></div><div class="line">        http_client = AsyncHTTPClient()</div><div class="line">        http_client.fetch(<span class="string">"http://example.com"</span>,</div><div class="line">                          callback=self.on_fetch)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">on_fetch</span><span class="params">(self, response)</span>:</span></div><div class="line">        do_something_with_response(response)</div><div class="line">        self.render(<span class="string">"template.html"</span>)</div></pre></td></tr></table></figure><br>è¿™ç§å†™æ³•ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿå‡è®¾æˆ‘ç°åœ¨éœ€è¦å¯¹è¿”å›çš„æ•°æ®è¿›è¡Œå¤„ç†ï¼Œé‚£ä¹ˆæˆ‘å¿…é¡»è¦å†™åˆ°å›è°ƒå‡½æ•°é‡Œé¢ã€‚å¦å¤–ï¼Œå¦‚æœåœ¨å›è°ƒå‡½æ•°é‡Œé¢ç»§ç»­è¦ä½¿ç”¨å…¶ä»–çš„å›è°ƒé€»è¾‘ï¼Œé‚£ä¹ˆè‚¯å®šä¹Ÿæ˜¯éœ€è¦ç»§ç»­åœ¨å›è°ƒå‡½æ•°é‡Œé¢ç¼–å†™ï¼Œæœ€åå°±å½¢æˆäº†è‘—åçš„å›è°ƒåœ°ç‹±ã€‚æ˜æ˜¾è¿™ç§æ–¹å¼æ˜¯å¾ˆè®©äººæ¶å¿ƒçš„ï¼ŒTornadoåœ¨è¿™ä¸€ç‰ˆæœ¬ä¸Šæ”¹åŠ¨æˆäº†è¿™æ ·<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenAsyncHandler</span><span class="params">(RequestHandler)</span>:</span></div><div class="line"><span class="meta">    @asynchronous</span></div><div class="line"><span class="meta">    @gen.engine</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></div><div class="line">        http_client = AsyncHTTPClient()</div><div class="line">        response = <span class="keyword">yield</span> gen.Task(http_client.fetch, <span class="string">"http://example.com"</span>)</div><div class="line">        do_something_with_response(response)</div><div class="line">        self.render(<span class="string">"template.html"</span>)</div></pre></td></tr></table></figure><br>è¿™æ ·å°±å¥½å¾ˆå¤šäº†å˜›ï¼Œæ›´ç¬¦åˆäººä»¬åŒæ­¥ç¼–å†™ä»£ç çš„ç›´è§‰ã€‚è§‚å¯Ÿæ”¹å˜æœ‰ä¸‰ä¸ªåœ°æ–¹</p>
<ul>
<li>æ•´ä¸ªå‡½æ•°æ·»åŠ äº†gen.engineè£…é¥°å™¨</li>
<li>æ·»åŠ äº†yieldè¯­å¥</li>
<li>http_client.fetchè¢«gen.Taskå°è£…èµ·æ¥</li>
</ul>
<h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><p>å…ˆè¯´ä¸€ä¸‹è¿™ä¸ªåœ°æ–¹çš„æ”¹åŠ¨ã€‚<span style="color:red"><strong>v2.1.0ç‰ˆæœ¬å¹¶æ²¡æœ‰æ”¹åŠ¨ä»»ä½•å·²æœ‰çš„ä»£ç ï¼Œä»…ä»…æ˜¯æ·»åŠ äº†gen.pyæ¨¡å—</strong></span>ï¼Œ<a href="https://github.com/tornadoweb/tornado/commit/e4ead597956457aada766b09d624a3d9f7b888d9">è¯¥commitzåœ¨è¿™é‡Œ</a>ã€‚æˆ‘è§‰å¾—è¿™ç®—æ˜¯æ¯”è¾ƒå‰å®³çš„åœ°æ–¹äº†</p>
<p>å›é¡¾è¿™é‡Œç”¨åˆ°çš„çŸ¥è¯†ç‚¹ï¼Œæ¯«æ— ç–‘é—®ï¼ŒTornadoé‡Œé¢æœ€æ ¸å¿ƒçš„yieldç»ˆäºåœ¨è¿™ä¸ªç‰ˆæœ¬ä¸Šåœºäº†ã€‚åŸæ¥http_client.fetchæ˜¯éœ€è¦ä¼ å…¥ä¸€ä¸ªcallbackå›è°ƒå‡½æ•°è¿›è¡Œå›è°ƒçš„ã€‚é‚£ä¹ˆè¢«gen.Taskå°è£…ä¹‹åï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°ä¸å­˜åœ¨äº†ï¼Œå¯ä»¥è®¤ä¸ºè¿™é‡Œæ˜¯gen.Taskè‡ªå·±å†…éƒ¨ä¼ å…¥äº†ä¸€ä¸ªå›è°ƒå‡½æ•°ã€‚è€Œåªè¦æ˜¯å‡½æ•°ç”¨åˆ°äº†yieldå…³é”®å­—ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨å¯¹è±¡ã€‚ç”Ÿæˆå™¨å¯¹è±¡æœ‰ä¸¤ä¸ªåŸºæœ¬çš„ç‰¹æ€§,æ‰§è¡Œget()å¹¶ä¸ä¼šç«‹å³å¼€å§‹æ‰§è¡Œã€æ‰§è¡Œsendåé‡åˆ°yieldä¼šè¢«æš‚åœ</p>
<p>è€ƒè™‘åˆ°ä¸Šé¢è¯´çš„gen.pyæ˜¯ä¸€ä¸ªå¾ˆç‹¬ç«‹çš„å‡½æ•°ï¼Œå¹¶æ²¡æœ‰æ”¹åŠ¨ä»»ä½•å·²æœ‰çš„ä»£ç ã€‚é‚£ä¹ˆgen.engineè£…é¥°å™¨è‚¯å®šå¯¹get()æ‰§è¡Œäº†åˆå§‹åŒ–å¹¶æ‰§è¡Œäº†send(None)è®©å®ƒå¼€å§‹è¿è¡Œèµ·æ¥ã€‚å¯æ˜¯é‡åˆ°yieldä¼šåœæ­¢ã€‚åŒæ—¶ä¸Šé¢çš„è¯­ä¹‰æ˜¯å†æ¬¡æ¢å¤åä»¥å‰http_client.fetchä¼ é€’ç»™å›è°ƒå‡½æ•°çš„å€¼éœ€è¦èµ‹å€¼ç»™responseå˜é‡ï¼Œç”Ÿæˆå™¨çš„sendæ–¹æ³•æ˜¯å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹çš„ï¼Œè¿™é‡Œå¯èƒ½å¹¶ä¸å¤ªå¥½ç†è§£ã€‚</p>
<p>ç°åœ¨å¯¹åŠŸèƒ½è¿›è¡Œåˆ’åˆ†</p>
<ul>
<li>gen.engineè£…é¥°å™¨çš„ä¸»è¦ä½œç”¨æ˜¯è®©ç”Ÿæˆå™¨è¿è¡Œèµ·æ¥(è°ƒç”¨åå†æ‰§è¡Œsend(None))</li>
<li>gen.Taskçš„ä½œç”¨æ˜¯å°†http_client.fetch å°è£…æˆTaskå¯¹è±¡ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ªå›è°ƒï¼Œè¯¥å›è°ƒä½¿å¾—sendè¢«å†æ¬¡è°ƒç”¨</li>
<li>Runner è¿™æ˜¯ä¸€ä¸ªå¯¹ç”¨æˆ·æ— æ„ŸçŸ¥çš„ç±»ã€‚è¿æ¥gen.engineå’Œgen.Task</li>
</ul>
<p>åŸºç¡€å®ç°ä»£ç å¦‚ä¸‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Runner</span><span class="params">()</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, gen)</span>:</span></div><div class="line">        self.gen = gen()</div><div class="line">        self.yielded = self.gen.send(<span class="keyword">None</span>)</div><div class="line">        self.yielded.start(self)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">result_callback</span><span class="params">(self, value)</span>:</span></div><div class="line">        self.result = value</div><div class="line">        self.run()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            self.yielded = self.gen.send(self.result)</div><div class="line">        <span class="keyword">except</span> StopIteration:</div><div class="line">            <span class="keyword">return</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self.yielded.start(self)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span><span class="params">()</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, func)</span>:</span></div><div class="line">        self.func = func</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self, runner)</span>:</span></div><div class="line">        self.func(callback=runner.result_callback)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">engine</span><span class="params">(func)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner</span><span class="params">()</span>:</span></div><div class="line">        <span class="keyword">return</span> Runner(func)</div><div class="line">    <span class="keyword">return</span> inner</div></pre></td></tr></table></figure><br>å¯ä»¥çœ‹åˆ°gen.engineæ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„è£…é¥°å™¨ï¼Œå°†ç”Ÿæˆå™¨ä¼ é€’ç»™Runnerå¹¶è¿”å›ã€‚åœ¨Runneré‡Œé¢å®ƒè¢«æ‰§è¡Œsend(None)ã€‚è¿™ä¸ªæ—¶å€™send(None)è¿”å›çš„æ˜¯Task(http_client.fetch, â€œ<a href="http://example.com&quot;)ã€‚">http://example.com&quot;)ã€‚</a></p>
<p>Taskçš„å°è£…ä¹Ÿå¯ä»¥å¾ˆç®€å•ï¼Œå®ƒä»…ä»…å­˜åœ¨ä¸€ä¸ªstartã€‚ä¼ å…¥runnerå¹¶å°†http_client.fetchçš„å›è°ƒè®¾ç½®ä¸ºrunner.result_callback</p>
<p>Runnerå‘¢ï¼Œå®ƒè´Ÿè´£äº†è®©ç”Ÿæˆå™¨å¼€å§‹è¿è¡Œï¼Œå¹¶æ‹¥æœ‰result_callbackå‡½æ•°ï¼Œåœ¨callbacké‡Œé¢ï¼Œå®ƒè°ƒç”¨äº†è‡ªèº«çš„runå‡½æ•°ã€‚åœ¨runé‡Œé¢å†æ¬¡è°ƒç”¨sendï¼Œæ­¤æ—¶sendçš„å€¼æ˜¯http_client.fetchè¿”å›çš„å€¼ã€‚å¦‚æœæ²¡æœ‰è§¦å‘StopIterationå¼‚å¸¸åˆ™è¡¨æ˜å†ä¸€æ¬¡è¿”å›äº†Taskå¯¹è±¡ã€‚é‡å¤è¿‡ç¨‹æ‰§è¡ŒTask.start</p>
<p>è¿™æ ·å®ƒå¾ˆå·§å¦™çš„å°†callbacké©±åŠ¨å˜æˆäº†yieldé©±åŠ¨ï¼Œè¦çŸ¥é“Taskå¿…å®šä¼šè°ƒç”¨callbackå‡½æ•°ï¼Œå½“callbackè¢«è°ƒç”¨çš„æ—¶å€™å°±ç­‰åŒäºèµ‹å€¼ç»™äº†yieldå·¦è¾¹çš„å˜é‡</p>
<h3 id="æ”¹è¿›"><a href="#æ”¹è¿›" class="headerlink" title="æ”¹è¿›"></a>æ”¹è¿›</h3><p>ä¸Šé¢çš„ä»£ç å¹¶æ²¡æœ‰è€ƒè™‘å¼‚å¸¸æƒ…å†µï¼Œå¦å¤–å¯èƒ½å­˜åœ¨è¿™ç§æƒ…å†µ<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></div><div class="line">    http_client = AsyncHTTPClient()</div><div class="line">    response1, response2 = <span class="keyword">yield</span> [gen.Task(http_client.fetch, url1),</div><div class="line">                                  gen.Task(http_client.fetch, url2)]</div></pre></td></tr></table></figure><br>æˆ‘ä»¬å¸Œæœ›ä¸¤ä¸ªTaskåŒæ—¶æ‰§è¡Œï¼Œè€Œä¸æ˜¯ç­‰ä¸€ä¸ªå¾—åˆ°ç»“æœåï¼Œå†å»è¯·æ±‚ç¬¬äºŒä¸ªç»“æœã€‚å› æ­¤éœ€è¦ç¨å¾®å¤æ‚ä¸€äº›ã€‚æˆ‘ä»¬ç»™æ¯ä¸€ä¸ªTaskæ ‡è®°ä¸€ä¸ªç‹¬ç«‹çš„keyï¼Œå¹¶ä¿®æ”¹Taskçš„callbackéƒ¨åˆ†ï¼Œè®©å›è°ƒçš„æ—¶å€™çŸ¥é“å±äºå“ªä¸€ä¸ªTaskå¯¹è±¡ã€‚äºæ­¤åŒæ—¶Taskå¤šäº†ä¸¤ä¸ªæ–¹æ³•<code>get_result</code>å’Œ<code>is_ready</code>æ–¹æ³•ã€‚åœ¨é¦–æ¬¡å¾—åˆ°yieldedå¯¹è±¡åã€‚å¦‚æœåˆ¤æ–­æ˜¯listå¯¹è±¡ï¼Œé‚£ä¹ˆå¯¹è¯¥listå†æ¬¡è¿›è¡Œå°è£…å¾—åˆ°Multiå¯¹è±¡,å®ƒçš„is_readyä¼šæ£€æŸ¥å¤šä¸ªTaskæ˜¯ä¸æ˜¯éƒ½å¾—åˆ°ç»“æœã€‚åœ¨è¢«æ‰§è¡Œå›è°ƒåæ‰§è¡Œåˆ°Runner.run(),ä¼šå…ˆæ£€æŸ¥æ˜¯å¦æ»¡è¶³is_readyã€‚å¦‚æœä¸æ»¡è¶³è¯´æ˜è¿˜æœ‰çš„Taskå¹¶æ²¡æœ‰è¿”å›ç»“æœï¼Œç›´æ¥è¿”å›ã€‚ç­‰å¾…ä¸‹ä¸€æ¬¡è¢«å›è°ƒã€‚å‡æ»¡è¶³æ‰å¾—åˆ°å…¨éƒ¨ç»“æœæ‰§è¡Œsendæ“ä½œ</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>è¿™æ®µä»£ç éå¸¸ç‹¬ç«‹ï¼Œè¿˜æ˜¯å¾ˆæœ‰çœ‹å¤´å¾ˆç²¾å½©çš„ã€‚è¢«gen.engineä¿®é¥°ä¸€æ¬¡æ„å‘³ç€å­˜åœ¨ä¸€ä¸ªRunnerï¼Œè¿™ä¸ªRunneré…åˆç€å¤šä¸ªTaskï¼Œä¸»è¦å¯ä»¥çœ‹åšTaskå’ŒRunneräº’ç›¸è°ƒç”¨çš„è¿‡ç¨‹ã€‚Taskæ¯è¢«å›è°ƒä¸€æ¬¡åˆ™Runner.run()è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œæ‰§è¡Œä¸€æ¬¡sendæ“ä½œï¼Œyieldå¾€ä¸‹èµ°ä¸€æ¬¡è¿”å›ä¸‹ä¸€ä¸ªTaskå¯¹è±¡ã€‚å¦å¤–è¿™æ®µä»£ç é‡Œé¢è¿˜æä¾›äº†å¾ˆå‘çˆ¹çš„Callbackã€Waitæ§åˆ¶æ–¹å¼ã€‚æ€ç»´æœ‰ç‚¹å¥‡è‘©ï¼Œä¸€èˆ¬äººä¸å¤ªä¼šå»ç”¨ï¼Œå®ç°å€’æ˜¯å¹¶ä¸å¤æ‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Tornadoåœ¨2011å¹´çš„2.1ç‰ˆæœ¬åŠ å…¥äº†gen.engineæ¨¡å—ï¼Œè¯¥æ¨¡å—ä¸»è¦ä¸ºäº†è§£å†³å¼‚æ­¥ç¨‹åºç¼–å†™ä¸å¤Ÿä¼˜é›…çš„é—®é¢˜ã€‚åŠ›å›¾è®©ä½¿ç”¨è€…ç¦»callbackæ›´è¿œï¼Œè¿™ä¹Ÿæ˜¯Tornadoå‰å®³çš„åœ°æ–¹ã€‚æœ¬æ¥å†…éƒ¨å„ç§äº‹ä»¶å¤„ç†ï¼Œcallbackæ»¡å¤©é£ï¼Œå¯æ˜¯åœ¨ç”¨æˆ·çœ¼é‡Œï¼Œå®ƒé‚£ä¸ªclass Handler(web.RequestHandler)ä¸‹é¢getçš„å†™æ³•å’ŒåŒæ­¥å†™æ³•å·®ä¸å¤šå˜›ã€‚å’ŒåŒæ­¥çš„å†™æ³•ä¸€æ ·ï¼Œè·å¾—äº†æ›´é«˜çš„æ€§èƒ½ï¼Œæˆ‘æƒ³è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆTornadoèƒ½å‡ºå½©çš„åœ°æ–¹å§(æœ¬æ–‡ä»£ç åŸºäºv2.3.0)&lt;/p&gt;
    
    </summary>
    
      <category term="Tornado" scheme="https://www.zoulei.net/categories/Tornado/"/>
    
    
  </entry>
  
  <entry>
    <title>Tornado ä¹‹StackContext</title>
    <link href="https://www.zoulei.net/2018/03/16/Tornado_StackContext/"/>
    <id>https://www.zoulei.net/2018/03/16/Tornado_StackContext/</id>
    <published>2018-03-16T08:14:25.000Z</published>
    <updated>2018-03-17T04:01:17.534Z</updated>
    
    <content type="html"><![CDATA[<p>yieldè¿™ä¸ªå…³é”®å­—åœ¨2001å¹´2.2ç‰ˆæœ¬çš„æ—¶å€™å°±å‡ºç°äº†ã€‚2006åŠ å…¥yield.sendåŠŸèƒ½ã€‚ç„¶è€Œç›´åˆ°2006å¹´2.5ç‰ˆæœ¬æ‰çœ‹åˆ°ä½¿ç”¨åœ¨contextmanagerä¸Šï¼Œtornado 2011å¹´æ‰ç”¨å®ƒå®ç°äº†ç¥å¥‡çš„gené€»è¾‘ã€‚ä»¤æˆ‘æ²¡æƒ³åˆ°çš„æ˜¯</p>
<ol>
<li>yieldå‡ºç°çš„è¿™ä¹ˆæ—©</li>
<li>yieldå‰å®³ä¸€ç‚¹çš„åº”ç”¨(contentmanager)å±…ç„¶è¿‡äº†äº”å¹´æ‰åŠ å…¥åˆ°æ ‡å‡†åº“ã€‚</li>
<li>tornadoçš„1.0.0ç‰ˆæ ¹æœ¬å’Œyieldæ²¡æœ‰ä¸€æ¯›é’±å…³ç³»</li>
<li>tornadoæœ€å…ˆå¼•å…¥yieldå±…ç„¶å¹¶ä¸æ˜¯å®ç°äº†gen</li>
</ol>
<p>yieldæœ€å…ˆåœ¨tornadoé‡Œé¢å±•éœ²å¤´è§’æ˜¯åœ¨<span style="color:red"><strong><a href="https://github.com/tornadoweb/tornado/commit/721e25d0acc68d751073261bec150ac12a9f88ab">è¿™ä¸ªcommit</a></strong></span>é‡Œé¢ã€‚å¤§ç¥å°±æ˜¯å¤§ç¥ï¼Œè™½ç„¶è¿™ä¸ªä»£ç ä»…ä»…åªæœ‰å‡ åè¡Œã€‚å¯æ˜¯æˆ‘è§‰å¾—æ€è·¯å¾ˆæ–°å¥‡ï¼Œè†œæ‹œğŸ˜€(ä»£ç åŸºäºv1.0.0å’Œv1.1.0)</p>
<a id="more"></a>
<p>å»ºè®®æ‰“å¼€è¯¥commitï¼Œå…ˆçœ‹ä¸€çœ‹å®ƒåšäº†ä»€ä¹ˆäº‹æƒ…ã€‚é™¤å»æµ‹è¯•ç”¨ä¾‹ï¼Œå®ƒæ”¹åŠ¨çš„åœ°æ–¹å¯è°“éå¸¸å°‘äº†</p>
<h3 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h3><p>è§‚å¯Ÿä¸‹é¢çš„ä»£ç (å¯ä»¥å°†tornadoçš„æºç åœ¨1.0.0ç‰ˆæœ¬å’Œ1.1.0ç‰ˆæœ¬åˆ‡æ¢å‘ç°ä¸åŒï¼Œåœ¨1.0.0ç‰ˆæœ¬å®¢æˆ·ç«¯æ— æ³•å¾—åˆ°å“åº”ï¼Œ1.1.0ç‰ˆæœ¬å®¢æˆ·ç«¯å¾—åˆ°500é”™è¯¯)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> tornado.ioloop</div><div class="line"><span class="keyword">import</span> tornado.web</div><div class="line"><span class="keyword">import</span> tornado.httpserver</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span><span class="params">(tornado.web.RequestHandler)</span>:</span></div><div class="line"><span class="meta">    @tornado.web.asynchronous</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></div><div class="line">        tornado.ioloop.IOLoop.instance().add_callback(self.callback)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">callback</span><span class="params">(self,*args)</span>:</span></div><div class="line">        <span class="keyword">raise</span> Exception(<span class="string">"Error"</span>)</div><div class="line"></div><div class="line">application = tornado.web.Application(handlers=[(<span class="string">'/'</span>, Index)])</div><div class="line">tornado.httpserver.HTTPServer(application).listen(<span class="number">8888</span>)</div><div class="line">tornado.ioloop.IOLoop.instance().start()</div></pre></td></tr></table></figure><br>è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„httpå“åº”ã€‚åœ¨æ¥å—åˆ°è¯·æ±‚ä¹‹åæ‰§è¡Œgetå‡½æ•°ä½“ï¼Œæœ€ç»ˆå®ƒå°†self.callbackåŠ å…¥åˆ°IOLoopå¾ªç¯åˆ—è¡¨ï¼Œgetå‡½æ•°ç»“æŸã€‚å› ä¸ºå­˜åœ¨asynchronousè£…é¥°å™¨ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰ä¸»åŠ¨è°ƒç”¨self.finish()ã€‚å¾…IOLoopæ‰§è¡Œself.callbackå›è°ƒæ—¶ã€‚æ­¤æ—¶å¹¶å‡½æ•°å†…éƒ¨è§¦å‘äº†å¼‚å¸¸ã€‚<span style="color:red"><strong>ä½†æ˜¯è¿™ä¸ªå¼‚å¸¸å·²ç»å’Œgetå‡½æ•°æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œå› æ­¤getå‡½æ•°æ— æ³•æ•è·åˆ°è¿™ä¸ªå¼‚å¸¸</strong></span><br>å¯¹æ¯”ä¸€ä¸‹getå‡½æ•°ä½“è‡ªèº«è§¦å‘å¼‚å¸¸ã€‚ç”±web.RequestHandler._executeè°ƒç”¨getå‡½æ•°ã€‚æ­¤æ—¶å®ƒå°†æ•è·å¼‚å¸¸å¹¶è°ƒç”¨self._handle_request_exception.æœ€ç®€æµç¨‹å¦‚ä¸‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_execute</span><span class="params">(self, transforms, *args, **kwargs)</span>:</span></div><div class="line">    self._transforms = transforms</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        getattr(self, self.request.method.lower())(*args, **kwargs)</div><div class="line">        <span class="keyword">if</span> self._auto_finish <span class="keyword">and</span> <span class="keyword">not</span> self._finished:</div><div class="line">            self.finish()</div><div class="line">    <span class="keyword">except</span> Exception, e:</div><div class="line">        self._handle_request_exception(e)</div></pre></td></tr></table></figure><br>self._handler_request_exceptionçš„æµç¨‹ä¹Ÿæ¯”è¾ƒç®€å•è¾“å‡ºå¼‚å¸¸è°ƒç”¨æ ˆã€‚è¿”å›å®¢æˆ·ç«¯500é”™è¯¯ï¼Œè¯¥httpæµç¨‹ç»“æŸ</p>
<p>å¯æ˜¯å¯¹äºä¸€ä¸ªå›è°ƒï¼Œå®ƒçš„å¼‚å¸¸ç”±IOLoopæ•è·ï¼Œç„¶è€Œå¯æ‚²çš„æ˜¯å®ƒæ•è·åˆ°å¼‚å¸¸å´å¹¶ä¸èƒ½ç¡®å®šæ˜¯è°æ·»åŠ åˆ°IOLoopé‡Œé¢çš„ï¼Œå¼‚å¸¸æ•è·ä¹‹åæ˜¯ä¸æ˜¯åªç”¨è¾“å‡ºè°ƒç”¨æ ˆå°±å¥½ã€‚æ‰€ä»¥éœ€æ±‚å‡ºæ¥äº†ï¼Œå¯¹äºå‡¡æ˜¯ç”±getæ“ä½œä¸‹é¢åŠ å…¥åˆ°IOLoopçš„å›è°ƒï¼Œæˆ‘ä»¬æœŸå¾…èƒ½å’Œgetçš„å¼‚å¸¸å¤„ç†é€»è¾‘ä¸€è‡´</p>
<h3 id="å†å²ä¸Šè¿™ä¸ªé—®é¢˜æ˜¯æ€ä¹ˆå¤„ç†çš„"><a href="#å†å²ä¸Šè¿™ä¸ªé—®é¢˜æ˜¯æ€ä¹ˆå¤„ç†çš„" class="headerlink" title="å†å²ä¸Šè¿™ä¸ªé—®é¢˜æ˜¯æ€ä¹ˆå¤„ç†çš„"></a>å†å²ä¸Šè¿™ä¸ªé—®é¢˜æ˜¯æ€ä¹ˆå¤„ç†çš„</h3><p>è¿™è‚¯å®šæ˜¯ä¸€ä¸ªéå¸¸å¸¸è§çš„é—®é¢˜ï¼Œå½“æ‰§è¡Œ<code>ioloop.IOLoop.instance().add_callback</code>ä¹‹åã€‚callbackå‡½æ•°è§¦å‘çš„å¼‚å¸¸æ·»åŠ å›è°ƒçš„å‡½æ•°æ— æ³•æ„ŸçŸ¥ã€‚æœ€å®¹æ˜“æƒ³åˆ°çš„æ–¹æ³•å°±æ˜¯æˆ‘ä»¬æŠŠcallbackæ•´ä½“åŠ ä¸Šå¼‚å¸¸æ•æ‰é€»è¾‘<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span><span class="params">(self,*args)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">                ...</div><div class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">                self._handle_request_exception(e)</div></pre></td></tr></table></figure><br>ä½†æ˜¯è¿™ä¹ˆæ¶å¿ƒçš„æ–¹æ³•æ˜æ˜¾æ˜¯ä¸å¯å–çš„ã€‚æ„å‘³ç€æˆ‘ä»¬æ¯å†™ä¸€ä¸ªå›è°ƒé€»è¾‘éƒ½éœ€è¦åœ¨å¤–éƒ¨åŠ ä¸Štry..exceptã€‚åœ¨1.0.0ç‰ˆæœ¬æä¾›äº†ä¸€ä¸ªè£…é¥°å™¨å‡½æ•°æä¾›ç±»ä¼¼çš„åŠŸèƒ½async_callback,æ‰€ä»¥ä¸Šé¢çš„å†™æ³•åªéœ€è¦å°†<code>tornado.ioloop.IOLoop.instance().add_callback(self.callback)</code>å˜æ›´æˆ<code>tornado.ioloop.IOLoop.instance().add_callback(self.async_callback(self.callback))</code>å°±å¯ä»¥äº†ã€‚è™½ç„¶æ–¹æ³•å¾ˆä¸å¥½ï¼Œå¯æ˜¯ä¸´æ—¶è§£å†³äº†é—®é¢˜ï¼Œåœ¨1.1.0ç‰ˆæœ¬å°±å¼•å…¥äº†StackContexté€»è¾‘ï¼Œè§£å†³äº†è¿™ä¸ªé—®é¢˜</p>
<h3 id="é¢„å¤‡çŸ¥è¯†Yield"><a href="#é¢„å¤‡çŸ¥è¯†Yield" class="headerlink" title="é¢„å¤‡çŸ¥è¯†Yield"></a>é¢„å¤‡çŸ¥è¯†Yield</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_fn</span><span class="params">()</span>:</span></div><div class="line">    result = <span class="keyword">yield</span> <span class="number">1</span></div><div class="line">    print(<span class="string">"result of yueld: "</span>+result)</div><div class="line">    result2 = <span class="keyword">yield</span>  <span class="number">2</span></div><div class="line">    print(<span class="string">"result of 2nd yield: "</span> + result2)</div><div class="line">    <span class="keyword">return</span> <span class="string">'we are done'</span></div><div class="line"></div><div class="line">caller = gen_fn()</div><div class="line">x = caller.send(<span class="keyword">None</span>)</div><div class="line">print(x)</div><div class="line">y = caller.send(<span class="string">'joe'</span>)</div><div class="line">print(y)</div><div class="line"><span class="keyword">try</span>:</div><div class="line">    caller.send(<span class="string">"bob"</span>)</div><div class="line"><span class="keyword">except</span> StopIteration:</div><div class="line">    print()</div></pre></td></tr></table></figure>
<ol>
<li>å¯¹äºä¸€ä¸ªç”Ÿæˆå™¨æ¥è¯´ï¼Œè°ƒç”¨å®ƒ(gen())å¹¶ä¸ä¼šç«‹å³è¢«æ‰§è¡Œã€‚åªæ˜¯ç”Ÿæˆäº†ä¸€ä¸ªç”Ÿæˆå™¨å¯¹è±¡</li>
<li>nex(g)ç­‰åŒäºg.send(None)ã€‚æ‰€ä»¥å¯¹äºç”Ÿæˆå™¨åªéœ€è¦æŒæ¡sendå‡½æ•°å°±å¯ä»¥äº†</li>
<li>send(value)è¿”å›çš„æ˜¯yieldå³è¾¹çš„å€¼ï¼ŒåŒæ—¶valueèµ‹å€¼ç»™yieldå·¦è¾¹çš„å¯¹è±¡ï¼Œ<span style="color:red"><strong>åƒä¸‡ä¸è¦è¢«ç¬¬ä¸€æ¬¡çš„send(None)è¯¯å¯¼ï¼Œè®¤ä¸ºç»è¿‡ç¬¬ä¸€æ¬¡send(None)åresultçš„å€¼ä¸ºNone</strong></span>,ä½ å¯ä»¥åœ¨å¿ƒç›®ä¸­å°†æ²¡ä¸€ä¸ªyieldåˆ’ä¸Šç«–çº¿ï¼Œè¿è¡Œåˆ°é‚£é‡Œå°±è¿”å›ï¼Œç„¶åä¸‹ä¸€æ¬¡sendçš„å€¼è¢«èµ‹å€¼ç»™yieldå·¦è¾¹</li>
<li>ä¸Šä¾‹ä¸­<code>we are done</code>æ²¡æœ‰è¢«æ‰“å°ï¼Œå› ä¸ºä¸æ–­çš„è¢«sendåç”Ÿæˆå™¨ä¼šè§¦å‘StopIterationå¼‚å¸¸ã€‚æœ€ç»ˆè¢«except StopIterationæ‰€æ•è·ã€‚å¯æ˜¯ä»–å¹¶æ²¡æœ‰å°†æ•è·çš„å€¼è¾“å‡ºï¼Œå› è€Œæ²¡æœ‰è¢«æ˜¾ç¤ºå¤„ç†ã€‚åŒæ—¶python2ä¸å…è®¸åœ¨ç”Ÿæˆå™¨æ‰§è¡Œreturnï¼Œæ‰€ä»¥åœ¨tornadoä¸­ç»å¸¸çœ‹åˆ°raise gen.Return(value)è¿™ç§å†™æ³•ï¼Œå®ƒå®è´¨å°±æ˜¯è§¦å‘StopIterationå¼‚å¸¸ï¼Œç„¶åè¢«exceptæ•è·åå¾—åˆ°å€¼ï¼Œå®Œæˆä¼ é€’è¿‡ç¨‹ï¼Œåˆ°äº†python3è¯­æ³•å°±ç›´æ¥å…è®¸æ‰§è¡Œreturnäº†</li>
</ol>
<h3 id="é¢„å¤‡çŸ¥è¯†-with"><a href="#é¢„å¤‡çŸ¥è¯†-with" class="headerlink" title="é¢„å¤‡çŸ¥è¯† with"></a>é¢„å¤‡çŸ¥è¯† with</h3><p>pythonæœ‰å¾ˆå¤šé­”æœ¯æ–¹æ³•(å¯ä»¥å‚è€ƒ<a href="https://pycoders-weekly-chinese.readthedocs.io/en/latest/issue6/a-guide-to-pythons-magic-methods.html">è¿™ç¯‡æ–‡ç« </a>)ã€‚å…¶ä¸­å¦‚æœä¸€ä¸ªç±»å­˜åœ¨<code>__enter__</code>å’Œ<code>__exit__</code>æ–¹æ³•ã€‚é‚£ä¹ˆå½“ä½¿ç”¨withè¯­å¥ä¹‹åã€‚ä¼šæ‰§è¡Œ<code>__enter__</code>åå¾—åˆ°å¯¹è±¡è¿”å›ç»™<code>with as</code>åé¢çš„å˜é‡ã€‚åœ¨é€€å‡ºçš„æ—¶å€™æ‰§è¡Œ<code>__exit__</code>æ–¹æ³•ï¼Œæœ€å¸¸è§çš„å°±æ˜¯æˆ‘ä»¬ä½¿ç”¨<code>with open() as f</code>å»æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶äº†ï¼Œå¤„ç†å®Œæˆåè‡ªåŠ¨å…³é—­æ–‡ä»¶ï¼Œé¿å…äº†å†…å­˜æ³„æ¼ã€‚ä»”ç»†æƒ³ä¸€ä¸‹ï¼Œå…¶å®ç”¨è£…é¥°å™¨æ˜¯å¾ˆå®¹æ˜“å®ç°çš„ã€‚å¯æ˜¯withè¯­å¥è¿˜æœ‰ä»¥ä¸€ä¸ªå¾ˆå¤§çš„ä¼˜ç‚¹ï¼ŒPythonçš„ç¼–ç æ˜¯åŸºäºç¼©è¿›æ¥å†³å®šä»£ç å—çš„ï¼Œè£…é¥°å™¨æ˜¯ä½œç”¨åœ¨å‡½æ•°ä¸Šï¼Œè€Œwithæ˜¯å½“è·³å‡ºå®ƒçš„ç¼©è¿›åˆ™æ‰§è¡Œ<code>__exit__</code>(å¯èƒ½æè¿°çš„ä¸å¤ªå¥½)ï¼Œå¾ˆå¤šæƒ…å†µä¸‹withè¦æ¯”è£…é¥°å™¨çš„å†™æ³•ä¼˜ç¾å¾ˆå¤šã€‚</p>
<p>å°†withå’Œyieldè”åˆèµ·æ¥ä½¿ç”¨è¿˜çœŸçš„æ˜¯æŒºç¥å¥‡çš„ã€‚from contextlib import contextmanagerï¼Œè¯¥æ¨¡å—å°†withè¯­å¥åšåˆ°äº†è£…é¥°å™¨çš„æ•ˆæœã€‚æ¯”å¦‚è®¡ç®—ä¸€ä¸ªwithè¯­å¥ä¸‹é¢çš„æ‰§è¡Œæ—¶é—´<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> contextmanager</div><div class="line"></div><div class="line"><span class="meta">@contextmanager</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">timeit</span><span class="params">()</span>:</span></div><div class="line">    start = time.time()</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="keyword">yield</span></div><div class="line">    <span class="keyword">finally</span>:</div><div class="line">        print(<span class="string">"elapsed time: &#123;&#125;"</span>.format(time.time() - start))</div><div class="line"></div><div class="line"><span class="keyword">with</span> timeit():</div><div class="line">    time.sleep(<span class="number">1</span>)</div></pre></td></tr></table></figure><br>ä½œä¸ºä¸æ˜ç™½å®ƒå®ç°çš„äººï¼Œä¹Ÿèƒ½å¤Ÿå¾ˆå®¹æ˜“çœ‹å‡ºæ¥ã€‚yieldå°†timeitåˆ’åˆ†ä¸ºäº†ä¸¤éƒ¨åˆ†ã€‚å‰é¢çš„ç›¸å½“äºæ‰§è¡Œ<code>__enter__</code>åŠ¨ä½œï¼Œåé¢çš„ç›¸å½“äºæ‰§è¡Œ<code>__exit__</code>åŠ¨ä½œã€‚</p>
<p>æƒ³è±¡ä¸€ä¸‹å®ƒçš„å†…éƒ¨contextmanagerè£…é¥°å™¨æ˜¯å¦‚ä½•å®ç°çš„ã€‚é¦–å…ˆè¢«è£…é¥°çš„å‡½æ•°timeitæ˜¯ä¸€ä¸ªç”Ÿæˆå™¨ã€‚å› æ­¤ï¼Œåœ¨æ‰§è¡Œ<code>__enter__</code>çš„æ—¶å€™åªéœ€è¦æ‰§è¡Œsend(None)æ“ä½œå°±èƒ½åˆ°è¾¾yieldçš„å³è¾¹å¹¶æš‚åœï¼Œå†<code>__exit__</code>çš„æ—¶å€™å†æ¬¡æ‰§è¡Œsend(None)ï¼Œæ­¤æ—¶æ‰§è¡Œåˆ°äº†finallyè¯­å¥å¹¶è§¦å‘StopIterationå¼‚å¸¸ï¼Œæµç¨‹ç»“æŸã€‚æ•´ä¸ªè¿‡ç¨‹å¯ä»¥è¿™æ ·è®¤ä¸º<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">contextmanager</span><span class="params">(func)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">        g = func(*args,**kwargs)</div><div class="line">        <span class="class"><span class="keyword">class</span> <span class="title">w</span><span class="params">()</span>:</span></div><div class="line">            <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></div><div class="line">                g.send(<span class="keyword">None</span>)</div><div class="line"></div><div class="line">            <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></div><div class="line">                <span class="keyword">try</span>:</div><div class="line">                    g.send(<span class="keyword">None</span>)</div><div class="line">                <span class="keyword">except</span> Exception:</div><div class="line">                    print(<span class="string">"4"</span>)</div><div class="line">        <span class="keyword">return</span> w()</div><div class="line">    <span class="keyword">return</span> inner</div><div class="line"></div><div class="line"><span class="meta">@contextmanager</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        print(<span class="string">"1"</span>)</div><div class="line">        <span class="keyword">yield</span></div><div class="line">        <span class="keyword">raise</span> Exception(<span class="string">"E"</span>)</div><div class="line">    <span class="keyword">finally</span>:</div><div class="line">        print(<span class="string">"3"</span>)</div><div class="line"></div><div class="line"><span class="keyword">with</span> log():</div><div class="line">    print(<span class="string">"2"</span>)</div></pre></td></tr></table></figure><br>æ˜¯å¦è¿˜æ˜¯æ„Ÿè§‰ç›¸å¯¹æ¯”è¾ƒç®€å•å‘¢</p>
<h3 id="StackContextçš„å®ç°"><a href="#StackContextçš„å®ç°" class="headerlink" title="StackContextçš„å®ç°"></a>StackContextçš„å®ç°</h3><p>åœ¨èµ·å› éƒ¨åˆ†ï¼Œè§£é‡Šäº†callbackä¸­ä¼šå­˜åœ¨çš„é—®é¢˜(æœŸå¾…RequestHandler.geté‡Œé¢æ‰€æœ‰ç›¸å…³å†…å®¹å‘ç”Ÿé”™è¯¯éƒ½ä¼šå¯¼è‡´è¿”å›500é”™è¯¯ç»™å®¢æˆ·ç«¯)ã€‚1.0ç‰ˆæœ¬çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯ç»™æ¯ä¸ªå›è°ƒå‡½æ•°å¥—ä¸Šä¸€ä¸ªè£…é¥°å™¨ã€‚è§¦å‘é”™è¯¯çš„æ—¶å€™å°±å¯ä»¥è¿”å›500äº†ï¼Œæ„Ÿè§‰ä¸å¤ªå¥½è®²è¿°è¿™æ®µå¤©æ‰èˆ¬çš„ä»£ç äº†ğŸ˜•<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> contextlib</div><div class="line"></div><div class="line">_state = ()</div><div class="line"></div><div class="line"><span class="meta">@contextlib.contextmanager</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">StackContext</span><span class="params">(context_factory)</span>:</span></div><div class="line">    <span class="keyword">global</span> _state</div><div class="line">    old_contexts = _state</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        _state = old_contexts + (context_factory,)</div><div class="line">        <span class="keyword">with</span> context_factory():</div><div class="line">            <span class="keyword">yield</span></div><div class="line">    <span class="keyword">finally</span>:</div><div class="line">        _state = old_contexts</div><div class="line"></div><div class="line"><span class="meta">@contextlib.contextmanager</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">ErrorCapture</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="keyword">yield</span></div><div class="line">    <span class="keyword">except</span> Exception:</div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="keyword">with</span> StackContext(ErrorCapture):</div><div class="line">    print(_state)</div><div class="line">    <span class="keyword">raise</span> Exception(<span class="string">"Error"</span>)</div><div class="line">print(_state)</div></pre></td></tr></table></figure><br>è¿™ä¸ªåœ°æ–¹StackContextæ˜¯ä¸€ä¸ªå·¥å‚æ¨¡å¼ï¼Œå®ƒä¼ å…¥çš„å‚æ•°context_factoryä¹Ÿæ˜¯ä¸€ä¸ªè¢«contextlib.contextmanagerè£…é¥°çš„å¯¹è±¡ã€‚åœ¨StackContextçš„å†…éƒ¨å®ƒåˆæ‰§è¡Œäº†withè¯­å¥æ¥åˆå§‹åŒ–æˆ‘ä»¬çš„context_factoryï¼Œemmm.è¿™ä¸ªå…¶å®å’Œå¤šå±‚åµŒå¥—è£…é¥°å™¨å¹¶æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ï¼Œå®ƒå®ç°äº†ä»€ä¹ˆæ•ˆæœå‘¢ï¼Œåœ¨è°ƒç”¨with StackContext(context_factory)çš„æ—¶å€™å°†context_factoryåŠ å…¥åˆ°è€çš„é‡Œé¢ã€‚<span style="color:red"><strong>æ³¨æ„ï¼Œå½“å‰çš„context_factoryå’Œ1.0.0ç‰ˆæœ¬é‡Œé¢çš„async_callbackæ•ˆæœæ˜¯ä¸€æ ·æ ·çš„ï¼Œåœ¨withçš„è¯­å¥å—ä¸‹é¢ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨_stateå˜é‡ã€‚å½“è·³å‡ºwithä¹‹å_stateå°±è¢«æ¢å¤åˆ°åŸæ¥çš„æ ·å­</strong></span>ã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•ä½¿ç”¨è¿™ä¸ª_stateå˜é‡å‘¢ï¼Œæ³¨æ„åˆ°withè¯­å¥è¿›å…¥çš„æ—¶å€™ä¼šåŠ å…¥context_factoryï¼Œé€€å‡ºçš„æ—¶å€™ä¼šæ¸…é™¤ã€‚è¿™æ„å‘³ç€åœ¨withä¸‹é¢çš„ä»£ç å—é‡Œé¢æˆ‘ä»¬å¯ä»¥å®‰å…¨çš„ä½¿ç”¨å®ƒ<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrap</span><span class="params">(fn)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapped</span><span class="params">(callback, contexts)</span>:</span></div><div class="line">        <span class="keyword">with</span> contextlib.nested(*[i() <span class="keyword">for</span> i <span class="keyword">in</span> contexts]):</div><div class="line">            callback()</div><div class="line">    contexts = _state</div><div class="line">    result = functools.partial(wrapped, fn, contexts)</div><div class="line">    <span class="keyword">return</span> result</div></pre></td></tr></table></figure><br>è¿™é‡Œï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªè£…é¥°å™¨ã€‚åœ¨IOLoopä¸­æ‰€æœ‰éœ€è¦æ·»åŠ å›è°ƒçš„åœ°æ–¹å‡ç”±wrapåŒ…è£…èµ·æ¥<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">     def add_callback(self, callback):</div><div class="line">         &quot;&quot;&quot;Calls the given callback on the next I/O loop iteration.&quot;&quot;&quot;</div><div class="line">-        self._callbacks.add(callback)</div><div class="line">+        self._callbacks.add(stack_context.wrap(callback))</div><div class="line">         self._wake()</div><div class="line">`</div></pre></td></tr></table></figure></p>
<p>é‚£ä¹ˆï¼Œåœ¨å®ƒè¢«è°ƒç”¨çš„æ—¶å€™å®é™…æ‰§è¡Œçš„æ˜¯wrappedå‡½æ•°ï¼Œå®ƒä¼šå…ˆè°ƒç”¨with contextlib.nested(*[i() for i in contexts]).æ­¤æ­¥éª¤æ¢å¤äº†with StackContextæ—¶æœŸåŠ å…¥çš„å¯¹è±¡(å³äººä»¬å¸¸è¯´çš„ä¸Šä¸‹æ–‡)ã€‚å¯¹äºå¼‚å¸¸æ•è·æ¥è¯´ï¼Œå°±æ˜¯èƒ½å¤Ÿæ­£ç¡®çš„æ•è·callbackçš„å¼‚å¸¸å¹¶ä¸”è¿”å›500ç»™å®¢æˆ·ç«¯ã€‚å¦å¤–ï¼Œæœ€å¼€å§‹çš„æ—¶å€™æ•è·RequestHandle.getçš„å¼‚å¸¸æ˜¯åœ¨_executeå¥—ä¸Štryâ€¦except,å°†ä»–å˜åŠ¨ä¸ºwith StackContextå°±å¥½äº†ã€‚è¿™é‡Œåº”è¯¥è°¨è®°ä¸‹é¢ä¸¤ç‚¹</p>
<ul>
<li>Tornadoçš„è¿è¡Œæ˜¯å•çº¿ç¨‹çš„,with StackContextè¿è¡Œçš„è¿‡ç¨‹ä¸­ä¸å¯èƒ½å­˜åœ¨åˆ«çš„æ­¥éª¤å¦å¤–å»æ”¹å˜äº†_stateçš„å€¼(è¿™ä¸ªå€¼å¾ˆé‡è¦)</li>
<li>StackContextæ˜¯å¯ä»¥è¿›è¡ŒåµŒå¥—çš„</li>
</ul>
<h3 id="æ”¹è¿›"><a href="#æ”¹è¿›" class="headerlink" title="æ”¹è¿›"></a>æ”¹è¿›</h3><p>å½“ç„¶ä»¥ä¸Šåªæ˜¯ä¸ºäº†è¡¨è¿°åŸç†è®²è§£çš„æœ€ç®€ä»£ç ï¼Œå®é™…ä¸Šæºç ä¸­ç•¥æœ‰ä¸åŒã€‚é¦–å…ˆè€ƒè™‘å¤šçº¿ç¨‹çš„æƒ…å†µï¼Œåœ¨å•çº¿ç¨‹ä¸­_stateçš„æ”¹åŠ¨æ˜¯å¾ˆæ˜¾ç„¶çš„ï¼Œæ‰§è¡Œ<code>with StackContext</code>å³å…è®¸æ”¹åŠ¨ã€‚åœ¨å¤šçº¿ç¨‹ä¸­å°±ä¸å¤ªä¸€æ ·äº†ã€‚å¤šçº¿ç¨‹ä¸­å¦‚æœä¹Ÿæ‰§è¡Œäº†<code>with StackContext</code>æ“ä½œï¼Œé‚£ä¹ˆæœ‰å¯èƒ½é€ æˆ_stateè¢«æ”¹åŠ¨ã€‚å› æ­¤ï¼Œ_stateè¢«ç»§æ‰¿è‡ªthread.localå¯¹è±¡ã€‚é‚£ä¹ˆä¸åŒçº¿ç¨‹å†…çš„ä¿®æ”¹æ˜¯äº’ç›¸ç‹¬ç«‹çš„<br>å…¶æ¬¡å¦‚æœä¸€ä¸ªå‡½æ•°å·²ç»è¢«wrappedåŒ…è£…ï¼Œé‚£ä¹ˆå°±ä¸å¿…è¦å†æ¬¡è¿›è¡ŒåŒ…è£…äº†(æƒ³è±¡ä¸€ä¸‹é€’å½’è°ƒç”¨add_callback)ã€‚å¯¹äºä¸å­˜åœ¨çš„<code>with StackContext</code>ä¹Ÿéœ€è¦è€ƒè™‘ï¼Œå¦‚æœæ‰§è¡Œcontextlib.nestedçš„å‚æ•°ä¸ºç©ºï¼Œæ— ç–‘æ˜¯ä¼šæŠ¥é”™çš„ã€‚<br>å…¶ä»–æœ‰çš„ç‹¬ç«‹çš„è¿è¡Œçš„æ¨¡å—ä¸å¸Œæœ›è¢«å·²å­˜åœ¨çš„_stateå½±å“ï¼Œå› æ­¤ç‹¬ç«‹è®¾ç½®äº†NullContext<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@contextlib.contextmanager</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">NullContext</span><span class="params">()</span>:</span></div><div class="line">    old_contexts = _state.contexts</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        _state.contexts = ()</div><div class="line">        <span class="keyword">yield</span></div><div class="line">    <span class="keyword">finally</span>:</div><div class="line">        _state.contexts = old_contexts</div></pre></td></tr></table></figure><br>å¦‚æœä¸å¸Œæœ›è¢«_stateå¹²æ‰°ï¼Œé‚£ä¹ˆåœ¨å‰é¢åŠ ä¸Š<code>with StackContext(NullContext)</code>ã€‚_stateå³è¢«ç½®ä¸ºç©ºã€‚æ˜¾ç„¶add_callbackä¼ å…¥çš„contextsä¸ºç©ºã€‚åœ¨å®ƒè¢«æ‰§è¡Œçš„æ—¶å€™ï¼Œä¹Ÿå’Œwithè¯­å¥æ²¡ä»€ä¹ˆäº‹æƒ…äº†</p>
<h3 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h3><p>æˆ‘æœ€å¼€å§‹çœ‹åˆ°çš„åº”ç”¨æ˜¯è¿™ä¸ª,<a href="https://gist.github.com/Hackforid/7130a5d59463186e217e">åœ¨Tornadoé‡Œé¢ä½¿ç”¨Sqlalchemy</a>ã€‚é»˜è®¤Sqlalchemyå­˜åœ¨sessionmakerä¸€ä¸ªå·¥å‚å‡½æ•°ï¼Œå®ƒä¼šç¡®å®šå¦‚ä½•ç”Ÿæˆä¸€ä¸ªsessionä¼šè¯å¯¹è±¡ä»¥ä¾›ä½¿ç”¨ã€‚é»˜è®¤çš„æƒ…å†µæ˜¯ä½¿ç”¨çº¿ç¨‹idï¼Œè¿™å¯¹äºå¤šçº¿ç¨‹ç¯å¢ƒéå¸¸éå¸¸æ–¹ä¾¿ã€‚å› ä¸ºå¤šçº¿ç¨‹webæ¡†æ¶ä¸­æ¯ä¸€ä¸ªHTTPè¯·æ±‚çš„å¤„ç†éƒ½æ˜¯åœ¨ç‹¬ç«‹çš„çº¿ç¨‹å†…è¿›è¡Œçš„ï¼Œé‚£ä¹ˆä¸€ä¸ªhttpå¤„ç†ç”Ÿå‘½å‘¨æœŸå¯¹åº”ä¸€ä¸ªsqlalchemyçš„sessionç”Ÿå‘½å‘¨æœŸéå¸¸å®Œç¾ã€‚<br>å¯æ˜¯åœ¨Tornadoè¿™ç§å•çº¿ç¨‹çš„æ¡†æ¶ä¸­å‘ç”Ÿäº†å˜åŒ–ï¼Œå› ä¸ºå®ƒä¸å¥½ç¡®å®šæ¯ä¸€ä¸ªhttpçš„ç”Ÿå‘½å‘¨æœŸæ ‡è¯†ã€‚StackContextç»™äº†æˆ‘ä»¬æ–¹æ³•ï¼Œè™½ç„¶èµ·å› æ˜¯callbackçš„å¼‚å¸¸å¤„ç†ï¼Œå¯æ˜¯æˆ‘ä»¬ä¸€æ ·å¯ä»¥å‚ç…§å®ƒçš„å¥—è·¯ï¼Œåœ¨_executeæ‰§è¡ŒæœŸé—´å†™å…¥å˜é‡ï¼Œåœ¨å•ä¸ªhttpç”Ÿå‘½å‘¨æœŸå‡å¯ä»¥è®¿é—®å˜é‡ï¼Œhttpå®Œç»“åæ¸…é™¤å®ƒã€‚ä»£ç å¯ä»¥å‚è€ƒç»™å‡ºçš„gisté“¾æ¥</p>
<h3 id="ç”¨ä¾‹"><a href="#ç”¨ä¾‹" class="headerlink" title="ç”¨ä¾‹"></a>ç”¨ä¾‹</h3><p>ä¸‹é¢ç»™ä¸€ä¸ªæ•´ç¯‡æ–‡ç« çš„ä»£ç æ€»ç»“<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>:</div><div class="line">    <span class="keyword">from</span> contextlib <span class="keyword">import</span> nested</div><div class="line"><span class="keyword">except</span> ImportError:</div><div class="line">    <span class="keyword">from</span> contextlib <span class="keyword">import</span> ExitStack, contextmanager</div><div class="line"></div><div class="line"><span class="meta">    @contextmanager</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">nested</span><span class="params">(*contexts)</span>:</span></div><div class="line">        <span class="keyword">with</span> ExitStack() <span class="keyword">as</span> stack:</div><div class="line">            <span class="keyword">for</span> ctx <span class="keyword">in</span> contexts:</div><div class="line">                stack.enter_context(ctx)</div><div class="line">            <span class="keyword">yield</span> contexts</div><div class="line"><span class="keyword">import</span> functools</div><div class="line"></div><div class="line"><span class="meta">@contextmanager</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">StackContext</span><span class="params">(context_factory)</span>:</span></div><div class="line">    <span class="keyword">global</span> _state</div><div class="line">    old_contexts = _state</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        _state = old_contexts + (context_factory,)</div><div class="line">        <span class="keyword">with</span> context_factory():</div><div class="line">            <span class="keyword">yield</span></div><div class="line">    <span class="keyword">finally</span>:</div><div class="line">        _state = old_contexts</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@contextmanager</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">ErrorCapture</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="keyword">yield</span></div><div class="line">    <span class="keyword">except</span> Exception:</div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line">_state = ()</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrap</span><span class="params">(fn)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapped</span><span class="params">(callback, contexts)</span>:</span></div><div class="line">        <span class="keyword">with</span> nested(*[i() <span class="keyword">for</span> i <span class="keyword">in</span> contexts]):</div><div class="line">            callback()</div><div class="line"></div><div class="line">    contexts = _state</div><div class="line">    result = functools.partial(wrapped, fn, contexts)</div><div class="line">    <span class="keyword">return</span> result</div><div class="line"></div><div class="line"></div><div class="line">loop_list = []</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">call_back</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">"WTF"</span>)</div><div class="line">    print(get_current_request_id())</div><div class="line"></div><div class="line"></div><div class="line">g = &#123;&#125;</div><div class="line"></div><div class="line"><span class="meta">@contextmanager</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">ThreadRequestContext</span><span class="params">(**data)</span>:</span></div><div class="line">    <span class="keyword">global</span> g</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        g = data</div><div class="line">        <span class="keyword">yield</span></div><div class="line">    <span class="keyword">finally</span>:</div><div class="line">        g.clear()</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_current_request_id</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> g[<span class="string">'request_id'</span>]</div><div class="line"></div><div class="line"></div><div class="line">global_data = &#123;<span class="string">"request_id"</span>: <span class="number">12</span>&#125;</div><div class="line"><span class="keyword">with</span> StackContext(functools.partial(ThreadRequestContext, **global_data)):</div><div class="line">    <span class="keyword">with</span> StackContext(ErrorCapture):</div><div class="line">        loop_list.append(wrap(call_back))</div><div class="line">        print(get_current_request_id())</div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> loop_list:</div><div class="line">    i()</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;yieldè¿™ä¸ªå…³é”®å­—åœ¨2001å¹´2.2ç‰ˆæœ¬çš„æ—¶å€™å°±å‡ºç°äº†ã€‚2006åŠ å…¥yield.sendåŠŸèƒ½ã€‚ç„¶è€Œç›´åˆ°2006å¹´2.5ç‰ˆæœ¬æ‰çœ‹åˆ°ä½¿ç”¨åœ¨contextmanagerä¸Šï¼Œtornado 2011å¹´æ‰ç”¨å®ƒå®ç°äº†ç¥å¥‡çš„gené€»è¾‘ã€‚ä»¤æˆ‘æ²¡æƒ³åˆ°çš„æ˜¯&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;yieldå‡ºç°çš„è¿™ä¹ˆæ—©&lt;/li&gt;
&lt;li&gt;yieldå‰å®³ä¸€ç‚¹çš„åº”ç”¨(contentmanager)å±…ç„¶è¿‡äº†äº”å¹´æ‰åŠ å…¥åˆ°æ ‡å‡†åº“ã€‚&lt;/li&gt;
&lt;li&gt;tornadoçš„1.0.0ç‰ˆæ ¹æœ¬å’Œyieldæ²¡æœ‰ä¸€æ¯›é’±å…³ç³»&lt;/li&gt;
&lt;li&gt;tornadoæœ€å…ˆå¼•å…¥yieldå±…ç„¶å¹¶ä¸æ˜¯å®ç°äº†gen&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;yieldæœ€å…ˆåœ¨tornadoé‡Œé¢å±•éœ²å¤´è§’æ˜¯åœ¨&lt;span style=&quot;color:red&quot;&gt;&lt;strong&gt;&lt;a href=&quot;https://github.com/tornadoweb/tornado/commit/721e25d0acc68d751073261bec150ac12a9f88ab&quot;&gt;è¿™ä¸ªcommit&lt;/a&gt;&lt;/strong&gt;&lt;/span&gt;é‡Œé¢ã€‚å¤§ç¥å°±æ˜¯å¤§ç¥ï¼Œè™½ç„¶è¿™ä¸ªä»£ç ä»…ä»…åªæœ‰å‡ åè¡Œã€‚å¯æ˜¯æˆ‘è§‰å¾—æ€è·¯å¾ˆæ–°å¥‡ï¼Œè†œæ‹œğŸ˜€(ä»£ç åŸºäºv1.0.0å’Œv1.1.0)&lt;/p&gt;
    
    </summary>
    
      <category term="Tornado" scheme="https://www.zoulei.net/categories/Tornado/"/>
    
    
  </entry>
  
  <entry>
    <title>Tornado ä¹‹WSGI</title>
    <link href="https://www.zoulei.net/2018/03/16/tornado_wsgi/"/>
    <id>https://www.zoulei.net/2018/03/16/tornado_wsgi/</id>
    <published>2018-03-16T03:28:02.000Z</published>
    <updated>2018-03-16T07:39:45.556Z</updated>
    
    <content type="html"><![CDATA[<p>WSGIæ¯•ç«Ÿæ˜¯Pythonç¤¾åŒºå®˜æ–¹è®¤å¯çš„è§„èŒƒï¼Œå¯æ˜¯è¿™ç§è§„èŒƒåœ¨å¤šçº¿ç¨‹å¤šè¿›ç¨‹æ¨¡å¼ä¸‹å®ç°å¾ˆç®€å•ï¼Œä¸å¤ªé€‚åˆå•çº¿ç¨‹å¼‚æ­¥è¿™ç§æƒ…å†µã€‚é‰´äºæ­¤Tornadoå¹¶æ²¡æœ‰æŒ‰ç…§è¿™ä¸ªæ¡†æ¶å»å®ç°ä¸€ä¸ªWSGIçš„webæ¡†æ¶ï¼Œå¯æ˜¯å®ƒå´æä¾›äº†åŸºæœ¬çš„å…¼å®¹ï¼Œ1.å…è®¸Tornadoçš„applicationå¯¹è±¡è½¬å˜æˆWSGI applicationã€‚2. å…è®¸WSGI applicationåœ¨tornado ioloopä¸­æ‰§è¡Œï¼Œåªæ˜¯è¿™ä¸€åˆ‡éƒ½ä¸æ˜¯å®Œç¾çš„ï¼Œå®ƒä»…ä»…æä¾›äº†åŸºæœ¬çš„å…¼å®¹ï¼Œæ•ˆç‡å’Œå¯ç”¨æ€§å¾—ä¸åˆ°ä¿è¯ã€‚å› æ­¤ä¸ªäººè¿˜æ˜¯æ„Ÿè§‰å¾ˆé¸¡è‚‹çš„</p>
<a id="more"></a>
<h3 id="å›é¡¾WSGI"><a href="#å›é¡¾WSGI" class="headerlink" title="å›é¡¾WSGI"></a>å›é¡¾WSGI</h3><p>wsgiç”±<a href="https://www.python.org/dev/peps/pep-0333/">PEP333</a>å¼€å§‹ï¼Œåœ¨<a href="https://www.python.org/dev/peps/pep-3333/">PEP3333</a>å¾—åˆ°å¢å¼ºã€‚åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†ä¸ºå®¹å™¨ï¼Œå¦ä¸€éƒ¨åˆ†ä¸ºåº”ç”¨ã€‚åº”ç”¨çš„æœ€ç®€å½¢å¼å¦‚ä¸‹<br>ä¼ å…¥environåŸºç¡€ç¯å¢ƒå­—å…¸(å¿…é¡»åŒ…å«ä¸€äº›å€¼)å’Œå›è°ƒå‡½æ•°ï¼Œæœ€ç»ˆè¿”å›ä¸€ä¸ªå¯è¿­ä»£å¯¹çº¿<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">simple_app</span><span class="params">(environ, start_response)</span>:</span></div><div class="line">    status = <span class="string">'200 OK'</span></div><div class="line">    response_headers = [(<span class="string">'Content-type'</span>, <span class="string">'text/plain'</span>)]</div><div class="line">    start_response(status, response_headers)</div><div class="line">    <span class="keyword">return</span> [<span class="string">'Hello world!\n'</span>]</div></pre></td></tr></table></figure><br>å¯¹äºå®¹å™¨ã€‚åˆ™æ˜¯æ¯æ¥æ”¶åˆ°ä¸€ä¸ªhttpè¯·æ±‚åˆ™è°ƒç”¨ä¸€æ¬¡åº”ç”¨ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯å®¹å™¨å’Œåº”ç”¨å¯ä»¥å®Œå…¨éš”ç¦»ï¼Œåº”ç”¨å¯ä»¥ä½¿ç”¨ä»»æ„å®¹å™¨æ¥æ‰§è¡Œ</p>
<h3 id="Tornado-applicationè½¬å˜æˆWSGI-application"><a href="#Tornado-applicationè½¬å˜æˆWSGI-application" class="headerlink" title="Tornado applicationè½¬å˜æˆWSGI application"></a>Tornado applicationè½¬å˜æˆWSGI application</h3><p>å®ç°æ•ˆæœå¦‚ä¸‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> tornado.web</div><div class="line"><span class="keyword">import</span> tornado.wsgi</div><div class="line"><span class="keyword">import</span> wsgiref.simple_server</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></div><div class="line">        self.write(<span class="string">"Hello, world"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    application = tornado.wsgi.WSGIApplication([</div><div class="line">        (<span class="string">r"/"</span>, MainHandler),</div><div class="line">    ])</div><div class="line">    server = wsgiref.simple_server.make_server(<span class="string">''</span>, <span class="number">8888</span>, application)</div><div class="line">    server.serve_forever()</div></pre></td></tr></table></figure></p>
<p>åœ¨Tornadoé‡Œé¢applicationæ¥å—ä¸€ä¸ªå‚æ•°è°ƒç”¨ï¼Œä¼ å…¥Requestså¯¹è±¡ã€‚è°ƒç”¨çš„ç»“æœæ˜¯æœ€ç»ˆç”Ÿæˆheaderä»¥åŠhandler._write_bufferå¯¹è±¡(ä¼šè§¦å‘iostreamçš„å†™äº‹ä»¶ï¼Œæœ€ç»ˆç”±IOLoopè§¦å‘socketå†™æ“ä½œ)ã€‚å› æ­¤è™½ç„¶å®ƒæ‰§è¡Œäº†RequestsHandler._executeæ“ä½œï¼Œå®é™…å¹¶æ²¡æœ‰å‘ç”Ÿsocketå‘é€æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥ä»handlerå¯¹è±¡å–å¾—å®Œæ•´çš„HTTPå›å¤æŠ¥æ–‡ã€‚ç„¶åè°ƒç”¨start_responseå’Œè¿”å›ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡<br>å¯ä»¥çœ‹åˆ°é‡ç‚¹å°±æ˜¯ä»WSGI serverä¼ é€’çš„environå­—å…¸é‡Œé¢é‡ç»„å‡ºä¸€ä¸ªRequestå¯¹è±¡(æ¨¡æ‹Ÿåˆ°å’Œhttpserveræ¨¡å—ä¸­çš„HTTPRequestå¯¹è±¡ä¸€æ ·)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WSGIApplication</span><span class="params">(web.Application)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, handlers=None, default_host=<span class="string">""</span>, **settings)</span>:</span></div><div class="line">        web.Application.__init__(self, handlers, default_host, transforms=[],</div><div class="line">                                 wsgi=<span class="keyword">True</span>, **settings)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, environ, start_response)</span>:</span></div><div class="line">        handler = web.Application.__call__(self, HTTPRequest(environ))</div><div class="line">        <span class="keyword">assert</span> handler._finished</div><div class="line">        status = str(handler._status_code) + <span class="string">" "</span> + \</div><div class="line">            httplib.responses[handler._status_code]</div><div class="line">        headers = handler._headers.items()</div><div class="line">        <span class="keyword">for</span> cookie_dict <span class="keyword">in</span> getattr(handler, <span class="string">"_new_cookies"</span>, []):</div><div class="line">            <span class="keyword">for</span> cookie <span class="keyword">in</span> cookie_dict.values():</div><div class="line">                headers.append((<span class="string">"Set-Cookie"</span>, cookie.OutputString(<span class="keyword">None</span>)))</div><div class="line">        start_response(status, headers)</div><div class="line">        <span class="keyword">return</span> handler._write_buffer</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">HTTPRequest</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div></pre></td></tr></table></figure><br>å¯ä»¥çœ‹åˆ°é‡ç‚¹å°±æ˜¯ä»environé‡Œé¢æ„å»ºå‡ºä¸€ä¸ªå…¼å®¹httpserverçš„HTTPRequestå¯¹è±¡ã€‚å¦å¤–ç”±äºIOLoopåœ¨è¿™ç§æƒ…å†µä¸‹ä¸å…è®¸ä½¿ç”¨ï¼Œæ‰€ä»¥ä¾èµ–IOLoopçš„å¼‚æ­¥ç‰¹æ€§ä¹Ÿå°±ä¸å­˜åœ¨äº†ã€‚è€Œä¸”è¿åŒå¤šçº¿ç¨‹çš„ç‰¹æ€§ä¹Ÿä¸åœ¨å­˜åœ¨ã€‚æ‰€ä»¥åªæ˜¯ä¸€ä¸ªç©å…·ç½¢äº†å§</p>
<h3 id="åœ¨Tornadoä¸­è¿è¡ŒWSGI-application"><a href="#åœ¨Tornadoä¸­è¿è¡ŒWSGI-application" class="headerlink" title="åœ¨Tornadoä¸­è¿è¡ŒWSGI application"></a>åœ¨Tornadoä¸­è¿è¡ŒWSGI application</h3><p>ä¸Šé¢çš„æ˜¯å°†tornadoçš„åº”ç”¨è½¬å˜æˆWSGIå…¼å®¹ï¼Œç„¶åè®©WSGIçš„å®¹å™¨å»è¿è¡Œã€‚è¿™ä¸€ä¸ªæ˜¯åè¿‡æ¥ï¼Œè®©tornadoä½œä¸ºå®¹å™¨å»è¿è¡ŒWSGIåº”ç”¨ã€‚å®ç°è¿™æ ·çš„æ•ˆæœ<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">simple_app</span><span class="params">(environ, start_response)</span>:</span></div><div class="line">    status = <span class="string">"200 OK"</span></div><div class="line">    response_headers = [(<span class="string">"Content-type"</span>, <span class="string">"text/plain"</span>)]</div><div class="line">    start_response(status, response_headers)</div><div class="line">    <span class="keyword">return</span> [<span class="string">"Hello world!\n"</span>]</div><div class="line"></div><div class="line">container = tornado.wsgi.WSGIContainer(simple_app)</div><div class="line">http_server = tornado.httpserver.HTTPServer(container)</div><div class="line">http_server.listen(<span class="number">8888</span>)</div><div class="line">tornado.ioloop.IOLoop.instance().start()</div></pre></td></tr></table></figure></p>
<p>tornado.httpserver.HTTPServerä¼šè°ƒç”¨å‡½æ•°å¹¶ä¼ å…¥ä¸€ä¸ªRequestå¯¹è±¡ã€‚<span style="color:red"><strong>åˆšå¥½å’Œä¸Šé¢çš„è¿‡ç¨‹ç›¸å</strong></span>ã€‚å°†Requestå¯¹è±¡åˆ†å‰²ä¸º<code>environ</code>å’Œ<code>start_response</code>ã€‚ç›´æ¥è´´1.0.0çš„åŸå§‹ä»£ç å§<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WSGIContainer</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, wsgi_application)</span>:</span></div><div class="line">        self.wsgi_application = wsgi_application</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, request)</span>:</span></div><div class="line">        data = &#123;&#125;</div><div class="line">        response = []</div><div class="line">        <span class="comment"># å°†statuså’Œheadersæ”¾å…¥å­—å…¸ä¸­,åç»­è°ƒç”¨åˆ™å†™å…¥body</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">start_response</span><span class="params">(status, response_headers, exc_info=None)</span>:</span></div><div class="line">            data[<span class="string">"status"</span>] = status</div><div class="line">            data[<span class="string">"headers"</span>] = response_headers</div><div class="line">            <span class="keyword">return</span> response.append</div><div class="line">        <span class="comment"># wsgi appæœ€ç»ˆè¿”å›å¯è¿­ä»£å¯¹è±¡ä½œä¸ºbody</span></div><div class="line">        app_response = self.wsgi_application(</div><div class="line">            WSGIContainer.environ(request), start_response)</div><div class="line">        response.extend(app_response)</div><div class="line">        body = <span class="string">""</span>.join(response)</div><div class="line">        <span class="keyword">if</span> hasattr(app_response, <span class="string">"close"</span>):</div><div class="line">            app_response.close()</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data: <span class="keyword">raise</span> Exception(<span class="string">"WSGI app did not call start_response"</span>)</div><div class="line">        <span class="comment"># ç»„åˆæˆæ•´ä¸ªhttpæŠ¥æ–‡</span></div><div class="line">        status_code = int(data[<span class="string">"status"</span>].split()[<span class="number">0</span>])</div><div class="line">        headers = data[<span class="string">"headers"</span>]</div><div class="line">        header_set = set(k.lower() <span class="keyword">for</span> (k,v) <span class="keyword">in</span> headers)</div><div class="line">        body = escape.utf8(body)</div><div class="line">        <span class="keyword">if</span> <span class="string">"content-length"</span> <span class="keyword">not</span> <span class="keyword">in</span> header_set:</div><div class="line">            headers.append((<span class="string">"Content-Length"</span>, str(len(body))))</div><div class="line">        <span class="keyword">if</span> <span class="string">"content-type"</span> <span class="keyword">not</span> <span class="keyword">in</span> header_set:</div><div class="line">            headers.append((<span class="string">"Content-Type"</span>, <span class="string">"text/html; charset=UTF-8"</span>))</div><div class="line">        <span class="keyword">if</span> <span class="string">"server"</span> <span class="keyword">not</span> <span class="keyword">in</span> header_set:</div><div class="line">            headers.append((<span class="string">"Server"</span>, <span class="string">"TornadoServer/0.1"</span>))</div><div class="line"></div><div class="line">        parts = [<span class="string">"HTTP/1.1 "</span> + data[<span class="string">"status"</span>] + <span class="string">"\r\n"</span>]</div><div class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> headers:</div><div class="line">            parts.append(escape.utf8(key) + <span class="string">": "</span> + escape.utf8(value) + <span class="string">"\r\n"</span>)</div><div class="line">        parts.append(<span class="string">"\r\n"</span>)</div><div class="line">        parts.append(body)</div><div class="line">        <span class="comment"># å‘é€å®Œæˆ</span></div><div class="line">        request.write(<span class="string">""</span>.join(parts))</div><div class="line">        request.finish()</div><div class="line">        self._log(status_code, request)</div><div class="line"></div><div class="line"><span class="meta">    @staticmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">environ</span><span class="params">(request)</span>:</span></div><div class="line">        hostport = request.host.split(<span class="string">":"</span>)</div><div class="line">        <span class="keyword">if</span> len(hostport) == <span class="number">2</span>:</div><div class="line">            host = hostport[<span class="number">0</span>]</div><div class="line">            port = int(hostport[<span class="number">1</span>])</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            host = request.host</div><div class="line">            port = <span class="number">443</span> <span class="keyword">if</span> request.protocol == <span class="string">"https"</span> <span class="keyword">else</span> <span class="number">80</span></div><div class="line">        environ = &#123;</div><div class="line">            <span class="string">"REQUEST_METHOD"</span>: request.method,</div><div class="line">            <span class="string">"SCRIPT_NAME"</span>: <span class="string">""</span>,</div><div class="line">            <span class="string">"PATH_INFO"</span>: request.path,</div><div class="line">            <span class="string">"QUERY_STRING"</span>: request.query,</div><div class="line">            <span class="string">"REMOTE_ADDR"</span>: request.remote_ip,</div><div class="line">            <span class="string">"SERVER_NAME"</span>: host,</div><div class="line">            <span class="string">"SERVER_PORT"</span>: port,</div><div class="line">            <span class="string">"SERVER_PROTOCOL"</span>: request.version,</div><div class="line">            <span class="string">"wsgi.version"</span>: (<span class="number">1</span>, <span class="number">0</span>),</div><div class="line">            <span class="string">"wsgi.url_scheme"</span>: request.protocol,</div><div class="line">            <span class="string">"wsgi.input"</span>: cStringIO.StringIO(escape.utf8(request.body)),</div><div class="line">            <span class="string">"wsgi.errors"</span>: sys.stderr,</div><div class="line">            <span class="string">"wsgi.multithread"</span>: <span class="keyword">False</span>,</div><div class="line">            <span class="string">"wsgi.multiprocess"</span>: <span class="keyword">True</span>,</div><div class="line">            <span class="string">"wsgi.run_once"</span>: <span class="keyword">False</span>,</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> <span class="string">"Content-Type"</span> <span class="keyword">in</span> request.headers:</div><div class="line">            environ[<span class="string">"CONTENT_TYPE"</span>] = request.headers[<span class="string">"Content-Type"</span>]</div><div class="line">        <span class="keyword">if</span> <span class="string">"Content-Length"</span> <span class="keyword">in</span> request.headers:</div><div class="line">            environ[<span class="string">"CONTENT_LENGTH"</span>] = request.headers[<span class="string">"Content-Length"</span>]</div><div class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> request.headers.iteritems():</div><div class="line">            environ[<span class="string">"HTTP_"</span> + key.replace(<span class="string">"-"</span>, <span class="string">"_"</span>).upper()] = value</div><div class="line">        <span class="keyword">return</span> environ</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_log</span><span class="params">(self, status_code, request)</span>:</span></div><div class="line">        <span class="keyword">if</span> status_code &lt; <span class="number">400</span>:</div><div class="line">            log_method = logging.info</div><div class="line">        <span class="keyword">elif</span> status_code &lt; <span class="number">500</span>:</div><div class="line">            log_method = logging.warning</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            log_method = logging.error</div><div class="line">        request_time = <span class="number">1000.0</span> * request.request_time()</div><div class="line">        summary = request.method + <span class="string">" "</span> + request.uri + <span class="string">" ("</span> + \</div><div class="line">            request.remote_ip + <span class="string">")"</span></div><div class="line">        log_method(<span class="string">"%d %s %.2fms"</span>, status_code, summary, request_time)</div></pre></td></tr></table></figure></p>
<p>ä¸»è¦æ˜¯å°†Requestsè½¬å˜æˆenvironï¼Œä¼ å…¥ç»™WSGIåº”ç”¨ã€‚æœ€ç»ˆæ ¹æ®åº”ç”¨çš„è¿”å›é‡ç»„æˆä¸€ä¸ªHTTPå›å¤æŠ¥æ–‡å­—ç¬¦ä¸²è°ƒç”¨å‘é€é€»è¾‘ï¼Œæµç¨‹å®Œæˆã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;WSGIæ¯•ç«Ÿæ˜¯Pythonç¤¾åŒºå®˜æ–¹è®¤å¯çš„è§„èŒƒï¼Œå¯æ˜¯è¿™ç§è§„èŒƒåœ¨å¤šçº¿ç¨‹å¤šè¿›ç¨‹æ¨¡å¼ä¸‹å®ç°å¾ˆç®€å•ï¼Œä¸å¤ªé€‚åˆå•çº¿ç¨‹å¼‚æ­¥è¿™ç§æƒ…å†µã€‚é‰´äºæ­¤Tornadoå¹¶æ²¡æœ‰æŒ‰ç…§è¿™ä¸ªæ¡†æ¶å»å®ç°ä¸€ä¸ªWSGIçš„webæ¡†æ¶ï¼Œå¯æ˜¯å®ƒå´æä¾›äº†åŸºæœ¬çš„å…¼å®¹ï¼Œ1.å…è®¸Tornadoçš„applicationå¯¹è±¡è½¬å˜æˆWSGI applicationã€‚2. å…è®¸WSGI applicationåœ¨tornado ioloopä¸­æ‰§è¡Œï¼Œåªæ˜¯è¿™ä¸€åˆ‡éƒ½ä¸æ˜¯å®Œç¾çš„ï¼Œå®ƒä»…ä»…æä¾›äº†åŸºæœ¬çš„å…¼å®¹ï¼Œæ•ˆç‡å’Œå¯ç”¨æ€§å¾—ä¸åˆ°ä¿è¯ã€‚å› æ­¤ä¸ªäººè¿˜æ˜¯æ„Ÿè§‰å¾ˆé¸¡è‚‹çš„&lt;/p&gt;
    
    </summary>
    
      <category term="Tornado" scheme="https://www.zoulei.net/categories/Tornado/"/>
    
    
  </entry>
  
  <entry>
    <title>Tornado ä¹‹web</title>
    <link href="https://www.zoulei.net/2018/03/15/tornado_web/"/>
    <id>https://www.zoulei.net/2018/03/15/tornado_web/</id>
    <published>2018-03-15T09:23:07.000Z</published>
    <updated>2018-03-16T03:25:03.691Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸Šä¸€ç¯‡æ–‡ç« è®²è§£äº†httpserverã€‚å®ƒæœ€ç»ˆä¼ å…¥çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ¥å—çš„æ˜¯Requestå¯¹è±¡ï¼Œè¿™å’ŒTornadoæ‰€å±•ç¤ºçš„Hello Worldæœ‰ä¸€äº›å·®è·ã€‚tornadoçš„webæ¨¡å—å°±æ˜¯å°†å®ƒä»ä¸€ä¸ªå‡½æ•°å˜åŒ–æˆä¸€ä¸ªç±»å¯¹è±¡ï¼Œå¹¶ä¸”åŒ…å«äº†åŸºç¡€çš„è·¯ç”±åŠŸèƒ½ï¼Œæœ€ç»ˆå®ç°ç±»ä¼¼ä¸è¿™æ ·çš„Hello World(ä»£ç åŸºäº1.0.0ç‰ˆæœ¬)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> tornado <span class="keyword">import</span> web</div><div class="line"><span class="keyword">from</span> tornado <span class="keyword">import</span> httpserver</div><div class="line"><span class="keyword">from</span> tornado <span class="keyword">import</span> ioloop</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span><span class="params">(web.RequestHandler)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></div><div class="line">        self.write(<span class="string">b"Hello World"</span>)</div><div class="line"></div><div class="line">application = web.Application([</div><div class="line">    (<span class="string">r"/"</span>, MainHandler)</div><div class="line">])</div><div class="line"></div><div class="line">http_server = httpserver.HTTPServer(application)</div><div class="line">http_server.listen(<span class="number">8888</span>)</div><div class="line">ioloop.IOLoop.instance().start()</div></pre></td></tr></table></figure></p>
<a id="more"></a>
<h3 id="å°†handler-requestå›è°ƒå°è£…ä¸ºRequestHandlerç±»å’ŒApplication"><a href="#å°†handler-requestå›è°ƒå°è£…ä¸ºRequestHandlerç±»å’ŒApplication" class="headerlink" title="å°†handler_requestå›è°ƒå°è£…ä¸ºRequestHandlerç±»å’ŒApplication"></a>å°†handler_requestå›è°ƒå°è£…ä¸ºRequestHandlerç±»å’ŒApplication</h3><p>å’Œä¸Šä¸€ç¯‡çš„httpserverå¹¶æ²¡æœ‰å¤ªå¤§çš„å˜åŠ¨ï¼Œä¼ å…¥çš„å¯¹è±¡ç”±å•ä¸ªå‡½æ•°å˜æˆäº†applicationå¯¹è±¡ï¼Œå¹¶ä¸”webæ¨¡å—æœ‰RequestHandlerå’ŒApplicationç±»ï¼Œèƒ½çŒœæƒ³åˆ°webæ¨¡å—æä¾›äº†è·¯ç”±åŠŸèƒ½ï¼Œå¯¹è¯·æ±‚çš„HTTPã€‚å®ƒå…ˆå¾—åˆ°è¯·æ±‚è·¯å¾„å’ŒHTTPæ–¹æ³•ã€‚æ‰¾åˆ°å¯¹åº”çš„ç±»ã€‚è°ƒç”¨å¯¹åº”çš„æ–¹æ³•ã€‚ç”±æ­¤å†™å‡ºä»¥ä¸‹æœ€ç®€ä»£ç <br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestHandler</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, request, application)</span>:</span></div><div class="line">        self.request = request</div><div class="line">        self.application = application</div><div class="line">        self._write_chunk = <span class="string">b""</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">raise</span> NotImplementedError()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(self, chunk)</span>:</span></div><div class="line">        self._write_chunk += chunk</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">finish</span><span class="params">(self)</span>:</span></div><div class="line">        self.request.write(<span class="string">b"HTTP/1.0 200 OK\r\nContent-Length: %d\r\n\r\n%s"</span> % (</div><div class="line">            len(self._write_chunk), self._write_chunk))</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_execute</span><span class="params">(self)</span>:</span></div><div class="line">        self.get()</div><div class="line">        self.finish()</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, handlers)</span>:</span></div><div class="line">        self.handlers = handlers</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, request)</span>:</span></div><div class="line">        <span class="comment"># å…ˆä»requestå¾—åˆ°è®¿é—®hostã€urlå’Œmethodå¯¹handlersè¿›è¡ŒåŒ¹é…</span></div><div class="line">        handler = self.handlers[<span class="number">0</span>][<span class="number">1</span>](request, self)</div><div class="line">        handler._execute()</div></pre></td></tr></table></figure></p>
<p>å°†æ‰€æœ‰çš„RequestHandlerç±»å‡æ”¾ç½®åˆ°Applicationä¸‹é¢ã€‚å½“å®ƒè¢«tornado.httpserverè°ƒç”¨ä¼ å…¥requestå¯¹è±¡çš„æ—¶å€™ä¼šè°ƒç”¨Applicationçš„<code>__call__</code>å‡½æ•°ã€‚å› ä¸ºself.handlersä¸­ï¼Œæ¯ä¸€ä¸ªhandlerå‡æœ‰å¯¹åº”çš„è·¯ç”±åœ°å€ï¼Œæ¯«æ— ç–‘é—®ï¼Œè¿™ä¸ªåœ°æ–¹ä¼šå­˜åœ¨ä¸€ä¸ªåŒ¹é…è¿‡ç¨‹ã€‚å› ä¸ºè°ƒç”¨<code>__call__</code>çš„æ—¶å€™requestå¯¹è±¡å·²ç»å¯ä»¥æå–åˆ°hostã€portã€urlã€headerã€bodyç­‰å„ç§ä¿¡æ¯ï¼Œæœ€å¸¸ç”¨çš„åªéœ€è¦ä½¿ç”¨hostå’Œurlå³å¯ç¡®å®šè°ƒç”¨å“ªä¸€ä¸ªRequestHandlerã€‚åŒ¹é…åå¯¹RestsHandlerè¿›è¡Œåˆå§‹åŒ–,æ­¤æ—¶ä¼ å…¥äº†requestå¯¹è±¡å’ŒApplicationå¯¹è±¡æœ¬èº«ï¼Œæœ€åè°ƒç”¨_executeå®Œæˆæ•´ä¸ªè¿‡ç¨‹çš„æ‰§è¡Œ</p>
<h3 id="è·¯ç”±åŠŸèƒ½"><a href="#è·¯ç”±åŠŸèƒ½" class="headerlink" title="è·¯ç”±åŠŸèƒ½"></a>è·¯ç”±åŠŸèƒ½</h3><p>è·¯ç”±åŠŸèƒ½çš„å®ç°ä¸»è¦ä¾é æ­£åˆ™åŒ¹é…ã€‚æ¯”å¦‚å®ç°å¯¹åšå®¢åœ°å€çš„åŒ¹é…<code>/(\d{4})/(\d{2})/(\d{2})/(.+?)</code>ã€‚åˆ†åˆ«è¡¨ç¤ºå¹´ã€æœˆã€æ—¥ã€ä¸»é¢˜ï¼Œæˆ–è€…ä½¿ç”¨æ­£åˆ™å‘½ååˆ†ç»„<code>/(?P&lt;year&gt;\d{4})/(?P&lt;month&gt;\d{2})/(?P&lt;day&gt;\d{2})/(?P&lt;theme&gt;.+?)</code>ã€‚é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦å†æ·»åŠ çš„æ—¶å€™æ‰§è¡Œre.compileã€‚åœ¨åŒ¹é…çš„æ—¶å€™æ‰§è¡Œre.matchå³å¯ã€‚å¯¹äºæ™®é€šçš„ä¸å­˜åœ¨æ­£åˆ™åˆ†ç»„çš„æƒ…å†µï¼Œå°±ä¸éœ€è¦ä¼ å…¥æ­£åˆ™åˆ†ç»„åŒ¹é…çš„å†…å®¹ã€‚å¦åˆ™åƒä»¥ä¸‹è¿™æ ·<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">class BlogHandler(RequestHandler):</div><div class="line">        def get(self,year,month,day):</div><div class="line">                pass</div></pre></td></tr></table></figure></p>
<p>åœ¨Tornadoé‡Œé¢å®ƒä½¿ç”¨äº†URLSpecç±»æ¥å°è£…è¿™ä¸ªäº‹æƒ…</p>
<h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><p>å’Œä¸Šä¸€ç¯‡çš„httpserverä¸­ä½¿ç”¨handler_requestå‡½æ•°ä¸åŒã€‚æœ¬ç¯‡çš„webæ¨¡å—å¯¹å®ƒè¿›è¡Œäº†è¿›ä¸€æ­¥çš„å°è£…ã€‚æˆ‘ä»¬é¢å¯¹çš„ç¼–å†™ä¸»è¦çš„ä¸šåŠ¡é€»è¾‘å‡æ˜¯ç»§æ‰¿è‡ªRequestHandlerå¯¹è±¡ã€‚åœ¨ä¸Šä¸€ç« åŸºæœ¬é¢å¯¹çš„è¿˜æ˜¯ç›´æ¥å¯¹iostreamè¿›è¡Œå†™æ“ä½œï¼Œå†™å…¥headerã€å†™å…¥cookiesã€å†™å…¥etagã€æ¨¡æ¿æ¸²æŸ“è¿™äº›éƒ½æ˜¯æ²¡æœ‰ç›´æ¥æä¾›çš„ã€‚webæ¨¡å—ä½œä¸ºå®ƒçš„æ›´é«˜çº§åˆ«å°è£…ï¼Œå®ƒæä¾›äº†è¿™äº›åŠŸèƒ½ã€‚</p>
<ul>
<li>è·¯ç”±åŒ¹é…</li>
<li>ç»™RequestHandlerå¯¹è±¡æš´éœ²Applicationå¯¹è±¡å’ŒRequestå¯¹è±¡</li>
<li>æä¾›çŠ¶æ€ç ã€è·³è½¬ã€urlå‚æ•°ã€headerã€cookiesã€ç¼“å­˜å¤´ã€æ¨¡æ¿æ¸²æŸ“ã€CSRFã€æ—¥å¿—è®°å½•ç­‰åŠŸèƒ½</li>
<li>æä¾›httpè¯·æ±‚ç”Ÿå‘½å‘¨æœŸå†…çš„å„é¡¹hookäº‹ä»¶prepareã€on_finishã€on_connection_close</li>
<li>æä¾›æœ€å¸¸ç”¨çš„è¾…åŠ©å‡½æ•°get_login_urlã€get_current_userç­‰</li>
<li>åŸºäºRequestHandlerç»§æ‰¿å‡ºäº†ä¸€äº›å…¶ä»–å¯¹è±¡ï¼Œæ¯”å¦‚ErrorHandlerã€StaticFileHandlerã€RedirectHandlerç­‰ã€‚æ³¨æ„ï¼Œè¿™ä¸€äº›å’ŒFlaskç­‰webæ¡†æ¶çš„ç”¨æ³•ä¸ä¸€æ ·ã€‚åœ¨Flaskä¸­æ˜¯ç›´æ¥return ErrorHandler()ç­‰ç­‰ã€‚å¯æ˜¯åœ¨Tornadoä¸­æœ€åæ‰§è¡Œçš„æ˜¯RequestHandler._executeï¼Œå®ƒæ˜¯ä¸æ”¯æŒç›´æ¥è¿”å›è¿™ä¸€äº›å¯¹è±¡çš„ã€‚æ¯”å¦‚è·³è½¬ç›´æ¥æ‰§è¡Œself.redirectå³å¯ã€‚è¿™ä¸€äº›ç»§æ‰¿å¯¹è±¡åº”è¯¥ä½¿ç”¨Application.add_handlerè¿›è¡Œè°ƒç”¨ã€‚é…åˆurlåŒ¹é…è§„åˆ™ï¼Œç„¶åæœ€ç»ˆè¢«è°ƒç”¨ErrorHandler._executeç­‰ç­‰</li>
</ul>
<p>webé‡Œé¢è¿˜å­˜åœ¨ä¸€ä¸ªè£…é¥°å™¨å‡½æ•°asynchronousï¼Œè¿™ä¸ªè£…é¥°å™¨åœ¨Tornadoå­˜åœ¨äº†å¾ˆé•¿æ—¶é—´ï¼Œåªæ˜¯ç°åœ¨åŸºæœ¬å¯ä»¥ä¸ä½¿ç”¨å®ƒäº†ã€‚å¯æ˜¯ä¾æ—§å¾ˆå¤šäººå–œæ¬¢ä¸€è¨€ä¸åˆå°±å¸¦ä¸Šå®ƒã€‚ç”¨æ³•æ˜¯è¿™æ ·<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyRequestHandler</span><span class="params">(web.RequestHandler)</span>:</span></div><div class="line"><span class="meta">    @web.asynchronous</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></div><div class="line">        http = httpclient.AsyncHTTPClient()</div><div class="line">        http.fetch(<span class="string">"http://friendfeed.com/"</span>, self._on_download)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_on_download</span><span class="params">(self, response)</span>:</span></div><div class="line">        self.write(<span class="string">"Downloaded!"</span>)</div><div class="line">        self.finish()</div></pre></td></tr></table></figure><br>äº§ç”Ÿçš„åŸå› æ˜¯æœ€ç»ˆweb.RequestHandler._executeè°ƒç”¨äº†getå‡½æ•°ã€‚getæ‰§è¡Œå®Œhttp.fetchæ•´ä¸ªè¿‡ç¨‹å°±å®Œæˆäº†ã€‚åªæ˜¯http.fetchå®ƒå¹¶æ²¡æœ‰é˜»å¡ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯åŠ å…¥äº†IOLoopçš„å›è°ƒï¼Œ_executeçš„é»˜è®¤é€»è¾‘æ˜¯å½“getå‡½æ•°æ‰§è¡Œå®Œæ¯•åä¼šç«‹å³è°ƒç”¨self.finishè¡¨ç¤ºè¯·æ±‚æµç¨‹ç»“æŸã€‚æ˜æ˜¾è¿™ä¸æ˜¯æˆ‘ä»¬éœ€è¦çš„é€»è¾‘ï¼Œæ­£å¸¸é€»è¾‘æ˜¯ç­‰å¾…ç½‘é¡µä¸‹è½½å®Œæ¯•åå†è¿”å›å†…å®¹ï¼Œå› æ­¤web.asynchronousçš„é€»è¾‘å¾ˆç®€å•ã€‚å°†getå‡½æ•°è®¾ç½®ä¸€ä¸ªæ ‡å¿—ä½<code>self._auto_finish = False</code>è¡¨æ˜è¯¥å‡½æ•°ä¸éœ€è¦è°ƒç”¨<code>self.finish()</code>æ“ä½œï¼Œè‡ªç„¶æœ€åå†æ‰‹åŠ¨è°ƒç”¨finishå°±å¥½äº†</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸Šä¸€ç¯‡æ–‡ç« è®²è§£äº†httpserverã€‚å®ƒæœ€ç»ˆä¼ å…¥çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ¥å—çš„æ˜¯Requestå¯¹è±¡ï¼Œè¿™å’ŒTornadoæ‰€å±•ç¤ºçš„Hello Worldæœ‰ä¸€äº›å·®è·ã€‚tornadoçš„webæ¨¡å—å°±æ˜¯å°†å®ƒä»ä¸€ä¸ªå‡½æ•°å˜åŒ–æˆä¸€ä¸ªç±»å¯¹è±¡ï¼Œå¹¶ä¸”åŒ…å«äº†åŸºç¡€çš„è·¯ç”±åŠŸèƒ½ï¼Œæœ€ç»ˆå®ç°ç±»ä¼¼ä¸è¿™æ ·çš„Hello World(ä»£ç åŸºäº1.0.0ç‰ˆæœ¬)&lt;br&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; tornado &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; tornado &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; httpserver&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; tornado &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; ioloop&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;MainHandler&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(web.RequestHandler)&lt;/span&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(self)&lt;/span&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        self.write(&lt;span class=&quot;string&quot;&gt;b&quot;Hello World&quot;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;application = web.Application([&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    (&lt;span class=&quot;string&quot;&gt;r&quot;/&quot;&lt;/span&gt;, MainHandler)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;])&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;http_server = httpserver.HTTPServer(application)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;http_server.listen(&lt;span class=&quot;number&quot;&gt;8888&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ioloop.IOLoop.instance().start()&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Tornado" scheme="https://www.zoulei.net/categories/Tornado/"/>
    
    
  </entry>
  
  <entry>
    <title>Tornado ä¹‹httpserver</title>
    <link href="https://www.zoulei.net/2018/03/15/tornado_httpserver/"/>
    <id>https://www.zoulei.net/2018/03/15/tornado_httpserver/</id>
    <published>2018-03-15T03:37:29.000Z</published>
    <updated>2018-03-15T09:14:55.763Z</updated>
    
    <content type="html"><![CDATA[<p>Tornadoå¯ä»¥å½“åšä¸€ä¸ªhttpå®¢æˆ·ç«¯å»å‘é€è¯·æ±‚ï¼Œå¯ä»¥å¤„ç†éœ€è¦å’Œå®¢æˆ·ç«¯å»ºç«‹é•¿è¿æ¥çš„è¯·æ±‚ã€‚å¯æ˜¯Tornadoæœ€ä¸ºçŸ¥åçš„è¿˜æ˜¯å®ƒä½œä¸ºä¸€ä¸ªHTTP webæ¡†æ¶â€¦,ä¸Šä¸€ç¯‡è®²è¿°äº†IOLoopçš„å¥—è·¯ã€‚æœ¬ç¯‡è®²è§£ä¸€ä¸‹å¦‚ä½•å°†IOLoopå’Œhttpserverè”ç³»èµ·æ¥(æœ¬ä»£ç æ€è·¯ä¾æ®1.0.0ç‰ˆæœ¬)</p>
<a id="more"></a>
<h3 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h3><p>æœ¬æ–‡çš„åŸºæœ¬ç›®æ ‡æ˜¯å®ç°è¿™ä¸ªéœ€æ±‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> tornado <span class="keyword">import</span> httpserver</div><div class="line"><span class="keyword">from</span> tornado <span class="keyword">import</span> ioloop</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_request</span><span class="params">(request)</span>:</span></div><div class="line">    message = <span class="string">b"Hello World\n"</span></div><div class="line">    request.write(<span class="string">b"HTTP/1.0 200 OK\r\nContent-Length: %d\r\n\r\n%s"</span> % (</div><div class="line">        len(message), message))</div><div class="line">    request.finish()</div><div class="line"></div><div class="line">http_server = httpserver.HTTPServer(handle_request)</div><div class="line">http_server.listen(<span class="number">8888</span>)</div><div class="line">ioloop.IOLoop.instance().start()</div></pre></td></tr></table></figure></p>
<h3 id="æœ€ç®€æœåŠ¡ç«¯"><a href="#æœ€ç®€æœåŠ¡ç«¯" class="headerlink" title="æœ€ç®€æœåŠ¡ç«¯"></a>æœ€ç®€æœåŠ¡ç«¯</h3><p>æ ¹æ®ä¸Šä¸€ç¯‡ã€‚æˆ‘ä»¬å¯ä»¥æƒ³åˆ°å½“æ‰§è¡Œlistenç›‘å¬æ“ä½œçš„æ—¶å€™ï¼Œä¼šåˆ›å»ºä¸€ä¸ªç›‘å¬socket.ç„¶åå°†å¤„ç†å‡½æ•°æ·»åŠ åˆ°äº‹ä»¶å›è°ƒä¸­ã€‚ä¸è€ƒè™‘å¼‚å¸¸å› ç´ ï¼Œæœ€ç®€å•çš„æ˜¯è¿™æ ·<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> socket</div><div class="line"><span class="keyword">from</span> tornado <span class="keyword">import</span> ioloop</div><div class="line"><span class="keyword">from</span> selectors <span class="keyword">import</span> EVENT_READ, EVENT_WRITE</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">HTTPServer</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, handler)</span>:</span></div><div class="line">        self.handler = handler</div><div class="line">        self.io_loop = ioloop.IOLoop.instance()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">listen</span><span class="params">(self, port)</span>:</span></div><div class="line">        self.s = socket.socket()</div><div class="line">        self.s.setblocking(<span class="number">0</span>)</div><div class="line">        self.s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</div><div class="line">        self.s.bind((<span class="string">'127.0.0.1'</span>, port))</div><div class="line">        self.s.listen(<span class="number">128</span>)</div><div class="line">        self.io_loop.add_handler(self.s.fileno(), EVENT_READ, self._handle)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_handle</span><span class="params">(self)</span>:</span></div><div class="line">        client_sock, _ = self.s.accept()</div><div class="line">        client_sock.send(<span class="string">b"HTTP/1.0 200 OK\r\nContent-Length: 12\r\n\r\nHello World\n"</span>)</div><div class="line">        client_sock.close()</div></pre></td></tr></table></figure><br>å¯¹äºç›‘å¬socket,å½“è§¦å‘å¯è¯»çš„æ—¶å€™æ„å‘³æœ‰æ–°çš„å®¢æˆ·ç«¯è¿æ¥è¿›æ¥äº†ï¼Œæ­¤æ—¶è°ƒç”¨å›è°ƒè¿›è¡Œacceptå¾—åˆ°äº¤äº’socketè¿æ¥ã€‚ç®€å•èµ·è§ç›´æ¥sendå‘é€ä¸€ä¸ªç®€æ˜“çš„HTTPæ¶ˆæ¯ç„¶åå…³é—­socket</p>
<h3 id="å°è£…Requestå¯¹è±¡"><a href="#å°è£…Requestå¯¹è±¡" class="headerlink" title="å°è£…Requestå¯¹è±¡"></a>å°è£…Requestå¯¹è±¡</h3><p>ä»ä¸Šé¢çš„ç¤ºä¾‹ä¸­å¯ä»¥çœ‹åˆ°ã€‚å®ƒæ²¡æœ‰è°ƒç”¨ä¼ å…¥çš„requestå‡½æ•°ï¼Œå› ä¸ºsocketå¯¹è±¡å¹¶æ²¡æœ‰writeå’Œfinishæ–¹æ³•ã€‚æ­¤å¤–ï¼Œå³ä½¿æˆ‘ä»¬å°†socketçš„sendå’Œcloseå½“åšwriteå’Œfinishã€‚å®ƒè¿˜æœ‰ä¸€ä¸ªå·¨å¤§çš„ç¼ºé™·ã€‚æˆ‘ä»¬åªæ˜¯è¿›è¡Œäº†å‘é€ï¼Œè€Œæ²¡æœ‰å¯¹æ¥æ”¶åˆ°çš„httpæŠ¥æ–‡è¿›è¡Œä»»ä½•å¤„ç†ã€‚<br>ä¸€èˆ¬è€Œè¨€ï¼Œä¼šä»å®ƒçš„è¡Œé¦–ã€å¤´éƒ¨ã€æ¶ˆæ¯ä½“å¾—åˆ°æŸä¸€äº›æˆ‘ä»¬éœ€è¦çš„å†…å®¹ï¼Œç„¶åå¯¹å†…å®¹è¿›è¡Œå¤„ç†ï¼Œæœ€ç»ˆå†™å…¥ä¿¡æ¯ï¼Œè¿‡ç¨‹ç»“æŸã€‚å› æ­¤ï¼Œå°è£…ä¸€ä¸ªRequestå¯¹è±¡æ˜¯å¿…é¡»çš„ï¼Œæœ€åå°†å°è£…çš„å¯¹è±¡ä¼ å…¥åˆ°handlerå‡½æ•°ä»¥ä¾›ä½¿ç”¨ã€‚å¦‚ä½•å°è£…å‘¢ï¼Ÿæˆ‘ä»¬åªéœ€è¦çŸ¥é“ä¸€ä¸ªå®Œæ•´çš„HTTPæŠ¥æ–‡å³å¯ä»¥å¾—åˆ°ä¸€ä¸ªrequestså¯¹è±¡ï¼Œè€Œä¸€ä¸ªhttpæŠ¥æ–‡åˆæœ‰æ˜æ˜¾çš„åˆ†éš”ç¬¦.ä¾‹å¦‚ä¸‹æ–‡è¿™ä¸ªè¯·æ±‚æŠ¥æ–‡<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">GET /docs/index.html HTTP/1.1</div><div class="line">Host: www.ipinfo.com</div><div class="line">Accept: image/gif, image/jpeg, */*</div><div class="line">Accept-Language: en-us</div><div class="line">Accept-Encoding: gzip, deflate</div><div class="line">User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)</div><div class="line">(blank line)</div></pre></td></tr></table></figure></p>
<p>è·å–æµç¨‹å¦‚ä¸‹ã€‚å½“è¯»å–åˆ°ç¬¬ä¸€ä¸ª<code>\r\n</code>å³ç¡®å®šReques Lineéƒ¨åˆ†ï¼Œå½“è¯»å–åˆ°<code>\r\n\r\n</code>å³ç¡®å®šHeaderéƒ¨åˆ†ï¼Œå¦‚æœHeaderéƒ¨åˆ†å­˜åœ¨Content-Lengthåˆ™è¡¨ç¤ºå­˜åœ¨bodyéƒ¨åˆ†ï¼Œå­˜åœ¨åˆ™ç»§ç»­è¯»å–Content-Lengthé•¿åº¦ã€‚å¦‚æ­¤ä¸‹æ¥å•ä¸ªHTTPæŠ¥æ–‡è¯»å–å®Œæ¯•ã€‚å¯ä»¥æ„å»ºè¿™ä¸ªè¿‡ç¨‹ï¼ŒRequests Lineè¯»å–å®Œæ¯•åâ€”&gt;å›è°ƒè¯»å–Headeréƒ¨åˆ†â€”&gt;å›è°ƒè¯»å–Bodyéƒ¨åˆ†â€”&gt;æ„å»ºRequestå¯¹è±¡â€”&gt;å›è°ƒhandlerå‡½æ•°ï¼Œå°†Requestå¯¹è±¡ä¼ å…¥ã€‚å¦å¤–ç¬¬ä¸€æ­¥å¯ä»¥çœç•¥,è¯»å–Headerå³åŒ…å«Requests Line</p>
<p>å¯ä»¥çœ‹åˆ°å¯¹äºä¸€ä¸ªsocketå¯¹è±¡,å°†å®ƒæ ¹æ®åˆ†éš”ç¬¦ä»¥åŠé•¿åº¦è¯»å–å°±èƒ½è§£ææˆå•ä¸ªhttpåŒ…ï¼Œå¦å¤–å¯¹äºå¾ˆå¤šæµåè®®ä¹Ÿæ˜¯å¦‚æ­¤ã€‚æˆ‘ä»¬å°†socketå°è£…ä¸€ä¸‹ã€‚è®©å®ƒæä¾›ä¸¤ä¸ªåŠŸèƒ½read_untilã€read_bytesã€‚å…è®¸è¯»å–åˆ°åˆ†éš”ç¬¦åè°ƒç”¨å›è°ƒå‡½æ•°ã€è¯»å–åˆ°å›ºå®šé•¿åº¦åè°ƒç”¨å›è°ƒå‡½æ•°ã€‚æœ€ç®€ä»£ç å¦‚ä¸‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> tornado <span class="keyword">import</span> ioloop</div><div class="line"><span class="keyword">from</span> selectors <span class="keyword">import</span> EVENT_READ</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">IOStream</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, socket)</span>:</span></div><div class="line">        self.socket = socket</div><div class="line">        self.ioloop = ioloop.IOLoop.instance()</div><div class="line">        self.ioloop.add_handler(self.socket.fileno(), EVENT_READ, self._handler)</div><div class="line">        self._read_buffer = <span class="string">b""</span></div><div class="line">        self._read_delimiter = <span class="keyword">None</span></div><div class="line">        self._read_bytes = <span class="keyword">None</span></div><div class="line">        self._read_callback = <span class="keyword">None</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_handler</span><span class="params">(self)</span>:</span></div><div class="line">        data = self.socket.recv(<span class="number">1024</span>)</div><div class="line">        self._read_buffer += data</div><div class="line">        <span class="keyword">if</span> self._read_delimiter <span class="keyword">and</span> self._read_delimiter <span class="keyword">in</span> self._read_buffer:</div><div class="line">            result, self._read_buffer = self._read_buffer.split(self._read_delimiter)</div><div class="line">            self._read_callback(result)</div><div class="line">            self._read_delimiter = <span class="keyword">None</span></div><div class="line">            self._read_callback = <span class="keyword">None</span></div><div class="line">        <span class="keyword">elif</span> self._read_bytes <span class="keyword">and</span> len(self._read_buffer) &gt; self._read_bytes:</div><div class="line">            result = self._read_buffer[:self._read_bytes]</div><div class="line">            self._read_buffer = self._read_buffer[self._read_bytes:]</div><div class="line">            self._read_callback(result)</div><div class="line">            self._read_bytes = <span class="keyword">None</span></div><div class="line">            self._read_callback = <span class="keyword">None</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read_until</span><span class="params">(self, delimiter, callback)</span>:</span></div><div class="line">        self._read_delimiter = delimiter</div><div class="line">        self._read_callback = callback</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read_bytes</span><span class="params">(self, length, callback)</span>:</span></div><div class="line">        self._read_bytes = length</div><div class="line">        self._read_callback = callback</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(self, data)</span>:</span></div><div class="line">        self.socket.send(data)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></div><div class="line">        self.ioloop.ioloop.unregister(self.socket.fileno())</div><div class="line">        self.socket.close()</div></pre></td></tr></table></figure><br>å¯¹äºåˆ›å»ºçš„IOStreamå¯¹è±¡ï¼Œå®ƒæ·»åŠ READäº‹ä»¶ï¼Œå°†å›è°ƒå‡½æ•°è®¾ç½®ä¸ºself._handlerã€‚å½“ä½¿ç”¨read_untilçš„æ—¶å€™å°†å†å²æ•°æ®ç»™callbackå‡½æ•°è°ƒç”¨ã€‚<br>å†çœ‹ä¸€ä¸‹HTTPConnectå¯¹è±¡<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">HTTPConnection</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, io_stream, handler_callback)</span>:</span></div><div class="line">        self.io_loop = ioloop.IOLoop.instance()</div><div class="line">        self.stream = io_stream</div><div class="line">        self.handler_callback = handler_callback</div><div class="line">        self.stream.read_until(<span class="string">b'\r\n\r\n'</span>, self._parse_header)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_parse_header</span><span class="params">(self, data)</span>:</span></div><div class="line">        <span class="comment"># å¿½ç•¥è¡Œé¦–ï¼Œå…¨éƒ¨å½“åšheader</span></div><div class="line">        request = Request(connect=self, header=data)</div><div class="line">        self.handler_callback(request)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(self, data)</span>:</span></div><div class="line">        self.stream.write(data)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">finish</span><span class="params">(self)</span>:</span></div><div class="line">        self.stream.close()</div></pre></td></tr></table></figure><br>æ˜¾ç„¶ï¼Œå®ƒä¼ å…¥çš„æ˜¯IOStreamå¯¹è±¡ï¼Œå¹¶ä¸”åœ¨åˆå§‹åŒ–çš„æ—¶å€™å°±è°ƒç”¨read_untilè¯»å–HTTP Headeréƒ¨åˆ†å†…å®¹ã€‚ç®€å•èµ·è§ï¼Œè¿™é‡Œåªè¯»å–å¹¶æ²¡æœ‰è§£æã€‚æœ€åå°è£…æˆRequestå¯¹è±¡ã€‚è®©handle_requestå‡½æ•°è°ƒç”¨ã€‚è¾¾åˆ°æˆ‘ä»¬æ–‡ç« å¼€å¤´çš„ç›®çš„<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, connect, header)</span>:</span></div><div class="line">        self.connect = connect</div><div class="line">        self.header = header</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(self, data)</span>:</span></div><div class="line">        self.connect.write(data)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">finish</span><span class="params">(self)</span>:</span></div><div class="line">        self.connect.finish()</div></pre></td></tr></table></figure><br>å°†æœ€å¼€å§‹çš„æœ€ç®€æœåŠ¡å™¨éƒ¨åˆ†ç¨å¾®æ”¹åŠ¨ä¸€ä¸‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_handle</span><span class="params">(self)</span>:</span></div><div class="line">    client_sock, _ = self.s.accept()</div><div class="line">    stream = IOStream(client_sock)</div><div class="line">    HTTPConnection(stream, self.handler)</div></pre></td></tr></table></figure></p>
<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>IOStreamã€HTTPConnectionã€Requestã€HTTPServerã€‚å…¶ä¸­æš´æ¼ç»™ç”¨æˆ·çš„å‡ ä¹åªæœ‰Requestå¯¹è±¡ï¼Œä»ä¸Šé¢çš„åˆ†æä¸­åº”è¯¥å¯ä»¥å‘ç°ã€‚å°†æ–‡ä»¶æè¿°ç¬¦åŠ å…¥äº‹ä»¶ï¼Œç­‰å¾…IOStreamçš„å…¨å±€_headerè¿›è¡Œå›è°ƒï¼Œå…¨å±€_headeråˆé’ˆå¯¹å„ç§æƒ…å†µ(åˆ†éš”ç¬¦æ¡ä»¶æ»¡è¶³ã€é•¿åº¦æ¡ä»¶æ»¡è¶³)å‘èµ·å›è°ƒã€‚åŒæ—¶<span style="color:red"><strong>å¦‚æœä¸è°ƒç”¨iostream.read_untilç­‰é‚£ä¹ˆå…¨å±€çš„_headerå°±æ²¡æœ‰æ„ä¹‰äº†</strong></span>ã€‚æå®šIOStreamåã€‚ç«‹é©¬åœ¨HTTPConnectioné‡Œé¢è°ƒç”¨<code>iostream.read_until</code>ã€‚è¢«å›è°ƒåˆ™è¡¨æ˜HTTPå¤´éƒ¨æ¥æ”¶å®Œæˆã€‚ç»„è£…æˆRequestsç„¶åè°ƒç”¨handle_requestã€‚</p>
<p>ä½œç”¨åˆ†å·¥:<br>HTTPServer:     åˆ›å»ºç›‘å¬socket,ä¼ å…¥httpå¤„ç†å›è°ƒå‡½æ•°<br>IOStream:   æä¾›é€šç”¨TCPæµè§£æï¼Œæœ€é‡è¦çš„æ˜¯æä¾›äº†writeã€read_untilã€read_lengthï¼Œ<span style="color:red"><strong>ä¸”å¯ä»¥ä¼ å…¥å›è°ƒ</strong></span><br>Request:    å°†å­—ç¬¦ä¸²è§£ææˆä¸€ä¸ªRequestå¯¹è±¡ã€‚ä¾¿äºç®€å•çš„è·å–è®¿é—®ä¿¡æ¯ã€‚å¦‚urlã€hostã€portã€bodyç­‰ç­‰<br>HTTPConnection:  å°†å‰ä¸‰è€…è”ç³»èµ·æ¥,è°ƒç”¨IOStream.read_untilå¼€å¯è·å–HTTPæ•°æ®åŒ…çš„æµç¨‹</p>
<p>å¦å¤–æœ¬æ–‡ç®€å•èµ·è§ï¼Œåªæ³¨å†Œäº†READäº‹ä»¶ã€‚å¯¹äºsendæ“ä½œã€‚åŒæ ·æ˜¯éœ€è¦è¿›è¡Œæ³¨å†Œäº‹ä»¶ã€‚ç­‰åˆ°WRITEäº‹ä»¶è§¦å‘æ‰æ‰§è¡Œsendæ“ä½œï¼Œå¸Œæœ›ä¸è¦å¼•èµ·è¯¯è§£ï¼Œå¦å¤–æœ¬ä¾‹ä¸­ä½¿ç”¨HTTP/1.0çš„é€»è¾‘ï¼Œå¤„ç†å®Œæˆå•ä¸ªé“¾æ¥åç›´æ¥å…³é—­ã€‚å¯¹äºHTTP/1.1æ¥è¯´è¦å®ç°keep-aliveåªéœ€è¦åœ¨finishçš„ä½¿ç”¨å¹¶ä¸å…³é—­é“¾æ¥ï¼Œè€Œæ˜¯ç»§ç»­æ‰§è¡Œself.read_until(bâ€™\r\n\r\nâ€™,self._parse_header)ç»§ç»­ç­‰å¾…å¤„ç†ä¸‹ä¸€ä¸ªHTTPæŠ¥æ–‡</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Tornadoå¯ä»¥å½“åšä¸€ä¸ªhttpå®¢æˆ·ç«¯å»å‘é€è¯·æ±‚ï¼Œå¯ä»¥å¤„ç†éœ€è¦å’Œå®¢æˆ·ç«¯å»ºç«‹é•¿è¿æ¥çš„è¯·æ±‚ã€‚å¯æ˜¯Tornadoæœ€ä¸ºçŸ¥åçš„è¿˜æ˜¯å®ƒä½œä¸ºä¸€ä¸ªHTTP webæ¡†æ¶â€¦,ä¸Šä¸€ç¯‡è®²è¿°äº†IOLoopçš„å¥—è·¯ã€‚æœ¬ç¯‡è®²è§£ä¸€ä¸‹å¦‚ä½•å°†IOLoopå’Œhttpserverè”ç³»èµ·æ¥(æœ¬ä»£ç æ€è·¯ä¾æ®1.0.0ç‰ˆæœ¬)&lt;/p&gt;
    
    </summary>
    
      <category term="Tornado" scheme="https://www.zoulei.net/categories/Tornado/"/>
    
    
  </entry>
  
  <entry>
    <title>Tornado ä¹‹IOLoop</title>
    <link href="https://www.zoulei.net/2018/03/14/tornado_ioloop/"/>
    <id>https://www.zoulei.net/2018/03/14/tornado_ioloop/</id>
    <published>2018-03-14T10:03:18.000Z</published>
    <updated>2018-03-15T03:21:18.382Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™æ˜¯Tornadoç³»åˆ—çš„å¼€ç¯‡,Tornadoä½œä¸ºå¼‚æ­¥webæ¡†æ¶2010å¹´å‘å¸ƒ1.0ç‰ˆæœ¬ã€‚å¯ä»¥è¯´Pythonç¤¾åŒºæäº†è¿™ä¹ˆå¤šå¹´ï¼Œä¸ºäº†è·å¾—æ¯”å¤šçº¿ç¨‹å¤šè¿›ç¨‹æ›´é«˜çš„æ€§èƒ½ï¼Œç»å†äº†Twistedã€Tornadoã€yieldã€geventã€yield fromã€asyncioã€‚ä¹Ÿä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™æ‰æ˜¯ä¸€ä¸ªå°½å¤´~~ã€‚Tornadoè¿‡äº†è¿™ä¹ˆå¤šå¹´è¿˜ç®—å¼€å‘æ´»è·ƒ(<a href="https://github.com/tornadoweb/tornado/graphs/contributors">ä¸€ä¸ªå¤§ç¥æ‰›èµ·äº†ä¸€ç‰‡å¤©å•Š</a>)ï¼Œä¸åŒäºå¤šçº¿ç¨‹æ¨¡å‹çš„ä¸€æ½­æ­»æ°´ï¼Œçœ‹å®ƒçš„ä»£ç ä½ ä¼šå‘ç°å®ƒè¿˜æ˜¯ç´§è·Ÿæ½®æµçš„ï¼Œè€Œä¸”æœ‰ä¸€ç‚¹ã€‚å®ƒçš„å†…éƒ¨è™½ç„¶ä¸€ç›´åœ¨å˜åŠ¨ï¼Œä½†æ˜¯æä¾›ç»™ç”¨æˆ·çš„ä½¿ç”¨æ¥å£æ˜¯å¾ˆç¨³å®šçš„ï¼Œåç»­å°±ä¼šå‘ç°è¿™ä¸ªå‘æœ‰å¤šå¤§</p>
<a id="more"></a>
<p>æˆªæ­¢ç›®å‰æœ€æ–°ç‰ˆæœ¬çš„ä»£ç æ˜¯4.5ï¼Œæ’é™¤æµ‹è¯•æ€»ä»£ç é‡å¤§çº¦ä¸º12000è¡Œã€‚æˆ‘ä¸ªäººå–œæ¬¢çœ‹ç²¾ç®€ç‰ˆæœ¬çš„ä»£ç ï¼Œæ‰€ä»¥æœ¬æ–‡ä¸º1.0.0ç‰ˆæœ¬ã€‚æ€»ä»£ç é‡ä¸º4200è¡Œï¼Œæ¯”è¾ƒå®¹æ˜“çœ‹æ‡‚ã€‚æ¯•ç«Ÿåˆ«äººä¼˜åŒ–äº†å…«å¹´ï¼ŒæœŸå¾…ä¸€ä¸ªæ˜ŸæœŸç²¾è¯»èƒ½ææ˜ç™½å„ç§å·¥ç¨‹ä¼˜åŒ–æ˜¯ä¸ç°å®çš„ã€‚</p>
<h3 id="IOLoop"><a href="#IOLoop" class="headerlink" title="IOLoop"></a>IOLoop</h3><p>è¯´åˆ°å¼‚æ­¥éé˜»å¡å¤§å¤šæ•°äººéƒ½çŸ¥é“æ˜¯å¼‚æ­¥IOæ¨¡å‹(selectã€pollã€epollã€kqueue)ã€‚æ²¡é”™åœ¨é˜»å¡æ¨¡å‹ä¸­æ¯”å¦‚ä½¿ç”¨<code>socket.recv</code>å®ƒä¼šä¸»çº¿ç¨‹é€ æˆé˜»å¡ã€‚è¿™ç›´æ¥å¯¼è‡´äº†åœ¨pythonä¸­éœ€è¦ä½¿ç”¨å¤šçº¿ç¨‹æˆ–è€…å¤šè¿›ç¨‹æ¨¡å‹æ‰èƒ½å¤ŸåŒæ—¶å¤„ç†å¤šä¸ªè¯·æ±‚ã€‚å¯æ˜¯åœ¨å¼‚æ­¥æ¨¡å‹ä¸­å…è®¸å¯¹æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œç›‘å¬ï¼Œæ“ä½œç³»ç»Ÿæä¾›åŠŸèƒ½ï¼Œå½“æ–‡ä»¶çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–(å¯è¯»ã€å¯å†™ã€å¼‚å¸¸)ç¨‹åºèƒ½å¤Ÿè·å¾—è¿™ä¸€çŠ¶æ€ã€‚å¯¹æˆ‘ä»¬æ¥è¯´å°±æ˜¯å½“æ˜ç¡®çŸ¥é“æŸæ–‡ä»¶å­˜åœ¨ä»€ä¹ˆäº‹ä»¶çš„æ—¶å€™å»è§¦å‘ç›¸åº”çš„å¤„ç†å‡½æ•°ã€‚æ³¨æ„ï¼Œè¿™å°±æ˜¯ä¸€ä¸ª<span style="color:red"><strong>å›è°ƒã€å›è°ƒã€å›è°ƒ(é‡è¦çš„äº‹æƒ…è¯´ä¸‰é)</strong></span></p>
<p>å¯ä»¥æŠŠIOLoopå½“åšä¸€ä¸ªåœä¸ä¸‹æ¥çš„æ­»å¾ªç¯ï¼Œç±»ä¼¼ä¸‹é¢è¿™æ ·<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">import</span> bisect</div><div class="line"><span class="keyword">from</span> selectors <span class="keyword">import</span> DefaultSelector</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">IOLoop</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self._callback = set()</div><div class="line">        self._timeout = []</div><div class="line">        self.ioloop = DefaultSelector()</div><div class="line"></div><div class="line"><span class="meta">    @classmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">instance</span><span class="params">(cls)</span>:</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(cls, <span class="string">'_instance'</span>):</div><div class="line">            cls._instance = cls()</div><div class="line">        <span class="keyword">return</span> cls._instance</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_handler</span><span class="params">(self, fd, event, func)</span>:</span></div><div class="line">        self.ioloop.register(fd, event, func)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update_handler</span><span class="params">(self, fd, event)</span>:</span></div><div class="line">        temp = ioloop.get_key(fd)</div><div class="line">        ioloop.unregister(fd)</div><div class="line">        ioloop.register(fd, event, temp.data)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_callback</span><span class="params">(self, func)</span>:</span></div><div class="line">        self._callback.add(func)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_timeout</span><span class="params">(self, t, func)</span>:</span></div><div class="line">        <span class="class"><span class="keyword">class</span> <span class="title">_T</span>:</span></div><div class="line">            <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, t, func)</span>:</span></div><div class="line">                self.t = t</div><div class="line">                self.callback = func</div><div class="line"></div><div class="line">            <span class="function"><span class="keyword">def</span> <span class="title">__lt__</span><span class="params">(self, other)</span>:</span></div><div class="line">                <span class="keyword">return</span> self.t &lt; other.t</div><div class="line"></div><div class="line">            <span class="function"><span class="keyword">def</span> <span class="title">__gt__</span><span class="params">(self, other)</span>:</span></div><div class="line">                <span class="keyword">return</span> self.t &gt; other.t</div><div class="line"></div><div class="line">        t = _T(t, func)</div><div class="line">        bisect.insort(self._timeout, t)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></div><div class="line"></div><div class="line">        <span class="keyword">while</span> <span class="number">1</span>:</div><div class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> self._callback.copy():</div><div class="line">                i()</div><div class="line">                self._callback.remove(i)</div><div class="line"></div><div class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> self._timeout.copy():</div><div class="line">                <span class="keyword">if</span> time.time() &gt; i.t:</div><div class="line">                    i.callback()</div><div class="line">                    self._timeout.remove(i)</div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    <span class="keyword">break</span></div><div class="line"></div><div class="line">            <span class="keyword">for</span> k, v <span class="keyword">in</span> self.ioloop.select(timeout=<span class="number">0.2</span>):</div><div class="line">                k.data()</div></pre></td></tr></table></figure></p>
<p>ä½ åªéœ€è¦è®°ä½ä»¥ä¸‹å‡ ç‚¹</p>
<ol>
<li><span style="color:red"><strong>IOLoopæ˜¯ä¸€ä¸ªå•ä¾‹</strong></span></li>
<li>IOLoopæä¾›äº†å¤„ç†ä¸‰ç§æƒ…å†µçš„æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯å›è°ƒå½¢å¼(_callback)ã€å®šæ—¶å™¨å½¢å¼(_timeout)ã€ç½‘ç»œIO(selectors)</li>
<li>æœ€åæ˜¯ä¸€ä¸ªwhile 1çš„æ­»å¾ªç¯</li>
</ol>
<h3 id="Callback"><a href="#Callback" class="headerlink" title="Callback"></a>Callback</h3><p>æ­£å› ä¸ºIOLoopæ˜¯ä¸€ä¸ªå•ä¾‹ã€‚æ‰€ä»¥æ‰€æœ‰çš„å‡½æ•°æœ€ç»ˆéƒ½é€šè¿‡add_callbackã€add_timeoutã€add_handleræ”¾ç½®åˆ°äº†IOLoopä¸‹é¢ï¼Œæœ€ç»ˆè¢«æ‰§è¡Œstartä¾æ¬¡è°ƒç”¨ï¼Œå†è°ƒç”¨çš„è¿‡ç¨‹ä¸­ï¼Œè¿™äº›å‡½æ•°åˆä½¿ç”¨ioloop.IOLoop.instance().add_callbackç­‰ä¸æ–­çš„åŠ å…¥ä¸€äº›äº‹ä»¶å¤„ç†ã€‚å¯¼è‡´å½¢æˆäº†ä¸€ä¸ªcallbacké“¾æ¡ï¼Œè®©æˆ‘ä»¬æœ€ç»ˆå¾—åˆ°ç»“æœ<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ä»£ç ä¸ºpython3</span></div><div class="line"><span class="keyword">from</span> selectors <span class="keyword">import</span> DefaultSelector, EVENT_WRITE, EVENT_READ</div><div class="line"><span class="keyword">import</span> socket</div><div class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</div><div class="line"></div><div class="line">done = <span class="keyword">False</span></div><div class="line">selector = DefaultSelector()</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(url)</span>:</span></div><div class="line">    parse = urlparse(url)</div><div class="line">    s = socket.socket()</div><div class="line">    s.setblocking(<span class="keyword">False</span>)</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        s.connect((parse.hostname, <span class="number">80</span>))</div><div class="line">    <span class="keyword">except</span> BlockingIOError:</div><div class="line">        <span class="keyword">pass</span></div><div class="line">    selector.register(s.fileno(), EVENT_WRITE, <span class="keyword">lambda</span>: connected(s, parse.path, parse.hostname))</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">connected</span><span class="params">(s, path, host)</span>:</span></div><div class="line">    selector.unregister(s.fileno())</div><div class="line">    s.send((<span class="string">'GET &#123;&#125; HTTP/1.0\r\nHost:&#123;&#125;\r\n\r\n'</span>.format(path, host)).encode())</div><div class="line">    buf = []</div><div class="line">    selector.register(s.fileno(), EVENT_READ, <span class="keyword">lambda</span>: readable(s, buf))</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">readable</span><span class="params">(s, buf)</span>:</span></div><div class="line">    <span class="keyword">global</span> done</div><div class="line">    chunk = s.recv(<span class="number">1024</span>)</div><div class="line">    <span class="keyword">if</span> chunk:</div><div class="line">        buf.append(chunk)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        done = <span class="keyword">True</span></div><div class="line">        selector.unregister(s.fileno())</div><div class="line">        print((<span class="string">b''</span>.join(buf)).decode())</div><div class="line">        s.close()</div><div class="line"></div><div class="line"></div><div class="line">get(<span class="string">"http://httpbin.org/ip"</span>)</div><div class="line"></div><div class="line"><span class="keyword">while</span> <span class="keyword">not</span> done:</div><div class="line">    events = selector.select()</div><div class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> events:</div><div class="line">        k.data()</div></pre></td></tr></table></figure>    </p>
<p>å¦‚ä¸Šä¾‹.å½“æˆ‘ä»¬è°ƒç”¨get()å¼€å§‹æ‰§è¡Œä»£ç çš„æ—¶å€™å®ƒåªæ˜¯å¼€å¯äº†ç¬¬ä¸€æ­¥åˆ›å»ºäº†ä¸€ä¸ªsocketé“¾æ¥å¹¶åœ¨selectorä¸­æ³¨å†Œäº†ä¸€ä¸ªäº‹ä»¶ï¼Œç­‰å¾…READäº‹ä»¶è¢«è§¦å‘ï¼Œk.data()è¢«è°ƒç”¨ï¼Œå³connectedå‡½æ•°è¢«è°ƒç”¨ï¼Œå‘é€æ•°æ®ä¹‹åå†æ¬¡æ³¨å†ŒREADäº‹ä»¶ã€‚ä¾ç„¶ç­‰å¾…ç›´åˆ°k.data()è¢«è°ƒç”¨ï¼Œå³readableè¢«è°ƒç”¨ã€‚æœ€åç›´è‡³æ•°æ®è¯»å–å®Œæˆã€‚è¡¨ç¤ºæ•´ä¸ªè¿‡ç¨‹ç»“æŸ</p>
<h3 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h3><p>è§‚å¯ŸIOLoopä¾‹å­ä¸­çš„startæ­»å¾ªç¯å¯ä»¥çŸ¥é“ã€‚å®ƒå…¶å®ä¹Ÿæ˜¯ä¼´éšç€é˜»å¡çš„ï¼Œåœ¨<code>self.ioloop.select(timeout=0.2)</code>ä¸­å¦‚æœæŒç»­0.2ç§’æ²¡æœ‰ç­‰å¾…çš„IOäº‹ä»¶å‘ç”Ÿï¼Œé‚£ä¹ˆä¼šé˜»å¡0.2ç§’ï¼Œçœ‹ä¼¼0.2ç§’ä¹Ÿä¸é•¿ï¼Œä½†å…¶å®éå¸¸å¤§é‡çš„äº‹ä»¶å¹¶ä¸æ˜¯IOäº‹ä»¶ï¼Œè€Œæ˜¯åœ¨self._callbacké›†åˆä¸­ã€‚å› æ­¤ä»æ•ˆç‡æ–¹é¢è€ƒè™‘æ·»åŠ _callbackçš„æ—¶å€™è§¦å‘IOäº‹ä»¶ï¼Œè®©selectä¸å†å»é˜»å¡é‚£0.2ç§’ï¼Œå› æ­¤åˆ›å»ºäº†ä¸€ä¸ªç®¡é“å¯¹è±¡æ¥è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå½“æ·»åŠ çš„_callbackçš„æ—¶å€™åŒæ—¶å‘ç®¡é“å†™å…¥ä¸€ä¸ªå­—ç¬¦ã€‚é‚£ä¹ˆå°±ä¸å­˜åœ¨0.2ç§’çš„é˜»å¡äº†</p>
<h3 id="åº”ç”¨ä¸€-PeriodicCallback"><a href="#åº”ç”¨ä¸€-PeriodicCallback" class="headerlink" title="åº”ç”¨ä¸€ PeriodicCallback"></a>åº”ç”¨ä¸€ PeriodicCallback</h3><p>ioloop.pyä¸‹é¢æœ‰ä¸€ä¸ªéå¸¸ç®€å•çš„PeriodicCallbackç±»ï¼Œå®ƒçš„ä½œç”¨æ˜¯å®šæœŸå°†callbackåŠ å…¥åˆ°IOLoopçš„_timeoutåˆ—è¡¨ä¸­ã€‚æ¯”å¦‚ä½ éœ€è¦æ¯éš”ä¸‰ååˆ†é’Ÿå»æ¸…ç†ä¸€æ¬¡ä¸´æ—¶æ–‡ä»¶å¤¹äº§ç”Ÿçš„åƒåœ¾æ–‡ä»¶ç­‰ç­‰ã€‚ç®€æ˜“å®ç°å¤§æ¦‚æ˜¯è¿™æ ·<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PeriodicCallback</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, interval, func)</span>:</span></div><div class="line">        self.interval = interval</div><div class="line">        self.func = func</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></div><div class="line">        timeout = time.time() + self.interval</div><div class="line">        IOLoop.instance().add_timeout(timeout, self.callback)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">callback</span><span class="params">(self)</span>:</span></div><div class="line">        self.func()</div><div class="line">        self.start()</div></pre></td></tr></table></figure><br>å†æ‰§è¡Œstartä¹‹åæ·»åŠ åˆ°äº†_timeoutã€‚å¾…æ—¶é—´åˆ°è¾¾åæ‰§è¡Œä¸€æ¬¡ç„¶åå†è°ƒç”¨startï¼Œå¦‚æ­¤åå¤ğŸ˜³ã€‚æœ€åè¾¾åˆ°äº†æ— é™å¾ªç¯æ‰§è¡Œçš„æ•ˆæœ</p>
<h3 id="åº”ç”¨äºŒ-è‡ªåŠ¨é‡å¯"><a href="#åº”ç”¨äºŒ-è‡ªåŠ¨é‡å¯" class="headerlink" title="åº”ç”¨äºŒ è‡ªåŠ¨é‡å¯"></a>åº”ç”¨äºŒ è‡ªåŠ¨é‡å¯</h3><p>å¯¹äºwebæ¡†æ¶è€Œè¨€ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­å½“ä»£ç å‘ç”Ÿå˜æ›´è‡ªåŠ¨é‡å¯æœºåˆ¶å‡ ä¹æ˜¯éƒ½å¿…å¤‡çš„ã€‚åœ¨Flaskä¸­æ˜¯ä¸»çº¿ç¨‹å•ç‹¬å¼€äº†ä¸€ä¸ªè¿›ç¨‹ï¼Œåœ¨è¿›ç¨‹é‡Œé¢å°†ä¸»å‡½æ•°å¼€ä¸€ä¸ªçº¿ç¨‹è¿è¡Œã€‚ç„¶åæ‰§è¡Œæ­»å¾ªç¯è¿›è¡Œä»£ç å˜æ›´æ£€æµ‹ã€‚å‘ç°å˜æ›´åˆ™è¿›è¡Œè¿›ç¨‹é€€å‡ºæ“ä½œã€‚ä¸»çº¿ç¨‹æ•è·é€€å‡ºçŠ¶æ€è¿›è¡Œé‡å¯ã€‚ç¤ºä¾‹ä»£ç å¯ä»¥<a href="/2016/07/25/werkzeug_note_requests_response_auto_realod/index.html#çƒ­é‡å¯å®ç°åŸç†">çœ‹è¿™é‡Œ</a></p>
<p>å¯ä»¥çœ‹åˆ°è‡ªåŠ¨é‡å¯åŸºæœ¬ç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆã€‚</p>
<ol>
<li>ä¸»ä»£ç æ­£å¸¸æ‰§è¡Œ</li>
<li>æ£€æµ‹ä»£ç å˜æ›´é€»è¾‘å®šæœŸæ‰§è¡Œ</li>
<li>æ£€æµ‹åˆ°å˜æ›´åé‡å¯ç¨‹åº</li>
</ol>
<p>å¯¹äºç¬¬ä¸€ä¸ªæ¡ä»¶è€Œè¨€Tornadoæ²¡ä»€ä¹ˆï¼Œå°±æ˜¯ä¸»çº¿ç¨‹æ­£å¸¸æ“ä½œï¼Œç¬¬äºŒä¸ªæ¡ä»¶å°±åˆ©ç”¨äº†ä¸Šé¢è¯´çš„PeriodicCallbackï¼Œå°†æ£€æµ‹å‡½æ•°å®šæœŸæ‰§è¡Œå°±å¥½ã€‚ç¬¬ä¸‰ä¸ªæ¡ä»¶ä½¿ç”¨os.execvé‡è½½æ•´ä¸ªè¿›ç¨‹ã€‚bingo,æ²¡æœ‰å•ç‹¬çš„å¼€å¯çº¿ç¨‹ï¼Œå¼€å¯è¿›ç¨‹ã€‚å•çº¿ç¨‹å®Œæˆäº†è‡ªåŠ¨é‡å¯çš„æ“ä½œã€‚æœ€ç®€ä»£ç åº”è¯¥æ˜¯è¿™æ ·çš„<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> functools</div><div class="line"><span class="keyword">import</span> ioloop</div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> types</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(io_loop=None, check_time=<span class="number">500</span>)</span>:</span></div><div class="line">    io_loop = io_loop <span class="keyword">or</span> ioloop.IOLoop.instance()</div><div class="line">    modify_times = &#123;&#125;</div><div class="line">    callback = functools.partial(_reload_on_update, modify_times)</div><div class="line">    scheduler = ioloop.PeriodicCallback(callback, check_time, io_loop=io_loop)</div><div class="line">    scheduler.start()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_reload_on_update</span><span class="params">(modify_times)</span>:</span></div><div class="line">    <span class="keyword">for</span> module <span class="keyword">in</span> sys.modules.values():</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(module, types.ModuleType): <span class="keyword">continue</span></div><div class="line">        path = getattr(module, <span class="string">"__file__"</span>, <span class="keyword">None</span>)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> path: <span class="keyword">continue</span></div><div class="line">        <span class="keyword">if</span> path.endswith(<span class="string">".pyc"</span>) <span class="keyword">or</span> path.endswith(<span class="string">".pyo"</span>):</div><div class="line">            path = path[:<span class="number">-1</span>]</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            modified = os.stat(path).st_mtime</div><div class="line">        <span class="keyword">except</span>:</div><div class="line">            <span class="keyword">continue</span></div><div class="line">        <span class="keyword">if</span> path <span class="keyword">not</span> <span class="keyword">in</span> modify_times:</div><div class="line">            modify_times[path] = modified</div><div class="line">            <span class="keyword">continue</span></div><div class="line">        <span class="keyword">if</span> modify_times[path] != modified:</div><div class="line">            os.execv(sys.executable, [sys.executable] + sys.argv)</div></pre></td></tr></table></figure><br>ä½¿ç”¨sys.modulesæŸ¥çœ‹æ‰€æœ‰å·²åŠ è½½çš„æ¨¡å—ã€‚æ¯500æ¯«ç§’å°†æ–‡ä»¶æ”¹åŠ¨æ—¶é—´å’Œå·²æœ‰æ•°æ®è¿›è¡Œå¯¹æ¯”ã€‚å¦‚æœä¸åŒåˆ™æ‰§è¡Œos.execvè¦†ç›–æ‰å½“å‰è¿›ç¨‹ï¼Œåç»­è¯¥ä»£ç è™½ç„¶ä¸ºäº†è·¨å¹³å°é€»è¾‘ä¸Šæœ‰å˜åŠ¨ã€‚å¯æ˜¯æ•´ä½“æ€è·¯æ˜¯æ²¡æœ‰æ”¹å˜çš„</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æ€»ç»“è€Œè¨€IOLoopçš„é€»è¾‘è¿˜æ˜¯å¾ˆå¥½ç†è§£çš„ã€‚å®ƒå¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªç‹¬ç«‹æ€§éå¸¸å¼ºçš„æ¨¡å—ã€‚ä¸€ä¸ªå•ä¾‹ï¼Œæ•´ä½“æ˜¯ä¸€ä¸ªæ­»å¾ªç¯æä¾›ä¸‰ç§æƒ…å†µçš„å¤„ç†ã€‚åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¸æ–­çš„è°ƒç”¨å•ä¾‹çš„æˆå‘˜å‡½æ•°ï¼Œå®Œæˆå¯¹ä¸€ä¸ªäº‹åŠ¡(æ¯”å¦‚è·å¾—ä¸€ä¸ªç½‘é¡µçš„å†…å®¹)çš„å¤„ç†ã€‚è‡³äºä¸ºä»€ä¹ˆæ²¡æœ‰è¢«é˜»å¡ã€‚æ¯å½“è¦IOé˜»å¡çš„æ—¶å€™(æ¯”å¦‚connect)å°±æ³¨å†Œä¸€ä¸ªäº‹ä»¶å›è°ƒï¼Œç„¶åç»§ç»­è¿è¡Œä¸ä¼šé˜»å¡çš„éƒ¨åˆ†ã€‚ç­‰åˆ°äº‹ä»¶å®Œæˆå†è¿›è¡ŒIOæ“ä½œå°±ä¸ä¼šé˜»å¡äº†ã€‚ä»è€Œè¾¾åˆ°æ•´ä½“éé˜»å¡çš„æ•ˆæœ</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿™æ˜¯Tornadoç³»åˆ—çš„å¼€ç¯‡,Tornadoä½œä¸ºå¼‚æ­¥webæ¡†æ¶2010å¹´å‘å¸ƒ1.0ç‰ˆæœ¬ã€‚å¯ä»¥è¯´Pythonç¤¾åŒºæäº†è¿™ä¹ˆå¤šå¹´ï¼Œä¸ºäº†è·å¾—æ¯”å¤šçº¿ç¨‹å¤šè¿›ç¨‹æ›´é«˜çš„æ€§èƒ½ï¼Œç»å†äº†Twistedã€Tornadoã€yieldã€geventã€yield fromã€asyncioã€‚ä¹Ÿä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™æ‰æ˜¯ä¸€ä¸ªå°½å¤´~~ã€‚Tornadoè¿‡äº†è¿™ä¹ˆå¤šå¹´è¿˜ç®—å¼€å‘æ´»è·ƒ(&lt;a href=&quot;https://github.com/tornadoweb/tornado/graphs/contributors&quot;&gt;ä¸€ä¸ªå¤§ç¥æ‰›èµ·äº†ä¸€ç‰‡å¤©å•Š&lt;/a&gt;)ï¼Œä¸åŒäºå¤šçº¿ç¨‹æ¨¡å‹çš„ä¸€æ½­æ­»æ°´ï¼Œçœ‹å®ƒçš„ä»£ç ä½ ä¼šå‘ç°å®ƒè¿˜æ˜¯ç´§è·Ÿæ½®æµçš„ï¼Œè€Œä¸”æœ‰ä¸€ç‚¹ã€‚å®ƒçš„å†…éƒ¨è™½ç„¶ä¸€ç›´åœ¨å˜åŠ¨ï¼Œä½†æ˜¯æä¾›ç»™ç”¨æˆ·çš„ä½¿ç”¨æ¥å£æ˜¯å¾ˆç¨³å®šçš„ï¼Œåç»­å°±ä¼šå‘ç°è¿™ä¸ªå‘æœ‰å¤šå¤§&lt;/p&gt;
    
    </summary>
    
      <category term="Tornado" scheme="https://www.zoulei.net/categories/Tornado/"/>
    
    
  </entry>
  
  <entry>
    <title>Pythoné«˜çº§å¤šçº¿ç¨‹å¹¶å‘</title>
    <link href="https://www.zoulei.net/2018/03/12/python_concurrent_futures_thread/"/>
    <id>https://www.zoulei.net/2018/03/12/python_concurrent_futures_thread/</id>
    <published>2018-03-12T10:49:33.000Z</published>
    <updated>2018-03-12T11:27:47.101Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å¤šçº¿ç¨‹å¤šè¿›ç¨‹å½“é“çš„å¹´ä»£è¿™ä¸ªè¢«ç§°ä¸ºé«˜çº§å¹¶å‘çš„æ¨¡å—è¿˜æ˜¯å¾ˆä»¤äººæƒŠè‰³çš„ã€‚concurrent.futureæ¨¡å—çš„å‰å®³ä¹‹å¤„åœ¨äºå°è£…äº†å¤šçº¿ç¨‹ã€å¤šè¿›ç¨‹ã€é”ã€é˜Ÿåˆ—åˆ°ä¸€èµ·ã€‚è¿™äº›ç»†èŠ‚ä½¿ç”¨è€…éƒ½ä¸éœ€è¦çŸ¥é“ã€‚å››äº”è¡Œä»£ç èƒ½å®ç°ä»¥å¾€äºŒä¸‰åè¡Œå®ç°çš„æ•ˆæœã€‚è€Œä¸”å¤šçº¿ç¨‹å’Œå¤šè¿›ç¨‹çš„ä½¿ç”¨æ–¹å¼å®Œå…¨ä¸€æ ·ï¼Œå ªç§°å®Œç¾æ°ä½œã€‚å¯æƒœï¼Œç°åœ¨å·²ç»æ˜¯å¼‚æ­¥æ—¶ä»£äº†ï¼Œä¸»è¦æ˜¯å› ä¸ºtornadoç”¨åˆ°äº†å®ƒçš„Futureæ¨¡å—ã€‚æˆ‘å°±çœ‹çœ‹å®ƒå¤§æ¦‚æ˜¯æ€æ ·å®ç°çš„</p>
<a id="more"></a>
<p>æ¥è‡ªå®˜æ–¹æ–‡æ¡£çš„ç¤ºä¾‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> concurrent.futures</div><div class="line"><span class="keyword">import</span> urllib.request</div><div class="line"></div><div class="line">URLS = [<span class="string">'http://www.foxnews.com/'</span>,</div><div class="line">        <span class="string">'http://www.cnn.com/'</span>,</div><div class="line">        <span class="string">'http://europe.wsj.com/'</span>,</div><div class="line">        <span class="string">'http://www.bbc.co.uk/'</span>,</div><div class="line">        <span class="string">'http://some-made-up-domain.com/'</span>]</div><div class="line"></div><div class="line"><span class="comment"># Retrieve a single page and report the URL and contents</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_url</span><span class="params">(url, timeout)</span>:</span></div><div class="line">    <span class="keyword">with</span> urllib.request.urlopen(url, timeout=timeout) <span class="keyword">as</span> conn:</div><div class="line">        <span class="keyword">return</span> conn.read()</div><div class="line"></div><div class="line"><span class="comment"># We can use a with statement to ensure threads are cleaned up promptly</span></div><div class="line"><span class="keyword">with</span> concurrent.futures.ThreadPoolExecutor(max_workers=<span class="number">5</span>) <span class="keyword">as</span> executor:</div><div class="line">    <span class="comment"># Start the load operations and mark each future with its URL</span></div><div class="line">    future_to_url = &#123;executor.submit(load_url, url, <span class="number">60</span>): url <span class="keyword">for</span> url <span class="keyword">in</span> URLS&#125;</div><div class="line">    <span class="keyword">for</span> future <span class="keyword">in</span> concurrent.futures.as_completed(future_to_url):</div><div class="line">        url = future_to_url[future]</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            data = future.result()</div><div class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</div><div class="line">            print(<span class="string">'%r generated an exception: %s'</span> % (url, exc))</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            print(<span class="string">'%r page is %d bytes'</span> % (url, len(data)))</div></pre></td></tr></table></figure>
<p>é¦–å…ˆè€ƒè™‘ä¸€ä¸ªé—®é¢˜ã€‚åœ¨å¤šçº¿ç¨‹é‡Œé¢ï¼Œä¸€èˆ¬æˆ‘ä»¬ç›´æ¥<code>threading.Thread(target=)</code>,ä½†æ˜¯ç›´æ¥è¿è¡Œä¸ä¼šå¾—åˆ°è¿”å›çš„ç»“æœçš„ã€‚è¿™é‡Œå°±ç”¨åˆ°äº†<code>Future</code>å¯¹è±¡ã€‚ç±»ä¼¼ä¸è£…é¥°å™¨ï¼Œæœ€ç»ˆè¿è¡Œçš„å‡½æ•°è¢«åµŒå¥—ï¼Œç»“æœè¢«æ·»åŠ åˆ°<code>Future</code>å¯¹è±¡ä¸Šã€‚ä½ å¯ä»¥å°†<code>Future</code>å½“åšä¸€ä¸ªåŠå…¶ç®€å•çš„å¯¹è±¡ï¼Œå°±åƒä¸‹é¢è¿™æ ·<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Future</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.result = <span class="keyword">None</span></div><div class="line">        self._state = <span class="string">"PENDING"</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_result</span><span class="params">(self, value)</span>:</span></div><div class="line">        self._state = <span class="string">"FINISHED"</span></div><div class="line">        self.result = value</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_result</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.result</div></pre></td></tr></table></figure></p>
<p>å› æ­¤æœ€ç»ˆæœ€æ–°çš„å¹¶éæ˜¯åŸå§‹çš„å‡½æ•°ã€‚æ­¤å¤„è¢«å°è£…æˆäº†WorkItemå¯¹è±¡<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WorkerItem</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, future, fn, *args, **kwargs)</span>:</span></div><div class="line">        self.fn = fn</div><div class="line">        self.args = args</div><div class="line">        self.kwargs = kwargs</div><div class="line">        self.future = future</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            ret = self.fn(*self.args, **self.kwargs)</div><div class="line">            self.future.set_result(ret)</div><div class="line"></div><div class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">            self.future.set_result(e)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_worker</span><span class="params">(work_queue)</span>:</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">            work_item = work_queue.get(block=<span class="keyword">True</span>)</div><div class="line">            <span class="keyword">if</span> work_item <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">                work_item.run()</div><div class="line">    <span class="keyword">except</span> BaseException:</div><div class="line">        traceback.print_exc()</div></pre></td></tr></table></figure></p>
<p>å…¶æ¬¡å®ƒèƒ½å¤Ÿå…è®¸å¯¹åˆ›å»ºçš„çº¿ç¨‹æ•°é‡è¿›è¡Œæ§åˆ¶max_clientã€‚è¿™ä¸ªä¹Ÿå¯ä»¥æƒ³åˆ°é€šè¿‡é˜Ÿåˆ—æ¥æ§åˆ¶ï¼Œå½“submitåˆ›å»ºä»»åŠ¡çš„æ—¶å€™å¹¶ä¸æ˜¯ç›´æ¥è°ƒç”¨threading.Threadåˆ›å»ºä¸€ä¸ªå…¨æ–°çš„çº¿ç¨‹ã€‚è€Œæ˜¯ä»…ä»…æŠŠå®ƒåŠ å…¥åˆ°é˜Ÿåˆ—ï¼Œåˆ¤æ–­å½“å‰çº¿ç¨‹æ•°é‡æ˜¯å¦å°äºæœ€å¤§æ•°é‡ã€‚å½“ç„¶åœ¨çº¿ç¨‹ä¸­å°±æ˜¯ä¸æ–­å¾ªç¯æ‰§è¡ŒWorkã€‚<code>Future</code>ã€<code>WorkItem</code>ã€<code>_worker</code>éƒ½æ˜¯å½±è—æ²¡æœ‰å¯¹ç”¨æˆ·æš´éœ²ã€‚çœŸæ­£å¯¹ç”¨æˆ·æš´éœ²çš„åªæœ‰ä¸€ä¸ªThreadPoolExecutor,å¤§æ¦‚å¯ä»¥è¿™æ ·è®¤ä¸º</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolExecutor</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, max_workers)</span>:</span></div><div class="line">        self.max_workers = max_workers</div><div class="line">        self._queue = Queue()</div><div class="line">        self._thread = set()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">submit</span><span class="params">(self, fn, *args, **kwargs)</span>:</span></div><div class="line">        f = Future()</div><div class="line">        worker_item = WorkerItem(f, fn, *args, **kwargs)</div><div class="line">        self._queue.put(worker_item)</div><div class="line">        <span class="keyword">if</span> len(self._thread) &lt; self.max_workers:</div><div class="line">            t = Thread(target=_worker, args=(self._queue,))</div><div class="line">            t.daemon = <span class="keyword">True</span></div><div class="line">            t.start()</div><div class="line">        <span class="keyword">return</span> f</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> self._thread:</div><div class="line">            i.join()</div></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°æ¯æ¬¡submitåä¼šå¾—åˆ°ä¸€ä¸ª<code>Future</code>å¯¹è±¡ã€‚è®¾æƒ³ä¸€ä¸‹å½“çº¿ç¨‹æ‰§è¡Œå¾—åˆ°ç»“æœåæˆ‘ä»¬å¯ä»¥æ ¹æ®<code>Future</code>çš„çŠ¶æ€è½®è¯¢å¾—åˆ°æˆ‘ä»¬éœ€è¦çš„ç»“æœã€‚å¤§æ¦‚å¯ä»¥è¿™æ ·å†™<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">5</span>) <span class="keyword">as</span> executor:</div><div class="line">    future_to_url = &#123;executor.submit(load_url, url, <span class="number">1</span>): url <span class="keyword">for</span> url <span class="keyword">in</span> URLS&#125;</div><div class="line">    <span class="keyword">while</span> <span class="number">1</span>:</div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> future_to_url.copy().keys():</div><div class="line">            <span class="keyword">if</span> i._state == <span class="string">"FINISHED"</span>:</div><div class="line">                print(i.get_result())</div><div class="line">                future_to_url.pop(i)</div><div class="line">        <span class="keyword">if</span> len(future_to_url) == <span class="number">0</span>:</div><div class="line">            <span class="keyword">break</span></div></pre></td></tr></table></figure></p>
<p><span style="color:red"><strong>ä½†æ˜¯å¯èƒ½ä½œè€…è§‰å¾—è¿™ç§æ–¹å¼å¤ªlow,æ•ˆç‡å¤ªä½ã€‚å®ç°äº†ä¸€ä¸ªas_completedå‡½æ•°ï¼Œç›´æ¥è®©ç†è§£éš¾åº¦æå‡ä¸€ä¸ªæ•°é‡çº§ã€‚ã€‚ã€‚ã€‚</strong></span></p>
<p>å¤§æ¦‚å°±æ˜¯å…ˆç”Ÿæˆäº†ä¸€ä¸ªwaiterså¯¹è±¡(è¿™ä¸ªå¯¹è±¡æœ‰threading.Event)ï¼Œå¹¶å°†è¿™äº›å¯¹è±¡æ·»åŠ åˆ°æ‰€æœ‰çš„æœªå®Œæˆçš„Futuresä¸­ã€‚ä»»ä¸€å¯¹è±¡å®Œæˆåˆ™ä¼šè§¦å‘äº‹ä»¶çš„è®¾ç½®ã€‚è¿™æ ·é˜»å¡è¢«æš‚æ—¶å–æ¶ˆï¼Œå¯ä»¥å¾—åˆ°ç»“æœè¿”å›ï¼Œä»£ç æ³¨é‡Šå¦‚ä¸‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">as_completed</span><span class="params">(fs, timeout=None)</span>:</span></div><div class="line">    <span class="keyword">if</span> timeout <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">        end_time = timeout + time.time()</div><div class="line"></div><div class="line">    fs = set(fs)</div><div class="line">    <span class="keyword">with</span> _AcquireFutures(fs):</div><div class="line">        <span class="comment"># å…ˆæŒ‘é€‰å‡ºæ‰€æœ‰å·²ç»æœ‰ç»“æœçš„Future</span></div><div class="line">        finished = set(</div><div class="line">                f <span class="keyword">for</span> f <span class="keyword">in</span> fs</div><div class="line">                <span class="keyword">if</span> f._state <span class="keyword">in</span> [CANCELLED_AND_NOTIFIED, FINISHED])</div><div class="line">        pending = fs - finished</div><div class="line">        <span class="comment"># åˆ›å»ºäº†ä¸€ä¸ªwaiterå¯¹è±¡ã€‚è¯¥å¯¹è±¡ç”¨äºthreading.Eventã€‚ç„¶åå°†è‡ªèº«æ·»åŠ åˆ°äº†æ‰€æœ‰çš„Futuresä¸Šé¢</span></div><div class="line">        waiter = _create_and_install_waiters(fs, _AS_COMPLETED)</div><div class="line"></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="comment"># å…ˆä¾æ¬¡è¿”å›å·²å®Œæˆçš„Future</span></div><div class="line">        <span class="keyword">yield</span> <span class="keyword">from</span> finished</div><div class="line"></div><div class="line">        <span class="keyword">while</span> pending:</div><div class="line">            <span class="keyword">if</span> timeout <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">                wait_timeout = <span class="keyword">None</span></div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                wait_timeout = end_time - time.time()</div><div class="line">                <span class="keyword">if</span> wait_timeout &lt; <span class="number">0</span>:</div><div class="line">                    <span class="keyword">raise</span> TimeoutError(</div><div class="line">                            <span class="string">'%d (of %d) futures unfinished'</span> % (</div><div class="line">                            len(pending), len(fs)))</div><div class="line">            </div><div class="line">            <span class="comment"># å½“Futureè¢«è¿›è¡Œè®¾ç½®ç»“æœä¼šè§¦å‘threading.Event.set</span></div><div class="line">            <span class="comment"># é‚£ä¹ˆè¯¥å¤„çš„é˜»å¡å°±ä¼šè¢«å–æ¶ˆ</span></div><div class="line">            waiter.event.wait(wait_timeout)</div><div class="line"></div><div class="line">            <span class="keyword">with</span> waiter.lock:</div><div class="line">                <span class="comment"># åˆå¾—åˆ°ä¸€æ‰¹å·²å®Œæˆçš„Futures</span></div><div class="line">                finished = waiter.finished_futures</div><div class="line">                waiter.finished_futures = []</div><div class="line">                <span class="comment"># å–æ¶ˆçŠ¶æ€,ç­‰å¾…ä¸‹ä¸€æ¬¡çš„set</span></div><div class="line">                waiter.event.clear()</div><div class="line">            </div><div class="line">            <span class="comment"># ä¾æ¬¡è¿”å›å¹¶ä»pendingé˜Ÿåˆ—ä¸­ç§»å‡º</span></div><div class="line">            <span class="keyword">for</span> future <span class="keyword">in</span> finished:</div><div class="line">                <span class="keyword">yield</span> future</div><div class="line">                pending.remove(future)</div><div class="line"></div><div class="line">    <span class="keyword">finally</span>:</div><div class="line">        <span class="keyword">for</span> f <span class="keyword">in</span> fs:</div><div class="line">            <span class="keyword">with</span> f._condition:</div><div class="line">                f._waiters.remove(waiter)</div></pre></td></tr></table></figure></p>
<p>å¤šçº¿ç¨‹çš„æ–¹å¼ç›¸è¾ƒå¤šè¿›ç¨‹è¦ç®€å•å¾ˆå¤šã€‚å¤šè¿›ç¨‹çš„å®ç°æœ‰æœºä¼šå†å†™ç»­ç¯‡~~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨å¤šçº¿ç¨‹å¤šè¿›ç¨‹å½“é“çš„å¹´ä»£è¿™ä¸ªè¢«ç§°ä¸ºé«˜çº§å¹¶å‘çš„æ¨¡å—è¿˜æ˜¯å¾ˆä»¤äººæƒŠè‰³çš„ã€‚concurrent.futureæ¨¡å—çš„å‰å®³ä¹‹å¤„åœ¨äºå°è£…äº†å¤šçº¿ç¨‹ã€å¤šè¿›ç¨‹ã€é”ã€é˜Ÿåˆ—åˆ°ä¸€èµ·ã€‚è¿™äº›ç»†èŠ‚ä½¿ç”¨è€…éƒ½ä¸éœ€è¦çŸ¥é“ã€‚å››äº”è¡Œä»£ç èƒ½å®ç°ä»¥å¾€äºŒä¸‰åè¡Œå®ç°çš„æ•ˆæœã€‚è€Œä¸”å¤šçº¿ç¨‹å’Œå¤šè¿›ç¨‹çš„ä½¿ç”¨æ–¹å¼å®Œå…¨ä¸€æ ·ï¼Œå ªç§°å®Œç¾æ°ä½œã€‚å¯æƒœï¼Œç°åœ¨å·²ç»æ˜¯å¼‚æ­¥æ—¶ä»£äº†ï¼Œä¸»è¦æ˜¯å› ä¸ºtornadoç”¨åˆ°äº†å®ƒçš„Futureæ¨¡å—ã€‚æˆ‘å°±çœ‹çœ‹å®ƒå¤§æ¦‚æ˜¯æ€æ ·å®ç°çš„&lt;/p&gt;
    
    </summary>
    
      <category term="python" scheme="https://www.zoulei.net/categories/python/"/>
    
    
  </entry>
  
  <entry>
    <title>Pythonä¸­çš„å¤šçº¿ç¨‹é”</title>
    <link href="https://www.zoulei.net/2018/03/12/Python_Thread_Lock/"/>
    <id>https://www.zoulei.net/2018/03/12/Python_Thread_Lock/</id>
    <published>2018-03-12T06:16:13.000Z</published>
    <updated>2018-03-12T09:21:24.786Z</updated>
    
    <content type="html"><![CDATA[<p>å¤šçº¿ç¨‹æ˜¯ä¸ªå‘çˆ¹çš„è¯¾é¢˜ï¼Œæœ‰å¤šçº¿ç¨‹å°±æœ‰é”ã€‚Pythonä¸­æœ‰ä½çº§çº¿ç¨‹æ¨¡å—_threadã€å†å°è£…ä¸€ä¸‹å°±æ˜¯threadingã€å†æ¥ä¸€ä¸‹å°±æ˜¯<code>from concurrent.futures import ThreadPoolExecutor</code>ã€‚å…¶ä¸­æ¶‰åŠåˆ°çš„é”å¤§æ¦‚æœ‰Lockã€RLockã€Conditionã€Semaphoreã€BoundedSeamphoreã€Eventã€‚è¿™ä¹ˆå¤šçœ‹èµ·æ¥æ€ªå“äººçš„ï¼Œå…¶å®è¿™ä¹ˆå¤šçš„é”å…¨éƒ¨åªæ˜¯ç”±Lockæ¼”åŒ–å‡ºæ¥çš„</p>
<a id="more"></a>
<h3 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h3><p><code>Lock = _thread._allocate_lock</code> è¿™ä¸ªæ˜¯ç›´æ¥ç”±æœ€ä½çº§åˆ«çš„_threadç›´æ¥å¼•ç”¨è¿‡æ¥çš„ã€‚åˆ›å»ºé”çš„æ—¶å€™æ˜¯å¤„äºæœªè¢«é”å®šçš„çŠ¶æ€ã€‚è¿™åº”è¯¥æ˜¯æœ€å®¹æ˜“è¢«ç†è§£å’Œä½¿ç”¨çš„ä¸€ç§é”äº†ã€‚åˆšå­¦ä¹ çš„æ—¶å€™é“å®šå†™è¿‡ç±»ä¼¼ä¸‹é¢è¿™ç§ç¤ºä¾‹ã€‚æœ¬è´¨åŸå› æ˜¯pythonä¸­çš„åŸå­æ“ä½œæ˜¯é’ˆå¯¹å•æ¡æŒ‡ä»¤ã€‚è€Œa+=1è¢«ç¿»è¯‘æˆäº†å¤šæ¡æŒ‡ä»¤ã€‚æ‰§è¡Œè¿‡ç¨‹ä¸­ä»»ä½•æ—¶åˆ»å¯èƒ½è¢«æ‰“æ–­</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">a = <span class="number">0</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">global</span> a</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100000</span>):</div><div class="line">        a += <span class="number">1</span></div><div class="line"></div><div class="line">t = [threading.Thread(target=change) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>)]</div><div class="line">[i.start() <span class="keyword">for</span> i <span class="keyword">in</span> t]</div><div class="line">[i.join() <span class="keyword">for</span> i <span class="keyword">in</span> t]</div><div class="line">print(a)</div></pre></td></tr></table></figure>
<p>è§£å†³æ–¹æ³•å°±æ˜¯<span style="color:red"><strong>æ‰€æœ‰çº¿ç¨‹å…±äº«åŒä¸€ä¸ªé”ï¼Œè™½ç„¶é”æœ‰å¾ˆå¤šç§ï¼Œä½†æ˜¯å‡ ä¹éƒ½æ˜¯è¿™æ ·æš´éœ²ç»™ç”¨æˆ·ä½¿ç”¨çš„</strong></span>ï¼Œè¿™æ˜¯å¤§å®¶éƒ½çŸ¥é“çš„ã€‚ä¸€ä¸ªé”éƒ½å¥½ç†è§£ã€‚å¦‚æœæœ‰ä¸¤ä¸ªé”å°±ä¸æ˜¯é‚£ä¹ˆå¥½ç†è§£äº†ï¼Œæ¯”å¦‚è¿™ä¸ªæœ‰ç‚¹è£…é€¼çš„ä¾‹å­ã€‚äº¤å‰æ‰“å°Helloå’ŒWorld</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">lock_a = Lock()</div><div class="line">lock_b = Lock()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</div><div class="line">        lock_a.acquire()</div><div class="line">        time.sleep(<span class="number">0.1</span>)</div><div class="line">        print(<span class="string">"Hello"</span>)</div><div class="line">        lock_b.release()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">world</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</div><div class="line">        lock_b.acquire()</div><div class="line">        time.sleep(<span class="number">0.1</span>)</div><div class="line">        print(<span class="string">"World"</span>)</div><div class="line">        lock_a.release()</div><div class="line"></div><div class="line">Thread(target=hello).start()</div><div class="line">Thread(target=world).start()</div></pre></td></tr></table></figure>
<h3 id="RLock"><a href="#RLock" class="headerlink" title="RLock"></a>RLock</h3><p>å¯é‡å…¥é”å…è®¸çº¿ç¨‹è·å¾—é”ä¹‹åè¯¥çº¿ç¨‹å¯ä»¥æ— æ•°æ¬¡çš„å†æ¬¡è·å¾—é”ã€‚çœ‹èµ·æ¥æ²¡ä»€ä¹ˆç”¨ï¼Œå¤§æ¦‚ä¹Ÿç¡®å®æ²¡å•¥ç”¨å§ï¼Œä¸è¿‡è€ƒè™‘ä¸€ä¸‹ä¸‹é¢è¿™ç§åœºæ™¯<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Change</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.a = <span class="number">1</span></div><div class="line">        self.b = <span class="number">1</span></div><div class="line">        self.lock = RLock()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">adda</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> self.lock:</div><div class="line">            self.a += <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">addb</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> self.lock:</div><div class="line">            self.b += <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">addab</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> self.lock:</div><div class="line">            self.adda()</div><div class="line">            self.addb()</div></pre></td></tr></table></figure><br>ä½ æœ‰ä¸€ä¸ªç±»ã€‚å…¶ä¸­addaæ”¹å˜a,addbæ”¹å˜b.è¿˜æä¾›æ–¹æ³•addabåŒæ—¶è°ƒç”¨å‰ä¸¤è€…ã€‚å¦‚æœæ²¡æœ‰å¯é‡å…¥é”é‚£ä¹ˆä½ å°†ä¸å¾—ä¸æŠŠä¸¤ä¸ªå‡½æ•°ç²˜è´´åˆ°addabä¸‹é¢ã€‚å®ƒçš„å®ç°åŸç†æ˜¯è·å–é”çš„æ—¶å€™æ ¹æ®get_identå¾—åˆ°å½“å‰çº¿ç¨‹æ ‡è¯†ã€‚å¦‚æœå’Œå½“å‰é”çš„æ ‡è¯†ä¸€æ ·åˆ™ä»…ä»…æ˜¯ç»™å€¼åŠ 1ï¼Œå¦åˆ™å°±å°è¯•å»è·å–é”ã€‚ç®€è¦ä»£ç å¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Lock, get_ident</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RLock</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.lock = Lock()</div><div class="line">        self._owner = <span class="keyword">None</span></div><div class="line">        self._count = <span class="number">0</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">acquire</span><span class="params">(self)</span>:</span></div><div class="line">        me = get_ident()</div><div class="line">        <span class="keyword">if</span> self._owner == me:</div><div class="line">            self._count += <span class="number">1</span></div><div class="line">            <span class="keyword">return</span></div><div class="line">        rc = self.lock.acquire()</div><div class="line">        <span class="keyword">if</span> rc:</div><div class="line">            self._owner = me</div><div class="line">            self._count = <span class="number">1</span></div><div class="line"></div><div class="line">    __enter__ = acquire</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">release</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">if</span> self._owner != get_ident():</div><div class="line">            <span class="keyword">raise</span> RuntimeError()</div><div class="line">        self._count -= <span class="number">1</span></div><div class="line">        <span class="keyword">if</span> self._count == <span class="number">0</span>:</div><div class="line">            self._owner = <span class="keyword">None</span></div><div class="line">            self.lock.release()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></div><div class="line">        self.release()</div></pre></td></tr></table></figure>
<h2 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h2><p>è¢«ç§°ä¸ºæ¡ä»¶å˜é‡ï¼Œè¿™ä¸ªåº”è¯¥æ˜¯å¾ˆå°‘è¢«ä½¿ç”¨çš„ã€‚å®ƒå…è®¸ä¼ å…¥ä¸€ä¸ªé”ï¼Œå½“æ»¡è¶³æ¡ä»¶çš„æ—¶å€™è§¦å‘é€šçŸ¥(å¯ä»¥çœ‹ä¸€ä¸‹queueæ¨¡å—çš„å®ç°ï¼Œå½“getä¸åˆ°æ•°æ®çš„æ—¶å€™å°±æ‰§è¡Œwaitç­‰å¾…ï¼Œæ–°åŠ å…¥æ•°æ®çš„æ—¶å€™æ‰§è¡Œnotifyé€šçŸ¥å”¤é†’)ï¼Œè¿™åº”è¯¥æ˜¯å®ƒè¢«ç§°ä¸ºæ¡ä»¶å˜é‡çš„åŸå› (æ„Ÿè§‰éƒ½æœ‰ç‚¹ç‰µå¼ºğŸ˜•),å’ŒLockä»¥åŠRLockä¸åŒã€‚è¿™ä¸ªä¸œä¸œä¸»è¦æ˜¯ç”¨æ¥é€šçŸ¥å…¶ä»–çº¿ç¨‹çš„ã€‚å¤§æ¦‚æœ‰ä¸¤ä¸ªæ–¹æ³•wait(é˜»å¡ç›´åˆ°è¢«é€šçŸ¥)ï¼Œnotify(å”¤é†’wait)ã€‚<br>å®ç°çš„æ€è·¯æ˜¯æ‰€æœ‰çš„çº¿ç¨‹å…±äº«åŒä¸€ä¸ªé”Aï¼ŒåŒæ—¶æœ‰ä¸€ä¸ªå…±ç”¨çš„é”åˆ—è¡¨ã€‚æ¯å½“è°ƒç”¨waitçš„æ—¶å€™ç”Ÿæˆä¸€ä¸ªæ–°çš„é”æ”¾å…¥é”åˆ—è¡¨ï¼Œç„¶åè·å¾—è¯¥é”ï¼Œå†é‡Šæ”¾é”A(å› ä¸ºwaitå¿…é¡»åœ¨è·å¾—é”Aæ‰èƒ½è°ƒç”¨ï¼Œå¦‚æœä¸é‡Šæ”¾åˆ™å…¶ä»–çº¿ç¨‹æ— æ³•è·å¾—é”A)ã€‚æœ€ç»çš„æ¥äº†ï¼Œ<span style="color:red"><strong>å†æ¬¡è·å¾—æ–°ç”Ÿæˆçš„é”é€ æˆæ­»é”</strong></span>ã€‚ç”±æ­¤è¯¥çº¿ç¨‹è¢«æŒ‚èµ·ã€‚ç›´åˆ°å…¶ä»–è·å¾—é”Açš„çº¿ç¨‹æ‰§è¡Œnotifyæ“ä½œã€‚å°†waitçš„é”é‡Šæ”¾ã€‚<br>å®ç°ä»£ç å¦‚ä¸‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Condition</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self._lock = RLock()</div><div class="line">        self._waiters = deque()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self._lock.__enter__()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, *args)</span>:</span></div><div class="line">        <span class="keyword">return</span> self._lock.__exit__(*args)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">assert</span> get_ident() == self._lock._owner</div><div class="line">        waiter = Lock()</div><div class="line">        self._waiters.append(waiter)</div><div class="line"></div><div class="line">        waiter.acquire()</div><div class="line">        self._lock.release()</div><div class="line">        waiter.acquire()</div><div class="line">        self._lock.acquire()</div><div class="line">        <span class="keyword">del</span> waiter</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">notify</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">assert</span> get_ident() == self._lock._owner</div><div class="line">        <span class="keyword">for</span> waiter <span class="keyword">in</span> self._waiters.copy():</div><div class="line">            waiter.release()</div><div class="line">            self._waiters.remove(waiter)</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªä¸œä¸œå§å…¶å®ä¸å¤ªé€‚åˆè¢«ç›´æ¥ä½¿ç”¨ã€‚ä½†æ˜¯ç½‘ä¸Šè¿˜æ˜¯æœ‰äººç¡¬ç”Ÿç”Ÿå‡‘äº†ä¸€ä¸ªæ¶ˆè´¹è€…ç”Ÿäº§è€…çš„ä¾‹å­å‡ºæ¥åšæ¼”ç¤º<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> threading</div><div class="line"><span class="keyword">import</span> random</div><div class="line"><span class="keyword">import</span> time</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Producer</span><span class="params">(threading.Thread)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, integers, condition)</span>:</span></div><div class="line">        super(Producer, self).__init__()</div><div class="line">        self.integers = integers</div><div class="line">        self.condition = condition</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</div><div class="line">            integer = random.randint(<span class="number">0</span>, <span class="number">256</span>)</div><div class="line">            <span class="keyword">with</span> self.condition:</div><div class="line">                self.integers.append(integer)</div><div class="line">                self.condition.notify()</div><div class="line">                time.sleep(<span class="number">0.5</span>)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Consumer</span><span class="params">(threading.Thread)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, integers, condition)</span>:</span></div><div class="line">        super(Consumer, self).__init__()</div><div class="line">        self.integers = integers</div><div class="line">        self.condition = condition</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> self.condition:</div><div class="line">            <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">                <span class="keyword">while</span> self.integers:</div><div class="line">                    integer = self.integers.pop()</div><div class="line">                    print(integer)</div><div class="line">                self.condition.wait()</div><div class="line"></div><div class="line">integers = []</div><div class="line">condition = Condition()</div><div class="line">Producer(integers, condition).start()</div><div class="line">Consumer(integers, condition).start()</div></pre></td></tr></table></figure><br>è¿™ä¸ªä¾‹å­æœ‰ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ã€‚notifyå’Œwaitå¹¶ä¸æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚ä¸ä»£è¡¨æ‰§è¡Œäº†notifyï¼Œwaitéƒ¨åˆ†ä¸€å®šä¼šè¢«æ‰§è¡Œã€‚æ‰€ä»¥å¦‚æœæ¶ˆè´¹è€…éƒ¨åˆ†è¿™æ ·å†™ä¼šé€ æˆéƒ¨åˆ†æ²¡æœ‰è¢«å¤„ç†<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Consumer</span><span class="params">(threading.Thread)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, integers, condition)</span>:</span></div><div class="line">        super(Consumer, self).__init__()</div><div class="line">        self.integers = integers</div><div class="line">        self.condition = condition</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> self.condition:</div><div class="line">            <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">                self.condition.wait()</div><div class="line">                integer = self.integers.pop()</div><div class="line">                print(integer)</div></pre></td></tr></table></figure></p>
<h3 id="Semaphore-amp-BoundedSeamphore"><a href="#Semaphore-amp-BoundedSeamphore" class="headerlink" title="Semaphore &amp; BoundedSeamphore"></a>Semaphore &amp; BoundedSeamphore</h3><p>ä¸Šé¢å…ˆä»‹ç»Conditionæ˜¯æœ‰åŸå› çš„ï¼Œå› ä¸ºå¤šçº¿ç¨‹ä¿¡å·é‡å’Œäº‹ä»¶éƒ½æ˜¯åŸºäºå®ƒç”Ÿæˆçš„ã€‚ä¿¡å·é‡å¸¸ç”¨äºé™åˆ¶å¯¹æœ‰é™èµ„æºçš„è®¿é—®ã€‚æ¯”å¦‚ä½ æœ‰1000ä¸ªçº¿ç¨‹ï¼Œå¦‚æœæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½å»åˆ›å»ºæ•°æ®åº“è¿æ¥ï¼Œé‚£ä¹ˆæ•°æ®åº“å¯èƒ½ä¼šå´©ã€‚æˆ–è€…çˆ¬è™«åˆ›å»ºå¯¹ç½‘ç«™çš„è¿æ¥ï¼Œå¤ªè¿‡å‡¶æ®‹å¹¶ä¸å¥½ï¼Œè¿™ä¸ªæ—¶å€™ç”¨ä¿¡å·é‡æ¥å¤„ç†å°±ä¸é”™ã€‚</p>
<p>è¿™é‡Œå¦‚æœç›´æ¥ä½¿ç”¨Lockæ¥æ„å»ºã€‚é‚£ä¹ˆä¸€ä¸ªé”åŒæ—¶åªå…è®¸ä¸€ä¸ªçº¿ç¨‹æ¥è·å¾—æ˜¾ç„¶æ˜¯ä¸è¾¾ä¸åˆ°è¦æ±‚çš„ã€‚ç¥­å‡ºåˆšæ‰æ„å»ºçš„Condition<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Semaphore</span>:</span></div><div class="line">    <span class="comment"># valueå€¼ç”¨å®Œäº†å°±è¢«è°ƒç”¨wait.åªæœ‰notifyèƒ½è§£é™¤</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value=<span class="number">1</span>)</span>:</span></div><div class="line">        self._lock = Condition()</div><div class="line">        self.value = value</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> self._lock:</div><div class="line">            <span class="keyword">if</span> self.value == <span class="number">0</span>:</div><div class="line">                self._lock.wait()</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                self.value -= <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></div><div class="line">        self.value += <span class="number">1</span></div><div class="line">        self._lock.notify()</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BoundedSemaphore</span><span class="params">(Semaphore)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value=<span class="number">1</span>)</span>:</span></div><div class="line">        super(BoundedSemaphore, self).__init__(value=value)</div></pre></td></tr></table></figure></p>
<h3 id="Event"><a href="#Event" class="headerlink" title="Event"></a>Event</h3><p>Eventå’ŒConditionå·®ä¸å¤šã€‚åŒºåˆ«å°±æ˜¯ä¸Šé¢æåˆ°çš„ï¼Œä½¿ç”¨Conditionï¼Œå¦‚æœåœ¨å•çº¿ç¨‹ï¼Œé‚£ä¹ˆå½“notifyçš„æ—¶å€™æ˜¯æ— æ³•è§¦å‘waitçš„ï¼Œå†è°ƒç”¨waitçº¿ç¨‹ä¼šè¢«é˜»å¡ã€‚<span style="color:red"><strong>ä½†æ˜¯Eventå°±æ”¯æŒåœ¨å•çº¿ç¨‹ä½¿ç”¨ã€‚</strong></span>æä¾›ä¸¤ä¸ªä¸»è¦æ–¹æ³•ï¼Œsetå’Œwaitã€‚ä½†æ˜¯å®ƒå¹¶ä¸éœ€è¦å…ˆè·å¾—é”ã€‚ä½¿ç”¨å¥½åƒæ›´æ–¹ä¾¿ä¸€ç‚¹ï¼Œå®ç°å¦‚ä¸‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Event</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self._cond = Condition()</div><div class="line">        self._flag = <span class="keyword">False</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> self._cond:</div><div class="line">            self._flag = <span class="keyword">True</span></div><div class="line">            self._cond.notify()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clear</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> self._cond:</div><div class="line">            self._flag = <span class="keyword">False</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> self._cond:</div><div class="line">            signaled = self._flag</div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> signaled:</div><div class="line">                signaled = self._cond.wait()</div><div class="line">            <span class="keyword">return</span> signaled</div></pre></td></tr></table></figure></p>
<p>å¦‚æœæŠŠåˆšæ‰é‚£ä¸ªç”Ÿäº§è€…æ¶ˆè´¹è€…æ¢åˆ°å®ƒä¸Šé¢æ¥ï¼Œå¤§æ¦‚æ˜¯è¿™ä¸ªæ ·å­äº†<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> threading</div><div class="line"><span class="keyword">import</span> random</div><div class="line"><span class="keyword">import</span> time</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Producer</span><span class="params">(threading.Thread)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, integers, condition)</span>:</span></div><div class="line">        super(Producer, self).__init__()</div><div class="line">        self.integers = integers</div><div class="line">        self.condition = condition</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</div><div class="line">            integer = random.randint(<span class="number">0</span>, <span class="number">256</span>)</div><div class="line">            self.integers.append(integer)</div><div class="line">            self.condition.set()</div><div class="line">            time.sleep(<span class="number">0.5</span>)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Consumer</span><span class="params">(threading.Thread)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, integers, condition)</span>:</span></div><div class="line">        super(Consumer, self).__init__()</div><div class="line">        self.integers = integers</div><div class="line">        self.condition = condition</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">            <span class="keyword">while</span> self.integers:</div><div class="line">                integer = self.integers.pop()</div><div class="line">                print(integer)</div><div class="line">            self.condition.wait()</div><div class="line"></div><div class="line">integers = []</div><div class="line">condition = Event()</div><div class="line">Producer(integers, condition).start()</div><div class="line">Consumer(integers, condition).start()</div></pre></td></tr></table></figure><br>å½“ç„¶ï¼Œæ²¡å•¥å¿…è¦ç”¨è¿™äº›æ¯”è¾ƒä½çº§çš„ä¸œä¸œã€‚èƒ½ç”¨é€šç”¨é«˜çº§æ•°æ®ç»“æ„å°±ç›´æ¥ç”¨ï¼Œè¿™æ ·å¤§å®¶éƒ½æ¯”è¾ƒå¥½ç†è§£ï¼Œæ€»ç»“å°±æ˜¯åªæ˜¯ç»™å…±äº«èµ„æºåŠ é”ç”¨Lockã€é™åˆ¶èµ„æºè®¿é—®ä½¿ç”¨BoundedSeamphoreï¼Œå”¤é†’ç›¸å…³çº¿ç¨‹ä½¿ç”¨Event</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¤šçº¿ç¨‹æ˜¯ä¸ªå‘çˆ¹çš„è¯¾é¢˜ï¼Œæœ‰å¤šçº¿ç¨‹å°±æœ‰é”ã€‚Pythonä¸­æœ‰ä½çº§çº¿ç¨‹æ¨¡å—_threadã€å†å°è£…ä¸€ä¸‹å°±æ˜¯threadingã€å†æ¥ä¸€ä¸‹å°±æ˜¯&lt;code&gt;from concurrent.futures import ThreadPoolExecutor&lt;/code&gt;ã€‚å…¶ä¸­æ¶‰åŠåˆ°çš„é”å¤§æ¦‚æœ‰Lockã€RLockã€Conditionã€Semaphoreã€BoundedSeamphoreã€Eventã€‚è¿™ä¹ˆå¤šçœ‹èµ·æ¥æ€ªå“äººçš„ï¼Œå…¶å®è¿™ä¹ˆå¤šçš„é”å…¨éƒ¨åªæ˜¯ç”±Lockæ¼”åŒ–å‡ºæ¥çš„&lt;/p&gt;
    
    </summary>
    
      <category term="python" scheme="https://www.zoulei.net/categories/python/"/>
    
    
  </entry>
  
  <entry>
    <title>Linux ä¿¡å·</title>
    <link href="https://www.zoulei.net/2018/03/06/linux_signal/"/>
    <id>https://www.zoulei.net/2018/03/06/linux_signal/</id>
    <published>2018-03-06T04:29:40.000Z</published>
    <updated>2018-03-06T04:35:15.156Z</updated>
    
    <content type="html"><![CDATA[<p>ä¿¡å·æ˜¯è¿›ç¨‹é—´é€šä¿¡çš„ä¸€ç§æ–¹å¼,åŒæ—¶å®ƒæ˜¯ä¸€ç§å¼‚æ­¥çš„å½¢å¼ã€‚å…ˆæ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°ï¼Œå½“æ¥æ”¶åˆ°ä¿¡å·çš„æ—¶å€™å›è°ƒè¯¥å‡½æ•°è¿›ç¨‹å¤„ç†ã€‚ä¿¡å·åœ¨ç³»ç»Ÿä¸­ä»¥æ•°å­—çš„å½¢å¼æ ‡è¯†ã€‚æ¯ä¸ªä¿¡å·å¯¹åº”ç€ä¸€ä¸ªå¤„ç†å‡½æ•°</p>
<a id="more"></a>
<h3 id="ä¿¡å·è¡¨"><a href="#ä¿¡å·è¡¨" class="headerlink" title="ä¿¡å·è¡¨"></a>ä¿¡å·è¡¨</h3><p>æ¥ä¸ªpythonæ‰“å°æ”¯æŒçš„ä¿¡å·<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> signal</div><div class="line"></div><div class="line">signals_to_names = &#123;</div><div class="line">    getattr(signal, n): n</div><div class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> dir(signal)</div><div class="line">    <span class="keyword">if</span> n.startswith(<span class="string">'SIG'</span>) <span class="keyword">and</span> <span class="string">'_'</span> <span class="keyword">not</span> <span class="keyword">in</span> n</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> s, name <span class="keyword">in</span> sorted(signals_to_names.items()):</div><div class="line">    handler = signal.getsignal(s)</div><div class="line">    <span class="keyword">if</span> handler <span class="keyword">is</span> signal.SIG_DFL:</div><div class="line">        handler = <span class="string">'SIG_DFL'</span></div><div class="line">    <span class="keyword">elif</span> handler <span class="keyword">is</span> signal.SIG_IGN:</div><div class="line">        handler = <span class="string">'SIG_IGN'</span></div><div class="line">    print(<span class="string">'&#123;:&lt;10&#125; (&#123;:2d&#125;):'</span>.format(name, s), handler)</div></pre></td></tr></table></figure></p>
<p>å› ä¸ºå¹³æ—¶ç”¨çš„å°‘ï¼Œè€Œubuntuä¸Šçš„<code>man 7 signal</code>çš„å†…å®¹æ¯”è¾ƒå¤šï¼Œæˆ‘åªæ˜¯åœ¨osxä¸Šçœ‹äº†ä¸€ä¸‹singalçš„æ–‡æ¡£ã€‚å®ƒä»…åŒ…å«ä¸‹åˆ—ä¸€äº›ä¿¡å·</p>
<table>
<thead>
<tr>
<th>åºå·</th>
<th>åç§°</th>
<th>é»˜è®¤åŠ¨ä½œ</th>
<th>è§£é‡Š</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>SIGHUP</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>è®©ç¨‹åºæŒ‚èµ·</td>
</tr>
<tr>
<td>2</td>
<td>SIGINT</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>æ‰“æ–­ç¨‹åºçš„æ‰§è¡Œ</td>
</tr>
<tr>
<td>3</td>
<td>SIGQUIT</td>
<td>dump</td>
<td>ç¨‹åº</td>
</tr>
<tr>
<td>4</td>
<td>SIGILL</td>
<td>dump</td>
<td>éæ³•æŒ‡ä»¤</td>
</tr>
<tr>
<td>5</td>
<td>SIGTRAP</td>
<td>dump</td>
<td>é™·é˜±</td>
</tr>
<tr>
<td>6</td>
<td>SIGABRT</td>
<td>dump</td>
<td>æ‰“æ–­ç¨‹åº</td>
</tr>
<tr>
<td>7</td>
<td>SIGEMT</td>
<td>dump</td>
<td></td>
</tr>
<tr>
<td>8</td>
<td>SIGFPE</td>
<td>dump</td>
<td>æµ®ç‚¹æ•°å¼‚å¸¸</td>
</tr>
<tr>
<td>9</td>
<td>SIGKILL</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>æ€æ­»ç¨‹åº(ä¸å¯ä¿®æ”¹)</td>
</tr>
<tr>
<td>10</td>
<td>SIGBUS</td>
<td>dump</td>
<td>æ€»çº¿é”™è¯¯</td>
</tr>
<tr>
<td>11</td>
<td>SIGSEGV</td>
<td>dump</td>
<td>æ®µé”™è¯¯</td>
</tr>
<tr>
<td>12</td>
<td>SIGSYS</td>
<td>dump</td>
<td>è°ƒç”¨ä¸å­˜åœ¨çš„ç³»ç»Ÿè°ƒç”¨</td>
</tr>
<tr>
<td>13</td>
<td>SIGPIPE</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>ç»™ä¸€ä¸ªæ²¡æœ‰è¯»çš„ç®¡é“å†™æ•°æ®</td>
</tr>
<tr>
<td>14</td>
<td>SIGALRM</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>å®æ—¶è®¡æ—¶å™¨è¶…æ—¶</td>
</tr>
<tr>
<td>15</td>
<td>SIGTERM</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>è½¯ä¸­æ–­ä¿¡å·</td>
</tr>
<tr>
<td>16</td>
<td>SIGURG</td>
<td>å·²åºŸå¼ƒ</td>
<td></td>
</tr>
<tr>
<td>17</td>
<td>SIGSTOP</td>
<td>åœæ­¢è¿›ç¨‹</td>
<td>åœæ­¢(ä¸å¯ä¿®æ”¹)</td>
</tr>
<tr>
<td>18</td>
<td>SIGTSTP</td>
<td>åœæ­¢è¿›ç¨‹</td>
<td>ä»é”®ç›˜ç”Ÿæˆåœæ­¢ä¿¡å·</td>
</tr>
<tr>
<td>19</td>
<td>SIGCONT</td>
<td>åºŸå¼ƒ</td>
<td></td>
</tr>
<tr>
<td>20</td>
<td>SIGCHLD</td>
<td>åºŸå¼ƒ</td>
<td></td>
</tr>
<tr>
<td>21</td>
<td>SIGTTIN</td>
<td>åœæ­¢è¿›ç¨‹</td>
<td>åå°è¿›ç¨‹å°è¯•è¯»å–ç»ˆç«¯æ—¶è§¦å‘</td>
</tr>
<tr>
<td>22</td>
<td>SIGTOU</td>
<td>åœæ­¢è¿›ç¨‹</td>
<td>åå°è¿›ç¨‹å°è¯•å†™å…¥ç»ˆç«¯æ—¶è§¦å‘</td>
</tr>
<tr>
<td>23</td>
<td>SIGIO</td>
<td>åºŸå¼ƒ</td>
<td></td>
</tr>
<tr>
<td>24</td>
<td>SIGXCPU</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>è¿›ç¨‹çš„cpuæ—¶é—´ç‰‡åˆ°æœŸ(setrlimit)</td>
</tr>
<tr>
<td>25</td>
<td>SIGXFSZ</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶(setrlimit)</td>
</tr>
<tr>
<td>26</td>
<td>SIGVTLRM</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>è™šæ‹Ÿæ—¶é’Ÿè¶…æ—¶(setitimer)</td>
</tr>
<tr>
<td>27</td>
<td>SIGPROF</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>profilæ—¶é’Ÿè¶…æ—¶(setitimer)</td>
</tr>
<tr>
<td>28</td>
<td>SIGWINCH</td>
<td>åºŸå¼ƒ</td>
<td></td>
</tr>
<tr>
<td>29</td>
<td>SIGINFO</td>
<td>åºŸå¼ƒ</td>
<td></td>
</tr>
<tr>
<td>30</td>
<td>SIGUSR1</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>ç”¨æˆ·è‡ªå®šä¹‰ä¿¡å·1</td>
</tr>
<tr>
<td>31</td>
<td>SIGUSR2</td>
<td>ç»ˆæ­¢è¿›ç¨‹</td>
<td>ç”¨æˆ·è‡ªå®šä¹‰ä¿¡å·2</td>
</tr>
</tbody>
</table>
<h3 id="ä¿¡å·çš„äº§ç”Ÿ"><a href="#ä¿¡å·çš„äº§ç”Ÿ" class="headerlink" title="ä¿¡å·çš„äº§ç”Ÿ"></a>ä¿¡å·çš„äº§ç”Ÿ</h3><p>ä¿¡å·å¯ä»¥äº§ç”Ÿè‡ªè½¯ä»¶å’Œç¡¬ä»¶ï¼Œç¡¬ä»¶æ¥è¯´ï¼Œæˆ‘ä»¬æœ€å¸¸ç”¨çš„<code>Ctrl+C</code>æ¥ç»ˆæ­¢ä¸€ä¸ªç¨‹åºçš„æ‰§è¡Œï¼Œè½¯ä»¶å±‚é¢å°±æ˜¯ç»å¸¸ä½¿ç”¨<code>kill -9 pid</code>æ¥å¼ºåˆ¶ç»ˆæ­¢ä¸€ä¸ªç¨‹åºã€‚è§‚å¯Ÿä¸Šè¡¨å¯ä»¥å‘ç°è¿˜æœ‰å¾ˆå¤šç±»ä¼¼éæ³•æŒ‡ä»¤ã€é™·å…¥ã€æ®µé”™è¯¯ç­‰ç­‰éƒ½æ˜¯ç”±æ“ä½œç³»ç»Ÿè§¦å‘åé¦ˆç»™åº”ç”¨ç¨‹åºã€‚è¿˜æœ‰å°±æ˜¯æˆ‘ä»¬è‡ªå·±ç¼–å†™ç¨‹åºè¿›è¡Œç³»ç»Ÿè°ƒç”¨è§¦å‘ã€‚æ¯”å¦‚pythonä¸­å¸¸ç”¨çš„<code>signal.alarm</code></p>
<h3 id="ä¿¡å·çš„å¤„ç†"><a href="#ä¿¡å·çš„å¤„ç†" class="headerlink" title="ä¿¡å·çš„å¤„ç†"></a>ä¿¡å·çš„å¤„ç†</h3><p>è§‚å¯Ÿä¿¡å·è¡¨å¯ä»¥å‘ç°è™½ç„¶æœ‰31ä¸ªä¿¡å·ã€‚ä½†æ˜¯é»˜è®¤åŠ¨ä½œåªæœ‰ç»ˆæ­¢è¿›ç¨‹ã€dumpã€åœæ­¢è¿›ç¨‹ä¸‰ç§ã€‚è¿™ç®—æˆäº†å¤šå¯¹ä¸€çš„å…³ç³»ï¼Œå¤šä¸ªä¿¡å·å¯¹åº”ä¸€ä¸ªå¤„ç†ç»“æœã€‚æƒ³æƒ³è¿™å…¶å®æ˜¯ä¸€ç§äººä¸ºçš„çº¦å®šã€‚æ“ä½œç³»ç»Ÿé‡åˆ°ä¸€äº›å¼‚å¸¸çš„æ—¶å€™æœ¬å¯ä»¥ç›´æ¥å¡æ“¦æ‰è¿›ç¨‹ã€‚ä½†æ˜¯è¿˜æ˜¯å…ˆçŸ¥ä¼šä½ ä¸€å£°ï¼Œä¸‡ä¸€ç¨‹åºä½œè€…è§‰å¾—é‡åˆ°è¿™ç§æƒ…å†µè¿˜èƒ½å†æŠ¢æ•‘ä¸€ä¸‹é‚£å°±ä¸å¼‚å¸¸äº†ã€‚æ‰€ä»¥è§„å®šè¿™ä¹ˆå¤šä¿¡å·idã€‚è¿˜æ˜¯ä¸ºäº†æ–¹ä¾¿ç¼–ç¨‹çš„æ—¶å€™å¯¹ä¿¡å·è¿›è¡Œåˆ†ç±»å¤„ç†ã€‚è€Œä¸”ä¸ä»…ä»…çº¦å®šä¿—æˆã€‚åé¢è¿˜æœ‰ä¸¤ä¸ªè‡ªå®šä¹‰ä¿¡å·è®©ä½ è‡ªå·±è¿›è¡Œå®šä¹‰</p>
<p>ä¿¡å·å¤„ç†åŸºæœ¬æœ‰ä¸‰ç§å¥—è·¯ï¼Œé»˜è®¤ã€å¿½ç•¥ã€è‡ªå®šä¹‰ã€‚å¦‚æœä½ è§‰å¾—é‡åˆ°å¼‚å¸¸ä½ è¿˜å¯ä»¥å†æŠ¢æ•‘ä¸€ä¸‹é‚£å°±è‡ªå®šä¹‰æˆ–è€…å¿½ç•¥ã€‚ä½†æ˜¯å‡å¦‚å¿½ç•¥æ‰æ‰€æœ‰çš„ä¿¡å·ã€‚ç®¡ç†äººå‘˜å¯èƒ½å°±æ— æ³•é€€å‡ºä½ çš„ç¨‹åºäº†ã€‚<span style="color:red"><strong>å› æ­¤SIGKILLå’ŒSIGSTOPå¼ºåˆ¶ä¸å…è®¸è¢«å¿½ç•¥æˆ–è€…è‡ªå®šä¹‰</strong></span>ã€‚æ‰€ä»¥<code>kill -9</code>å°±æ˜¯ä¸€ä¸ªå¤§æ€å™¨</p>
<p>ä½†æ˜¯å¾ˆå¤šäººå¹¶ä¸è¢«æ¨èç”¨<code>kill -9</code>ï¼Œè€Œæ›´å¤šçš„äººæ¨èç”¨<code>kill -15</code>ã€‚åŸå› æ˜¯å¼ºåˆ¶è™½ç„¶å¼ºã€‚ä½†æ˜¯è¿™æ ·ç¼–ç¨‹äººå‘˜åˆ«æ— é€‰æ‹©ã€‚æœ‰çš„ç¨‹åºåœ¨æ„å¤–é€€å‡ºå‰éœ€è¦åšä¸€äº›æ¸…ç†å·¥ä½œï¼Œæ¯”å¦‚åˆ æ‰ä¸´æ—¶æ–‡ä»¶å•¥çš„ã€‚å½“ç„¶ï¼Œæ¸£æ°´å¹³çš„ä½œè€…æ€ä¹ˆå¯èƒ½ä¼šå»è‡ªå®šä¹‰å¤„ç†SIGTERMä¿¡å·â”‘(ï¿£Ğ” ï¿£)â”</p>
<h3 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h3><p>æ¯”å¦‚tornadoä¸­å¯ä»¥ä½¿ç”¨ä¿¡å·æœºåˆ¶è®°å½•å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼çš„æ ˆå¸§<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> tornado.httpserver</div><div class="line"><span class="keyword">import</span> tornado.ioloop</div><div class="line"><span class="keyword">import</span> tornado.web</div><div class="line"><span class="keyword">import</span> traceback</div><div class="line"><span class="keyword">import</span> time</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">record_block</span><span class="params">(_, frame)</span>:</span></div><div class="line">    a = traceback.format_stack(frame)</div><div class="line">    print(<span class="string">""</span>.join(a))</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></div><div class="line">        time.sleep(<span class="number">10</span>)</div><div class="line">        self.write(<span class="string">"Hello, world"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    application = tornado.web.Application([</div><div class="line">        (<span class="string">r"/"</span>, MainHandler),</div><div class="line">    ])</div><div class="line">    http_server = tornado.httpserver.HTTPServer(application)</div><div class="line">    http_server.listen(<span class="number">8888</span>)</div><div class="line">    ioloop = tornado.ioloop.IOLoop.current()</div><div class="line">    ioloop.set_blocking_signal_threshold(<span class="number">1</span>, record_block)</div><div class="line">    ioloop.start()</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    main()</div><div class="line"></div></pre></td></tr></table></figure></p>
<p>å…³äºå®ƒçš„å®ç°å°±æ¯”è¾ƒç®€å•äº†ã€‚å…ˆä½¿ç”¨<code>signal.signal(signal.SIGALRM,callback)</code>æ³¨å†Œä¿¡å·å›è°ƒå‡½æ•°ã€‚åœ¨ioloopä¸»å¾ªç¯ä¸­æ¯æ¬¡äº‹ä»¶å®Œæˆåå°†å®æ—¶è®¡æ—¶å™¨å½’é›¶<code>signal.setitimer(signal.ITIMER_REAL, 0, 0)</code>åå†é‡æ–°å¼€å§‹è®¡æ—¶ã€‚æ­¤å¤„ä¸ºä»€ä¹ˆä¸æ˜¯ç”¨alarmè€Œä½¿ç”¨setitimerã€‚å› ä¸ºå‰è€…åªæ”¯æŒæ•´æ•°ç§’ï¼Œåè€…æ”¯æŒæµ®ç‚¹æ•°</p>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p><a href="https://pymotw.com/3/signal/index.html">signal â€” Asynchronous System Events</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¿¡å·æ˜¯è¿›ç¨‹é—´é€šä¿¡çš„ä¸€ç§æ–¹å¼,åŒæ—¶å®ƒæ˜¯ä¸€ç§å¼‚æ­¥çš„å½¢å¼ã€‚å…ˆæ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°ï¼Œå½“æ¥æ”¶åˆ°ä¿¡å·çš„æ—¶å€™å›è°ƒè¯¥å‡½æ•°è¿›ç¨‹å¤„ç†ã€‚ä¿¡å·åœ¨ç³»ç»Ÿä¸­ä»¥æ•°å­—çš„å½¢å¼æ ‡è¯†ã€‚æ¯ä¸ªä¿¡å·å¯¹åº”ç€ä¸€ä¸ªå¤„ç†å‡½æ•°&lt;/p&gt;
    
    </summary>
    
      <category term="linux" scheme="https://www.zoulei.net/categories/linux/"/>
    
    
  </entry>
  
  <entry>
    <title>åˆ©ç”¨BKæ ‘ä¼˜åŒ–æ±‰æ˜è·ç¦»æŸ¥è¯¢</title>
    <link href="https://www.zoulei.net/2018/03/04/Postgresql_use_bktree_hamming/"/>
    <id>https://www.zoulei.net/2018/03/04/Postgresql_use_bktree_hamming/</id>
    <published>2018-03-04T02:45:47.000Z</published>
    <updated>2018-03-04T03:22:06.071Z</updated>
    
    <content type="html"><![CDATA[<p><a href="/2018/03/03/BKTree_VPTree/">ä¸Šä¸€ç¯‡</a> ä»‹ç»äº†BKæ ‘å’ŒVPæ ‘ï¼Œå¹¶è¯´æ˜ç”¨å®ƒå¯ä»¥ä¼˜åŒ–æ±‰æ˜è·ç¦»çš„æŸ¥è¯¢ã€‚ç”¨æ¥å¤„ç†é‡å¤å›¾ç‰‡çš„é—®é¢˜ã€‚æœ¬ç¯‡æˆ‘ä»¬åšå‡ºç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯100ä¸‡æ¡æ•°æ®ã€‚ç›¸å¯¹äºå…¨è¡¨éå†çš„31ç§’ä¸‹é™åˆ°54æ¯«ç§’ã€‚ä½¿ç”¨äº†æ­£ç¡®çš„ç´¢å¼•é€Ÿåº¦æå‡äº†äº”ç™¾å¤šå€</p>
<a id="more"></a>
<h3 id="è·å¾—å›¾ç‰‡çš„simhash"><a href="#è·å¾—å›¾ç‰‡çš„simhash" class="headerlink" title="è·å¾—å›¾ç‰‡çš„simhash"></a>è·å¾—å›¾ç‰‡çš„simhash</h3><p>æˆ‘ä»¬ç›´æ¥ä½¿ç”¨pythonçš„ç¬¬ä¸‰æ–¹åº“<a href="https://github.com/JohannesBuchner/imagehash">imagehash</a>ã€‚ä»£ç å¦‚ä¸‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</div><div class="line"><span class="keyword">import</span> imagehash</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_phash</span><span class="params">(file_path)</span>:</span></div><div class="line">    img = Image.open(file_path)</div><div class="line">    phash = imagehash.phash(img).hash.flatten()</div><div class="line">    phash_list = list(map(bool, phash))</div><div class="line"></div><div class="line">    <span class="keyword">return</span> sum((<span class="number">2</span> ** k) * v <span class="keyword">for</span> k, v <span class="keyword">in</span> enumerate(phash_list[<span class="number">1</span>:][::<span class="number">-1</span>]))</div></pre></td></tr></table></figure></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ã€‚é»˜è®¤å¾—åˆ°çš„phashæ˜¯ä¸€ä¸ªç»è¿‡hexç¼–ç çš„å­—ç¬¦ä¸²ã€‚è¿™æ ·ä¼šå¾ˆé•¿ï¼Œè€Œ<span style="color:red"><strong>æˆ‘ä»¬éœ€è¦ä¿å­˜åˆ°æ•°æ®åº“çš„æ•°æ®æ˜¯ä¸€ä¸ªbigintç±»å‹ã€‚å› æ­¤æˆ‘ä»¬ç›´æ¥è·å¾—64ä½çš„np.arrayï¼Œ</strong></span>å°†å®ƒè½¬æ¢æˆæ•°å­—ã€‚å› ä¸ºint64ä¸­ç¬¬ä¸€ä½æ˜¯ç¬¦å·ä½ã€‚å63ä½æ˜¯è¡¥ç ã€‚å¦‚æœç›´æ¥å°†64ä½éƒ½è½¬æˆæ­£æ•´æ•°ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šä¿å­˜å‡ºé”™ã€‚ä»æœ€æ–¹ä¾¿çš„è§’åº¦æ¥è¯´æˆ‘ä»¬å¯ä»¥å»æ‰ç¬¬ä¸€ä½(å®é™…ä¸Šæˆ‘æµ‹è¯•äº†å¥½å¤šä¸ªã€‚å‘ç°ç¬¬ä¸€ä½åŸºæœ¬éƒ½æ˜¯1)ã€‚è¿™æ ·è½¬æ¢å¾—åˆ°çš„æ•°å­—å°±èƒ½ç›´æ¥å­˜å‚¨åˆ°æ•°æ®åº“äº†ã€‚</p>
<p>å¦‚æœçœŸçš„è¦æ¨¡æ‹Ÿè½¬æ¢æˆbigintçš„æ•ˆæœã€‚å¯ä»¥çœ‹æˆ‘å†™çš„<a href="https://gist.github.com/ficapy/e7012d193c5ea85110a404c006ed7273">è¿™ä¸ª</a></p>
<h3 id="æ•°æ®åº“ä¼˜åŒ–"><a href="#æ•°æ®åº“ä¼˜åŒ–" class="headerlink" title="æ•°æ®åº“ä¼˜åŒ–"></a>æ•°æ®åº“ä¼˜åŒ–</h3><ul>
<li>æ¥ä¸ªç¤ºä¾‹</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">--  åˆ›å»ºè¡¨</span></div><div class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> int8tmp_2</div><div class="line">(</div><div class="line">	a <span class="built_in">bigint</span></div><div class="line">);</div><div class="line"></div><div class="line"><span class="comment">-- å†™å…¥ä¸€ç™¾ä¸‡æ¡æ•°æ®</span></div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> int8tmp_2 <span class="keyword">SELECT</span> val</div><div class="line">                      <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="keyword">sqrt</span>(random()) :: <span class="built_in">NUMERIC</span> * <span class="number">9223372036854775807</span> * <span class="number">2</span> -</div><div class="line">                                   <span class="number">9223372036854775807</span> :: <span class="built_in">NUMERIC</span> <span class="keyword">AS</span> val</div><div class="line">                            <span class="keyword">FROM</span> generate_series(<span class="number">1</span>, <span class="number">1000000</span>)) t;</div><div class="line"><span class="comment">-- åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢å‡½æ•°</span></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> <span class="keyword">bit_count</span>(<span class="keyword">value</span> <span class="built_in">BIGINT</span>)</div><div class="line">  <span class="keyword">RETURNS</span> <span class="built_in">NUMERIC</span></div><div class="line"><span class="keyword">AS</span> $$ <span class="keyword">SELECT</span> <span class="keyword">SUM</span>((<span class="keyword">value</span> &gt;&gt; <span class="built_in">bit</span>) &amp; <span class="number">1</span>)</div><div class="line">      <span class="keyword">FROM</span> generate_series(<span class="number">0</span>, <span class="number">63</span>) <span class="built_in">bit</span> $$</div><div class="line"><span class="keyword">LANGUAGE</span> <span class="keyword">SQL</span> IMMUTABLE <span class="keyword">STRICT</span>;</div><div class="line"></div><div class="line"><span class="comment">-- æŸ¥è¯¢</span></div><div class="line"><span class="keyword">SELECT</span></div><div class="line">  a,</div><div class="line">  <span class="keyword">bit_count</span>(a # <span class="number">8192711222023195111</span>) <span class="keyword">AS</span> hd</div><div class="line"><span class="keyword">FROM</span> int8tmp_2</div><div class="line"><span class="keyword">WHERE</span> <span class="keyword">bit_count</span>(a # <span class="number">8192711222023195111</span>) &lt; <span class="number">4</span></div><div class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> hd;    </div><div class="line"></div><div class="line"><span class="comment">-- ç»“æœå¤§æ¦‚è¿™æ ·</span></div><div class="line"><span class="comment">-- [2018-03-04 11:06:56] 1 row retrieved starting from 1 in 25s 403ms (execution: 25s 383ms, fetching: 20ms)</span></div></pre></td></tr></table></figure>
<ul>
<li>ä½¿ç”¨BKæ ‘åˆ›å»ºç´¢å¼•</li>
</ul>
<p>æˆ‘é€‰æ‹©äº†è¿™ä¸ªæ‰©å±•<a href="https://github.com/fake-name/pg-spgist_hamming">fake-name/pg-spgist_hamming</a>. å®‰è£…çš„å¥—è·¯æ˜¯è¿™æ ·çš„(åªæ”¯æŒPG9.6ä»¥ä¸Šç‰ˆæœ¬)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">git clone .......</div><div class="line">cd bktree</div><div class="line">USE_PGXS=1 make</div><div class="line">USE_PGXS=1 make install</div></pre></td></tr></table></figure>
<p><span style="color:red"><strong>æ³¨æ„è¿™ä¸ªåº“åŒæ—¶æä¾›äº†bktreeå’Œvptree,ä½†æ˜¯æˆ‘æ²¡ææ‡‚vptree,vptreeçš„è¡¨ç°å¾ˆå¥‡æ€ª,å¦å¤–ä¸èƒ½åŒæ—¶ä½¿ç”¨bktreeå’Œvptreeã€‚å› ä¸ºå®ƒä»¬æœ‰ä¸€äº›é‡è½½çš„æ“ä½œç¬¦é‡å¤äº†</strong></span></p>
<ul>
<li>ä½¿ç”¨æµç¨‹</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- å¯ç”¨æ‰©å±•</span></div><div class="line"><span class="keyword">CREATE</span> EXTENSION bktree;</div><div class="line"><span class="comment">-- åˆ›å»º</span></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> int8idx_2 <span class="keyword">ON</span> int8tmp_2 <span class="keyword">USING</span> spgist ( a bktree_ops );</div><div class="line"><span class="comment">-- æŸ¥è¯¢( &lt;-&gt; è¿ç®—ç¬¦è¡¨ç¤ºè®¡ç®—æ±‰æ˜è·ç¦», &lt;@()è¡¨ç¤ºç¬¦åˆæ±‰æ˜è·ç¦»å°äºN)</span></div><div class="line"><span class="keyword">SELECT</span></div><div class="line">  a,</div><div class="line">  a &lt;-&gt; <span class="number">8192711222023195111</span> <span class="keyword">AS</span> hd</div><div class="line"><span class="keyword">FROM</span> int8tmp_2</div><div class="line"><span class="keyword">WHERE</span> a &lt;@ (<span class="number">8192711222023195111</span>, <span class="number">4</span>)</div><div class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> hd;</div><div class="line"><span class="comment">-- ç»“æœå¤§æ¦‚æ˜¯è¿™æ ·çš„</span></div><div class="line">[2018-03-04 11:18:25] 1 row retrieved starting from 1 in 44ms (execution: 31ms, fetching: 13ms)</div></pre></td></tr></table></figure>
<p>ä¸–ç•ŒçœŸç¾å¦™â”‘(ï¿£Ğ” ï¿£)â”</p>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p><a href="https://github.com/digoal/blog/blob/master/201708/20170804_01.md">æµ·é‡æ•°æ®,æµ·æ˜(simhash)è·ç¦»é«˜æ•ˆæ£€ç´¢(smlar) - é˜¿é‡Œäº‘RDS PosgreSQLæœ€ä½³å®è·µ</a><br><a href="https://stackoverflow.com/questions/46280722/bit-count-function-in-postgresql">bit_count function in PostgreSQL</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;/2018/03/03/BKTree_VPTree/&quot;&gt;ä¸Šä¸€ç¯‡&lt;/a&gt; ä»‹ç»äº†BKæ ‘å’ŒVPæ ‘ï¼Œå¹¶è¯´æ˜ç”¨å®ƒå¯ä»¥ä¼˜åŒ–æ±‰æ˜è·ç¦»çš„æŸ¥è¯¢ã€‚ç”¨æ¥å¤„ç†é‡å¤å›¾ç‰‡çš„é—®é¢˜ã€‚æœ¬ç¯‡æˆ‘ä»¬åšå‡ºç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯100ä¸‡æ¡æ•°æ®ã€‚ç›¸å¯¹äºå…¨è¡¨éå†çš„31ç§’ä¸‹é™åˆ°54æ¯«ç§’ã€‚ä½¿ç”¨äº†æ­£ç¡®çš„ç´¢å¼•é€Ÿåº¦æå‡äº†äº”ç™¾å¤šå€&lt;/p&gt;
    
    </summary>
    
      <category term="database" scheme="https://www.zoulei.net/categories/database/"/>
    
    
  </entry>
  
  <entry>
    <title>BKæ ‘å’ŒVPæ ‘</title>
    <link href="https://www.zoulei.net/2018/03/03/BKTree_VPTree/"/>
    <id>https://www.zoulei.net/2018/03/03/BKTree_VPTree/</id>
    <published>2018-03-03T09:17:02.000Z</published>
    <updated>2018-03-04T02:18:38.874Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘æœ‰ä¸€ä¸ªé¡¹ç›®éœ€è¦ç”¨åˆ°simhash.è·å–å›¾ç‰‡çš„hashå€¼å¹¶ä¿å­˜åˆ°æ•°æ®åº“ã€‚åœ¨ç”Ÿæˆæ–°çš„hashçš„æ—¶å€™å’Œæ•°æ®åº“è¿›è¡Œæ¯”å¯¹ã€‚è¾¾åˆ°å»é‡çš„æ•ˆæœã€‚å‡å¦‚å›¾ç‰‡è¾¾åˆ°äº†ä¸€å®šæ•°é‡çº§ï¼Œé‚£ä¹ˆæ¯æ¬¡æŸ¥è¯¢ä¼šè¿›è¡Œå…¨è¡¨æ‰«æï¼Œæ•ˆç‡æ˜¯æ¯”è¾ƒä½ä¸‹çš„ï¼Œè€Œæ•°æ®åº“é»˜è®¤çš„ä¸€äº›ç´¢å¼•åˆæ— æ³•è¾¾åˆ°è¿™ä¸ªéœ€æ±‚ï¼Œåæ¥çœ‹åˆ°äº†BKæ ‘ã€‚è®°å½•ä¸€ä¸‹</p>
<a id="more"></a>
<p>ä½¿ç”¨Pythonçš„åº“<a href="https://github.com/JohannesBuchner/imagehash">imageHash</a> è¿ç®—åä¼šå¾—åˆ°64bité•¿åº¦çš„ç»“æœ(æœ€åä½¿ç”¨äº†hexç¼–ç å¯¼è‡´ç»“æœçœ‹èµ·æ¥å¾ˆé•¿)ã€‚å¦‚æœä¸¤å¼ å›¾ç‰‡çš„bitè¿›è¡Œå¼‚æˆ–åä¸åŒçš„åœ°æ–¹è¶Šå°ã€‚è¯´æ˜ä¸¤å¼ å›¾ç‰‡è¶Šç›¸ä¼¼ã€‚åº¦é‡è¿™2ä¸ªbitä¸ç›¸ä¼¼ç¨‹åº¦è¢«ç§°ä¹‹ä¸ºæ±‰æ˜è·ç¦»</p>
<p>è¿™ä¸ªè·ç¦»å®ƒåˆæ»¡è¶³ä»¥ä¸‹æ€§è´¨(è¢«ç§°ä¸ºLevenshtein)</p>
<ol>
<li>d(x, y) = 0 å½“ä¸”ä»…å½“ x=y  ï¼ˆLevenshteinè·ç¦»ä¸º0 &lt;==&gt; å­—ç¬¦ä¸²ç›¸ç­‰ï¼‰</li>
<li>d(x, y) = d(y, x)     ï¼ˆä»xå˜åˆ°yçš„æœ€å°‘æ­¥æ•°å°±æ˜¯ä»yå˜åˆ°xçš„æœ€å°‘æ­¥æ•°ï¼‰</li>
<li>d(x, y) + d(y, z) &gt;= d(x, z)  ï¼ˆä»xå˜åˆ°zæ‰€éœ€çš„æ­¥æ•°ä¸ä¼šè¶…è¿‡xå…ˆå˜æˆyå†å˜æˆzçš„æ­¥æ•°ï¼‰</li>
</ol>
<h3 id="BKæ ‘"><a href="#BKæ ‘" class="headerlink" title="BKæ ‘"></a>BKæ ‘</h3><p>ä¸ºäº†åŠ é€ŸæŸ¥æ‰¾, æ„å»ºäº†è¿™æ ·ä¸€ç§æ ‘ç»“æ„ã€‚</p>
<ol>
<li>ä»»é€‰ä¸€ä¸ªèŠ‚ç‚¹å½“åšæ ¹èŠ‚ç‚¹</li>
<li>æ’å…¥èŠ‚ç‚¹çš„æ—¶å€™å’Œæ ¹èŠ‚ç‚¹å¯¹æ¯”å¾—åˆ°è·ç¦»ã€‚å¦‚æœè¯¥è·ç¦»ä¸å­˜åœ¨åˆ™æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹ä½œä¸ºæ ¹èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ã€‚å¦‚æœèŠ‚ç‚¹å­˜åœ¨åˆ™è·å¾—èŠ‚ç‚¹ä½œä¸ºæ ¹èŠ‚ç‚¹è¿›è¡Œé€’å½’æ“ä½œ</li>
</ol>
<p>ç¬¬äºŒæ­¥çš„æ„ä¹‰åœ¨äº<strong>ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹ä¸‹é¢çš„å…ƒç´ å¯¹äºè¯¥èŠ‚ç‚¹çš„è·ç¦»éƒ½æ˜¯ç›¸ç­‰çš„</strong>ã€‚æ„å»ºå°±è¾¾åˆ°äº†è¿™ä¸ªæ•ˆæœã€‚åˆ«çš„å•¥äº‹æ²¡åšã€‚</p>
<p>æŸ¥æ‰¾è¿‡ç¨‹ã€‚æŸ¥æ‰¾çš„åŸç†ä¸»è¦ä¾é ç¬¬ä¸‰æ¡æ€§è´¨<code>d(x, y) + d(y, z) &gt;= d(x, z)</code>.<br>å‡è®¾æˆ‘ä»¬æœ‰è¿™æ ·ä¸€ä¸ªæŸ¥è¯¢è¦æ±‚ã€‚éœ€è¦æŸ¥æ‰¾å­—ç¬¦ä¸²targetè·ç¦»ä¸å¤§äºnçš„æ‰€æœ‰ç»“æœã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">è®¾rootä¸ºx, targetä¸ºy</div><div class="line">d(root, target) + d(target, element) &gt;= d(root, element)</div><div class="line">d(target, element)çš„å–å€¼èŒƒå›´æ˜¯[0, n]</div><div class="line">å¾—åˆ°d(root, element) çš„æœ€å¤§å€¼æ˜¯ n + d(root, target)</div></pre></td></tr></table></figure></p>
<p><strong>å› æ­¤æˆ‘ä»¬æ ¹æ®è¿™ä¸ªä¸ç­‰å¼å®ç°äº†å‰ªæçš„æ•ˆæœ</strong>ã€‚å¯¹äºæ»¡è¶³æ¡ä»¶çš„å…ƒç´ ã€‚å°†å…¶è®¾ç½®ä¸ºæ ¹å…ƒç´ ã€‚é€’å½’å¾—åˆ°æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„å…ƒç´ </p>
<h3 id="VPæ ‘"><a href="#VPæ ‘" class="headerlink" title="VPæ ‘"></a>VPæ ‘</h3><p>VPæ ‘å’ŒBKæ ‘åŸç†å·®ä¸å¤šã€‚ä¼˜ç‚¹æ˜¯å½“éœ€è¦æŸ¥è¯¢çš„è·ç¦»Næ›´å¤§çš„æ—¶å€™æ•ˆç‡æ›´é«˜(å…·ä½“åŸç†æˆ‘è¿˜ä¸å¤ªäº†è§£ã€‚å†™çš„æ—¶å€™å‘ç°å¾ˆå¤šæ—¶å€™å®ƒçš„æ•ˆç‡ç”šè‡³æ˜¯ä¸åŠBKæ ‘çš„)ã€‚</p>
<p>BKæ ‘å¯ä»¥çœ‹å‡ºæ˜¯ä¸€ä¸ªå¤šå‰æ ‘ã€‚æ¯ä¸ªèŠ‚ç‚¹ä¸‹é¢å¯ä»¥æœ‰å¤šä¸ªèŠ‚ç‚¹ã€‚VPæ ‘ä¸åŒï¼Œå®ƒæ˜¯ä¸€ä¸ªäºŒå‰æ ‘ã€‚æ ¹æ®æˆ‘çš„éœ€æ±‚ã€‚ç®€å•èµ·è§ã€‚æ¯ä¸€ä¸ªèŠ‚ç‚¹æˆ‘è®¾ç½®äº†ç›¸åŒçš„é˜ˆå€¼ã€‚è·ç¦»å°äºé˜ˆå€¼åˆ™æ”¾åœ¨å·¦è¾¹ï¼Œå¤§äºåˆ™æ”¾åœ¨å³è¾¹ã€‚</p>
<p>æŸ¥æ‰¾çš„æ—¶å€™è¿˜æŒºå°´å°¬çš„ã€‚æ ¹æ®ä¸Šé¢è¯´çš„<code>d(root, element) &lt;= n + d(root, target)</code>ã€‚å½“èŠ‚ç‚¹çš„é˜ˆå€¼å°äºè¿™ä¸ªå€¼çš„æ—¶å€™å·¦å³å­èŠ‚ç‚¹éƒ½éœ€è¦éå†ã€‚å½“èŠ‚ç‚¹é˜ˆå€¼å¤§äºçš„æ—¶å€™å°±åªéœ€è¦éå†å·¦è¾¹(è¾¾åˆ°å‰ªæçš„æ•ˆæœ)</p>
<p>æ³¨æ„:  ä»¥ä¸Šæˆ‘éƒ½åªè€ƒè™‘äº†æ·»åŠ ï¼Œæ²¡æœ‰è€ƒè™‘ä¿®æ”¹å’Œåˆ é™¤çš„äº‹æƒ…ã€‚</p>
<p>Pythonç‰ˆæœ¬ä»£ç å®ç°å¦‚ä¸‹</p>
<script src="//gist.github.com/ficapy/ed909648b184bc2fc1486ce90175d356.js?file=bk_tree.py"></script>
<script src="//gist.github.com/ficapy/ed909648b184bc2fc1486ce90175d356.js?file=vp_tree.py"></script>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p><a href="http://www.matrix67.com/blog/archives/333">ç¼–è¾‘è·ç¦»ã€æ‹¼å†™æ£€æŸ¥ä¸åº¦é‡ç©ºé—´ï¼šä¸€ä¸ªæœ‰è¶£çš„æ•°æ®ç»“æ„</a><br><a href="https://fribbels.github.io/vptree/writeup">VP Tree</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘æœ‰ä¸€ä¸ªé¡¹ç›®éœ€è¦ç”¨åˆ°simhash.è·å–å›¾ç‰‡çš„hashå€¼å¹¶ä¿å­˜åˆ°æ•°æ®åº“ã€‚åœ¨ç”Ÿæˆæ–°çš„hashçš„æ—¶å€™å’Œæ•°æ®åº“è¿›è¡Œæ¯”å¯¹ã€‚è¾¾åˆ°å»é‡çš„æ•ˆæœã€‚å‡å¦‚å›¾ç‰‡è¾¾åˆ°äº†ä¸€å®šæ•°é‡çº§ï¼Œé‚£ä¹ˆæ¯æ¬¡æŸ¥è¯¢ä¼šè¿›è¡Œå…¨è¡¨æ‰«æï¼Œæ•ˆç‡æ˜¯æ¯”è¾ƒä½ä¸‹çš„ï¼Œè€Œæ•°æ®åº“é»˜è®¤çš„ä¸€äº›ç´¢å¼•åˆæ— æ³•è¾¾åˆ°è¿™ä¸ªéœ€æ±‚ï¼Œåæ¥çœ‹åˆ°äº†BKæ ‘ã€‚è®°å½•ä¸€ä¸‹&lt;/p&gt;
    
    </summary>
    
      <category term="database" scheme="https://www.zoulei.net/categories/database/"/>
    
    
  </entry>
  
  <entry>
    <title>å¼€å§‹GitLab CI/CD</title>
    <link href="https://www.zoulei.net/2017/12/25/GitLabCICD_quickstart/"/>
    <id>https://www.zoulei.net/2017/12/25/GitLabCICD_quickstart/</id>
    <published>2017-12-25T12:38:35.000Z</published>
    <updated>2017-12-26T01:34:46.618Z</updated>
    
    <content type="html"><![CDATA[<h3 id="GitLabCI-CDæµç¨‹"><a href="#GitLabCI-CDæµç¨‹" class="headerlink" title="GitLabCI/CDæµç¨‹"></a>GitLabCI/CDæµç¨‹</h3><p>gitlabå¦‚æœæ²¡æœ‰å’ŒDockerå¾ˆå¥½çš„ç»“åˆã€‚é‚£ä¹ˆå®ƒä¼šæ˜¯ä¸€ä¸ªå¾ˆå¹³å‡¡çš„äº§å“ã€‚ä½†æ˜¯æœ‰äº†CIå¯¹æ¯”å…¶ä»–äº§å“Gogsã€githubç­‰å®ƒè¿˜ç®—å¯å ªä¸€ç”¨ã€‚ä¸Šä¸€ç¯‡æ–‡ç« å†™äº†gitlab_ci.ymlé…ç½®æ–‡ä»¶çš„ä¸€äº›å‚æ•°çš„å«ä¹‰ã€‚æœ¬ç¯‡æ–‡ç« è®°å½•ä¸€ä¸‹å¦‚ä½•ä»é›¶åœ¨Gitlabä¸Šå®Œæˆç®€å•çš„CI/CDæµç¨‹ã€‚åŸºç¡€æµç¨‹å¦‚ä¸‹Buildæµç¨‹æ„å»ºæˆ‘ä»¬éœ€è¦çš„é•œåƒä¸Šä¼ åˆ°é•œåƒä»“åº“ã€‚éƒ¨ç½²çš„æ—¶å€™ä»é•œåƒä»“åº“ç›´æ¥æ‹‰å–é‡å¯å®¹å™¨<br><img src="https://ficapy.b0.upaiyun.com/blogimg/GitlabCI.jpg" alt="GitlabCI"><br><a id="more"></a></p>
<h3 id="1-å®‰è£…Docker"><a href="#1-å®‰è£…Docker" class="headerlink" title="1. å®‰è£…Docker"></a>1. å®‰è£…Docker</h3><p>è¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„ã€‚æ— è„‘aptå°±å¥½äº†ã€‚å®‰è£…å®Œæ¯•åéœ€è¦å°†æœ¬åœ°ç”¨æˆ·åŠ å…¥åˆ°Dockerç”¨æˆ·ç»„ã€‚æ–¹ä¾¿å‘½ä»¤çš„æ‰§è¡Œã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹éœ€è¦æ³¨æ„çš„æ˜¯æœ€å¥½ä¿®æ”¹å®ƒçš„é»˜è®¤é…ç½®ï¼Œ/etc/docker/daemon.json</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;data-root&quot;: &quot;/data/docker&quot;,</div><div class="line">    &quot;registry-mirrors&quot;: [&quot;https://xxx.mirror.aliyuncs.com&quot;],</div><div class="line">    &quot;log-opts&quot;: &#123;</div><div class="line">        &quot;max-size&quot;: &quot;50m&quot;,</div><div class="line">        &quot;max-file&quot;: &quot;3&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>ç°åœ¨äº‘ä¸»æœºéƒ½æ˜¯ä½å®¹é‡ç³»ç»Ÿç›˜å¤–åŠ é«˜å®¹é‡æŒ‚è½½ç›˜ç»„æˆã€‚ä¿®æ”¹ä¸€ä¸‹é»˜è®¤çš„æ ¹ç›®å½•ä¼šæ¯”è¾ƒå¥½</li>
<li>æ²¡ä¸ªé•œåƒæºä¸‹è½½dockerhubé•œåƒä¸æ˜æ™ºå•Š</li>
<li>é™å®šä¸€ä¸‹æœ€å¤§æ—¥å¿—é‡æ€»æ²¡é”™ã€‚å¦åˆ™æ—¶é—´å¤ªé•¿æ—¥å¿—å¤šäº†ä¹Ÿå¾ˆçƒ¦äºº</li>
</ol>
<h2 id="2-æ­å»ºDockeré•œåƒä»“åº“"><a href="#2-æ­å»ºDockeré•œåƒä»“åº“" class="headerlink" title="2. æ­å»ºDockeré•œåƒä»“åº“"></a>2. æ­å»ºDockeré•œåƒä»“åº“</h2><p>æˆ‘ä½¿ç”¨çš„æ˜¯Vmwareå‡ºå“çš„<a href="https://github.com/vmware/harbor">Harbor</a>ã€‚å®‰è£…ä¸­é‡åˆ°äº†ä»¥ä¸‹å‡ ä¸ªå‘</p>
<ol>
<li>æŒ‰ç…§æ–‡æ¡£ä»æºç å®‰è£…å¤±è´¥ã€‚ç›´æ¥ä¸‹è½½å…«ç™¾å¤šå…†çš„ç¦»çº¿å®‰è£…åŒ…å®‰è£…å¥½æ­¹ç®—æ˜¯æˆåŠŸäº†</li>
<li>æˆ‘å°†HTTPSæ”¾åˆ°è´Ÿè½½å‡è¡¡ä¸Šé¢ã€‚å®é™…è¯·æ±‚åˆ°åç«¯çš„æ˜¯httpåè®®ã€‚æ‰€ä»¥æˆ‘å°†é…ç½®ä¿®æ”¹ä¸ºhttpã€‚ä½†æ˜¯ç™»é™†å¤±è´¥ã€‚æŸ¥äº†ä¸‹å°†common/config/registry/config.ymlçš„tokenç”±httpæ”¹æˆhttpså¯ä»¥ç™»é™†äº†ã€‚è§£å†³äº†è¿™ä¸ªç„¶åè¿˜ä¸èƒ½pushâ€¦æ²¡åŠæ³•ã€‚æˆ‘å°†è´Ÿè½½å‡è¡¡æ”¹æˆTCPç«¯å£è½¬å‘ã€‚ç›´æ¥å°†è¯ä¹¦æ”¾åœ¨harborä¸Šã€‚å¯ç®—æ˜¯æ²¡æ¯›ç—…äº†</li>
<li>ä»¥å‰é…ç½®è¿‡ä¸€æ¬¡Harborã€‚å¯¼è‡´äº†å†å²é—ç•™æ–‡ä»¶ã€‚å†æ¬¡å®‰è£…ç»“æœå¹¶ä¸ä¼šè¦†ç›–æ‰ä»¥å‰çš„é…ç½®ä¹Ÿä¸ä¼šåšä»»ä½•æç¤ºã€‚</li>
<li>é…ç½®æ–‡ä»¶é‡Œé¢æˆ‘æ”¹äº†ä¸€ä¸‹secretkey_pathåœ°å€ã€‚ç»“æœæ— æ³•ä½¿ç”¨ï¼Œæ— å¥ˆåˆæ”¹å›æ¥äº†</li>
</ol>
<p>æ€»ç»“ã€‚åœ¨Harborä½œä¸ºå®£ç§°çš„ä¼ä¸šçº§Dockeré•œåƒå·¥å…·ã€‚æ€æ‰‹çº§åŠŸèƒ½æ˜¯å¼‚åœ°å¤åˆ¶ï¼Œé•œåƒéªŒè¯ã€‚å®‰å…¨æ‰«æå•¥çš„ã€‚å¦‚æœåªæ˜¯è¦æä¸ªåŸºç¡€çš„é•œåƒä»“åº“ã€‚æœ€åæƒ³äº†æƒ³è¿˜ä¸å¦‚æŠ˜è…¾Gitlabçš„Dockerä»“åº“ã€‚è¯´ä¸å®šåœ¨æƒé™ä¸Šå’ŒGitlabç»“åˆçš„æ›´å¥½</p>
<h2 id="3-æ³¨å†ŒGitlab-runner"><a href="#3-æ³¨å†ŒGitlab-runner" class="headerlink" title="3. æ³¨å†ŒGitlab-runner"></a>3. æ³¨å†ŒGitlab-runner</h2><p>è¿™åº”è¯¥ç®—æ˜¯CIå¼ºå¤§çš„åœ°æ–¹äº†ã€‚å®ƒå’ŒGitlabæœ¬èº«æ¾è€¦åˆã€‚å®¢æˆ·ç«¯å»ºç«‹é•¿è¿æ¥å’ŒGitlabæœåŠ¡å™¨ä¿æŒé€šä¿¡ã€‚å½“æ»¡è¶³æ¡ä»¶çš„æ—¶å€™ç”±Gitlabå¯¹Runnerè¿›è¡Œè°ƒåº¦ã€‚Gitlab-runneræ˜¯ä½¿ç”¨Goç¼–å†™çš„ï¼Œä¾¿äºéƒ¨ç½²ã€‚å½“Runneræ¥æ”¶åˆ°è¯·æ±‚çš„æ—¶å€™å®ƒä¼šæ‰§è¡Œshellè„šæœ¬ã€‚æƒ³è±¡ä¸€ä¸‹pythonç•Œçš„fabricã€‚ä¾æ¬¡æ‰§è¡ŒBashå‘½ä»¤ã€‚Runnerä¹Ÿæ˜¯å·®ä¸å¤šçš„å¥—è·¯ã€‚å¤šæ¡Bashå‘½ä»¤é—´æ˜¯æ²¡æœ‰ç›¸å…³æ€§çš„ã€‚æ¯”å¦‚ä½ ä¸Šä¸€æ¡æ‰§è¡Œ<code>cd demo</code>ä¸‹ä¸€æ¡<code>pwd</code>å¾—åˆ°çš„è¿˜æ˜¯æœ¬åœ°ç”¨æˆ·ç›®å½•ï¼Œå¹¶ä¸æ˜¯demoã€‚</p>
<ol>
<li>å¯åŠ¨gitlab-runner Service</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">docker run -d --name gitlab-runner --restart always \</div><div class="line">  -v /var/gitlab-runner/config:/etc/gitlab-runner \</div><div class="line">  -v /var/run/docker.sock:/var/run/docker.sock \</div><div class="line">  gitlab/gitlab-runner:latest</div></pre></td></tr></table></figure>
<p>é¡ºä¾¿è¯´ä¸€ä¸‹ã€‚è¦æ˜¯æ‰§è¡Œgitlab-runnerçœ‹å®ƒçš„å‘½ä»¤è¡Œå‚æ•°è¿˜æŒºå¤šã€‚å…¶å®æ˜¯è‡ªèº«è®¾è®¡çš„ä¸å¤ªå¥½ã€‚æ˜¾å¾—å¥½åƒå¾ˆå¤æ‚ï¼Œå¾ˆå¤šå‘½ä»¤éœ€è¦è¢«<a href="https://docs.gitlab.com/runner/commands/README.html#service-related-commands">åºŸå¼ƒäº†</a>.å®ƒçš„ä½¿ç”¨å…¶å®è¿˜æ˜¯å¾ˆç®€å•çš„ã€‚å¦‚æœä½ éœ€è¦çœ‹å¸®åŠ©ã€‚é‚£ä¹ˆæ‰§è¡Œ<code>gitlab-runner register -h</code>è¿˜æœ‰ç‚¹ç”¨</p>
<ol>
<li>æ·»åŠ Runner</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">docker exec -it gitlab-runner gitlab-runner register -n --tag-list &quot;name&quot; \</div><div class="line">    -r &quot;token&quot; --name &quot;BigBrother&quot; -u https://gitlab.company.com \</div><div class="line">    --executor &quot;docker&quot; --docker-image &quot;default_image&quot; \</div><div class="line">    --docker-volumes /var/run/docker.sock:/var/run/docker.sock</div></pre></td></tr></table></figure>
<ul>
<li>n è¡¨ç¤ºéäº¤äº’æ¨¡å¼</li>
<li>tag-listè¡¨ç¤ºè¯¥Runnerçš„æ ‡ç­¾(å•ç‹¬çš„é¡¹ç›®ç”¨å•ç‹¬çš„tagä¹ŸæŒºå¥½ã€‚äº’ä¸å¹²æ‰°)</li>
<li>r è¯¥é¡¹ç›®çš„token</li>
<li>name åç§°æ ‡è¯†</li>
<li>u Gitlabåœ°å€</li>
<li>executor å’Œä¸Šé¢è¯´çš„æ‰§è¡Œbashå‘½ä»¤ã€‚æœ‰å¤šç§æ–¹å¼ã€‚æ— è„‘ç”¨dockeræŒºå¥½</li>
<li>docker-image executoré€‰æ‹©äº†dockerä¹‹å,éœ€è¦é€‰æ‹©é»˜è®¤çš„é•œåƒ</li>
<li>docker-volumes è¿™ä¸ªæ˜¯ä¸ºäº†åœ¨dockeré‡Œé¢<a href="https://docs.gitlab.com/ce/ci/docker/using_docker_build.html">ä½¿ç”¨Dockeræ„å»ºé•œåƒ</a></li>
</ul>
<p>ä»¥ä¸Šä¸¤æ­¥å®Œæˆåå°±èƒ½å¤Ÿåœ¨Gitlabåå°çœ‹åˆ°æ­£å¸¸çŠ¶æ€çš„Runneräº†</p>
<h3 id="4-ç¼–å†™-gitlab-ci-ymlæ–‡ä»¶"><a href="#4-ç¼–å†™-gitlab-ci-ymlæ–‡ä»¶" class="headerlink" title="4. ç¼–å†™.gitlab-ci.ymlæ–‡ä»¶"></a>4. ç¼–å†™.gitlab-ci.ymlæ–‡ä»¶</h3><p>å¦‚æœä½ æœ‰ä¸°å¯Œçš„Dockerä½¿ç”¨ç»éªŒï¼Œè¿™ä¸€æ­¥å®é™…ä¸Šæ²¡æœ‰å¤ªå¤§çš„é—®é¢˜ã€‚æœ¬ä¾‹ä¸­æˆ‘åªæ˜¯é€šè¿‡docker buildæ„å»ºäº†é•œåƒã€‚ç„¶åä¸Šä¼ åˆ°ä»“åº“ã€‚éœ€è¦éƒ¨ç½²çš„æ—¶å€™ä½¿ç”¨SSHè¿æ¥åˆ°è¿œç¨‹æœºå™¨ä¸Šä½¿ç”¨<code>docker-compose up --build -d</code>æ›´æ–°ç¨‹åº<br>Demoé¡¹ç›®ç›®å½•å¦‚ä¸‹ã€‚æ­£å¸¸æœ¬åœ°å¯åŠ¨æ‰§è¡Œpython main.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">.</div><div class="line">â”œâ”€â”€ README.md</div><div class="line">â”œâ”€â”€ conf.py</div><div class="line">â”œâ”€â”€ deploy</div><div class="line">â”‚Â Â  â”œâ”€â”€ Dockerfile</div><div class="line">â”‚Â Â  â”œâ”€â”€ prod_env</div><div class="line">â”‚Â Â  â”œâ”€â”€ docker-compose.yml</div><div class="line">â”‚Â Â  â””â”€â”€ stage_env</div><div class="line">â”œâ”€â”€ main.py</div><div class="line">â”œâ”€â”€ .gitlab-ci.yml</div><div class="line">â””â”€â”€ requirements.txt</div></pre></td></tr></table></figure>
<p>Dockerfileå¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">FROM ficapy/python35_alpine</div><div class="line"></div><div class="line">RUN mkdir /app</div><div class="line">WORKDIR /app</div><div class="line">ENV PYTHONPATH=/app</div><div class="line"></div><div class="line">COPY ./requirements.txt /app/requirements.txt</div><div class="line">RUN pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple</div><div class="line"></div><div class="line">COPY . /app</div><div class="line"></div><div class="line">CMD [&quot;python&quot;, &quot;main.py&quot;]</div></pre></td></tr></table></figure>
<p>docker-compose.ymlå¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">version: &apos;3&apos;</div><div class="line"></div><div class="line">services:</div><div class="line">  Name:</div><div class="line">    image: registry.company.com/repos/projectname:$&#123;TAG&#125;</div><div class="line">    restart: always</div><div class="line">    env_file:</div><div class="line">      - $&#123;ENV&#125;_env</div></pre></td></tr></table></figure>
<p>.gitlab-ci.ymlå¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">image: ficapy/docker:latest</div><div class="line"></div><div class="line">variables:</div><div class="line">  SSH: &quot;Host xxxxx&quot;</div><div class="line"></div><div class="line">stages:</div><div class="line">  - build</div><div class="line">  - deploy</div><div class="line"></div><div class="line">build:</div><div class="line">  stage: build</div><div class="line">  only:</div><div class="line">    - master</div><div class="line">  tags:</div><div class="line">    - tag</div><div class="line">  script:</div><div class="line">      - export DOCKER_TAG=$(env TZ=&apos;Asia/Shanghai&apos; date -d @$(git log -n1 $CI_COMMIT_SHA --format=&quot;%at&quot;) +%Y_%m_%d_%H%M%S)</div><div class="line">      - echo $DOCKER_TAG</div><div class="line">      - docker login -u deploy -p $DOCKER_PWD registry.company.com</div><div class="line">      - docker build -t registry.company.com/repos/must_lower_case:$DOCKER_TAG -f deploy/Dockerfile .</div><div class="line">      - docker push registry.company.com/repos/must_lower_case:$DOCKER_TAG</div><div class="line"></div><div class="line">prod_deploy:</div><div class="line">  stage: deploy</div><div class="line">  only:</div><div class="line">    - master</div><div class="line">  tags:</div><div class="line">    - tag</div><div class="line">  when: manual</div><div class="line">  variables:</div><div class="line">    SERVER: ssh_name</div><div class="line">  before_script:</div><div class="line">    - export DOCKER_TAG=$(env TZ=&apos;Asia/Shanghai&apos; date -d @$(git log -n1 $CI_COMMIT_SHA --format=&quot;%at&quot;) +%Y_%m_%d_%H%M%S)</div><div class="line">    - echo $DOCKER_TAG</div><div class="line">    - eval $(ssh-agent -s)</div><div class="line">    - bash -c &quot;ssh-add &lt;(echo &apos;$SSH_PRIVATE_KEY&apos;)&quot;</div><div class="line">    - mkdir -p ~/.ssh</div><div class="line">    - &apos;[[ -f /.dockerenv ]] &amp;&amp; echo -e &quot;$SSH&quot; &gt; ~/.ssh/config&apos;</div><div class="line">  script:</div><div class="line">    - ssh $SERVER &quot;mkdir -p ~/$CI_PROJECT_NAME || true&quot;</div><div class="line">    - rsync -r deploy $SERVER:~/$CI_PROJECT_NAME</div><div class="line">    - ssh $SERVER &quot;docker login -u deploy -p $DOCKER_PWD registry.company.com&quot;</div><div class="line">    - ssh $SERVER &quot;cd $CI_PROJECT_NAME/deploy &amp;&amp; TAG=$DOCKER_TAG ENV=prod docker-compose up --build -d&quot;</div><div class="line">  environment:</div><div class="line">    name: PROD</div></pre></td></tr></table></figure>
<p>æ•´ä¸ªè¿‡ç¨‹çœ‹é…ç½®æ–‡ä»¶åº”è¯¥è¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“ç†è§£çš„ã€‚å¦‚æœæœ‰äº›å‚æ•°ä¸å¤ªæ˜ç™½è¯·æŸ¥çœ‹å‰ä¸€ç¯‡gitlabci ymlç¬”è®°ã€‚å› ä¸ºå®ƒåªæ˜¯ä¸ªDemoã€‚æ‰€ä»¥æˆ‘è®©ä»–åœ¨æ¯æ¬¡masteråˆ†æ”¯æäº¤çš„æ—¶å€™éƒ½è¿›è¡Œè§¦å‘ã€‚æ•´ä¸ªéƒ¨ç½²æµç¨‹å®é™…ä¸Šå°±æ˜¯ä½¿ç”¨äº†SSHè¿œç¨‹è¿æ¥ä¹‹åæ“ä½œdocker-composeè¿›è¡Œæ›´æ–°ã€‚è¿‡ç¨‹ä¸­æ„Ÿè§‰è®©æˆ‘æ¯”è¾ƒéš¾ä»¥å†³æ–­çš„æ˜¯å¦‚ä½•æä¸€ä¸ªå¥½çš„TAGæ–¹æ³•</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å®Œæˆä¸Šè¿°è¿‡ç¨‹ä¹‹åæˆ‘åšä¸€ä¸ªè‡ªæˆ‘æ€»ç»“ã€‚æ‰€è°“CI/CDä¸è¿‡æ˜¯å°†æˆ‘ä»¬æ‡’å¾—è¾“å…¥çš„å‘½ä»¤ç»„åˆå½¢æˆæ–‡ä»¶ã€‚è®©å®ƒä¾æ¬¡æ‰§è¡ŒTest-&gt;Build-&gt;Deployã€‚è¯¥æ–¹æ¡ˆå‡ ä¹ä½¿ç”¨äº†å…¨å¥—Docker.ä»gitlab-runnerã€buildåˆ°é•œåƒä»“åº“åˆ°ç”Ÿäº§ç¯å¢ƒçš„éƒ¨ç½²ã€‚åœ¨é¡¹ç›®æ¯”è¾ƒå¤šçš„æ—¶å€™å®ƒæ˜¯æœ‰å¥½å¤„çš„ã€‚æ¯”å¦‚æœ‰åä¸ªé¡¹ç›®éœ€è¦æ›´æ–°ã€‚æ¯ä¸ªé¡¹ç›®éœ€è¦æ›´æ–°åˆ°å¤šä¸ªç¯å¢ƒä¸‹ã€‚é‚£ä¹ˆä½¿ç”¨è¿™ç§è‡ªåŠ¨åŒ–è¿˜æ˜¯æœ‰ä¼˜åŠ¿çš„ã€‚å¦‚æœå°±ä¸€ä¸¤ä¸ªé¡¹ç›®ï¼Œè€Œä¸”åªéœ€è¦æ›´æ–°åˆ°æµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒã€‚ä¸ªäººè§‰å¾—fabricå°±å¤Ÿäº†ã€‚è€Œä¸”è¯¥æ–¹æ¡ˆæœ‰ä¸€ä¸ªç¼ºç‚¹å°±æ˜¯éƒ¨ç½²é€Ÿåº¦è¾ƒæ…¢ã€‚Gitlabæ¯æ¬¡æ‰§è¡Œä»»åŠ¡é€Ÿåº¦å¹¶ä¸æ˜¯æƒ³è±¡çš„é‚£ä¹ˆå¿«ã€‚æœ€åç”Ÿæˆé•œåƒï¼Œä¸Šä¼ ï¼Œå†æ‹‰å–åˆ°æ­£å¼ç¯å¢ƒã€‚å¦‚æœé•œåƒè¿‡å¤§å°±æ›´æ…¢äº†ã€‚è€Œå¦‚æœä¸ä½¿ç”¨Dockeré•œåƒçš„æ–¹å¼ã€‚ç›´æ¥git pullæ‹‰å–æºç ã€‚å†supervisorctlæ›´æ–°ç¨‹åºã€‚æ—¶é—´åŸºæœ¬æ˜¯ç§’çº§çš„ã€‚åœ¨é¢‘ç¹æ›´æ–°çš„æµ‹è¯•ç¯å¢ƒå®ƒå¯èƒ½æ›´é«˜æ•ˆã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;GitLabCI-CDæµç¨‹&quot;&gt;&lt;a href=&quot;#GitLabCI-CDæµç¨‹&quot; class=&quot;headerlink&quot; title=&quot;GitLabCI/CDæµç¨‹&quot;&gt;&lt;/a&gt;GitLabCI/CDæµç¨‹&lt;/h3&gt;&lt;p&gt;gitlabå¦‚æœæ²¡æœ‰å’ŒDockerå¾ˆå¥½çš„ç»“åˆã€‚é‚£ä¹ˆå®ƒä¼šæ˜¯ä¸€ä¸ªå¾ˆå¹³å‡¡çš„äº§å“ã€‚ä½†æ˜¯æœ‰äº†CIå¯¹æ¯”å…¶ä»–äº§å“Gogsã€githubç­‰å®ƒè¿˜ç®—å¯å ªä¸€ç”¨ã€‚ä¸Šä¸€ç¯‡æ–‡ç« å†™äº†gitlab_ci.ymlé…ç½®æ–‡ä»¶çš„ä¸€äº›å‚æ•°çš„å«ä¹‰ã€‚æœ¬ç¯‡æ–‡ç« è®°å½•ä¸€ä¸‹å¦‚ä½•ä»é›¶åœ¨Gitlabä¸Šå®Œæˆç®€å•çš„CI/CDæµç¨‹ã€‚åŸºç¡€æµç¨‹å¦‚ä¸‹Buildæµç¨‹æ„å»ºæˆ‘ä»¬éœ€è¦çš„é•œåƒä¸Šä¼ åˆ°é•œåƒä»“åº“ã€‚éƒ¨ç½²çš„æ—¶å€™ä»é•œåƒä»“åº“ç›´æ¥æ‹‰å–é‡å¯å®¹å™¨&lt;br&gt;&lt;img src=&quot;https://ficapy.b0.upaiyun.com/blogimg/GitlabCI.jpg&quot; alt=&quot;GitlabCI&quot;&gt;&lt;br&gt;
    
    </summary>
    
      <category term="devops" scheme="https://www.zoulei.net/categories/devops/"/>
    
    
  </entry>
  
</feed>
