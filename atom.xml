<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>é‚¹é›·</title>
  <subtitle>åˆ¨è¿‡çš„å‘,è‡ªå·±æ…¢æ…¢æ¥å¡«</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://www.zoulei.net/"/>
  <updated>2017-07-05T15:33:53.000Z</updated>
  <id>https://www.zoulei.net/</id>
  
  <author>
    <name>ficapy</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Docker CDåˆæ¢-Drone</title>
    <link href="https://www.zoulei.net/2017/07/05/drone/"/>
    <id>https://www.zoulei.net/2017/07/05/drone/</id>
    <published>2017-07-05T13:51:26.000Z</published>
    <updated>2017-07-05T15:33:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘æœ‰ä¸ªå°éœ€æ±‚ï¼Œæˆ‘ä»¬å…¬å¸å†™æ–‡æ¡£æ˜¯é€šè¿‡<a href="https://github.com/lord/slate">slate</a>æ¥çš„ã€‚æ¯ä¸€æ¬¡æ–‡æ¡£ç¼–å†™å®Œæˆä¹‹åéƒ½éœ€è¦æ‰§è¡Œ<code>bundle exec middleman build --clean</code>ç”Ÿæˆé™æ€æ–‡ä»¶ã€‚ç„¶åå†ä½¿ç”¨rsyncæ¥è¿›è¡Œä¸Šä¼ æ“ä½œã€‚è™½ç„¶åªæœ‰2æ­¥ã€‚ä½†æ˜¯åšçš„æ¬¡æ•°å¤šäº†éš¾å…ä¹Ÿè®©äººè§‰å¾—åŒçƒ¦ã€‚èŒç”Ÿäº†è‡ªåŠ¨åŒ–å¤„ç†çš„æƒ³æ³•ã€‚æ¯”è¾ƒç²—æš´çš„æ–¹å¼æœ‰ã€‚æ¯éš”å‡ åˆ†é’Ÿå»æ£€æµ‹ä¸€æ¬¡gitç‰ˆæœ¬åº“æ˜¯å¦æœ‰æ›´æ–°(ä»¥å‰æœ¬äººçœŸè¿™æ ·å®ç°è¿‡)ï¼Œè‡ªå·±å†™ä¸ªå°webç¨‹åºã€‚è®¾ç½®webhookã€‚æ¥æ”¶åˆ°webhookå†æ‹‰å–è¿›è¡Œæ“ä½œ(æˆ‘ä¹Ÿå®ç°è¿‡ï¼Œç›®å‰ä¸€åˆ‡è¿è¡Œè‰¯å¥½)ã€‚ç°åœ¨å°è¯•ä¸‹ä½¿ç”¨å¯æŒç»­é›†æˆçš„å¥—è·¯å»å®ç°ã€‚</p>
<a id="more"></a>
<p>è¯´ä¸€ä¸‹ç¬¬ä¸‰ç§æ–¹æ¡ˆç›¸å¯¹å‰ä¸¤ç§æ–¹æ¡ˆçš„ç‰¹ç‚¹ã€‚</p>
<ul>
<li>é›†ä¸­åŒ–ç®¡ç†ã€‚ç¬¬ä¸€äºŒç§æ–¹æ¡ˆéƒ½éœ€è¦å°†è„šæœ¬æ”¾åœ¨å¯¹åº”çš„åº”ç”¨æœºå™¨ä¸Šé¢ã€‚ç¬¬ä¸‰ç§ä¸éœ€è¦ï¼Œå®ƒé›†ä¸­åŒ–äº†ã€‚æ‰€æœ‰çš„webhookéƒ½åœ¨å¯æŒç»­é›†æˆå¹³å°å¤„ç†ã€‚ç”±å¹³å°å†æ¥æ“æ§åº”ç”¨ã€‚è€Œä¸”æ¯ä¸€æ¬¡è§¦å‘æ“ä½œéƒ½æœ‰è¯¦å°½çš„æ—¥å¿—ã€‚é›†ä¸­åœ¨ä¸€èµ·æ¯”è¾ƒå®¹æ˜“çœ‹å‡ºå“ªé‡Œå‡ºäº†ä»€ä¹ˆé—®é¢˜</li>
<li>ä¸éœ€è¦åœ¨æ¯ä¸€å°åº”ç”¨æœºå¤„ç†webhook(å¤„ç†æ„å‘³ç€æ¯ä¸ªåº”ç”¨æœºéƒ½éœ€è¦ç»‘å®šä¸€ä¸ªåŸŸå)ï¼Œå¯èƒ½å’Œä¸Šé¢çš„é›†ä¸­åŒ–ç®¡ç†çš„ä¼˜ç‚¹æ˜¯ä¸€ä¸ªæ„æ€å§</li>
<li>å¯¹äºä¸€ä¸ªè‰¯å¥½çš„æ¶æ„ã€‚å¯æŒç»­é›†æˆå¹³å°æ¯”é›¶æ•£çš„è„šæœ¬æ— ç–‘æ›´åˆé€‚</li>
<li>ç®—æ˜¯ä¸€ä¸ªç¼ºç‚¹ã€‚å•ç‹¬å†™è„šæœ¬ç‹¬ç«‹å¤„ç†webhookç›¸å¯¹å¯æŒç»­é›†æˆæ›´å®¹æ˜“</li>
</ul>
<h3 id="Droneé…ç½®"><a href="#Droneé…ç½®" class="headerlink" title="Droneé…ç½®"></a>Droneé…ç½®</h3><p>docker-composeæˆ‘éƒ½ä¸å¤§ç”¨äº†ï¼Œç›´æ¥ç”¨docker stack deployæ›¿ä»£ã€‚åè€…ç›¸å¯¹å‰è€…å®é™…æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚æˆ–è€…è¯´å‰è€…æ˜¯å› ä¸ºdockerç½‘ç»œé…ç½®æ¬ å‘è¾¾çš„äº§ç‰©ã€‚docker-composeé€‚åˆå•æœºéƒ¨ç½²ï¼Œdocker-swarmé€‚åˆå¤šä¸»æœºã€‚å¼€å¯docker-swarmåªéœ€è¦docker swarm initå¤§æ¦‚å°±å¯ä»¥äº†ï¼Œæ›´è¯¦ç»†çš„çŸ¥è¯†è¯·æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£</p>
<p>drone.yml æ–‡ä»¶å¤§æ¦‚å¦‚ä¸‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">version: &apos;3&apos;</div><div class="line"></div><div class="line">services:</div><div class="line">  drone-server:</div><div class="line">    image: drone/drone:0.7</div><div class="line">    ports:</div><div class="line">      - 82:8000</div><div class="line">    volumes:</div><div class="line">      - /data/github_drone:/var/lib/drone/</div><div class="line">    environment:</div><div class="line">      - DRONE_OPEN=false</div><div class="line">      - DRONE_ADMIN=ficapy</div><div class="line">      - DRONE_GITLAB=true</div><div class="line">      - DRONE_GITHUB_CLIENT=xxxxxxxxx</div><div class="line">      - DRONE_GITHUB_SECRET=xxxxxxxxxx</div><div class="line">      - DRONE_SECRET=xxxpwdxxx</div><div class="line"></div><div class="line">  drone-agent:</div><div class="line">    image: drone/drone:0.7</div><div class="line">    command: agent</div><div class="line">    depends_on:</div><div class="line">      - drone-server</div><div class="line">    volumes:</div><div class="line">      - /var/run/docker.sock:/var/run/docker.sock</div><div class="line">    environment:</div><div class="line">      - DRONE_SERVER=ws://drone-server:8000/ws/broker</div><div class="line">      - DRONE_SECRET=xxxpwdxxx</div><div class="line"></div></pre></td></tr></table></figure></p>
<p>ç„¶åæ‰§è¡Œ<code>docker stack deploy --compose-file=drone.yml drone</code>ï¼Œæ•´ä¸ªç¨‹åºå°±è¿è¡Œèµ·æ¥äº†ã€‚æ­¤å¤„æ˜¯ç›‘å¬81ç«¯å£ã€‚ä»é…ç½®æ–‡ä»¶ä¸­ä¹Ÿå¯ä»¥çŒœä¸€ä¸ªå¤§æ¦‚ã€‚äº†è§£ä¸‹droneçš„æµç¨‹ã€‚serviceä¸»è¦ç”¨æ¥å“åº”æµè§ˆå™¨ç«¯çš„è¯·æ±‚ã€‚æ¥æ”¶åˆ°è¯·æ±‚åä½¿ç”¨websocketå’Œagenté€šä¿¡ç”¨æ¥ä¸‹å‘ä»»åŠ¡è·å–ç»“æœã€‚agenté€šè¿‡/var/run/docker.sockæ¥å’Œdocker daemonè¿›è¡Œé€šä¿¡ã€‚æ‰§è¡Œåˆ›å»ºå®¹å™¨ã€‚æ‰§è¡Œå‘½ä»¤ç­‰ä¸€ç³»åˆ—è¿‡ç¨‹ã€‚</p>
<p>æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„çš„</p>
<ul>
<li>æœ€å¥½æŒ‡å®šç®¡ç†å‘˜ç”¨æˆ·DRONE_ADMINï¼Œå› ä¸ºæœ‰äº›æ“ä½œéœ€è¦adminæƒé™</li>
<li>DRONE_OPENè®¾ç½®ä¸ºtrueçš„æ—¶å€™æ‰€æœ‰çš„ç”¨æˆ·éƒ½èƒ½æˆæƒåä½¿ç”¨ä½ çš„Droneè¿›è¡Œé›†æˆæµ‹è¯•ã€‚è¿™å¾€å¾€æ˜¯ä½ ä¸æ„¿æ„çš„ï¼Œä¸ªäººçš„è¯‰æ±‚å¾€å¾€æ˜¯ç§æœ‰çš„</li>
<li>githubå’Œgitlabåœ¨ä¸€ä¸ªdroneä¸èƒ½åŒæ—¶ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘éƒ¨ç½²äº†ä¸¤å¥—ï¼Œä½¿ç”¨äº†ä¸åŒçš„åŸŸå</li>
<li>èµ·ç äº†è§£OAuthæµç¨‹å’Œwebhookçš„è¿‡ç¨‹ï¼Œæ‰èƒ½æ›´å¥½çš„ç†è§£æ•´å¥—æµç¨‹</li>
<li>å…¶ä»–äº‹å®œå¯ä»¥æŸ¥çœ‹Droneçš„<a href="http://docs.drone.io/installation/">å®‰è£…æ–‡æ¡£</a></li>
</ul>
<p>ä¹‹æ‰€ä»¥ç›‘å¬81ç«¯å£ï¼Œæ˜¯å› ä¸ºæˆ‘ä½¿ç”¨çš„Caddyå½“åšå‰ç½®webæœåŠ¡å™¨ã€‚é…ç½®å¦‚ä¸‹Caddyfile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">drone.ficapy.com &#123;</div><div class="line">    proxy / dockerhost:81 &#123;</div><div class="line">        websocket</div><div class="line">        transparent</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯¹åº”çš„docker-composeæ–‡ä»¶å¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">version: &quot;3&quot;</div><div class="line"></div><div class="line">services:</div><div class="line">  Caddy:</div><div class="line">    image: &quot;abiosoft/caddy&quot;</div><div class="line">    volumes:</div><div class="line">      - /root/caddy/Caddyfile:/etc/Caddyfile</div><div class="line">      - /root/.caddy:/root/.caddy</div><div class="line">    ports:</div><div class="line">      - &quot;80:80&quot;</div><div class="line">      - &quot;443:443&quot;</div><div class="line">    extra_hosts:</div><div class="line">      - &quot;dockerhost:$&#123;dockerhost&#125;&quot;</div></pre></td></tr></table></figure>
<p>æ­¤å¤„ä½¿ç”¨äº†ç¯å¢ƒå˜é‡dockerhostï¼Œæˆ‘å°†å®ƒå†™å…¥äº†zshrcé…ç½®æ–‡ä»¶ä¸­<code>export dockerhost=&quot;172.17.0.1&quot;</code>,ä¸éš¾çœ‹å‡ºåªæ˜¯ä¸ºäº†è½¬å‘è¯·æ±‚, å’Œdroneä¸€æ ·ã€‚æ‰§è¡Œ<code>docker stack deploy --compose-file=caddy_compose.yml caddy</code>å¯åŠ¨</p>
<h3 id="æŒç»­é›†æˆéƒ¨ç½²"><a href="#æŒç»­é›†æˆéƒ¨ç½²" class="headerlink" title="æŒç»­é›†æˆéƒ¨ç½²"></a>æŒç»­é›†æˆéƒ¨ç½²</h3><p>å½“ä½¿ç”¨Droneï¼Œå¹¶æˆæƒä¹‹åã€‚Droneä¼šè‡ªåŠ¨ç»™ä½ çš„é¡¹ç›®åŠ ä¸Šwebhookåœ°å€ã€‚æˆ‘ä»¬åœ¨é¡¹ç›®æ ¹ç›®å½•æ”¾ç½®.drone.ymlæ–‡ä»¶åä¼šä½¿ç”¨dockerè‡ªåŠ¨æ„å»º</p>
<p>å®ç°æœ¬æ–‡å¼€å¤´è¯´çš„éœ€æ±‚.drone.ymlæ–‡ä»¶å¦‚ä¸‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">pipeline:</div><div class="line">  build:</div><div class="line">    image: ruby:2.3</div><div class="line">    commands:</div><div class="line">      - bundle config mirror.https://rubygems.org https://gems.ruby-china.org</div><div class="line">      - bundle install</div><div class="line">      - apt-get update &amp;&amp; apt-get install nodejs rsync -y &amp;&amp; bundle exec middleman build --clean</div><div class="line">      - rsync -r --rsh=&apos;ssh -o LogLevel=ERROR -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o IdentitiesOnly=yes -i /data/id_rsa -p 22&apos; build/* user@host:~/docs --progress --delete</div><div class="line">    volumes:</div><div class="line">      - /data:/data</div><div class="line">    when:</div><div class="line">      branch: master</div></pre></td></tr></table></figure></p>
<p>åœ¨ä½¿ç”¨ä¹‹å‰ã€‚æˆ‘ç°åœ¨/dataç›®å½•ä½¿ç”¨ssh-agentç”Ÿæˆäº†å¯†åŒ™å¯¹ã€‚åœ¨ç›®æ ‡ä¸»æœºä¸Šæ”¾ä¸Šå…¬é’¥ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿsshè¿æ¥è¿œç«¯ä¸»æœºã€‚ç„¶åå®¹å™¨åˆ›å»ºçš„æ—¶å€™å°†å¯†åŒ™æŒ‚è½½åˆ°å®¹å™¨ç›®å½•(æ­¤å¤„éœ€è¦ç®¡ç†å‘˜æƒé™å°†é¡¹ç›®è®¾ç½®ä¸ºå¯ä¿¡)ã€‚ç„¶åå°±é¡ºç†æˆç« äº†ã€‚æ­å»ºç¯å¢ƒï¼Œç”Ÿæˆé™æ€æ–‡ä»¶ï¼ŒrsyncåŒæ­¥å°±å®Œæˆäº†ã€‚</p>
<p>å†æ¥çœ‹çœ‹æˆ‘çš„åšå®¢ä¹Ÿæ˜¯ä½¿ç”¨è¿™ä¸ªæ–¹å¼éƒ¨ç½²çš„ï¼Œç›¸ä¿¡ä½ çœ‹é…ç½®æ–‡ä»¶å°±èƒ½å¤Ÿæ˜ç™½<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">pipeline:</div><div class="line">  build:</div><div class="line">    image: alpine</div><div class="line">    commands:</div><div class="line">      - rm -rf /root/blog &amp;&amp; cp -r * /var/blog</div><div class="line">    volumes:</div><div class="line">      - /root/blog:/var/blog</div><div class="line">    when:</div><div class="line">      branch: master</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘æœ‰ä¸ªå°éœ€æ±‚ï¼Œæˆ‘ä»¬å…¬å¸å†™æ–‡æ¡£æ˜¯é€šè¿‡&lt;a href=&quot;https://github.com/lord/slate&quot;&gt;slate&lt;/a&gt;æ¥çš„ã€‚æ¯ä¸€æ¬¡æ–‡æ¡£ç¼–å†™å®Œæˆä¹‹åéƒ½éœ€è¦æ‰§è¡Œ&lt;code&gt;bundle exec middleman build --clean&lt;/code&gt;ç”Ÿæˆé™æ€æ–‡ä»¶ã€‚ç„¶åå†ä½¿ç”¨rsyncæ¥è¿›è¡Œä¸Šä¼ æ“ä½œã€‚è™½ç„¶åªæœ‰2æ­¥ã€‚ä½†æ˜¯åšçš„æ¬¡æ•°å¤šäº†éš¾å…ä¹Ÿè®©äººè§‰å¾—åŒçƒ¦ã€‚èŒç”Ÿäº†è‡ªåŠ¨åŒ–å¤„ç†çš„æƒ³æ³•ã€‚æ¯”è¾ƒç²—æš´çš„æ–¹å¼æœ‰ã€‚æ¯éš”å‡ åˆ†é’Ÿå»æ£€æµ‹ä¸€æ¬¡gitç‰ˆæœ¬åº“æ˜¯å¦æœ‰æ›´æ–°(ä»¥å‰æœ¬äººçœŸè¿™æ ·å®ç°è¿‡)ï¼Œè‡ªå·±å†™ä¸ªå°webç¨‹åºã€‚è®¾ç½®webhookã€‚æ¥æ”¶åˆ°webhookå†æ‹‰å–è¿›è¡Œæ“ä½œ(æˆ‘ä¹Ÿå®ç°è¿‡ï¼Œç›®å‰ä¸€åˆ‡è¿è¡Œè‰¯å¥½)ã€‚ç°åœ¨å°è¯•ä¸‹ä½¿ç”¨å¯æŒç»­é›†æˆçš„å¥—è·¯å»å®ç°ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Docker" scheme="https://www.zoulei.net/categories/Docker/"/>
    
    
  </entry>
  
  <entry>
    <title>ç†è§£metaclass</title>
    <link href="https://www.zoulei.net/2017/03/24/python_metaclass/"/>
    <id>https://www.zoulei.net/2017/03/24/python_metaclass/</id>
    <published>2017-03-24T01:34:48.000Z</published>
    <updated>2017-05-31T08:46:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>metaclassä¸€ç›´è¢«å½’ç±»ä¸ºæ¯”è¾ƒé«˜æ·±çš„å†…å®¹ï¼Œå†™ä»£ç ä¹Ÿå¾ˆå°‘ä¼šä½¿ç”¨åˆ°metaclassã€‚ç„¶è€Œå¦‚æœä½ çœ‹æŸäº›é¡¹ç›®çš„æºä»£ç ï¼Œè¿˜æ˜¯ä¼šè¢«ç»•åˆ°metaclassé‡Œé¢å»ã€‚èŠ±ä¸€äº›æ—¶é—´ç†è§£ä¸‹metaclasså¾ˆæœ‰ç”¨çš„ï¼Œå› ä¸ºå®ƒçœŸçš„èƒ½æŠŠä¸€æ¡çº¿ä¸²èµ·æ¥ï¼Œç¯ç¯ç›¸æ‰£ï¼Œæ‰€ä»¥æœ‰æ‰å®çš„åŸºç¡€æ˜¯æŒæ¡metaclassçš„å‰æï¼Œæœ¬æ–‡ä»£ç åŸºäºpython3.5</p>
<a id="more"></a>
<p>ä½ åªéœ€è¦ç†è§£ä»¥ä¸‹2ç‚¹</p>
<ol>
<li>metaclasså’Œ<code>__new__</code>ã€<code>__init__</code>å¹¶æ²¡æœ‰éå¸¸éå¸¸æ·±çš„å…³ç³»</li>
<li>type(name, bases, dict)ç”Ÿæˆäº†ä¸€ä¸ªobjectç±»ï¼Œäº†è§£ä¸‰ä¸ªå‚æ•°åˆ†åˆ«æŒ‡ä»£äº†ä»€ä¹ˆ</li>
</ol>
<p>äº†è§£pythonä¸­æœ‰è¿™æ ·ä¸€æ¡å…³ç³»é“¾type-&gt;object-&gt;instance,é€šå¸¸æˆ‘ä»¬å†™ç±»é»˜è®¤ä¼šç»§æ‰¿è‡ªobjectã€‚ä»å…³ç³»é“¾å°±èƒ½çŸ¥é“typeèƒ½å¤Ÿç”Ÿæˆobjectã€‚ä»£ç å¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(type)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, name, bases, attrs)</span>:</span></div><div class="line">        attrs.pop(<span class="string">'e'</span>)</div><div class="line">        print(<span class="string">'1'</span>, cls, name, bases, attrs)</div><div class="line">        cls.a = <span class="number">1</span></div><div class="line">        <span class="keyword">return</span> super().__new__(cls, name, bases, attrs)</div><div class="line"></div><div class="line">    <span class="comment"># def __call__(self, *args, **kwargs):</span></div><div class="line">    <span class="comment">#     print('3')</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, bases, attrs)</span>:</span></div><div class="line">        self.b = <span class="number">2</span></div><div class="line">        print(<span class="string">'2'</span>, self, name, bases, attrs)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(metaclass=A)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, *args, **kwargs)</span>:</span></div><div class="line">        print(<span class="string">'4'</span>, args, kwargs)</div><div class="line">        cls.c = <span class="number">4</span></div><div class="line">        <span class="keyword">return</span> super().__new__(cls)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">e</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></div><div class="line">        print(<span class="string">'5'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, d)</span>:</span></div><div class="line">        self.d = d</div><div class="line">        print(<span class="string">'6'</span>)</div><div class="line"></div><div class="line"></div><div class="line">b = B(<span class="number">6</span>)</div><div class="line">print(hasattr(b, <span class="string">'a'</span>))</div><div class="line">print(b.b)</div><div class="line">print(b.c)</div><div class="line">print(b.d)</div><div class="line">print(hasattr(b, <span class="string">'e'</span>))</div></pre></td></tr></table></figure>
<p>å¯ä»¥å°è¯•æ³¨é‡Šæ‰B(12)ï¼ŒAä¾æ—§ä¼šè¢«æ‰“å°ï¼Œè§‚å¯Ÿargså’Œkwargsçš„è¾“å‡ºã€‚å¯¹æ¯”Aå’ŒBçš„ä¸åŒï¼Œä½ ä¼šå‘ç°metaclassçš„ç”¨å¤„ï¼Œ<strong>ä½¿ç”¨metaclassçš„æ—¶å€™ï¼ŒBçš„æ‰€æœ‰å±æ€§ä¼šè¢«å½“åšå‚æ•°ä¼ é€’ç»™A</strong>ï¼Œé‚£ä¹ˆæˆ‘ä»¬èƒ½å¤Ÿå°†è¿™äº›ä¼ è¿‡æ¥çš„å‚æ•°é¢„å¤„ç†ç„¶åæŒ‚åœ¨åˆ°ç±»çš„å±æ€§ä¸Šé¢è¿”å›ã€‚ä»¥ä¾›åç»­Bä½¿ç”¨ã€‚ç›®å‰åœ¨æˆ‘é‡åˆ°çš„webå¼€å‘ä¸­ä½“ç°çš„æœ€å¸¸è§çš„å°±æ˜¯ORMå’Œè¡¨å•éªŒè¯ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“<code>__new__</code>åˆ›å»ºä¸€ä¸ªå¯¹è±¡ã€‚<code>__init__</code>å¯¹åˆ›å»ºåçš„å¯¹è±¡è¿›è¡Œèµ‹å€¼ç­‰åˆå§‹åŒ–æ“ä½œã€‚ä»–ä»¬çš„ä¼ å‚argså’Œkwargsæ˜¯æ²¡æœ‰åŒºåˆ«çš„ã€‚ä½†æ˜¯åœ¨<code>__new__</code>é˜¶æ®µï¼Œèƒ½å¤Ÿå¯¹attrsè¿›è¡Œä¿®æ”¹ä»è€Œhookå¯¹è±¡çš„åˆ›å»ºæµç¨‹ï¼Œé™¤æ­¤ä¹‹å¤–æ„Ÿè§‰åªèƒ½ç”¨newä¸èƒ½ç”¨initçš„åœºæ™¯æ˜¯å¾ˆå°‘çš„ã€‚ç›®å‰çœ‹åˆ°çš„ä¾‹å­è®°å¾—çš„å¯èƒ½åªæœ‰ç”¨newå®ç°å•ä¾‹ã€‚å¯¹äºå†…ç½®ä¸å¯å˜å¯¹è±¡æ¯”å¦‚intç”¨newå˜æ›´åˆå§‹åŒ–é€»è¾‘</p>
<p>æœ€åä¾‹ä¸¾ä¸€ä¸ªORMçš„ä¾‹å­(è§å‚è€ƒ)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Field</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, column_type)</span>:</span></div><div class="line">        self.name = name</div><div class="line">        self.column_type = column_type</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StringField</span><span class="params">(Field)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></div><div class="line">        super(StringField, self).__init__(name, <span class="string">'vachar(100)'</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelMetaclass</span><span class="params">(type)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, name, bases, attrs)</span>:</span></div><div class="line">        <span class="keyword">if</span> name != <span class="string">'Model'</span>:</div><div class="line">            mappings = &#123;k: v.name <span class="keyword">for</span> k, v <span class="keyword">in</span> attrs.items() <span class="keyword">if</span> isinstance(v, Field)&#125;</div><div class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> mappings.keys():</div><div class="line">                attrs.pop(k)</div><div class="line">            attrs[<span class="string">'__mappings__'</span>] = mappings</div><div class="line">            attrs[<span class="string">'__table__'</span>] = name</div><div class="line"></div><div class="line">        <span class="keyword">return</span> type.__new__(cls, name, bases, attrs)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Model</span><span class="params">(dict, metaclass=ModelMetaclass)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, **kwargs)</span>:</span></div><div class="line">        super().__init__(**kwargs)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, key)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">return</span> self[key]</div><div class="line">        <span class="keyword">except</span> KeyError:</div><div class="line">            <span class="keyword">raise</span> AttributeError(<span class="string">r"'Model' object has no attribute &#123;key&#125;"</span>.format(key=key))</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span></div><div class="line">        self[key] = value</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(self)</span>:</span></div><div class="line">        fields, params, args = [], [], []</div><div class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> self.__mappings__.items():</div><div class="line">            fields.append(v)</div><div class="line">            params.append(<span class="string">'?'</span>)</div><div class="line">            args.append(getattr(self, k, <span class="keyword">None</span>))</div><div class="line">        sql = <span class="string">'insert into &#123;table_name&#125; (&#123;fields&#125;) values (&#123;values&#125;)'</span>.format(table_name=self.__table__,</div><div class="line">                                                                             fields=<span class="string">','</span>.join(fields),</div><div class="line">                                                                             values=<span class="string">','</span>.join(params))</div><div class="line">        print(<span class="string">'SQL: &#123;sql&#125;'</span>.format(sql=sql))</div><div class="line">        print(<span class="string">'ARGS: &#123;args&#125;'</span>.format(args=args))</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserModel</span><span class="params">(Model)</span>:</span></div><div class="line">    user_name = StringField(<span class="string">'username'</span>)</div><div class="line">    email = StringField(<span class="string">'email'</span>)</div><div class="line">    password = StringField(<span class="string">'password'</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    user = UserModel(user_id=<span class="number">123</span>, user_name=<span class="string">'hhh'</span>, email=<span class="string">'a@a.a'</span>, password=<span class="string">'asdfa'</span>, x=<span class="string">'y'</span>)</div><div class="line">    user.save()</div><div class="line">    </div></pre></td></tr></table></figure>    </p>
<p>ä¸‹ç¯‡ä¼šåˆ†æmetaclassåœ¨WTFormsä¸­çš„åº”ç”¨</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.ionelmc.ro/2015/02/09/understanding-python-metaclasses/">Understanding Python metaclasses æ›´è¯¦ç»†çš„ä»‹ç»</a><br><a href="http://www.jianshu.com/p/9dfa40bf2a62">pythonå®ç°ORM</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;metaclassä¸€ç›´è¢«å½’ç±»ä¸ºæ¯”è¾ƒé«˜æ·±çš„å†…å®¹ï¼Œå†™ä»£ç ä¹Ÿå¾ˆå°‘ä¼šä½¿ç”¨åˆ°metaclassã€‚ç„¶è€Œå¦‚æœä½ çœ‹æŸäº›é¡¹ç›®çš„æºä»£ç ï¼Œè¿˜æ˜¯ä¼šè¢«ç»•åˆ°metaclassé‡Œé¢å»ã€‚èŠ±ä¸€äº›æ—¶é—´ç†è§£ä¸‹metaclasså¾ˆæœ‰ç”¨çš„ï¼Œå› ä¸ºå®ƒçœŸçš„èƒ½æŠŠä¸€æ¡çº¿ä¸²èµ·æ¥ï¼Œç¯ç¯ç›¸æ‰£ï¼Œæ‰€ä»¥æœ‰æ‰å®çš„åŸºç¡€æ˜¯æŒæ¡metaclassçš„å‰æï¼Œæœ¬æ–‡ä»£ç åŸºäºpython3.5&lt;/p&gt;
    
    </summary>
    
      <category term="python" scheme="https://www.zoulei.net/categories/python/"/>
    
    
  </entry>
  
  <entry>
    <title>tornadoè¡¨å•éªŒè¯</title>
    <link href="https://www.zoulei.net/2017/03/23/tornado_wtforms/"/>
    <id>https://www.zoulei.net/2017/03/23/tornado_wtforms/</id>
    <published>2017-03-23T12:17:29.000Z</published>
    <updated>2017-03-23T12:41:33.000Z</updated>
    
    <content type="html"><![CDATA[<p>å·¥ä½œä¸­çœ‹åˆ°æœ‰ä¸€äº›ä¸å¥½çš„ä»£ç ï¼Œæƒ³äº†ä¸ªåŠæ³•ä¼˜åŒ–äº†ä¸€ä¸‹ï¼Œäºæ˜¯æœ‰äº†è¿™ç¯‡åšæ–‡ã€‚æœ¬æ–‡ä¸»è¦è®²tornadoçš„è¡¨å•éªŒè¯ï¼Œä½¿ç”¨çš„æ˜¯wtformsã€‚æœ¬æ–‡æœ€ç»ˆè¾¾åˆ°çš„æ•ˆæœæ˜¯ä½¿ç”¨self.xxè·å–postä¼ é€’è¿‡æ¥çš„å€¼ã€‚</p>
<a id="more"></a>
<p>é¦–å…ˆæ˜¯å°†wtformsåµŒå…¥tornadoã€‚åšæ³•å¯ä»¥å‚è€ƒ<a href="https://github.com/truemped/tornadotools/blob/master/tornadotools/forms.py">https://github.com/truemped/tornadotools/blob/master/tornadotools/forms.py</a>ï¼Œæˆ‘çš„åšæ³•ç±»ä¼¼ï¼Œå¯ä»¥çœ‹æœ€ä¸‹é¢çš„ä»£ç ã€‚è¿™æ ·ç»§æ‰¿ä¸€ä¸‹å°±èƒ½å¤Ÿä½¿ç”¨wtformsçš„è¡¨å•éªŒè¯äº†ã€‚èƒ½å¤Ÿä½¿ç”¨çš„ç»“æœæ˜¯å¾ˆå¤šäººå†™è¿™æ ·çš„ä»£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">self.xx1 = self.form.xx1.data</div><div class="line">self.xx2 = self.form.xx2.data</div><div class="line">self.xx3 = self.form.xx3.data</div><div class="line">:</div><div class="line">:</div></pre></td></tr></table></figure>
<p>ç„¶åè¿™æ ·å†™äº†20è¡Œ(ä¸é»‘ï¼Œé¡¹ç›®é‡ŒçœŸæœ‰è¿™æ ·çš„)ã€‚å†™çš„äººä¹Ÿç¡®å®æ˜¯å¾ˆè®¤çœŸå•Šï¼ï¼Œæ”¹è¿›çš„æ–¹æ³•å¾ˆç®€å•ã€‚è°ƒç”¨self.xx1çš„æ—¶å€™è‡ªåŠ¨å–å€¼self.form.xx1.dataã€‚èƒ½åšæˆè¿™æ ·çš„æ–¹æ³•æŒºå¤šã€‚å¾ˆå¤šæ—¶å€™ä¼šå¯¼è‡´self.xxxä½¿ç”¨IDEæ— æ³•è¡¥å…¨ã€‚æˆ‘ä¸ªäººè®¤ä¸ºå¥½çš„ä»£ç è‚¯å®šèƒ½å¤Ÿæ–¹ä¾¿çš„è¡¥å…¨å’Œæç¤ºï¼Œæ¯•ç«Ÿè¿™æ ·èƒ½å®æ‰“å®çš„æå‡ç ä»£ç çš„å¿ƒæƒ…ï¼Œè¯•æƒ³ä¸€ä¸‹ä½ è¦è¾“å…¥20ä¸ªå•è¯ï¼Œå¾ˆå¯èƒ½ä¸€ä¸å°å¿ƒå°±è¾“å…¥é”™è¯¯äº†ã€‚æ”¹è¿›çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨<code>__getattribute__</code>,é…åˆç±»ç»§æ‰¿ï¼Œå…¼é¡¾è‡ªåŠ¨è¡¥å…¨ä¹Ÿä¸ç”¨è·‘å»å†™self.form.xxx.dataäº†</p>
<ol>
<li><code>__getattr__</code>ï¼Œå½“å±æ€§ä¸å­˜åœ¨çš„æ—¶å€™ä¼šè°ƒç”¨</li>
<li><code>__getattribute__</code>,æ— è®ºå±æ€§æ˜¯å¦å­˜åœ¨éƒ½ä¼šè¢«è°ƒç”¨</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">import tornado.ioloop</div><div class="line">import tornado.web</div><div class="line"></div><div class="line">from wtforms import validators, fields</div><div class="line">from wtforms import Form</div><div class="line">from wtforms.fields.core import UnboundField</div><div class="line"></div><div class="line"></div><div class="line">class MultiDict(dict):</div><div class="line">    def getlist(self, key):</div><div class="line">        return self[key]</div><div class="line"></div><div class="line">    def setlist(self, key, value):</div><div class="line">        self[key] = value</div><div class="line"></div><div class="line"></div><div class="line">class BaseForm(Form):</div><div class="line">    def __init__(self, handler=None, obj=None, prefix=&apos;&apos;, **kwargs):</div><div class="line">        if handler is None:</div><div class="line">            return</div><div class="line">        formdata = MultiDict()</div><div class="line">        if handler.request.method == &apos;POST&apos;:</div><div class="line">            for name in handler.request.arguments.keys():</div><div class="line">                formdata.setlist(name, handler.get_arguments(name))</div><div class="line">        else:</div><div class="line">            for name in handler.request.query_arguments.keys():</div><div class="line">                formdata.setlist(name, handler.request.query_arguments[name])</div><div class="line">        Form.__init__(self, formdata, obj=obj, prefix=prefix, **kwargs)</div><div class="line"></div><div class="line"></div><div class="line">class LoginForm(BaseForm):</div><div class="line">    email = fields.StringField(</div><div class="line">        validators=[validators.Email(), validators.required(), validators.length(min=5, max=64)])</div><div class="line">    password = fields.PasswordField(validators=[validators.required()])</div><div class="line"></div><div class="line"></div><div class="line">class MainHandler(tornado.web.RequestHandler, LoginForm):</div><div class="line">    def __getattribute__(self, item):</div><div class="line">        ret = object.__getattribute__(self, item)</div><div class="line">        if isinstance(ret, UnboundField):</div><div class="line">            form = object.__getattribute__(self, &apos;form&apos;)</div><div class="line">            return getattr(form, item).data</div><div class="line">        return ret</div><div class="line"></div><div class="line">    def post(self):</div><div class="line">        self.form = LoginForm(self)</div><div class="line">        print(self.email)</div><div class="line">        self.write(&quot;Hello, world&quot;)</div><div class="line"></div><div class="line"></div><div class="line">def make_app():</div><div class="line">    return tornado.web.Application([</div><div class="line">        (r&quot;/&quot;, MainHandler),</div><div class="line">    ])</div><div class="line"></div><div class="line"></div><div class="line">if __name__ == &quot;__main__&quot;:</div><div class="line">    app = make_app()</div><div class="line">    app.listen(8888)</div><div class="line">    tornado.ioloop.IOLoop.current().start()</div></pre></td></tr></table></figure>
<p>å®Œç¾è§£å†³é—®é¢˜,å¿ƒæƒ…ç¬é—´èˆ’ç•…äº†â”‘(ï¿£Ğ” ï¿£)â”</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å·¥ä½œä¸­çœ‹åˆ°æœ‰ä¸€äº›ä¸å¥½çš„ä»£ç ï¼Œæƒ³äº†ä¸ªåŠæ³•ä¼˜åŒ–äº†ä¸€ä¸‹ï¼Œäºæ˜¯æœ‰äº†è¿™ç¯‡åšæ–‡ã€‚æœ¬æ–‡ä¸»è¦è®²tornadoçš„è¡¨å•éªŒè¯ï¼Œä½¿ç”¨çš„æ˜¯wtformsã€‚æœ¬æ–‡æœ€ç»ˆè¾¾åˆ°çš„æ•ˆæœæ˜¯ä½¿ç”¨self.xxè·å–postä¼ é€’è¿‡æ¥çš„å€¼ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="python" scheme="https://www.zoulei.net/categories/python/"/>
    
    
  </entry>
  
  <entry>
    <title>sshç«¯å£æ˜ å°„</title>
    <link href="https://www.zoulei.net/2017/03/12/ssh-port-forward/"/>
    <id>https://www.zoulei.net/2017/03/12/ssh-port-forward/</id>
    <published>2017-03-12T03:40:30.000Z</published>
    <updated>2017-06-01T07:30:20.000Z</updated>
    
    <content type="html"><![CDATA[<p>å¼€å‘ä¸­ç»å¸¸ä¼šéœ€è¦ç”¨åˆ°ç«¯å£æ˜ å°„è¿™ç§äº‹æƒ…ã€‚ä»¥å‰è§‰å¾—å¥½å®¹æ˜“æ··æ·†ã€‚å…¶å®ç”¨ä¹ æƒ¯äº†å°±ä¼šå‘ç°å¦‚æ­¤ç®€å•â”‘(ï¿£Ğ” ï¿£)â”ï¼Œä¸‹é¢è”ç³»åˆ°æˆ‘æ—¥å¸¸ä½¿ç”¨åˆ°çš„ä¸€äº›sshæ˜ å°„å®ä¾‹è®²è§£ä¸€ä¸‹</p>
<a id="more"></a>
<ol>
<li><p>-Då‚æ•°ï¼Œæä¾›ä¸€ä¸ªsocket5çº§åˆ«çš„ä»£ç†ã€‚</p>
<p> è¿™ä¸ªåœ¨å¾ˆå¤šå¹´ä»¥å‰ç¿»å¢™çš„æ—¶å€™è¿˜æ˜¯å¾ˆå¥½ç”¨çš„ã€‚ä¸è¿‡éƒ½å·²ç»æˆä¸ºäº†å†å²ã€‚æœ‰ä»£ç†ä½¿ç”¨ç»éªŒçš„å¼€å‘è€…éƒ½èƒ½å¾ˆå¿«ç†è§£è¿™ä¸ªç©æ„</p>
</li>
<li><p>-L(local forward)æœ¬åœ°è½¬å‘</p>
<p> æ¯”å¦‚ä½ ç°åœ¨éœ€è¦è¿æ¥åˆ°æ­£å¼ç¯å¢ƒçš„æ•°æ®åº“,é‚£ä¹ˆä½ ä¸éœ€è¦å…ˆsshåˆ°æ­£å¼ç¯å¢ƒå†è¾“å…¥æ•°æ®åº“å‘½ä»¤ã€‚æˆ‘çš„åšæ³•æ˜¯é€‰æ‹©ç”¨å›¾å½¢ç•Œé¢æŸ¥çœ‹æ•°æ®åº“ã€‚å‘½ä»¤æ˜¯è¿™æ ·çš„ </p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh -L  6789:192.168.10.10:5432 prod</div></pre></td></tr></table></figure>
<p> å«ä¹‰å°±æ˜¯å°†æœ¬åœ°6789ç«¯å£æ¥å—åˆ°çš„è¯·æ±‚è½¬å‘åˆ°ç”Ÿäº§ç¯å¢ƒprodä¸Šé¢çš„192.168.10.10:5432ï¼Œè¿™æ ·æœ¬åœ°GUIæ•°æ®åº“ç®¡ç†ç¨‹åºå°±èƒ½å¤Ÿç›´æ¥è¿æ¥æœ¬åœ°6789ç«¯å£æ˜¾ç¤ºçº¿ä¸Šæ•°æ®äº†ã€‚å¯ä»¥çœ‹å‡ºå®ƒçš„ä½œç”¨å°±æ˜¯å°†æœ¬åœ°ç«¯å£çš„è¯·æ±‚è½¬å‘çš„æœåŠ¡å™¨ä¸Šé¢</p>
</li>
<li><p>-R(Remote forward)è¿œç¨‹è½¬å‘</p>
<p> è¿™ä¸ªå°±æ˜¯å’Œæœ¬åœ°è½¬å‘ç›¸åã€‚åœ¨è¿æ¥çš„æœåŠ¡å™¨ä¸Šæ‰“å¼€ä¸€ä¸ªç«¯å£ï¼Œæ˜ å°„åˆ°è‡ªå·±çš„ç«¯å£ã€‚æ­¤æ—¶æ•°æ®æµæ˜¯æœåŠ¡å™¨ç«¯å£æ¥æ”¶åˆ°çš„æ•°æ®ä¼ åˆ°äº†æœ¬åœ°ã€‚æ¯”å¦‚ä½ éœ€è¦ä¸€ä¸ªå…¬ç½‘ip(æ˜¾ç„¶æˆ‘ä»¬çš„åŠå…¬ç¯å¢ƒéƒ½æ˜¯æ²¡æœ‰å…¬ç½‘ipçš„)æ¥è°ƒè¯•ä½ çš„webåº”ç”¨ï¼Œæ¯”å¦‚ä½ æœ¬åœ°å†™äº†ä¸ªwebç¨‹åºç›‘å¬8989ç«¯å£ï¼Œä½ è¿œç¨‹æœåŠ¡å™¨ä¸Šæœ‰å…¬ç½‘ipã€‚ä½ éœ€è¦æŠŠwebç¨‹åºä¸´æ—¶åˆ†äº«åˆ°å…¬ç½‘ç»™åˆ«äººå°è¯•ä½¿ç”¨ã€‚æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh -R 4321:127.0.0.1:8989 prod</div></pre></td></tr></table></figure>
<p> è¿™æ ·åˆ«äººè®¿é—®prod_ip:4321å°±ä¼šæ˜ å°„åˆ°ä½ æœ¬åœ°çš„8989ç«¯å£ä¸Šã€‚</p>
</li>
<li><p>åŠ©è®°</p>
<p> åˆšå¼€å§‹å¯èƒ½è§‰å¾—ç«¯å£æ¯”è¾ƒå®¹æ˜“æ··æ·†ã€‚åªéœ€è¦è®°ä½xx:xxï¼Œå‰é¢æ˜¯å…¥å£ï¼Œåé¢æ˜¯å‡ºå£ã€‚æœ¬åœ°è½¬å‘çš„æ—¶å€™æ•°æ®æ˜¯ä»æœ¬åœ°å‘åˆ°è¿œç¨‹ã€‚æ‰€ä»¥6789æ˜¯æœ¬åœ°ç«¯å£ã€‚è¿œç¨‹è½¬å‘çš„æ—¶å€™æ•°æ®æ˜¯ä»è¿œç¨‹å‘åˆ°æœ¬åœ°ã€‚æ‰€ä»¥8989æ˜¯æœ¬åœ°ç«¯å£</p>
</li>
<li><p>è¾…åŠ©å‚æ•°åŠå·¥å…·</p>
<p> å‡å¦‚ä½ åªéœ€è¦ç«¯å£æ˜ å°„ä¸éœ€è¦è¿›å…¥ç»ˆç«¯æ‰§è¡Œå‘½ä»¤ã€‚å¯ä»¥å¢åŠ -Nfå‚æ•°ï¼Œ-Nä¸ºä¸è¿›å…¥äº¤äº’å¼ç»ˆç«¯ã€‚fä¸ºåå°æ‰§è¡Œã€‚å‡å¦‚ä½ éœ€è¦é•¿æœŸä½¿ç”¨ï¼Œé‚£å°±ä½¿ç”¨autosshï¼Œå’Œsshä¸€ä¸ªå¥—è·¯ã€‚å°±ä¸ä¸¾ä¾‹äº†</p>
</li>
</ol>
<h2 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h2><p>å…¶å®æœ¬åœ°è½¬å‘å’Œè¿œç¨‹è½¬å‘å·²ç»å½¢æˆäº†ä¸€ä¸ªåŒå‘çš„æ•°æ®æµåŠ¨ã€‚è¿™æ ·æˆ‘ä»¬å°±èƒ½å¤Ÿå®ç°ä¸€äº›çœ‹èµ·æ¥å¾ˆé«˜çº§çš„åŠŸèƒ½ã€‚æ¯”å¦‚è®¿é—®å†…ç½‘æœºå™¨(æ²¡æœ‰å…¬ç½‘ipï¼Œä¸èƒ½å¤Ÿè¢«ç›´æ¥è®¿é—®åˆ°)ã€‚åªè¦å†…ç½‘æœºå™¨èƒ½å¤Ÿä½¿ç”¨sshè®¿é—®åˆ°å¤–éƒ¨æœºå™¨ï¼Œè€Œè¿™å°å¤–éƒ¨æœºå™¨æˆ‘ä»¬èƒ½å¤Ÿè¿›è¡Œè®¿é—®ã€‚é‚£ä¹ˆæ­¤æ—¶å°±æ˜¯æ­é…æœ¬åœ°è½¬å‘å’Œè¿œç¨‹è½¬å‘çš„æ—¶å€™äº†ã€‚(æ³¨æ„ï¼Œå¦‚æœå¤–éƒ¨æœºå™¨èƒ½å¤Ÿå’Œå†…éƒ¨æœºå™¨åŒå‘è®¿é—®é‚£ä¹ˆä¼šæ›´ç®€å•)</p>
<p>æ€è·¯å°±æ˜¯ä½¿ç”¨å†…ç½‘æœºå™¨è®¿é—®å¤–éƒ¨æœºå™¨ï¼Œä½¿ç”¨è¿œç¨‹ç«¯å£æ˜ å°„ï¼Œå°†æœ¬æœºçš„22ç«¯å£æ˜ å°„åˆ°å¤–éƒ¨æœºå™¨çš„ä»»ä¸€ç«¯å£ä¸Šã€‚ä¹‹ååœ¨å¤–éƒ¨æœºå™¨å°±èƒ½å¤Ÿä½¿ç”¨ssh localhost -p xxè®¿é—®åˆ°å†…ç½‘æœºå™¨äº†ã€‚ç„¶è€Œè¿™éœ€è¦æˆ‘ä»¬å…ˆç™»å½•åˆ°å¤–éƒ¨æœºå™¨å†ä½¿ç”¨localhostç™»é™†åˆ°å†…ç½‘ã€‚æ­¤æ—¶æˆ‘ä»¬å¯ä»¥æ›´ç®€å•çš„ä½¿ç”¨~/.ssh/configé…ç½®æ–‡ä»¶å®Œæˆ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Host demo</div><div class="line">    user    ficapy</div><div class="line">    HostName    localhost</div><div class="line">    ProxyCommand ssh prod -W %h:7890</div></pre></td></tr></table></figure>
<p>ssh demoåä¼šå…ˆè¿æ¥å¤–éƒ¨æœºå™¨prod,å†å°†è¯·æ±‚è½¬å‘åˆ°localhost:7890ä¸Šå®Œæˆå¯¹å†…éƒ¨æœºå™¨çš„ç™»é™†ã€‚<br>å‡å¦‚å†…éƒ¨æœºå™¨å’Œå¤–éƒ¨æœºå™¨å¯ä»¥åŒå‘è®¿é—®ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦è¿œç¨‹ç«¯å£è½¬å‘ï¼Œåªéœ€è¦è¿™æ ·</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Host demo</div><div class="line">    User ficapy</div><div class="line">    HostName å†…ç½‘æœºå™¨ip</div><div class="line">    ProxyCommand ssh prod -W %h:%p</div></pre></td></tr></table></figure>
<h3 id="æ›´å‘çˆ¹çš„æƒ…å†µ"><a href="#æ›´å‘çˆ¹çš„æƒ…å†µ" class="headerlink" title="æ›´å‘çˆ¹çš„æƒ…å†µ"></a>æ›´å‘çˆ¹çš„æƒ…å†µ</h3><p>åœ¨ä¸¥æ ¼çš„ç¯å¢ƒä¸‹ï¼Œå‡å¦‚ç¦ç”¨äº†sshåè®®ã€‚ä¸å…è®¸ä»å†…éƒ¨sshåˆ°å¤–éƒ¨ã€‚åªå…è®¸å¯¹å¤–å‘é€httpã€httpsè¯·æ±‚ã€‚æ­¤æ—¶sshã€ngrok1.7ç‰ˆæœ¬ã€frpè¿™ç§æ˜¯æ— æ³•ä½¿ç”¨çš„ã€‚æ¨èä½¿ç”¨pagekiteè‡ªå»ºï¼Œäº¦æˆ–è€…ä½¿ç”¨é€Ÿåº¦æš´æ…¢çš„ngrokä»˜è´¹ç‰ˆ<br>é‡åˆ°è¿‡ä¸€ä¸ªé—®é¢˜ã€‚æµ‹è¯•æœºä¸Šéœ€è¦è®¿é—®10.19.2.96çš„1234å’Œ5053ç«¯å£ã€‚å¤„ç†æ–¹æ¡ˆæ˜¯å°†10.19.2.96æ­¤ipç»‘å®šåˆ°ç½‘å¡ä¸Šé¢é…åˆsshè½¬å‘ï¼Œ<code>sudo ifconfig en0 10.19.15.34 netmask 255.255.255.0 up</code>ã€‚ç„¶å<code>ssh -NL 10.19.15.34:1234:10.19.15.34:1234 -L 10.19.15.34:5053:10.19.15.34:5053 dev</code>å°±å¯ä»¥äº†</p>
<h3 id="æ”¶é›†çš„sshé…ç½®æ–‡ä»¶ï¼ˆæ›´å¥½çš„è¿æ¥åˆ°è¿œç«¯æœåŠ¡å™¨ï¼‰"><a href="#æ”¶é›†çš„sshé…ç½®æ–‡ä»¶ï¼ˆæ›´å¥½çš„è¿æ¥åˆ°è¿œç«¯æœåŠ¡å™¨ï¼‰" class="headerlink" title="æ”¶é›†çš„sshé…ç½®æ–‡ä»¶ï¼ˆæ›´å¥½çš„è¿æ¥åˆ°è¿œç«¯æœåŠ¡å™¨ï¼‰"></a>æ”¶é›†çš„sshé…ç½®æ–‡ä»¶ï¼ˆæ›´å¥½çš„è¿æ¥åˆ°è¿œç«¯æœåŠ¡å™¨ï¼‰</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Host	   *</div><div class="line">	Port          		 22</div><div class="line">    User          		 root</div><div class="line">    IdentityFile  		 ~/.ssh/id_rsa</div><div class="line">    ConnectTimeout 		15</div><div class="line">    ConnectionAttempts 	3</div><div class="line">    ServerAliveInterval 	20</div><div class="line">    ServerAliveCountMax 	5		</div><div class="line">    # å¤šæ¡è¿æ¥å…±äº«</div><div class="line">    ControlMaster   	auto</div><div class="line">    ControlPath     	/tmp/ssh_mux_%h_%p_%r</div><div class="line">    # é•¿è¿æ¥(é€€å‡ºæœåŠ¡å™¨åè¿æ¥ä¾ç„¶å¯é‡ç”¨)</div><div class="line">    ControlPersist  	4h</div><div class="line">    # å‡å°‘å»¶è¿Ÿ</div><div class="line">    GSSAPIAuthentication 	no</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼€å‘ä¸­ç»å¸¸ä¼šéœ€è¦ç”¨åˆ°ç«¯å£æ˜ å°„è¿™ç§äº‹æƒ…ã€‚ä»¥å‰è§‰å¾—å¥½å®¹æ˜“æ··æ·†ã€‚å…¶å®ç”¨ä¹ æƒ¯äº†å°±ä¼šå‘ç°å¦‚æ­¤ç®€å•â”‘(ï¿£Ğ” ï¿£)â”ï¼Œä¸‹é¢è”ç³»åˆ°æˆ‘æ—¥å¸¸ä½¿ç”¨åˆ°çš„ä¸€äº›sshæ˜ å°„å®ä¾‹è®²è§£ä¸€ä¸‹&lt;/p&gt;
    
    </summary>
    
      <category term="DevOps" scheme="https://www.zoulei.net/categories/DevOps/"/>
    
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨acme.shå¿«é€Ÿæ­å»ºhttps</title>
    <link href="https://www.zoulei.net/2017/03/05/acme.sh_quick_start/"/>
    <id>https://www.zoulei.net/2017/03/05/acme.sh_quick_start/</id>
    <published>2017-03-05T09:19:27.000Z</published>
    <updated>2017-03-05T14:23:56.000Z</updated>
    
    <content type="html"><![CDATA[<p>letsencryptåˆšå‡ºæ¥çš„æ—¶å€™å†™äº†ä¸€ç¯‡å®ƒçš„è®¤è¯ç­¾å‘åŸç†ã€‚è‡ªé‚£è¿‡åå°±æ²¡æœ‰çœŸæ­£çš„å»å®è·µè¿‡äº†ã€‚æœ€è¿‘æœ‰éƒ¨ç½²HTTPSçš„éœ€æ±‚å°±åˆè€ƒå¯Ÿäº†ä¸€ç•ªã€‚å‘ç°acme.shç°å¸¸å¥½ç”¨å•Š~~~ï¼Œæ¥ä¸€ç¯‡æ°´æ–‡è®°å½•ä¸‹æµ‹è¯•éƒ¨ç½²HTTPSçš„å®Œæ•´è¿‡ç¨‹å§</p>
<a id="more"></a>
<p>é¦–å…ˆæœ‰2ç§è®¤è¯æ–¹å¼ï¼Œç”Ÿæˆä¸€ä¸ªæŒ‡å®šçš„æ–‡ä»¶è®©letsencryptè®¿é—®ã€‚æˆ–è€…ç”Ÿæˆä¸€ä¸ªDNSè®°å½•è®©letsencryptè®¿é—®ã€‚ç¬¬ä¸€ç§æ–¹å¼æœ‰éå¸¸å¤§çš„å±€é™æ€§ã€‚æ¯”å¦‚ä½ çš„80ç«¯å£æ­£åœ¨è¢«ä½¿ç”¨ã€‚é‚£ä¹ˆä½ éœ€è¦å…ˆè®¾ç½®DNSè§£æï¼Œå†ä¿®æ”¹ä¸‹nginxçš„é…ç½®è®©ç½‘å€èƒ½å¤Ÿè¢«æ­£å¸¸è®¿é—®åˆ°ã€‚è¿™å°±æ˜¾å¾—å¾ˆéº»çƒ¦äº†ã€‚ä¸»æµçš„DNSæœåŠ¡æä¾›å•†éƒ½å·²ç»æä¾›äº†APIæ¥å£ï¼Œä½¿ç”¨DNSçš„ä¼˜åŠ¿å°±æ˜¯ï¼š</p>
<ol>
<li>ä»»ä½•ç”µè„‘éƒ½èƒ½ç›´æ¥ç”Ÿæˆè¯ä¹¦æ–‡ä»¶ï¼Œä¸éœ€è¦ä¾èµ–æœ¬æœºèƒ½å¤Ÿè¢«å¤–éƒ¨è®¿é—®</li>
<li>ä¸éœ€è¦å¯¹nginxåšä»»ä½•è®¾ç½®</li>
</ol>
<p>ä»¥ä¸‹è®°å½•ä¸‹æˆ‘ä½¿ç”¨ä¸€ä¸ªä¸´æ—¶çš„digitaloceanæœºå™¨ä»0å¼€å§‹éƒ¨ç½²httpsçš„æ­¥éª¤(å‡è®¾æµ‹è¯•urlä¸ºssl.ficapy.com,æ“ä½œç¯å¢ƒä¸ºosx)</p>
<p>æˆ‘è¿˜æ˜¯è¦å®‰åˆ©ä¸‹ï¼Œä¸´æ—¶ä½¿ç”¨digitaloceanæµ‹è¯•ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·tugboatç°å¸¸å¥½å•Š</p>
<ol>
<li><p>å®‰è£…tugboatç”¨å‘½ä»¤è¡Œå¿«é€Ÿåˆ›å»ºæœºå™¨ä»¥åŠæµ‹è¯•å®Œæˆååˆ é™¤</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gem install tugboat</div></pre></td></tr></table></figure>
</li>
<li><p>å°†digitaloceançš„apiå†™å…¥è®©tugboatèƒ½å¤Ÿæ­£å¸¸ä½¿ç”¨,å¹¶æ‰§è¡Œä¸€äº›åˆå§‹åŒ–è®¾ç½®</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tugboat authorize</div></pre></td></tr></table></figure>
</li>
<li><p>æ ¹æ®åˆå§‹åŒ–é»˜è®¤è®¾ç½®åˆ›å»ºä¸€ä¸ªvps</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tugboat create temp</div></pre></td></tr></table></figure>
</li>
<li><p>sshç™»é™†</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tugboat ssh temp</div></pre></td></tr></table></figure>
</li>
<li><p>å®‰è£…acme.sh</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl https://get.acme.sh | sh</div></pre></td></tr></table></figure>
</li>
<li><p>å‚ç…§acme.shæ–‡æ¡£å°†dnsçš„apiä¿¡æ¯ä½œä¸ºç¯å¢ƒå˜é‡å†™å…¥(è®°å¾—æ‰§è¡Œsource ~/.bashrc)</p>
</li>
<li><p>ç”Ÿæˆè¯ä¹¦</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">acme.sh --issue --dns dns_cf -d ssl.ficapy.com --debug</div></pre></td></tr></table></figure>
</li>
<li><p>å°†è¯ä¹¦æ”¾ç½®åˆ°ä½ç½®å¹¶è®¾ç½®nginxé‡å¯å‘½ä»¤</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">acme.sh --installcert -d ssl.ficapy.com \</div><div class="line">           --keypath       /etc/nginx/ssl/ssl.ficapy.com.key  \</div><div class="line">           --fullchainpath /etc/nginx/ssl/ssl.ficapy.com.pem \</div><div class="line">           --reloadcmd     &quot;service nginx force-reload&quot;</div></pre></td></tr></table></figure>
</li>
<li><p>å¼ºåˆ¶æµ‹è¯•ç»­çº¦(è¯¥æ“ä½œä¼šè‡ªåŠ¨æ‰§è¡Œæ³¨å†Œè¿‡çš„äº‹ä»¶ï¼Œä¸€èˆ¬å°±æ˜¯é‡å¯nginxå’¯ï¼Œç»­çº¦keyæ˜¯ä¸ä¼šå˜çš„ï¼Œå˜çš„æ˜¯fullchain.ceræ–‡ä»¶)</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">acme.sh --renew-all --force</div></pre></td></tr></table></figure>
</li>
<li><p>ç”Ÿæˆdhparamæ–‡ä»¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl dhparam -out /etc/nginx/ssl/dhparam.pem 2048</div></pre></td></tr></table></figure>
</li>
<li><p>ä½¿ç”¨ç”Ÿæˆä¸€ä¸ªæ ‡å‡†çš„nginxé…ç½®æ–‡ä»¶å¹¶æ”¾å…¥/etc/nginx/site-enablesç›®å½•ï¼Œç¤ºä¾‹å¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">    server &#123;</div><div class="line">    listen 443 ssl;</div><div class="line"></div><div class="line">    server_name ssl.ficapy.com;</div><div class="line">    # certs sent to the client in SERVER HELLO are concatenated in ssl_certificate</div><div class="line">    ssl_certificate /etc/nginx/ssl/ssl.ficapy.com.pem;</div><div class="line">    ssl_certificate_key /etc/nginx/ssl/ssl.ficapy.com.key;</div><div class="line">    ssl_session_timeout 1d;</div><div class="line">    ssl_session_cache shared:SSL:50m;</div><div class="line"></div><div class="line"></div><div class="line">    # Diffie-Hellman parameter for DHE ciphersuites, recommended 2048 bits</div><div class="line">    ssl_dhparam /etc/nginx/ssl/dhparam.pem;</div><div class="line"></div><div class="line">    # intermediate configuration. tweak to your needs.</div><div class="line">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</div><div class="line">    ssl_ciphers &apos;ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS&apos;;</div><div class="line">    ssl_prefer_server_ciphers on;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>æœ€åå°±æ˜¯æµè§ˆå™¨è®¿é—®ä»¥ä¸‹æµ‹è¯•å®Œæ¯•å•¦ã€‚å¦‚æœå‡ºç°é”™è¯¯å¯ä»¥æŸ¥çœ‹nginxçš„æ—¥å¿—/var/log/error.logï¼Œè‚¯å®šæ˜¯å“ªä¸€æ­¥å‡ºé—®é¢˜å•¦ï¼Œæœ€åå°±æ˜¯æµ‹è¯•å®Œæ¯•ååˆ é™¤vpså•¦<code>tugboat destory temp</code></p>
</li>
</ol>
<p>é¢å¤–è¯´ä¸€ä¸‹å…¶ä»–çš„å§ã€‚æœ€å¼€å§‹æˆ‘è¯•è¿‡é˜¿é‡Œäº‘dnsçš„apiï¼Œç”¨çš„æ˜¯å­è´¦å·ã€‚ç»“æœå­è´¦å·æ˜¯æ— æ³•åŒ…å«(æ³¨æ„)dnsçš„æ“ä½œæƒé™çš„ï¼Œå°±æ€»æ˜¯å¤±è´¥ã€‚åæ¥ä¸ç”¨å­è´¦å·ï¼Œç›´æ¥ç”¨åŸè´¦å·çš„apiå¯†åŒ™å°±å®Œå…¨æ²¡é—®é¢˜å•¦~~~ã€‚å¦å¤–å„å¤§äº‘å¹³å°å¤§å¤šéƒ½æœ‰è´Ÿè½½å‡è¡¡å™¨ï¼Œç„¶åå¯ä»¥å¡«å†™httpsè¯ä¹¦ã€‚è¿™ç§å°±ä¸å¤ªé€‚åˆletsencryptè¿™ç§çŸ­æœŸè¯ä¹¦äº†ã€‚å¦åˆ™æ€»ä¸Šå»æ¢è¯ä¹¦ä¸è¢«éº»çƒ¦æ­»ã€‚å¦‚æœåœ¨è¿™ç§è´Ÿè½½å‡è¡¡å™¨ä¸Šä¸è®¾ç½®httpsè¯ä¹¦ã€‚é‚£ä¹ˆå°±éœ€è¦åœ¨è´Ÿè½½å‡è¡¡å™¨æ¯ä¸€å°æœºå™¨éƒ½è®¾ç½®ä¸Šhttpsè¯ä¹¦ï¼Œå—¯æƒ³æƒ³ä¹ŸæŒºå¤´å¤§å•Š~~~ï¼Œæ‰€ä»¥è¿™ç§è‡ªåŠ¨åŒ–æ–¹å¼åªæ¯”è¾ƒé€‚åˆåœ¨ä¸€å°æœºå™¨ä¸Šç”Ÿæˆå¹¶ç»´æŠ¤è¯ä¹¦</p>
<p>å†é¢å¤–ï¼Œå“ªä¸ªæ—¶å€™å†™ä¸ªAnsibleçš„playbookå°±å¥½å“’ï¼Œå¯èƒ½ä¼šæ›´åŠ æ–¹ä¾¿â”‘(ï¿£Ğ” ï¿£)â”</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://github.com/pearkes/tugboat">github tugboat</a><br><a href="https://mozilla.github.io/server-side-tls/ssl-config-generator/">mozilla ssl-config-generator</a><br><a href="https://ruby-china.org/topics/31983">ä½¿ç”¨ acme.sh ç»™ Nginx å®‰è£… Letâ€™ s Encrypt æä¾›çš„å…è´¹ SSL è¯ä¹¦</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;letsencryptåˆšå‡ºæ¥çš„æ—¶å€™å†™äº†ä¸€ç¯‡å®ƒçš„è®¤è¯ç­¾å‘åŸç†ã€‚è‡ªé‚£è¿‡åå°±æ²¡æœ‰çœŸæ­£çš„å»å®è·µè¿‡äº†ã€‚æœ€è¿‘æœ‰éƒ¨ç½²HTTPSçš„éœ€æ±‚å°±åˆè€ƒå¯Ÿäº†ä¸€ç•ªã€‚å‘ç°acme.shç°å¸¸å¥½ç”¨å•Š~~~ï¼Œæ¥ä¸€ç¯‡æ°´æ–‡è®°å½•ä¸‹æµ‹è¯•éƒ¨ç½²HTTPSçš„å®Œæ•´è¿‡ç¨‹å§&lt;/p&gt;
    
    </summary>
    
      <category term="DevOps" scheme="https://www.zoulei.net/categories/DevOps/"/>
    
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨pre-commitæ”¹è¿›ä»£ç é£æ ¼</title>
    <link href="https://www.zoulei.net/2017/03/04/pre_commit/"/>
    <id>https://www.zoulei.net/2017/03/04/pre_commit/</id>
    <published>2017-03-04T04:52:37.000Z</published>
    <updated>2017-03-04T10:44:07.000Z</updated>
    
    <content type="html"><![CDATA[<p>å¾ˆæ—©å°±ä½¿ç”¨è¿‡autopep8æ¥è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç ï¼Œä½¿ç”¨IDEçš„æ—¶å€™ä¹Ÿä¼šç»å¸¸ä½¿ç”¨æ ¼å¼åŒ–ä»£ç åŠŸèƒ½è®©ä»£ç æ›´ç¬¦åˆè§„èŒƒä¸€ç‚¹ã€‚å¯æ˜¯è¿™éƒ½ä¸æ˜¯è‡ªåŠ¨åŒ–çš„ï¼Œæˆ–è€…è¯´æ˜¯å¼ºåˆ¶çš„ã€‚ä¸ºäº†ä¿æŒå›¢é˜Ÿçš„è‰¯å¥½ä»£ç é£æ ¼æ„Ÿè§‰æ¯ä¸ªåŒäº‹åœ¨æäº¤ä»£ç ä¹‹å‰éƒ½è‡ªåŠ¨è¿›è¡Œæ ¼å¼åŒ–æˆ–è€…é£æ ¼æ£€æŸ¥æ˜¯ä¸€ä¸ªä¸é”™çš„ä¸»æ„ï¼Œäºæ˜¯æ‰¾åˆ°äº†<a href="http://pre-commit.com/">pre-commit</a></p>
<p>åŸç†ä¹Ÿè¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œgitè‡ªèº«æä¾›äº†ä¸€äº›hookåŠŸèƒ½ï¼ŒæŸ¥çœ‹git/hooksç›®å½•ä¸‹ä¼šå‘ç°æœ‰ä¸€äº›sampleæ–‡ä»¶ï¼Œè¿™æ ·åœ¨æ‰§è¡Œcommitã€pushã€mergeçš„æ—¶å€™éƒ½æ˜¯å¯ä»¥è¿›è¡Œä¸€äº›ç®€å•çš„æ£€æŸ¥ç­‰åŠŸèƒ½çš„ã€‚ç„¶è€Œè¿™ä¸ªè®¾å®šæœ‰ä¸€ä¸ªç¼ºç‚¹ã€‚æ²¡ä¸€ä¸ªhookåªèƒ½æ‰§è¡Œä¸€ä¸ªæ–‡ä»¶çš„å†…å®¹ï¼Œæ‰€ä»¥è¦ä¹ˆå°†å„ç§åŠŸèƒ½æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œé¢ï¼Œæˆ–è€…æ¯ä¸ªåŠŸèƒ½éƒ½æ”¾ç½®åœ¨å„è‡ªçš„æ–‡ä»¶é‡Œé¢ã€‚æœ€åç”±ä¸€ä¸ªæ–‡ä»¶ä¸€èµ·æ‰§è¡Œã€‚pre-commitå°±è§£å†³äº†æˆ‘ä»¬çš„è¿™ä¸ªæ–‡ä»¶ã€‚å°†ä¸åŒçš„ä»»åŠ¡åˆ†å‰²æˆå•ä¸ªæ–‡ä»¶ã€‚ç„¶ååªéœ€è¦æ·»åŠ åˆ«äººå…±äº«çš„è„šæœ¬å°±èƒ½å¤Ÿå¾ˆå¿«çš„è¿›è¡Œcommit hookäº†ï¼Œç®€è¦ä½¿ç”¨æ–¹æ³•ä¾‹ä¸¾å¦‚ä¸‹</p>
<ol>
<li><p>åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ç¼–å†™é…ç½®æ–‡ä»¶(.pre-commit-config.yaml)</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-   repo: git://github.com/pre-commit/pre-commit-hooks</div><div class="line">    sha: v0.7.1</div><div class="line">    hooks:</div><div class="line">    -   id: trailing-whitespace</div><div class="line">    -   id: autopep8-wrapper</div></pre></td></tr></table></figure>
</li>
<li><p>è¿›è¡Œåˆå§‹åŒ–<code>pre-commit install</code>å°±å¯ä»¥äº†ï¼Œä»¥åæ¯æ¬¡æ‰§è¡Œcommitçš„æ—¶å€™å°±ä¼šæ‰§è¡Œæ£€æŸ¥ã€‚é…ç½®æ–‡ä»¶çš„repoåœ°å€å³ä¸ºç¬¦åˆpre-commitæ¡†æ¶çš„åœ°å€ï¼Œidå³ä¸ºæä¾›çš„åŠŸèƒ½~~ï¼Œè¿˜æ˜¯å¾ˆå¥½ç†è§£çš„ã€‚ä¾‹å¦‚ä»¥ä¸Šæä¾›çš„autopep8-wrapperå°±å¯èƒ½å¤Ÿé…ç½®pep8è§„èŒƒè¿›è¡Œä¸€äº›ä»£ç é£æ ¼æ£€æŸ¥ï¼Œå¦‚æœä¸ç¬¦åˆé£æ ¼å°±ä¼šè‡ªåŠ¨æ ¼å¼åŒ–ã€‚pep8å·¥å…·çš„é»˜è®¤é…ç½®æ–‡ä»¶æ˜¯<code>~/.config/pep8</code></p>
</li>
</ol>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://blog.sideci.com/2015/12/14/style-guide-of-python-and-lint-tool/">About style guide of python and linter tool. pep8, pyflakes, flake8, haking, Pyling.</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¾ˆæ—©å°±ä½¿ç”¨è¿‡autopep8æ¥è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç ï¼Œä½¿ç”¨IDEçš„æ—¶å€™ä¹Ÿä¼šç»å¸¸ä½¿ç”¨æ ¼å¼åŒ–ä»£ç åŠŸèƒ½è®©ä»£ç æ›´ç¬¦åˆè§„èŒƒä¸€ç‚¹ã€‚å¯æ˜¯è¿™éƒ½ä¸æ˜¯è‡ªåŠ¨åŒ–çš„ï¼Œæˆ–è€…è¯´æ˜¯å¼ºåˆ¶çš„ã€‚ä¸ºäº†ä¿æŒå›¢é˜Ÿçš„è‰¯å¥½ä»£ç é£æ ¼æ„Ÿè§‰æ¯ä¸ªåŒäº‹åœ¨æäº¤ä»£ç ä¹‹å‰éƒ½è‡ªåŠ¨è¿›è¡Œæ ¼å¼åŒ–æˆ–è€…é£æ ¼æ£€æŸ¥æ˜¯ä¸€ä¸ªä¸é”™çš„ä¸»æ„ï¼Œäºæ˜¯æ‰¾åˆ°äº†&lt;a href=&quot;
    
    </summary>
    
      <category term="python" scheme="https://www.zoulei.net/categories/python/"/>
    
    
  </entry>
  
  <entry>
    <title>supervisoré‡åˆ°çš„å‘</title>
    <link href="https://www.zoulei.net/2016/12/25/supervisor_may_be_sucks/"/>
    <id>https://www.zoulei.net/2016/12/25/supervisor_may_be_sucks/</id>
    <published>2016-12-25T12:01:43.000Z</published>
    <updated>2017-01-11T08:02:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>å†™å‡ æ¡è‡ªå·±ç”¨supervisoré‡åˆ°çš„ä¸€äº›å°å‘</p>
<ol>
<li><a href="https://python3wos.appspot.com/">Python 3 Wall</a>çš„åæ´¾ä»£è¡¨ï¼Œä¸€ç›´ä¸èƒ½ä½¿ç”¨python3å®‰è£…</li>
<li>å¯¹ä¸­æ–‡è¾“å‡ºæ”¯æŒå¥‡å·®ï¼Œä¼°è®¡æ˜¯ä½¿ç”¨python2é€ æˆçš„ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚ä½ è¦åœ¨python2é‡Œé¢printè¾“å‡ºä¸€ä¸ªunicodeä¸­æ–‡å­—ç¬¦ã€‚æˆ‘è¯•äº†å„ç§åŠæ³•ï¼Œå‡æ— è§£(å’Œsupervisorä½¿ç”¨å­è¿›ç¨‹è¿è¡Œç¨‹åºçš„ç­–ç•¥æœ‰å…³),å¥½åœ¨ä½¿ç”¨loggingæ¨¡å—è¾“å‡ºä¸­æ–‡å±…ç„¶æ²¡å•¥é—®é¢˜-_-ï¼Œæ­£å¼è¿è¡Œç¯å¢ƒä¹Ÿæ˜¯å…¨éƒ¨ä½¿ç”¨loggingä»£æ›¿print</li>
<li>å³ä½¿ç”¨python3ï¼Œè¾“å‡ºä¸­æ–‡ä¹Ÿä¼šé‡åˆ°é—®é¢˜,éœ€è¦åœ¨é…ç½®æ–‡ä»¶æ·»åŠ <code>environment=LANG=&quot;en_US.utf8&quot;, LC_ALL=&quot;en_US.UTF-8&quot;, LC_LANG=&quot;en_US.UTF-8&quot;</code>è§£å†³</li>
<li>å†™é…ç½®æ–‡ä»¶çš„æ—¶å€™ä¸€ä¸ªå˜é‡ä¸èƒ½é…ç½®å¤šè¡Œ,æˆ‘ä¸€å¼€å§‹å› ä¸ºenvironmentå¤ªé•¿ã€‚å†™äº†2è¡Œï¼Œå¯¼è‡´åé¢çš„æ²¡ç”Ÿæ•ˆï¼ŒæŠ˜è…¾å¥½ä¹…</li>
<li>ä¿®æ”¹supervisoré…ç½®æ–‡ä»¶åï¼Œå¦‚æœé…ç½®æ–‡ä»¶é”™äº†ï¼Œä¸ä¼šæŠ¥é”™ï¼è€Œä¸”supervisoræ²¡æœ‰å·¥å…·èƒ½å¯¹é…ç½®æ–‡ä»¶çš„æ­£ç¡®æ€§è¿›è¡Œæ£€æŸ¥ï¼Œç°å¸¸æ“è›‹å•Šï¼</li>
<li>supervisorå¯ä»¥æ£€æŸ¥åˆ°å¼‚å¸¸è‡ªåŠ¨é‡å¯å¹¶è®¾ç½®æœ€å¤§é‡å¯æ¬¡æ•°ï¼Œå¯æ˜¯æœ‰æ—¶å€™ä¼šé€ æˆæ— é™é‡å¯è¿™ç§æƒ…å†µã€‚å› ä¸ºé‡å¯åç«‹åˆ»é€€å‡ºæ‰ä¼šè§¦å‘æœ€å¤§é‡å¯æ¬¡æ•°æœºåˆ¶ï¼Œå‡å¦‚ç¨‹åºä¸€ç›´æ˜¯è¿è¡Œäº†ååˆ†é’Ÿè‡ªåŠ¨é€€å‡ºã€‚é‚£ä¹ˆä¼šé€ æˆæ— é™é‡å¯ï¼Œå¯ä»¥ä½¿ç”¨å®ƒçš„apiå†™ä¸€ä¸ªè„šæœ¬ç›‘æ§è¿™ç§æƒ…å†µï¼Œè¿›è¡Œè­¦å‘Š</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> xmlrpc.client</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_time</span><span class="params">(name: str, interval: int, times: int)</span>:</span></div><div class="line">    s = xmlrpc.client.ServerProxy(<span class="string">'http://localhost:9001'</span>)</div><div class="line">    <span class="keyword">if</span> s.supervisor.getProcessInfo(name).get(<span class="string">'statename'</span>) != <span class="string">'RUNNING'</span>:</div><div class="line">        <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">    context = s.supervisor.readLog(<span class="number">0</span>, <span class="number">10</span> * <span class="number">1024</span> * <span class="number">100</span>)</div><div class="line">    context = filter(<span class="keyword">lambda</span> x: name <span class="keyword">in</span> x <span class="keyword">and</span> <span class="string">'spawn'</span> <span class="keyword">in</span> x, context.splitlines())</div><div class="line">    context = map(<span class="keyword">lambda</span> x: datetime.strptime(x[:<span class="number">19</span>], <span class="string">'%Y-%m-%d %H:%M:%S'</span>), context)</div><div class="line">    context = list(filter(<span class="keyword">lambda</span> x: x + timedelta(minutes=interval) &gt; datetime.now(), context))</div><div class="line">    <span class="keyword">return</span> (len(context) &gt; times) <span class="keyword">and</span> len(context)</div></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://in355hz.iteye.com/blog/1860787">ä¹Ÿè°ˆ Python çš„ä¸­æ–‡ç¼–ç å¤„ç†</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å†™å‡ æ¡è‡ªå·±ç”¨supervisoré‡åˆ°çš„ä¸€äº›å°å‘&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;https://python3wos.appspot.com/&quot;&gt;Python 3 Wall&lt;/a&gt;çš„åæ´¾ä»£è¡¨ï¼Œä¸€ç›´ä¸èƒ½ä½¿ç”¨python3å®‰è£…&lt;/li&gt;
&lt;li&gt;å¯¹ä¸­æ–‡è¾“å‡ºæ”¯æŒå¥‡å·®ï¼Œ
    
    </summary>
    
      <category term="python" scheme="https://www.zoulei.net/categories/python/"/>
    
    
  </entry>
  
  <entry>
    <title>åŠè‡ªåŠ¨åˆ·ç½‘ç»œè¯¾ç¨‹</title>
    <link href="https://www.zoulei.net/2016/11/08/network_course_pass/"/>
    <id>https://www.zoulei.net/2016/11/08/network_course_pass/</id>
    <published>2016-11-08T14:04:28.000Z</published>
    <updated>2016-11-08T14:04:33.000Z</updated>
    
    <content type="html"><![CDATA[<p>åˆ·ä¸€ä¸ªç½‘ç»œè¯¾ç¨‹ï¼Œå¾ˆå¸¸è§çš„é‚£ç§ï¼Œæ’­æ”¾è§†é¢‘ç»Ÿè®¡è§‚çœ‹æ—¶é•¿ã€‚ä¸è¿‡è¯¥ç³»ç»Ÿæ¯”è¾ƒå¼±ï¼Œå³ä½¿åˆ‡æ¢åˆ°åˆ«çš„é¡µé¢ä¸€æ ·ä¹Ÿä¼šè®¡ç®—æ—¶é•¿ã€‚é™åˆ¶æ¡ä»¶åªæ˜¯å¶å°”ä¼šå‡ºç°ä¸€äº›é—®ç­”é¢˜è®©è§†é¢‘æš‚åœä¸”ä¸€ä¸ªè§†é¢‘æ’­æ”¾å®Œæˆåä¸ä¼šè‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€ä¸ªè§†é¢‘ã€‚æœ€å¼€å§‹æ˜¯æ‰“ç®—ç›´æ¥æ¨¡æ‹Ÿå‘é€httpè¯·æ±‚ï¼Œä¸è¿‡åé¢æ„Ÿè§‰æˆ–è®¸æœ‰å‘å°±é€‰äº†å¦å¤–ä¸€ç§åŠæ³•ã€‚è®²è¯¾è‚¯å®šæ˜¯æœ‰å£°éŸ³çš„ï¼Œç”¨ç¨‹åºå»æ•è·å£°éŸ³ï¼Œå¦‚æœäº”ç§’é’Ÿæ²¡æœ‰å£°éŸ³åˆ™è®¤ä¸ºæœ‰é—®ç­”é¢˜å‡ºç°æˆ–è€…è¯¥ç« èŠ‚è®²å®Œäº†ã€‚</p>
<a id="more"></a>
<h3 id="æ¨¡æ‹Ÿè¯·æ±‚æ³•"><a href="#æ¨¡æ‹Ÿè¯·æ±‚æ³•" class="headerlink" title="æ¨¡æ‹Ÿè¯·æ±‚æ³•"></a>æ¨¡æ‹Ÿè¯·æ±‚æ³•</h3><p>é€šè¿‡chromeå¼€å‘è€…å·¥å…·å¯ä»¥çŸ¥é“æ¯60ç§’ä¼šå‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œå¤§æ¦‚å¦‚ä¸‹(æŸäº›ä¿¡æ¯*å·æ›¿ä»£)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">POST /home/scorm/rte?cmd=submit&amp;token=68&amp;uid=null&amp;cwid=20&amp;eplanid=17245&amp;dig=************ HTTP/1.1</div><div class="line">Host: ******</div><div class="line">Connection: keep-alive</div><div class="line">Content-Length: 58</div><div class="line">Pragma: no-cache</div><div class="line">Cache-Control: no-cache</div><div class="line">Origin: *********</div><div class="line">X-Requested-With: ShockwaveFlash/23.0.0.205</div><div class="line">User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.71 Safari/537.36</div><div class="line">Content-Type: text/xml</div><div class="line">Accept: */*</div><div class="line">Referer: *****htmlv1player_template_index.swf?1478605419919</div><div class="line">Accept-Encoding: gzip, deflate</div><div class="line">Accept-Language: zh-CN,zh;q=0.8</div><div class="line">Cookie: *********</div><div class="line"></div><div class="line">cmd:submit</div><div class="line">token:68</div><div class="line">uid:null</div><div class="line">cwid:20</div><div class="line">eplanid:17245</div><div class="line">dig:*****</div></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°cookieä¿¡æ¯ç™»å½•åå°±ä¼šæœ‰ï¼Œè¦æ‹¼å‡‘å‡ºä»¥ä¸Šä¿¡æ¯åªéœ€è¦çŸ¥é“digæ˜¯å¦‚ä½•äº§ç”Ÿçš„ã€‚ä»X-Requested-With: ShockwaveFlash/23.0.0.205æˆ‘ä»¬å°±èƒ½çœ‹å‡ºæ¥æ˜¯flashå‘é€çš„ï¼Œç„¶åä¸‹è½½é¡µé¢çš„swfæ–‡ä»¶è¿›è¡Œåç¼–è¯‘å°±èƒ½çŸ¥é“digäº§ç”Ÿçš„é€»è¾‘ã€‚æŠŠswfæ–‡ä»¶æ”¾å…¥<a href="http://www.showmycode.com/">http://www.showmycode.com/</a>å°±èƒ½çœ‹åˆ°äº§ç”Ÿçš„é€»è¾‘äº†ã€‚ä¸è¿‡æˆ‘ä¸ä¼šasï¼Œä»–äº§ç”Ÿçš„ä»£ç ä¹Ÿå¼‚å¸¸ç³Ÿç³•ï¼Œæˆªå–ä¸€æ®µå¦‚ä¸‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">md5String = (md5String + _md5PrivateKey);</div><div class="line">md5String = MD5.hash(md5String);</div><div class="line">req = new URLRequest((_serviceUrlHasQuery) ? ((((((((((_serviceUrl + &quot;&amp;cmd=submit&amp;token=&quot;) + _token) + &quot;&amp;uid=&quot;) + _uid) + &quot;&amp;cwid=&quot;) + _cwid) + &quot;&amp;eplanid=&quot;) + _cplanid) + &quot;&amp;dig=&quot;) + md5String) : ((((((((((_serviceUrl + &quot;?cmd=submit&amp;token=&quot;) + _token) + &quot;&amp;uid=&quot;) + _uid) + &quot;&amp;cwid=&quot;) + _cwid) + &quot;&amp;eplanid=&quot;) + _cplanid) + &quot;&amp;dig=&quot;) + md5String));</div><div class="line">req.method = URLRequestMethod.POST;</div><div class="line">req.contentType = &quot;text/xml&quot;;</div><div class="line">_currentSubmitData = xml;</div><div class="line">req.data = xml;</div><div class="line">_urlLoader.load(req);</div></pre></td></tr></table></figure></p>
<p>å¦‚æœä½ å¯¹aséå¸¸ç†Ÿæ‚‰çœ‹èµ·æ¥ä¼°è®¡æ²¡å•¥é—®é¢˜ã€‚å¯æ˜¯æœ‰æ›´å¥½çš„æ–¹æ¡ˆã€‚å¼€æºè½¯ä»¶<a href="https://github.com/jindrapetrik/jpexs-decompiler">jpexs-decompiler</a>.è€Œä¸”å±…ç„¶æœ‰ä¸­æ–‡è¯­è¨€åŒ…ã€‚å¾ˆç‰›çš„ä¸€ç‚¹å°±æ˜¯å®ƒèƒ½å¤Ÿç›´æ¥ç¼–è¾‘ç¼–åç¼–è¯‘åçš„ä»£ç å†é‡æ–°æ‰“åŒ…ï¼Œå¯ä»¥çœ‹çœ‹å®ƒç”Ÿæˆçš„ä»£ç <br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">this._token++;</div><div class="line">md5String = this._token + &quot;&quot; + this._uid + &quot;&quot; + this._cwid + &quot;&quot; + this._cplanid + &quot;&quot; + tmpTime;</div><div class="line">xml = &quot;&lt;request lastAccess=\&quot;&quot; + this._lastAccess + &quot;\&quot; sessionTime=\&quot;&quot; + tmpTime + &quot;\&quot;&gt;&quot;;</div><div class="line">for each(tmpObj in tmpHash)</div><div class="line">&#123;</div><div class="line">   if(tmpHash[&quot;sco_&quot; + tmpObj.id] == null)</div><div class="line">   &#123;</div><div class="line">      tmpObj2 = this._tracksHash[&quot;sco_&quot; + tmpObj.id];</div><div class="line">      if(tmpObj2 != null)</div><div class="line">      &#123;</div><div class="line">         xml = xml + &quot;&lt;item id=\&quot;&quot; + tmpObj2.id + &quot;\&quot; score=\&quot;&quot; + tmpObj2.score + &quot;\&quot; time=\&quot;&quot; + tmpObj2.time + &quot;\&quot;/&gt;&quot;;</div><div class="line">         tmpHash[&quot;sco_&quot; + tmpObj.id] = tmpObj2;</div><div class="line">         md5String = md5String + tmpObj2.id + tmpObj2.score;</div><div class="line">      &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">for each(objTemp in tmpHash)</div><div class="line">&#123;</div><div class="line">   xml = xml + &quot;&lt;item id=\&quot;&quot; + objTemp.id + &quot;\&quot; complete=\&quot;&quot; + objTemp.complete + &quot;\&quot; type=\&quot;obj\&quot;/&gt;&quot;;</div><div class="line">&#125;</div><div class="line">xml = xml + &quot;&lt;/request&gt;&quot;;</div><div class="line">this._cmd = &quot;submit&quot;;</div><div class="line">md5String = md5String + this._md5PrivateKey;</div><div class="line">ExternalInterface.call(&quot;console.log&quot;,md5String);</div><div class="line">md5String = MD5.hash(md5String);</div><div class="line">req = new URLRequest(!!this._serviceUrlHasQuery?this._serviceUrl + &quot;&amp;cmd=submit&amp;token=&quot; + this._token + &quot;&amp;uid=&quot; + this._uid + &quot;&amp;cwid=&quot; + this._cwid + &quot;&amp;eplanid=&quot; + this._cplanid + &quot;&amp;dig=&quot; + md5String:this._serviceUrl + &quot;?cmd=submit&amp;token=&quot; + this._token + &quot;&amp;uid=&quot; + this._uid + &quot;&amp;cwid=&quot; + this._cwid + &quot;&amp;eplanid=&quot; + this._cplanid + &quot;&amp;dig=&quot; + md5String);</div><div class="line">req.method = URLRequestMethod.POST;</div><div class="line">req.contentType = &quot;text/xml&quot;;</div><div class="line">this._currentSubmitData = xml;</div><div class="line">req.data = xml;</div><div class="line">this._urlLoader.load(req);</div></pre></td></tr></table></figure></p>
<p>è¿™æ ·çœ‹èµ·æ¥å°±å¾ˆå®¹æ˜“ç†è§£äº†ï¼Œå†™æˆpythonä»£ç å¤§æ¦‚å°±æ˜¯è¿™æ ·å­(åç¼–è¯‘åå¯ä»¥çœ‹åˆ°key)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Request Payload</span></div><div class="line"><span class="comment"># &lt;request lastAccess="ch_00_02" sessionTime="60"&gt;&lt;/request&gt;</span></div><div class="line"><span class="comment"># &lt;response success="true"&gt;</span></div><div class="line"><span class="comment"># &lt;item complete="0" id="ch_00_02" score="0.0" time="2249" /&gt;</span></div><div class="line"><span class="comment"># &lt;/response&gt;</span></div><div class="line"><span class="comment"># &lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;response success="true"&gt;&lt;item complete="0" id="ch_00_02" score="0.0" time="2249"/&gt;&lt;/response&gt;</span></div><div class="line"></div><div class="line"><span class="comment"># http://***?cmd=submit&amp;token=5&amp;uid=null&amp;cwid=67&amp;eplanid=17242&amp;dig=*****</span></div><div class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</div><div class="line">pri = <span class="string">'#Huaxia$RTE-*PP'</span></div><div class="line">a = <span class="string">'1null671724260#Huaxia$RTE-*PP'</span></div><div class="line">b = md5(a).hexdigest()</div></pre></td></tr></table></figure><br>å¦å¤–å¦‚æœé‡åˆ°ä»€ä¹ˆç–‘æƒ‘å¯ä»¥ç›´æ¥<code>ExternalInterface.call(&quot;console.log&quot;,md5String);</code>è¿™æ ·èƒ½å¤Ÿè¾“å‡ºå˜é‡ã€‚é‡æ–°æ‰“åŒ…ä¸ºswfï¼Œå†ç”¨fiddleræ›¿æ¢æ‰è¯·æ±‚çš„swfæ–‡ä»¶ä¸ºè‡ªå·±æ‰“åŒ…çš„æ–‡ä»¶ï¼Œè¿™æ ·å°±èƒ½çœ‹åˆ°è°ƒè¯•è¾“å‡ºäº†ã€‚æ„Ÿæ…¨ä¸‹è¿™ä¸ªå·¥å…·çœŸå¥½ç”¨ï¼Œä¸è¿‡æœ¬äººä¸æ˜¯æå‰ç«¯çš„ï¼Œè€Œä¸”flashä¹Ÿå·²ç»æ²¡è½åˆ°æ²¡æœ‰å»æ·±å…¥çš„å¿…è¦â”‘(ï¿£Ğ” ï¿£)â”</p>
<h3 id="åˆ¤æ–­è§†é¢‘æ˜¯å¦æ’­æ”¾å®ŒæˆåŠè‡ªåŠ¨åŒ–"><a href="#åˆ¤æ–­è§†é¢‘æ˜¯å¦æ’­æ”¾å®ŒæˆåŠè‡ªåŠ¨åŒ–" class="headerlink" title="åˆ¤æ–­è§†é¢‘æ˜¯å¦æ’­æ”¾å®ŒæˆåŠè‡ªåŠ¨åŒ–"></a>åˆ¤æ–­è§†é¢‘æ˜¯å¦æ’­æ”¾å®ŒæˆåŠè‡ªåŠ¨åŒ–</h3><p>æˆ‘åˆ¤æ–­çš„ä¾æ®æ˜¯æ²¡æœ‰å£°éŸ³äº†ï¼Œéœ€è¦è§£å†³çš„å°±æ˜¯è·å–å½“å‰éŸ³é‡å¤§å°çš„é—®é¢˜ã€‚æœ€å¼€å§‹æƒ³çš„æ˜¯ä½¿ç”¨ç³»ç»Ÿçš„å‘½ä»¤è¡Œæ¥å£ï¼Œæ— å¥ˆå¹¶æ²¡æœ‰æ‰¾åˆ°ï¼Œè€Œåçœ‹åˆ°äº†ä½¿ç”¨è™šæ‹ŸéŸ³é¢‘æ¥å£<a href="https://github.com/mattingalls/Soundflower">Soundflower</a>,è™½ç„¶2å¹´æ²¡æ›´æ–°è¿‡äº†ï¼ŒæƒŠå¥‡çš„æ˜¯èƒ½æ­£å¸¸ä½¿ç”¨ã€‚å®‰è£…ä¸Šä¹‹ååœ¨soundé‡Œé¢çš„inputå’Œoutputä¼šå¤šå‡º2ä¸ªè®¾å¤‡ï¼Œå¦‚å›¾<img src="https://ficapy.b0.upaiyun.com/blogimg/soundflower.png" alt="soundflower">,å½“ä½ éœ€è¦æ•è·ç³»ç»Ÿå£°éŸ³çš„æ—¶å€™å°†inputå’Œoutputå‡é€‰ä¸ºåŒä¸€ä¸ª(è¿™æ ·ä¼šå¯¼è‡´æœºå™¨æ²¡æœ‰å£°éŸ³è¾“å‡ºï¼Œéœ€è¦é€‰æ‹©åŒä¸€ä¸ªçš„åŸå› æˆ‘è§‰å¾—æ˜¯ä»£ç ä¸­æ ¹æ®inputçš„æ–‡ä»¶æè¿°ç¬¦æ¥è·å¾—output,æ‰€ä»¥éœ€è¦å°†inputå’Œoutputé€‰ä¸ºåŒä¸€ä¸ª)ï¼Œç„¶è€Œæˆ‘å•ç‹¬å¼€äº†ä¸€ä¸ªwindowsè™šæ‹Ÿæœºï¼Œè™šæ‹Ÿæœºå¯ä»¥é€‰æ‹©ä½¿ç”¨å“ªä¸ªè¾“å…¥è¾“å‡ºéŸ³é¢‘æ¥å£ï¼Œå¯¹äºè™šæ‹Ÿæœºçš„è¾“å‡ºæˆ‘é€‰æ‹©äº†soundflowerï¼Œåœ¨ç³»ç»Ÿè®¾ç½®é‡Œé¢æˆ‘é€‰æ‹©äº†ç›¸åŒçš„soundeflowerä½œä¸ºè¾“å…¥ã€‚å¯æ˜¯é€‰æ‹©äº†æ­£å¸¸çš„æ¥å£ä½œä¸ºè¾“å‡ºã€‚å¦‚æ­¤æˆ‘å¬ä¸åˆ°è™šæ‹Ÿæœºå‘å‡ºçš„å£°éŸ³ï¼ŒåŒæ—¶æœ¬æœºå‘å‡ºçš„å£°éŸ³åˆå¯ä»¥æ­£å¸¸æ”¶å¬ï¼Œå®Œç¾~~~<br>ä»£ç å¦‚ä¸‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">import time</div><div class="line">import pyaudio</div><div class="line">import audioop</div><div class="line">from collections import deque</div><div class="line">from subprocess import Popen</div><div class="line"></div><div class="line">FORMAT = pyaudio.paInt16</div><div class="line">CHANNELS = 2</div><div class="line">RATE = 44100</div><div class="line">CHUNK = 1024</div><div class="line"></div><div class="line">audio = pyaudio.PyAudio()</div><div class="line"></div><div class="line">stream = audio.open(format=FORMAT, channels=CHANNELS,</div><div class="line">                    rate=RATE, input=True,</div><div class="line">                    frames_per_buffer=CHUNK)</div><div class="line"></div><div class="line">flag = time.time()</div><div class="line">queue = deque(maxlen=5)</div><div class="line">while True:</div><div class="line">    data = stream.read(CHUNK)</div><div class="line">    if time.time() - flag &gt; 1:</div><div class="line">        flag = time.time()</div><div class="line">        rms = audioop.rms(data, 2)</div><div class="line">        print rms</div><div class="line">        queue.append(rms)</div><div class="line">        if len(queue) == 5 and sum(queue) == 0:</div><div class="line">            Popen(&quot;&quot;&quot;/usr/bin/osascript -e &apos;display notification &quot;look here&quot; &apos;&quot;&quot;&quot;, shell=True)</div></pre></td></tr></table></figure></p>
<p>å½“äº”ç§’é’Ÿæ²¡æœ‰å£°éŸ³å°±åœ¨å±å¹•å³ä¸Šè§’å¼¹å‡ºä¸€ä¸ªæç¤ºæ¡†æé†’ä½ å»ç‚¹å‡»ã€‚æœ¬æ–‡ç”¨äºosxç³»ç»Ÿï¼Œå…¶ä»–ç³»ç»ŸæŒ‰ç…§è¿™ä¸ªæ€è·¯åº”è¯¥ä¹Ÿèƒ½å®ç°</p>
<h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><p>å½“ç„¶è¿™ä¸ªç³»ç»Ÿè¿˜æœ‰å¾ˆ<code>è´´å¿ƒ</code>çš„åœ°æ–¹ï¼Œå¯¹äºè§†é¢‘è®²è§£ä¸­å‡ºç°çš„é—®ç­”é¢˜ï¼Œå…¶å®åœ¨å‰ç«¯é¡µé¢ä¸­å·²ç»ç»™å‡ºäº†ç­”æ¡ˆï¼Œæ‰“å¼€webæ§åˆ¶å°ï¼ŒæŸ¥çœ‹ä¸€ä¸‹å°±æœ‰å“’ã€‚<br>ç„¶åè¿˜ä¸å…è®¸å¤åˆ¶ç²˜è´´ã€‚è¿™ä¸ªåŒæ ·ç›´æ¥åœ¨æ§åˆ¶å°é‡Œé¢å¤åˆ¶å°±å¥½äº†ï¼Œä¹Ÿæ²¡å¿…è¦ç¦ç”¨jså•¥çš„~~</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://www.christianengvall.se/record-audio-soundflower/">record-audio-soundflower</a><br><a href="http://stackoverflow.com/questions/26478315/getting-volume-levels-from-pyaudio-for-use-in-arduino">getting-volume-levels-from-pyaudio-for-use-in-arduino</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åˆ·ä¸€ä¸ªç½‘ç»œè¯¾ç¨‹ï¼Œå¾ˆå¸¸è§çš„é‚£ç§ï¼Œæ’­æ”¾è§†é¢‘ç»Ÿè®¡è§‚çœ‹æ—¶é•¿ã€‚ä¸è¿‡è¯¥ç³»ç»Ÿæ¯”è¾ƒå¼±ï¼Œå³ä½¿åˆ‡æ¢åˆ°åˆ«çš„é¡µé¢ä¸€æ ·ä¹Ÿä¼šè®¡ç®—æ—¶é•¿ã€‚é™åˆ¶æ¡ä»¶åªæ˜¯å¶å°”ä¼šå‡ºç°ä¸€äº›é—®ç­”é¢˜è®©è§†é¢‘æš‚åœä¸”ä¸€ä¸ªè§†é¢‘æ’­æ”¾å®Œæˆåä¸ä¼šè‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€ä¸ªè§†é¢‘ã€‚æœ€å¼€å§‹æ˜¯æ‰“ç®—ç›´æ¥æ¨¡æ‹Ÿå‘é€httpè¯·æ±‚ï¼Œä¸è¿‡åé¢æ„Ÿè§‰æˆ–è®¸æœ‰å‘å°±é€‰äº†å¦å¤–ä¸€ç§åŠæ³•ã€‚è®²è¯¾è‚¯å®šæ˜¯æœ‰å£°éŸ³çš„ï¼Œç”¨ç¨‹åºå»æ•è·å£°éŸ³ï¼Œå¦‚æœäº”ç§’é’Ÿæ²¡æœ‰å£°éŸ³åˆ™è®¤ä¸ºæœ‰é—®ç­”é¢˜å‡ºç°æˆ–è€…è¯¥ç« èŠ‚è®²å®Œäº†ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="ä¼ªæŠ€æœ¯" scheme="https://www.zoulei.net/categories/%E4%BC%AA%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="python" scheme="https://www.zoulei.net/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>Flaskè·¯ç”±æœºåˆ¶</title>
    <link href="https://www.zoulei.net/2016/09/11/flask_routing_note/"/>
    <id>https://www.zoulei.net/2016/09/11/flask_routing_note/</id>
    <published>2016-09-11T14:06:12.000Z</published>
    <updated>2016-09-11T14:11:49.000Z</updated>
    
    <content type="html"><![CDATA[<p>Flaskå¸…æ°”çš„Hello Worldç¤ºä¾‹è®©äººå°è±¡æ·±åˆ»ã€‚å…¶ä¸­ä½¿ç”¨è£…é¥°å™¨çš„è·¯ç”±å†™æ³•åŠŸä¸å¯æ²¡ï¼Œç”šè‡³ä»¥å‰çœ‹è¿‡ä¸€ä¸ªç³»åˆ—<a href="http://ains.co/blog/things-which-arent-magic-flask-part-1.html">æ²¡é‚£ä¹ˆç¥å¥‡</a>ï¼Œè®²äº†app.routeã€‚æ˜¯çš„ï¼Œå®ƒå¥½åƒå¹¶æ²¡æœ‰é‚£ä¹ˆç¥å¥‡ï¼Œæˆ‘ä¹Ÿæ¥è§£æä¸€ä¸‹ğŸ˜†</p>
<a id="more"></a>
<p>Flaskçš„è·¯ç”±æ˜¯å¯¹werkzeugè¿›è¡Œäº†ç®€å•çš„åŒ…è£…ï¼Œåšæˆäº†app.routeè£…é¥°å™¨å’Œblueprintã€‚å…¶å®werkzeugä¸­æœ‰ä¸€æ®µdocstringå°±èƒ½åæ˜ å‡ºflaskçš„è·¯ç”±æœºåˆ¶(MapAdapter.dispatch)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> werkzeug.wrappers <span class="keyword">import</span> Request, Response</div><div class="line"><span class="keyword">from</span> werkzeug.wsgi <span class="keyword">import</span> responder</div><div class="line"><span class="keyword">from</span> werkzeug.routing <span class="keyword">import</span> Map, Rule</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_index</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="keyword">return</span> Response(<span class="string">'Hello from the index'</span>)</div><div class="line"></div><div class="line">url_map = Map([Rule(<span class="string">'/'</span>, endpoint=<span class="string">'index'</span>)])</div><div class="line">views = &#123;<span class="string">'index'</span>: on_index&#125;</div><div class="line"></div><div class="line"><span class="meta">@responder</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span><span class="params">(environ, start_response)</span>:</span></div><div class="line">    request = Request(environ)</div><div class="line">    urls = url_map.bind_to_environ(environ)</div><div class="line">    <span class="keyword">return</span> urls.dispatch(<span class="keyword">lambda</span> e, v: views[e](request, **v),</div><div class="line">                         catch_http_exceptions=<span class="keyword">True</span>)</div></pre></td></tr></table></figure></p>
<p>werkzeugè·¯ç”±çš„å…¨éƒ¨å®ç°éƒ½åœ¨routing.pyæ–‡ä»¶å½“ä¸­ï¼Œçœ‹å®ƒå°±å¤Ÿäº†ã€‚è·¯ç”±çš„åŸºæœ¬åŠŸèƒ½å¯ä»¥è¯´æ˜¯</p>
<ol>
<li>ç»™å‡ºä¸€ä¸ªURLï¼ŒåŒ¹é…åˆ°å®ƒå¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œ</li>
<li>ç»™å‡ºå‡½æ•°èƒ½åæ¨æ„é€ å‡ºURL</li>
</ol>
<h2 id="Rule"><a href="#Rule" class="headerlink" title="Rule"></a>Rule</h2><p>ä¸€ä¸ªRuleå°±æ˜¯ä¸€æ¡URLåŒ¹é…è§„åˆ™,å®ƒçš„æ¨¡å¼å¦‚ä¸‹<code>&lt;converter(arguments):name&gt;</code>,ä½¿ç”¨æ­£åˆ™åŒ¹é…æ‰¾å‡ºæˆ‘ä»¬éœ€è¦çš„ä¿¡æ¯<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">_rule_re = re.compile(r&apos;&apos;&apos;</div><div class="line">    (?P&lt;static&gt;[^&lt;]*)                           # static rule data</div><div class="line">    &lt;</div><div class="line">    (?:</div><div class="line">        (?P&lt;converter&gt;[a-zA-Z_][a-zA-Z0-9_]*)   # converter name</div><div class="line">        (?:\((?P&lt;args&gt;.*?)\))?                  # converter arguments</div><div class="line">        \:                                      # variable delimiter</div><div class="line">    )?</div><div class="line">    (?P&lt;variable&gt;[a-zA-Z_][a-zA-Z0-9_]*)        # variable name</div><div class="line">    &gt;</div><div class="line">&apos;&apos;&apos;, re.VERBOSE)</div></pre></td></tr></table></figure></p>
<p>å¤§æ¦‚æ˜¯è¿™ä¹ˆä¸ªæ ·å­ruleåŒ¹é…<br><img src="https://ficapy.b0.upaiyun.com/blogimg/werkzeug_rule_re.png" alt="werkzeug_rule_re"><br>convertè§„åˆ™åŒ¹é…<br><img src="https://ficapy.b0.upaiyun.com/blogimg/werkzeug_converter_args_re.png" alt="werkzeug_converter_args_re"><br>å¾ˆå®¹æ˜“æƒ³åˆ°ä½¿ç”¨è¿™2ä¸ªæ­£åˆ™èƒ½å¤ŸåŒ¹é…ä¸€ä¸ªURLï¼Œä¸€çœ‹ä»–æ˜¯å¦åŒ¹é…æŸä¸ªruleï¼Œå…¶æ¬¡å¦‚æœåŒ¹é…é‚£ä¹ˆæå–å‡ºruleä¸­çš„å‚æ•°å’Œå€¼,æ¯”å¦‚<code>/&lt;int:id&gt;</code>å°±èƒ½åŒ¹é…<code>/16</code>è¿™ä¸ªurlä¸”å¾—åˆ°id=16ã€‚è¿™2ä¸ªå‡½æ•°å°±æ˜¯matchå’Œbuildäº†<br>ä»…ä»…æœ‰å®ƒä»¬æ˜¯ä¸å¤Ÿçš„ã€‚æˆ‘ä»¬éœ€è¦çš„ä¸ä»…ä»…æ˜¯ä¸€æ¡Ruleï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯æ‰€æœ‰Ruleçš„é›†åˆã€‚å½“æˆ‘ä»¬æ¯åˆ›å»ºä¸€ä¸ªRuleçš„æ—¶å€™å°†å®ƒåŠ å…¥åˆ°é›†åˆä¸­ã€‚æ‰€ä»¥å®ƒæä¾›äº†get_ruleså’Œbindæ–¹æ³•</p>
<p>Ruleå¯¹è±¡åŒæ—¶æœ‰2ä¸ªéå¸¸é‡è¦çš„å±æ€§endpointå’Œ_regex(ç¼–è¯‘åçš„æ­£åˆ™).endpointä¸ç”¨è¯´åŒ¹é…è¿”å›å®ƒï¼Œæ ¹æ®å®ƒè¿”å›æ„å»ºå¥½çš„URLï¼ŒåŒ¹é…åŠŸèƒ½åˆ™æ˜¯ç”±_regexå¯¹è±¡æä¾›çš„ã€‚å¦å¤–æœ‰å‡ ä¸ªå¯¹è±¡ç»§æ‰¿è‡ªRule<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Subdomain           self.subdomain</div><div class="line">Submount            self.rule = self.path + self.rule</div><div class="line">EndpointPrefix      self.endpoint = self.prefix + self.endpoint</div></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹å‡ºè¿™ä¸‰ä¸ªå¯¹è±¡éƒ½æ˜¯å¯¹Ruleçš„å±æ€§è¿›è¡Œäº†å°å¹…åº¦ä¿®æ”¹,å…¶ä¸­subdomainå’Œsubmountä¿®æ”¹çš„æœ€ç»ˆç»“æœå°±æ˜¯æ”¹å˜äº†_regexå¯¹è±¡</p>
<p>è¯´ä¸€ä¸‹Subdomain,å­åŸŸåã€‚è¿™ç©æ„å„¿å¥½åƒå¹¶ä¸å¸¸ç”¨ï¼Œä¸€èˆ¬ä¸€ä¸ªå­åŸŸåå°±æ˜¯å•ç‹¬ä¸€ä¸ªé¡¹ç›®äº†ï¼Œä¸å¤§ä¼šå‡ ä¸ªå­åŸŸåæ··åˆåœ¨ä¸€ä¸ªé¡¹ç›®é‡Œé¢ã€‚å¦‚æœè¦ä½¿ç”¨å­åŸŸåéœ€è¦è®¾ç½®SERVER_NAMEã€‚ç¤ºä¾‹å¦‚ä¸‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</div><div class="line">app = Flask(__name__)</div><div class="line">app.config[<span class="string">'SERVER_NAME'</span>] = <span class="string">'app.local:5000'</span></div><div class="line"><span class="meta">@app.route('/',subdomain='blog')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> <span class="string">'Hello'</span></div><div class="line">app.run(<span class="string">'app.local'</span>)</div></pre></td></tr></table></figure><br>ç„¶åå°±æ˜¯åœ¨hosté‡Œé¢æ·»åŠ å°±å¯ä»¥æ­£å¸¸è°ƒè¯•å­åŸŸåäº†<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">127.0.0.1 app.local</div><div class="line">127.0.0.1 blog.app.local</div></pre></td></tr></table></figure></p>
<h2 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h2><p>Mapçš„ä½œç”¨å°±æ˜¯å°†æ‰€æœ‰çš„Ruleç»„åˆåœ¨ä¸€èµ·,æ‰€ä»¥addå‡½æ•°æ˜¯å¿…é¡»çš„,Ruleå¯¹è±¡ä¸­çš„matchå’Œbuildéƒ½åªæ˜¯é’ˆå¯¹è‡ªå·±çš„ï¼ŒMapä¸­æä¾›çš„matchå’Œbuildåˆ™æ˜¯é’ˆå¯¹æ‰€æœ‰Ruleçš„ã€‚æ¯”å¦‚åœ¨Flaskä¸­å†™app.routeå¿…ç„¶ä¼šè°ƒç”¨addï¼Œå°†è¯¥Ruleæ·»åŠ åˆ°Mapä¸­ã€‚ä»£ç å¦‚ä¸‹(0.1ç‰ˆæœ¬)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_url_rule</span><span class="params">(self, rule, endpoint, **options)</span>:</span></div><div class="line">    options[<span class="string">'endpoint'</span>] = endpoint</div><div class="line">    options.setdefault(<span class="string">'methods'</span>, (<span class="string">'GET'</span>,))</div><div class="line">    self.url_map.add(Rule(rule, **options))</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">route</span><span class="params">(self, rule, **options)</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(f)</span>:</span></div><div class="line">      self.add_url_rule(rule, f.__name__, **options)</div><div class="line">      self.view_functions[f.__name__] = f</div><div class="line">      <span class="keyword">return</span> f</div><div class="line">  <span class="keyword">return</span> decorator</div></pre></td></tr></table></figure><br>ä»£ç ä¸­self.url_map = Map(),å¯ä»¥çœ‹åˆ°app.routeåšäº†2ä»¶äº‹æƒ…ï¼ŒåŠ å…¥åˆ°Mapä¸­ï¼ŒåŠ å…¥åˆ°äº†view_functionså­—å…¸ä¸­(endpointå¯¹åº”å‡½æ•°,è¿™æ®µä»£ç å’Œæ–‡ç« å¼€å¤´çš„ä»£ç æ˜¯å¾ˆç›¸ä¼¼çš„)</p>
<p>Mapå¯¹è±¡ä¸­æœ‰2ä¸ªå±æ€§ä¹Ÿæ˜¯æ¯”è¾ƒé‡è¦çš„,_rulesåˆ—è¡¨å’Œ_rules_by_endpointå­—å…¸ã€‚å‰è€…å­˜æ”¾æ‰€æœ‰Ruleå¯¹è±¡ï¼ŒåŒ¹é…çš„æ—¶å€™ç”¨æ¥éå†ï¼Œåè€…ä¸ºendpointåˆ°Ruleçš„æ˜ å°„ã€‚ç”¨æ¥buildé‡ç»„URL</p>
<p>ç°åœ¨å†æ¥çœ‹çœ‹Flaskä¸­çš„dispatchåˆ†å‘é€»è¾‘<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatch_request</span><span class="params">(self)</span>:</span></div><div class="line">    <span class="string">"""Does the request dispatching.  Matches the URL and returns the</div><div class="line">    return value of the view or error handler.  This does not have to</div><div class="line">    be a response object.  In order to convert the return value to a</div><div class="line">    proper response object, call :func:`make_response`.</div><div class="line">    """</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        endpoint, values = self.match_request()</div><div class="line">        <span class="keyword">return</span> self.view_functions[endpoint](**values)</div><div class="line">    <span class="keyword">except</span> HTTPException, e:</div><div class="line">        handler = self.error_handlers.get(e.code)</div><div class="line">        <span class="keyword">if</span> handler <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">return</span> e</div><div class="line">        <span class="keyword">return</span> handler(e)</div><div class="line">    <span class="keyword">except</span> Exception, e:</div><div class="line">        handler = self.error_handlers.get(<span class="number">500</span>)</div><div class="line">        <span class="keyword">if</span> self.debug <span class="keyword">or</span> handler <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">raise</span></div><div class="line">        <span class="keyword">return</span> handler(e)</div></pre></td></tr></table></figure><br>åŒ¹é…è¯·æ±‚å¾—åˆ°endpointå†ä»view_functionä¸­å¾—åˆ°å¯¹åº”çš„å¤„ç†å‡½æ•°æ‰§è¡Œ</p>
<h2 id="Blueprint"><a href="#Blueprint" class="headerlink" title="Blueprint"></a>Blueprint</h2><p>@app.routeè™½ç„¶å¤Ÿç‚«é…·ï¼Œå¯æ˜¯å®ƒç»ä¸é€‚åº”äºå¤§é¡¹ç›®ã€‚å› ä¸ºæ³¨å†Œçš„endpointå°±æ˜¯å‡½æ•°çš„åç§°ï¼Œåœ¨å¤§é¡¹ç›®ä¸­ç»å¯¹ä¼šå­˜åœ¨é‡åå‡½æ•°çš„ã€‚Blueprintçš„è§£å†³åŠæ³•å°±æ˜¯<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">blueprint = Blueprint(&apos;public&apos;, __name__, static_folder=&apos;../static&apos;)</div><div class="line">@blueprint.route(&apos;/&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">def index()</div><div class="line"></div><div class="line">app.register_blueprint(blueprint)</div></pre></td></tr></table></figure></p>
<p>è¿™æ ·å®ƒæ³¨å†Œçš„endpointå°±ä¼šå˜æˆpublic.indexï¼Œè§£å†³äº†é‡åé—®é¢˜</p>
<p>æœ‰äººé—®ä¸ºä»€ä¹ˆendpointä¸ç›´æ¥ä½¿ç”¨å¯¹åº”çš„å‡½æ•°ï¼Œè€Œè¦ä½¿ç”¨å­—ç¬¦ä¸²ã€‚æˆ‘è®¤ä¸ºæ˜¯ä½¿ç”¨url_forç­‰æ„å»ºURLå‡½æ•°çš„æ—¶å€™éœ€è¦å®ƒæ˜¯å­—ç¬¦ä¸²ï¼Œå› ä¸ºä½¿ç”¨è£…é¥°å™¨åfunc = deactor(func)ï¼Œä½ ä½¿ç”¨@app.routeä¹‹åæ³¨å†Œçš„funcå’Œä½ ç°åœ¨çš„funcä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚æ„å»ºå‡½æ•°å°†æ— æ³•ä½¿ç”¨,è¿™ä¹Ÿå‘Šè¯‰äº†æˆ‘ä»¬,ä»»ä½•æ—¶å€™å…¶ä»–çš„è£…é¥°å™¨éƒ½éœ€è¦å†™åœ¨@app.routeä¸‹é¢,å› ä¸ºå¦‚æœå†™åœ¨ä¸Šé¢ï¼Œä½ æ³¨å†Œçš„é‚£ä¸ªå‡½æ•°æ˜¯ä¸åŒ…å«ä¸Šé¢çš„è£…é¥°å™¨çš„ï¼Œæ³¨å®šäº†ä¸Šé¢çš„è£…é¥°å™¨æ— æ³•æ‰§è¡Œ</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Flaskå¸…æ°”çš„Hello Worldç¤ºä¾‹è®©äººå°è±¡æ·±åˆ»ã€‚å…¶ä¸­ä½¿ç”¨è£…é¥°å™¨çš„è·¯ç”±å†™æ³•åŠŸä¸å¯æ²¡ï¼Œç”šè‡³ä»¥å‰çœ‹è¿‡ä¸€ä¸ªç³»åˆ—&lt;a href=&quot;http://ains.co/blog/things-which-arent-magic-flask-part-1.html&quot;&gt;æ²¡é‚£ä¹ˆç¥å¥‡&lt;/a&gt;ï¼Œè®²äº†app.routeã€‚æ˜¯çš„ï¼Œå®ƒå¥½åƒå¹¶æ²¡æœ‰é‚£ä¹ˆç¥å¥‡ï¼Œæˆ‘ä¹Ÿæ¥è§£æä¸€ä¸‹ğŸ˜†&lt;/p&gt;
    
    </summary>
    
      <category term="Flask" scheme="https://www.zoulei.net/categories/Flask/"/>
    
    
      <category term="Flask" scheme="https://www.zoulei.net/tags/Flask/"/>
    
  </entry>
  
  <entry>
    <title>Flaskæ’ä»¶åŸç†</title>
    <link href="https://www.zoulei.net/2016/09/05/flask_plugin_note/"/>
    <id>https://www.zoulei.net/2016/09/05/flask_plugin_note/</id>
    <published>2016-09-04T23:38:32.000Z</published>
    <updated>2016-09-11T14:08:21.000Z</updated>
    
    <content type="html"><![CDATA[<p>Flaskçš„æ’ä»¶è¿˜æŒºå¤š,ç”¨è¿‡çš„éƒ½çŸ¥é“æ¯”å¦‚flask-sqlalchemy,å®‰è£…çš„æ—¶å€™æ˜¯ä½¿ç”¨pip install flask-sqlalchemyï¼Œä½¿ç”¨çš„æ—¶å€™å°±æˆäº†from flask.ext.sqlalchemy import SQLAlchemyã€‚ä½¿ç”¨çš„æ˜¯flask.extè€Œä¸æ˜¯flask_sqlalchemyã€‚æ„Ÿè§‰è¿˜æœ‰ç‚¹ç‰›æ°å•Š-_-ï¼Œä¸è¿‡ä»…ä»…æ˜¯çœ‹èµ·æ¥é«˜å¤§ä¸Šï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ã€‚<a href="https://github.com/pallets/flask/issues/1135">åœ¨2016å¹´4æœˆ13å·æ­£å¼è¢«ç§»å‡ºæ”¯æŒäº†</a>ï¼Œå·²ç»ç›´æ¥å‘å‡ºä¸å»ºè®®ä½¿ç”¨çš„è­¦å‘Šã€‚æœ¬æ–‡è¿˜æ˜¯æ¥ç‚’ä¸€ä¸‹ç°é¥­ï¼Œçœ‹çœ‹å®ƒèƒŒåçš„é€»è¾‘</p>
<a id="more"></a>
<p>æ¯”å¦‚flask-sqlalchemyåŸæœ¬æ˜¯ä½¿ç”¨from flask_sqlalchemy import [anything]ä½¿ç”¨çš„ï¼Œè¢«å˜æˆäº†from flask.ext.sqlalchemy import [anything]ã€‚è¿™æ˜¯ä¸€ç§å¯¹äºimportçš„hookã€‚æˆ‘ä»¬çŸ¥é“è¦å¯¼å…¥ä¸€ä¸ªæ¨¡å—ï¼Œä¸ä½¿ç”¨importå£°æ˜ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå¯ä»¥ä½¿ç”¨__import__å‡½æ•°ï¼Œè¿”å›å¾—åˆ°çš„ä¹Ÿæ˜¯ä¸€ä¸ªæ¨¡å—å¯¹è±¡</p>
<h2 id="import-hook"><a href="#import-hook" class="headerlink" title="import hook"></a>import hook</h2><p>ä¸‹æ–‡ç®€è¿°ï¼Œå¦‚æœéœ€è¦äº†è§£æ¯”è¾ƒè¯¦ç»†çš„èµ„æ–™å¯ä»¥æŸ¥çœ‹åæ–‡ç»™å‡ºçš„å‚è€ƒé“¾æ¥(python2å’Œ3çš„importæœºåˆ¶æ˜¯ç•¥æœ‰åŒºåˆ«çš„)<br>importå£°æ˜ä¸»è¦åšäº†2ä»¶äº‹æƒ…ï¼ŒæŸ¥æ‰¾æ¨¡å—ï¼ŒåŠ è½½æ¨¡å—ã€‚æˆ‘ä»¬è¯´çš„hookå‘ç”Ÿåœ¨ç¬¬ä¸€æ­¥æŸ¥æ‰¾æ¨¡å—ã€‚æŸ¥æ‰¾æ¨¡å—çš„æ­¥éª¤æ˜¯</p>
<ol>
<li>æŸ¥æ‰¾sys.modulesç¼“å­˜</li>
<li>åœ¨sys.meta_pathä¸­ä¾æ¬¡æ‰§è¡Œfinderå¯¹è±¡,æ‰¾åˆ°å°±è¿”å›è‡ªèº«,æ‰€æœ‰çš„éƒ½æ²¡æœ‰æ‰¾åˆ°åˆ™ä¼šæŠ¥é”™<br>æ³¨æ„:sys.path_hooksä¸­çš„finderä¼šè¢«sys.meta_pathè°ƒç”¨æ‰§è¡Œ(sys.meta_pathå’Œsys.path_hookéƒ½å¯ä»¥å‚ä¸import hooksæ­¥éª¤)</li>
</ol>
<h2 id="ç²¾ç®€ç‰ˆæœ¬å®ç°"><a href="#ç²¾ç®€ç‰ˆæœ¬å®ç°" class="headerlink" title="ç²¾ç®€ç‰ˆæœ¬å®ç°"></a>ç²¾ç®€ç‰ˆæœ¬å®ç°</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sys</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExtensionImporter</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install</span><span class="params">(self)</span>:</span></div><div class="line">        sys.meta_path[:] = [x <span class="keyword">for</span> x <span class="keyword">in</span> sys.meta_path <span class="keyword">if</span> self != x] + [self]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_module</span><span class="params">(self, fullname, path=None)</span>:</span></div><div class="line">        <span class="keyword">if</span> fullname.startswith(<span class="string">'flask.ext.'</span>):</div><div class="line">            <span class="keyword">return</span> self</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load_module</span><span class="params">(self, fullname)</span>:</span></div><div class="line">        <span class="keyword">if</span> fullname <span class="keyword">in</span> sys.modules:</div><div class="line">            <span class="keyword">return</span> sys.modules[fullname]</div><div class="line"></div><div class="line">        modname = fullname.split(<span class="string">'.'</span>)[<span class="number">-1</span>]</div><div class="line"></div><div class="line"></div><div class="line">        realname = <span class="string">'flask_'</span> +  modname</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            __import__(realname)</div><div class="line">        <span class="keyword">except</span> ImportError:</div><div class="line">            <span class="keyword">raise</span> ImportError(<span class="string">'No module named %s'</span> % fullname)</div><div class="line"></div><div class="line">        module = sys.modules[fullname] = sys.modules[realname]</div><div class="line">        <span class="keyword">if</span> <span class="string">'.'</span> <span class="keyword">not</span> <span class="keyword">in</span> modname:</div><div class="line">            setattr(sys.modules[<span class="string">'flask.ext'</span>], modname, module)</div><div class="line"></div><div class="line">        <span class="keyword">return</span> module</div></pre></td></tr></table></figure>
<p>ExtensionImporteræ˜¯ä¸€ä¸ªfinderå¯¹è±¡,å½“æ‰§è¡Œimport flask.extæ—¶ä¼šæŠŠå®ƒåŠ å…¥åˆ°sys.meta_pathåˆ—è¡¨ï¼Œåç»­çš„importéƒ½ä¼šå…ˆæ‰§è¡Œå®ƒï¼Œåˆ¤æ–­æ»¡è¶³è¦æ±‚åå°±ä¼šä½¿ç”¨__import__å¯¼å…¥ç„¶ååŠ å…¥åˆ°sys.modulesï¼Œè¿™æ ·å°±å®ç°äº†flask.ext.sqlalchemyå¯¼å…¥</p>
<p>ä¸ºä»€ä¹ˆä¼šè¢«åºŸé™¤å‘¢ã€‚ä¸‹é¢æ˜¯æˆ‘çŒœæµ‹çš„ã€‚é¦–å…ˆæœ¬æ¥è¿™ä¸ªä¸œè¥¿æ²¡æœ‰å®è´¨çš„ä½œç”¨ï¼Œå°±æ˜¯çœ‹ç€ç‚«é…·è€Œå·²ã€‚æˆ‘ä»¬å¯ä»¥è®¤ä¸ºæ‰€æœ‰çš„æ‰©å±•å¯¼å…¥éƒ½ä¼šä½¿ç”¨flask.ext.xxxï¼Œä½†æ˜¯è¿™å¯¹ç¬¬ä¸‰æ–¹æ‰©å±•åº“æ˜¯æœ‰è¦æ±‚çš„ï¼Œé‚£å°±æ˜¯åŒ…åå¿…é¡»ä¸ºflask_xxxæ‰è¡Œï¼Œæˆ‘çŒœæµ‹æœ‰çš„ç¬¬ä¸‰æ–¹åº“æœªå¿…éµå®ˆè¿™ä¸ªè§„åˆ™(å¦åˆ™exthook.pyä¸­ä¹Ÿä¸ä¼šå‡ºç°['flask_%s', 'flaskext.%s'flaskext.å¦å¤–ä¸€ç§å½¢å¼)ï¼Œè¿™å°±è¯´æ˜äº†æœ‰çš„ä½œè€…ä½¿ç”¨äº†flaskextxxxè¿™ç§åŒ…åã€‚å‡ºç°äº†ç¬¬äºŒç§éš¾å…å°±ä¼šå‡ºç°å¦å¤–çš„ã€‚å½“ä½¿ç”¨è€…å‘ç°å¹¶éæ‰€æœ‰çš„ç¬¬ä¸‰æ–¹æ‰©å±•éƒ½ä½¿ç”¨flask.extå¯¼å…¥çš„æ—¶å€™ã€‚ç¤¾åŒºä¹Ÿè§‰å¾—æ²¡å¿…è¦ç»´æŒäº†ï¼Œæ¯•ç«Ÿç¬¬ä¸€ä¸ªå†™è¿™ä¸ªä»£ç çš„äººæ˜¯ä¸æ˜¯å› ä¸ºåˆšåˆšäº†è§£äº†importæœºåˆ¶ï¼Œè§‰å¾—å¾ˆç‚«é…·å†™ä¸Šå»çš„å‘¢-_-,å¦å¤–è¿™ç§èŠ±å“¨çš„è®¾è®¡ä¹Ÿå¯èƒ½å¯¹ä»£ç è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½äº§ç”Ÿäº†è´Ÿé¢å½±å“ã€‚soï¼Œæœ€åè¿˜æ˜¯å›åˆ°äº†åŸæ¥çš„ä½ç½®ï¼Œç›´æ¥ä½¿ç”¨import flask_sqlalchemyå¯¼å…¥å§</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://docs.python.org/3/reference/import.html#import-hooks">å®˜æ–¹import hookæ–‡æ¡£</a><br><a href="https://github.com/Liuchang0812/slides/tree/master/pycon2015cn">pycon2015 importæ¼”è®²</a><br><a href="https://github.com/mitsuhiko/flask-sqlalchemy">flask-sqlalchemy</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Flaskçš„æ’ä»¶è¿˜æŒºå¤š,ç”¨è¿‡çš„éƒ½çŸ¥é“æ¯”å¦‚flask-sqlalchemy,å®‰è£…çš„æ—¶å€™æ˜¯ä½¿ç”¨pip install flask-sqlalchemyï¼Œä½¿ç”¨çš„æ—¶å€™å°±æˆäº†from flask.ext.sqlalchemy import SQLAlchemyã€‚ä½¿ç”¨çš„æ˜¯flask.extè€Œä¸æ˜¯flask_sqlalchemyã€‚æ„Ÿè§‰è¿˜æœ‰ç‚¹ç‰›æ°å•Š-_-ï¼Œä¸è¿‡ä»…ä»…æ˜¯çœ‹èµ·æ¥é«˜å¤§ä¸Šï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ã€‚&lt;a href=&quot;https://github.com/pallets/flask/issues/1135&quot;&gt;åœ¨2016å¹´4æœˆ13å·æ­£å¼è¢«ç§»å‡ºæ”¯æŒäº†&lt;/a&gt;ï¼Œå·²ç»ç›´æ¥å‘å‡ºä¸å»ºè®®ä½¿ç”¨çš„è­¦å‘Šã€‚æœ¬æ–‡è¿˜æ˜¯æ¥ç‚’ä¸€ä¸‹ç°é¥­ï¼Œçœ‹çœ‹å®ƒèƒŒåçš„é€»è¾‘&lt;/p&gt;
    
    </summary>
    
      <category term="Flask" scheme="https://www.zoulei.net/categories/Flask/"/>
    
    
      <category term="Flask" scheme="https://www.zoulei.net/tags/Flask/"/>
    
  </entry>
  
  <entry>
    <title>tmux</title>
    <link href="https://www.zoulei.net/2016/09/02/tmux_note/"/>
    <id>https://www.zoulei.net/2016/09/02/tmux_note/</id>
    <published>2016-09-02T07:43:22.000Z</published>
    <updated>2016-09-04T07:33:07.000Z</updated>
    
    <content type="html"><![CDATA[<p>è‡ªscreenä¹‹åtmuxæ—©å·²èº«åè¿œæ‰¬ï¼Œç„¶è€Œè¿™ä¸ªä¸œè¥¿å¯¹äºä¸€èˆ¬äººæ¥è¯´å¥½åƒå¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ï¼Œå¥½åƒè¿˜æ¯”è¾ƒéº»çƒ¦ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¥å‰çš„çœ‹æ³•ã€‚ä¸»è¦åŸå› å°±æ˜¯iterm2å·²ç»éå¸¸å®Œç¾äº†ã€‚iterm2çš„å¥½ç”¨ä¸€å®šç¨‹åº¦ä¸Šæ©ç›–äº†tmuxçš„å…‰è¾‰ã€‚å› ä¸ºiterm2æ˜¯å¼€ç®±å³ç”¨,tmuxä¸é…ç½®ä¸ä¸€å®šç”¨çš„èˆ’æœã€‚ç›´åˆ°æŸä¸€å¤©æˆ‘åœ¨youtubeä¸Šçœ‹åˆ°äº†2ä¸ªè§†é¢‘ï¼Œæˆ‘çŸ¥é“æˆ‘è¯¥æ”¹æ”¹äº†:)<br><img src="https://ficapy.b0.upaiyun.com/blogimg/gotbletu_tmux.png" alt="gotbletu_tmux"><br>æˆ‘ä¸ªäººä¹Ÿæ˜¯åˆšå…¥é—¨,ä¸‹é¢ä»‹ç»ä¸€äº›åŸºæœ¬çŸ¥è¯†ï¼Œå¸Œæœ›å¯¹è¯»è€…æœ‰æ‰€å¸®åŠ©.</p>
<a id="more"></a>
<h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><ul>
<li>tmuxåˆ†å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ï¼Œè¿™ä¸ªdockerè¿™ç§æ˜¯å¾ˆç›¸ä¼¼çš„ï¼Œæˆ‘ä»¬æ“ä½œçš„åªæ˜¯é’ˆå¯¹å®¢æˆ·ç«¯ï¼ŒæœåŠ¡ç«¯ä»¥å®ˆæŠ¤è¿›ç¨‹è¿è¡Œï¼Œè¿™æ ·å®ç°äº†æˆ‘ä»¬é€€å‡ºåä¸‹æ¬¡å†è¿›å…¥ä¾æ—§ä¿æŒäº†è¿è¡ŒçŠ¶æ€</li>
<li>session:æ¯”å¦‚ä½ åœ¨å…¬å¸æœ‰ä¸ªå·¥ä½œç¯å¢ƒï¼Œåœ¨å®¶é‡Œåˆæ˜¯å¦å¤–ä¸€ä¸ªå·¥ä½œç¯å¢ƒã€‚è¿™2ä¸ªç¯å¢ƒå·®åˆ«éå¸¸å¤§ã€‚é‚£ä¹ˆå°±ä½¿ç”¨2ä¸ªä¸åŒçš„session</li>
<li>window:ä½ åœ¨å·¥ä½œç¯å¢ƒä¸­è¦æ‰“å¼€å¤šä¸ªè½¯ä»¶ï¼ŒèŠå¤©çš„ã€BTä¸‹è½½çš„ã€å¬æ­Œçš„etc</li>
<li>pane:ä¸€ä¸ªè½¯ä»¶è¦åˆ†æˆå¤šä¸ªåŒºåŸŸè¾“å‡º</li>
<li>å½“ç„¶ä¸€èˆ¬æ¥è¯´è¶Šå°‘æ˜¯è¶Šæ–¹ä¾¿åˆ‡æ¢çš„ã€‚å°±ä¸ªäººæ¥è¯´ä¸€ä¸ªsessionå°±å¤Ÿäº†,ä¸»è¦åˆ‡æ¢æ¥è‡ªäºwindowå’Œpane</li>
<li>tmuxä¸»è¦æ¥è¯´æœ€é‡è¦çš„å°±æ˜¯å¯¹å„ä¸ªçª—å£çš„åˆ‡æ¢æ’åˆ—ç®¡ç†ï¼Œå„ç§é”®ä½ç»‘å®šä¹Ÿæ˜¯ç”¨äºå¯¹çª—å£çš„åˆ‡æ¢</li>
</ul>
<h2 id="windows-paneåŸºæœ¬è®¾ç½®"><a href="#windows-paneåŸºæœ¬è®¾ç½®" class="headerlink" title="windows,paneåŸºæœ¬è®¾ç½®"></a>windows,paneåŸºæœ¬è®¾ç½®</h2><p>å’Œvimä¸€æ ·tmuxä¹Ÿæ˜¯ä½¿ç”¨ä¸€ä¸ªä¸»è¦çš„prefix keyï¼Œå…ˆè¾“å…¥prefix keyä¹‹åå†è¾“å…¥ç»‘å®šçš„å­—æ¯æ‰§è¡Œæ“ä½œ.ä¸‹é¢å°±å°†æˆ‘ä»å¤šä¸ªåœ°æ–¹copyæ¥çš„é…ç½®è§£é‡Šä¸€ç•ª-_-</p>
<p>è®¾ç½®æˆC-a,åŒæ—¶è§£ç»‘åŸæ¥çš„C-b,æœ€åçš„bind açš„ä½œç”¨å°±æ˜¯:C-aæœ¬æ¥æ˜¯å›åˆ°è¡Œé¦–çš„å¿«æ·é”®ï¼Œè¢«tmuxä½¿ç”¨ä¹‹åä½¿ç”¨æ­¤è®¾å®šå˜æˆäº†C-a-aåˆ°è¡Œé¦–</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">set -g prefix ^a</div><div class="line">unbind ^b</div><div class="line">bind a send-prefix</div></pre></td></tr></table></figure>
<p>ä¹‹åå°±æ˜¯å¯¹windowå’Œpaneçš„å¿«æ·é”®è®¾å®šï¼Œæœ¬äººä½¿ç”¨vimç›¸ä¼¼çš„å¿«æ·é”®è®¾å®šã€‚è¿™ä¸ªå¥½åƒæ²¡å•¥å¥½è¯´çš„ï¼Œæ¯”å¦‚hjklåœ¨paneä¸­ç§»åŠ¨,sã€våˆ†å±ï¼Œä½¿ç”¨&lt;ã€&gt;ã€+ã€_å¯¹paneè¿›è¡Œå¤§å°çš„æ”¹å˜ï¼Œä½¿ç”¨C-uã€C-dè¿›è¡Œäº¤æ¢ï¼Œä½¿ç”¨qã€C-qè¿›è¡Œå…³é—­paneå’Œwindowï¼Œä¸¾ä¸ªä¾‹å­</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">bind k selectp -U</div><div class="line">bind -r &lt; resize-pane -L 10</div><div class="line">bind ^u swapp -U</div><div class="line">bind q killp</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨-r(recursion)å°±èƒ½å¤Ÿè¾“å…¥ä¸€æ¬¡&lt;ä¹‹åé©¬ä¸Šå¤šæ¬¡è¾“å…¥&lt;ã€&gt;æœ‰æ•ˆ,è¿™å¯¹äºè°ƒæ•´å¤§å°æ—¶æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚ã€‚ã€‚,æ²¡æœ‰è¢«é‡å†™çš„é…ç½®åŸºæœ¬éƒ½æ˜¯éå¸¸å¥½è®°çš„å•è¯,cã€nã€wã€dè®°è¿™äº›éƒ½æ˜¯æ¯«ä¸è´¹åŠ›çš„</p>
<h2 id="é¼ æ ‡ã€å¤åˆ¶åŠæ¸…å±è®¾ç½®"><a href="#é¼ æ ‡ã€å¤åˆ¶åŠæ¸…å±è®¾ç½®" class="headerlink" title="é¼ æ ‡ã€å¤åˆ¶åŠæ¸…å±è®¾ç½®"></a>é¼ æ ‡ã€å¤åˆ¶åŠæ¸…å±è®¾ç½®</h2><p>å¦‚æœä½ ä¸è¿›è¡Œå…¶ä»–è®¾ç½®å¯èƒ½ç”¨å‡ ä¸‹åŠ¨ä¸€ä¸‹é¼ æ ‡ä¸Šä¸‹ç¿»ä¸€ä¸‹ï¼Œå°±ä¼šé«˜å‘¼WTFã€‚æ¯•ç«Ÿå®Œå…¨ä¸åŠ¨é¼ æ ‡çš„å¤§ç¥ä¸å¤šï¼Œæˆ‘è¿˜æ˜¯æ‰“å¼€é¼ æ ‡è®¾ç½®å§,è¿™æ ·ä¹Ÿèƒ½åŒæ—¶ä½¿ç”¨é¼ æ ‡è¿›è¡Œä¸Šä¸‹æ»‘åŠ¨äº†ï¼Œå…¶æ¬¡å¤åˆ¶ä¹Ÿå’Œä»¥å‰ä¸ä¸€æ ·äº†ï¼Œç‰¹åˆ«æ˜¯å¦‚æœä½ åˆ†äº†2ä¸ªç«–å‘çš„pane,è¿™æ ·å’Œä»¥å‰ä¸€æ ·ç”¨é¼ æ ‡å¤åˆ¶å°±å‡ºé—®é¢˜äº†ï¼Œå½“ç„¶ä½ å¯ä»¥ç”¨z(zoom)å…¨å±å½“å‰çš„paneï¼Œç„¶åç”¨é¼ æ ‡å¤åˆ¶ã€‚ç„¶è€Œä¸€ä¸ªvimå…šæ˜¯ä¸ä¼šè¿™æ ·åšçš„T_Tã€‚ä¸‹é¢æ˜¯è®¾ç½®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">setw -g mouse on</div><div class="line">#set vi mode for copy mode</div><div class="line">setw -g mode-keys vi</div><div class="line"></div><div class="line"># more settings to make copy-mode more vim-like</div><div class="line">unbind [</div><div class="line">bind Escape copy-mode</div><div class="line">unbind p</div><div class="line">bind p paste-buffer</div><div class="line">bind -t vi-copy &apos;v&apos; begin-selection</div><div class="line">bind -t vi-copy &apos;y&apos; copy-selection</div><div class="line"></div><div class="line"># Buffers to/from Mac clipboard, yay tmux book from pragprog</div><div class="line">bind C-c run &quot;tmux save-buffer - | reattach-to-user-namespace pbcopy&quot;</div><div class="line">bind C-v run &quot;tmux set-buffer $(reattach-to-user-namespace pbpaste); tmux paste-buffer&quot;</div></pre></td></tr></table></figure>
<p>è¿™æ ·å¤åˆ¶å¥½åƒå˜å¾—å¤æ‚äº†ã€‚ã€‚ã€‚éœ€è¦å…ˆè¿›å…¥é€‰æ‹©æ¨¡å¼C-a-ESC-vé€‰æ‹©éœ€è¦å¤åˆ¶çš„å†…å®¹åå†æ‰§è¡Œyå¤åˆ¶åˆ°tmuxçš„ç¼“å†²åŒºï¼Œå¦å¤–åƒtmuxå’Œvimè¿™ç§çš„ç²˜è´´æ¿æ˜¯ç‹¬ç«‹çš„,å’Œosxç³»ç»Ÿçš„ç²˜è´´æ¿ä¸å…±é€š,å¦‚æœè¦å†å¤åˆ¶åˆ°ç³»ç»Ÿç²˜è´´æ¿ï¼Œæ­¤æ—¶å†ä½¿ç”¨C-a-C-c,å¥½åƒæ˜¯æ¯”è¾ƒå¤æ‚å•Šã€‚ã€‚ä½ å¯ä»¥æŒ‰ä½optionå†ç”¨é¼ æ ‡é€‰æ‹©ä¹Ÿæ˜¯ç›´æ¥å¤åˆ¶åˆ°ç³»ç»Ÿç²˜è´´æ¿ï¼Œè¦è®©vimå’Œtmuxå’Œç³»ç»Ÿç²˜è´´æ¿é€šç”¨ï¼Œä½ éœ€è¦<code>brew install reattach-to-user-namespace</code>å®‰è£…ã€‚å¦å¤–iterm2å…¶å®æ˜¯å¯ä»¥è®©ä»–ä»¬å…±ç”¨çš„ï¼Œä¸‹å›¾é€‰ä¸­Applications in terminal may access clipboardä¹Ÿèƒ½è¾¾åˆ°åŒæ ·çš„æ•ˆæœï¼Œä¸è¿‡ä¸‹é¢çš„å‚è€ƒæ–‡ç« æœ‰è¯´æœ‰ç¼ºç‚¹-_-æˆ‘å°±å¬äº†ä»–çš„äº†<br><img src="https://ficapy.b0.upaiyun.com/blogimg/iterm_access_clipboard.png" alt="iterm_access_clipboard"></p>
<p>å†å°±æ˜¯é…ç½®é‡è½½å’Œæ¸…å±</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#bind -n C-l send-keys &apos;C-l&apos;</div><div class="line">bind -n C-k send-keys -R \; send-keys C-l \; clear-history</div><div class="line"># reload config (prefix r)</div><div class="line">bind r source ~/.tmux.conf \; display &quot;Configuration reloaded!&quot;</div></pre></td></tr></table></figure>
<p>å°±å¥½åƒcommand+kå®Œå…¨æ¸…å±ï¼Œtmuxä¹Ÿå¯ä»¥ï¼Œä¸è¿‡éœ€è¦é…ç½®(è¿™ä¸ªå®Œç¾æ¸…å±å‘½ä»¤æ‰¾äº†å¾ˆä¹…),-nè¡¨ç¤ºä¸éœ€è¦å…ˆæŒ‰prefix keyç›´æ¥ä½¿ç”¨C-kå°±è°ƒç”¨äº†ï¼Œå¦å¤–ä¸è¦å°†C-lè®¾ç½®ä¸ºæ¸…å±,ä¼šè®©TABè¡¥å…¨å¤±æ•ˆ</p>
<h2 id="çŠ¶æ€æ "><a href="#çŠ¶æ€æ " class="headerlink" title="çŠ¶æ€æ "></a>çŠ¶æ€æ </h2><p>é…ç½®ä¸€ä¸ªå¥½çœ‹çš„çŠ¶æ€æ å¥½åƒè¿˜æ˜¯æ¯”è¾ƒå›°éš¾çš„,æˆ‘æ¯”è¾ƒå·æ‡’å°±ç›´æ¥ä½¿ç”¨äº†<a href="https://github.com/erikw/tmux-powerline">tmux-powerline</a>å’Œ<a href="https://github.com/seebi/tmux-colors-solarized/blob/master/tmuxcolors-256.conf">tmux-colors-solarized</a>,ä¸‹é¢æ˜¯æ•ˆæœ<br><img src="https://ficapy.b0.upaiyun.com/blogimg/tmux_statusbar.png" alt="tmux_statusbar"><br>æ³¨æ„é…ç½®powerlineçš„æ—¶å€™å¯èƒ½éœ€è¦åœ¨~/.zshrcä¸­åŠ å…¥<code>PS1=&quot;$PS1&quot;&#39;$([ -n &quot;$TMUX&quot; ] &amp;&amp; tmux setenv TMUXPWD_$(tmux display -p &quot;#D&quot; | tr -d %) &quot;$PWD&quot;)&#39;</code>æœ‰çš„æ—¶å€™ä¿®æ”¹é…ç½®å¯èƒ½éœ€è¦tmux kill-serveråé‡æ–°è¿›å…¥æ‰èƒ½çœ‹åˆ°æ•ˆæœ</p>
<p>åœ¨çŠ¶ä½“æ çš„é…ç½®ä¼šçœ‹åˆ°è¿™ç§<code>set-option -g status-bg colour235</code>,colour235æ˜¯ä»€ä¹ˆé¬¼é¢œè‰²ã€‚çœŸæ˜¯ä¸å¥½çŒœå•Šï¼Œå¯ä»¥å•ç‹¬å¼€ä¸€ä¸ªpaneæ‰“å°è¾“å‡ºæ‰€æœ‰256ç§é¢œè‰²ï¼Œè‡ªå·±å¯¹æ¯”ä¿®æ”¹æˆå–œæ¬¢çš„é¢œè‰²</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">for i in &#123;0..255&#125; ; do</div><div class="line">    printf &quot;\x1b[38;5;$&#123;i&#125;mcolour$&#123;i&#125;\n&quot;</div><div class="line">done</div></pre></td></tr></table></figure>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>æˆ‘ä»¬è®¾ç½®å¥½äº†ä¹‹åå¯èƒ½éœ€è¦åœ¨æ‰“å¼€itermä¹‹åå°±ç›´æ¥è¿›å…¥tmux,å¦åˆ™å²‚ä¸æ˜¯ç™½å¿™æ´»~(â‰§â–½â‰¦)/~å•¦å•¦å•¦ï¼Œå¾ˆç®€å•,åœ¨itermçš„è®¾ç½®é¡µprofilesâ†’Generalâ†’Send text at startä¸­å¡«å…¥<code>tmux attach -t init || tmux new -s init</code>,æ›´æœ‰ç”¨çš„æ˜¯åœ¨æˆ‘ä»¬è¿œç¨‹åˆ°vpsä¸Šçš„æ—¶å€™ç›´æ¥è¿›å…¥åˆ°tmux,è®¾ç½®ä¸€ä¸ªåˆ«åå¦‚ä¸‹<code>alias hg=&quot;ssh -t hg \&quot;bash -c &#39;tmux a -t init || tmux new -s init&#39;\&quot;&quot;</code>è¿™æ ·æˆ‘ä»¬æ‰§è¡Œhgçš„æ—¶å€™å°±æ–°å»ºä¸€ä¸ªsessionæˆ–è€…è¿æ¥åˆ°å·²æœ‰çš„session</p>
<p>å¦‚æœæˆ‘ä»¬æœ¬åœ°å¼€ä¸€ä¸ªtmuxï¼Œç„¶åè¿œç¨‹è¿æ¥vpsï¼Œvpså†è¿è¡Œtmuxï¼Œè¿™ä¼šé€ æˆåµŒå¥—ä½¿ç”¨ã€‚ç‰¹åˆ«æ˜¯å½“ä½ çš„prefix keyè¿˜æ˜¯ä¸€æ ·çš„æ—¶å€™ã€‚ã€‚ã€‚æ‚²å‚¬äº†ï¼Œä½ æ‰€è¾“å…¥çš„å¿«æ·é”®åªä¼šè¢«æœ¬åœ°çš„tmuxå¤„ç†è€Œä¸ä¼šè¢«è¿œç¨‹çš„tmuxå“åº”ï¼Œè¦å¤„ç†è¿™ä¸ªé—®é¢˜å¯ä»¥å°†2è€…çš„prefix keyè®¾ç½®æˆä¸ä¸€æ ·,æ¯”å¦‚ä¸€ä¸ªä¸ºaå¦å¤–ä¸€ä¸ªä¸ºsã€‚æˆ–è€…ä½¿ç”¨itermå•ç‹¬å¼€ä¸€ä¸ªçª—å£ï¼Œæˆ‘æ›´æ¨èåè€…,å› ä¸ºè®¾ç½®æˆä¸åŒçš„prefix keyè¾“å…¥å¿«äº†å¯èƒ½å°±è¾“å…¥æ··æ·†å•¦ã€‚</p>
<p>å¦å¤–,ä½¿ç”¨äº†tmuxæ˜¾è‘—å¢åŠ äº†iterm2çš„è€—ç”µé‡,ä¼°è®¡æ˜¯æˆ‘è®¾ç½®çš„é‚£ä¸ªçŠ¶æ€æ æ˜¾ç¤ºä¸Šä¼ ä¸‹è½½æµé‡å¯¼è‡´çš„ï¼Œæ¯å‡ ç§’åˆ·æ–°æ‰§è¡Œä¸€æ¬¡shellæˆ–è®¸æŒºè€—ç”µ.</p>
<p><a href="https://github.com/ficapy/dotfiles/blob/master/.tmux.conf">æˆ‘çš„tmuxé…ç½®</a></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://danielmiessler.com/study/tmux/">A tmux Primer</a><br><a href="https://www.youtube.com/playlist?list=PL5BE1545D8486D66D">gotbletu youtube playlist</a><br><a href="https://evertpot.com/osx-tmux-vim-copy-paste-clipboard/">Making the clipboard work between iTerm2, tmux, vim and OS X.</a><br><a href="http://superuser.com/questions/285381/how-does-the-tmux-color-palette-work">How does the tmux color palette work?</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è‡ªscreenä¹‹åtmuxæ—©å·²èº«åè¿œæ‰¬ï¼Œç„¶è€Œè¿™ä¸ªä¸œè¥¿å¯¹äºä¸€èˆ¬äººæ¥è¯´å¥½åƒå¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ï¼Œå¥½åƒè¿˜æ¯”è¾ƒéº»çƒ¦ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¥å‰çš„çœ‹æ³•ã€‚ä¸»è¦åŸå› å°±æ˜¯iterm2å·²ç»éå¸¸å®Œç¾äº†ã€‚iterm2çš„å¥½ç”¨ä¸€å®šç¨‹åº¦ä¸Šæ©ç›–äº†tmuxçš„å…‰è¾‰ã€‚å› ä¸ºiterm2æ˜¯å¼€ç®±å³ç”¨,tmuxä¸é…ç½®ä¸ä¸€å®šç”¨çš„èˆ’æœã€‚ç›´åˆ°æŸä¸€å¤©æˆ‘åœ¨youtubeä¸Šçœ‹åˆ°äº†2ä¸ªè§†é¢‘ï¼Œæˆ‘çŸ¥é“æˆ‘è¯¥æ”¹æ”¹äº†:)&lt;br&gt;&lt;img src=&quot;https://ficapy.b0.upaiyun.com/blogimg/gotbletu_tmux.png&quot; alt=&quot;gotbletu_tmux&quot;&gt;&lt;br&gt;æˆ‘ä¸ªäººä¹Ÿæ˜¯åˆšå…¥é—¨,ä¸‹é¢ä»‹ç»ä¸€äº›åŸºæœ¬çŸ¥è¯†ï¼Œå¸Œæœ›å¯¹è¯»è€…æœ‰æ‰€å¸®åŠ©.&lt;/p&gt;
    
    </summary>
    
      <category term="linux" scheme="https://www.zoulei.net/categories/linux/"/>
    
    
  </entry>
  
  <entry>
    <title>fasdå’Œfzf</title>
    <link href="https://www.zoulei.net/2016/08/29/fasd&amp;fzf/"/>
    <id>https://www.zoulei.net/2016/08/29/fasd&amp;fzf/</id>
    <published>2016-08-29T13:55:24.000Z</published>
    <updated>2016-08-30T07:24:19.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ¥2ä¸ªæ—¥å¸¸ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·ç©ä¸€ç©ï¼Œå‰ä¸€ä¸ªæ˜¯ç›®å½•å¿«é€Ÿè·³è½¬ï¼Œåä¸€ä¸ªæ˜¯ä½¿ç”¨cursesæ¨¡ç³ŠæŸ¥æ‰¾</p>
<a id="more"></a>
<h2 id="fasd"><a href="#fasd" class="headerlink" title="fasd"></a><a href="https://github.com/clvv/fasd">fasd</a></h2><p>ç›®å½•å¿«é€Ÿè·³è½¬å·¥å…·æŒºå¤šçš„autojump,z.æˆ‘æœ€å¼€å§‹ç”¨çš„æ˜¯zï¼Œç”¨é•¿äº†æ„Ÿè§‰å¥½åƒæœ‰bug,ç„¶åå°±æ¢fasd.<code>å¥½åƒ</code>æ„Ÿè§‰å¥½ç”¨é‚£ä¹ˆä¸€ç‚¹ç‚¹ã€‚è¿™ç§å·¥å…·åŸç†éƒ½å·®ä¸å¤šã€‚å¯¹ä½ çš„å†å²è¾“å…¥è¿›è¡Œç»Ÿè®¡ï¼Œæ”¾å…¥æ•°æ®åº“ã€‚ç„¶åæ ¹æ®ä½ è¾“å…¥çš„ç»“æœä»æ•°æ®åº“åŒ¹é…è¾¾åˆ°å¿«é€Ÿcdçš„ç»“æœã€‚å®‰è£…å¥½åç›´æ¥è¾“å…¥fasd,å°±å¯ä»¥çœ‹åˆ°å¾—åˆ†ä»¥åŠç›®å½•/æ–‡ä»¶ã€‚ä»å®ƒçš„åŸç†ä¹Ÿèƒ½å¯ä»¥çœ‹å‡ºæ¥ã€‚å®ƒåªèƒ½å¯¹æœ‰è®°å½•çš„å¿«é€Ÿåˆ‡æ¢(ä»ä½ å®‰è£…è¿™ä¸ªè½¯ä»¶å¼€å§‹è®°å½•)ã€‚å¯¹äºä¸€ä¸ªæ–°çš„ç›®å½•é¦–æ¬¡è®¿é—®è¿˜æ˜¯éœ€è¦ç”¨cdã€‚è¿™ä¸ªè½¯ä»¶ä¸ªå¸¸ç”¨çš„å‘½ä»¤ä¹Ÿå°±2ä¸ª<br>zå’Œvï¼Œåˆ†åˆ«ä»£è¡¨åˆ‡æ¢ç›®å½•å’Œä½¿ç”¨$EDITORæ‰“å¼€æ–‡ä»¶.æ‰€ä»¥:</p>
<ul>
<li>å½“ä½ éœ€è¦å¿«é€Ÿcdåˆ°ä»¥å‰æ‰“å¼€è¿‡çš„ç›®å½•ç”¨z,å½“ä½ é¦–æ¬¡æ‰“å¼€ä¸€ä¸ªç›®å½•ç”¨cd(æˆ–è€…æ‰“å¼€å½“å‰ç›®å½•)ï¼›</li>
<li>å½“ä½ éœ€è¦ç”¨vimæ‰“å¼€ä»¥å‰æ‰“å¼€çš„æ–‡ä»¶ç”¨v,é¦–æ¬¡æ‰“å¼€æˆ–ç¡®å®šç›®å½•vim</li>
<li>å®ƒçœŸçš„å¾ˆæ–¹ä¾¿äº†,æˆ‘çœ‹åˆ°æœ‰äº›äººæŠŠå®ƒå’Œfzfåˆèµ·æ¥ä¸€èµ·ç”¨ã€‚æˆ‘æƒ³äº†å¾ˆä¹…ï¼Œé™¤äº†è£…é€¼é™ä½æ•ˆç‡ã€‚æˆ‘æ²¡æƒ³åˆ°æœ‰ä»€ä¹ˆç”¨</li>
</ul>
<h2 id="fzf"><a href="#fzf" class="headerlink" title="fzf"></a><a href="https://github.com/junegunn/fzf">fzf</a></h2><p>è¿™æ¬¾è½¯ä»¶å¯¹äºæé«˜å‘½ä»¤è¡Œæ•ˆç‡ä¹Ÿæ˜¯å¾ˆç‰›é€¼,è€Œä¸”çœ‹githubä¸Šé¢çš„æäº¤è®°å½•ï¼Œä¾æ—§éå¸¸æ´»è·ƒ(å¯¹äºä¸€ä¸ªå°ç™½æ²¡ä»€ä¹ˆæ¯”é¡¹ç›®çš„æ´»è·ƒæ›´é‡è¦äº†ï¼Œå› ä¸ºå®ƒæ„å‘³ç€ä½ å¯èƒ½é‡åˆ°çš„å‘å‰äººéƒ½å¯èƒ½å·²ç»è¶Ÿè¿‡).è€Œä¸”è¿™ä¸ªé¡¹ç›®çš„ä½œè€…å¥½åƒéå¸¸è‡ªä¿¡,é¡¹ç›®è¯´æ˜é‡Œé¢å±…ç„¶åªåˆ—ä¸¾äº†ä¼˜ç‚¹ï¼Œä¸æ¯«æ²¡æœ‰ç¼ºç‚¹.</p>
<p>è¿™æ˜¯ä¸€æ¬¾å®‰è£…ä¸Šå»å°±èƒ½è®©ä½ çœ¼å‰ä¸€äº®çš„è½¯ä»¶ã€‚æ¯”å¦‚Ctrl+Rï¼Œå®Œç¾æ›¿æ¢äº†shellé»˜è®¤çš„å†å²è®°å½•åŠŸèƒ½,å½“è¾“å…¥æŒ‡ä»¤çš„æ—¶å€™ä½¿ç”¨ctrl+Tå°±èƒ½åˆ—å‡ºå½“å‰ç›®å½•ä¸‹æ‰€æœ‰çš„æ–‡ä»¶ã€‚å½“ç„¶è¿™åªæ˜¯åˆ—ä¸¾çš„2ä¸ªæœ€å¸¸ç”¨çš„åŠŸèƒ½,å®é™…ä¸Šï¼Œå®ƒçš„æ½œåŠ›è¿œä¸æ­¢è¿™ä¹ˆç‚¹ï¼Œå¦‚æœä½ ç”¨è¿‡osxä¸Šè¢«äººå¹æˆç¥çš„alfred,é‚£ä¹ˆfzfçš„æ¦‚å¿µå¯èƒ½å’Œå®ƒæœ‰ä¸€å®šçš„ç›¸ä¼¼æ€§(å–å¾—ä¸€äº›ç»“æœ,ç„¶åä½¿ç”¨åˆ—è¡¨æ’é™¤å‡ºæ¥),ä¸¾ä¸ªä¾‹å­,IDEä¸­æˆ‘ä»¬ç»å¸¸ä½¿ç”¨å…¨å±€æ›¿æ¢,ç”¨ä»¥ä¸‹å‘½ä»¤ä¹Ÿèƒ½æå®š<br><code>grep -rn &#39;python&#39;| fzf -m | awk -F &#39;:&#39; &#39;{print $1}&#39; | xargs -L 1 sed -i -e &#39;s/python/hello/g&#39;</code><br>æ•ˆæœå¦‚ä¸‹<img src="https://ficapy.b0.upaiyun.com/blogimg/fzf_grep_sed.gif" alt="fzf_grep_sed"><br>è§£é‡Šä¸€ä¸‹ï¼Œ</p>
<ol>
<li>ä½¿ç”¨grepé€’å½’åŒ¹é…å½“å‰ç›®å½•å«æœ‰pythonçš„æ–‡ä»¶,-rä¸ºé€’å½’ï¼Œ-nä¸ºæ˜¾ç¤ºè¡Œå·ã€‚</li>
<li>ä½¿ç”¨fzfæ˜¾ç¤ºå‡ºæ¥,-mä¸ºå¤šè¡Œæ¨¡å¼,ä½¿ç”¨tabä¸ºé€‰æ‹©æˆ–è€…å–æ¶ˆé€‰æ‹©ã€‚</li>
<li>ä½¿ç”¨awkå¯¹é€‰æ‹©çš„çš„ç»“æœè¿›è¡Œå¤„ç†,-Fä¸ºé€‰æ‹©åˆ†éš”ç¬¦ï¼Œç»“æœä¸ºå¤šä¸ªç›®å½•</li>
<li>ä½¿ç”¨xargså¯¹ç»“æœæ‰§è¡Œsedæ›¿æ¢,-Lä¸ºå¯¹æ¯ä¸€ä¸ªéç©ºè¡Œæ‰§è¡Œåç»­å‘½ä»¤(Call utility for every number non-empty lines read.  A line ending with a space continues to the next non-empty line)</li>
<li>å¦å¤–grepçš„æ•ˆç‡æ˜¯éå¸¸é«˜çš„,å¦‚æœä½ ç›´æ¥ç”¨sedè¿›è¡Œå…¨å±€æ›¿æ¢-_-æ–‡ä»¶ä¸€å¤šè¿˜æ˜¯å¾ˆèŠ±è´¹æ—¶é—´æ»´,æ¯”å¦‚è¿™ç§<code>sed -i -- &#39;s/foo/bar/g&#39; **/*(D.)</code></li>
</ol>
<h3 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h3><p>è™½ç„¶ä½œè€…æ²¡æœ‰åˆ—ä¸¾å‡ºæ¥,æˆ‘è¿˜æ˜¯å°±æˆ‘çš„ä¸ªäººæ„Ÿè§‰è¯´ä¸€ä¸‹</p>
<ol>
<li>è ¢åˆ°å®¶çš„åŒ¹é…æ•ˆæœ,ä½ å¾ˆéš¾ç†è§£å®ƒæ˜¯æ ¹æ®ä»€ä¹ˆç»™ä½ åŒ¹é…çš„,æ”¾ä¸€å¼ å›¾<img src="http://ficapy.b0.upaiyun.com/blogimg/fzf_match.png" alt="fzf_match">ï¼Œå°±è¿™åŒªå¤·æ‰€æ€çš„åŒ¹é…ï¼Œä½ ä¸å¾—ä¸ä½¿ç”¨^$!ç­‰é¢å¤–çš„è§„åˆ™æˆ–è€…å¤šè¾“å…¥ä¸€äº›å­—ç¬¦ç„¶åä¸Šä¸‹é”®é€‰æ‹©</li>
<li>çœ‹ç€ç‚«é…·,æœ‰æ—¶å€™æ²¡å¿…è¦é‚£ä¹ˆç‚«é…·ï¼Œæ¯”å¦‚ä½¿ç”¨zçš„æ—¶å€™tabå¦‚æœæœ‰å¤šä¸ªé€‰æ‹©ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœä½ ç”¨fzfæ›¿ä»£ï¼Œä»–ä¼šä½¿ç”¨curseså…¨å±è®©ä½ é€‰æ‹©,å…¶å®æ•´ä¸ªè¿‡ç¨‹å·²ç»å¤šè¾“å…¥äº†å¥½å¤šå­—ç¬¦.</li>
</ol>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>fasdå’Œfzfçš„å¾ˆå¥½ç”¨ï¼Œè€Œä¸”å®ƒä»¬éƒ½ä¸éœ€è¦ä»»ä½•é…ç½®éƒ½èƒ½è®©ä½ æ„Ÿåˆ°é«˜æ•ˆ!å¯¹äºfzfå¦‚æœä½ èŠ±æ—¶é—´é…ç½®æ˜¯æœ‰ç‰¹åˆ«å¤šç©æ³•çš„ï¼Œå¯ä»¥å‚ç…§å®˜ç½‘<a href="https://github.com/junegunn/fzf/wiki/examples">fzf_examples</a>å’Œ<a href="https://www.youtube.com/playlist?list=PLqv94xWU9zZ2fMsMMDF4PjtNHCeBFbggD">gotbletuçš„è§†é¢‘æ•™ç¨‹</a>ä½“éªŒå®ƒçš„å¼ºå¤§ã€‚å¦å¤–ï¼Œå¦‚æœä½ å–œæ¬¢è¿™2ä¸ªè½¯ä»¶ï¼Œé‚£ä¹ˆä½ ä¸€å®šä¼šå–œæ¬¢<a href="https://github.com/zsh-users/zsh-autosuggestions">zsh-autosuggestions</a>è¯•ä¸€è¯•å§~~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æ¥2ä¸ªæ—¥å¸¸ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·ç©ä¸€ç©ï¼Œå‰ä¸€ä¸ªæ˜¯ç›®å½•å¿«é€Ÿè·³è½¬ï¼Œåä¸€ä¸ªæ˜¯ä½¿ç”¨cursesæ¨¡ç³ŠæŸ¥æ‰¾&lt;/p&gt;
    
    </summary>
    
      <category term="linux" scheme="https://www.zoulei.net/categories/linux/"/>
    
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨shellä¿®æ”¹osxçš„CapsLockæ˜ å°„</title>
    <link href="https://www.zoulei.net/2016/08/29/use_shell_modifier_capslock_map_on_osx/"/>
    <id>https://www.zoulei.net/2016/08/29/use_shell_modifier_capslock_map_on_osx/</id>
    <published>2016-08-29T03:24:33.000Z</published>
    <updated>2016-08-29T03:49:10.000Z</updated>
    
    <content type="html"><![CDATA[<p>å¯¹äºå‘½ä»¤è¡Œçˆ±å¥½è€…,å¾ˆå¤šäººä¼šé€‰æ‹©å°†é»„é‡‘é”®ç›˜ä½ç½®CapsLockæ›¿æ¢æˆCtrl,æœ‰äº›äººé€‰æ‹©ä»…ä»…æ˜¯å’Œé»˜è®¤çš„Ctrlè¿›è¡Œæ›¿æ¢ï¼Œæœ‰äº›äººæ›´æç«¯ï¼Œç›¸å½“äºå»æ‰CapsLocké”®å¢åŠ ä¸€ä¸ªCtrlä½ç½®ã€‚æˆ‘é€‰æ‹©åè€…ã€‚æœ‰æ—¶å€™ä¼šæƒ³ã€‚å‡å¦‚éœ€è¦è¾“å…¥å¤§æ®µæ–‡å­—çš„æ—¶å€™ä¸€ç›´æŒ‰ä½Shiftå²‚ä¸æ˜¯è›‹ç–¼ã€‚æœç´¢äº†ä¸‹ï¼Œç½‘ä¸ŠçœŸæœ‰è¿™ä¸ªé—®é¢˜ã€‚è€Œä¸”æœ‰äººè¿˜ç»™å‡ºäº†ç­”æ¡ˆã€‚æˆ‘å°±è½¬å‘ä¸€ä¸‹å¥½äº†-_-</p>
<ul>
<li>é¦–å…ˆä½ è¦çŸ¥é“åœ¨ä½ çš„<code>system preferencesâ†’keyboardâ†’modifiers keys</code>æ˜¯å¯ä»¥ä¿®æ”¹CapsLockæ˜ å°„<br>åˆ°Ctrlçš„</li>
<li>å…¶æ¬¡ä½¿ç”¨applescriptå¯ä»¥ç¼–è¾‘è„šæœ¬å¯¹GUIç•Œé¢è¿›è¡Œæ“ä½œ(ç³»ç»Ÿè¿˜è‡ªå¸¦ä¸€ä¸ªScript Editor,ä¸å¾—ä¸åæ§½ä¸€ä¸‹,è„šæœ¬çœŸä¸ç¾è§‚)</li>
<li>è„šæœ¬ç¼–å†™åæ‰§è¡Œéœ€è¦åˆ°å®‰å…¨è®¾ç½®é‡Œé¢æ·»åŠ è®¸å¯æƒé™(<code>system preferencesâ†’security&amp;privacyâ†’accessibility</code>,ç”±äºæˆ‘ä½¿ç”¨çš„æ˜¯iTerm,å°†å®ƒåŠ å…¥å°±å¥½äº†)</li>
</ul>
<p>æœ€åå¥‰ä¸Šè„šæœ¬(æ·»åŠ è‡³~/.zshrc,!!!!ä»…å¯¹è‹±æ–‡ç³»ç»Ÿæœ‰æ•ˆ,ä¸­æ–‡ä¼°è®¡æ”¹ä¸€ä¸‹ä¹Ÿèƒ½ç”¨)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">caps () &#123;</div><div class="line">	osascript &gt; /dev/null &lt;&lt;EOF</div><div class="line">    tell application &quot;System Preferences&quot;</div><div class="line">        reveal anchor &quot;keyboardTab&quot; of pane &quot;com.apple.preference.keyboard&quot;</div><div class="line">    end tell</div><div class="line">    tell application &quot;System Events&quot; to tell window 1 of process &quot;System Preferences&quot;</div><div class="line">        click button 1 of tab group 1</div><div class="line">        tell sheet 1</div><div class="line">            tell pop up button 4</div><div class="line">                click</div><div class="line">                delay 0.1</div><div class="line">                if value is &quot;â‡ª Caps Lock&quot; then</div><div class="line">                    click menu item 2 of menu 1</div><div class="line">                    log &quot;Change Caps Lock&quot;</div><div class="line">                else</div><div class="line">                    click menu item 1 of menu 1</div><div class="line">                    log &quot;Restore Caps Lock&quot;</div><div class="line">                end if</div><div class="line">            end tell</div><div class="line">            click button &quot;OK&quot;</div><div class="line">        end tell</div><div class="line">    end tell</div><div class="line">    quit application &quot;System Preferences&quot;</div><div class="line">EOF</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://superuser.com/questions/495956/controlling-modifier-key-behavior-via-the-terminal-on-mac">Controlling modifier key behavior via the terminal on mac</a><br><a href="http://apple.stackexchange.com/questions/103621/run-applescript-from-bash-script">Run AppleScript from bash script</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¯¹äºå‘½ä»¤è¡Œçˆ±å¥½è€…,å¾ˆå¤šäººä¼šé€‰æ‹©å°†é»„é‡‘é”®ç›˜ä½ç½®CapsLockæ›¿æ¢æˆCtrl,æœ‰äº›äººé€‰æ‹©ä»…ä»…æ˜¯å’Œé»˜è®¤çš„Ctrlè¿›è¡Œæ›¿æ¢ï¼Œæœ‰äº›äººæ›´æç«¯ï¼Œç›¸å½“äºå»æ‰CapsLocké”®å¢åŠ ä¸€ä¸ªCtrlä½ç½®ã€‚æˆ‘é€‰æ‹©åè€…ã€‚æœ‰æ—¶å€™ä¼šæƒ³ã€‚å‡å¦‚éœ€è¦è¾“å…¥å¤§æ®µæ–‡å­—çš„æ—¶å€™ä¸€ç›´æŒ‰ä½Shiftå²‚ä¸æ˜¯è›‹ç–¼ã€‚æœç´¢äº†ä¸‹ï¼Œç½‘
    
    </summary>
    
      <category term="ä¼ªæŠ€æœ¯" scheme="https://www.zoulei.net/categories/%E4%BC%AA%E6%8A%80%E6%9C%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨Dockeré…ç½®é™æ€åšå®¢</title>
    <link href="https://www.zoulei.net/2016/08/21/docker_static_blog/"/>
    <id>https://www.zoulei.net/2016/08/21/docker_static_blog/</id>
    <published>2016-08-21T01:29:29.000Z</published>
    <updated>2016-08-29T13:53:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>é¦–å…ˆè¿™æ˜¯ç¯‡æ°´æ–‡:),ä»…è®°å½•ä¸‹è¿™2å¤©ä½¿ç”¨dockerçš„æƒ…å†µã€‚å®é™…ä¸Šå’Œdockeræ²¡ä»€ä¹ˆå…³ç³»,é™æ€åšå®¢å˜›,ç”Ÿæˆä¹‹åä¸Šä¼ åˆ°vpsç„¶åä¸Šé¢æ”¾ä¸ªnginxå°±å¥½äº†ï¼Œæ²¡ä»€ä¹ˆéœ€è¦æ“å¿ƒçš„</p>
<a id="more"></a>
<p>æ­¥éª¤å¦‚ä¸‹(æœåŠ¡ç«¯)ï¼š</p>
<ol>
<li>å‚ç…§dockerå®˜æ–¹æ–‡æ¡£å®‰è£…ä¸Šdocker,æœ€è€—æ—¶çš„å°±æ˜¯è¿™ä¸€æ­¥äº†ï¼Œå› ä¸ºdockerè™½ç„¶å‘å±•å‡ å¹´äº†ï¼Œå¯æ˜¯è¿˜æ˜¯å¤„äºä¸æ–­å®Œå–„ä¸­ã€‚è¿å®‰è£…æ–¹å¼éƒ½ä¸æ˜¯ç®€å•çš„<code>apt-get install xx</code>æå®š(å¦å¤–ç°åœ¨dockeræ”¯æŒçš„æœ€ä½ç‰ˆæœ¬å·æ˜¯3.1,æ„å‘³ç€openvzæ˜¯æ— æ³•ä½¿ç”¨çš„ï¼Œå› ä¸ºopenvzçš„å†…æ ¸ç‰ˆæœ¬å·æ˜¯2.6.32ï¼Œä¸”æ— æ³•å‡çº§)</li>
<li>åœ¨ä½ å­˜æ”¾é™æ€æ–‡ä»¶çš„ç›®å½•ä¸‹æ‰§è¡Œ <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -d --restart=always -p 80:80 -v `pwd`:/usr/share/nginx/html nginx</div></pre></td></tr></table></figure>
</li>
</ol>
<p>è§£é‡Šä¸€ä¸‹:</p>
<ul>
<li>då‚æ•°è¡¨ç¤ºä»¥detach,ä»¥åå°è¿›ç¨‹å½¢å¼ä¸€ç›´è¿è¡Œ</li>
<li><code>--restart=always</code>å½“å®¹å™¨å› ä¸ºå¼‚å¸¸é€€å‡ºç”šè‡³è¢«rebooté‡å¯æ“ä½œåæ— é™è‡ªåŠ¨é‡å¯</li>
<li>på‚æ•°ï¼Œç”¨è¿‡vagrantçš„æ¯”è¾ƒå¥½ç†è§£ï¼Œè™šæ‹Ÿæœºéƒ½æœ‰è¿™ä¹ˆä¸ªç©æ„å„¿ã€‚ç«¯å£æ˜ å°„</li>
<li>vå‚æ•°ã€‚vagrantä¹Ÿæœ‰è¿™ä¸ªæ¦‚å¿µã€‚æ–‡ä»¶å¤¹å…±äº«</li>
<li>è‡³äºå…±äº«çš„ç›®å½•,é‚£æ˜¯å› ä¸ºå®¹å™¨å†…nginxé»˜è®¤çš„é…ç½®æ—¢å¦‚æ­¤ã€‚é»˜è®¤æ–‡ä»¶ä½ç½®ä¸º/usr/share/nginx/htmlã€‚è¿™ä¸ªåœ°æ–¹å‰åçš„åœ°å€å¿…é¡»éƒ½æ˜¯ç»å¯¹åœ°å€ã€‚æ„Ÿè§‰è¦æ˜¯èƒ½ç”¨ç›¸å¯¹å°±å¥½äº†</li>
<li>å¦‚æœä½ è¦å»å®¹å™¨å†…çœ‹çœ‹å®ƒnginxçš„é…ç½®å•¥çš„æ‰§è¡Œ(exité€€å‡º)<code>docker run -it --restart=always -p 80:80 -v `pwd`:/usr/share/nginx/html nginx /bin/bash</code></li>
</ul>
<p>è‡³äºå®¢æˆ·ç«¯,ç”¨rsyncåŒæ­¥å°±å¥½äº†ã€‚æˆ‘ç”¨çš„æ˜¯hexoé™æ€åšå®¢ç”Ÿæˆå™¨ã€‚ä½¿ç”¨<a href="https://github.com/hexojs/hexo-deployer-rsync">https://github.com/hexojs/hexo-deployer-rsync</a>è¿™ä¸ªé…åˆssh configé…ç½®ä¸€ä¸‹å°±å¥½äº†ã€‚å¾ˆç®€å•O_o</p>
<p>å¦å¤–ç›®å‰æœ¬äººå°†è¿™ä¸ªé™æ€åšå®¢æ”¾åœ¨äº†3ä¸ªåœ°æ–¹:</p>
<ol>
<li>hostkerä½¿ç”¨gitéƒ¨ç½²<a href="https://www.zoulei.net">https://www.zoulei.net</a></li>
<li>github pagesä½¿ç”¨gitéƒ¨ç½²<a href="https://ficapy.github.io">https://ficapy.github.io</a></li>
<li>128M vps rsyncåŒæ­¥<a href="https://www.ficapy.com">https://www.ficapy.com</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;é¦–å…ˆè¿™æ˜¯ç¯‡æ°´æ–‡:),ä»…è®°å½•ä¸‹è¿™2å¤©ä½¿ç”¨dockerçš„æƒ…å†µã€‚å®é™…ä¸Šå’Œdockeræ²¡ä»€ä¹ˆå…³ç³»,é™æ€åšå®¢å˜›,ç”Ÿæˆä¹‹åä¸Šä¼ åˆ°vpsç„¶åä¸Šé¢æ”¾ä¸ªnginxå°±å¥½äº†ï¼Œæ²¡ä»€ä¹ˆéœ€è¦æ“å¿ƒçš„&lt;/p&gt;
    
    </summary>
    
      <category term="ä¼ªæŠ€æœ¯" scheme="https://www.zoulei.net/categories/%E4%BC%AA%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="docker" scheme="https://www.zoulei.net/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>werkzeugæºç åˆ†æ(Debugæ¨¡å—)</title>
    <link href="https://www.zoulei.net/2016/08/07/werkzeug_debug_note/"/>
    <id>https://www.zoulei.net/2016/08/07/werkzeug_debug_note/</id>
    <published>2016-08-07T00:43:31.000Z</published>
    <updated>2016-09-04T07:32:59.000Z</updated>
    
    <content type="html"><![CDATA[<p>flaskçš„debugçœ‹èµ·æ¥è¿˜æ˜¯å¾ˆç¥å¥‡çš„ï¼Œå¯ä»¥åœ¨å¼‚å¸¸é¡µé¢æŸ¥çœ‹å½“å‰è°ƒç”¨æ ˆï¼Œä¸”èƒ½å¤Ÿåœ¨å½“å‰æ ˆå†…è¿›è¡Œäº¤äº’å¼ä¼šè¯ç”¨ä»¥è°ƒè¯•ã€‚æœ¬æ–‡å°†ä¼šä»pythonçš„REPLè¿›è¡Œè¯´æ˜å¹¶å»¶ä¼¸åˆ°flaskã€‚çœ‹çœ‹å®ƒçš„å…·ä½“å®ç°</p>
<a id="more"></a>
<h3 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h3><p>pythonçš„è¿è¡Œæ˜¯è®²æºç è¿›è¡Œç¼–è¯‘ï¼Œä¹‹åè™šæ‹Ÿæœºæ‰§è¡Œã€‚è¿™2ä¸ªæ­¥éª¤pythonéƒ½æä¾›äº†æ¥å£,compileå’Œexecã€‚execçš„æ‰§è¡Œä¼šè°ƒç”¨compile,æˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šä¸»åŠ¨å»è°ƒç”¨compileã€‚compileè¿™ä¸ªå‡½æ•°æœ‰ä¸‰ä¸ªæ¨¡å¼<a href="https://docs.python.org/3/library/functions.html#compile">å®˜æ–¹æ–‡æ¡£</a> <a href="http://stackoverflow.com/questions/2220699/whats-the-difference-between-eval-exec-and-compile-in-python">stackoverflow</a></p>
<ul>
<li>exec:ä¸€ç³»åˆ—å£°æ˜</li>
<li>eval:å•æ¡è¡¨è¾¾å¼</li>
<li>single:å•æ¡å£°æ˜,å’Œexecä¸åŒçš„æ˜¯å½“è¿”å›ä¸ä¸ºNoneçš„æ—¶å€™æ‰§è¡Œçš„æ—¶å€™ä¼šæ‰“å°ã€‚è¿™ä¸€æƒ³éƒ½çŸ¥é“ä¸“é—¨æ˜¯ä¸ºäº¤äº’å¼ç¯å¢ƒå‡†å¤‡çš„</li>
</ul>
<p>ç¼–è¯‘ä¹‹åä¸ç”¨è¯´ã€‚ä½¿ç”¨å†…å»ºå‡½æ•°execæ‰§è¡Œå°±å¥½å•¦ã€‚å®ƒå¸¦æœ‰2ä¸ªå¯é€‰å‚æ•°,å…¨å±€ç©ºé—´å˜é‡åŠå±€éƒ¨ç©ºé—´å˜é‡ã€‚çœ‹ä¸€ä¸ªä¾‹å­<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">local = &#123;&#125;</div><div class="line">code = compile(<span class="string">'a=1'</span>, filename=<span class="string">'&lt;string&gt;'</span>, mode=<span class="string">'single'</span>)</div><div class="line">print(code)</div><div class="line">exec(code,local)</div><div class="line">code = compile(<span class="string">'a+=1'</span>, filename=<span class="string">'&lt;string&gt;'</span>, mode=<span class="string">'single'</span>)</div><div class="line"><span class="keyword">try</span>:</div><div class="line">    exec(code)</div><div class="line"><span class="keyword">except</span>:</div><div class="line">    print(<span class="string">'Error'</span>)</div><div class="line">exec(code,local)</div><div class="line">print(local.get(<span class="string">'a'</span>))</div><div class="line">code = compile(<span class="string">'x+=1'</span>,filename=<span class="string">'&lt;string&gt;'</span>,mode=<span class="string">'single'</span>)</div><div class="line">print(code)</div><div class="line"><span class="comment"># &lt;code object &lt;module&gt; at 0x10fd9dc90, file "&lt;string&gt;", line 1&gt;</span></div><div class="line"><span class="comment"># Error</span></div><div class="line"><span class="comment"># 2</span></div><div class="line"><span class="comment"># &lt;code object &lt;module&gt; at 0x105c25c90, file "&lt;string&gt;", line 1&gt;</span></div></pre></td></tr></table></figure></p>
<ol>
<li>ç¼–è¯‘çš„æ—¶å€™åªè¦è¯­æ³•æ²¡æœ‰é—®é¢˜å°±å¯ä»¥é€šè¿‡ï¼Œçœ‹x+=1,å³ä½¿å…¨å±€å˜é‡ä¸å­˜åœ¨xä¹Ÿèƒ½å¤Ÿç¼–è¯‘é€šè¿‡</li>
<li>ä½¿ç”¨execçš„æ—¶å€™ï¼Œå¯ä»¥å¼•å…¥ä¸€ä¸ªå­—å…¸ï¼Œå¦åˆ™ä¼šè‡ªåŠ¨ä½¿ç”¨é»˜è®¤çš„global,æœ‰äº†è¿™ä¸ªå­—å…¸æˆ‘ä»¬å°±å¯ä»¥è¿æ¥ä¸Šä¸‹æ–‡ï¼Œæƒ³ä¸€æƒ³ã€‚è¦æ˜¯æˆ‘ä»¬æ‰§è¡Œa=1ï¼Œå¦‚æœæ²¡æœ‰è®°å½•ã€‚é‚£ä¹ˆåé¢æ‰§è¡Œa+=1å°±ä¼šæŠ¥é”™äº†ï¼Œè¿™è‚¯å®šä¸æ˜¯æˆ‘ä»¬æ‰€å¸Œæœ›çš„</li>
</ol>
<h3 id="è‡ªå¸¦REPL"><a href="#è‡ªå¸¦REPL" class="headerlink" title="è‡ªå¸¦REPL"></a>è‡ªå¸¦REPL</h3><p>è¦å®ç°ä¸€ä¸ªç±»ä¼¼çš„IDLEç¯å¢ƒ2æ¡è¯­å¥å°±å¤Ÿäº†<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> code</div><div class="line">code.interact()</div></pre></td></tr></table></figure><br>çœ‹è°ƒç”¨å›¾<br><img src="http://ficapy.b0.upaiyun.com/blogimg/code_interactiveconsole.png" alt="code_interactiveconsole"><br>ä¼šæ¶‰åŠåˆ°2ä¸ªæ¨¡å—ï¼Œcodeå’Œcodeopï¼Œè¿™2ä¸ªæ¨¡å—å¯ä»¥éƒ½è¯´æ˜¯ä¸ºç”Ÿæˆäº¤äº’å¼è§£é‡Šå™¨æœåŠ¡çš„ã€‚codeæ¨¡å—ä½œç”¨æ˜¯æ¥æ”¶è¯·æ±‚ç„¶åè§£æå†æ‰§è¡Œ(exec)ã€‚è§£æéƒ¨åˆ†å°±æ˜¯ç”±codeopæä¾›çš„ã€‚è®¾æƒ³ä¸€ä¸‹ä¸ºä»€ä¹ˆæœ‰äº†compileè¿˜éœ€è¦ä¸€ä¸ªå•ç‹¬çš„codeopæ¨¡å—ã€‚<br>æˆ‘ä»¬ä½¿ç”¨äº¤äº’å¼è§£é‡Šå™¨çš„æ—¶å€™å¹¶ä¸æ˜¯æ‰€æœ‰çš„å‘½ä»¤éƒ½æ˜¯ä¸€è¡Œè¾“å…¥å®Œæˆçš„ã€‚æ¯”å¦‚è¾“å…¥ä¸€ä¸ªå‡½æ•°ï¼Œé‚£å°±éœ€è¦å¤šè¡Œã€‚å°†æˆ‘ä»¬è¾“å…¥çš„å¤šè¡Œç¼–è¯‘ä¸€æ¬¡ã€‚è¿™æ˜¯æˆ‘ä»¬çš„éœ€æ±‚ã€‚codeopå°±æ˜¯ä¸ºè¿™ä¸ªè€Œå­˜åœ¨çš„ã€‚æ¯”å¦‚ä½ æ‰§è¡Œcodeop.compile_command(â€˜math(â€˜)ä¼šè¿”å›Noneã€‚è¿™å°±ä»£è¡¨ä½ ä¸‹ä¸€è¡Œç»§ç»­è¾“å…¥ï¼Œç›´åˆ°ä½ è¿ç»­è¾“å…¥äº†2ä¸ªç©ºè¡Œã€‚å¥½äº†ï¼Œå®ƒçŸ¥é“ä½ è¾“å…¥å®Œæˆäº†ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">runsource</span><span class="params">(self, source, filename=<span class="string">"&lt;input&gt;"</span>, symbol=<span class="string">"single"</span>)</span>:</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        code = self.compile(source, filename, symbol)</div><div class="line">    <span class="keyword">except</span> (OverflowError, SyntaxError, ValueError):</div><div class="line">        <span class="comment"># Case 1</span></div><div class="line">        self.showsyntaxerror(filename)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> code <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        <span class="comment"># Case 2</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line"></div><div class="line">    <span class="comment"># Case 3</span></div><div class="line">    self.runcode(code)</div><div class="line">    <span class="keyword">return</span> <span class="keyword">False</span></div></pre></td></tr></table></figure><br>é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„ã€‚</p>
<h3 id="Exception-traceback-frameè”ç³»"><a href="#Exception-traceback-frameè”ç³»" class="headerlink" title="Exception,traceback,frameè”ç³»"></a>Exception,traceback,frameè”ç³»</h3><p>ä¸Šä¸ªä¾‹å­<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomeExcept</span><span class="params">(Exception)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, desc)</span>:</span></div><div class="line">        super(CustomeExcept, self).__init__()</div><div class="line">        self.desc = desc</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.desc</div><div class="line"></div><div class="line">    __str__ = __repr__</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">t</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">raise</span> CustomeExcept(<span class="string">'l'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">app</span><span class="params">()</span>:</span></div><div class="line">    a = <span class="number">1</span></div><div class="line">    t()</div><div class="line"><span class="keyword">try</span>:</div><div class="line">    app()</div><div class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">    <span class="comment"># traceback.print_exc(file=sys.stdout)</span></div><div class="line">    exc_type, exc_value, exc_tb = sys.exc_info()</div><div class="line">    print(exc_tb.tb_frame.f_lineno)</div><div class="line">    print(exc_type)</div><div class="line">    print(exc_value <span class="keyword">is</span> e)</div><div class="line">    print(exc_value)</div><div class="line">    print([i <span class="keyword">for</span> i <span class="keyword">in</span> dir(exc_tb) <span class="keyword">if</span> <span class="keyword">not</span> i.startswith(<span class="string">'_'</span>)])</div><div class="line">    print(exc_tb.tb_frame, exc_tb.tb_lineno, exc_tb.tb_next.tb_lineno, exc_tb.tb_next.tb_next.tb_lineno,</div><div class="line">          exc_tb.tb_next.tb_next.tb_next, sys._getframe(<span class="number">0</span>), exc_tb.tb_frame.f_back)</div><div class="line">    print(exc_tb.tb_next.tb_frame.f_locals)</div><div class="line"><span class="comment"># 23</span></div><div class="line"><span class="comment"># &lt;class '__main__.CustomeExcept'&gt;</span></div><div class="line"><span class="comment"># True</span></div><div class="line"><span class="comment"># l</span></div><div class="line"><span class="comment"># ['tb_frame', 'tb_lasti', 'tb_lineno', 'tb_next']</span></div><div class="line"><span class="comment"># &lt;frame object at 0x7f90b5813958&gt; 19 17 13 None &lt;frame object at 0x7f90b5813958&gt; None</span></div><div class="line"><span class="comment"># &#123;'a': 1&#125;</span></div></pre></td></tr></table></figure></p>
<ul>
<li>Exceptioné…åˆraiseä½¿ç”¨,ä½¿ç”¨exceptæ•è·å¼‚å¸¸çš„æ—¶å€™è¿”å›å®ƒçš„å®ä¾‹</li>
<li>è¿”å›çš„å®ä¾‹æ˜¯å’Œå¸§æ ˆFrameæ˜¯æ²¡æœ‰å…³ç³»çš„</li>
<li>sys.exc_infoè¿”å›äº†å¼‚å¸¸ç±»ï¼Œå¼‚å¸¸å®ä¾‹,tracebackå®ä¾‹</li>
<li>tracebackå¯¹è±¡è®°å½•çš„å¸§ä¸æ˜¯å½“å‰å¸§,è€Œæ˜¯ä»å‘èµ·å¼‚å¸¸çš„é‚£ä¸ªå‡½æ•°å¼€å§‹è®°å½•å¸§æ ˆ,å› æ­¤æ¯”å½“å‰å¸§æ ˆæ›´é•¿,tracebackçš„ä¸­æ–‡æ„æ€æ˜¯å›æº¯,å®ƒçš„tb_nextå¯ä»¥æƒ³è±¡ä¸€ä¸‹,å®é™…ä¸Šæ›´å¯ä»¥è¯´æ˜¯è¯»å–ä¸Šä¸€ä¸ªå¸§(å› ä¸ºå¼•å‘å¼‚å¸¸çš„é‚£ä¸ªå¸§å®é™…ä¸Šåœ¨æœ€ä¸Šé¢)</li>
<li>tb_nextè¿”å›çš„è¿˜æ˜¯ä¸€ä¸ªtracebackå¯¹è±¡</li>
<li>tracebackæ¨¡å—æä¾›äº†ä¸€äº›æ¥å£(æ¯”å¦‚traceback.print_exc)ä»å¸§ä¸­æå–å‡ºä¿¡æ¯ç„¶åæ ¼å¼åŒ–æ‰“å°<br>å·ä¸€å¼ å›¾(å¼•ç”¨è‡ª<a href="http://busuncle.github.io/python-vm-and-bytecode.html">http://busuncle.github.io/python-vm-and-bytecode.html</a>)<br><img src="https://ficapy.b0.upaiyun.com/blogimg/pyframeobject_busuncle.github.io.jpg" alt="pyframeobject"></li>
</ul>
<h3 id="werkzeugå®ç°"><a href="#werkzeugå®ç°" class="headerlink" title="werkzeugå®ç°"></a>werkzeugå®ç°</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">__debugger__:yes</div><div class="line">cmd:a = 1+1</div><div class="line">frm:0</div><div class="line">s:3WcibzVj8YXQDR0Na4bv</div></pre></td></tr></table></figure>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p><a href="http://busuncle.github.io/python-vm-and-bytecode.html">Pythonè™šæ‹Ÿæœºä¸å­—èŠ‚ç </a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;flaskçš„debugçœ‹èµ·æ¥è¿˜æ˜¯å¾ˆç¥å¥‡çš„ï¼Œå¯ä»¥åœ¨å¼‚å¸¸é¡µé¢æŸ¥çœ‹å½“å‰è°ƒç”¨æ ˆï¼Œä¸”èƒ½å¤Ÿåœ¨å½“å‰æ ˆå†…è¿›è¡Œäº¤äº’å¼ä¼šè¯ç”¨ä»¥è°ƒè¯•ã€‚æœ¬æ–‡å°†ä¼šä»pythonçš„REPLè¿›è¡Œè¯´æ˜å¹¶å»¶ä¼¸åˆ°flaskã€‚çœ‹çœ‹å®ƒçš„å…·ä½“å®ç°&lt;/p&gt;
    
    </summary>
    
      <category term="Flask" scheme="https://www.zoulei.net/categories/Flask/"/>
    
    
      <category term="Flask" scheme="https://www.zoulei.net/tags/Flask/"/>
    
  </entry>
  
  <entry>
    <title>redis-pyæºç åˆ†æ</title>
    <link href="https://www.zoulei.net/2016/08/06/redis_py_note/"/>
    <id>https://www.zoulei.net/2016/08/06/redis_py_note/</id>
    <published>2016-08-06T11:39:07.000Z</published>
    <updated>2016-08-06T23:04:33.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡ä¼šç®€è¿°è¯¥åº“çš„ä»£ç ç»„ç»‡æ¶æ„ï¼Œä¼šç€é‡ä»‹ç»å®ƒå®ç°çš„è¿æ¥æ± ConnectPoolä»¥åŠå¦‚ä½•å®ç°çš„çº¿ç¨‹ã€è¿›ç¨‹å®‰å…¨ã€‚</p>
<a id="more"></a>
<h3 id="æ–‡ä»¶ç»“æ„"><a href="#æ–‡ä»¶ç»“æ„" class="headerlink" title="æ–‡ä»¶ç»“æ„"></a>æ–‡ä»¶ç»“æ„</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">.</div><div class="line">â”œâ”€â”€ __init__.py</div><div class="line">â”œâ”€â”€ _compat.py          å…¼å®¹æ€§</div><div class="line">â”œâ”€â”€ client.py           å®ç°å®¢æˆ·ç«¯,è°ƒç”¨connectionpool</div><div class="line">â”œâ”€â”€ connection.py       å®ç°è¿æ¥æ± ï¼Œè¿æ¥ï¼Œè§£æå™¨</div><div class="line">â”œâ”€â”€ exceptions.py       å¼‚å¸¸ç±»</div><div class="line">â”œâ”€â”€ lock.py             å®ç°åˆ†å¸ƒå¼é”</div><div class="line">â”œâ”€â”€ sentinel.py         é…åˆredis sentinelæœºåˆ¶å®ç°é«˜å¯ç”¨å®¢æˆ·ç«¯</div><div class="line">â””â”€â”€ utils.py            è¾…åŠ©ç±»</div></pre></td></tr></table></figure>
<h3 id="å®ç°é€»è¾‘"><a href="#å®ç°é€»è¾‘" class="headerlink" title="å®ç°é€»è¾‘"></a>å®ç°é€»è¾‘</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> redis</div><div class="line">r = redis.Redis()</div><div class="line">r.set(<span class="string">'foob'</span>, <span class="string">'bar'</span>)</div></pre></td></tr></table></figure>
<p>çœ‹æ¶æ„å›¾<br><img src="https://ficapy.b0.upaiyun.com/blogimg/redis_py_arch.png" alt="redis_client_arch"><br>çœ‹è°ƒç”¨å›¾(ä»¥ä¸‹ä¸º5å¹´å‰çš„<a href="https://github.com/andymccurdy/redis-py/tree/2.4">2.4ç‰ˆæœ¬</a>)<br><img src="https://ficapy.b0.upaiyun.com/blogimg/redis_old_version.png" alt="redis_old_version"><br>ç¬¬ä¸€æ­¥æ‰§è¡Œ<code>r=redis.Redis()</code>æ²¡è¿›è¡Œä»€ä¹ˆæ“ä½œï¼ŒåŒæ—¶éšå¼çš„åˆå§‹åŒ–äº†ConnectionPoolã€‚<br>ç­‰åˆ°æ‰§è¡Œsetæ“ä½œçš„æ—¶å€™ã€‚å°±æ˜¯æ‰§è¡Œäº†execute_commandï¼Œæ­¤æ—¶åˆ†ä¸ºäº†å‡ ä¸ªæ­¥éª¤ã€‚çœ‹ç¬¬5ä¸ªå‡½æ•°è°ƒç”¨ï¼Œä»è¿æ¥æ± é‡Œé¢get_connectionã€‚å¦‚æœæ²¡æœ‰å¯ç”¨çš„ï¼Œé‚£ä¹ˆåˆ™æ–°å»º(redis.connection.Connection.<strong>init</strong>),æ­¤æ—¶å¹¶æ²¡æœ‰åˆ›å»ºsocketè¿æ¥ã€‚ç¬¬8ä¸ªå‡½æ•°è°ƒç”¨send_command,å‘½ä»¤æ‰“åŒ…ç„¶ååˆ›å»ºè¿æ¥å‘é€ã€‚è¯¥ç‰ˆæœ¬ä½¿ç”¨connection._sock.makefile(â€˜râ€™)ä¾¿äºè¯»å–ã€‚<br>å†åˆ°äº†ç¬¬21ä¸ªå‡½æ•°è°ƒç”¨Connection.read_response.ä½¿ç”¨è§£æå™¨ä»socketè¯»å–æ•°æ®å¹¶è½¬æ¢æˆä¾¿äºpythonä½¿ç”¨çš„æ•°æ®ç»“æ„<br>æœ€åfinallyå°†è¯¥è¿æ¥é‡Šæ”¾åˆ°çº¿ç¨‹æ± </p>
<p>ç°åœ¨å¯ä»¥çœ‹åˆ°æœ‰è¿™æ ·ä¸€æ¡å…³ç³»ï¼Œæ¯ä¸€ä¸ªredis.Redis()å®ä¾‹éƒ½æœ‰ä¸€ä¸ªConnectionPoolå¯¹è±¡,ä¸€ä¸ªè¿æ¥æ± è‡³å°‘å«æœ‰ä¸€æ¡è¿æ¥ã€‚æ‰€ä»¥ç»å¤§å¤šæ•°æƒ…å†µæ²¡æœ‰å¿…è¦å†™å‡ºè¿æ¥æ± <br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">pool = redis.ConnectionPool()</div><div class="line">r = redis.Redis(connection_pool=pool)</div><div class="line">ç­‰ä»·äº</div><div class="line">r = redis.Redis()</div></pre></td></tr></table></figure></p>
<h3 id="å¤šçº¿ç¨‹"><a href="#å¤šçº¿ç¨‹" class="headerlink" title="å¤šçº¿ç¨‹"></a>å¤šçº¿ç¨‹</h3><p>å¦‚æœä½ çš„ç¨‹åºæ˜¯å•çº¿ç¨‹çš„ã€‚é‚£ä¹ˆæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œä¸€ä¸ªRediså®ä¾‹ï¼Œä¸€ä¸ªè¿æ¥æ± ï¼Œä¸€ä¸ªsocketè¿æ¥ã€‚<br>å¤šçº¿ç¨‹é‚£æˆ‘ä»¬ä¸»è¦è€ƒè™‘çš„æ˜¯çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚å¯¹äºrediså®¢æˆ·ç«¯å°±æ˜¯socketè¿æ¥ç»å¯¹è¦çº¿ç¨‹é—´éš”ç¦»ï¼Œå¦åˆ™ä¸€ä¸ªçº¿ç¨‹è§£æäº†å¦å¤–ä¸€ä¸ªsocketçš„è¿”å›å†…å®¹ï¼Œé‚£ä¹ˆå¤šçº¿ç¨‹ä¹Ÿå°±æ²¡æ„ä¹‰äº†ã€‚æµ‹è¯•ä¸€ä¸‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">import</span> threading</div><div class="line"><span class="keyword">import</span> redis</div><div class="line">r = redis.Redis()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    r.setex(threading.get_ident(), threading.get_ident(), <span class="number">2</span>)</div><div class="line">    <span class="keyword">while</span> <span class="number">1</span>:</div><div class="line">        time.sleep(<span class="number">0.1</span>)</div><div class="line">        <span class="keyword">assert</span> r.get(threading.get_ident()) <span class="keyword">in</span> [str(threading.get_ident()).encode(), <span class="keyword">None</span>]</div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">50</span>):</div><div class="line">    threading.Thread(target=main).start()</div><div class="line"><span class="comment"># watch -n 1 "redis-cli INFO clients"    </span></div><div class="line"><span class="comment"># Every 1.0s: redis-cli INFO clients                                           Sat Aug  6 21:34:31 2016</span></div><div class="line"><span class="comment"># </span></div><div class="line"><span class="comment"># #Clients</span></div><div class="line"><span class="comment"># connected_clients:26</span></div><div class="line"><span class="comment"># client_longest_output_list:0</span></div><div class="line"><span class="comment"># client_biggest_input_buf:0</span></div><div class="line"><span class="comment"># blocked_clients:0</span></div></pre></td></tr></table></figure><br>å¯ä»¥çœ‹åˆ°ç»“æœå¹¶æ²¡æœ‰é”™è¯¯ï¼Œè€Œä¸”åˆ›å»ºçš„è¿æ¥æ•°å’Œåˆ›å»ºçš„çº¿ç¨‹æ•°å¹¶ä¸æ˜¯ä¸€è‡´çš„</p>
<p>è¯•æƒ³ä¸€ä¸‹ï¼Œæ¯æ¬¡æ‰§è¡Œä¸€æ¬¡ç±»ä¼¼setçš„æŒ‡ä»¤ã€‚éƒ½ä¼šä»è¿æ¥æ± (Listç»“æ„)å–å‡º(pop)ä¸€ä¸ªè¿æ¥ã€‚è€Œlist.popæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚æ‰§è¡Œå®Œæ¯•å‘½ä»¤ååˆä¼šä½¿ç”¨appendåŠ å…¥åˆ°è¿æ¥æ± ï¼Œlist.appendä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚æ‰€ä»¥é’ˆå¯¹socketçš„æ“ä½œæ˜¯çº¿ç¨‹éš”ç¦»çš„ã€‚è¿™ä¸€åˆ‡å¥½åƒå’Œ_in_use_connectionså¹¶æ²¡æœ‰ä»€ä¹ˆå…³ç³»ã€‚å¯¹äºä¸€ä¸ªç®€å•çš„è¿æ¥æ± ã€‚ä»è¿æ¥æ± å–å‡ºï¼Œç”¨å®ŒåŠ å…¥åˆ°è¿æ¥æ± ã€‚è€Œ_in_use_connectionsè®°å½•çš„æ˜¯ä½¿ç”¨ä¸­çš„çº¿ç¨‹ã€‚å•¥å­ç”¨å‘¢ã€‚å®ƒç”¨äºä¸€ä¸ªæ¥å£(å…³é—­è¿æ¥æ± ä¸­çš„æ‰€æœ‰è¿æ¥)ã€‚æ³¨æ„å…³é—­è¿æ¥å¹¶ä¸ä¼šå°†_available_connectionså’Œ_in_use_connectionsæ¸…ç©ºã€‚å®ƒåªä¼šå°†connectionå¯¹è±¡ä¸­çš„_sockè®¾ç½®ä¸ºNoneï¼Œè€Œæ¯æ¬¡æ‰§è¡Œå‘½ä»¤çš„æ—¶å€™connectionéƒ½æ˜¯ä¼šæ£€æŸ¥_sockæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™ä¼šé‡æ–°å»ºç«‹è¿æ¥,å¦‚ä¸‹ç¤ºä¾‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> redis</div><div class="line"></div><div class="line">r = redis.Redis()</div><div class="line">r.setex(<span class="string">'key'</span>, <span class="string">'value'</span>, <span class="number">20</span>)</div><div class="line">print(r.connection_pool._available_connections[<span class="number">0</span>]._sock)</div><div class="line">r.connection_pool.disconnect()</div><div class="line">print(r.connection_pool._available_connections[<span class="number">0</span>]._sock)</div><div class="line">r.setex(<span class="string">'key'</span>,<span class="string">'value'</span>,<span class="number">20</span>)</div><div class="line">print(r.connection_pool._available_connections[<span class="number">0</span>]._sock)</div><div class="line"><span class="comment"># &lt;socket.socket fd=5, family=AddressFamily.AF_INET6, type=SocketKind.SOCK_STREAM, proto=6, laddr=('::1', 62900, 0, 0), raddr=('::1', 6379, 0, 0)&gt;</span></div><div class="line"><span class="comment"># None</span></div><div class="line"><span class="comment"># &lt;socket.socket fd=5, family=AddressFamily.AF_INET6, type=SocketKind.SOCK_STREAM, proto=6, laddr=('::1', 62901, 0, 0), raddr=('::1', 6379, 0, 0)&gt;</span></div></pre></td></tr></table></figure><br>å› ä¸ºå®ƒå…³é—­è¿æ¥çš„æ—¶å€™å¹¶æ²¡æœ‰å°†å¯¹åº”çš„connectionå¯¹è±¡ä»è¿æ¥æ± ä¸­åˆ é™¤ã€‚é‚£ä¹ˆä¼šé€ æˆä¸€ä¸ªé—®é¢˜ã€‚å¦‚æœä½ åˆ›å»ºè¿‡100ä¸ªè¿æ¥ï¼Œé‚£ä¹ˆè¿æ¥æ± å°†ä¼šä¸€ç›´å¤ç”¨è¿™äº›å¯¹è±¡ã€‚å¦‚æœä½ é«˜å³°æœŸåˆ›å»ºè¿‡å¤šçš„è¿æ¥ï¼Œè€Œååˆåªéœ€è¦å‡ ä¸ªè¿æ¥å°±å¤Ÿäº†(è™½ç„¶è¿™æ ·çš„é—®é¢˜ä¼°è®¡æå°‘ä¼šé‡åˆ°)ã€‚ä½ å¯ä»¥æ˜¾å¼çš„popå‡º_available_connectionså¹¶å…³é—­ã€‚<br>å…¶å®æœ‰ä¸€ä¸ªåœ°æ–¹æ˜¯éçº¿ç¨‹å®‰å…¨çš„ã€‚åœ¨åˆ›å»ºè¿æ¥çš„æ—¶å€™æœ‰self._created_connections += 1,å¦‚æœä½ è®¿é—®è¿™ä¸ªå€¼å¾—åˆ°åˆ›å»ºçš„è¿æ¥æ•°æ˜¯ä¸å¯é çš„ã€‚ä¸è¿‡è¿™éƒ½æ— å…³ç´§è¦ï¼Œå› ä¸ºä½ ä¸å¯èƒ½åœ¨æçŸ­çš„æ—¶é—´å†…åˆ›å»ºè®¸å¤šè¿æ¥ã€‚å³ä½¿è¿™é‡Œä¸å‡†ã€‚ç»Ÿè®¡è¯¯å·®ä¹Ÿä¸ä¼šæœ‰2ä¸ªã€‚</p>
<p>ä¸ºäº†é¿å…æ— ç«¯åˆ›å»ºå‡ºNå¤šè¿æ¥ã€‚è¯¥å®¢æˆ·ç«¯åæœŸåŠ å…¥äº†BlockingConnectionPoolç±»ã€‚ä½¿ç”¨LifoQueueåˆ›å»ºå‡ºè¿æ¥é˜Ÿåˆ—ï¼Œå¦‚æœè¯¥é˜Ÿåˆ—è¢«ä½¿ç”¨å®Œï¼Œé‚£ä¹ˆåç»­è¯·æ±‚å°†ä¼šé˜»å¡ä¸€æ®µæ—¶é—´ï¼Œè¿‡é•¿åˆ™å¼•å‘å¼‚å¸¸ã€‚</p>
<h3 id="å¤šè¿›ç¨‹å®‰å…¨"><a href="#å¤šè¿›ç¨‹å®‰å…¨" class="headerlink" title="å¤šè¿›ç¨‹å®‰å…¨"></a>å¤šè¿›ç¨‹å®‰å…¨</h3><p>redis-pyåœ¨2.4.12åŠ å…¥äº†å¤šçº¿ç¨‹å®‰å…¨<a href="https://github.com/andymccurdy/redis-py/issues/234">è§issues</a>ã€‚<br>å¯ä»¥çœ‹åˆ°å®ç°åŸç†ä¹Ÿæ˜¯å¾ˆç®€å•çš„ã€‚forkè¿›ç¨‹çš„æ—¶å€™socketä¸€æ ·ä½¿ç”¨çš„ã€‚ä¸ºäº†åˆ†å¼€ï¼Œä½¿ç”¨äº†os.getpid()åŒºåˆ†ã€‚å¦‚æœè¿›ç¨‹å·å˜äº†ï¼Œåˆ™å…³é—­æ‰€æœ‰çš„è¿æ¥ï¼Œé‡æ–°è¿æ¥åè‡ªç„¶å°±åˆ†å¼€äº†ã€‚åŒæ—¶ä¸ºäº†é˜²æ­¢ä¸€ä¸ªè¿›ç¨‹æœ‰å¤šä¸ªçº¿ç¨‹è¿™ç§æƒ…å†µã€‚ä¸€ä¸ªçº¿ç¨‹å…³é—­åï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¹Ÿå¯èƒ½æ‰§è¡Œå…³é—­æ“ä½œã€‚æ‰€ä»¥æ­¤å¤„ä½¿ç”¨äº†é”<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_checkpid</span><span class="params">(self)</span>:</span></div><div class="line">    <span class="keyword">if</span> self.pid != os.getpid():</div><div class="line">        <span class="keyword">with</span> self._check_lock:</div><div class="line">            <span class="keyword">if</span> self.pid == os.getpid():</div><div class="line">                <span class="comment"># another thread already did the work while we waited</span></div><div class="line">                <span class="comment"># on the lock.</span></div><div class="line">                <span class="keyword">return</span></div><div class="line">            self.disconnect()</div><div class="line">            self.reset()</div></pre></td></tr></table></figure></p>
<p>æ’æ’­ä¸€ä¸‹å½“å‰2.10.5ç‰ˆæœ¬çš„è°ƒç”¨å›¾<br><img src="http://ficapy.b0.upaiyun.com/blogimg/redis_pool.png" alt="new_redis_pool"><br>å¯ä»¥çœ‹åˆ°å’Œæœ€ä¸Šé¢çš„è°ƒç”¨å›¾å‡ºå…¥å¾ˆå°ï¼Œä»…ä»…åŠ å…¥äº†è¿›ç¨‹å®‰å…¨,å°†socket.makefileå˜æˆäº†SocketBuffer.</p>
<h3 id="åˆ†å¸ƒå¼é”"><a href="#åˆ†å¸ƒå¼é”" class="headerlink" title="åˆ†å¸ƒå¼é”"></a>åˆ†å¸ƒå¼é”</h3><p>çº¿ç¨‹é”å°±æ˜¯å¤šçº¿ç¨‹é—´æœ‰çº¿ç¨‹é—´å…±äº«å˜é‡ã€‚è¿›ç¨‹é”å°±æ˜¯å¤šè¿›ç¨‹é—´æœ‰è¿›ç¨‹é—´å…±äº«å˜é‡ã€‚æ­¤å¤„çš„å…±äº«å˜é‡å°±æ˜¯å°†å˜é‡å­˜å‚¨åˆ°redisæ•°æ®åº“ã€‚å®ç°ä¹Ÿæ¯”è¾ƒç®€å•ã€‚æˆªå–ä¸€æ®µacquireçœ‹çœ‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_acquire</span><span class="params">(self, token)</span>:</span></div><div class="line">    <span class="keyword">if</span> self.redis.setnx(self.name, token):</div><div class="line">        <span class="keyword">if</span> self.timeout:</div><div class="line">            <span class="comment"># convert to milliseconds</span></div><div class="line">            timeout = int(self.timeout * <span class="number">1000</span>)</div><div class="line">            self.redis.pexpire(self.name, timeout)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">False</span></div></pre></td></tr></table></figure><br>å¦å¤–å®ƒå®ç°çš„åªæ˜¯æœ€ç®€å•çš„é”ã€‚æ¯”å¦‚å¯é‡å…¥é”å•¥çš„éƒ½æ˜¯æ²¡æœ‰å®ç°çš„ã€‚å¦‚æœä½ æƒ³é…åˆsentinelè¿›è¡Œé«˜å¯ç”¨ã€‚å¾€ä¸‹çœ‹â€¦..</p>
<h3 id="Sentinel"><a href="#Sentinel" class="headerlink" title="Sentinel"></a>Sentinel</h3><p><img src="https://ficapy.b0.upaiyun.com/blogimg/redis_sentinel.png" alt="redis_sentinel"><br>å¾—ç›Šäºredis-pyçš„æ¾è€¦åˆï¼Œè¿æ¥æ± ã€è¿æ¥ã€è§£æå™¨åŸºæœ¬éƒ½å¾ˆç‹¬ç«‹ã€‚<br>å®¢æˆ·ç«¯å’Œç›‘è§†å™¨ç»„åˆ›å»ºä¸€ä¸ªä¸Šé¢è¯´çš„Redisæ­£å¸¸è¿æ¥ã€‚å®ƒä¸»è¦æä¾›æ¥å£è¿”å›masterçš„åœ°å€å’Œè¿”å›salveçš„åœ°å€ã€‚<br>ç„¶åæˆ‘ä»¬ä½¿ç”¨master_forè¿”å›çš„ä¹Ÿæ˜¯ä¸€ä¸ªRedisè¿æ¥<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">return redis_class(connection_pool=connection_pool_class(</div><div class="line">            service_name, self, **connection_kwargs))</div></pre></td></tr></table></figure></p>
<p>ä¸è¿‡å®ƒè¿›è¡Œå¯¹è¿æ¥æ± å’Œè¿æ¥å¯¹è±¡éƒ½è¿›è¡Œäº†ä¸€äº›ä¿®æ”¹ã€‚å¯ä»¥çœ‹åˆ°å®ƒå°†selfä¼ é€’ç»™äº†åº•å±‚è¿æ¥æ± ã€‚è€Œè¿æ¥æ± ä¹Ÿä½¿ç”¨<code>self.connection_kwargs[&#39;connection_pool&#39;] = weakref.proxy(self)</code>å°†è‡ªå·±ä¼ é€’ç»™äº†åº•å±‚Connectionï¼Œå°±è¿™æ ·å®ƒå®ç°äº†é«˜å¯ç”¨å®¢æˆ·ç«¯ï¼Œåœ¨åº•å±‚è¿æ¥çš„æ—¶å€™ä½¿ç”¨é«˜å±‚æä¾›çš„å‡½æ•°æä¾›æ­£ç¡®çš„åœ°å€~~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ¬æ–‡ä¼šç®€è¿°è¯¥åº“çš„ä»£ç ç»„ç»‡æ¶æ„ï¼Œä¼šç€é‡ä»‹ç»å®ƒå®ç°çš„è¿æ¥æ± ConnectPoolä»¥åŠå¦‚ä½•å®ç°çš„çº¿ç¨‹ã€è¿›ç¨‹å®‰å…¨ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æºç è§£æ" scheme="https://www.zoulei.net/categories/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
    
      <category term="python" scheme="https://www.zoulei.net/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>werkzeugæºç åˆ†æ(local.py)</title>
    <link href="https://www.zoulei.net/2016/08/03/werkzeug_local_note/"/>
    <id>https://www.zoulei.net/2016/08/03/werkzeug_local_note/</id>
    <published>2016-08-03T00:58:00.000Z</published>
    <updated>2016-09-04T08:14:45.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ‰äººè¯´flaskçš„ä¸Šä¸‹æ–‡æœºåˆ¶æ˜¯æ•´ä¸ªæ¡†æ¶çš„ç²¾åéƒ¨åˆ†ï¼Œæœ‰äººè¯´å®ƒç¥å¥‡çš„gè®©äººè´¹è§£ã€‚werkzeugçš„local.pyå°±æ˜¯å®ƒçš„å…·ä½“å®ç°ã€‚è¿™ä¸ªçœ‹ä¼¼ç¥å¥‡çš„æœºåˆ¶èƒŒååŠ ä¸Šåº”ç”¨ä»£ç ä¹Ÿä¸è¿‡ä¸¤ä¸‰ç™¾è¡Œã€‚ä¸è¿‡å¥½åƒå‘è¿˜æ˜¯<code>æ¯”è¾ƒæ·±</code>çš„ã€‚å¦å¤–flaskçš„0.1ç‰ˆæœ¬æ‰200å¤šè¡Œä»£ç ã€‚å€¼å¾—ç…ä¸€ä¸‹</p>
<a id="more"></a>
<h3 id="ç›´è§‚æ„Ÿå—ä¸Šä¸‹æ–‡"><a href="#ç›´è§‚æ„Ÿå—ä¸Šä¸‹æ–‡" class="headerlink" title="ç›´è§‚æ„Ÿå—ä¸Šä¸‹æ–‡"></a>ç›´è§‚æ„Ÿå—ä¸Šä¸‹æ–‡</h3><p>ä½¿ç”¨wrkè¿›è¡Œå‹æµ‹<code>wrk -t300 -c300 -d10s http://127.0.0.1:5000</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">import</span> random</div><div class="line"><span class="keyword">from</span> pprint <span class="keyword">import</span> pprint</div><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</div><div class="line"><span class="keyword">from</span> flask.globals <span class="keyword">import</span> _request_ctx_stack,_app_ctx_stack</div><div class="line"></div><div class="line">app = Flask(__name__)</div><div class="line"><span class="meta">@app.route('/')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></div><div class="line">    time.sleep(random.random())</div><div class="line">    pprint(_request_ctx_stack._local.__storage__)</div><div class="line">    pprint(_app_ctx_stack._local.__storage__)</div><div class="line">    <span class="keyword">return</span> <span class="string">''</span></div><div class="line"></div><div class="line">app.run(threaded=<span class="keyword">True</span>)</div><div class="line"></div><div class="line"><span class="comment"># æŸä¸€æ—¶åˆ»çŠ¶æ€</span></div><div class="line"><span class="comment"># &#123;123145360109568: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></div><div class="line"><span class="comment">#  123145391640576: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></div><div class="line"><span class="comment">#  123145407406080: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></div><div class="line"><span class="comment">#  123145417916416: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></div><div class="line"><span class="comment">#  123145428426752: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></div><div class="line"><span class="comment">#  123145459957760: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></div><div class="line"><span class="comment">#  123145480978432: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></div><div class="line"><span class="comment">#  123145496743936: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></div><div class="line"><span class="comment">#  123145512509440: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></div><div class="line"><span class="comment">#  123145538785280: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></div><div class="line"><span class="comment">#  123145549295616: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></div><div class="line"><span class="comment">#  123145601847296: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></div><div class="line"><span class="comment">#  123145638633472: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></div><div class="line"><span class="comment">#  123145680674816: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></div><div class="line"><span class="comment">#  123145743736832: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;,</span></div><div class="line"><span class="comment">#  123145764757504: &#123;'stack': [&lt;RequestContext 'http://127.0.0.1:5000/' [GET] of temp&gt;]&#125;&#125;</span></div><div class="line"><span class="comment"># &#123;123145360109568: &#123;'stack': [&lt;flask.ctx.AppContext object at 0x103f90f60&gt;]&#125;,</span></div><div class="line"><span class="comment">#  123145391640576: &#123;'stack': [&lt;flask.ctx.AppContext object at 0x103fcdc50&gt;]&#125;,</span></div><div class="line"><span class="comment">#  123145407406080: &#123;'stack': [&lt;flask.ctx.AppContext object at 0x10402c080&gt;]&#125;,</span></div><div class="line"><span class="comment">#  123145417916416: &#123;'stack': [&lt;flask.ctx.AppContext object at 0x103fa0668&gt;]&#125;,</span></div><div class="line"><span class="comment">#  123145428426752: &#123;'stack': [&lt;flask.ctx.AppContext object at 0x104058828&gt;]&#125;,</span></div><div class="line"><span class="comment">#  123145459957760: &#123;'stack': [&lt;flask.ctx.AppContext object at 0x103fd8470&gt;]&#125;,</span></div><div class="line"><span class="comment">#  123145480978432: &#123;'stack': [&lt;flask.ctx.AppContext object at 0x1040859e8&gt;]&#125;,</span></div><div class="line"><span class="comment">#  123145496743936: &#123;'stack': [&lt;flask.ctx.AppContext object at 0x104078cf8&gt;]&#125;,</span></div><div class="line"><span class="comment">#  123145512509440: &#123;'stack': [&lt;flask.ctx.AppContext object at 0x104036c88&gt;]&#125;,</span></div></pre></td></tr></table></figure></p>
<h3 id="ä¸ºä»€ä¹ˆä¼šæœ‰Local"><a href="#ä¸ºä»€ä¹ˆä¼šæœ‰Local" class="headerlink" title="ä¸ºä»€ä¹ˆä¼šæœ‰Local"></a>ä¸ºä»€ä¹ˆä¼šæœ‰Local</h3><p>æ¯”è¾ƒæŠ½è±¡çš„è§£é‡Šå«å®ƒ<code>çº¿ç¨‹å†…å…±äº«å˜é‡</code>ï¼Œä¸‹é¢æ¥ä¸ªä¾‹å­<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> threading</div><div class="line"></div><div class="line">l = threading.local()</div><div class="line">l.a = <span class="number">1</span></div><div class="line">threading.Thread(target=<span class="keyword">lambda</span>: setattr(l, <span class="string">'a'</span>, <span class="number">2</span>) <span class="keyword">or</span> print(l.a, threading.current_thread())).start()</div><div class="line">print(l.a)</div><div class="line"><span class="comment"># 2 &lt;Thread(Thread-1, started 123145307557888)&gt;</span></div><div class="line"><span class="comment"># 1</span></div></pre></td></tr></table></figure><br>å¯ä»¥çœ‹å‡ºå°±æ˜¯ä¸€å…¨å±€å¯¹è±¡å¯¹å®ƒè®¾ç½®çš„å±æ€§åœ¨çº¿ç¨‹é—´æ˜¯éš”ç¦»çš„ã€‚å¯æ˜¯è¿™åˆæœ‰ä»€ä¹ˆç”¨ã€‚æˆ‘ä»¬ä½œä¸ºæ¡†æ¶ä½¿ç”¨è€…é€»è¾‘ä¸€èˆ¬éƒ½æ˜¯å†™åœ¨ä¸€èµ·çš„ï¼Œæ²¡æœ‰äººä¼šæ•…æ„å»åƒè¿™æ ·å†™<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">l = threading.local()</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    l.a = <span class="number">1</span></div><div class="line">    l.a  <span class="comment">##è¿›è¡Œå¼•ç”¨</span></div></pre></td></tr></table></figure><br>å¯æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯æ¡†æ¶ï¼çº¿ç¨‹çš„è°ƒèµ·ä¸æ˜¯æˆ‘ä»¬ä¸»åŠ¨å»æ“ä½œçš„ã€‚æ¡†æ¶ä¼šæœ‰ä¸€äº›ç¬¬ä¸‰æ–¹æ‰©å±•ã€‚å®ƒä»¬ä¾é æ­¤æœºåˆ¶ç»™æˆ‘ä»¬æä¾›æ¥å£ï¼Œæ¯”å¦‚æ¥ä¸ª<a href="http://flask.pocoo.org/docs/0.11/appcontext/#context-usage">å®˜æ–¹ç¤ºä¾‹</a><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sqlite3</div><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> g</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_db</span><span class="params">()</span>:</span></div><div class="line">    db = getattr(g, <span class="string">'_database'</span>, <span class="keyword">None</span>)</div><div class="line">    <span class="keyword">if</span> db <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        db = g._database = connect_to_database()</div><div class="line">    <span class="keyword">return</span> db</div><div class="line"><span class="comment">#=========================</span></div><div class="line"><span class="keyword">from</span> werkzeug.local <span class="keyword">import</span> LocalProxy</div><div class="line">db = LocalProxy(get_db)    </div></pre></td></tr></table></figure></p>
<p>Localçš„å®ç°åŸç†å¾ˆç®€å•ï¼Œè¿™é‡Œä¸è¯¦è¿°äº†ã€‚å°±æ˜¯å‰ä¸€ç¯‡åšæ–‡è¯´çš„å­—å…¸çš„<code>dict[key] = value</code>æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å…¶å®threading.localä¹Ÿæ˜¯ä¸€æ ·çš„ä½œç”¨ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¸ç”¨å®ƒã€‚</p>
<ul>
<li>æ”¯æŒäº†greenlet(æœ¬åšæ–‡åªä¼šæ¶‰åŠåˆ°å¤šçº¿ç¨‹æƒ…å†µ)</li>
<li>è‡ªå¸¦çš„å†™æ³•å¤ªç‰¹ä¹ˆæ¶å¿ƒäº†ï¼Œé‚£ä¸ªæºç æˆ‘éƒ½å¿«çœ‹åäº†ï¼Œä¸å¦‚è‡ªå·±å†™ä¸€ä¸ª(æˆ‘éƒ½æ²¡çœ‹é€è‡ªå¸¦çš„ä¸ºä»€ä¹ˆè¦é‚£ä¹ˆå†™,å¦‚æœä½ èƒ½è½»æ¾çœ‹æ˜ç™½ï¼Œé‚£ä¹ˆä½ è‚¯å®šæ˜¯çœ‹é­”æœ¯æ–¹æ³•çš„å¤§ç¥)<br>ç®€è¿°ä¸‹è‡ªå¸¦çš„é€»è¾‘ï¼Œä¸»è¦æ˜¯è¿™å‡ å¥<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"># python2.7.11ä»£ç </div><div class="line">dict = object.__getattribute__(self, &apos;__dict__&apos;)</div><div class="line">current_thread().__dict__[key] = dict</div><div class="line"></div><div class="line">key = object.__getattribute__(self, &apos;_local__key&apos;)</div><div class="line">d = current_thread().__dict__.get(key)</div><div class="line"># import threading</div><div class="line"># l = threading.current_thread()</div><div class="line"># print(l is threading.current_thread())</div><div class="line"># threading.Thread(target=lambda :print(threading.current_thread() is l)).start()</div><div class="line"># True</div><div class="line"># False</div></pre></td></tr></table></figure>
</li>
</ul>
<p>åœ¨åŒä¸€çº¿ç¨‹å†…threading.current_thread()æ˜¯åŒä¸€å¯¹è±¡ï¼Œæœ‰ä¸€ä¸ª_patchå‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨localå±æ€§è¢«è°ƒç”¨å‰æå‰è°ƒç”¨ï¼Œå°†current_thread().__dict__ç›¸å…³çš„å†…å®¹ç»‘å®šåœ¨local.__dict__ä¸Šã€‚</p>
<h3 id="ä¸ºä»€ä¹ˆä¼šæœ‰LocalStack"><a href="#ä¸ºä»€ä¹ˆä¼šæœ‰LocalStack" class="headerlink" title="ä¸ºä»€ä¹ˆä¼šæœ‰LocalStack"></a>ä¸ºä»€ä¹ˆä¼šæœ‰LocalStack</h3><p>å®ƒä¸»è¦å°†ä¸Šé¢çš„Localç”±<code>l.key = value</code>å˜æˆäº†<code>l.push(value)</code>ã€‚å˜æˆäº†æ ˆç»“æ„ã€‚å¯æ˜¯ä»ä¸Šé¢çš„ç›´è§‚æ„Ÿå—ä¸Šä¸‹æ–‡éƒ¨åˆ†å¯ä»¥çœ‹åˆ°åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä»»ä¸€æ—¶åˆ»æ ˆé‡Œé¢éƒ½ä»…æœ‰ä¸€ä¸ªå†…å®¹ã€‚é‚£ä¹ˆè¿˜ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æ ˆå‘¢ï¼Œå¾€ä¸‹çœ‹ã€‚</p>
<h3 id="ä¸ºä»€ä¹ˆä¼šæœ‰LocalProxy"><a href="#ä¸ºä»€ä¹ˆä¼šæœ‰LocalProxy" class="headerlink" title="ä¸ºä»€ä¹ˆä¼šæœ‰LocalProxy"></a>ä¸ºä»€ä¹ˆä¼šæœ‰LocalProxy</h3><p>ä»åå­—å°±å¯ä»¥çœ‹å‡ºæ¥æ˜¯ä»£ç†æ¨¡å¼ã€‚å¯ä»¥çœ‹çœ‹githubä¸Šçš„<a href="https://github.com/faif/python-patterns/blob/master/proxy.py">è®¾è®¡æ¨¡å¼</a>ï¼ŒåŒæ ·æ˜¯è®²çš„ä»£ç†æ¨¡å¼ï¼Œflaskçš„å®é™…åº”ç”¨å°±æ¯”è¿™ä¸ªä¾‹å­è¦é«˜æ˜çš„å¤š</p>
<p>æˆ‘ä»¬ä½¿ç”¨ä»£ç†æ˜¯ä¸ºäº†ç»•è¿‡é˜²ç«å¢™è®¿é—®å¤–é¢çš„ä¸–ç•Œï¼Œé‚£ä¹ˆLocalProxyè¿™ä¸ªä»£ç†æ˜¯å¹²å•¥å­çš„å‘¢ã€‚è®¾æƒ³ä¸€ä¸‹ã€‚æˆ‘ä»¬ä½¿ç”¨äº†l = Local()å¹¶ä¸”åœ¨ä¸Šé¢ç»™ä¸€ä¸ªå±æ€§èµ‹å€¼äº†l.key = valueã€‚é‚£ä¹ˆå½“ä½ è¦è°ƒç”¨çš„æ—¶å€™å°±ä½¿ç”¨l.keyå°±å¥½å•¦ã€‚ç°åœ¨æˆ‘ä»¬æ²¡æœ‰ç›´æ¥ç”¨Localç”¨çš„æ˜¯l = LocalStack(),l.push(RequestContext()),requestè¿™ä¸ªå±æ€§åˆåœ¨<br>RequestContext()è¿™ä¸ªå¯¹è±¡ä¸Šã€‚é‚£ä¹ˆæˆ‘ä»¬è¦è®¿é—®requestæ€ä¹ˆåŠï¼æ­¤æ—¶ä½ å°±è¦æ‰§è¡Œl.top.requestè¿›è¡Œè®¿é—®ã€‚å¯æ˜¯ä¼˜é›…å‘¢ï¼ä¼˜é›…å‘¢ï¼ä¼˜é›…å‘¢ï¼ä¼˜é›…å“ªé‡Œå»äº†ã€‚æˆ‘ä»¬å¾ˆæ‡’ï¼Œæˆ‘ä»¬æƒ³æ‰§è¡Œä¸€ä¸ªrequestå°±èƒ½ä»£æ›¿l.top.request(æœ‰äººä¼šé—®ä¸ºä»€ä¹ˆä¸ç›´æ¥å†™æ­»reques = l.top.requestï¼Œé‚£æ˜¯å› ä¸ºå®ƒæ˜¯æ­»ï¼ï¼ï¼çš„,è€Œl.top.requestæ˜¯éšç€çº¿ç¨‹è¿›å…¥é€€å‡ºä¸€ç›´å‡ºå…¥æ ˆåŠ¨æ€å˜åŒ–çš„ï¼Œæˆ‘ä»¬åªèƒ½åœ¨æ¯æ¬¡ä½¿ç”¨çš„æ—¶å€™æ‰§è¡Œl.top.requestå¾—åˆ°æ­£ç¡®çš„ç»“æœ)ã€‚â†’_â†’è¿™å°±æ˜¯è¿™ä¸ªä»£ç†èƒ½ä¸ºæˆ‘ä»¬åšçš„<br>æ‰§è¡Œrepr(current_app)çš„è°ƒç”¨å›¾ï¼Œè¯·æ— è§†pycallé‚£ä¸€å—<br><img src="http://ficapy.b0.upaiyun.com/blogimg/werkzeug_localproxy.png" alt="werkzeug_localproxy"><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_find_app</span><span class="params">()</span>:</span></div><div class="line">    top = _app_ctx_stack.top</div><div class="line">    <span class="keyword">if</span> top <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        <span class="keyword">raise</span> RuntimeError(_app_ctx_err_msg)</div><div class="line">    <span class="keyword">return</span> top.app</div><div class="line"></div><div class="line">_app_ctx_stack = LocalStack()</div><div class="line">current_app = LocalProxy(_find_app)</div></pre></td></tr></table></figure><br>åœ¨LocalProxyé‡Œé¢æˆ‘ä»¬å†™äº†ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“å¯¹LocalProxyå±æ€§è¿›è¡Œè®¿é—®çš„æ—¶å€™ï¼Œå®ƒæ°¸è¿œéƒ½æ˜¯å…ˆæ‰§è¡Œ_get_current_object,è¯¥å‡½æ•°å°±æ˜¯æ‰§è¡Œæˆ‘ä»¬å†™å…¥çš„å›è°ƒå‡½æ•°å¾—åˆ°è®¿é—®å¯¹è±¡,æ¯”å¦‚current_appå°±æ˜¯å¾—åˆ°_app_ctx_stack.top.appå¯¹è±¡ã€‚æœ€åå†å¯¹å¾—åˆ°çš„å¯¹è±¡è¿›è¡Œå±æ€§è®¿é—®</p>
<p>å¯¹LocalProxyè®²3ä¸ªå°ç»†èŠ‚</p>
<ol>
<li><p>__init__ä¸­æœ‰<code>object.__setattr__(self, &#39;_LocalProxy__local&#39;, local)</code>ã€‚å¦‚æœä½ è¦ç¡®ä¿å¯¹ä¸€ä¸ªå¯¹è±¡çš„<code>__dict__</code>ä¸­åŠ å…¥å†…å®¹ï¼Œéœ€è¦ä½¿ç”¨object.__setattr__ï¼Œä½¿ç”¨self.xã€setattr(self,â€™xâ€™)ã€self.__dict__[x]éƒ½æ˜¯ä¸ç¡®å®šçš„ï¼Œå› ä¸ºå®ƒselfè¿™ä¸ªå¯¹è±¡å¯èƒ½ä¼šé‡å†™è‡ªèº«çš„__setattr__,å…¶æ¬¡å¯¹äºç§æœ‰å˜é‡ã€‚æ‰§è¡Œ__setattr__çš„æ—¶å€™éœ€è¦å˜æ¢</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">class Foo():</div><div class="line">    def __init__(self):</div><div class="line">        self.__a = 1</div><div class="line">print(Foo().__dict__)</div><div class="line"># &#123;&apos;_Foo__a&apos;: 1&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>æœ€ä¸‹é¢åŒæ—¶ä¹Ÿå¯¹æ‰€æœ‰å¯åˆ—ä¸¾çš„é­”æœ¯æ–¹æ³•è¿›è¡Œäº†ä»£ç†<code>__str__ = lambda x:    str(x._get_current_object())</code></p>
</li>
<li>ç”±äºä»£ç†çš„å­˜åœ¨åŸå§‹å¯¹è±¡çš„è®¿é—®éœ€è¦é€šè¿‡_get_current_object(å…¶å®å¯¹äºçœ‹è¿‡ä»£ç çš„è¿™åº”è¯¥æ˜¯åºŸè¯O_o)<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">from flask import Flask,current_app</div><div class="line">from flask.globals import _app_ctx_stack</div><div class="line">with Flask(__name__).app_context():</div><div class="line">    print(current_app is _app_ctx_stack.top.app)</div><div class="line">    print(current_app._get_current_object() is _app_ctx_stack.top.app)</div><div class="line"># False</div><div class="line"># True</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="requestã€sessionå’Œg"><a href="#requestã€sessionå’Œg" class="headerlink" title="requestã€sessionå’Œg"></a>requestã€sessionå’Œg</h3><p>è¿™å‡ ä¸ªå’Œä¸Šä¸‹æ–‡æ¯æ¯ç›¸å…³,æ¯”å¦‚ç¦»å¼€äº†å¯¹åº”çš„ä¸Šä¸‹æ–‡å®ƒä»¬å®Œå…¨æ— æ³•ä½¿ç”¨<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request, session, g</div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> [request, session, g]:</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        i.x = <span class="number">1</span></div><div class="line">    <span class="keyword">except</span> RuntimeError:</div><div class="line">        print(<span class="string">'boom! '</span>, end=<span class="string">''</span>)</div><div class="line"><span class="comment"># boom! boom! boom! </span></div></pre></td></tr></table></figure><br>flaskçš„0.1ç‰ˆæœ¬æ˜¯åªæœ‰RequestContextè¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œæ²¡æœ‰åº”ç”¨ä¸Šä¸‹æ–‡çš„ã€‚<a href="https://github.com/pallets/flask/commit/47288231fe8f9c6b2c413d50160c32c3884d5785">ç›´åˆ°0.9ç‰ˆæœ¬æ‰ç”¨äºŒä¸‰åè¡Œä»£ç åŠ ä¸ŠAppContextåº”ç”¨ä¸Šä¸‹æ–‡</a><br>ä¸ºä»€ä¹ˆè¦åŠ ä¸Šåº”ç”¨ä¸Šä¸‹æ–‡å‘¢ã€‚å®˜æ–¹æ–‡æ¡£æˆ‘æ²¡æœ‰æ‰¾åˆ°å¾ˆè¯¦å°½çš„è§£é‡Šï¼Œ<a href="http://flask.pocoo.org/docs/0.11/appcontext/#purpose-of-the-application-context">åªæœ‰ä¸€æ®µç®€è¦çš„æè¿°</a>ï¼ŒåŒæ—¶å‚è€ƒäº†ä¸‹åˆ«äººçš„åšå®¢ã€‚æˆ‘ä¸ªäººç†è§£æ˜¯ä¸ºäº†å¤„ç†å•ç‹¬ä½¿ç”¨åº”ç”¨ä¸Šä¸‹æ–‡ä¸ä½¿ç”¨è¯·æ±‚ä¸Šä¸‹æ–‡çš„æƒ…å†µã€‚å¦å¤–æ–‡æ¡£æœ‰<code>creating such a request context is an unnecessarily expensive operation</code>åœ¨æŸäº›æƒ…å†µä½¿ç”¨è¯·æ±‚ä¸Šä¸‹æ–‡æ˜¯æ˜‚è´µçš„æ²¡æœ‰å¿…è¦çš„æ“ä½œã€‚å‚è€ƒä¸‹é¢çš„ä»£ç <br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,current_app</div><div class="line"><span class="keyword">from</span> flask.globals <span class="keyword">import</span> _app_ctx_stack, _request_ctx_stack</div><div class="line"></div><div class="line">app1 = Flask(<span class="string">'a'</span>)</div><div class="line">app2 = Flask(<span class="string">'b'</span>)</div><div class="line"></div><div class="line"><span class="keyword">with</span> app1.app_context():</div><div class="line">    <span class="keyword">with</span> app2.app_context():</div><div class="line">        print(_request_ctx_stack._local.__storage__)</div><div class="line">        print(_app_ctx_stack._local.__storage__)</div><div class="line"></div><div class="line"><span class="comment"># &#123;&#125;</span></div><div class="line"><span class="comment"># &#123;140735191154688: &#123;'stack': [&lt;flask.ctx.AppContext object at 0x1096c1f60&gt;, &lt;flask.ctx.AppContext object at 0x1096cd048&gt;]&#125;&#125;</span></div><div class="line"></div><div class="line"><span class="keyword">with</span> app1.test_client() <span class="keyword">as</span> client1:</div><div class="line">    <span class="keyword">with</span> app2.test_client() <span class="keyword">as</span> client2:</div><div class="line">        print(_request_ctx_stack._local.__storage__)</div><div class="line">        print(_app_ctx_stack._local.__storage__)</div><div class="line">        client2.get(<span class="string">'/b'</span>)</div><div class="line">        print(current_app)</div><div class="line">        print(_request_ctx_stack._local.__storage__)</div><div class="line">        client1.get(<span class="string">'/a'</span>)</div><div class="line">        print(current_app)</div><div class="line">        print(_request_ctx_stack._local.__storage__)</div><div class="line">    resp = client1.get(<span class="string">'/a'</span>)</div><div class="line">    print(_request_ctx_stack._local.__storage__)</div><div class="line">    print(current_app)</div><div class="line"><span class="comment"># &#123;&#125;</span></div><div class="line"><span class="comment"># &#123;&#125;</span></div><div class="line"><span class="comment"># &lt;Flask 'b'&gt;</span></div><div class="line"><span class="comment"># &#123;140735191154688: &#123;'stack': [&lt;RequestContext 'http://localhost/b' [GET] of b&gt;]&#125;&#125;</span></div><div class="line"><span class="comment"># &lt;Flask 'a'&gt;</span></div><div class="line"><span class="comment"># &#123;140735191154688: &#123;'stack': [&lt;RequestContext 'http://localhost/a' [GET] of a&gt;]&#125;&#125;</span></div><div class="line"><span class="comment"># &#123;140735191154688: &#123;'stack': [&lt;RequestContext 'http://localhost/a' [GET] of a&gt;]&#125;&#125;</span></div></pre></td></tr></table></figure><br>é¦–å…ˆå¯ä»¥çœ‹åˆ°æ‰§è¡Œapp_context()çš„æ—¶å€™æœ‰äº†åº”ç”¨ä¸Šä¸‹æ–‡ï¼Œå’Œè¯·æ±‚ä¸Šä¸‹æ–‡ä¸€æ¯›é’±å…³ç³»éƒ½æ²¡æœ‰ã€‚çœ‹ä¸‹ä»£ç å°±æ˜¯return AppContext(self),å®ƒè‡ªå·±æœ‰ä¸ª<strong>enter</strong>å‡½æ•°æ‰§è¡Œäº†pushã€‚è¿™æœ‰ä»€ä¹ˆç”¨å‘¢ã€‚æ¯”å¦‚ä½ è¦åœ¨å‘½ä»¤è¡Œè°ƒç”¨ä¸‹ä½ å†™çš„æ•°æ®åº“å‡½æ•°ã€‚å¾ˆæ˜æ˜¾å®ƒéœ€è¦æ•°æ®åº“çš„é…ç½®app.configã€‚å¦‚æœæ²¡æœ‰åº”ç”¨ä¸Šä¸‹æ–‡ï¼Œé‚£ä¹ˆä½ éœ€è¦å…ˆåˆ›å»ºè¯·æ±‚ä¸Šä¸‹æ–‡ã€‚ç°åœ¨ä½ åªéœ€è¦åˆ›å»ºåº”ç”¨ä¸Šä¸‹æ–‡äº†(æ¯”è¯·æ±‚ä¸Šä¸‹æ–‡æ›´è½»é‡)ã€‚å†è€…å½“æˆ‘ä»¬ä¸€æ¬¡æ€§è¿›å…¥äº†å¤šä¸ªåº”ç”¨ä¸Šä¸‹æ–‡çš„æ—¶å€™æ­¤æ—¶æ ˆé‡Œé¢å°±ä¸æ­¢ä¸€ä¸ªå…ƒç´ äº†ã€‚æ‰€ä»¥ã€‚ã€‚ã€‚ã€‚è¿™ä¹Ÿæ˜¯ä¸Šé¢é—®çš„ä¸ºä»€ä¹ˆè¦ç”¨æ ˆ</p>
<p>ç¬¬äºŒä¸ªä¾‹å­åªæœ‰å½“è¯·æ±‚å‘é€ååº”ç”¨ä¸Šä¸‹æ–‡å’Œè¯·æ±‚ä¸Šä¸‹æ–‡æ‰ä¼šåŒæ—¶å…¥æ ˆã€‚ä¸”åŒæ—¶å‡ºæ ˆï¼Œæ‰€ä»¥ç½‘ä¸Šæœ‰åšå®¢å†™ä¸€ä¸ªåº”ç”¨ä¸Šä¸‹æ–‡ä¼šåŒ…å«å¤šä¸ªè¯·æ±‚ä¸Šä¸‹æ–‡è¿™æ˜¯ä¸å¯¹çš„ã€‚å¹¶ä¸”ç»å¯¹ä¸èƒ½ç†è§£ä¸ºåº”ç”¨ä¸Šä¸‹æ–‡çš„ç”Ÿå­˜å‘¨æœŸæ˜¯ä¸€ä¸ªappä»å¯åŠ¨åˆ°å…³é—­è¿™ä¸ªè¿‡ç¨‹</p>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p><a href="https://blog.tonyseek.com/post/the-context-mechanism-of-flask/">Flask çš„ Context æœºåˆ¶</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ‰äººè¯´flaskçš„ä¸Šä¸‹æ–‡æœºåˆ¶æ˜¯æ•´ä¸ªæ¡†æ¶çš„ç²¾åéƒ¨åˆ†ï¼Œæœ‰äººè¯´å®ƒç¥å¥‡çš„gè®©äººè´¹è§£ã€‚werkzeugçš„local.pyå°±æ˜¯å®ƒçš„å…·ä½“å®ç°ã€‚è¿™ä¸ªçœ‹ä¼¼ç¥å¥‡çš„æœºåˆ¶èƒŒååŠ ä¸Šåº”ç”¨ä»£ç ä¹Ÿä¸è¿‡ä¸¤ä¸‰ç™¾è¡Œã€‚ä¸è¿‡å¥½åƒå‘è¿˜æ˜¯&lt;code&gt;æ¯”è¾ƒæ·±&lt;/code&gt;çš„ã€‚å¦å¤–flaskçš„0.1ç‰ˆæœ¬æ‰200å¤šè¡Œä»£ç ã€‚å€¼å¾—ç…ä¸€ä¸‹&lt;/p&gt;
    
    </summary>
    
      <category term="Flask" scheme="https://www.zoulei.net/categories/Flask/"/>
    
    
      <category term="Flask" scheme="https://www.zoulei.net/tags/Flask/"/>
    
  </entry>
  
  <entry>
    <title>listå’Œdictçš„çº¿ç¨‹å®‰å…¨</title>
    <link href="https://www.zoulei.net/2016/07/31/list_dict_threading_safe/"/>
    <id>https://www.zoulei.net/2016/07/31/list_dict_threading_safe/</id>
    <published>2016-07-30T23:47:09.000Z</published>
    <updated>2016-08-02T03:56:03.000Z</updated>
    
    <content type="html"><![CDATA[<p>åˆšè½¬è¡Œç¬¬ä¸€æ¬¡ITé¢è¯•çš„æ—¶å€™é¢è¯•å®˜é—®æˆ‘ï¼Œlistå’Œdictæ˜¯ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å½“æ—¶æˆ‘å°±æƒ³ï¼Œæ“¦å˜,ä½œä¸ºä¸€ä¸ªåˆå­¦è€…listå’Œdictä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„éƒ½çœ‹äº†Néå•¦ã€‚è¿™è¿˜æœ‰ç–‘é—®ä¹ˆ~~~ï¼Œç°åœ¨æƒ³æƒ³å¹¶æ²¡æœ‰æŠ“ä½é‡ç‚¹ï¼Œçº¿ç¨‹å®‰å…¨åº”è¯¥é’ˆå¯¹äºå…·ä½“çš„æ“ä½œï¼Œè€Œä¸æ˜¯å…·ä½“çš„å¯¹è±¡ï¼Œæˆ‘ä»¬è¯´Queueæ˜¯çº¿ç¨‹å®‰å…¨çš„æ˜¯å› ä¸ºé’ˆå¯¹å®ƒçš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<a id="more"></a>
<h3 id="å®˜æ–¹æ–‡æ¡£"><a href="#å®˜æ–¹æ–‡æ¡£" class="headerlink" title="å®˜æ–¹æ–‡æ¡£"></a><a href="https://docs.python.org/2/faq/library.html#what-kinds-of-global-value-mutation-are-thread-safe">å®˜æ–¹æ–‡æ¡£</a></h3><p>å¯ä»¥çœ‹åˆ°å¤§æ¦‚æœ‰è¿™ä¹ˆä¸ªæ¦‚å¿µ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">L,L1,L2-&gt;list</div><div class="line">D,D1,D2-&gt;dict</div><div class="line">x,y-&gt;object</div><div class="line">i,j-&gt;int</div><div class="line"></div><div class="line">çº¿ç¨‹å®‰å…¨</div><div class="line">L.append(x)</div><div class="line">L1.append(L2)</div><div class="line">x=L[i]</div><div class="line">y=L.pop()</div><div class="line">L1[i,j]=L2</div><div class="line">L.sort()</div><div class="line">x=y</div><div class="line">x.field=y</div><div class="line">D[x]=y</div><div class="line">D1.update(D2)</div><div class="line">D.keys()</div><div class="line"></div><div class="line"></div><div class="line">ä»¥ä¸‹æ˜¯éçº¿ç¨‹å®‰å…¨</div><div class="line">i=i+1</div><div class="line">L.append(L[-1])</div><div class="line">L[i]=L[j]</div><div class="line">D[x]=D[x]+1</div></pre></td></tr></table></figure><br>å¯ä»¥çœ‹åˆ°listçš„appendå•¥çš„å…¶å®æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚æˆ‘ä»¬çœ‹åˆ°çš„ä¸¾éçº¿ç¨‹å®‰å…¨çš„ä¾‹å­åŸºæœ¬éƒ½æ˜¯i+=1è¿™ç§ï¼Œæœ€åå¾—åˆ°çš„ç»“æœå°äºç›¸åŠ æ¬¡æ•°ã€‚ç„¶åæœ€åè¯´ä¸€å¥å¤šçº¿ç¨‹å¯¹åŒä¸€èµ„æºè¿›è¡Œæ“ä½œçš„æ—¶å€™è¦åŠ é”å“‡ã€‚ã€‚ã€‚ã€‚ã€‚è¿™è¯ç›´æ¥è¯´çš„å¥½åƒæ¯”è¾ƒä¸è´Ÿè´£ä»»ã€‚è®©æˆ‘è¿™æ ·çš„åˆå­¦è€…é£å£°é¹¤å”³è‰æœ¨çš†å…µ</p>
<h3 id="ä¸€ç‚¹å°è§£é‡Š"><a href="#ä¸€ç‚¹å°è§£é‡Š" class="headerlink" title="ä¸€ç‚¹å°è§£é‡Š"></a>ä¸€ç‚¹å°è§£é‡Š</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> threading</div><div class="line"><span class="keyword">import</span> dis</div><div class="line"></div><div class="line">i = <span class="number">0</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">global</span> i</div><div class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">3000000</span>):</div><div class="line">        i += <span class="number">1</span></div><div class="line"></div><div class="line">th = [threading.Thread(target=main), threading.Thread(target=main)]</div><div class="line"></div><div class="line"><span class="keyword">for</span> t <span class="keyword">in</span> th:</div><div class="line">    t.start()</div><div class="line"></div><div class="line"><span class="keyword">for</span> t <span class="keyword">in</span> th:</div><div class="line">    t.join()</div><div class="line">print(i)</div><div class="line"></div><div class="line">dis.dis(main)</div><div class="line"></div><div class="line"><span class="comment"># 4372439</span></div><div class="line"><span class="comment">#   8           0 SETUP_LOOP              30 (to 33)</span></div><div class="line"><span class="comment">#               3 LOAD_GLOBAL              0 (range)</span></div><div class="line"><span class="comment">#               6 LOAD_CONST               1 (3000000)</span></div><div class="line"><span class="comment">#               9 CALL_FUNCTION            1</span></div><div class="line"><span class="comment">#              12 GET_ITER            </span></div><div class="line"><span class="comment">#         &gt;&gt;   13 FOR_ITER                16 (to 32)</span></div><div class="line"><span class="comment">#              16 STORE_FAST               0 (_)</span></div><div class="line"><span class="comment"># </span></div><div class="line"><span class="comment">#   9          19 LOAD_GLOBAL              1 (i)</span></div><div class="line"><span class="comment">#              22 LOAD_CONST               2 (1)</span></div><div class="line"><span class="comment">#              25 INPLACE_ADD         </span></div><div class="line"><span class="comment">#              26 STORE_GLOBAL             1 (i)</span></div><div class="line"><span class="comment">#              29 JUMP_ABSOLUTE           13</span></div><div class="line"><span class="comment">#         &gt;&gt;   32 POP_BLOCK           </span></div><div class="line"><span class="comment">#         &gt;&gt;   33 LOAD_CONST               0 (None)</span></div><div class="line"><span class="comment">#              36 RETURN_VALUE     </span></div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çŸ¥é“pythonä»£ç ç»è¿‡ç¼–è¯‘æˆå­—èŠ‚ç æŒ‡ä»¤ï¼Œç„¶åpythonè™šæ‹ŸæœºæŒ‰ç…§æŒ‡ä»¤è¿›è¡Œæ‰§è¡Œï¼Œè¿™é‡Œæ¯ä¸€æ¡æŒ‡ä»¤éƒ½æ˜¯åŸå­æ“ä½œä¸ä¼šè¢«ä¸­æ–­ï¼Œå¯ä»¥çœ‹åˆ°<code>i+=1</code>è¿™æ¡è¯­å¥è¢«åˆ’åˆ†ä¸º4æ¡æŒ‡ä»¤è¢«æ‰§è¡Œã€‚å–å‡ºiå˜é‡çš„å€¼å…¥æ ˆâ†’â†’å°†è¢«åŠ æ•°1å…¥æ ˆâ†’â†’å–å‡º2ä¸ªæ•°ç›¸åŠ ç»“æœå†å…¥æ ˆâ†’â†’ç»“æœå‡ºæ ˆã€‚å› ä¸ºæ˜¯è¦ç´¯åŠ ã€‚æˆ‘ä»¬å½“ç„¶éœ€è¦ç´¯åŠ çš„ç¬¬ä¸€æ­¥åŠ å…¥çš„å€¼æ˜¯ä¸Šä¸€ä¸ªç´¯åŠ çš„ç»“æœã€‚å¯æ˜¯åœ¨å¤šçº¿ç¨‹ä¸åŠ é”çš„æƒ…å†µä¸‹æ¯ä¸€æ¡æŒ‡ä»¤è¢«æ‰§è¡Œå®Œæ¯•åéƒ½æœ‰å¯èƒ½å»æ‰§è¡Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„æŒ‡ä»¤ã€‚è¿™å°±ä¼šé€ æˆç¬¬ä¸€æ­¥åŠ å…¥çš„å€¼æœ‰å¯èƒ½å’Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹æ˜¯ä¸€æ ·çš„ï¼Œäºæ˜¯æ‚²å‰§å‘ç”Ÿäº†O_o</p>
<p>å†æƒ³ä¸€æƒ³append<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">8          19 LOAD_GLOBAL              1 (i)</div><div class="line">           22 LOAD_ATTR                2 (append)</div><div class="line">           25 LOAD_CONST               2 (1)</div><div class="line">           28 CALL_FUNCTION            1</div><div class="line">           31 POP_TOP             </div></pre></td></tr></table></figure><br> <a href="http://jakevdp.github.io/images/array_vs_list.png">å›¾ç‰‡å¼•ç”¨è‡ª</a><br> <img src="https://ficapy.b0.upaiyun.com/blogimg/array_vs_list.png" alt="array_vs_list"><br>å¯ä»¥çœ‹å‡ºlistå°±æ˜¯ä¸€ä¸ªå®¹å™¨.appendå°±ç›¸å½“ä¸åœ¨æœ€åé¢åŠ äº†ä¸€ä¸ªå¼•ç”¨ã€‚è™½ç„¶å®ƒä¹Ÿæ˜¯ç”±å‡ æ¡æŒ‡å®šç»„æˆã€‚ä¹Ÿä¼šå‘ç”Ÿäº¤é”™æ‰§è¡Œçš„æƒ…å†µã€‚è¿™ç§äº¤é”™é€ æˆçš„ç»“æœæ— éå°±æ˜¯æˆ‘æœ¬æ¥æ˜¯å…ˆæ‰§è¡Œçš„å´åœ¨äº†ä¸€ä¸ªçš„åé¢æ‰§è¡Œäº†æ’å…¥ï¼Œé€ æˆçš„ç»“æœå°±æ˜¯<code>é¡ºåºé”™ä¹±äº†</code>ã€‚ğŸ˜„å¯æ˜¯ç‰¹å–µæœ¬æ¥å°±æ˜¯å¤šçº¿ç¨‹ç¨‹åºï¼Œè°ç‰¹å–µä¼šå»å…³å¿ƒé¡ºåºå‘¢ã€‚æ‰€ä»¥å°±è¯´çº¿ç¨‹å®‰å…¨äº†ã€‚<br>å¯ä»¥çœ‹å‡ºï¼Œappendå’Œ<code>i+=1</code>æœ€å¤§çš„åŒºåˆ«å°±æ˜¯æ˜¯å¦å¯¹è‡ªèº«è¿›è¡Œäº†ä¿®æ”¹ã€‚dictåŒç†~~</p>
<p>å¦å¤–åŠ é”çš„æ—¶é—´å¼€é”€å…¶å®è¿˜æ˜¯æŒºå¤§çš„ã€‚ä¸Šä¾‹ï¼Œæˆ‘ç”¨3ä¸ªçº¿ç¨‹(ç»“æœæ˜¯9000000)ï¼Œä¸åŠ é”1.38ç§’ï¼ŒåŠ é”æ‰§è¡Œ39.16ç§’(python2.7.11)ã€‚ä¸åŠ é”1.06ç§’ï¼ŒåŠ é”3.94ç§’(python3.5.1)ã€‚â†’_â†’å½“ç„¶ä½ å¯ä»¥æŠŠi+=1æ”¹æˆi.apped(1)è¿™æ ·ä¸ç”¨é”ç»“æœä¹Ÿèƒ½å¯¹äº†ï¼Œåªä¸è¿‡å†…å­˜æ¶ˆè€—æ„Ÿäºº</p>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p><a href="http://qingyunha.github.io/taotao/">A Python Interpreter Written in Python</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åˆšè½¬è¡Œç¬¬ä¸€æ¬¡ITé¢è¯•çš„æ—¶å€™é¢è¯•å®˜é—®æˆ‘ï¼Œlistå’Œdictæ˜¯ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å½“æ—¶æˆ‘å°±æƒ³ï¼Œæ“¦å˜,ä½œä¸ºä¸€ä¸ªåˆå­¦è€…listå’Œdictä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„éƒ½çœ‹äº†Néå•¦ã€‚è¿™è¿˜æœ‰ç–‘é—®ä¹ˆ~~~ï¼Œç°åœ¨æƒ³æƒ³å¹¶æ²¡æœ‰æŠ“ä½é‡ç‚¹ï¼Œçº¿ç¨‹å®‰å…¨åº”è¯¥é’ˆå¯¹äºå…·ä½“çš„æ“ä½œï¼Œè€Œä¸æ˜¯å…·ä½“çš„å¯¹è±¡ï¼Œæˆ‘ä»¬è¯´Queueæ˜¯çº¿ç¨‹å®‰å…¨çš„æ˜¯å› ä¸ºé’ˆå¯¹å®ƒçš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="python" scheme="https://www.zoulei.net/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>werkzeugæºç åˆ†æ(Request/Responseå’Œçƒ­é‡å¯)</title>
    <link href="https://www.zoulei.net/2016/07/25/werkzeug_note_requests_response_auto_realod/"/>
    <id>https://www.zoulei.net/2016/07/25/werkzeug_note_requests_response_auto_realod/</id>
    <published>2016-07-25T13:48:17.000Z</published>
    <updated>2016-09-04T08:46:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>Flaskè¿™ä¸ªäººäººç§°èµçš„å¾®æ¡†æ¶å°±æ˜¯æ„å»ºåœ¨werkzeugä¹‹ä¸Šï¼Œwerkzeugç»™è‡ªå·±çš„å®šä½å°±æ˜¯å·¥å…·é›†åˆã€‚å®ƒå®ç°äº†wsgi serverã€Requests/Responseå°è£…ã€DEBUGã€çƒ­é‡å¯ã€è·¯ç”±æ§åˆ¶ä»¥åŠå…¶ä»–çš„ä¸€äº›è¾…åŠ©åŠŸèƒ½ã€‚æ¥ä¸‹æ¥çš„å‡ ç¯‡æ–‡ç« ä¼šä»ä¸€äº›å¤§çš„æ–¹é¢å»åˆ†æå®ƒã€‚æœ¬ç¯‡å¦‚æ ‡é¢˜:D</p>
<a id="more"></a>
<h3 id="WSGI-Server"><a href="#WSGI-Server" class="headerlink" title="WSGI Server"></a>WSGI Server</h3><p>è¿™ä¸ªåˆç•¥è¯´ä¸€ä¸‹ã€‚å’Œå®ƒç›¸å…³çš„ä»£ç ä¸å¤šã€‚å’Œwsgirefä¸€æ ·å®ƒæ„å»ºåœ¨pythonè‡ªå¸¦æ¨¡å—SocketServerå’ŒBaseHTTPRequestHandlerä¹‹ä¸Šã€‚ç”šè‡³æ¯”è‡ªå¸¦çš„wsgirefä»£ç è¦å°‘ã€‚å®ƒä¸»è¦å¢åŠ äº†SSLå’Œsocket.fromfdæ”¯æŒã€‚å¹¶ä¸”å°†debugã€é™æ€æ–‡ä»¶åˆ†å‘ã€çƒ­é‡å¯ç»„åˆå†äº†ä¸€èµ·</p>
<h3 id="Requestã€Responseå°è£…"><a href="#Requestã€Responseå°è£…" class="headerlink" title="Requestã€Responseå°è£…"></a>Requestã€Responseå°è£…</h3><p>è¿™ä¸ªå¯èƒ½ç®—æ˜¯é‡ç‚¹äº†ã€‚æœ‰ä¸ªåº“webobå°±æ˜¯ä¸“é—¨åšè¿™ä¸ªçš„ã€‚å å¾—ä»£ç é‡ä¹Ÿå¾ˆå¤§ã€‚å¯æƒœæˆ‘å¹¶ä¸æƒ³è¯¦ç»†å†™æ¯ä¸€ä¸ªçš„è¿‡ç¨‹ï¼Œå¤ªéº»çƒ¦äº†ï¼Œäº†è§£äº†å¤§æ¦‚å°±å¥½å•¦ã€‚ä»¥åä¼šä¸»è¦åˆ†æä¸‹datastructures.pyè¿™ä¸ªæ–‡ä»¶ã€‚ä¸‹é¢æ˜¯è¶…ç®€æ´çš„åŸç†ä»£ç <br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span><span class="params">()</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, env)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="meta">    @classmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">application</span><span class="params">(cls, f)</span>:</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(env, start_response)</span>:</span></div><div class="line">            request = cls(env)</div><div class="line">            <span class="keyword">return</span> f(request)(env, start_response)</div><div class="line"></div><div class="line">        <span class="keyword">return</span> decorator</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Response</span><span class="params">()</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, str)</span>:</span></div><div class="line">        self.body = str</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, env, start_response)</span>:</span></div><div class="line">        start_response(<span class="string">'200 OK'</span>, [])</div><div class="line">        <span class="keyword">return</span> [self.body]</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@Request.application</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">app</span><span class="params">(req)</span>:</span></div><div class="line">    <span class="keyword">return</span> Response(<span class="string">b'Hello'</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server</div><div class="line"></div><div class="line">make_server(<span class="string">''</span>, <span class="number">8000</span>, app).serve_forever()</div></pre></td></tr></table></figure><br>å¯ä»¥å¤§æ¦‚äº†è§£æ˜¯è¿™ä¹ˆå›äº‹:</p>
<ul>
<li>Requestå®ƒä¸»è¦å°è£…çš„æ˜¯headersï¼Œç„¶åå˜ï¼Œå„ç§å±æ€§éƒ½ç”¨propertyå°±å¥½äº†ï¼Œå‰©ä¸‹çš„bodyå’Œå…¶ä»–çš„ä¹Ÿå·®ä¸å¤šå•¦ã€‚</li>
<li>Request.applicationè¿™ä¸ªè£…é¥°å™¨çš„ä½œç”¨å°±æ˜¯å°†åŸæ¥çš„env,start_responseå‚æ•°å˜æˆreqç»™æˆ‘ä»¬ä½¿ç”¨</li>
<li><code>Responseå®ƒå°±æ˜¯ä¸€ä¸ªwsgiappå¯¹è±¡</code><br>çœ‹ä¸‹å®ƒä»¬2ä¸ªçš„ç»§æ‰¿å›¾<br><img src="https://ficapy.b0.upaiyun.com/blogimg/werkzerg_wrappers_inherit.png" alt="werkzeug.wrappers.inherit"><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlainRequest</span><span class="params">(StreamOnlyMixin, Request)</span>:</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Response</span><span class="params">(BaseResponse, ETagResponseMixin, ResponseStreamMixin,</div><div class="line">               CommonResponseDescriptorsMixin,</div><div class="line">               WWWAuthenticateMixin)</span>:</span></div></pre></td></tr></table></figure>
ç¿»æºç å¯ä»¥çœ‹åˆ°å®ƒä»¬çš„ç»§æ‰¿å¤§éƒ¨åˆ†éƒ½æ˜¯å¯¹headersçš„æ“ä½œ</li>
</ul>
<h3 id="çƒ­é‡å¯å®ç°åŸç†"><a href="#çƒ­é‡å¯å®ç°åŸç†" class="headerlink" title="çƒ­é‡å¯å®ç°åŸç†"></a>çƒ­é‡å¯å®ç°åŸç†</h3><p>ä¸Šç®€å›¾ï¼š<br><img src="https://ficapy.b0.upaiyun.com/blogimg/werkzeug_autoreload.png" alt="werkzeug_autoreload"><br>ä¸ŠåŸç†ä»£ç :<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">import</span> subprocess</div><div class="line"><span class="keyword">import</span> threading</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">'Hello'</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">file_change</span><span class="params">()</span>:</span></div><div class="line">    mtimes = &#123;&#125;</div><div class="line">    <span class="keyword">while</span> <span class="number">1</span>:</div><div class="line">        filename = __file__</div><div class="line">        mtime = os.stat(filename).st_mtime</div><div class="line">        old_time = mtimes.get(filename)</div><div class="line">        <span class="keyword">if</span> old_time <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            mtimes[filename] = mtime</div><div class="line">            <span class="keyword">continue</span></div><div class="line">        <span class="keyword">elif</span> mtime &gt; old_time:</div><div class="line">            print(<span class="string">' * Detected change in &#123;&#125;, reloading'</span>.format(filename))</div><div class="line">            sys.exit(<span class="number">3</span>)</div><div class="line">        time.sleep(<span class="number">1</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> os.environ.get(<span class="string">'secord_process'</span>):</div><div class="line">    threading.Thread(target=main, args=()).start()</div><div class="line">    file_change()</div><div class="line"><span class="keyword">else</span>:</div><div class="line">    <span class="keyword">while</span> <span class="number">1</span>:</div><div class="line">        env = os.environ.copy()</div><div class="line">        env[<span class="string">'secord_process'</span>] = <span class="string">'true'</span></div><div class="line">        exit_code = subprocess.call([sys.executable] + sys.argv, env=env)</div><div class="line">        <span class="keyword">if</span> exit_code != <span class="number">3</span>:</div><div class="line">            <span class="keyword">break</span></div></pre></td></tr></table></figure></p>
<p>åšæ³•å°±æ˜¯ä¸»çº¿ç¨‹å•¥äº‹æ²¡åšï¼Œè·‘ä¸€ä¸ªæ­»å¾ªç¯ï¼Œç”Ÿæˆå­è¿›ç¨‹(å°±ç›¸å½“è¿è¡Œè‡ªèº«,åŒºåˆ«å°±æ˜¯os.environ)ã€‚è¿™ä¸ªè¿›ç¨‹å†…ä½¿ç”¨å•ç‹¬çš„çº¿ç¨‹è·‘éœ€è¦è¿è¡Œçš„å‡½æ•°ï¼Œå¦å¤–å°±æ˜¯æ£€æŸ¥ç›¸å…³æ–‡ä»¶æ˜¯å¦è¢«æ”¹å˜ã€‚æ”¹å˜å°±æ‰§è¡Œsys.exitã€‚ç„¶åå°±åˆè¢«ä¸»çº¿ç¨‹çš„æ­»å¾ªç¯ç”Ÿæˆäº†æ–°çš„å­è¿›ç¨‹</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Flaskè¿™ä¸ªäººäººç§°èµçš„å¾®æ¡†æ¶å°±æ˜¯æ„å»ºåœ¨werkzeugä¹‹ä¸Šï¼Œwerkzeugç»™è‡ªå·±çš„å®šä½å°±æ˜¯å·¥å…·é›†åˆã€‚å®ƒå®ç°äº†wsgi serverã€Requests/Responseå°è£…ã€DEBUGã€çƒ­é‡å¯ã€è·¯ç”±æ§åˆ¶ä»¥åŠå…¶ä»–çš„ä¸€äº›è¾…åŠ©åŠŸèƒ½ã€‚æ¥ä¸‹æ¥çš„å‡ ç¯‡æ–‡ç« ä¼šä»ä¸€äº›å¤§çš„æ–¹é¢å»åˆ†æå®ƒã€‚æœ¬ç¯‡å¦‚æ ‡é¢˜:D&lt;/p&gt;
    
    </summary>
    
      <category term="Flask" scheme="https://www.zoulei.net/categories/Flask/"/>
    
    
      <category term="Flask" scheme="https://www.zoulei.net/tags/Flask/"/>
    
  </entry>
  
  <entry>
    <title>osx airdropæ— æ³•ä½¿ç”¨ä¿®å¤</title>
    <link href="https://www.zoulei.net/2016/07/23/fix_osx_airdrop_not_working/"/>
    <id>https://www.zoulei.net/2016/07/23/fix_osx_airdrop_not_working/</id>
    <published>2016-07-23T02:53:25.000Z</published>
    <updated>2016-07-24T08:27:21.000Z</updated>
    
    <content type="html"><![CDATA[<p>å‰äº›å¤©ç”¨çš„å¥½å¥½çš„airdropå±…ç„¶æ— æ³•ä½¿ç”¨äº†ã€‚å…·ä½“æƒ…å†µæ˜¯ï¼šæˆ‘æœ‰iphoneã€ipadã€macã€‚iphoneå’Œipadèƒ½å¤Ÿäº’ç›¸å‘ç°ã€‚macå¯¹å®ƒä»¬2ä¸ªå‘ç°ä¸äº†ã€‚å¦ˆè›‹æ­£è¦ä¼ èµ„æ–™å¯æ€¥æ­»æˆ‘äº†ã€‚ç½‘ä¸Šä¸€æœè¿™ç§æƒ…å†µè¿˜ä¸åœ¨å°‘æ•°ã€‚</p>
<p>é‡åˆ°è¿™ç§æƒ…å†µã€‚å¯ä»¥æ‰“å¼€about this macâ†’â†’system reportæŸ¥çœ‹Network(wifi)å¯ä»¥çœ‹åˆ°Country Code:æ˜¯ä¸æ˜¯CN(æˆ‘ç”µè„‘æœ‰é—®é¢˜çš„æ—¶å€™æ˜¯X3)ã€‚å¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆæ— æ³•ä½¿ç”¨airdropå°±å’Œå®ƒæœ‰å…³ã€‚è‡³äºå¦‚ä½•ä¿®å¤è¿™ä¸ªé—®é¢˜æˆ‘æ²¡æœ‰æ‰¾åˆ°ç¡®åˆ‡çš„åŠæ³•.æœ‰ä¸€ä¸ªåŸå› å¯èƒ½æ˜¯ç”±äºè·¯ç”±å™¨é€ æˆçš„ã€‚è¿™ä¸ªå¯ä»¥æ‰“å¼€ç³»ç»Ÿè‡ªå¸¦çš„æ— çº¿æ£€æµ‹å·¥å…·Wireless Diagnostics(Windowsâ†’â†’scan)æŸ¥çœ‹æ˜¯ä¸æ˜¯ç”±äºå›½å®¶ç å†²çªé€ æˆçš„(è¯¦æƒ…çœ‹ç¬¬ä¸€ä¸ªå‚è€ƒèµ„æ–™)ã€‚å¦‚æœè¿™é‡Œæ²¡æœ‰é—®é¢˜(æˆ‘çš„ä¸æ˜¯è¿™ä¸ªé—®é¢˜)ã€‚ã€‚ã€‚ã€‚ã€‚é‚£ä¹ˆè¯·å°è¯•æ‰§è¡Œä»¥ä¸‹æ“ä½œ</p>
<ol>
<li>å°†æ“ä½œç³»ç»Ÿçš„è¯­è¨€æ”¹æˆä¸­æ–‡</li>
<li>åœ¨ç³»ç»Ÿè®¾ç½®é¡µé€€å‡ºicloudè´¦å·</li>
<li>é‡å¯ç³»ç»Ÿ<br>ï¼š<br>ï¼š<br>å°¼ç›ï¼Œæœ‰å¯èƒ½å°±æš‚æ—¶èƒ½æ­£å¸¸ä½¿ç”¨äº†ãƒ¾(ï½¡ï½€Ğ”Â´ï½¡)</li>
</ol>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p><a href="http://www.howtogeek.com/211993/how-to-fix-conflicting-country-codes-and-improve-your-macs-wi-fi/">how-to-fix-conflicting-country-codes-and-improve-your-macs-wi-fi</a><br><a href="http://km.nicetypo.com/doc/7090786787135be8d32fa6624b892309">è§£æ±ºç„¡æ³•å¾ iPhone AirDrop åˆ° Mac çš„æ–¹æ³•</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å‰äº›å¤©ç”¨çš„å¥½å¥½çš„airdropå±…ç„¶æ— æ³•ä½¿ç”¨äº†ã€‚å…·ä½“æƒ…å†µæ˜¯ï¼šæˆ‘æœ‰iphoneã€ipadã€macã€‚iphoneå’Œipadèƒ½å¤Ÿäº’ç›¸å‘ç°ã€‚macå¯¹å®ƒä»¬2ä¸ªå‘ç°ä¸äº†ã€‚å¦ˆè›‹æ­£è¦ä¼ èµ„æ–™å¯æ€¥æ­»æˆ‘äº†ã€‚ç½‘ä¸Šä¸€æœè¿™ç§æƒ…å†µè¿˜ä¸åœ¨å°‘æ•°ã€‚&lt;/p&gt;
&lt;p&gt;é‡åˆ°è¿™ç§æƒ…å†µã€‚å¯ä»¥æ‰“å¼€about this ma
    
    </summary>
    
    
      <category term="éšç¬”" scheme="https://www.zoulei.net/tags/%E9%9A%8F%E7%AC%94/"/>
    
  </entry>
  
</feed>
